<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>技術/Windows/PE(Portable Executable)フォーマットの実験/01, リンカオプション - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">技術/Windows/PE(Portable Executable)フォーマットの実験/01, リンカオプション</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2010-05-26 13:18:36 &nbsp; / &nbsp; last updated at: 2010-07-13 12:18:41<br>
カテゴリ: <a href="category-10.html">C言語</a>&nbsp;<a href="category-8.html">Windows</a>&nbsp;<a href="category-50.html">hacks</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-708.html" title="技術/Windows/PE(Portable Executable)フォーマットの実験">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-678.html" title="技術/Windows/PE(Portable Executable)フォーマットの実験/02, 再配置情報で遊ぼう！">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-23.html" title="技術">技術</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
IMAGE_OPTIONAL_HEADERのメンバのいくつかを、コンパイラやリンカオプションでデフォルト値を変更し、影響を確認してみる。DataDirectoryはまだ触らない。CPUはx86-32bit(Pen4)を使用。
<br />
</p>

<p class="paragraph">
OSはWindows XP SP3, VCはVC++ 2008 Express Edition, コンパイラとリンカのバージョンは次の通り：
<br />
</p>
<pre>&gt; cl
Microsoft(R) 32-bit C/C++ Optimizing Compiler Version 15.00.30729.01 for 80x86
Copyright (C) Microsoft Corporation.  All rights reserved.
</pre>

<pre>&gt; link
Microsoft (R) Incremental Linker Version 9.00.30729.01
Copyright (C) Microsoft Corporation.  All rights reserved.
</pre>



<ul><li><a href="#idf70a11">IMAGE_OPTIONAL_HEADER の全メンバ</a><ul><li><a href="#idc7dcd8">リンカオプションで操作可能なメンバ</a></li></ul></li>
<li><a href="#id338451">&quot;/BASE&quot;, &quot;/FIXED&quot; の影響を確認してみる</a><ul><li><a href="#id151d2e">EXEファイルで &quot;/BASE&quot; の影響を確認してみる</a></li>
<li><a href="#id8390a2">DLLファイルで &quot;/BASE&quot;, &quot;/FIXED&quot; の影響を確認してみる</a></li>
<li><a href="#id6b75fb">DLLと&quot;/NOENTRY&quot;オプションの実験</a></li></ul></li>
<li><a href="#ide8ca6e">&quot;/ALIGN&quot; の影響を確認してみる</a></li>
<li><a href="#idfdf1e5">&quot;/OPT:WIN98&quot;(4KB) or &quot;/OPT:NOWIN98&quot;(512B)  の影響を確認してみる</a></li>
<li><a href="#id88d6ad">&quot;Subsystem&quot;フィールドの値で遊んでみる</a></li>
<li><a href="#id797006">&quot;/VERSION&quot; の影響を確認してみる</a></li>
<li><a href="#idfbf59f">&quot;/RELEASE&quot; の影響を確認してみる</a></li>
<li><a href="#id01e6aa">&quot;/STACK&quot; の影響を確認してみる</a></li>
<li><a href="#id9fe59a">&quot;/HEAP&quot; の影響を確認してみる</a></li>
<li><a href="#id0227a3">参考URL</a></li></ul>
<hr />
<h3 id="idf70a11">IMAGE_OPTIONAL_HEADER の全メンバ</h3>

<p class="paragraph">
まずIMAGE_OPTIONAL_HEADERの全メンバは次の通り。(from WinNT.h)
<br />
</p>
<dl>
<dt> &quot;Standard fields&quot; </dt>
<dd>
<table>
	<tr>
		<td> WORD </td>
		<td> Magic </td>
		<td> IMAGE_OPTIONAL_HEADER用のマジックナンバー </td>
	</tr>
	<tr>
		<td> BYTE </td>
		<td> MajorLinkerVersion </td>
		<td> リンカバージョン </td>
	</tr>
	<tr>
		<td> BYTE </td>
		<td> MinorLinkerVersion </td>
		<td> 同上 </td>
	</tr>
	<tr>
		<td> DWORD </td>
		<td> SizeOfCode </td>
		<td> IMAGE_SCN_CNT_CODEを持った(=含実行コード)セクションの合計サイズ </td>
	</tr>
	<tr>
		<td> DWORD </td>
		<td> SizeOfInitializedData </td>
		<td> 初期化済みのデータセクションの合計サイズ </td>
	</tr>
	<tr>
		<td> DWORD </td>
		<td> SizeOfUninitializedData </td>
		<td> 初期化されていないデータセクションの合計サイズ。リンカがデータセクションに未初期化データを含めることが出来た場合は、0になる。 </td>
	</tr>
	<tr>
		<td> DWORD </td>
		<td> AddressOfEntryPoint </td>
		<td> 実行開始位置のRVA。実際のアドレスは、ImageBaseを加えたものになる。DLLだと0になる場合もある。リンカの&quot;/NOENTRY&quot;オプションを使うと、0になる。 </td>
	</tr>
	<tr>
		<td> DWORD </td>
		<td> BaseOfCode </td>
		<td> 実行コード領域が始まるRVA </td>
	</tr>
	<tr>
		<td> DWORD </td>
		<td> BaseOfData </td>
		<td> データ領域が始まるRVA </td>
	</tr>
</table></dd>
<dt> &quot;NT additional fields&quot; </dt>
<dd>
<table>
	<tr>
		<td> DWORD </td>
		<td> ImageBase </td>
		<td> ファイルがロードされる先頭アドレス。再配置情報有り＋このアドレスにロード失敗の場合は別アドレスにロードされる。&quot;/BASE&quot;リンカオプションで変更可能。再配置を防ぐには &quot;/FIXED&quot; リンカオプションを指定。 </td>
	</tr>
	<tr>
		<td> DWORD </td>
		<td> SectionAlignment </td>
		<td> セクションがメモリに配置される境界, 丸め数値。デフォルトはx86-32bitCPUのページング単位である4KB(0x1000)で、 &quot;/ALIGN&quot; リンカオプションで変更可能。 </td>
	</tr>
	<tr>
		<td> DWORD </td>
		<td> FileAlignment </td>
		<td> セクションがファイルに格納される時の境界, 丸め数値。200h(=512B) or 1000h(=4KB)になる。&quot;/OPT:WIN98&quot;(4KB) or &quot;/OPT:NOWIN98&quot;(512B) リンカオプションで切り替える。 </td>
	</tr>
	<tr>
		<td> WORD </td>
		<td> MajorOperatingSystemVersion </td>
		<td> OSのバージョン </td>
	</tr>
	<tr>
		<td> WORD </td>
		<td> MinorOperatingSystemVersion </td>
		<td> 同上 </td>
	</tr>
	<tr>
		<td> WORD </td>
		<td> MajorImageVersion </td>
		<td> 実行ファイルのバージョンで、&quot;/VERSION&quot;リンカオプションで開発者が指定する。OSからは使われないので、開発側の都合に応じて設定する。 </td>
	</tr>
	<tr>
		<td> WORD </td>
		<td> MinorImageVersion </td>
		<td> 同上 </td>
	</tr>
	<tr>
		<td> WORD </td>
		<td> MajorSubsystemVersion </td>
		<td> かつてはWin95/WinNTのユーザーインターフェイス選択で使われていたが、現在は未使用。 </td>
	</tr>
	<tr>
		<td> WORD </td>
		<td> MinorSubsystemVersion </td>
		<td> 同上 </td>
	</tr>
	<tr>
		<td> DWORD </td>
		<td> Win32VersionValue </td>
		<td> 未使用 </td>
	</tr>
	<tr>
		<td> DWORD </td>
		<td> SizeOfImage </td>
		<td> ファイルをロードする為に必要なメモリサイズで、SectionAlignmentの倍数になる。 </td>
	</tr>
	<tr>
		<td> DWORD </td>
		<td> SizeOfHeaders </td>
		<td> DOSヘッダー, PEヘッダー, セクションテーブルを含めたファイル上のヘッダーサイズで、FileAlignmentの倍数になる。 </td>
	</tr>
	<tr>
		<td> DWORD </td>
		<td> CheckSum </td>
		<td> カーネルモードドライバやシステムDLLのいくつかで必須となるチェックサム。IMAGEHLP.DLLのCheckSumMappedFile()を使って計算可能だが、&quot;/RELEASE&quot;リンカオプションを指定するとリンカにより自動的に計算され、設定される。 </td>
	</tr>
	<tr>
		<td> WORD </td>
		<td> Subsystem </td>
		<td> ユーザーインターフェイス(subsystem)の種別。2(IMAGE_SUBSYSTEM_WINDOWS_GUI), 3(IMAGE_SUBSYSTEM_WINDOWS_CUI)など。 </td>
	</tr>
	<tr>
		<td> WORD </td>
		<td> DllCharacteristics </td>
		<td> DLLの特性を表すビットフィールド </td>
	</tr>
	<tr>
		<td> DWORD </td>
		<td> SizeOfStackReserve </td>
		<td> プロセスのデフォルトスレッドに割り当てられるスタック領域の予約サイズ。 &quot;/STACK&quot;リンカオプションで指定可能。 </td>
	</tr>
	<tr>
		<td> DWORD </td>
		<td> SizeOfStackCommit </td>
		<td> 同上の起動時にコミット済のサイズ。 &quot;/STACK&quot;リンカオプションで指定可能。 </td>
	</tr>
	<tr>
		<td> DWORD </td>
		<td> SizeOfHeapReserve </td>
		<td> プロセスに割り当てられるヒープ領域の予約サイズ。 &quot;/HEAP&quot;リンカオプションで指定可能。 </td>
	</tr>
	<tr>
		<td> DWORD </td>
		<td> SizeOfHeapCommit </td>
		<td> 同上の起動時にコミット済のサイズ。 &quot;/HEAP&quot;リンカオプションで指定可能。 </td>
	</tr>
	<tr>
		<td> DWORD </td>
		<td> LoaderFlags </td>
		<td> 現在では未使用 </td>
	</tr>
	<tr>
		<td> DWORD </td>
		<td> NumberOfRvaAndSizes </td>
		<td> IMAGE_DATA_DIRECTORYの数。通常は16 </td>
	</tr>
</table>

<p class="paragraph">
(DataDirectory:IMAGE_DATA_DIRECTORY x IMAGE_NUMBEROF_DIRECTORY_ENTRIES メンバについては後日)
<br />
</p></dd>
</dl>

<h4 id="idc7dcd8">リンカオプションで操作可能なメンバ</h4>

<p class="paragraph">
上記メンバから、リンカオプションで変更可能 or 影響を受けるメンバを抜き出す。
<br />
</p>
<table>
	<tr>
		<td> ImageBase </td>
		<td> &quot;/BASE&quot;, &quot;/FIXED&quot; </td>
	</tr>
	<tr>
		<td> SectionAlignment, SizeOfImage </td>
		<td> &quot;/ALIGN&quot; </td>
	</tr>
	<tr>
		<td> FileAlignment, SizeOfHeaders </td>
		<td> &quot;/OPT:WIN98&quot;(4KB) or &quot;/OPT:NOWIN98&quot;(512B) </td>
	</tr>
	<tr>
		<td> MajorImageVersion, MinorImageVersion </td>
		<td> &quot;/VERSION&quot; </td>
	</tr>
	<tr>
		<td> CheckSum </td>
		<td> &quot;/RELEASE&quot; </td>
	</tr>
	<tr>
		<td> SizeOfStackReserve, SizeOfStackCommit </td>
		<td> &quot;/STACK&quot; </td>
	</tr>
	<tr>
		<td> SizeOfHeapReserve, SizeOfHeapCommit </td>
		<td> &quot;/HEAP&quot; </td>
	</tr>
</table>

<h3 id="id338451">&quot;/BASE&quot;, &quot;/FIXED&quot; の影響を確認してみる</h3>

<p class="paragraph">
EXEとDLLで、&quot;/BASE&quot;, &quot;/FIXED&quot;の影響を確認してみる。
<br />
</p>

<h4 id="id151d2e">EXEファイルで &quot;/BASE&quot; の影響を確認してみる</h4>

<p class="paragraph">
まず単純なGUIプログラムでAddressOfEntryPoint, ImageBaseを確認してみる。
<br />
</p>

<p class="paragraph">
gui01.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">windows.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">strsafe.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">WINAPI</span><span class="hl-code"> </span><span class="hl-identifier">WinMain</span><span class="hl-brackets">(</span><span class="hl-code">
    </span><span class="hl-identifier">HINSTANCE</span><span class="hl-code"> </span><span class="hl-identifier">hInst</span><span class="hl-code">, 
    </span><span class="hl-identifier">HINSTANCE</span><span class="hl-code"> </span><span class="hl-identifier">hPrevInst</span><span class="hl-code">, 
    </span><span class="hl-identifier">LPSTR</span><span class="hl-code"> </span><span class="hl-identifier">lpCmdLine</span><span class="hl-code">, 
    </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">nCmdShow</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span >char</span><span class="hl-code"> </span><span class="hl-identifier">buf</span><span class="hl-brackets">[</span><span class="hl-number">1024</span><span class="hl-brackets">]</span><span class="hl-code">;
    </span><span class="hl-identifier">HANDLE</span><span class="hl-code"> </span><span class="hl-identifier">hModule</span><span class="hl-code"> = </span><span >NULL</span><span class="hl-code">;
    
    </span><span class="hl-identifier">hModule</span><span class="hl-code"> = </span><span class="hl-identifier">GetModuleHandle</span><span class="hl-brackets">(</span><span >NULL</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">StringCbPrintf</span><span class="hl-brackets">(</span><span class="hl-identifier">buf</span><span class="hl-code">, </span><span class="hl-reserved">sizeof</span><span class="hl-brackets">(</span><span class="hl-identifier">buf</span><span class="hl-brackets">)</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">GetModuleHandle() returns %X</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">hModule</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">MessageBox</span><span class="hl-brackets">(</span><span >NULL</span><span class="hl-code">, </span><span class="hl-identifier">buf</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">test</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">MB_OK</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
コンパイル：
<br />
</p>
<pre>&gt; cl gui01.c user32.lib
</pre>

<p class="paragraph">
dumpbinで確認：
<br />
</p>
<pre>&gt; dumpbin /headers gui01.exe
(...)
OPTIONAL HEADER VALUES
            (...)
            14CD entry point (004014CD)
            (...)
          400000 image base (00400000 to 0040EFFF)
</pre>

<p class="paragraph">
実行するとGetModuleHandle()の戻り値がImageBaseと同じ400000hであることが確認出来る。
<br />
デバッガ上で動作させ、メモリレイアウトを確認してみるとエントリポイントは
<br />
</p>
<pre>400000h + 14CDh = 4014CDh
</pre>
<p class="paragraph">
となっており、リンカによりリンクされたスタートアップルーチンから始まっていることが分かる。WinMain()のコードは&quot;.text&quot;セクションの先頭、401000hから始まっている。
<br />
</p>

<p class="paragraph">
続いて、今回デバッガ上で確認した時にメモリレイアウト上「空き」が出来ていた 00700000h 付近を&quot;/BASE&quot;リンカオプションで指定してみる。
<br />
</p>

<p class="paragraph">
リンク：
<br />
</p>
<pre>&gt; link /BASE:0x700000 gui01.obj user32.lib
</pre>

<p class="paragraph">
dumpbinで確認：
<br />
</p>
<pre>&gt; dumpbin /headers gui01.exe
(...)
OPTIONAL HEADER VALUES
            (...)
            14CD entry point (007014CD)
            (...)
          700000 image base (00700000 to 0070EFFF)
</pre>

<p class="paragraph">
実行自体は問題なく、ImageBaseである700000hをMessageBox()で表示して正常終了した。
<br />
デバッガ上で動作させ、メモリレイアウトを確認したところ、確かに 700000h からヘッダーやセクションデータが展開されていることを確認出来た。
<br />
</p>

<p class="paragraph">
さらに、今度はシステムDLLがロードされるメモリアドレス7C800000h(kernel32.dll)を&quot;/BASE&quot;で指定してみる。
<br />
リンク：
<br />
</p>
<pre>&gt; link /BASE:0x7C800000 gui01.obj user32.lib
</pre>

<p class="paragraph">
dumpbinで確認：
<br />
</p>
<pre>&gt; dumpbin /headers gui01.exe
(...)
OPTIONAL HEADER VALUES
            (...)
            14CD entry point (7C8014CD)
            (...)
        7C800000 image base (7C800000 to 7C80EFFF)
</pre>

<p class="paragraph">
これを実行しようとすると、次のようなメッセージボックスが表示され異常終了する。
<br />
<a href="./../images/pe_format_exercise/pe_baseaddr_conflict01.jpg" title="" target="_blank"><img src="./../images/pe_format_exercise/pe_baseaddr_conflict01.jpg" alt="" title=""  /></a>
<br />
</p>

<p class="paragraph">
OllyDbgには次のログが表示されていた：
<br />
</p>
<pre>7C9A66C6 | 例外発生: C0000018 (CONFLICTING ADDRESSES)
</pre>

<p class="paragraph">
詳細まではここでは追わないが、やはりシステムDLLがmappingされる領域にImageBaseを持って行くのはトラブルの原因になるようだ。
<br />
</p>

<h4 id="id8390a2">DLLファイルで &quot;/BASE&quot;, &quot;/FIXED&quot; の影響を確認してみる</h4>

<p class="paragraph">
DLLを明示的に呼び出すdll_main.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">windows.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >typedef</span><span class="hl-code"> </span><span >int</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">CALLBACK</span><span class="hl-code">* </span><span class="hl-identifier">lp_foo</span><span class="hl-brackets">)</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code">, </span><span >int</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span >typedef</span><span class="hl-code"> </span><span >int</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">CALLBACK</span><span class="hl-code">* </span><span class="hl-identifier">lp_bar</span><span class="hl-brackets">)</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code">, </span><span >int</span><span class="hl-brackets">)</span><span class="hl-code">;
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">HINSTANCE</span><span class="hl-code"> </span><span class="hl-identifier">hDll</span><span class="hl-code">;
    </span><span class="hl-identifier">lp_foo</span><span class="hl-code"> </span><span class="hl-identifier">foo</span><span class="hl-code">;
    </span><span class="hl-identifier">lp_bar</span><span class="hl-code"> </span><span class="hl-identifier">bar</span><span class="hl-code">;
 
    </span><span class="hl-identifier">hDll</span><span class="hl-code"> = </span><span class="hl-identifier">LoadLibrary</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">dll_lib</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span >NULL</span><span class="hl-code"> == </span><span class="hl-identifier">hDll</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">dll load error.</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">1</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">dll module handle = %x</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">hDll</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">foo</span><span class="hl-code"> = </span><span class="hl-brackets">(</span><span class="hl-identifier">lp_foo</span><span class="hl-brackets">)</span><span class="hl-identifier">GetProcAddress</span><span class="hl-brackets">(</span><span class="hl-identifier">hDll</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">foo</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">!</span><span class="hl-identifier">foo</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">GetProcAddress error(foo).</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">FreeLibrary</span><span class="hl-brackets">(</span><span class="hl-identifier">hDll</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">2</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">foo() was found at %x</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">foo</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">bar</span><span class="hl-code"> = </span><span class="hl-brackets">(</span><span class="hl-identifier">lp_foo</span><span class="hl-brackets">)</span><span class="hl-identifier">GetProcAddress</span><span class="hl-brackets">(</span><span class="hl-identifier">hDll</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">bar</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">!</span><span class="hl-identifier">bar</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">GetProcAddress error(bar).</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">FreeLibrary</span><span class="hl-brackets">(</span><span class="hl-identifier">hDll</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">3</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">bar() was found at %x</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">bar</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">foo(2, 3) = %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">foo</span><span class="hl-brackets">(</span><span class="hl-number">2</span><span class="hl-code">, </span><span class="hl-number">3</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">bar(2, 3) = %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">bar</span><span class="hl-brackets">(</span><span class="hl-number">2</span><span class="hl-code">, </span><span class="hl-number">3</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">FreeLibrary</span><span class="hl-brackets">(</span><span class="hl-identifier">hDll</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
コンパイル：
<br />
</p>
<pre>&gt; cl dll_main.c
</pre>

<p class="paragraph">
foo()とbar()関数をexportするdll_lib.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">windows.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">__declspec</span><span class="hl-brackets">(</span><span class="hl-identifier">dllexport</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">foo</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">a</span><span class="hl-code">, </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">b</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">OutputDebugString</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">foo() start</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">a</span><span class="hl-code"> + </span><span class="hl-identifier">b</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">__declspec</span><span class="hl-brackets">(</span><span class="hl-identifier">dllexport</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">bar</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">a</span><span class="hl-code">, </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">b</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">OutputDebugString</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">bar() start</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">a</span><span class="hl-code"> * </span><span class="hl-identifier">b</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
 
</span><span class="hl-identifier">BOOL</span><span class="hl-code"> </span><span class="hl-identifier">WINAPI</span><span class="hl-code"> </span><span class="hl-identifier">DllMain</span><span class="hl-brackets">(</span><span class="hl-identifier">HINSTANCE</span><span class="hl-code"> </span><span class="hl-identifier">hInstance</span><span class="hl-code">, </span><span class="hl-identifier">DWORD</span><span class="hl-code"> </span><span class="hl-identifier">dwReason</span><span class="hl-code">, </span><span class="hl-identifier">LPVOID</span><span class="hl-code"> </span><span class="hl-identifier">lpvReserved</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-reserved">switch</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">dwReason</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-reserved">case</span><span class="hl-code"> </span><span class="hl-identifier">DLL_PROCESS_ATTACH</span><span class="hl-code">:
        </span><span class="hl-identifier">OutputDebugString</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">DllMain() : DLL_PROCESS_ATTACH</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-reserved">case</span><span class="hl-code"> </span><span class="hl-identifier">DLL_THREAD_ATTACH</span><span class="hl-code">:
        </span><span class="hl-identifier">OutputDebugString</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">DllMain() : DLL_THREAD_ATTACH</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-reserved">case</span><span class="hl-code"> </span><span class="hl-identifier">DLL_THREAD_DETACH</span><span class="hl-code">:
        </span><span class="hl-identifier">OutputDebugString</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">DllMain() : DLL_THREAD_DETACH</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-reserved">case</span><span class="hl-code"> </span><span class="hl-identifier">DLL_PROCESS_DETACH</span><span class="hl-code">:
        </span><span class="hl-identifier">OutputDebugString</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">DllMain() : DLL_PROCESS_DETACH</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-reserved">default</span><span class="hl-code">:
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span >TRUE</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
コンパイル：
<br />
</p>
<pre>&gt; cl /c dll_lib.c
</pre>

<p class="paragraph">
リンク：
<br />
</p>
<pre>&gt; link /DLL /OUT:dll_lib.dll dll_lib.obj
</pre>

<p class="paragraph">
dumpbinで確認：
<br />
</p>
<pre>&gt; dumpbin /headers dll_lib.dll
(...)
OPTIONAL HEADER VALUES
            (...)
            12D3 entry point (100012D3)
            (...)
        10000000 image base (10000000 to 1000CFFF)
</pre>

<p class="paragraph">
実行：
<br />
</p>
<pre>&gt; dll_main.exe
dll module handle = 10000000
foo() was found at 10001000
bar() was found at 10001020
foo(2, 3) = 5
bar(2, 3) = 6
</pre>

<p class="paragraph">
DLLのモジュールhandleがImageBaseと一致していることが確認出来る。
<br />
</p>

<p class="paragraph">
では、今回デバッガ上で確認した時にメモリレイアウト上「空き」が出来ていた 00700000h 付近を&quot;/BASE&quot;リンカオプションで指定してみる。
<br />
</p>

<p class="paragraph">
リンク：
<br />
</p>
<pre>&gt; link /DLL /OUT:dll_lib.dll /BASE:0x700000 dll_lib.obj
</pre>

<p class="paragraph">
dumpbinで確認：
<br />
</p>
<pre>&gt; dumpbin /headers dll_lib.dll
(...)
OPTIONAL HEADER VALUES
            (...)
            12D3 entry point (007012D3)
            (...)
          700000 image base (00700000 to 0070CFFF)
</pre>

<p class="paragraph">
実行：
<br />
</p>
<pre>&gt; dll_main.exe
dll module handle = 700000
foo() was found at 701000
bar() was found at 701020
foo(2, 3) = 5
bar(2, 3) = 6
</pre>

<p class="paragraph">
予想通り、ImageBaseの変更に合わせてモジュールhandleおよび関数本体(コード)の位置も変わっている。
<br />
</p>

<p class="paragraph">
では、いよいよ&quot;/BASE&quot;でdll_main.exeと同じ400000hをImageBaseに設定してみる。
<br />
リンク：
<br />
</p>
<pre>&gt; link /DLL /OUT:dll_lib.dll /BASE:0x400000 dll_lib.obj
</pre>

<p class="paragraph">
dumpbinで確認：
<br />
</p>
<pre>&gt; dumpbin /headers dll_lib.dll
(...)
OPTIONAL HEADER VALUES
            (...)
            12D3 entry point (004012D3)
            (...)
          400000 image base (00400000 to 0040CFFF)
</pre>

<p class="paragraph">
実行：
<br />
</p>
<pre>&gt; dll_main.exe
dll module handle = 3a0000
foo() was found at 3a1000
bar() was found at 3a1020
foo(2, 3) = 5
bar(2, 3) = 6
</pre>

<p class="paragraph">
既にdll_main.exeが展開されているため、3A0000h以降に再配置されたことが確認出来る。実際にデバッガ上でも、LoadLibrary()後に3A0000hからdll_lib.dllのPEイメージが展開されたことを確認出来た。
<br />
</p>

<p class="paragraph">
あとは&quot;/FIXED&quot;を組み合わせた時の挙動となる。
<br />
リンク：
<br />
</p>
<pre>&gt; link /DLL /OUT:dll_lib.dll /BASE:0x400000 /FIXED dll_lib.obj
</pre>

<p class="paragraph">
dumpbinで確認：
<br />
</p>
<pre>&gt; dumpbin /headers dll_lib.dll
(...)
OPTIONAL HEADER VALUES
            (...)
            12D3 entry point (004012D3)
            (...)
          400000 image base (00400000 to 0040BFFF)
</pre>

<p class="paragraph">
実行：
<br />
</p>
<pre>&gt; dll_main.exe
dll load error.
</pre>

<p class="paragraph">
デバッガを確認する前に、&quot;/FIXED&quot;の有無で変化したヘッダー情報をdumpbinから抜き出してみる。
<br />
まず IMAGE_FILE_HEADER の Characteristics に変化が見られる。
<br />
</p>
<dl>
<dt> &quot;/FIXED&quot;無し </dt>
<dd>
<pre>FILE HEADER VALUES
 (...)
 2102 characteristics
      Executable
      32 bit word machine
      DLL
</pre></dd>
<dt> &quot;/FIXED&quot;有り </dt>
<dd>
<pre>FILE HEADER VALUES
 (...)
 2103 characteristics
      Relocations stripped &lt;&lt;&lt; 追加
      Executable
      32 bit word machine
      DLL
</pre></dd>
<dd>このように&quot;/FIXED&quot;有りだと&quot;Relocations stripped&quot;フラグが加わる。</dd>
<dd>セクションにも変化が見られた。&quot;DUMPBIN /HEADERS&quot;の最後のSummary情報を比べてみる。</dd>
<dt> &quot;/FIXED&quot;無し </dt>
<dd>
<pre>Summary

      2000 .data
      2000 .rdata
      1000 .reloc
      7000 .text
</pre></dd>
<dt> &quot;/FIXED&quot;有り </dt>
<dd>
<pre>Summary

      2000 .data
      2000 .rdata
      7000 .text
</pre></dd>
<dd>&quot;/FIXED&quot;無しの場合は&quot;.reloc&quot;セクションが含まれていたが、&quot;/FIXED&quot;を指定した方には見当たらない。</dd>
</dl>

<p class="paragraph">
OllyDbgで見てみると、LoadLibrary()失敗のところで次のデバッグログが出力されていた：
<br />
</p>
<pre>7C9884DF | &quot;LDR: LdrRelocateImageWithBias() failed 0xc0000018 \
LDR: OldBase     : 00400000
LDR: NewBase     : 003A0000
LDR: Diff        : 0x7c94d6fa0012f83c
LDR: NextOffset  : 00000000
LDR: *NextOffset : 0x0
LDR: SizeOfBlock : 0x3a0000&quot;
</pre>

<p class="paragraph">
ImageBaseを変更しようとしたが失敗しているようだ。
<br />
</p>

<p class="paragraph">
以上、&quot;/BASE&quot;と&quot;/FIXED&quot;を指定することで故意にEXE側のメモリ領域とconflictさせる実験により、具体的な挙動を確認出来た。
<br />
</p>

<h4 id="id6b75fb">DLLと&quot;/NOENTRY&quot;オプションの実験</h4>

<p class="paragraph">
今回サンプルで作成したdll_lib.cには、DllMain()関数を用意している。DUMPBINでも EntryPoint に値が設定されており、CRTの用意したエントリポイントを通じてDllMain()が呼ばれていることをデバッガ上で確認出来る(OutputDebugString()のログ出力)。
<br />
</p>

<p class="paragraph">
ここで &quot;/NOENTRY&quot; リンカオプションを使い、EntryPointがどう設定されるか、DllMain()の呼び出しがどうなるか確認する。
<br />
</p>

<p class="paragraph">
リンク：
<br />
</p>
<pre>&gt; link /DLL /OUT:dll_lib.dll /NOENTRY dll_lib.obj kernel32.lib
</pre>
<p class="paragraph">
※ここまでkernel32.libを指定する必要が無かったが、&quot;/NOENTRY&quot;を指定した途端にOutputDebugString()が見つからなくなったので、急遽リンカにkernel32.libを追加。
<br />
</p>

<p class="paragraph">
dumpbinで確認：
<br />
</p>
<pre>&gt; dumpbin /headers dll_lib.dll
(...)
OPTIONAL HEADER VALUES
            (...)
               0 entry point
            (...)
</pre>

<p class="paragraph">
デバッガ上で実行し、OutputDebugString()のログ出力を確認すると、DllMain()が呼ばれなくなっていることを確認出来た。
<br />
</p>

<h3 id="ide8ca6e">&quot;/ALIGN&quot; の影響を確認してみる</h3>

<p class="paragraph">
cui01.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">argc</span><span class="hl-code">, </span><span >char</span><span class="hl-code"> *</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">Hello, World!</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
コンパイル：
<br />
</p>
<pre>&gt; cl /c cui01.c
</pre>

<p class="paragraph">
特にオプションを付けずにリンク：
<br />
</p>
<pre>&gt;link cui01.obj
</pre>

<p class="paragraph">
dumpbinで確認：
<br />
</p>
<pre>&gt; dumpbin /headers cui01.exe
(...)
OPTIONAL HEADER VALUES
            (...)
            1000 base of code
            A000 base of data
            (...)
            1000 section alignment
            (...)
            F000 size of image
            (...)
SECTION HEADER #1
   .text name
    8884 virtual size # -&gt; 1000hByteで丸めると9000h
    1000 virtual address (00401000 to 00409883)
    8A00 size of raw data
    (...)
SECTION HEADER #2
  .rdata name
    1D94 virtual size # -&gt; 1000hByteで丸めると2000h
    A000 virtual address (0040A000 to 0040BD93)
    1E00 size of raw data
    (...)
SECTION HEADER #3
   .data name
    2AC8 virtual size # -&gt; 1000hByteで丸めると3000h
    C000 virtual address (0040C000 to 0040EAC7)
    1000 size of raw data
    (...)

 Summary

       3000 .data
       2000 .rdata
       9000 .text
</pre>

<p class="paragraph">
なお&quot;base of code&quot;のRVA(1000h)はヘッダー用のセクション1000h(1ページ)分押し上げられた数値と思われる。&quot;.code&quot;セクションは9000hに丸められるので、&quot;base of data&quot;のRVA(A000h)は
<br />
</p>
<pre>1000h + 9000h = A000h
</pre>
<p class="paragraph">
として算出されたと思われる。
<br />
</p>

<p class="paragraph">
デバッガ上で動作させ、cui01.exeのメモリロード状況を確認：
<br />
</p>
<table>
	<tr>
		<td> 開始アドレス </td>
		<td> サイズ </td>
		<td> セクション/内容 </td>
	</tr>
	<tr>
		<td> 00400000h </td>
		<td> 00001000h </td>
		<td> PE header </td>
	</tr>
	<tr>
		<td> 00401000h </td>
		<td> 00009000h </td>
		<td> .text, code </td>
	</tr>
	<tr>
		<td> 0040A000h </td>
		<td> 00002000h </td>
		<td> .rdata, imports </td>
	</tr>
	<tr>
		<td> 0040C000h </td>
		<td> 00003000h </td>
		<td> .data, data </td>
	</tr>
</table>

<p class="paragraph">
&quot;/ALIGN:0x2000&quot;オプションでセクションalignmentを2KBにしてリンク：
<br />
</p>
<pre>&gt; link /ALIGN:0x2000 cui01.obj
LINK : warning LNK4108: /DRIVER なしで /ALIGN オプションが指定されました。\
イメージは正しく動作しない可能性があります。
</pre>

<p class="paragraph">
dumpbinで確認：
<br />
</p>
<pre>&gt; dumpbin /headers heap01.exe
(...)
OPTIONAL HEADER VALUES
            (...)
            2000 base of code
            C000 base of data
            (...)
            2000 section alignment
            (...)
           12000 size of image
            (...)
SECTION HEADER #1
   .text name
    8884 virtual size # -&gt; 2000hByteで丸めるとA000h
    2000 virtual address (00402000 to 0040A883)
    8A00 size of raw data
    (...)
SECTION HEADER #2
  .rdata name
    1D94 virtual size # -&gt; 2000hByteで丸めると2000h
    C000 virtual address (0040C000 to 0040DD93)
    1E00 size of raw data
    (...)
SECTION HEADER #3
   .data name
    2AC8 virtual size # -&gt; 2000hByteで丸めると4000h
    E000 virtual address (0040E000 to 00410AC7)
    1000 size of raw data
    (...)
 Summary

       4000 .data
       2000 .rdata
       A000 .text
</pre>

<p class="paragraph">
なお&quot;base of code&quot;のRVA(2000h)はヘッダー用のセクション2000h(1ページ)分押し上げられた数値と思われる。&quot;.code&quot;セクションはA000hに丸められるので、&quot;base of data&quot;のRVA(C000h)は
<br />
</p>
<pre>2000h + A000h = C000h
</pre>
<p class="paragraph">
として算出されたと思われる。
<br />
</p>

<p class="paragraph">
デバッガ上で動作させ、cui01.exeのメモリロード状況を確認：
<br />
</p>
<table>
	<tr>
		<td> 開始アドレス </td>
		<td> サイズ </td>
		<td> セクション/内容 </td>
	</tr>
	<tr>
		<td> 00400000h </td>
		<td> 00001000h </td>
		<td> PE header </td>
	</tr>
	<tr>
		<td> 00402000h </td>
		<td> 00009000h </td>
		<td> .text, code </td>
	</tr>
	<tr>
		<td> 0040C000h </td>
		<td> 00002000h </td>
		<td> .rdata, imports </td>
	</tr>
	<tr>
		<td> 0040E000h </td>
		<td> 00003000h </td>
		<td> .data, data </td>
	</tr>
</table>

<p class="paragraph">
サイズは実際のページサイズ(1000h=4KiB)になっているが、開始アドレス自体は実行ファイルのヘッダーに設定されている値通りの配置になっていることが分かる。
<br />
</p>

<p class="paragraph">
今回のサンプルコードの場合、どちらの実行イメージでも問題なく正常終了した。
<br />
</p>

<h3 id="idfdf1e5">&quot;/OPT:WIN98&quot;(4KB) or &quot;/OPT:NOWIN98&quot;(512B)  の影響を確認してみる</h3>

<p class="paragraph">
結論を先に書くと、&quot;Microsoft (R) Incremental Linker Version 9.00.30729.01&quot; においては&quot;/OPT:WIN98&quot;および&quot;/OPT:NOWIN98&quot;オプションはサポートされない。指定しても、warningが表示され、無視される。元々win98での実行ファイルイメージのキャッシュなどに効果を発揮するオプション選択であり、既に使われなくなったとしてサポートが打ち切られたものと推測される。
<br />
</p>

<p class="paragraph">
cui01.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">argc</span><span class="hl-code">, </span><span >char</span><span class="hl-code"> *</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">Hello, World!</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
コンパイル：
<br />
</p>
<pre>&gt; cl /c cui01.c
</pre>

<p class="paragraph">
&quot;/OPT:WIN98&quot;オプションでリンク：
<br />
</p>
<pre>&gt; link /OUT:cui01_win98.exe /OPT:WIN98 cui01.obj
LINK : warning LNK4224: /OPT:WIN98 はサポートされていません。無視されます。
</pre>

<p class="paragraph">
dumpbinで確認：
<br />
</p>
<pre>&gt; dumpbin /headers cui01_win98.exe
(...)
OPTIONAL HEADER VALUES
            (...)
            200 file alignment
            (...)
            400 size of headers
            (...)
SECTION HEADER #1
   .text name
     (...)
     400 file pointer to raw data (00000400 to 00008DFF)
     (...)
SECTION HEADER #2
   .rdata name
     (...)
    8E00 file pointer to raw data (00008E00 to 0000ABFF)
     (...)
SECTION HEADER #3
   .data name
     (...)
    AC00 file pointer to raw data (0000AC00 to 0000BBFF)
     (...)
</pre>

<p class="paragraph">
FileAlignmentは200h(=512B)、ヘッダー群のファイル上のサイズは400h。以降、セクションの実体データが400hから続くが、&quot;.text&quot;, &quot;.rdata&quot;, &quot;.data&quot;の順で200hに丸められてファイル上に並んでいる。
<br />
</p>

<p class="paragraph">
&quot;/OPT:NOWIN98&quot;オプションでリンク：
<br />
</p>
<pre>&gt; link /OUT:cui01_nowin98.exe /OPT:NOWIN98 cui01.obj
LINK : warning LNK4224: /OPT:NOWIN98 はサポートされていません。無視されます。
</pre>

<p class="paragraph">
dumpbinで確認：
<br />
</p>
<pre>&gt; dumpbin /headers cui01_nowin98.exe
(FileAlignment関連は cui01_win98.exe と同様なので省略)
</pre>

<h3 id="id88d6ad">&quot;Subsystem&quot;フィールドの値で遊んでみる</h3>

<p class="paragraph">
CRTのprintf()を使ったメッセージ出力ですが、Windows GUIプログラム(Subsystem = 2)ではコンソールが作成されないので、表示されません。そこで、ふと、「じゃぁ直接Subsystemを3(CUI)にしてみたらどうだろう」とやってみました。
<br />
</p>

<p class="paragraph">
gui02.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">windows.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">strsafe.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">WINAPI</span><span class="hl-code"> </span><span class="hl-identifier">WinMain</span><span class="hl-brackets">(</span><span class="hl-code">
    </span><span class="hl-identifier">HINSTANCE</span><span class="hl-code"> </span><span class="hl-identifier">hInst</span><span class="hl-code">, 
    </span><span class="hl-identifier">HINSTANCE</span><span class="hl-code"> </span><span class="hl-identifier">hPrevInst</span><span class="hl-code">, 
    </span><span class="hl-identifier">LPSTR</span><span class="hl-code"> </span><span class="hl-identifier">lpCmdLine</span><span class="hl-code">, 
    </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">nCmdShow</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">i</span><span class="hl-code">;
    </span><span >char</span><span class="hl-code"> </span><span class="hl-identifier">buf</span><span class="hl-brackets">[</span><span class="hl-number">1024</span><span class="hl-brackets">]</span><span class="hl-code">;
    </span><span class="hl-reserved">for</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">i</span><span class="hl-code"> = </span><span class="hl-number">0</span><span class="hl-code">; </span><span class="hl-identifier">i</span><span class="hl-code"> &lt; </span><span class="hl-number">5</span><span class="hl-code">; </span><span class="hl-identifier">i</span><span class="hl-code">++</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">StringCbPrintf</span><span class="hl-brackets">(</span><span class="hl-identifier">buf</span><span class="hl-code">, </span><span class="hl-reserved">sizeof</span><span class="hl-brackets">(</span><span class="hl-identifier">buf</span><span class="hl-brackets">)</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">count = %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">i</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">MessageBox</span><span class="hl-brackets">(</span><span >NULL</span><span class="hl-code">, </span><span class="hl-identifier">buf</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">test</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">MB_OK</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-identifier">buf</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
普通に
<br />
</p>
<pre>&gt; cl gui02.c user32.lib
</pre>
<p class="paragraph">
すると、GUI用のプログラムになります。つまりMessageBox()は表示されますが、printf()はどこにも出力されず裏側で捨てられてしまいます。
<br />
</p>

<p class="paragraph">
ここでバイナリエディタ等でIMAGE_OPTIONAL_HEADERのSubsystemフィールド相当箇所を直接3に書き換えると、実行時にコンソールが作成され、そちらに出力されるようになります。
<br />
</p>

<p class="paragraph">
元々表示されないのですからわざわざprintf()でデバッグメッセージを出力したりしていることは無いと思いますが、逆に、Subsystemをわざわざバイナリエディタで弄るような奇特な人向けのいたずらメッセージを仕込んでおきたい場合等は有用かも知れません。
<br />
</p>

<h3 id="id797006">&quot;/VERSION&quot; の影響を確認してみる</h3>

<p class="paragraph">
cui01.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">argc</span><span class="hl-code">, </span><span >char</span><span class="hl-code"> *</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">Hello, World!</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>
<p class="paragraph">
コンパイル：
<br />
</p>
<pre>&gt; cl /c cui01.c
</pre>

<p class="paragraph">
特にオプションを付けずにリンク：
<br />
</p>
<pre>&gt;link cui01.obj
</pre>

<p class="paragraph">
dumpbinで確認：
<br />
</p>
<pre>&gt; dumpbin /headers cui01.exe
(...)
OPTIONAL HEADER VALUES
            (...)
            0.00 image version
</pre>

<p class="paragraph">
続いて、適当な&quot;/VERSION&quot;リンカオプションでリンク：
<br />
</p>
<pre>&gt; link /VERSION:10.2 cui01.obj
</pre>

<p class="paragraph">
dumpbinで確認：
<br />
</p>
<pre>&gt; dumpbin /headers cui01.exe
(...)
OPTIONAL HEADER VALUES
            (...)
            10.02 image version
            ^^^^^
</pre>


<h3 id="idfbf59f">&quot;/RELEASE&quot; の影響を確認してみる</h3>

<p class="paragraph">
cui01.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">argc</span><span class="hl-code">, </span><span >char</span><span class="hl-code"> *</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">Hello, World!</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>
<p class="paragraph">
コンパイル：
<br />
</p>
<pre>&gt; cl /c cui01.c
</pre>

<p class="paragraph">
特にオプションを付けずにリンク：
<br />
</p>
<pre>&gt;link cui01.obj
</pre>

<p class="paragraph">
dumpbinで確認：
<br />
</p>
<pre>&gt; dumpbin /headers cui01.exe
(...)
OPTIONAL HEADER VALUES
            (...)
            0 checksum
</pre>

<p class="paragraph">
続いて、&quot;/RELEASE&quot;リンカオプションでリンク：
<br />
</p>
<pre>&gt; link /RELEASE cui01.obj
</pre>

<p class="paragraph">
dumpbinで確認：
<br />
</p>
<pre>&gt; dumpbin /headers cui01.exe
(...)
OPTIONAL HEADER VALUES
            (...)
            D126 checksum
            ^^^^
</pre>

<p class="paragraph">
バイナリエディタで該当部分を適当なバイナリ値に書き換えて実行してみる。
<br />
→正常に実行出来た。デバイスドライバやシステムDLLだと無理なのかも知れないが、さすがにそこまで実験する余力はないのでスルー。
<br />
また、WinXP+SP3上での実験なので、Vista/Win7含む将来のアップデートなどでどうなるかは不明。
<br />
</p>

<h3 id="id01e6aa">&quot;/STACK&quot; の影響を確認してみる</h3>

<p class="paragraph">
プロセスの初期スレッドに割り当てられるスレッドサイズは、デフォルトでは1MBとなっている。これを&quot;/STACK&quot;リンカオプションで変更してみる。
<br />
</p>

<p class="paragraph">
最初に、スタック上に1MBを超えるデータを確保するプログラムを作成し、スタックオーバーフローが発生するのを確認する。
<br />
stack01.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >#define</span><span class="hl-code"> </span><span class="hl-identifier">STACK_VAR_SIZE</span><span class="hl-code"> </span><span class="hl-number">0x100000</span><span ></span><span class="hl-code">
 
</span><span >void</span><span class="hl-code"> </span><span class="hl-identifier">fun</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span >char</span><span class="hl-code"> </span><span class="hl-identifier">data</span><span class="hl-brackets">[</span><span class="hl-identifier">STACK_VAR_SIZE</span><span class="hl-brackets">]</span><span class="hl-code">;
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">length = %x</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-reserved">sizeof</span><span class="hl-brackets">(</span><span class="hl-identifier">data</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">argc</span><span class="hl-code">, </span><span >char</span><span class="hl-code"> *</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">fun() start.</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">fun</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">fun() end.</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
コンパイル：
<br />
</p>
<pre>&gt; cl /c stack01.c
</pre>

<p class="paragraph">
特にオプションを付けずにリンク：
<br />
</p>
<pre>&gt;link stack01.obj
</pre>

<p class="paragraph">
dumpbinで確認：
<br />
</p>
<pre>&gt; dumpbin /headers stack01.exe
(...)
OPTIONAL HEADER VALUES
            (...)
            100000 size of stack reserve
</pre>

<p class="paragraph">
ここでstack01.exeをデバッガ上で実行すると、fun()内でスタックオーバーフローが発生する。
<br />
</p>

<p class="paragraph">
続いて &quot;/STACK&quot; オプションを使ってスタックサイズを2倍にしてみる。
<br />
</p>
<pre>&gt; link /STACK:0x200000 stack01.obj
</pre>

<p class="paragraph">
dumpbinで確認：
<br />
</p>
<pre>&gt; dumpbin /headers stack01.exe
(...)
OPTIONAL HEADER VALUES
            (...)
            200000 size of stack reserve
</pre>

<p class="paragraph">
実行してみると、スタックオーバーフローは発生せず、正常に処理を実行し、終了する。
<br />
</p>

<p class="paragraph">
最後にコミットサイズも指定してみる：
<br />
</p>
<pre>&gt; link /STACK:0x200000,0x2000 stack01.obj
</pre>

<p class="paragraph">
dumpbinで確認：
<br />
</p>
<pre>&gt; dumpbin /headers stack01.exe
(...)
OPTIONAL HEADER VALUES
            (...)
            200000 size of stack reserve
              2000 size of stack commit
</pre>

<h3 id="id9fe59a">&quot;/HEAP&quot; の影響を確認してみる</h3>

<p class="paragraph">
heap01.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">windows.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">argc</span><span class="hl-code">, </span><span >char</span><span class="hl-code"> *</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">HANDLE</span><span class="hl-code"> </span><span class="hl-identifier">hHeap</span><span class="hl-code"> = </span><span >NULL</span><span class="hl-code">;
    </span><span >void</span><span class="hl-code"> *</span><span class="hl-identifier">ptr</span><span class="hl-code"> = </span><span >NULL</span><span class="hl-code">;
    </span><span class="hl-identifier">hHeap</span><span class="hl-code"> = </span><span class="hl-identifier">GetProcessHeap</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">Heap Handle = 0x%x</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">hHeap</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">ptr</span><span class="hl-code"> = </span><span class="hl-identifier">HeapAlloc</span><span class="hl-brackets">(</span><span class="hl-identifier">hHeap</span><span class="hl-code">, </span><span class="hl-identifier">HEAP_ZERO_MEMORY</span><span class="hl-code">, </span><span class="hl-number">10</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">ptr = 0x%x</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">ptr</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
コンパイル：
<br />
</p>
<pre>&gt; cl /c heap01.c
</pre>

<p class="paragraph">
特にオプションを付けずにリンク：
<br />
</p>
<pre>&gt;link heap01.obj
</pre>

<p class="paragraph">
dumpbinで確認：
<br />
</p>
<pre>&gt; dumpbin /headers heap01.exe
(...)
OPTIONAL HEADER VALUES
            (...)
            100000 size of heap reserve
              1000 size of heap commit
</pre>

<p class="paragraph">
&quot;/HEAP&quot;オプション付きでリンク：
<br />
</p>
<pre>&gt; link /HEAP:0x200000,0x5000 heap01.obj
</pre>

<p class="paragraph">
dumpbinで確認：
<br />
</p>
<pre>&gt; dumpbin /headers heap01.exe
(...)
OPTIONAL HEADER VALUES
            (...)
            200000 size of heap reserve
              5000 size of heap commit
</pre>

<h3 id="id0227a3">参考URL</h3>

<ul><li> Inside Windows: An In-Depth Look into the Win32 Portable Executable File Format, Part1 (2002)<ul><li> <a class="externallink" href="http://msdn.microsoft.com/en-us/magazine/cc301805.aspx" target="_blank">http://msdn.microsoft.com/en-us/magazine/cc301805.aspx</a></li></ul></li>
<li> Inside Windows: An In-Depth Look into the Win32 Portable Executable File Format, Part2 (2002)<ul><li> <a class="externallink" href="http://msdn.microsoft.com/en-us/magazine/cc301808.aspx" target="_blank">http://msdn.microsoft.com/en-us/magazine/cc301808.aspx</a></li></ul></li>
<li> PE(Portable Executable)ファイルフォーマット その1 ファイルの基本構造<ul><li> <a class="externallink" href="http://hp.vector.co.jp/authors/VA050396/tech_06.html" target="_blank">http://hp.vector.co.jp/authors/VA050396/tech_06.html</a></li></ul></li></ul>

<p class="paragraph">
他、&quot;DUMPBIN /HEADERS&quot;と同様の処理をPythonスクリプトで組んでみた練習記事：
<br />
</p>
<ul><li> <a href="./view-660.html" >日記/2010/05/25/PEフォーマットのIMAGE_DOS_HEADERを眺めてみる</a></li>
<li> <a href="./view-661.html" >日記/2010/05/25/IMAGE_NT_HEADERSとIMAGE_FILE_HEADERを覗いてみる。</a></li>
<li> <a href="./view-662.html" >日記/2010/05/25/IMAGE_OPTIONAL_HEADERを覗いてみる。</a></li>
<li> <a href="./view-663.html" >日記/2010/05/26/IMAGE_SECTION_HEADERを覗いてみる。</a></li></ul>

<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-708.html" title="技術/Windows/PE(Portable Executable)フォーマットの実験">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-678.html" title="技術/Windows/PE(Portable Executable)フォーマットの実験/02, 再配置情報で遊ぼう！">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-708.html" title="技術/Windows/PE(Portable Executable)フォーマットの実験">Up</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-23.html" title="技術">技術</a>&nbsp;]</li>
</ul>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/664<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2001 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a target="_blank" href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" target="_blank" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>