<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>日記/2009/11/28/gccでstaticリンクさせようと手動でldコマンド動かしたメモ - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">日記/2009/11/28/gccでstaticリンクさせようと手動でldコマンド動かしたメモ</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2009-11-28 16:36:46 &nbsp; / &nbsp; last updated at: 2009-11-28 16:39:08<br>
カテゴリ: <a href="category-10.html">C言語</a>&nbsp;<a href="category-20.html">Linux</a>&nbsp;<a href="category-38.html">UNIX</a>&nbsp;</div>

<div class="data_body">
<p class="paragraph">
西田亙氏の「GNU DEVELOPMENT TOOLS」を読み返していて、第６章の静的リンクのところで躓いた。GCCやbinutilsのバージョンが大分変わっているのもあったと思う。
<br />
</p>

<p class="paragraph">
自分の環境：CentOS 5.2
<br />
</p>
<pre>$ rpm -q --qf &quot;%{NAME},%{VERSION}\n&quot; gcc binutils
gcc,4.1.2
binutils,2.17.50.0.6
</pre>

<p class="paragraph">
具体的には、hello.cをstaticリンクさせようとして手動でldコマンド実行したが、crt1.o, crti.o, hello.o, libc.a, libgcc.a, crtn.o だけだと未解決シンボルが出てリンクに失敗する。
<br />
結論を先に書くと、libgcc.aの後ろに libgcc_eh.a を置き、さらにその後ろに libc.a をもう一度指定することでリンクは成功する。
<br />
</p>



<hr />
<p class="paragraph">
下準備：
<br />
</p>
<pre class="plugin_pre">
$ cat hello.c
#include &lt;stdio.h&gt;

#define MESSAGE &quot;Hello, World&quot;

int main() {
    printf(&quot;%s\n&quot;, MESSAGE);
    return 123;
}

$ gcc -c -o hello.o hello.c ; echo $?
0
$ file hello.o
hello.o: ELF 32-bit LSB relocatable, Intel 80386, version 1 (SYSV), not stripped
</pre>

<p class="paragraph">
リンク失敗：
<br />
</p>
<pre class="plugin_pre">
$ ld \
&gt; /usr/lib/crt1.o \
&gt; /usr/lib/crti.o \
&gt; hello.o \
&gt; /usr/lib/libc.a \
&gt; `gcc -print-libgcc-file-name` \
&gt; /usr/lib/crtn.o
/usr/lib/libc.a(ioputs.o): In function `puts&#039;:
(.text+0x146): undefined reference to `_Unwind_Resume&#039;
/usr/lib/libc.a(ioputs.o):(.eh_frame+0xde): undefined reference to `__gcc_personality_v0&#039;
/usr/lib/libc.a(syslog.o): In function `openlog&#039;:
(.text+0x332): undefined reference to `_Unwind_Resume&#039;
...
/usr/lib/libc.a(iogetdelim.o): In function `getdelim&#039;:
(.text+0x26c): undefined reference to `_Unwind_Resume&#039;
/usr/lib/libc.a(iogetdelim.o):(.eh_frame+0xde): undefined reference to `__gcc_personality_v0&#039;
$ echo $?
1
</pre>
<p class="paragraph">
&quot;_Unwind_Resume&quot;というのと&quot;__gcc_personality_v0&quot;の２つのシンボルが見つからない。
<br />
</p>

<p class="paragraph">
試しに、普通にgccから&quot;-static&quot;オプションをつけて実行してみる。&quot;-v&quot;付で途中経過を表示させてみたところ：
<br />
</p>
<pre>/usr/libexec/gcc/i386-redhat-linux/4.1.2/collect2 -m elf_i386 
--hash-style=gnu 
-static 
-o hello_static 
/usr/lib/gcc/i386-redhat-linux/4.1.2/../../../crt1.o 
/usr/lib/gcc/i386-redhat-linux/4.1.2/../../../crti.o 
/usr/lib/gcc/i386-redhat-linux/4.1.2/crtbeginT.o 
-L/usr/lib/gcc/i386-redhat-linux/4.1.2 
-L/usr/lib/gcc/i386-redhat-linux/4.1.2 
-L/usr/lib/gcc/i386-redhat-linux/4.1.2/../../.. /tmp/ccxsa3ji.o 
--start-group 
-lgcc 
-lgcc_eh 
-lc 
--end-group 
/usr/lib/gcc/i386-redhat-linux/4.1.2/crtend.o 
/usr/lib/gcc/i386-redhat-linux/4.1.2/../../../crtn.o
</pre>
<p class="paragraph">
なんとなく
<br />
</p>
<pre>--start-group 
-lgcc 
-lgcc_eh 
-lc 
--end-group 
</pre>
<p class="paragraph">
というのが怪しそうな感じがする。とくに&quot;-lgcc_eh&quot;というのは何だろう。
<br />
というわけで、libgcc.aのあるディレクトリに潜ってみる。
<br />
</p>
<pre>$ gcc -print-libgcc-file-name
/usr/lib/gcc/i386-redhat-linux/4.1.2/libgcc.a
$ cd /usr/lib/gcc/i386-redhat-linux/4.1.2/
$ ls *.a
libgcc.a  libgcc_eh.a  ...
</pre>
<p class="paragraph">
&quot;libgcc_eh.a&quot;のシンボルをgrepしてみる。
<br />
</p>
<pre>$ nm libgcc_eh.a | grep &quot;_Unwind_Resume&quot;
nm: unwind-sjlj.o: no symbols
00002160 T _Unwind_Resume
00002060 T _Unwind_Resume_or_Rethrow
$ nm libgcc_eh.a | grep &quot;__gcc_personality_v0&quot;
nm: unwind-sjlj.o: no symbols
00000220 T __gcc_personality_v0
</pre>
<p class="paragraph">
このように、libgcc_eh.aの中に格納されていた。
<br />
というわけで、libgcc_eh.aを追加してみる。
<br />
</p>
<pre class="plugin_pre">
$ ld \
&gt; /usr/lib/crt1.o \
&gt; /usr/lib/crti.o \
&gt; hello.o \
&gt; /usr/lib/libc.a \
&gt; `gcc -print-libgcc-file-name` \
&gt; `gcc -print-file-name=libgcc_eh.a` \
&gt; /usr/lib/crtn.o
/usr/lib/gcc/i386-redhat-linux/4.1.2/libgcc_eh.a(unwind-dw2.o): In function `.L125&#039;:
(.text+0x958): undefined reference to `__stack_chk_fail_local&#039;
/usr/lib/gcc/i386-redhat-linux/4.1.2/libgcc_eh.a(unwind-dw2.o): In function `__frame_state_for&#039;:
(.text+0xf26): undefined reference to `__stack_chk_fail_local&#039;
/usr/lib/gcc/i386-redhat-linux/4.1.2/libgcc_eh.a(unwind-dw2.o): In function `.L413&#039;:
(.text+0x1896): undefined reference to `__stack_chk_fail_local&#039;
/usr/lib/gcc/i386-redhat-linux/4.1.2/libgcc_eh.a(unwind-dw2.o): In function `_Unwind_Backtrace&#039;:
(.text+0x1ce1): undefined reference to `__stack_chk_fail_local&#039;
/usr/lib/gcc/i386-redhat-linux/4.1.2/libgcc_eh.a(unwind-dw2.o): In function `_Unwind_RaiseException&#039;:
(.text+0x1f43): undefined reference to `__stack_chk_fail_local&#039;
/usr/lib/gcc/i386-redhat-linux/4.1.2/libgcc_eh.a(unwind-dw2.o):(.text+0x2155): more undefined references to `__stack_chk_fail_local&#039; follow
/usr/lib/gcc/i386-redhat-linux/4.1.2/libgcc_eh.a(unwind-dw2-fde-glibc.o): In function `_Unwind_Find_FDE&#039;:
(.text+0x1508): undefined reference to `dl_iterate_phdr&#039;
$ echo $?
1
</pre>
<p class="paragraph">
まだ終了ステータスが1、失敗である。先ほどまでのシンボル未定義は解消されたようだが、新たに次の２つが未定義となってしまった。
<br />
</p>
<pre>__stack_chk_fail_local
dl_iterate_phdr
</pre>
<p class="paragraph">
ところが、いろいろnmで漁っていると &quot;libc.a&quot; の方のTextセクションに定義されている。
<br />
</p>
<pre>$ nm /usr/lib/libc.a 2&gt;/dev/null | grep __stack_chk_fail_local
00000000 T __stack_chk_fail_local
$ nm /usr/lib/libc.a 2&gt;/dev/null | grep dl_iterate_phdr
00000000 T __dl_iterate_phdr
000000f0 T dl_iterate_phdr
</pre>

<p class="paragraph">
ldは引数で指定された順番でオブジェクトファイルを結合していく・・・筈だったような気がする・・・ので、試しにlibgcc_eh.aの後ろにもう一度libc.aを置いてみる。
<br />
</p>
<pre class="plugin_pre">
$ ld \
&gt; /usr/lib/crt1.o \
&gt; /usr/lib/crti.o \
&gt; hello.o \
&gt; /usr/lib/libc.a \
&gt; `gcc -print-libgcc-file-name` \
&gt; `gcc -print-file-name=libgcc_eh.a` \
&gt; /usr/lib/libc.a \
&gt; /usr/lib/crtn.o
$ echo $?
0
</pre>
<p class="paragraph">
今度は上手く行ったようである。
<br />
</p>
<pre>$ ./a.out
Hello, World
$ file a.out
a.out: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), \
for GNU/Linux 2.6.9, statically linked, for GNU/Linux 2.6.9, not stripped
$ ldd ./a.out
      not a dynamic executable
</pre>

<p class="paragraph">
今回は練習なので「リンク成功、動いてオッケー」で済ませたが、それにしてもlibgcc_eh.aファイルが何物か？など疑問が尽きない。
<br />
他にも今回の試行錯誤の過程で、実は &quot;/usr/lib/libc_nonshared.a&quot; というのをリンクさせようとして、いったんはそれで上手く行きそうに見えたのだけれど結局 &quot;libc.a&quot; を後ろにもう一度置くだけでOKになった。で、この&quot;libc_nonshared.a&quot;というのも分からない。
<br />
</p>

<p class="paragraph">
ここら辺を突っ込もうと思ったらinfoやgcc/binutilsのソースコードまで踏み込まないと駄目なんだろうなーと思うけど、それは後の楽しみに取っておく事にする・・・というか調べるだけの気力がまだ無いのでスルーしただけです。根性無し。
<br />
</p>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/503<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2001 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a target="_blank" href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" target="_blank" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>