<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>技術/Windows/UACを触ってみたメモ - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">技術/Windows/UACを触ってみたメモ</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2010-11-12 23:13:34 &nbsp; / &nbsp; last updated at: 2010-11-12 23:26:58<br>
カテゴリ: <a href="category-8.html">Windows</a>&nbsp;<a href="category-12.html">プログラミング</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-829.html" title="技術/Windows/UACとRunAsについてのメモ">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-930.html" title="技術/Windows/UI Automation">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-23.html" title="技術">技術</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
Win7(32bit)でUACを触ってみたメモ。
<br />
Administratorsグループに所属するユーザでログインし、コマンドプロンプトを２つ立ち上げ、ただし片方は「管理者として実行」していろいろ試してみました。
<br />
</p>

<p class="paragraph">
未来の自分向けであるのは勿論ですが、UACと付き合うときに試行錯誤しつつ作るであろう実験コードのサンプルになれば幸いです。
<br />
</p>



<ul><li><a href="#ide6f80f">参考URL</a><ul><li><a href="#id086562">UACそのものについての参考URL：</a></li>
<li><a href="#idba33fd">前半「とりあえず権限昇格する前後のTOKENをいくつか見てみる」の参考URL：</a></li>
<li><a href="#id6c6ae0">後半「権限昇格したプロセスから、未昇格状態のプロセスを起動する」の参考URL：</a></li></ul></li>
<li><a href="#id5e44c7">とりあえず権限昇格する前後のTOKENをいくつか見てみる</a><ul><li><a href="#idd5b4d2">TokenElevation</a></li>
<li><a href="#id710ad9">TokenElevationType</a></li>
<li><a href="#id589d78">TokenPrivileges</a></li>
<li><a href="#id8e1bcc">TokenMandatoryPolicy</a></li>
<li><a href="#idd96bf0">TokenIntegrityLevel</a></li>
<li><a href="#id2baf9a">TokenLinkedToken</a></li></ul></li>
<li><a href="#id6c4e2f">権限昇格したプロセスから、未昇格状態のプロセスを起動する</a><ul><li><a href="#id02c826">まずは実験用のCreateProcess()される側のプログラムを用意する。</a></li>
<li><a href="#idb151fa">セオリー通りにShellExecuteEx()で起動してみる</a></li>
<li><a href="#id7cfcc0">特に細工無しのCreateProcess()で起動してみる</a></li>
<li><a href="#id1ab512">MSDN Blogsの内容に従い、デスクトップユーザーのTokenをコピーしてCreateProcessWithTokenW()に渡してみる</a></li></ul></li></ul>
<hr />
<h3 id="ide6f80f">参考URL</h3>

<p class="paragraph">
例によりMSDNのURLについては2010-11-12時点でのURLです。将来変更された場合は、併記しているナビゲータを参考に辿り直してください。題名が長くて特徴的なMSDN記事については、検索エンジンでたどれると思いますのでナビゲーションは併記していません。
<br />
</p>

<h4 id="id086562">UACそのものについての参考URL：</h4>

<p class="paragraph">
<a href="./view-829.html" >技術/Windows/UACとRunAsについてのメモ</a> でも紹介している、@ITの解説記事をまずお勧めします。
<br />
</p>

<p class="paragraph">
MSDN提供のドキュメントを参照する場合は、次の３本が軽めですのでまずはこちらでウォーミングアップ。
<br />
</p>
<ul><li> UAC Processes and Interactions (TechNet, Windows 7, Security and Protection, How UAC Works)<ul><li> <a class="externallink" href="http://technet.microsoft.com/en-us/library/dd835561%28WS.10%29.aspx" target="_blank">http://technet.microsoft.com/en-us/library/dd835561%28WS.10%29.aspx</a></li></ul></li>
<li> UAC Architecture (TechNet, Windows 7, Security and Protection, How UAC Works)<ul><li> <a class="externallink" href="http://technet.microsoft.com/en-us/library/dd835540%28WS.10%29.aspx" target="_blank">http://technet.microsoft.com/en-us/library/dd835540%28WS.10%29.aspx</a></li></ul></li>
<li> Windows Vista Application Development Requirements for User Account Control (UAC)<ul><li> <a class="externallink" href="http://msdn.microsoft.com/en-us/library/aa905330.aspx" target="_blank">http://msdn.microsoft.com/en-us/library/aa905330.aspx</a></li></ul></li></ul>

<p class="paragraph">
グループポリシーを使ったUACの微調整や、企業内での独自アプリ・インストーラの配布、アプリケーションの修正など、本格的にUACとお付き合いする場合は以下の２本でMicrosoftお勧めのお作法を学べます。その分、記事の分量もそれなりにあります。
<br />
</p>
<ul><li> Windows Vista Application Development Requirements for User Account Control Compatibility<ul><li> <a class="externallink" href="http://msdn.microsoft.com/en-us/library/bb530410.aspx" target="_blank">http://msdn.microsoft.com/en-us/library/bb530410.aspx</a></li></ul></li>
<li> Understanding and Configuring User Account Control in Windows Vista<ul><li> <a class="externallink" href="http://technet.microsoft.com/en-us/library/cc709628%28WS.10%29.aspx" target="_blank">http://technet.microsoft.com/en-us/library/cc709628%28WS.10%29.aspx</a></li></ul></li></ul>

<p class="paragraph">
オプション：ShellExecute(Ex)()の内部を解析して、&quot;CreateProcessElevated()&quot;なるAPIをメインとしたユーティリティライブラリを作った人が、その解説記事を書いてます。
<br />
</p>
<ul><li> Vista UAC: The Definitive Guide - CodeProject<ul><li> <a class="externallink" href="http://www.codeproject.com/KB/vista-security/UAC__The_Definitive_Guide.aspx" target="_blank">http://www.codeproject.com/KB/vista-security/UAC__The_Definitive_Guide.aspx</a></li></ul></li></ul>

<h4 id="idba33fd">前半「とりあえず権限昇格する前後のTOKENをいくつか見てみる」の参考URL：</h4>

<p class="paragraph">
&quot;MSDN&quot; &gt; &quot;MSDN Library&quot; &gt; &quot;Windows Development&quot; &gt; &quot;Security&quot; &gt; &quot;Authorization&quot; &gt; ...
<br />
</p>
<ul><li> &quot;About Authorization&quot; &gt; &quot;Access Control&quot; &gt; &quot;Access Control Model&quot; &gt; &quot;Parts of the Access Control Model&quot; &gt; &quot;Access Tokens&quot;<ul><li> <a class="externallink" href="http://msdn.microsoft.com/en-us/library/aa374909%28VS.85%29.aspx" target="_blank">http://msdn.microsoft.com/en-us/library/aa374909%28VS.85%29.aspx</a></li>
<li> ... &gt; &quot;Access Rights for Access-Token Objects&quot;<ul><li> <a class="externallink" href="http://msdn.microsoft.com/en-us/library/aa374905%28VS.85%29.aspx" target="_blank">http://msdn.microsoft.com/en-us/library/aa374905%28VS.85%29.aspx</a></li></ul></li></ul></li>
<li> &quot;Authorization Reference&quot; &gt; &quot;Authorization Functions&quot; &gt; &quot;GetTokenInformation Function&quot;<ul><li> <a class="externallink" href="http://msdn.microsoft.com/en-us/library/aa446671%28VS.85%29.aspx" target="_blank">http://msdn.microsoft.com/en-us/library/aa446671%28VS.85%29.aspx</a></li></ul></li>
<li> &quot;Using Authorization in C++&quot; &gt; &quot;Supporting Tasks for Authorization in C++&quot; &gt; &quot;Establishing a Client Context from a SID in C++&quot; &gt; &quot;Searching for a SID in an Access Token in C++&quot;<ul><li> <a class="externallink" href="http://msdn.microsoft.com/en-us/library/aa379554%28VS.85%29.aspx" target="_blank">http://msdn.microsoft.com/en-us/library/aa379554%28VS.85%29.aspx</a></li></ul></li>
<li> &quot;MSDN&quot; &gt; &quot;MSDN Library&quot; &gt; &quot;.NET Development&quot; &gt; &quot;Articles and Overviews&quot; &gt; &quot;Windows Vista&quot; &gt; &quot;Technical Articles&quot; &gt; &quot;Windows Vista Integrity Mechanism Technical Reference&quot; &gt; &quot;Windows Integrity Mechanism Design&quot;<ul><li> <a class="externallink" href="http://msdn.microsoft.com/en-us/library/bb625963.aspx" target="_blank">http://msdn.microsoft.com/en-us/library/bb625963.aspx</a></li></ul></li></ul>

<p class="paragraph">
Web/DB プログラミング徹底解説シリーズ：
<br />
</p>
<ul><li> UAC (ユーザーアクセスコントロール) と管理権限の昇格 (elevating)<ul><li> <a class="externallink" href="http://keicode.com/windows/uac-elevating-to-admin.php" target="_blank">http://keicode.com/windows/uac-elevating-to-admin.php</a></li></ul></li>
<li> 管理者権限での実行を要求する方法<ul><li> <a class="externallink" href="http://keicode.com/windows/programming-uac-elevating-to-admin.php" target="_blank">http://keicode.com/windows/programming-uac-elevating-to-admin.php</a></li></ul></li>
<li> Vista 以降におけるトークンの変更 ～ リンクト・トークン (フィルタード・トークン)<ul><li> <a class="externallink" href="http://keicode.com/windows/linked-token.php" target="_blank">http://keicode.com/windows/linked-token.php</a></li></ul></li></ul>

<h4 id="id6c6ae0">後半「権限昇格したプロセスから、未昇格状態のプロセスを起動する」の参考URL：</h4>

<p class="paragraph">
&quot;Create process nonelevated from elevated process&quot; でggったら一発でした。
<br />
</p>

<ul><li> EternalWindows : セキュリティコンテキスト / UAC<ul><li> <a class="externallink" href="http://eternalwindows.jp/security/securitycontext/securitycontext10.html" target="_blank">http://eternalwindows.jp/security/securitycontext/securitycontext10.html</a></li></ul></li>
<li> Create non-elevated process from elevated process,...? in VC MFC<ul><li> <a class="externallink" href="http://www.eggheadcafe.com/software/aspnet/35797180/create-nonelevated-process-from-elevated-process.aspx" target="_blank">http://www.eggheadcafe.com/software/aspnet/35797180/create-nonelevated-process-from-elevated-process.aspx</a></li></ul></li>
<li> FAQ: How do I start a program as the desktop user from an elevated app? - Aaron Margosis&#039; &quot;Non-Admin&quot; and App-Compat WebLog - Site Home - MSDN Blogs<ul><li> <a class="externallink" href="http://blogs.msdn.com/b/aaron_margosis/archive/2009/06/06/faq-how-do-i-start-a-program-as-the-desktop-user-from-an-elevated-app.aspx" target="_blank">http://blogs.msdn.com/b/aaron_margosis/archive/2009/06/06/faq-how-do-i-start-a-program-as-the-desktop-user-from-an-elevated-app.aspx</a></li></ul></li></ul>

<hr />
<h3 id="id5e44c7">とりあえず権限昇格する前後のTOKENをいくつか見てみる</h3>

<p class="paragraph">
OpenProcessToken()で現在プロセスのTokenハンドルを取得し、GetTokenInformation()で権限昇格(Elevation)の前後で内容が変わりそうな情報を取得、表示させてみます。
<br />
</p>

<h4 id="idd5b4d2">TokenElevation</h4>

<p class="paragraph">
TOKEN_ELEVATION構造体のTokenIsElevatedに権限昇格時は1, 未昇格時は0がセットされるようです。
<br />
</p>

<ul><li> <a href="./../medias/exercise_uac/t_get_token_informations/TokenElevation.c" target="_blank" >./../medias/exercise_uac/t_get_token_informations/TokenElevation.c</a></li></ul>

<p class="paragraph">
通常のコマンドプロンプト：
<br />
</p>
<pre>&gt; TokenElevation
TOKEN_ELEVATION = 0
</pre>

<p class="paragraph">
「管理者として実行」コマンドプロンプト：
<br />
</p>
<pre>&gt; TokenElevation
TOKEN_ELEVATION = 1
</pre>

<p class="paragraph">
UACを無効にしてAdministratorsグループに所属するユーザーでログインしたコマンドプロンプト：
<br />
</p>
<pre>&gt; TokenElevation
TOKEN_ELEVATION = 1
</pre>

<h4 id="id710ad9">TokenElevationType</h4>

<p class="paragraph">
現在の権限昇格種別が取得できるみたいです。
<br />
</p>

<ul><li> <a href="./../medias/exercise_uac/t_get_token_informations/TokenElevationType.c" target="_blank" >./../medias/exercise_uac/t_get_token_informations/TokenElevationType.c</a></li></ul>

<p class="paragraph">
通常のコマンドプロンプト：
<br />
</p>
<pre>&gt; TokenElevationType
TOKEN_ELEVATION_TYPE = 3, TokenElevationTypeLimited
</pre>

<p class="paragraph">
「管理者として実行」コマンドプロンプト：
<br />
</p>
<pre>&gt; TokenElevationType
TOKEN_ELEVATION_TYPE = 2, TokenElevationTypeFull
</pre>

<p class="paragraph">
UACを無効にしてAdministratorsグループに所属するユーザーでログインしたコマンドプロンプト：
<br />
</p>
<pre>&gt; TokenElevationType
TOKEN_ELEVATION_TYPE = 1, TokenElevationTypeDefault
</pre>

<h4 id="id589d78">TokenPrivileges</h4>

<p class="paragraph">
与えられたPrivilegeの一覧を表示してみます。権限昇格前後での違いが一番良くわかる情報です。
<br />
</p>

<ul><li> <a href="./../medias/exercise_uac/t_get_token_informations/TokenPrivileges.c" target="_blank" >./../medias/exercise_uac/t_get_token_informations/TokenPrivileges.c</a></li></ul>

<p class="paragraph">
通常のコマンドプロンプト：
<br />
</p>
<pre class="plugin_pre">
&gt; TokenPrivileges.exe
Privileges[0]:
        PrivilegeName = [SeShutdownPrivilege]
        PrivilegeAttributes:
Privileges[1]:
        PrivilegeName = [SeChangeNotifyPrivilege]
        PrivilegeAttributes:
                SE_PRIVILEGE_ENABLED
                SE_PRIVILEGE_ENABLED_BY_DEFAULT
                SE_PRIVILEGE_REMOVED
                SE_PRIVILEGE_USED_FOR_ACCESS
Privileges[2]:
        PrivilegeName = [SeUndockPrivilege]
        PrivilegeAttributes:
Privileges[3]:
        PrivilegeName = [SeIncreaseWorkingSetPrivilege]
        PrivilegeAttributes:
Privileges[4]:
        PrivilegeName = [SeTimeZonePrivilege]
        PrivilegeAttributes:
</pre>

<p class="paragraph">
「管理者として実行」コマンドプロンプト：
<br />
</p>
<pre class="plugin_pre">
&gt; TokenPrivileges.exe
Privileges[0]:
        PrivilegeName = [SeIncreaseQuotaPrivilege]
        PrivilegeAttributes:
Privileges[1]:
        PrivilegeName = [SeSecurityPrivilege]
        PrivilegeAttributes:
Privileges[2]:
        PrivilegeName = [SeTakeOwnershipPrivilege]
        PrivilegeAttributes:
Privileges[3]:
        PrivilegeName = [SeLoadDriverPrivilege]
        PrivilegeAttributes:
Privileges[4]:
        PrivilegeName = [SeSystemProfilePrivilege]
        PrivilegeAttributes:
Privileges[5]:
        PrivilegeName = [SeSystemtimePrivilege]
        PrivilegeAttributes:
Privileges[6]:
        PrivilegeName = [SeProfileSingleProcessPrivilege]
        PrivilegeAttributes:
Privileges[7]:
        PrivilegeName = [SeIncreaseBasePriorityPrivilege]
        PrivilegeAttributes:
Privileges[8]:
        PrivilegeName = [SeCreatePagefilePrivilege]
        PrivilegeAttributes:
Privileges[9]:
        PrivilegeName = [SeBackupPrivilege]
        PrivilegeAttributes:
Privileges[10]:
        PrivilegeName = [SeRestorePrivilege]
        PrivilegeAttributes:
Privileges[11]:
        PrivilegeName = [SeShutdownPrivilege]
        PrivilegeAttributes:
Privileges[12]:
        PrivilegeName = [SeDebugPrivilege]
        PrivilegeAttributes:
Privileges[13]:
        PrivilegeName = [SeSystemEnvironmentPrivilege]
        PrivilegeAttributes:
Privileges[14]:
        PrivilegeName = [SeChangeNotifyPrivilege]
        PrivilegeAttributes:
                SE_PRIVILEGE_ENABLED
                SE_PRIVILEGE_ENABLED_BY_DEFAULT
                SE_PRIVILEGE_REMOVED
                SE_PRIVILEGE_USED_FOR_ACCESS
Privileges[15]:
        PrivilegeName = [SeRemoteShutdownPrivilege]
        PrivilegeAttributes:
Privileges[16]:
        PrivilegeName = [SeUndockPrivilege]
        PrivilegeAttributes:
Privileges[17]:
        PrivilegeName = [SeManageVolumePrivilege]
        PrivilegeAttributes:
Privileges[18]:
        PrivilegeName = [SeImpersonatePrivilege]
        PrivilegeAttributes:
                SE_PRIVILEGE_ENABLED
                SE_PRIVILEGE_ENABLED_BY_DEFAULT
                SE_PRIVILEGE_REMOVED
                SE_PRIVILEGE_USED_FOR_ACCESS
Privileges[19]:
        PrivilegeName = [SeCreateGlobalPrivilege]
        PrivilegeAttributes:
                SE_PRIVILEGE_ENABLED
                SE_PRIVILEGE_ENABLED_BY_DEFAULT
                SE_PRIVILEGE_REMOVED
                SE_PRIVILEGE_USED_FOR_ACCESS
Privileges[20]:
        PrivilegeName = [SeIncreaseWorkingSetPrivilege]
        PrivilegeAttributes:
Privileges[21]:
        PrivilegeName = [SeTimeZonePrivilege]
        PrivilegeAttributes:
Privileges[22]:
        PrivilegeName = [SeCreateSymbolicLinkPrivilege]
        PrivilegeAttributes:
</pre>

<h4 id="id8e1bcc">TokenMandatoryPolicy</h4>

<p class="paragraph">
&quot;Integrity Level&quot;とかいうのに関連してるようですが、まだ理解し切れていません。
<br />
</p>

<ul><li> <a href="./../medias/exercise_uac/t_get_token_informations/TokenMandatoryPolicy.c" target="_blank" >./../medias/exercise_uac/t_get_token_informations/TokenMandatoryPolicy.c</a></li></ul>

<p class="paragraph">
通常のコマンドプロンプト：
<br />
</p>
<pre>&gt; TokenMandatoryPolicy.exe
TOKEN_MANDATORY_POLICY = 3, TOKEN_MANDATORY_POLICY_VALID_MASK
</pre>

<p class="paragraph">
「管理者として実行」コマンドプロンプト：
<br />
</p>
<pre>&gt; TokenMandatoryPolicy.exe
TOKEN_MANDATORY_POLICY = 1, TOKEN_MANDATORY_POLICY_NO_WRITE_UP
</pre>

<h4 id="idd96bf0">TokenIntegrityLevel</h4>

<p class="paragraph">
TokenMandatoryPolicyと併せて &quot;Integrity Level&quot; をあらわすSIDを取得できるようですが、まだ理解し切れていません。また、リソースの解放で間違いがあるのか、異常終了してしまいます。情けない話ですが、追いきれませんでした。
<br />
</p>

<ul><li> <a href="./../medias/exercise_uac/t_get_token_informations/TokenMandatoryLabel.c" target="_blank" >./../medias/exercise_uac/t_get_token_informations/TokenMandatoryLabel.c</a></li></ul>

<p class="paragraph">
通常のコマンドプロンプト：
<br />
</p>
<pre>&gt; TokenMandatoryLabel.exe
MandatoryLabel : SID = S-1-16-8192
        Attribute = 00000060
</pre>

<p class="paragraph">
「管理者として実行」コマンドプロンプト：
<br />
</p>
<pre>&gt; TokenMandatoryLabel.exe
MandatoryLabel : SID = S-1-16-12288
        Attribute = 00000060
</pre>

<p class="paragraph">
表示されているSID自体は、MSDNの&quot;Windows Integrity Mechanism Design&quot;に記載されている内容と一致しています。
<br />
「管理者として実行」側の &quot;S-1-16-12288&quot; は &quot;Mandatory Label\High Mandatory Level&quot;、
<br />
通常側の &quot;S-1-16-8192&quot; は &quot;Mandatory Label\Medium Mandatory Level&quot; になりますので、他のUACドキュメントの説明どおりです。
<br />
</p>

<h4 id="id2baf9a">TokenLinkedToken</h4>

<p class="paragraph">
Administratorsグループのユーザがログオンするとき、管理者としてのフルアクセス用トークンと通常ユーザとしての制限されたトークンが発行されます。この二つのトークンで、現在プロセスのトークンと対になるトークンがTokenLinkedTokenで取得できます。
<br />
</p>

<ul><li> <a href="./../medias/exercise_uac/t_get_token_informations/TokenLinkedToken.c" target="_blank" >./../medias/exercise_uac/t_get_token_informations/TokenLinkedToken.c</a></li></ul>

<p class="paragraph">
通常のコマンドプロンプト：現在プロセスのTokenは制限されたトークンですので、LinkedTokenには対となる、フルアクセス用トークンが割り当てられています。
<br />
</p>
<pre class="plugin_pre">
&gt; TokenLinkedToken.exe
--------------- CURRENT TOKEN --------------------
Privileges[0]:
        PrivilegeName = [SeShutdownPrivilege]
        PrivilegeAttributes:
（省略）
Privileges[4]:
        PrivilegeName = [SeTimeZonePrivilege]
        PrivilegeAttributes:
--------------- LINKED TOKEN --------------------
Privileges[0]:
        PrivilegeName = [SeIncreaseQuotaPrivilege]
        PrivilegeAttributes:
（省略）
Privileges[22]:
        PrivilegeName = [SeCreateSymbolicLinkPrivilege]
        PrivilegeAttributes:
</pre>

<p class="paragraph">
「管理者として実行」コマンドプロンプト：現在プロセスのTokenはフルアクセス用トークンですので、LinkedTokenには対となる、制限されたトークンが割り当てられています。
<br />
</p>
<pre class="plugin_pre">
&gt; TokenLinkedToken.exe
--------------- CURRENT TOKEN --------------------
Privileges[0]:
        PrivilegeName = [SeIncreaseQuotaPrivilege]
        PrivilegeAttributes:
（省略）
Privileges[22]:
        PrivilegeName = [SeCreateSymbolicLinkPrivilege]
        PrivilegeAttributes:
--------------- LINKED TOKEN --------------------
Privileges[0]:
        PrivilegeName = [SeShutdownPrivilege]
        PrivilegeAttributes:
（省略）
Privileges[4]:
        PrivilegeName = [SeTimeZonePrivilege]
        PrivilegeAttributes:
</pre>

<p class="paragraph">
UACを無効にしてAdministratorsグループに所属するユーザーでログインしたコマンドプロンプト：
<br />
UACを無効にすると、制限トークンが発行されなくなります。したがってLinkedTokenは存在せず、管理者グループのユーザでログオンした場合はフルアクセス用トークンのみが発行されます。
<br />
</p>
<pre class="plugin_pre">
&gt; TokenLinkedToken.exe
--------------- CURRENT TOKEN --------------------
Privileges[0]:
        PrivilegeName = [SeIncreaseQuotaPrivilege]
        PrivilegeAttributes:
（省略）
Privileges[22]:
        PrivilegeName = [SeCreateSymbolicLinkPrivilege]
        PrivilegeAttributes:
GetTokenInformation() : 1312
</pre>
<p class="paragraph">
最後のGetLastError() = 1312はLinkedTokenのGetTokenInformation()で発生しています。日本語メッセージは以下になります。
<br />
</p>
<pre>指定されたログオン セッションは存在しません。\
そのセッションは既に終了している可能性があります。
</pre>


<h3 id="id6c4e2f">権限昇格したプロセスから、未昇格状態のプロセスを起動する</h3>

<p class="paragraph">
未昇格→未昇格プロセスのCreateProcess() : OK
<br />
未昇格→昇格プロセスのCreateProcess() : ERROR_ELEVATION_REQUIRED、ShellExecute(Ex)()を使う。
<br />
昇格→昇格プロセスのCreateProcess() : OK
<br />
</p>

<p class="paragraph">
では、
<br />
昇格→未昇格プロセスのCreateProcess()
<br />
するにはどうすれば良いでしょうか？
<br />
</p>

<h4 id="id02c826">まずは実験用のCreateProcess()される側のプログラムを用意する。</h4>

<ul><li> <a href="./../medias/exercise_uac/t_uac_with_manifest/check_elevation.c" target="_blank" >./../medias/exercise_uac/t_uac_with_manifest/check_elevation.c</a></li>
<li> 親プロセスと同じトークンで起動するためのmanifest<ul><li> <a href="./../medias/exercise_uac/t_uac_with_manifest/check_elevation.exe_asInvoker.manifest" target="_blank" >./../medias/exercise_uac/t_uac_with_manifest/check_elevation.exe_asInvoker.manifest</a></li></ul></li>
<li> 権限昇格を強制するためのmanifest<ul><li> <a href="./../medias/exercise_uac/t_uac_with_manifest/check_elevation.exe_requireAdministrator.manifest" target="_blank" >./../medias/exercise_uac/t_uac_with_manifest/check_elevation.exe_requireAdministrator.manifest</a></li></ul></li></ul>

<h4 id="idb151fa">セオリー通りにShellExecuteEx()で起動してみる</h4>

<ul><li> <a href="./../medias/exercise_uac/t_uac_with_manifest/t_shell_execute_ex.c" target="_blank" >./../medias/exercise_uac/t_uac_with_manifest/t_shell_execute_ex.c</a></li></ul>

<ul><li> 通常コマンドプロンプト<ul><li> asInvoker(manifest) → TOKEN_ELEVATION = 0</li>
<li> requireAdministrator(manifest) → UACプロンプト + TOKEN_ELEVATION = 1</li></ul></li>
<li> 「管理者として実行」コマンドプロンプト<ul><li> asInvoker(manifest) → TOKEN_ELEVATION = 1</li>
<li> requireAdministrator(manifest) → TOKEN_ELEVATION = 1</li></ul></li></ul>

<h4 id="id7cfcc0">特に細工無しのCreateProcess()で起動してみる</h4>

<ul><li> <a href="./../medias/exercise_uac/t_uac_with_manifest/t_create_process.c" target="_blank" >./../medias/exercise_uac/t_uac_with_manifest/t_create_process.c</a></li></ul>

<ul><li> 通常コマンドプロンプト<ul><li> asInvoker(manifest) → TOKEN_ELEVATION = 0</li>
<li> requireAdministrator(manifest) → ERROR_ELEVATION_REQUIRED(GetLastError() = 740)</li></ul></li>
<li> 「管理者として実行」コマンドプロンプト<ul><li> asInvoker(manifest) → TOKEN_ELEVATION = 1</li>
<li> requireAdministrator(manifest) → TOKEN_ELEVATION = 1</li></ul></li></ul>

<h4 id="id1ab512">MSDN Blogsの内容に従い、デスクトップユーザーのTokenをコピーしてCreateProcessWithTokenW()に渡してみる</h4>

<ul><li> <a href="./../medias/exercise_uac/t_uac_with_manifest/t_create_process_as_desktop_user.c" target="_blank" >./../medias/exercise_uac/t_uac_with_manifest/t_create_process_as_desktop_user.c</a></li></ul>

<ul><li> 通常コマンドプロンプト：(権限昇格済みのプロセスからのCreateProcess()実験に付き対象外)</li>
<li> 「管理者として実行」コマンドプロンプト<ul><li> asInvoker(manifest) →<strong>TOKEN_ELEVATION = 0</strong></li>
<li> requireAdministrator(manifest) →<strong>ERROR_ELEVATION_REQUIRED(GetLastError() = 740)(CreateProcessWithTokenW())</strong></li></ul></li></ul>

<hr />
<p class="paragraph">
以上、実験コードの足しになれば幸いです。
<br />
</p>

<p class="paragraph">
それにしてもWindowsのアクセス制御は複雑ですね。企業内で何百台ものクライアントPCを適切に管理したり、GUIのDesktopシステムとの組み合わせが発生する以上は仕方ないのかもしれません。
<br />
</p>

<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-829.html" title="技術/Windows/UACとRunAsについてのメモ">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-930.html" title="技術/Windows/UI Automation">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-703.html" title="技術/Windows">Up</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-23.html" title="技術">技術</a>&nbsp;]</li>
</ul>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/832<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2007 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>