<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>技術/Linux/RPMコマンドメモ(パッケージ作成など) - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">技術/Linux/RPMコマンドメモ(パッケージ作成など)</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2009-11-20 22:47:25 &nbsp; / &nbsp; last updated at: 2013-12-15 21:12:32<br>
カテゴリ: <a href="category-20.html">Linux</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-1244.html" title="技術/Linux/RPMコマンドメモ(yum)">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-103.html" title="技術/Linux/RPMコマンドメモ(入門レベル)">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-23.html" title="技術">技術</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
RPMパッケージを作成する時の注意点とか、RPMで&quot;/&quot;(root)ディレクトリを変更してRPMの使うDBの構築やパッケージのインストールを行う場合の自分用メモ。
<br />
なお動作検証は CentOS 5.2, RPM 4.4.2 で行っている。
<br />
</p>



<ul><li><a href="#idb1ee5e">RPMパッケージ作成の注意点（ユーザ環境の準備作業周辺）</a></li>
<li><a href="#id986b25">RPMで&quot;/&quot;(root)ディレクトリを変更したりする場合のメモ</a><ul><li><a href="#idcc39f9">一般ユーザー権限だけで準備しようとするとchroot(2)絡みでエラーになり進めなくなる件</a></li></ul></li></ul>

<p class="paragraph">
参考資料：
<br />
</p>
<ul><li> RPM Guide (Fedora Project) (rpm.orgのTracから&quot;Packager Documentation&quot;のリンク先がここになっている)<ul><li> <a class="externallink" href="http://docs.fedoraproject.org/drafts/rpm-guide-en/" target="_blank">http://docs.fedoraproject.org/drafts/rpm-guide-en/</a></li></ul></li>
<li> CentOS 5.2, RPM 4.4.2 のmanページ</li></ul>

<hr />
<h3 id="idb1ee5e">RPMパッケージ作成の注意点（ユーザ環境の準備作業周辺）</h3>

<p class="paragraph">
CentOS 5.2 の場合、&quot;/usr/src/redhat&quot; 以下にRPMパッケージの作成やSRPMからのビルドに必要なディレクトリツリーが準備されている。
<br />
RPMパッケージを作成する場合は、誤ってシステム本体のファイルシステムやRPMデータベースに書き込んでしまわないよう、ユーザ環境でディレクトリツリーを準備する事が推奨されている。
<br />
そのための準備作業としては大まかに、以下のようになる。
<br />
</p>
<ol><li> ユーザ環境でディレクトリツリーを準備</li>
<li> &quot;$HOME/.rpmmacros&quot; に &quot;%_topdir&quot; マクロを登録し、ユーザ環境で用意したディレクトリを設定する。</li></ol>

<p class="paragraph">
実際にやってみる。まずディレクトリツリーの準備だが、幸いシステムのディレクトリツリーが空の状態だったので cpio を使ってごっそりコピーする。
<br />
</p>
<pre>$ pwd
/usr/src/redhat
$ find . -depth -print | cpio -pvd ~/in_vitro/rpmbuild/
/home/msakamoto/in_vitro/rpmbuild//./BUILD
/home/msakamoto/in_vitro/rpmbuild//./SOURCES
/home/msakamoto/in_vitro/rpmbuild//./RPMS/athlon
/home/msakamoto/in_vitro/rpmbuild//./RPMS/i586
/home/msakamoto/in_vitro/rpmbuild//./RPMS/i686
/home/msakamoto/in_vitro/rpmbuild//./RPMS/noarch
/home/msakamoto/in_vitro/rpmbuild//./RPMS/i486
/home/msakamoto/in_vitro/rpmbuild//./RPMS/i386
/home/msakamoto/in_vitro/rpmbuild//./RPMS
/home/msakamoto/in_vitro/rpmbuild//./SPECS
/home/msakamoto/in_vitro/rpmbuild//./SRPMS
0 blocks
</pre>

<p class="paragraph">
続いて &quot;$HOME/.rpmmacros&quot;を次のように準備する。&quot;%home&quot;マクロについては、&quot;/etc/rpm/macros&quot; に入れておいても良いだろう。
<br />
</p>
<pre>$ cat .rpmmacros
%home %{expand:%%(cd; pwd)}
%_topdir %{home}/in_vitro/rpmbuild
</pre>

<p class="paragraph">
確認してみる。
<br />
</p>
<pre>$ rpm --eval &quot;%{home}&quot;
/home/msakamoto
$ rpm --eval &quot;%{_topdir}&quot;
/home/msakamoto/in_vitro/rpmbuild
$ rpm --showrc | grep _topdir
-14: _builddir  %{_topdir}/BUILD
-14: _rpmdir    %{_topdir}/RPMS
-14: _sourcedir %{_topdir}/SOURCES
-14: _specdir   %{_topdir}/SPECS
-14: _srcrpmdir %{_topdir}/SRPMS
-14: _topdir    %{home}/in_vitro/rpmbuild
</pre>

<p class="paragraph">
後は実際に &quot;$HOME/in_vitro/rpmbuiild&quot; ディレクトリの中でSPECファイルやソースファイル群を準備し、rpmbuildを実行すればよい。
<br />
</p>

<p class="paragraph">
なお今回検証したのはあくまでもspecファイルの作成からであり、SRPMのインストールからの作業は検証していない。SRPMのインストールでrpmコマンドを使って上記ユーザー環境にspecファイルやソースファイルを展開するのは不可能に思える。なぜなら、RPMコマンドの&quot;--root&quot;によりchrootして作業するのはroot権限で、一般ユーザではchroot(2)システムコールがエラーになってしまうからだ。
<br />
SRPMが手元にあり、そこからユーザー環境のディレクトリツリーでrpmbuildコマンドを実行したい場合は、一旦rpm2cpioでSPECファイルやソースファイル群を取り出した後手動で配置するべきかも知れない。
<br />
</p>

<p class="paragraph">
例：
<br />
</p>
<pre>$ ls
sample-1.0-1.src.rpm
$ rpm2cpio sample-1.0-1.src.rpm | cpio -t
sample-1.0.tar.gz
sample.spec
531 blocks
$ rpm2cpio sample-1.0-1.src.rpm | cpio -iv
sample-1.0.tar.gz
sample.spec
531 blocks
$ ls
sample-1.0-1.src.rpm  sample-1.0.tar.gz  sample.spec
</pre>

<p class="paragraph">
ちなみに自分は、当初勘違いして &quot;$HOME/.rpmrc&quot; に&quot;%_topdir&quot;設定を書いていて何度やってもエラーになってしまった。よくよくドキュメントを読み、&quot;%&quot;で始まるマクロ設定なので &quot;$HOME/.rpmmacros&quot; であることに気づくまで結構嵌ってしまった。
<br />
</p>

<h3 id="id986b25">RPMで&quot;/&quot;(root)ディレクトリを変更したりする場合のメモ</h3>

<p class="paragraph">
実験環境の構築などで、システムファイルやRPMデータベースの破壊を回避する為、一種のchroot環境を構築する場合を想定する。
<br />
rpmコマンドの &quot;--root&quot; オプションを使う事になるが、内部的に chroot(2) システムコールを使う為、root権限が必要になるので注意する。
<br />
</p>

<p class="paragraph">
基本的な流れとしては以下のようになる。なおファイル・ディレクトリパーミッション周りのトラブルを避ける為、基本的にroot権限で行う事を推奨する<span class="hidden">(</span><a class="footnote" href="#footnote_493_1" id="footnote_493_1_r"  title="そうなると「一般ユーザーで操作可能なRPM環境を準備する」というそもそもの結構ウェイトの大きい目的から外れてしまうが、chroot(2)周りで結局root権限のファイルが出来てしまうので仕方なかった。">*1</a><span class="hidden">)</span>。
<br />
</p>
<ol><li> 好みの場所に &quot;--root&quot; オプションで指定するための chroot 用ディレクトリを作成する。</li>
<li> chrootした中でさらにRPMの使うBerkeleyDB用のディレクトリを作成する。&quot;--dbpath&quot; で指定する事になる。</li>
<li> &quot;--root&quot; と &quot;--dbpath&quot; を指定して &quot;--initdb&quot; によりDBを初期化する。</li></ol>

<p class="paragraph">
以降、パッケージのインストール・アップデート・削除などは &quot;--root&quot;, &quot;--dbpath&quot; を指定する。
<br />
なお、&quot;/var/lib/rpm&quot;など元々のrpmコマンドが想定しているディレクトリをRPMのDB用に指定した場合は、&quot;--dbpath&quot;は不要。
<br />
</p>

<p class="paragraph">
以下、実際に試してみた例：&quot;--root&quot;が&quot;/opt/rpmroot&quot;で、&quot;--dbpath&quot;が&quot;/var/lib/rpmtest&quot;としてみた。
<br />
</p>
<pre class="plugin_pre">
$ su -
# mkdir -p /opt/rpmroot
# mkdir -p /opt/rpmroot/var/lib/rpmtest
# rpm --initdb -vv --root /opt/rpmroot --dbpath /var/lib/rpmtest
D: opening  db environment /opt/rpmroot/var/lib/rpmtest/Packages create:cdb:mpool
D: opening  db index       /opt/rpmroot/var/lib/rpmtest/Packages create mode=0x42
D: locked   db index       /opt/rpmroot/var/lib/rpmtest/Packages
D: closed   db index       /opt/rpmroot/var/lib/rpmtest/Packages
D: closed   db environment /opt/rpmroot/var/lib/rpmtest/Packages
D: May free Score board((nil))
# find /opt/rpmroot/var/lib
/opt/rpmroot/var/lib
/opt/rpmroot/var/lib/rpmtest
/opt/rpmroot/var/lib/rpmtest/__db.001
/opt/rpmroot/var/lib/rpmtest/Packages
/opt/rpmroot/var/lib/rpmtest/__db.000
/opt/rpmroot/var/lib/rpmtest/__db.003
/opt/rpmroot/var/lib/rpmtest/__db.002
</pre>
<p class="paragraph">
これでDBの初期化まで完了した。続いて、適当にでっち上げたRPMをインストールしてみる。
<br />
</p>
<pre class="plugin_pre">
# rpm -ivh -vv --nodeps --dbpath /var/lib/rpmtest --root /opt/rpmroot --test sample-1.0-1.i386.rpm
D: ============== sample-1.0-1.i386.rpm
D: Expected size:        11976 = lead(96)+sigs(180)+pad(4)+data(11696)
D:   Actual size:        11976
D: sample-1.0-1.i386.rpm: Header SHA1 digest: OK (6c105c09750403c748aaaa321e442518e98663a6)
D:      added binary package [0]
D: found 0 source and 1 binary packages
D: ========== recording tsort relations
D: ========== tsorting packages (order, #predecessors, #succesors, tree, depth, breadth)
D:     0    0    0    0    1    0   +sample-1.0-1.i386
D: installing binary packages
D: opening  db environment /opt/rpmroot/var/lib/rpmtest/Packages joinenv
D: opening  db index       /opt/rpmroot/var/lib/rpmtest/Packages rdonly mode=0x0
D: locked   db index       /opt/rpmroot/var/lib/rpmtest/Packages
D: mounted filesystems:
D:     i        dev    bsize       bavail       iavail mount point
D:     0 0x0000fd00     4096      1212587      2269294 /
D:     1 0x00000003     4096            0           -1 /proc
D:     2 0x00000000     4096            0           -1 /sys
D:     3 0x0000000b     4096            0           -1 /dev/pts
D:     4 0x00000801     1024        72066        26060 /boot
D:     5 0x00000012     4096        64436        64435 /dev/shm
D:     6 0x00000013     4096            0           -1 /proc/sys/fs/binfmt_misc
D:     7 0x00000014     4096            0           -1 /var/lib/nfs/rpc_pipefs
D: sanity checking 1 elements
D: opening  db index       /opt/rpmroot/var/lib/rpmtest/Name create mode=0x0
D: running pre-transaction scripts
D: computing 5 file fingerprints
Preparing...                D: computing file dispositions
D: opening  db index       /var/lib/rpmtest/Basenames create mode=0x0
########################################### [100%]
D: ========== +++ sample-1.0-1 i386-linux 0x1
D: Expected size:        11976 = lead(96)+sigs(180)+pad(4)+data(11696)
D:   Actual size:        11976
D: sample-1.0-1: Header SHA1 digest: OK (6c105c09750403c748aaaa321e442518e98663a6)
D:   install: sample-1.0-1 has 5 files, test = 1
D: running post-transaction scripts
D: closed   db index       /opt/rpmroot/var/lib/rpmtest/Basenames
D: closed   db index       /opt/rpmroot/var/lib/rpmtest/Name
D: closed   db index       /opt/rpmroot/var/lib/rpmtest/Packages
D: closed   db environment /opt/rpmroot/var/lib/rpmtest/Packages
D: May free Score board((nil))
</pre>

<p class="paragraph">
まだ&quot;--test&quot;付なので実際のインストールは行っていない。しかしこの段階でRPMデータベースディレクトリを覗いてみると、幾つかのインデックスファイルが作成されている事が分かる。
<br />
</p>
<pre># find /opt/rpmroot/var/lib
/opt/rpmroot/var/lib
/opt/rpmroot/var/lib/rpmtest
/opt/rpmroot/var/lib/rpmtest/__db.001
/opt/rpmroot/var/lib/rpmtest/Packages
/opt/rpmroot/var/lib/rpmtest/__db.000
/opt/rpmroot/var/lib/rpmtest/__db.003
/opt/rpmroot/var/lib/rpmtest/Basenames
/opt/rpmroot/var/lib/rpmtest/__db.002
/opt/rpmroot/var/lib/rpmtest/Name
</pre>

<p class="paragraph">
実際にインストールしてみる。
<br />
</p>
<pre class="plugin_pre">
# rpm -ivh -vv --nodeps --dbpath /var/lib/rpmtest --root /opt/rpmroot sample-1.0-1.i386.rpm
D: ============== sample-1.0-1.i386.rpm
D: Expected size:        11976 = lead(96)+sigs(180)+pad(4)+data(11696)
D:   Actual size:        11976
D: sample-1.0-1.i386.rpm: Header SHA1 digest: OK (6c105c09750403c748aaaa321e442518e98663a6)
D:      added binary package [0]
D: found 0 source and 1 binary packages
D: ========== recording tsort relations
D: ========== tsorting packages (order, #predecessors, #succesors, tree, depth, breadth)
D:     0    0    0    0    1    0   +sample-1.0-1.i386
D: installing binary packages
D: opening  db environment /opt/rpmroot/var/lib/rpmtest/Packages joinenv
D: opening  db index       /opt/rpmroot/var/lib/rpmtest/Packages create mode=0x42
D: locked   db index       /opt/rpmroot/var/lib/rpmtest/Packages
D: mounted filesystems:
D:     i        dev    bsize       bavail       iavail mount point
D:     0 0x0000fd00     4096      1212494      2269292 /
D:     1 0x00000003     4096            0           -1 /proc
D:     2 0x00000000     4096            0           -1 /sys
D:     3 0x0000000b     4096            0           -1 /dev/pts
D:     4 0x00000801     1024        72066        26060 /boot
D:     5 0x00000012     4096        64436        64435 /dev/shm
D:     6 0x00000013     4096            0           -1 /proc/sys/fs/binfmt_misc
D:     7 0x00000014     4096            0           -1 /var/lib/nfs/rpc_pipefs
D: sanity checking 1 elements
D: opening  db index       /opt/rpmroot/var/lib/rpmtest/Name create mode=0x42
D: running pre-transaction scripts
D: computing 5 file fingerprints
Preparing...                D: computing file dispositions
D: opening  db index       /var/lib/rpmtest/Basenames create mode=0x42
########################################### [100%]
D: ========== +++ sample-1.0-1 i386-linux 0x1
D: Expected size:        11976 = lead(96)+sigs(180)+pad(4)+data(11696)
D:   Actual size:        11976
D: sample-1.0-1: Header SHA1 digest: OK (6c105c09750403c748aaaa321e442518e98663a6)
D:   install: sample-1.0-1 has 5 files, test = 0
   1:sample                 D: ========== Directories not explicitly included in package:
D:          0 /usr/bin/
D:          1 /usr/share/doc/
D:          3 /usr/share/locale/ja/LC_MESSAGES/
D: ==========
D: /usr directory created with perms 0755, no context.
D: /usr/bin directory created with perms 0755, no context.
D: /usr/share directory created with perms 0755, no context.
D: /usr/share/doc directory created with perms 0755, no context.
D: /usr/share/locale directory created with perms 0755, no context.
D: /usr/share/locale/ja directory created with perms 0755, no context.
D: /usr/share/locale/ja/LC_MESSAGES directory created with perms 0755, no context.
D: fini      100755  1 (   0,   0)      3276 /usr/bin/sample;4b050e8d
D: fini      040755  2 (   0,   0)         0 /usr/share/doc/sample-1.0
D: fini      100644  1 (   0,   0)     18002 /usr/share/doc/sample-1.0/COPYING;4b050e8d
D: fini      100644  1 (   0,   0)         0 /usr/share/doc/sample-1.0/README;4b050e8d
########################################### [100%]
D: fini      100644  1 (   0,   0)       618 /usr/share/locale/ja/LC_MESSAGES/sample.mo;4b050e8d
GZDIO:       3 reads,    22740 total bytes in 0.002939 secs
D:   +++ h#       1 Header SHA1 digest: OK (6c105c09750403c748aaaa321e442518e98663a6)
D: adding &quot;sample&quot; to Name index.
D: adding 5 entries to Basenames index.
D: opening  db index       /var/lib/rpmtest/Group create mode=0x42
D: adding &quot;Applications/Text&quot; to Group index.
D: opening  db index       /var/lib/rpmtest/Requirename create mode=0x42
D: adding 5 entries to Requirename index.
D: opening  db index       /var/lib/rpmtest/Providename create mode=0x42
D: adding &quot;sample&quot; to Providename index.
D: opening  db index       /var/lib/rpmtest/Dirnames create mode=0x42
D: adding 4 entries to Dirnames index.
D: opening  db index       /var/lib/rpmtest/Requireversion create mode=0x42
D: adding 5 entries to Requireversion index.
D: opening  db index       /var/lib/rpmtest/Provideversion create mode=0x42
D: adding &quot;1.0-1&quot; to Provideversion index.
D: opening  db index       /var/lib/rpmtest/Installtid create mode=0x42
D: adding 1 entries to Installtid index.
D: opening  db index       /var/lib/rpmtest/Sigmd5 create mode=0x42
D: adding 1 entries to Sigmd5 index.
D: opening  db index       /var/lib/rpmtest/Sha1header create mode=0x42
D: adding &quot;6c105c09750403c748aaaa321e442518e98663a6&quot; to Sha1header index.
D: opening  db index       /var/lib/rpmtest/Filemd5s create mode=0x42
D: adding 5 entries to Filemd5s index.
D: opening  db index       /var/lib/rpmtest/Triggername create mode=0x42
D: running post-transaction scripts
D: closed   db index       /opt/rpmroot/var/lib/rpmtest/Filemd5s
D: closed   db index       /opt/rpmroot/var/lib/rpmtest/Sha1header
D: closed   db index       /opt/rpmroot/var/lib/rpmtest/Sigmd5
D: closed   db index       /opt/rpmroot/var/lib/rpmtest/Installtid
D: closed   db index       /opt/rpmroot/var/lib/rpmtest/Provideversion
D: closed   db index       /opt/rpmroot/var/lib/rpmtest/Requireversion
D: closed   db index       /opt/rpmroot/var/lib/rpmtest/Dirnames
D: closed   db index       /opt/rpmroot/var/lib/rpmtest/Triggername
D: closed   db index       /opt/rpmroot/var/lib/rpmtest/Providename
D: closed   db index       /opt/rpmroot/var/lib/rpmtest/Requirename
D: closed   db index       /opt/rpmroot/var/lib/rpmtest/Group
D: closed   db index       /opt/rpmroot/var/lib/rpmtest/Basenames
D: closed   db index       /opt/rpmroot/var/lib/rpmtest/Name
D: closed   db index       /opt/rpmroot/var/lib/rpmtest/Packages
D: closed   db environment /opt/rpmroot/var/lib/rpmtest/Packages
D: May free Score board((nil))
</pre>

<p class="paragraph">
この段階で &quot;/opt/rpmroot&quot; 以下を見てみると、確かにディレクトリ階層とパッケージ中のファイルが配置された事が分かる。
<br />
</p>
<pre class="plugin_pre">
# find /opt/rpmroot
/opt/rpmroot
/opt/rpmroot/usr
/opt/rpmroot/usr/bin
/opt/rpmroot/usr/bin/sample
/opt/rpmroot/usr/share
/opt/rpmroot/usr/share/locale
/opt/rpmroot/usr/share/locale/ja
/opt/rpmroot/usr/share/locale/ja/LC_MESSAGES
/opt/rpmroot/usr/share/locale/ja/LC_MESSAGES/sample.mo
/opt/rpmroot/usr/share/doc
/opt/rpmroot/usr/share/doc/sample-1.0
/opt/rpmroot/usr/share/doc/sample-1.0/COPYING
/opt/rpmroot/usr/share/doc/sample-1.0/README
/opt/rpmroot/var
/opt/rpmroot/var/lib
/opt/rpmroot/var/lib/rpmtest
/opt/rpmroot/var/lib/rpmtest/Providename
/opt/rpmroot/var/lib/rpmtest/__db.001
/opt/rpmroot/var/lib/rpmtest/Sigmd5
/opt/rpmroot/var/lib/rpmtest/Requirename
/opt/rpmroot/var/lib/rpmtest/Triggername
/opt/rpmroot/var/lib/rpmtest/Packages
/opt/rpmroot/var/lib/rpmtest/Group
/opt/rpmroot/var/lib/rpmtest/__db.000
/opt/rpmroot/var/lib/rpmtest/__db.003
/opt/rpmroot/var/lib/rpmtest/Filemd5s
/opt/rpmroot/var/lib/rpmtest/Installtid
/opt/rpmroot/var/lib/rpmtest/Basenames
/opt/rpmroot/var/lib/rpmtest/__db.002
/opt/rpmroot/var/lib/rpmtest/Sha1header
/opt/rpmroot/var/lib/rpmtest/Requireversion
/opt/rpmroot/var/lib/rpmtest/Name
/opt/rpmroot/var/lib/rpmtest/Dirnames
/opt/rpmroot/var/lib/rpmtest/Provideversion
</pre>

<p class="paragraph">
&quot;relocatable&quot;なRPMパッケージを作成すれば、chrootの必要性はある程度回避できるようになるが、それもパッケージの作者に依存してしまうので常に有効とは限らない。そうした場合にこのテクニックでシステムから分離してRPMを操作できるようになる。
<br />
</p>

<h4 id="idcc39f9">一般ユーザー権限だけで準備しようとするとchroot(2)絡みでエラーになり進めなくなる件</h4>

<p class="paragraph">
この記事を書こうとして&quot;--initdb&quot;周りの実験をやり始めた時、最初は一般ユーザでディレクトリを準備していた。
<br />
すると、どうしてもパッケージインストールのところでRPMデータベース中の &quot;Basenames&quot; ファイルの作成でエラーになってしまう。
<br />
</p>
<pre class="plugin_pre">
$ mkdir $HOME/rpmroot
$ mkdir -p $HOME/rpmroot/var/lib/rpmtest
$ rpm --initdb -vv --root $HOME/rpmroot --dbpath /var/lib/rpmtest
D: opening  db environment /home/msakamoto/rpmroot/var/lib/rpmtest/Packages create:cdb:mpool
D: opening  db index       /home/msakamoto/rpmroot/var/lib/rpmtest/Packages create mode=0x42
D: locked   db index       /home/msakamoto/rpmroot/var/lib/rpmtest/Packages
D: closed   db index       /home/msakamoto/rpmroot/var/lib/rpmtest/Packages
D: closed   db environment /home/msakamoto/rpmroot/var/lib/rpmtest/Packages
D: May free Score board((nil))
$ find $HOME/rpmroot/var/lib/rpmtest
/home/msakamoto/rpmroot/var/lib/rpmtest
/home/msakamoto/rpmroot/var/lib/rpmtest/__db.001
/home/msakamoto/rpmroot/var/lib/rpmtest/Packages
/home/msakamoto/rpmroot/var/lib/rpmtest/__db.000
/home/msakamoto/rpmroot/var/lib/rpmtest/__db.003
/home/msakamoto/rpmroot/var/lib/rpmtest/__db.002
</pre>

<p class="paragraph">
このように&quot;--initdb&quot;までは順調だが、実際にパッケージのインストールに進むと・・・
<br />
</p>
<pre class="plugin_pre">
$ rpm -ivh -vv --nodeps --dbpath /var/lib/rpmtest --root $HOME/rpmroot --test sample-1.0-1.i386.rpm
D: ============== sample-1.0-1.i386.rpm
D: Expected size:        11976 = lead(96)+sigs(180)+pad(4)+data(11696)
D:   Actual size:        11976
D: sample-1.0-1.i386.rpm: Header SHA1 digest: OK (6c105c09750403c748aaaa321e442518e98663a6)
D:      added binary package [0]
D: found 0 source and 1 binary packages
D: ========== recording tsort relations
D: ========== tsorting packages (order, #predecessors, #succesors, tree, depth, breadth)
D:     0    0    0    0    1    0   +sample-1.0-1.i386
D: installing binary packages
D: opening  db environment /home/msakamoto/rpmroot/var/lib/rpmtest/Packages joinenv
D: opening  db index       /home/msakamoto/rpmroot/var/lib/rpmtest/Packages rdonly mode=0x0
D: locked   db index       /home/msakamoto/rpmroot/var/lib/rpmtest/Packages
D: mounted filesystems:
D:     i        dev    bsize       bavail       iavail mount point
D:     0 0x0000fd00     4096      1212504      2269294 /
D:     1 0x00000003     4096            0           -1 /proc
D:     2 0x00000000     4096            0           -1 /sys
D:     3 0x0000000b     4096            0           -1 /dev/pts
D:     4 0x00000801     1024        72066        26060 /boot
D:     5 0x00000012     4096        64436        64435 /dev/shm
D:     6 0x00000013     4096            0           -1 /proc/sys/fs/binfmt_misc
D:     7 0x00000014     4096            0           -1 /var/lib/nfs/rpc_pipefs
D: sanity checking 1 elements
D: opening  db index       /home/msakamoto/rpmroot/var/lib/rpmtest/Name create mode=0x0
D: running pre-transaction scripts
D: computing 5 file fingerprints
Preparing...                D: computing file dispositions
D: opening  db index       /var/lib/rpmtest/Basenames rdonly mode=0x0
D: closed   db index       /var/lib/rpmtest/Basenames
error: cannot open Basenames index using db3 - No such file or directory (2)
セグメンテーション違反です
</pre>

<p class="paragraph">
Basenamesファイルのopenで &quot;No such file or directory&quot; になってしまう。
<br />
ファイル名をよくよく見ると、PackagesとNameまでは &quot;/home/...&quot; となっており、Basenamesから &quot;--root&quot; で指定したchrootパスを除去したパス名になっている。
<br />
そのため最初は「RPMのバグかな？」と思っていたのだが、色々漁っている内に次の記事に突き当たった。
<br />
</p>
<ul><li> <a class="externallink" href="http://markmail.org/thread/lalnffstoaczbeyf" target="_blank">http://markmail.org/thread/lalnffstoaczbeyf</a></li></ul>
<blockquote><pre>Why not just run as root?
</pre></blockquote>
<p class="paragraph">
ということで、「あ、chroot(2)って特権じゃないとだめ？」と今更ながらに気づいた<span class="hidden">(</span><a class="footnote" href="#footnote_493_2" id="footnote_493_2_r"  title="スミマセン、それまでchroot使った事無かったんです・・・">*2</a><span class="hidden">)</span>。
<br />
</p>

<p class="paragraph">
試しにstraceを使ってシステムコールとその結果を表示させてみたところ、確かにchroot(2)がEPERMを返している。
<br />
</p>
<pre class="plugin_pre">
$ strace rpm -ivh -vv --nodeps --dbpath /var/lib/rpmtest --root $HOME/rpmroot \
    --test sample-1.0-1.i386.rpm 2&gt;strace.log
Preparing...
$ more strace.log
...
open(&quot;/home/msakamoto/rpmroot/var/lib/rpmtest/Name&quot;, O_RDONLY|O_LARGEFILE) = 4
...
chdir(&quot;/&quot;)                              = 0
chroot(&quot;/home/msakamoto/rpmroot/&quot;)      = -1 EPERM (Operation not permitted)
...
stat64(&quot;/var/lib/rpmtest/Basenames&quot;, 0xbfcb189c) = -1 ENOENT (No such file or directory)
</pre>

<p class="paragraph">
これでようやく、一般ユーザ権限だけのRPM環境を準備する事は不可能で、root権限が必要だと判明した次第。
<br />
</p>


<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-1244.html" title="技術/Linux/RPMコマンドメモ(yum)">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-103.html" title="技術/Linux/RPMコマンドメモ(入門レベル)">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-509.html" title="技術/Linux">Up</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-23.html" title="技術">技術</a>&nbsp;]</li>
</ul><div class="footnote">
<a id="footnote_493_1" href="#footnote_493_1_r">*1</a>: そうなると「一般ユーザーで操作可能なRPM環境を準備する」というそもそもの結構ウェイトの大きい目的から外れてしまうが、chroot(2)周りで結局root権限のファイルが出来てしまうので仕方なかった。<br />
<a id="footnote_493_2" href="#footnote_493_2_r">*2</a>: スミマセン、それまでchroot使った事無かったんです・・・
</div>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/493<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2001 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a target="_blank" href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" target="_blank" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>