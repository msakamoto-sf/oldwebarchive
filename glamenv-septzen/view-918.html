<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>技術/Windows/メモリダンプ取得方法メモ - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">技術/Windows/メモリダンプ取得方法メモ</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2011-02-13 12:05:13 &nbsp; / &nbsp; last updated at: 2011-02-27 13:42:52<br>
カテゴリ: <a href="category-8.html">Windows</a>&nbsp;<a href="category-12.html">プログラミング</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-912.html" title="技術/Windows/ブート設定">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-979.html" title="技術/Windows/共有フォルダにアクセスしているのに認証ダイアログが表示されない">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-23.html" title="技術">技術</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
Windows XP SP3, Windows 7 上でのメモリダンプ取得方法メモ。
<br />
</p>

<p class="paragraph">
基本的に &quot;Debugging Tools for Windows&quot; 無しの状態を想定しています。つまりユーザー環境でアプリケーションクラッシュやハングアップ、あるいはBSODが発生した瞬間を捕まえるための設定をメモしていきます。
<br />
なお一部のシナリオではMicrosoftから公開されている&quot;UMPD : User Mode Process Dumper&quot;というツールを使っています。
<br />
</p>

<p class="paragraph">
以下の環境で動作確認しています。いずれも日本語版のWindowsを使っています。
<br />
</p>
<pre>Windows XP SP3 : x86(32bit), Windows 7 上のXP Modeを利用
   → Win2k, WinSrv2003 など
Windows 7 : x86(32bit)
   → Vista, WinSrv2008 など
</pre>


<p class="paragraph">
参考図書：
<br />
</p>
<a href="https://www.amazon.co.jp/dp/0321374460" target="_blank">Amazon | Advanced Windows Debugging | Hewardt, Mario Pravat, Daniel | Software Development</a><br>
<a href="https://www.amazon.co.jp/dp/0321578899" target="_blank">Amazon | Advanced .NET Debugging | Hewardt, Mario | Networking</a><br>
<a href="https://www.amazon.co.jp/dp/4048675095" target="_blank">Windowsダンプの極意 エラーが発生したら、まずダンプ解析! | 上原 祥市 |本 | 通販 | Amazon</a><br>
<ul><li> &quot;AWD本&quot; : &quot;Advanced Windows Debugging&quot;</li>
<li> &quot;ADND本&quot; : &quot;Advanced .NET Debugging&quot;</li>
<li> 「Windowsダンプの極意」：第１版第５刷</li></ul>

<hr />
<ul><li><a href="#idb58962">アプリケーションのメモリダンプ</a><ul><li><a href="#id9815c4">UMPD : User Mode Process Dumper のインストール</a></li>
<li><a href="#idb88ff0">アプリケーションクラッシュ時に取得</a><ul><li><a href="#id9b0773">Windows XP SP3 (ワトソン博士を使う場合)</a></li>
<li><a href="#id2231ca">Windows XP SP3 (UMPD : User Mode Process Dumper を使う場合)</a></li>
<li><a href="#id2758cd">Windows 7</a></li></ul></li>
<li><a href="#id093e19">任意のタイミングで取得</a><ul><li><a href="#idca03ba">Windows XP SP3</a></li>
<li><a href="#id2758cd">Windows 7</a></li></ul></li>
<li><a href="#id770971">.NET アプリケーションの例外発生時に取得</a><ul><li><a href="#id2e3cdc">CLR 2.x系列(.NET Framework 2 - 3.x)</a></li>
<li><a href="#ide19989">CLR 4.x系列(.NET Framework 4)</a></li></ul></li></ul></li>
<li><a href="#idcac630">システムのメモリダンプ</a><ul><li><a href="#id6d7dd6">任意のタイミングで取得(=BSOD発生)</a><ul><li><a href="#id7b122f">PS/2接続 or USB接続のキーボードでCtrl + ScrollLock x 2でSTOPエラー発生→ダンプ取得</a></li>
<li><a href="#id786595">StartBlueScreenでコマンドラインからBSOD発生→ダンプ取得</a></li></ul></li>
<li><a href="#id8f77bf">STOPエラーなどBSOD発生時のダンプの取得設定（種類や保存場所）</a><ul><li><a href="#id1cb110">WinXPでの設定例</a></li>
<li><a href="#idf104a4">Win7での設定例</a></li>
<li><a href="#id40ac35">2GB以上のRAM搭載時の完全メモリダンプの取得</a></li></ul></li></ul></li></ul>
<hr />
<h3 id="idb58962">アプリケーションのメモリダンプ</h3>

<p class="paragraph">
アプリケーションのメモリダンプを取得する方法のメモ。クラッシュなど例外発生時に自動的に取得する方法と、任意のタイミングで取得する方法（デッドロックなどで無応答になったり、CPU100%などのハングアップ状態に陥ったとき）の二種に大別して紹介する。
<br />
</p>

<h4 id="id9815c4">UMPD : User Mode Process Dumper のインストール</h4>

<p class="paragraph">
UMPDが必要になる場面：
<br />
</p>
<ul><li> 任意のタイミングでメモリダンプを取得したい</li>
<li> クラッシュ時にワトソン博士ではダンプが取得できない（まれにあるらしい）。</li></ul>

<p class="paragraph">
対応OS：Win2k SP3,SP4/WinSrv2003 NonSP,SP1,SP2/WinXP SP1,SP2
<br />
他、WinXP SP3でも動くようです（当記事でWinXP SP3で確認）。
<br />
</p>

<p class="paragraph">
情報とダウンロード：
<br />
</p>
<ul><li> Microsoft Support Professionals Toolkit for Windows<ul><li> <a class="externallink" href="http://www.microsoft.com/japan/windowsserver2003/downloads/supporttools.mspx" target="_blank">http://www.microsoft.com/japan/windowsserver2003/downloads/supporttools.mspx</a></li></ul></li>
<li> Download details: User Mode Process Dumper Version 8.1<ul><li> <a class="externallink" href="http://www.microsoft.com/downloads/en/details.aspx?FamilyID=E089CA41-6A87-40C8-BF69-28AC08570B7E&amp;displaylang=en" target="_blank">http://www.microsoft.com/downloads/en/details.aspx?FamilyID=E089CA41-6A87-40C8-BF69-28AC08570B7E&amp;displaylang=en</a></li></ul></li></ul>

<p class="paragraph">
以降の記事では UserModeProcessDumper8_1_2929_5.exe を使っています。
<br />
</p>

<p class="paragraph">
インストール：
<br />
</p>
<ol><li> ダウンロードリンクからexeをDLし、実行するとunzip解凍先が聞かれる。</li>
<li> デフォルトでは &quot;C:\kktools\userdump8.1&quot; になっている。特に変更する必要がなければそのままunzip。</li>
<li> クラッシュ時にダンプを取得させたい場合は、&quot;userdump8.1&quot;フォルダ以下の各アーキテクチャフォルダにあるsetup.exeを使ってシステムにインストールする。&quot;%WINDOWS%\system32\kktools&quot;以下にインストールされ、PATH環境変数にも同フォルダが自動で追加される。<ol><li> 任意のタイミングで取得したいだけであれば、setup.exeのインストールは不要です。</li></ol></li></ol>

<p class="paragraph">
setup.exeからのインストールの流れ：
<br />
<a href="./../images/winmemdump/umpd_setup_1.jpg" title="" target="_blank"><img src="./../images/winmemdump/umpd_setup_1.jpg" alt="" title=""  /></a>
<br />
↓
<br />
<a href="./../images/winmemdump/umpd_setup_2.jpg" title="" target="_blank"><img src="./../images/winmemdump/umpd_setup_2.jpg" alt="" title=""  /></a>
<br />
↓
<br />
<a href="./../images/winmemdump/umpd_setup_3.jpg" title="" target="_blank"><img src="./../images/winmemdump/umpd_setup_3.jpg" alt="" title=""  /></a>
<br />
↓
<br />
<a href="./../images/winmemdump/umpd_setup_4.jpg" title="" target="_blank"><img src="./../images/winmemdump/umpd_setup_4.jpg" alt="" title=""  /></a>
<br />
</p>

<p class="paragraph">
以上でインストールは終わり。使い方については以降の説明を参照。
<br />
</p>

<p class="paragraph">
ちなみに、UMPDには富士通・日立・日本ユニシス・NTTデータ・東芝が開発に関わっているようです。
<br />
</p>

<h4 id="idb88ff0">アプリケーションクラッシュ時に取得</h4>

<p class="paragraph">
例外発生などでアプリケーションがクラッシュしたときに自動的にメモリダンプを取得する方法を紹介します。
<br />
</p>

<h5 id="id9b0773">Windows XP SP3 (ワトソン博士を使う場合)</h5>

<p class="paragraph">
参考：「Windows ダンプの極意」p50-51
<br />
</p>

<p class="paragraph">
１．ワトソン博士(OSが提供するデバッガ)がデフォルトのデバッガになっているかチェック。
<br />
</p>
<pre>&gt; reg query &quot;HKLM\Software\Microsoft\Windows NT\CurrentVersion\AeDebug&quot; /v Debugger
...
   Debugger    REG_SZ  drwtsn32 -p %ld -e %ld -g
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^ : O.K.
</pre>

<p class="paragraph">
もしVisualStudioやDebugging Tools for Windowsのデバッガが設定されている場合は、
<br />
</p>
<pre>&gt; drwtsn32 -i
</pre>
<p class="paragraph">
とすることでワトソン博士に変更できる。
<br />
</p>

<p class="paragraph">
２．アプリケーションクラッシュ時に自動的にデバッガ(ワトソン博士)が起動することをチェック。
<br />
</p>
<pre>&gt; reg query &quot;HKLM\Software\Microsoft\Windows NT\CurrentVersion\AeDebug&quot; /v Auto
...
   Auto        REG_SZ  1
                       ^ : O.K.
</pre>
<p class="paragraph">
&quot;0&quot;になっている場合は1に変更する。
<br />
</p>

<p class="paragraph">
３．ワトソン博士の設定をチェック。
<br />
ログファイルパス, クラッシュダンプのファイル名を確認。例：
<br />
</p>
<pre>ログファイルパス：
C:\Documents and Settings\All Users\Application Data\Microsoft\Dr Watson
クラッシュダンプファイル名：
C:\Documents and Settings\All Users\Application Data\Microsoft\Dr Watson\user.dmp
</pre>
<p class="paragraph">
クラッシュダンプの種類は「完全」を選択しておく。オプションはデフォルトのままにしておく。
<br />
下記スクリーンショット参照。
<br />
<a href="./../images/winmemdump/appdump_drwtsn32.jpg" title="" target="_blank"><img src="./../images/winmemdump/appdump_drwtsn32.jpg" alt="" title=""  /></a>
<br />
</p>

<p class="paragraph">
適当なアプリで例外を発生させると、ログがログファイルに記録され、ダンプファイルが作成される。ダンプファイルはwindbgなどで読み込むことが出来る。
<br />
</p>

<p class="paragraph">
※エラー報告機能の影響でアプリクラッシュが分かりづらい場合は、エラー報告を無効にする。
<br />
「マイコンピュータ」右クリック→「システムのプロパティ」→「詳細設定」タブ→「エラー報告」で「エラー報告を無効にする」を設定する。
<br />
</p>

<h5 id="id2231ca">Windows XP SP3 (UMPD : User Mode Process Dumper を使う場合)</h5>

<p class="paragraph">
参考：「Windows ダンプの極意」p54
<br />
</p>

<p class="paragraph">
ワトソン博士でダンプを取得できない場合があるらしい。その場合はUMPDを使う。
<br />
</p>
<ol><li> UMPDをsetup.exeを使ってインストールする(前述)。</li>
<li> コントロールパネルから「Process Dumper」を起動し、「Process Monitoring」タブを開き、クラッシュするアプリケーションおよびUMPDで補足したい例外の種類を設定する。</li>
<li> アプリケーションを起動し、クラッシュさせるかクラッシュするのを待つ。クラッシュするとUMPDで設定したフォルダに「実行ファイル名＋PID＋&quot;.dmp&quot;」というファイル名でダンプファイルが作成される。</li></ol>

<p class="paragraph">
設定例：AWD本のサンプル、02sample.exeを設定してみた。
<br />
</p>

<p class="paragraph">
<a href="./../images/winmemdump/umpd_conf_1.jpg" title="" target="_blank"><img src="./../images/winmemdump/umpd_conf_1.jpg" alt="" title=""  /></a>
<br />
↓ &quot;Add&quot;ボタンをクリックしてアプリの実行ファイル名を指定する。
<br />
</p>

<p class="paragraph">
<a href="./../images/winmemdump/umpd_conf_2.jpg" title="" target="_blank"><img src="./../images/winmemdump/umpd_conf_2.jpg" alt="" title=""  /></a>
<br />
</p>

<p class="paragraph">
↓ アプリ毎に設定を調整したい場合は、「Process Monitoring」タブで追加したアプリ名をクリックし、下部「Rules」ボタンをクリック。
<br />
</p>

<p class="paragraph">
<a href="./../images/winmemdump/umpd_conf_3.jpg" title="" target="_blank"><img src="./../images/winmemdump/umpd_conf_3.jpg" alt="" title=""  /></a>
<br />
</p>

<p class="paragraph">
↓ 「Use custom rules」を選択し、調整する。（「Use default rules」の場合デフォルト設定が使われる。デフォルト設定は「Process Monitoring」タブ画面下部の「Default Settings」ボタンをクリックして開く設定画面から変更できる。）
<br />
</p>

<p class="paragraph">
<a href="./../images/winmemdump/umpd_conf_4.jpg" title="" target="_blank"><img src="./../images/winmemdump/umpd_conf_4.jpg" alt="" title=""  /></a>
<br />
</p>

<h5 id="id2758cd">Windows 7</h5>

<p class="paragraph">
参考：AWD本Chapter15, p743
<br />
</p>

<p class="paragraph">
Vista/Svr2008以降はWindows Error Reportingが大幅に改良され、ワトソン博士も外された。
<br />
</p>
<ul><li> What&#039;s New in WER (Windows)<ul><li> <a class="externallink" href="http://msdn.microsoft.com/en-us/library/bb513640.aspx" target="_blank">http://msdn.microsoft.com/en-us/library/bb513640.aspx</a><ul><li> &quot;MSDN Library&quot; &gt; &quot;Windows Development&quot; &gt; &quot;Diagnostics&quot; &gt; &quot;Windows Error Reporting&quot; &gt; &quot;What&#039;s New in WER&quot;</li></ul></li></ul></li></ul>

<p class="paragraph">
AWD本Chapter15, p743ではWER関連レジスタの&quot;ForceQueue&quot;値を編集することでダンプファイルをローカルに保存する方法が紹介されている。
<br />
本記事ではMSDNで紹介されているWER関連レジスタの&quot;LocalDumps&quot;キーを使ったダンプ方法を紹介する。キー自体はWER配下にあるが、他のWER機構とは独立しているため、エラー報告を無効にしていたり、あるいはエラー報告のダイアログボックスで「送信しない」をクリックした場合でも取得できる。
<br />
</p>
<ul><li> Collecting User-Mode Dumps (Windows)<ul><li> <a class="externallink" href="http://msdn.microsoft.com/en-us/library/bb787181.aspx" target="_blank">http://msdn.microsoft.com/en-us/library/bb787181.aspx</a><ul><li> &quot;MSDN Library&quot; &gt; &quot;Windows Development&quot; &gt; &quot;Diagnostics&quot; &gt; &quot;Windows Error Reporting&quot; &gt; &quot;Using WER&quot; &gt; &quot;Collecting User-Mode Dumps&quot;</li></ul></li></ul></li></ul>

<p class="paragraph">
設定例：
<br />
以下のregコマンドを管理者として実行したコマンドプロンプトから実行する。
<br />
&quot;HKLM\...&quot; は &quot;HKLM\SOFTWARE\Microsoft\Windows\Windows Error Reporting\LocalDumps&quot; に読み替えてください。
<br />
</p>
<pre>reg add &quot;HKLM\...&quot; /v DumpFolder /t REG_EXPAND_SZ /d ^%LOCALAPPDATA^%\CrashDumps /f
reg add &quot;HKLM\...&quot; /v DumpCount /t REG_DWORD /d 10 /f
reg add &quot;HKLM\...&quot; /v DumpType /t REG_DWORD /d 2 /f
reg add &quot;HKLM\...&quot; /v CustomDumpFlags /t REG_DWORD /d 0 /f
</pre>
<p class="paragraph">
上記設定の内容：
<br />
</p>
<pre>ダンプファイルの保存場所は &quot;%LOCALAPPDATA%\CrashDumps&quot;
上記フォルダに保存するダンプファイルの最大数は 10
フルダンプ(DumpType = 2)
(フルダンプなので使われないが、一応デフォルト値として設定)カスタムダンプ種類：通常(0)
</pre>
<p class="paragraph">
CustomDumpFlagsはDumpType=0, CustomDumpの場合に使われる。
<br />
</p>

<h4 id="id093e19">任意のタイミングで取得</h4>

<p class="paragraph">
デッドロックなどで無応答になったり、CPU100%で操作を受け付けなくなったときにメモリダンプを取得する方法を紹介します。
<br />
</p>

<h5 id="idca03ba">Windows XP SP3</h5>

<p class="paragraph">
UMPDを使う。unzipした段階で使える。setup.exeのインストールは不要。
<br />
</p>
<ol><li> コマンドプロンプトを開き、unzipしたフォルダ(デフォルトは&quot;C:\kktools\userdump8.1&quot;)中のご使用のアーキテクチャのフォルダにCDする。</li>
<li> &quot;userdump.exe -p&quot;でプロセス一覧を表示し、対象アプリのPIDか実行ファイル名を確認。</li>
<li> &quot;userdump.exe PID or 実行ファイル名&quot;でダンプ取得。</li></ol>

<p class="paragraph">
実行例：
<br />
</p>
<pre class="plugin_pre">
&gt; userdump -p
 C:\kktools\userdump8.1\x86&gt;userdump -p
User Mode Process Dumper (Version 8.1.2929.5)
Copyright (c) Microsoft Corp. All rights reserved.
   0 System Idle Process
   4 System
 600 smss.exe
...
2064 cmd.exe
1268 10DeadLock.exe
 788 userdump.exe

&gt; userdump 1268
User Mode Process Dumper (Version 8.1.2929.5)
Copyright (c) Microsoft Corp. All rights reserved.
Dumping process 1268 (10DeadLock.exe) to
C:\kktools\userdump8.1\x86\10DeadLock.dmp...
The process was dumped successfully.
</pre>
<p class="paragraph">
&quot;svchost.exe&quot;のように複数起動しているプロセスを指定した場合は、「svchost + PID + .dmp」というダンプファイル名でそれぞれのプロセスダンプを取得できる。
<br />
</p>
<pre class="plugin_pre">
&gt; userdump svchost.exe
User Mode Process Dumper (Version 8.1.2929.5)
Copyright (c) Microsoft Corp. All rights reserved.
Dumping process 920 (svchost.exe) to
C:\kktools\userdump8.1\x86\svchost920.dmp...
The process was dumped successfully.

(...)

Dumping process 1512 (svchost.exe) to
C:\kktools\userdump8.1\x86\svchost1512.dmp...
The process was dumped successfully.

&gt; dir svc*.dmp
...
2011/02/13  09:56        79,449,566 svchost1144.dmp
2011/02/13  09:56        24,162,167 svchost1220.dmp
2011/02/13  09:56        32,242,271 svchost1292.dmp
2011/02/13  09:56        34,269,822 svchost1512.dmp
2011/02/13  09:56        37,085,120 svchost920.dmp
2011/02/13  09:56        32,818,123 svchost988.dmp
...
</pre>

<h5 id="id2758cd">Windows 7</h5>

<p class="paragraph">
Vista, Win7以降ではタスクマネージャーから任意のタイミングでメモリダンプを取得できる。次のKBを参照。
<br />
</p>
<ul><li> Windows Vista でユーザーモード プロセスのダンプ ファイルを作成する方法<ul><li> <a class="externallink" href="http://support.microsoft.com/kb/931673" target="_blank">http://support.microsoft.com/kb/931673</a></li></ul></li>
<li> タスクマネージャーで取得できるダンプは「フルダンプ」になる。</li>
<li> SysinternalsのProcess Explorerを使うと、プロセスを右クリック→「Create Dump」から「Mini Dump」か「Full Dump」かを選択できる。</li>
<li> Process Explorerではダンプファイル名と保存場所を指定できるが、タスクマネージャー経由では指定できない(&quot;AppData\Local\Temp&quot;以下)。</li></ul>

<h4 id="id770971">.NET アプリケーションの例外発生時に取得</h4>

<p class="paragraph">
マネージドコードを含むアプリケーションで、CLRの例外：Exception code = 0xe0434f4d 発生時にダンプを取得する方法を紹介します。
<br />
WinXP, Win7 共通です。ただし、CLR 2.x系列(.NET Framework 2 - 3.x) と CLR 4.x系列(.NET Framework 4)とで一部レジストリ設定が異なります。
<br />
</p>

<p class="paragraph">
設定の基本方針としては以下の２ステップです。
<br />
</p>
<ol><li> CLR例外発生時にDebugging Tools for Windowsのcdb, ntsd, windbgを起動するように設定する。</li>
<li> デバッガ起動時のコマンドラインオプションを調整し、ダンプを取得してすぐに終了するように設定する。</li></ol>

<p class="paragraph">
参考：
<br />
</p>
<ul><li> Enabling JIT-Attach Debugging (.NET Framework 4)<ul><li> <a class="externallink" href="http://msdn.microsoft.com/en-us/library/2ac5yxx6.aspx" target="_blank">http://msdn.microsoft.com/en-us/library/2ac5yxx6.aspx</a><ul><li> &quot;MSDN Library&quot; &gt; &quot;.NET Development&quot; &gt; &quot;.NET Framework 4&quot; &gt; &quot;.NET Framework Core Development&quot; &gt; &quot;Debugging, Tracing, and Profiling&quot; &gt; &quot;Enabling JIT-Attach Debugging&quot;</li></ul></li></ul></li>
<li> Enabling JIT-attach Debugging (Visual Studio 2005 ver.)<ul><li> <a class="externallink" href="http://msdn.microsoft.com/en-us/library/2ac5yxx6%28v=VS.80%29.aspx" target="_blank">http://msdn.microsoft.com/en-us/library/2ac5yxx6%28v=VS.80%29.aspx</a><ul><li> &quot;MSDN Library&quot; &gt; &quot;Development Tools and Languages&quot; &gt; &quot;Visual Studio 2005&quot; &gt; &quot;Visual Studio&quot; &gt; &quot;.NET Framework Programming in Visual Studio&quot; &gt; &quot;.NET Framework Core Development&quot; &gt; &quot;Debugging and Profiling Applications&quot; &gt; &quot;Enabling JIT-attach Debugging&quot;</li></ul></li></ul></li>
<li> Configuring Automatic Debugging<ul><li> <a class="externallink" href="http://msdn.microsoft.com/en-us/library/bb204634.aspx" target="_blank">http://msdn.microsoft.com/en-us/library/bb204634.aspx</a><ul><li> &quot;MSDN Library&quot; &gt; &quot;Windows Development&quot; &gt; &quot;Diagnostics&quot; &gt; &quot;Debugging and Error Handling&quot; &gt; &quot;Basic Debugging&quot; &gt; &quot;Using Basic Debugging&quot; &gt; &quot;Configuring Automatic Debugging&quot;</li></ul></li></ul></li>
<li> Automatically Capturing a Dump When a Process Crashes - CLR Team Blog - Site Home - MSDN Blogs<ul><li> <a class="externallink" href="http://blogs.msdn.com/b/clrteam/archive/2009/10/15/automatically-capturing-a-dump-when-a-process-crashes.aspx" target="_blank">http://blogs.msdn.com/b/clrteam/archive/2009/10/15/automatically-capturing-a-dump-when-a-process-crashes.aspx</a></li></ul></li></ul>

<p class="paragraph">
MSDNの&quot;Enabling JIT-Attach Debugging&quot;については表示するバージョンによって内容が変わるため注意が必要。
<br />
</p>

<h5 id="id2e3cdc">CLR 2.x系列(.NET Framework 2 - 3.x)</h5>

<p class="paragraph">
１．例外発生時に起動するデバッガを指定する。
<br />
</p>

<p class="paragraph">
HKLM\SOFTWARE\Microsoft\.NETFramework\DbgManagedDebugger で例外発生時に起動するデバッガのフルパスとそのコマンドラインオプションを指定する。コマンドラインオプションでは &quot;-p %ld&quot; を必ず含める。デフォルトではこのレジストリ値は設定されていない。
<br />
</p>

<pre>例：
reg add HKLM\SOFTWARE\Microsoft\.NETFramework /v DbgManagedDebugger /t REG_SZ /d &quot;...\ntsd.exe -p %ld&quot; /f
</pre>

<p class="paragraph">
デスクトップ上でデバッガウインドウが起動するのを一度目視確認しておきたい場合はこのまま「２．」に進む。
<br />
デバッガウインドウの目視確認は不要で、ダンプファイルが生成される事だけを確認したい場合は、この段階で後述の「３．デバッガ起動時のコマンドラインオプション調整」で紹介するコマンドラインオプションを埋め込んでおく。
<br />
</p>

<p class="paragraph">
２．デバッガ起動のタイミングを指定する。
<br />
</p>

<p class="paragraph">
HKLM\SOFTWARE\Microsoft\.NETFramework\DbgJITDebugLaunchSetting でデバッガ起動タイミングを指定する。対話形式(デスクトップアプリ)・非対話形式(サービス系)の違いや、デバッガ起動時のメッセージボックス表示有無を調整することが出来る。デフォルトではこのレジストリ値は設定されていない。
<br />
</p>

<p class="paragraph">
とりあえず DbgManagedDebugger に登録したデバッガを起動させたい場合は 2 or 16 を指定する。
<br />
</p>
<ul><li> 2を指定すると、プロセスの対話形式(デスクトップアプリ)・非対話形式(サービス)に関わらずデバッガを起動する。</li>
<li> 16を指定すると、対話形式のプロセスならデバッガ起動の確認メッセージボックス表示。非対話形式なら確認なしでデバッガを起動する。</li></ul>

<pre>reg add HKLM\SOFTWARE\Microsoft\.NETFramework /v DbgJITDebugLaunchSetting /t REG_DWORD /d 2 /f
</pre>

<p class="paragraph">
３．デバッガ起動時のコマンドラインオプション調整
<br />
</p>

<p class="paragraph">
デバッガが起動したら即座にダンプファイルを取得、プロセスを終了するよう DbgManagedDebugger を調整する。
<br />
例：
<br />
</p>
<pre>(fullpath)\ntsd -pv -p %ld -c &quot;.dump /u /ma &lt;path to dumpfile&gt;; .kill; qd&quot;
</pre>

<h5 id="ide19989">CLR 4.x系列(.NET Framework 4)</h5>

<p class="paragraph">
CLR 4.x系列になると、関連レジストリがネイティブコードのデバッグに統合された。
<br />
ネイティブコードの場合と同様、起動するデバッガを
<br />
</p>
<pre>reg query &quot;HKLM\Software\Microsoft\Windows NT\CurrentVersion\AeDebug&quot; /v Debugger
</pre>
<p class="paragraph">
自動起動の設定を
<br />
</p>
<pre>reg query &quot;HKLM\Software\Microsoft\Windows NT\CurrentVersion\AeDebug&quot; /v Auto
</pre>
<p class="paragraph">
で確認できる。
<br />
</p>

<p class="paragraph">
HKLM\SOFTWARE\Microsoft\.NETFramework のDbgManagedDebugger, DbgJITDebugLaunchSetting は使わない。
<br />
</p>

<p class="paragraph">
１．例外発生時に起動するデバッガを指定する。
<br />
</p>

<p class="paragraph">
各デバッガ及びワトソン博士に特定のコマンドラインオプションを渡すことで自動的にレジストリを設定してくれる。
<br />
</p>
<pre>windbg -I
cdb -iae
ntsd -iae
drwtsn32 -i
</pre>

<p class="paragraph">
２．デバッガ起動のタイミングを指定する。
<br />
</p>

<p class="paragraph">
AeDebugの&quot;Auto&quot;を&quot;1&quot;に設定する。上述の「１．」での自動設定に含まれているので、特に手動で調整する必要はない。
<br />
</p>

<p class="paragraph">
３．デバッガ起動時のコマンドラインオプション調整
<br />
</p>

<p class="paragraph">
AeDebugの&quot;Debugger&quot;に、CLR 2.x系列の「３．」を参考に同様なコマンドラインオプションを設定する。
<br />
</p>

<h3 id="idcac630">システムのメモリダンプ</h3>

<p class="paragraph">
OSのCrashDumpの取得方法を紹介する。なお「カーネルダンプ」という単語はダンプの種類の一つを指してしまうため、いわゆるBSOD、OSのCrashによるメモリダンプをここでは「システムのメモリダンプ」と便宜上呼んでおく。
<br />
</p>

<p class="paragraph">
設定方法はWinXPとWin7でほとんど変わりません。2011年現在、MicrosoftのKBなどWeb上に資料が揃っていますので、詳細はそちらを参照してください。
<br />
</p>

<p class="paragraph">
参考資料：
<br />
</p>
<ul><li> 「Windows ダンプの極意」p43-</li>
<li> Windows: Understanding Crash Dump Files<ul><li> <a class="externallink" href="http://www.ditii.com/2008/01/08/windows-understanding-crash-dump-files/" target="_blank">http://www.ditii.com/2008/01/08/windows-understanding-crash-dump-files/</a></li></ul></li>
<li> Windows でシステム障害と回復のオプションを構成する方法<ul><li> <a class="externallink" href="http://support.microsoft.com/kb/307973/ja" target="_blank">http://support.microsoft.com/kb/307973/ja</a></li></ul></li>
<li> Windows Vista、Windows Server 2008 R2、Windows Server 2008、Windows Server 2003、Windows XP、および Windows 2000 のメモリ ダンプ ファイル オプションの概要<ul><li> <a class="externallink" href="http://support.microsoft.com/kb/254649/" target="_blank">http://support.microsoft.com/kb/254649/</a></li></ul></li>
<li> システムが予期せず停止した場合の動作を指定する<ul><li> <a class="externallink" href="http://technet.microsoft.com/ja-jp/library/cc778968%28WS.10%29.aspx" target="_blank">http://technet.microsoft.com/ja-jp/library/cc778968%28WS.10%29.aspx</a></li></ul></li>
<li> Windows BSOD analysis - A thorough usage guide<ul><li> <a class="externallink" href="http://www.dedoimedo.com/computers/windows-bsod.html" target="_blank">http://www.dedoimedo.com/computers/windows-bsod.html</a></li></ul></li></ul>

<p class="paragraph">
NMIを使ったりWindows Server2008 だったり、エンタープライズサーバー向けのKB：
<br />
</p>
<ul><li> How to generate a kernel or a complete memory dump file in Windows Server 2008<ul><li> <a class="externallink" href="http://support.microsoft.com/kb/969028/" target="_blank">http://support.microsoft.com/kb/969028/</a></li></ul></li>
<li> How to generate a complete crash dump file or a kernel crash dump file by using an NMI on a Windows-based system<ul><li> <a class="externallink" href="http://support.microsoft.com/kb/927069/" target="_blank">http://support.microsoft.com/kb/927069/</a></li></ul></li></ul>

<h4 id="id6d7dd6">任意のタイミングで取得(=BSOD発生)</h4>

<p class="paragraph">
任意のタイミングで取得する方法として、キーボード操作でSTOPエラー→BSODを発生させる方法と、&quot;StartBlueScreen&quot;というツールを使って任意のパラメータでKeBugCheckEx()実行→BSODを発生させる方法の二種類を紹介する。
<br />
</p>

<h5 id="id7b122f">PS/2接続 or USB接続のキーボードでCtrl + ScrollLock x 2でSTOPエラー発生→ダンプ取得</h5>

<ul><li> キーボード操作でメモリ ダンプ ファイルを作成できる Windows の機能<ul><li> <a class="externallink" href="http://support.microsoft.com/kb/244139/" target="_blank">http://support.microsoft.com/kb/244139/</a></li></ul></li></ul>

<p class="paragraph">
キーボード操作で～の場合のレジストリ設定例<strong>(PS/2接続専用)</strong>：管理者として実行したコマンドプロンプトで以下を実行：
<br />
</p>
<pre>reg add HKLM\SYSTEM\CurrentControlSet\Services\i8042prt\Parameters \
        /v CrashOnCtrlScroll /t REG_DWORD /d 1 /f
</pre>
<p class="paragraph">
レジストリ設定後、再起動。なおCtrlを押しながらScrollLockを二度押しでBSODになるが、<strong>この時押すCtrlキーはSpaceの右側のCtrlキーなので間違えないよう注意。</strong>
<br />
</p>

<p class="paragraph">
キーボード操作によるSTOP発生を無効化するには、上記レジストリに0を設定して再起動する。
<br />
</p>
<pre>reg add HKLM\SYSTEM\CurrentControlSet\Services\i8042prt\Parameters \
        /v CrashOnCtrlScroll /t REG_DWORD /d 0 /f
</pre>

<p class="paragraph">
USB接続キーボードの場合は、次のレジストリキーが対象となる。CrashOnCtrlScrollやその値はPS/2の時と同様。
<br />
</p>
<pre>HKLM\SYSTEM\CurrentControlSet\Services\kbdhid\Parameters
</pre>
<p class="paragraph">
なおWinSrv2003の場合のみ、KB244139にも記載があるがドライバのアップデートが必要。それ以外のバージョンであればドライバのアップデートは不要。(Win7では不要だった)
<br />
</p>

<h5 id="id786595">StartBlueScreenでコマンドラインからBSOD発生→ダンプ取得</h5>

<ul><li> StartBlueScreen - Initiate a Blue Screen of Death (BSOD) in Windows operating system<ul><li> <a class="externallink" href="http://www.nirsoft.net/utils/start_blue_screen.html" target="_blank">http://www.nirsoft.net/utils/start_blue_screen.html</a></li></ul></li></ul>

<p class="paragraph">
StartBlueScreenはコマンドラインからKeBugCheckEx()に与えるパラメータを設定できます。詳しくは上記WebサイトおよびDLしたアーカイブ中のreadmeファイルを参照してください。
<br />
</p>

<h4 id="id8f77bf">STOPエラーなどBSOD発生時のダンプの取得設定（種類や保存場所）</h4>

<p class="paragraph">
基本的に「起動と回復」設定でダンプの種類や保存場所、Crash発生時の挙動を設定する。設定後の再起動は不要。
<br />
</p>
<ul><li> WinXPの場合：<ul><li> 「コントロールパネル」→「システム」（デスクトップ上のマイコンピュータを右クリック）→「システムのプロパティ」→「詳細設定」→「起動と回復」→「詳細」ボタンクリック</li></ul></li>
<li> Win7の場合：<ul><li> 「コントロール パネル」→「システムとセキュリティ」→「システム」の左ペイン、「システムの詳細設定」→「起動と回復」→「詳細」ボタンクリック</li></ul></li></ul>

<p class="paragraph">
ダンプの種類で「完全メモリダンプ」を指定した場合は、Crash時に一旦全物理メモリを書き出すため、ブートボリューム上に十分な大きさのページングファイルと空き容量が必要。ページングファイルサイズの設定は基本的に「パフォーマンスオプション」から設定する。設定変更後は再起動が必要。
<br />
</p>
<ul><li> WinXPの場合：<ul><li> 「コントロールパネル」→「システム」（デスクトップ上のマイコンピュータを右クリック）→「システムのプロパティ」→「詳細設定」→「パフォーマンス」→「詳細」ボタンクリック→「パフォーマンスオプション」の「詳細設定」タブ→「仮想メモリ」→「変更」ボタンクリック</li></ul></li>
<li> Win7の場合：<ul><li> 「コントロール パネル」→「システムとセキュリティ」→「システム」の左ペイン、「システムの詳細設定」→「パフォーマンス」→「詳細」ボタンクリック→「パフォーマンスオプション」の「詳細設定」タブ→「仮想メモリ」→「変更」ボタンクリック<ul><li> &quot;初期サイズ&quot;を「すべてのドライブの総ページングファイルサイズ」の推奨値以上に設定しておけば「完全ダンプ」でも安心。</li></ul></li></ul></li></ul>

<h5 id="id1cb110">WinXPでの設定例</h5>

<p class="paragraph">
「起動と回復」設定のデフォルト：
<br />
<a href="./../images/winmemdump/oscrash_xp1_default.jpg" title="" target="_blank"><img src="./../images/winmemdump/oscrash_xp1_default.jpg" alt="" title=""  /></a>
<br />
</p>

<p class="paragraph">
「自動的に再起動する」をオフにしてBSOD画面を表示させる＋ダンプの種類をカーネルメモリダンプに変更：
<br />
<a href="./../images/winmemdump/oscrash_xp2_kmd.jpg" title="" target="_blank"><img src="./../images/winmemdump/oscrash_xp2_kmd.jpg" alt="" title=""  /></a>
<br />
</p>

<p class="paragraph">
ページングファイルサイズの設定：XPModeで512MBのRAMを割り当ててあり、初期値を「推奨」以上に設定済み：
<br />
<a href="./../images/winmemdump/oscrash_xp3_disk.jpg" title="" target="_blank"><img src="./../images/winmemdump/oscrash_xp3_disk.jpg" alt="" title=""  /></a>
<br />
</p>

<p class="paragraph">
BSOD:
<br />
<a href="./../images/winmemdump/oscrash_xp5_bsod.png" title="" target="_blank"><img src="./../images/winmemdump/oscrash_xp5_bsod.png" alt="" title=""  /></a>
<br />
</p>

<p class="paragraph">
BSOD→再起動後、ログインしたあとでデスクトップに表示されるメッセージボックス：
<br />
<a href="./../images/winmemdump/oscrash_xp4.jpg" title="" target="_blank"><img src="./../images/winmemdump/oscrash_xp4.jpg" alt="" title=""  /></a>
<br />
</p>

<h5 id="idf104a4">Win7での設定例</h5>

<p class="paragraph">
「起動と回復」設定のデフォルト：
<br />
<a href="./../images/winmemdump/oscrash_w71_default.jpg" title="" target="_blank"><img src="./../images/winmemdump/oscrash_w71_default.jpg" alt="" title=""  /></a>
<br />
</p>

<p class="paragraph">
BSOD→再起動後、ログインしたあとでデスクトップに表示されるメッセージボックス：
<br />
<a href="./../images/winmemdump/oscrash_w73.jpg" title="" target="_blank"><img src="./../images/winmemdump/oscrash_w73.jpg" alt="" title=""  /></a>
<br />
</p>

<p class="paragraph">
<a href="./../images/winmemdump/oscrash_w74.jpg" title="" target="_blank"><img src="./../images/winmemdump/oscrash_w74.jpg" alt="" title=""  /></a>
<br />
</p>

<h5 id="id40ac35">2GB以上のRAM搭載時の完全メモリダンプの取得</h5>

<p class="paragraph">
実験に使ったWin7は4GBのRAMを搭載している(32bitOSなので利用可能なのは3GBまで)。
<br />
このため、「起動と回復」設定からは「完全メモリダンプ」を選択できない。そもそも「デバッグ情報の書き込み」のダンプ種類を選択するプルダウンメニューに「完全メモリダンプ」の項目が無い。
<br />
<a href="./../images/winmemdump/oscrash_w72_nofull.jpg" title="" target="_blank"><img src="./../images/winmemdump/oscrash_w72_nofull.jpg" alt="" title=""  /></a>
<br />
</p>

<p class="paragraph">
レジストリを手動で設定することで「完全メモリダンプ」にすることが出来る。
<br />
</p>
<pre>レジストリキー：
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\CrashControl
値：
CrashDumpEnabled    REG_DWORD    0x1 &lt;= 「完全メモリダンプ」
</pre>

<p class="paragraph">
管理者として実行したコマンドプロンプトから下記のコマンドを実行することでもCrashDumpEnabledを1に変更できる。
<br />
</p>
<pre>wmic recoveros set DebugInfoType = 1
</pre>

<p class="paragraph">
ページングファイルサイズも手動で設定しなおす。
<br />
</p>

<p class="paragraph">
デフォルトでは自動管理になっていた：
<br />
<a href="./../images/winmemdump/oscrash_w75_pfs.jpg" title="" target="_blank"><img src="./../images/winmemdump/oscrash_w75_pfs.jpg" alt="" title=""  /></a>
<br />
</p>

<p class="paragraph">
カスタムサイズにして、初期値を推奨値以上に設定し、<strong>「設定」ボタンをクリックする。</strong>「設定」ボタンのクリックを忘れると、設定値が反映されない。
<br />
<a href="./../images/winmemdump/oscrash_w76_pfs.jpg" title="" target="_blank"><img src="./../images/winmemdump/oscrash_w76_pfs.jpg" alt="" title=""  /></a>
<br />
</p>

<p class="paragraph">
再起動後念のため確認：
<br />
<a href="./../images/winmemdump/oscrash_w77_pfs.jpg" title="" target="_blank"><img src="./../images/winmemdump/oscrash_w77_pfs.jpg" alt="" title=""  /></a>
<br />
</p>

<p class="paragraph">
以上の設定で、完全メモリダンプが有効になる。
<br />
</p>

<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-912.html" title="技術/Windows/ブート設定">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-979.html" title="技術/Windows/共有フォルダにアクセスしているのに認証ダイアログが表示されない">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-703.html" title="技術/Windows">Up</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-23.html" title="技術">技術</a>&nbsp;]</li>
</ul>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/918<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2001 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a target="_blank" href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" target="_blank" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>