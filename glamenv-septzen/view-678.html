<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>技術/Windows/PE(Portable Executable)フォーマットの実験/02, 再配置情報で遊ぼう！ - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">技術/Windows/PE(Portable Executable)フォーマットの実験/02, 再配置情報で遊ぼう！</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2010-06-10 20:31:46 &nbsp; / &nbsp; last updated at: 2010-07-13 12:19:18<br>
カテゴリ: <a href="category-10.html">C言語</a>&nbsp;<a href="category-28.html">Python</a>&nbsp;<a href="category-8.html">Windows</a>&nbsp;<a href="category-50.html">hacks</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-664.html" title="技術/Windows/PE(Portable Executable)フォーマットの実験/01, リンカオプション">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-707.html" title="技術/Windows/PE(Portable Executable)フォーマットの実験/03, TinyPEまとめ">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-23.html" title="技術">技術</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
PEファイルの再配置情報を取得、表示してみる。
<br />
さらにその発展として、PythonによりDLLをメモリ上にロード、再配置情報とIATを手動で書き換え実行可能にし、実際にエクスポート関数をPythonから呼んでみる。
<br />
</p>

<p class="paragraph">
Pythonは 2.6 を使用。
<br />
OSはWindows XP SP3, VCはVC++ 2008 Express Edition, コンパイラとリンカのバージョンは次の通り：
<br />
</p>
<pre>&gt; cl
Microsoft(R) 32-bit C/C++ Optimizing Compiler Version 15.00.30729.01 for 80x86
Copyright (C) Microsoft Corporation.  All rights reserved.
</pre>

<pre>&gt; link
Microsoft (R) Incremental Linker Version 9.00.30729.01
Copyright (C) Microsoft Corporation.  All rights reserved.
</pre>



<ul><li><a href="#idb298ae">サンプルコード</a><ul><li><a href="#id46ff00">DLL側：dlltest.c</a><ul><li><a href="#idf2c7b2">dumpbinでインポート情報を確認</a></li>
<li><a href="#id906767">dumpbinで再配置情報を確認</a></li>
<li><a href="#id7a338f">dumpbinで逆アセンブラ結果と付き合わせてみる</a></li></ul></li>
<li><a href="#id77003a">DLLをロードするサンプル：C言語版 main.c</a></li>
<li><a href="#id8f73f6">DLLをロードするサンプル：Python版 main1.py(ctypesで自動ロード)</a></li>
<li><a href="#id39af82">DLLをロードするサンプル：Python版 main2.py(LoadLibrary(), GetProcAddress()で手動ロード)</a></li></ul></li>
<li><a href="#ide76cef">show_relocations.py : 再配置情報を表示するPythonスクリプト</a><ul><li><a href="#iddde123">show_relocations.py : ソース全体</a></li>
<li><a href="#id77c410">show_relocations.py : 解説</a></li>
<li><a href="#id187d5e">show_relocations.py : 実行例</a></li></ul></li>
<li><a href="#id742c3b">test_pseudo_load.py : メモリ上に展開した後、手動で再配置情報とIATを書き換えて実行可能にしてみる</a><ul><li><a href="#id55de25">test_pseudo_load.py : ソース全体</a></li>
<li><a href="#id4ee6b2">test_pseudo_load.py : 解説</a></li></ul></li>
<li><a href="#id799ea5">参考</a></li></ul>
<hr />
<h3 id="idb298ae">サンプルコード</h3>

<p class="paragraph">
今回は、特に再配置情報を操作するPythonスクリプトが巨大化した為、C言語のソースファイルと合わせてzipファイルにまとめた。
<br />
以下のURLからダウンロード出来る。
<br />
<a href="./../medias/manual_dll_relocation.zip" target="_blank" >./../medias/manual_dll_relocation.zip</a>
<br />
</p>

<ul><li> dlltest.c : 再配置情報で遊ぶ為のDLL</li>
<li> main.c : dlltest.dll動作確認用の簡単なEXE</li>
<li> main1.py : Pythonのctypesモジュールで簡単にdlltest.dllを利用出来ますよ～というサンプル</li>
<li> main2.py : ctypesモジュール経由でLoadLibrary() + GetProcAddress()で明示的にdlltest.dllをロードするサンプル</li>
<li> show_relocations.py : 再配置情報を表示するPythonスクリプト</li>
<li> test_pseudo_load.py : DLLを手動でメモリ上に展開し、再配置情報を更新し、インポート情報を基にIATを更新し、実行可能なメモリイメージとして構築するPythonスクリプト</li></ul>

<p class="paragraph">
show_relocations.py, test_pseudo_load.py の解説は後に回し、まずはdlltest.c, main.c, main1/2.py を紹介する。
<br />
</p>

<h4 id="id46ff00">DLL側：dlltest.c</h4>

<p class="paragraph">
再配置情報を弄って遊ぶためのDLLで、&quot;/NOENTRY&quot;を指定してCRTのエントリ関数を削り、余計なインポートや再配置情報を省いてみた。
<br />
dlltest.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">windows.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">__declspec</span><span class="hl-brackets">(</span><span class="hl-identifier">dllexport</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">funcA</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">a</span><span class="hl-code">, </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">b</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">MessageBox</span><span class="hl-brackets">(</span><span class="hl-identifier">GetDesktopWindow</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">funcA</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">captionA</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">MB_OK</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">a</span><span class="hl-code"> = </span><span class="hl-identifier">funcC</span><span class="hl-brackets">(</span><span class="hl-identifier">b</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">a</span><span class="hl-code"> + </span><span class="hl-identifier">b</span><span class="hl-code"> + </span><span class="hl-number">1</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">__declspec</span><span class="hl-brackets">(</span><span class="hl-identifier">dllexport</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">funcB</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">a</span><span class="hl-code">, </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">b</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">MessageBox</span><span class="hl-brackets">(</span><span class="hl-identifier">GetDesktopWindow</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">funcB</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">captionB</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">MB_OK</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">b</span><span class="hl-code"> = </span><span class="hl-identifier">funcC</span><span class="hl-brackets">(</span><span class="hl-identifier">a</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">a</span><span class="hl-code"> * </span><span class="hl-identifier">b</span><span class="hl-code"> + </span><span class="hl-number">1</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">funcC</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">c</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">c</span><span class="hl-code"> * </span><span class="hl-number">2</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
GetDesktopWindow(), MessageBox(), funcC()のアドレスが再配置の対象になると予想される。
<br />
</p>

<p class="paragraph">
ビルド：
<br />
</p>
<pre>&gt; cl /LD dlltest.c user32.lib /link /noentry
</pre>

<h5 id="idf2c7b2">dumpbinでインポート情報を確認</h5>

<pre class="plugin_pre">
&gt; dumpbin /imports dlltest.dll
...
    USER32.dll
              10002000 Import Address Table
              10002034 Import Name Table
                     0 time date stamp
                     0 Index of first forwarder reference

                  11C GetDesktopWindow
                  1F8 MessageBoxA
</pre>

<h5 id="id906767">dumpbinで再配置情報を確認</h5>

<pre class="plugin_pre">
&gt; dumpbin /relocations dlltest.dll
...
BASE RELOCATIONS #4
    1000 RVA,       18 SizeOfBlock
       6  HIGHLOW            10003000
       B  HIGHLOW            1000300C
      11  HIGHLOW            10002000
      18  HIGHLOW            10002004
      46  HIGHLOW            10003014
      4B  HIGHLOW            10003020
      51  HIGHLOW            10002000
      58  HIGHLOW            10002004
   # offset type             ファイル上の値
</pre>

<h5 id="id7a338f">dumpbinで逆アセンブラ結果と付き合わせてみる</h5>

<p class="paragraph">
再配置情報と付き合わせてみると、見事に各offsetとその値が逆アセンブラ結果と対応していることが分かる。
<br />
また、GetDesktopWindow()/MessageBoxA()がそれぞれ
<br />
</p>
<pre>call        dword ptr ds:[10002000h] # GetDesktopWindow()
call        dword ptr ds:[10002004h] # MessageBoxA()
</pre>
<p class="paragraph">
という命令になっているが、&quot;10002000h&quot;は丁度IATのアドレスを指すようになっている。PEヘッダー上のIATアドレスはRVAなのでローダが処理してくれるが、実行コード内のIATアドレスについては、再配置情報としてローダに処理して貰う。
<br />
</p>

<pre class="plugin_pre">
&gt; dumpbin /disasm dlltest.dll
...
  ## funcA()
  10001000: 55                 push        ebp
  10001001: 8B EC              mov         ebp,esp
  10001003: 6A 00              push        0
  ## -&gt; &quot;captionA&quot;
  10001005: 68 00 30 00 10     push        10003000h
  ## -&gt; &quot;funcA&quot;
  1000100A: 68 0C 30 00 10     push        1000300Ch
  ## -&gt; GetDesktopWindow()
  1000100F: FF 15 00 20 00 10  call        dword ptr ds:[10002000h]
  10001015: 50                 push        eax
  ## -&gt; MessageBoxA()
  10001016: FF 15 04 20 00 10  call        dword ptr ds:[10002004h]
  1000101C: 8B 45 0C           mov         eax,dword ptr [ebp+0Ch]
  1000101F: 50                 push        eax
  ## -&gt; funcC()
  10001020: E8 5B 00 00 00     call        10001080
  10001025: 83 C4 04           add         esp,4
  10001028: 89 45 08           mov         dword ptr [ebp+8],eax
  1000102B: 8B 4D 0C           mov         ecx,dword ptr [ebp+0Ch]
  1000102E: 8B 55 08           mov         edx,dword ptr [ebp+8]
  10001031: 8D 44 0A 01        lea         eax,[edx+ecx+1]
  10001035: 5D                 pop         ebp
  10001036: C3                 ret
...
  ## funcB()
  10001040: 55                 push        ebp
  10001041: 8B EC              mov         ebp,esp
  10001043: 6A 00              push        0
  ## -&gt; &quot;captionB&quot;
  10001045: 68 14 30 00 10     push        10003014h
  ## -&gt; &quot;funcB&quot;
  1000104A: 68 20 30 00 10     push        10003020h
  ## -&gt; GetDesktopWindow()
  1000104F: FF 15 00 20 00 10  call        dword ptr ds:[10002000h]
  10001055: 50                 push        eax
  ## -&gt; MessageBoxA()
  10001056: FF 15 04 20 00 10  call        dword ptr ds:[10002004h]
  1000105C: 8B 45 08           mov         eax,dword ptr [ebp+8]
  1000105F: 50                 push        eax
  ## -&gt; funcC()
  10001060: E8 1B 00 00 00     call        10001080
  10001065: 83 C4 04           add         esp,4
  10001068: 89 45 0C           mov         dword ptr [ebp+0Ch],eax
  1000106B: 8B 45 08           mov         eax,dword ptr [ebp+8]
  1000106E: 0F AF 45 0C        imul        eax,dword ptr [ebp+0Ch]
  10001072: 83 C0 01           add         eax,1
  10001075: 5D                 pop         ebp
  10001076: C3                 ret
...
  ## funcC()
  10001080: 55                 push        ebp
  10001081: 8B EC              mov         ebp,esp
  10001083: 8B 45 08           mov         eax,dword ptr [ebp+8]
  10001086: D1 E0              shl         eax,1
  10001088: 5D                 pop         ebp
  10001089: C3                 ret
</pre>

<h4 id="id77003a">DLLをロードするサンプル：C言語版 main.c</h4>

<p class="paragraph">
main.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">__declspec</span><span class="hl-brackets">(</span><span class="hl-identifier">dllimport</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">funcA</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">a</span><span class="hl-code">, </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">b</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">__declspec</span><span class="hl-brackets">(</span><span class="hl-identifier">dllimport</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">funcB</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">a</span><span class="hl-code">, </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">b</span><span class="hl-brackets">)</span><span class="hl-code">;
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">argc</span><span class="hl-code">, </span><span >char</span><span class="hl-code"> *</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">funcA(2, 3) = %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">funcA</span><span class="hl-brackets">(</span><span class="hl-number">2</span><span class="hl-code">, </span><span class="hl-number">3</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">funcB(2, 3) = %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">funcB</span><span class="hl-brackets">(</span><span class="hl-number">2</span><span class="hl-code">, </span><span class="hl-number">3</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
ビルド・実行：
<br />
</p>
<pre>&gt; cl main.c dlltest.lib
&gt; main.exe
(メッセージボックス表示)
funcA(2, 3) = 10
(メッセージボックス表示)
funcB(2, 3) = 9
</pre>

<h4 id="id8f73f6">DLLをロードするサンプル：Python版 main1.py(ctypesで自動ロード)</h4>

<p class="paragraph">
main1.py:
<br />
</p>
<div class="hl-main"><pre><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">ctypes</span><span class="hl-code">
</span><span class="hl-identifier">dlltest</span><span class="hl-code"> = </span><span class="hl-identifier">ctypes</span><span class="hl-code">.</span><span class="hl-identifier">cdll</span><span class="hl-code">.</span><span class="hl-identifier">dlltest</span><span class="hl-code">
</span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">funcA(2, 3) = %d</span><span class="hl-quotes">&quot;</span><span class="hl-code"> % </span><span class="hl-identifier">dlltest</span><span class="hl-code">.</span><span class="hl-identifier">funcA</span><span class="hl-brackets">(</span><span class="hl-number">2</span><span class="hl-code">, </span><span class="hl-number">3</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">funcB(2, 3) = %d</span><span class="hl-quotes">&quot;</span><span class="hl-code"> % </span><span class="hl-identifier">dlltest</span><span class="hl-code">.</span><span class="hl-identifier">funcB</span><span class="hl-brackets">(</span><span class="hl-number">2</span><span class="hl-code">, </span><span class="hl-number">3</span><span class="hl-brackets">)</span></pre></div>

<p class="paragraph">
実行：
<br />
</p>
<pre>&gt; python main1.py
(メッセージボックス表示)
funcA(2, 3) = 10
(メッセージボックス表示)
funcB(2, 3) = 9
</pre>

<h4 id="id39af82">DLLをロードするサンプル：Python版 main2.py(LoadLibrary(), GetProcAddress()で手動ロード)</h4>

<p class="paragraph">
main2.py:
<br />
</p>
<div class="hl-main"><pre><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">ctypes</span><span class="hl-code">
 
</span><span class="hl-comment"># LoadLibrary(), GetProcAddress()についてはctypes標準機能で自動ロード</span><span class="hl-code">
 
</span><span class="hl-identifier">hModule</span><span class="hl-code"> = </span><span class="hl-identifier">ctypes</span><span class="hl-code">.</span><span class="hl-identifier">windll</span><span class="hl-code">.</span><span class="hl-identifier">kernel32</span><span class="hl-code">.</span><span class="hl-identifier">LoadLibraryA</span><span class="hl-brackets">(</span><span class="hl-quotes">'</span><span class="hl-string">dlltest.dll</span><span class="hl-quotes">'</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">hModule = 0x%08X</span><span class="hl-quotes">&quot;</span><span class="hl-code"> % </span><span class="hl-identifier">hModule</span><span class="hl-code">
 
</span><span class="hl-identifier">addr_funcA</span><span class="hl-code"> = </span><span class="hl-identifier">ctypes</span><span class="hl-code">.</span><span class="hl-identifier">windll</span><span class="hl-code">.</span><span class="hl-identifier">kernel32</span><span class="hl-code">.</span><span class="hl-identifier">GetProcAddress</span><span class="hl-brackets">(</span><span class="hl-identifier">hModule</span><span class="hl-code">, </span><span class="hl-quotes">'</span><span class="hl-string">funcA</span><span class="hl-quotes">'</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">Address of 'funcA' = 0x%08X</span><span class="hl-quotes">&quot;</span><span class="hl-code"> % </span><span class="hl-identifier">addr_funcA</span><span class="hl-code">
 
</span><span class="hl-identifier">addr_funcB</span><span class="hl-code"> = </span><span class="hl-identifier">ctypes</span><span class="hl-code">.</span><span class="hl-identifier">windll</span><span class="hl-code">.</span><span class="hl-identifier">kernel32</span><span class="hl-code">.</span><span class="hl-identifier">GetProcAddress</span><span class="hl-brackets">(</span><span class="hl-identifier">hModule</span><span class="hl-code">, </span><span class="hl-quotes">'</span><span class="hl-string">funcB</span><span class="hl-quotes">'</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">Address of 'funcB' = 0x%08X</span><span class="hl-quotes">&quot;</span><span class="hl-code"> % </span><span class="hl-identifier">addr_funcB</span><span class="hl-code">
 
</span><span class="hl-comment"># アドレス値から関数を取得する為の下準備として、prototypeを作成する。</span><span class="hl-code">
</span><span class="hl-comment"># 今回はcdecl呼び出し規約の関数をインポートするので&quot;CFUNCTYPE&quot;を使う。</span><span class="hl-code">
</span><span class="hl-comment"># stdcallの場合は&quot;WINFUNCTYPE&quot;を使うことになる。</span><span class="hl-code">
</span><span class="hl-identifier">prototypes</span><span class="hl-code"> = {
    </span><span class="hl-quotes">'</span><span class="hl-string">funcA</span><span class="hl-quotes">'</span><span class="hl-code"> : </span><span class="hl-identifier">ctypes</span><span class="hl-code">.</span><span class="hl-identifier">CFUNCTYPE</span><span class="hl-brackets">(</span><span class="hl-identifier">ctypes</span><span class="hl-code">.</span><span class="hl-identifier">c_int</span><span class="hl-code">, </span><span class="hl-identifier">ctypes</span><span class="hl-code">.</span><span class="hl-identifier">c_int</span><span class="hl-code">, </span><span class="hl-identifier">ctypes</span><span class="hl-code">.</span><span class="hl-identifier">c_int</span><span class="hl-brackets">)</span><span class="hl-code">,
    </span><span class="hl-quotes">'</span><span class="hl-string">funcB</span><span class="hl-quotes">'</span><span class="hl-code"> : </span><span class="hl-identifier">ctypes</span><span class="hl-code">.</span><span class="hl-identifier">CFUNCTYPE</span><span class="hl-brackets">(</span><span class="hl-identifier">ctypes</span><span class="hl-code">.</span><span class="hl-identifier">c_int</span><span class="hl-code">, </span><span class="hl-identifier">ctypes</span><span class="hl-code">.</span><span class="hl-identifier">c_int</span><span class="hl-code">, </span><span class="hl-identifier">ctypes</span><span class="hl-code">.</span><span class="hl-identifier">c_int</span><span class="hl-brackets">)</span><span class="hl-code">,
    }
 
</span><span class="hl-comment"># prototypeとアドレスから、ctypesの関数インスタンスを作成する。</span><span class="hl-code">
</span><span class="hl-identifier">funcA</span><span class="hl-code"> = </span><span class="hl-identifier">prototypes</span><span class="hl-brackets">[</span><span class="hl-quotes">'</span><span class="hl-string">funcA</span><span class="hl-quotes">'</span><span class="hl-brackets">]</span><span class="hl-brackets">(</span><span class="hl-identifier">addr_funcA</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-identifier">funcB</span><span class="hl-code"> = </span><span class="hl-identifier">prototypes</span><span class="hl-brackets">[</span><span class="hl-quotes">'</span><span class="hl-string">funcB</span><span class="hl-quotes">'</span><span class="hl-brackets">]</span><span class="hl-brackets">(</span><span class="hl-identifier">addr_funcB</span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-comment"># 実際に呼んでみる</span><span class="hl-code">
</span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">funcA(2, 3) = %d</span><span class="hl-quotes">&quot;</span><span class="hl-code"> % </span><span class="hl-identifier">funcA</span><span class="hl-brackets">(</span><span class="hl-number">2</span><span class="hl-code">, </span><span class="hl-number">3</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">funcB(2, 3) = %d</span><span class="hl-quotes">&quot;</span><span class="hl-code"> % </span><span class="hl-identifier">funcB</span><span class="hl-brackets">(</span><span class="hl-number">2</span><span class="hl-code">, </span><span class="hl-number">3</span><span class="hl-brackets">)</span></pre></div>

<p class="paragraph">
実行：
<br />
</p>
<pre>&gt; pythonn main2.py
hModule = 0x10000000
Address of &#039;funcA&#039; = 0x10001000
Address of &#039;funcB&#039; = 0x10001040
(メッセージボックス表示)
funcA(2, 3) = 10
(メッセージボックス表示)
funcB(2, 3) = 9
</pre>

<h3 id="ide76cef">show_relocations.py : 再配置情報を表示するPythonスクリプト</h3>

<p class="paragraph">
IMAGE_OPTIONAL_HEADERのDataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC]はIMAGE_BASE_RELOCATION構造体の配列の先頭アドレスを指しているので、そこから辿ることが出来る。
<br />
一つのIMAGE_BASE_RELOCATION構造体の後ろには、実際に書き換えるアドレスの種別とOFFSETを記録したWORD配列が並んでいる。
<br />
WORD値の上位4bitが再配置のタイプ、下位12bitがOFFSETとなる。OFFSETはIMAGE_BASE_RELOCATION構造体のVirtualAddressからのOFFSETとなる。
<br />
</p>

<h4 id="iddde123">show_relocations.py : ソース全体</h4>

<p class="paragraph">
show_relocations.py: (ソース巨大化のため省略)
<br />
</p>

<h4 id="id77c410">show_relocations.py : 解説</h4>

<p class="paragraph">
途中までは <a href="./view-677.html" >日記/2010/06/10/PEファイルのDLL遅延ロード情報を表示するPython</a> と同じで、構造体の定義とメモリ上にヘッダーとセグメントをロードする。
<br />
</p>

<p class="paragraph">
再配置情報の取得は以下のコードから始まる：
<br />
</p>
<div class="hl-main"><pre><span class="hl-comment"># Base Relocations</span><span class="hl-code">
</span><span class="hl-identifier">br_entry</span><span class="hl-code"> = </span><span class="hl-identifier">opt_header</span><span class="hl-code">.</span><span class="hl-identifier">DataDirectory</span><span class="hl-brackets">[</span><span class="hl-identifier">IMAGE_DIRECTORY_ENTRY_BASERELOC</span><span class="hl-brackets">]</span><span class="hl-code">
</span><span class="hl-identifier">br_rva</span><span class="hl-code"> = </span><span class="hl-identifier">br_entry</span><span class="hl-code">.</span><span class="hl-identifier">VirtualAddress</span><span class="hl-code">
</span><span class="hl-identifier">br_head</span><span class="hl-code"> = </span><span class="hl-identifier">image_buf_ptr</span><span class="hl-code"> + </span><span class="hl-identifier">br_rva</span><span class="hl-code">
</span><span class="hl-identifier">br_tail</span><span class="hl-code"> = </span><span class="hl-identifier">br_head</span><span class="hl-code"> + </span><span class="hl-identifier">br_entry</span><span class="hl-code">.</span><span class="hl-identifier">Size</span><span class="hl-code">
 
</span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code"> == </span><span class="hl-identifier">br_rva</span><span class="hl-code">:
  </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">NO BASE RELOCATIONS</span><span class="hl-quotes">&quot;</span><span class="hl-code">
  </span><span class="hl-identifier">quit</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span></pre></div>
<p class="paragraph">
br_tailでわざわざ再配置情報のメモリブロック終端アドレスを保存しているのは、ループ脱出条件に使う為。IMAGE_BASE_RELOCATION構造体には要素数を保持するメンバが無い為、br_tailと比べることでループ脱出を判定している。
<br />
EXEなど再配置情報が存在しない場合は、メッセージを表示して終了。
<br />
</p>

<p class="paragraph">
続くコードで、IMAGE_BASE_RELOCATION構造体の配列を順次取得していく：
<br />
</p>
<div class="hl-main"><pre><span class="hl-identifier">br_sz</span><span class="hl-code"> = </span><span class="hl-identifier">ctypes</span><span class="hl-code">.</span><span class="hl-identifier">sizeof</span><span class="hl-brackets">(</span><span class="hl-identifier">IMAGE_BASE_RELOCATION</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-identifier">br_type_sz</span><span class="hl-code"> = </span><span class="hl-identifier">ctypes</span><span class="hl-code">.</span><span class="hl-identifier">sizeof</span><span class="hl-brackets">(</span><span class="hl-identifier">WORD</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-identifier">offset</span><span class="hl-code"> = </span><span class="hl-identifier">br_head</span><span class="hl-code">
</span><span class="hl-identifier">brs</span><span class="hl-code"> = </span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-code">
</span><span class="hl-reserved">while</span><span class="hl-code"> </span><span class="hl-number">1</span><span class="hl-code">:
  </span><span class="hl-identifier">br</span><span class="hl-code"> = </span><span class="hl-identifier">IMAGE_BASE_RELOCATION</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">
  </span><span class="hl-identifier">ctypes</span><span class="hl-code">.</span><span class="hl-identifier">memmove</span><span class="hl-brackets">(</span><span class="hl-code">
      </span><span class="hl-identifier">ctypes</span><span class="hl-code">.</span><span class="hl-identifier">addressof</span><span class="hl-brackets">(</span><span class="hl-identifier">br</span><span class="hl-brackets">)</span><span class="hl-code">,
      </span><span class="hl-identifier">offset</span><span class="hl-code">,
      </span><span class="hl-identifier">br_sz</span><span class="hl-brackets">)</span><span class="hl-code">
  </span><span class="hl-identifier">br</span><span class="hl-code">.</span><span class="hl-identifier">types</span><span class="hl-code"> = </span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-code">
  </span><span class="hl-identifier">offset</span><span class="hl-code"> = </span><span class="hl-identifier">offset</span><span class="hl-code"> + </span><span class="hl-identifier">br_sz</span></pre></div>
<p class="paragraph">
次のコードは、IMAGE_BASE_RELOCATION構造体のSizeOfBlockメンバを元に、WORD配列の要素数を逆算している：
<br />
</p>
<pre> br_types_num = (br.SizeOfBlock - br_sz) / br_type_sz
</pre>
<p class="paragraph">
SizeOfBlockはWORD配列のサイズ + IMAGE_BASE_RELOCATION構造体自身のサイズになっているため、自分自身を引いた後、WORD型のサイズで割れば配列のよう素数が得られる。
<br />
以降、要素数を元にWORD配列を取得する：
<br />
</p>
<div class="hl-main"><pre><span class="hl-reserved">for</span><span class="hl-code"> </span><span class="hl-identifier">i</span><span class="hl-code"> </span><span class="hl-reserved">in</span><span class="hl-code"> </span><span class="hl-builtin">xrange</span><span class="hl-brackets">(</span><span class="hl-identifier">br_types_num</span><span class="hl-brackets">)</span><span class="hl-code">:
    </span><span class="hl-identifier">br_type</span><span class="hl-code"> = </span><span class="hl-identifier">WORD</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-identifier">ctypes</span><span class="hl-code">.</span><span class="hl-identifier">memmove</span><span class="hl-brackets">(</span><span class="hl-code">
        </span><span class="hl-identifier">ctypes</span><span class="hl-code">.</span><span class="hl-identifier">addressof</span><span class="hl-brackets">(</span><span class="hl-identifier">br_type</span><span class="hl-brackets">)</span><span class="hl-code">,
        </span><span class="hl-identifier">offset</span><span class="hl-code">,
        </span><span class="hl-identifier">br_type_sz</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-identifier">offset</span><span class="hl-code"> = </span><span class="hl-identifier">offset</span><span class="hl-code"> + </span><span class="hl-identifier">br_type_sz</span><span class="hl-code">
    </span><span class="hl-identifier">br</span><span class="hl-code">.</span><span class="hl-identifier">types</span><span class="hl-code">.</span><span class="hl-identifier">append</span><span class="hl-brackets">(</span><span class="hl-identifier">br_type</span><span class="hl-brackets">)</span><span class="hl-code">
  </span><span class="hl-identifier">brs</span><span class="hl-code">.</span><span class="hl-identifier">append</span><span class="hl-brackets">(</span><span class="hl-identifier">br</span><span class="hl-brackets">)</span><span class="hl-code">
  </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-identifier">offset</span><span class="hl-code"> + </span><span class="hl-number">1</span><span class="hl-code"> &gt; </span><span class="hl-identifier">br_tail</span><span class="hl-code">:
    </span><span class="hl-reserved">break</span></pre></div>

<p class="paragraph">
以下は取得出来たIMAGE_BASE_RELOCATION構造体の内容を出力する：
<br />
</p>
<div class="hl-main"><pre><span class="hl-reserved">for</span><span class="hl-code"> </span><span class="hl-identifier">br</span><span class="hl-code"> </span><span class="hl-reserved">in</span><span class="hl-code"> </span><span class="hl-identifier">brs</span><span class="hl-code">:
  </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">-----------------</span><span class="hl-quotes">&quot;</span><span class="hl-code">
  </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">VirtualAddress = 0x%08X</span><span class="hl-quotes">&quot;</span><span class="hl-code"> % </span><span class="hl-identifier">br</span><span class="hl-code">.</span><span class="hl-identifier">VirtualAddress</span><span class="hl-code">
  </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">SizeOfBlock = 0x%08X</span><span class="hl-quotes">&quot;</span><span class="hl-code"> % </span><span class="hl-identifier">br</span><span class="hl-code">.</span><span class="hl-identifier">SizeOfBlock</span><span class="hl-code">
  </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">[TYPE],</span><span class="hl-special">\t</span><span class="hl-string">[OFFSET],</span><span class="hl-special">\t</span><span class="hl-string">[FILE VALUE]</span><span class="hl-quotes">&quot;</span><span class="hl-code">
  </span><span class="hl-reserved">for</span><span class="hl-code"> </span><span class="hl-identifier">br_type</span><span class="hl-code"> </span><span class="hl-reserved">in</span><span class="hl-code"> </span><span class="hl-identifier">br</span><span class="hl-code">.</span><span class="hl-identifier">types</span><span class="hl-code">:
    </span><span class="hl-comment"># 上位4bit</span><span class="hl-code">
    </span><span class="hl-identifier">rel_base_type</span><span class="hl-code"> = </span><span class="hl-brackets">(</span><span class="hl-number">0</span><span class="hl-identifier">xF000</span><span class="hl-code"> &amp; </span><span class="hl-identifier">br_type</span><span class="hl-code">.</span><span class="hl-identifier">value</span><span class="hl-brackets">)</span><span class="hl-code"> &gt;&gt; </span><span class="hl-number">12</span><span class="hl-code">
    </span><span class="hl-comment"># 下位12bit</span><span class="hl-code">
    </span><span class="hl-identifier">rel_base_offset</span><span class="hl-code"> = </span><span class="hl-number">0</span><span class="hl-identifier">xFFF</span><span class="hl-code"> &amp; </span><span class="hl-identifier">br_type</span><span class="hl-code">.</span><span class="hl-identifier">value</span><span class="hl-code">
    </span><span class="hl-comment"># 実際にファイルに書き込まれている値を取得</span><span class="hl-code">
    </span><span class="hl-identifier">file_value</span><span class="hl-code"> = </span><span class="hl-identifier">DWORD</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-identifier">ctypes</span><span class="hl-code">.</span><span class="hl-identifier">memmove</span><span class="hl-brackets">(</span><span class="hl-code">
        </span><span class="hl-identifier">ctypes</span><span class="hl-code">.</span><span class="hl-identifier">addressof</span><span class="hl-brackets">(</span><span class="hl-identifier">file_value</span><span class="hl-brackets">)</span><span class="hl-code">,
        </span><span class="hl-identifier">image_buf_ptr</span><span class="hl-code"> + </span><span class="hl-identifier">br</span><span class="hl-code">.</span><span class="hl-identifier">VirtualAddress</span><span class="hl-code"> + </span><span class="hl-identifier">rel_base_offset</span><span class="hl-code">,
        </span><span class="hl-identifier">ctypes</span><span class="hl-code">.</span><span class="hl-identifier">sizeof</span><span class="hl-brackets">(</span><span class="hl-identifier">DWORD</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">%s,</span><span class="hl-special">\t</span><span class="hl-string">%X h,</span><span class="hl-special">\t</span><span class="hl-string">%X</span><span class="hl-quotes">&quot;</span><span class="hl-code"> % </span><span class="hl-brackets">(</span><span class="hl-code">
        </span><span class="hl-identifier">IMAGE_REL_BAESD_TYPES</span><span class="hl-brackets">[</span><span class="hl-identifier">rel_base_type</span><span class="hl-brackets">]</span><span class="hl-code">, 
        </span><span class="hl-identifier">rel_base_offset</span><span class="hl-code">,
        </span><span class="hl-identifier">file_value</span><span class="hl-code">.</span><span class="hl-identifier">value</span><span class="hl-code">
        </span><span class="hl-brackets">)</span></pre></div>

<h4 id="id187d5e">show_relocations.py : 実行例</h4>

<pre class="plugin_pre">
&gt; show_relocations.py dlltest.dll
-----------------
VirtualAddress = 0x00001000
SizeOfBlock = 0x00000018
        [TYPE], [OFFSET],       [FILE VALUE]
        HIGHLOW,        6 h,    10003000
        HIGHLOW,        B h,    1000300C
        HIGHLOW,        11 h,   10002000
        HIGHLOW,        18 h,   10002004
        HIGHLOW,        46 h,   10003014
        HIGHLOW,        4B h,   10003020
        HIGHLOW,        51 h,   10002000
        HIGHLOW,        58 h,   10002004
</pre>

<p class="paragraph">
dumpbin:
<br />
</p>
<pre class="plugin_pre">
&gt; dumpbin /relocations dlltest.dll
...
BASE RELOCATIONS #4
    1000 RVA,       18 SizeOfBlock
       6  HIGHLOW            10003000
       B  HIGHLOW            1000300C
      11  HIGHLOW            10002000
      18  HIGHLOW            10002004
      46  HIGHLOW            10003014
      4B  HIGHLOW            10003020
      51  HIGHLOW            10002000
      58  HIGHLOW            10002004
</pre>

<p class="paragraph">
dumpbinと同様に再配置情報を取得出来ている。
<br />
</p>

<h3 id="id742c3b">test_pseudo_load.py : メモリ上に展開した後、手動で再配置情報とIATを書き換えて実行可能にしてみる</h3>

<p class="paragraph">
つまり、OSのローダがしている処理を自前で実装してみる実験。
<br />
簡単にするため、以下のように機能をそぎ落としている。
<br />
</p>
<ul><li> DLLしかロードしない</li>
<li> 序数でエクスポートしているシンボルは無視</li>
<li> 序数でインポートしているシンボルも無視</li>
<li> インポートで転送しているのが見つかっても無視</li>
<li> 事前バインドも無視</li>
<li> 遅延ロードは考慮しない</li></ul>

<p class="paragraph">
とりあえず今回のdlltest.dllをロードし、funcA(), funcB()を実行するにはこれでも問題ない。
<br />
</p>

<h4 id="id55de25">test_pseudo_load.py : ソース全体</h4>

<p class="paragraph">
test_pseudo_load.py: (ソース巨大化のため省略)
<br />
</p>

<h4 id="id4ee6b2">test_pseudo_load.py : 解説</h4>

<p class="paragraph">
クラス定義に加え、インポート情報/エクスポート情報/再配置情報それぞれの構築とダンプ表示、再配置情報とIATの更新を関数にまとめた。
<br />
本体の、実験の要となる処理について見ていく。
<br />
</p>

<p class="paragraph">
まず、ファイルイメージをロードするメモリ領域を VirtualAlloc() を使って読み書き・実行可能なページに確保するようにしている。
<br />
これまでの実験ではctypesのcreate_string_buffer()で確保していたが、それだと実行可能なページには確保されない。
<br />
</p>
<div class="hl-main"><pre><span class="hl-comment"># {{{ load to memory</span><span class="hl-code">
</span><span class="hl-identifier">f</span><span class="hl-code">.</span><span class="hl-identifier">seek</span><span class="hl-brackets">(</span><span class="hl-number">0</span><span class="hl-code">, </span><span class="hl-number">0</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-identifier">file_bytes</span><span class="hl-code"> = </span><span class="hl-identifier">f</span><span class="hl-code">.</span><span class="hl-identifier">read</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-comment"># read all file contents</span><span class="hl-code">
</span><span class="hl-identifier">MEM_COMMIT</span><span class="hl-code"> = </span><span class="hl-number">0</span><span class="hl-identifier">x1000</span><span class="hl-code">
</span><span class="hl-identifier">PAGE_EXECUTE_READWRITE</span><span class="hl-code"> = </span><span class="hl-number">0</span><span class="hl-identifier">x40</span><span class="hl-code"> </span><span class="hl-comment"># WinXP SP2 や Win2k 等では無効かも。MSDNを確認して下さい。</span><span class="hl-code">
 
</span><span class="hl-identifier">image_buf_ptr</span><span class="hl-code"> = </span><span class="hl-identifier">ctypes</span><span class="hl-code">.</span><span class="hl-identifier">windll</span><span class="hl-code">.</span><span class="hl-identifier">kernel32</span><span class="hl-code">.</span><span class="hl-identifier">VirtualAlloc</span><span class="hl-brackets">(</span><span class="hl-code">
    </span><span class="hl-reserved">None</span><span class="hl-code">,
    </span><span class="hl-identifier">opt_header</span><span class="hl-code">.</span><span class="hl-identifier">SizeOfImage</span><span class="hl-code">,
    </span><span class="hl-identifier">MEM_COMMIT</span><span class="hl-code">,
    </span><span class="hl-identifier">PAGE_EXECUTE_READWRITE</span><span class="hl-code">
    </span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-comment"># copy headers</span><span class="hl-code">
</span><span class="hl-identifier">ctypes</span><span class="hl-code">.</span><span class="hl-identifier">memmove</span><span class="hl-brackets">(</span><span class="hl-code">
    </span><span class="hl-identifier">image_buf_ptr</span><span class="hl-code">, 
    </span><span class="hl-identifier">file_bytes</span><span class="hl-code">,
    </span><span class="hl-identifier">opt_header</span><span class="hl-code">.</span><span class="hl-identifier">SizeOfHeaders</span><span class="hl-code">
    </span><span class="hl-brackets">)</span></pre></div>

<p class="paragraph">
続いて再配置情報を取得・表示する。
<br />
</p>
<div class="hl-main"><pre><span class="hl-identifier">base_relocations</span><span class="hl-code"> = </span><span class="hl-identifier">build_base_relocations</span><span class="hl-brackets">(</span><span class="hl-identifier">opt_header</span><span class="hl-code">, </span><span class="hl-identifier">image_buf_ptr</span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code"> == </span><span class="hl-builtin">len</span><span class="hl-brackets">(</span><span class="hl-identifier">base_relocations</span><span class="hl-brackets">)</span><span class="hl-code">:
  </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">NO BASE RELOCATIONS</span><span class="hl-quotes">&quot;</span><span class="hl-code">
  </span><span class="hl-identifier">quit</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">-------[ RELOCATION INFO : BEFORE RELOCATION ]-------</span><span class="hl-quotes">&quot;</span><span class="hl-code">
</span><span class="hl-identifier">dump_base_relocations</span><span class="hl-brackets">(</span><span class="hl-identifier">base_relocations</span><span class="hl-code">, </span><span class="hl-identifier">image_buf_ptr</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">-----------------------------------------------------</span><span class="hl-quotes">&quot;</span><span class="hl-code">
</span><span class="hl-reserved">print</span></pre></div>

<p class="paragraph">
その後、ヘッダー上のImageBaseと実際にロードされた先頭アドレスの差分を取得し、再配置情報を更新する。
<br />
</p>
<div class="hl-main"><pre><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">File ImageBase = 0x%08X</span><span class="hl-quotes">&quot;</span><span class="hl-code"> % </span><span class="hl-identifier">opt_header</span><span class="hl-code">.</span><span class="hl-identifier">ImageBase</span><span class="hl-code">
</span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">Real ImageBase = 0x%08X</span><span class="hl-quotes">&quot;</span><span class="hl-code"> % </span><span class="hl-identifier">image_buf_ptr</span><span class="hl-code">
</span><span class="hl-identifier">diff</span><span class="hl-code"> = </span><span class="hl-identifier">image_buf_ptr</span><span class="hl-code"> - </span><span class="hl-identifier">opt_header</span><span class="hl-code">.</span><span class="hl-identifier">ImageBase</span><span class="hl-code">
</span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">Differencial = 0x%08X</span><span class="hl-quotes">&quot;</span><span class="hl-code"> % </span><span class="hl-identifier">diff</span><span class="hl-code">
</span><span class="hl-reserved">print</span><span class="hl-code">
 
</span><span class="hl-identifier">relocate_base_relocations</span><span class="hl-brackets">(</span><span class="hl-identifier">base_relocations</span><span class="hl-code">, </span><span class="hl-identifier">image_buf_ptr</span><span class="hl-code">, </span><span class="hl-identifier">diff</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-builtin">raw_input</span><span class="hl-brackets">(</span><span class="hl-quotes">'</span><span class="hl-string">Pausing ... Hit Return for Continue :</span><span class="hl-quotes">'</span><span class="hl-brackets">)</span></pre></div>
<p class="paragraph">
ここまでの実行結果：
<br />
</p>
<pre class="plugin_pre">
&gt; test_pseudo_load.py dlltest.dll
-------[ RELOCATION INFO : BEFORE RELOCATION ]-------
-----------------
VirtualAddress = 0x00001000
SizeOfBlock = 0x00000018
        [TYPE], [OFFSET],       [FILE VALUE]
        HIGHLOW,        6 h,    10003000
        HIGHLOW,        B h,    1000300C
        HIGHLOW,        11 h,   10002000
        HIGHLOW,        18 h,   10002004
        HIGHLOW,        46 h,   10003014
        HIGHLOW,        4B h,   10003020
        HIGHLOW,        51 h,   10002000
        HIGHLOW,        58 h,   10002004
-----------------------------------------------------

File ImageBase = 0x10000000
Real ImageBase = 0x00A00000
Differencial = 0x-F600000

Pausing ... Hit Return for Continue :
</pre>
<p class="paragraph">
ENTERキーを押せば、更新された再配置情報を表示する。
<br />
</p>
<div class="hl-main"><pre><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">-------[ RELOCATION INFO : AFTER RELOCATION ]-------</span><span class="hl-quotes">&quot;</span><span class="hl-code">
</span><span class="hl-identifier">dump_base_relocations</span><span class="hl-brackets">(</span><span class="hl-identifier">base_relocations</span><span class="hl-code">, </span><span class="hl-identifier">image_buf_ptr</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">----------------------------------------------------</span><span class="hl-quotes">&quot;</span><span class="hl-code">
</span><span class="hl-reserved">print</span></pre></div>
<p class="paragraph">
実行結果を見ると、実際にアドレスが調整されたことを確認出来る：
<br />
</p>
<pre class="plugin_pre">
-------[ RELOCATION INFO : AFTER RELOCATION ]-------
-----------------
VirtualAddress = 0x00001000
SizeOfBlock = 0x00000018
        [TYPE], [OFFSET],       [FILE VALUE]
        HIGHLOW,        6 h,    A03000
        HIGHLOW,        B h,    A0300C
        HIGHLOW,        11 h,   A02000
        HIGHLOW,        18 h,   A02004
        HIGHLOW,        46 h,   A03014
        HIGHLOW,        4B h,   A03020
        HIGHLOW,        51 h,   A02000
        HIGHLOW,        58 h,   A02004
----------------------------------------------------
</pre>
<p class="paragraph">
続いてインポート情報をダンプし、表示する。
<br />
</p>
<div class="hl-main"><pre><span class="hl-identifier">ids1</span><span class="hl-code"> = </span><span class="hl-identifier">build_import_descriptors</span><span class="hl-brackets">(</span><span class="hl-identifier">opt_header</span><span class="hl-code">, </span><span class="hl-identifier">image_buf_ptr</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">-------[ IMPORT INFO : BEFORE IMPORTING ]-------</span><span class="hl-quotes">&quot;</span><span class="hl-code">
</span><span class="hl-identifier">dump_import_descriptors</span><span class="hl-brackets">(</span><span class="hl-identifier">ids1</span><span class="hl-code">, </span><span class="hl-identifier">image_buf_ptr</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">------------------------------------------------</span><span class="hl-quotes">&quot;</span><span class="hl-code">
</span><span class="hl-reserved">print</span></pre></div>
<p class="paragraph">
この時点でのダンプ表示：
<br />
</p>
<pre class="plugin_pre">
-------[ IMPORT INFO : BEFORE IMPORTING ]-------
[USER32.dll]
FirstThunk: 0000204E
        (Original VirtualAddress = 00A02000)
FirstThunk: 00002040
        (Original VirtualAddress = 00A02004)
OriginalFirstThunk: 0000204E
        (Original VirtualAddress = 00A02034)
        Hint: 011C
        Name: GetDesktopWindow
OriginalFirstThunk: 00002040
        (Original VirtualAddress = 00A02038)
        Hint: 01F8
        Name: MessageBoxA
------------------------------------------------
</pre>
<p class="paragraph">
実際にインポート情報を基にアドレス解決を行い、IATを書き換えた後の情報を表示する。
<br />
</p>
<div class="hl-main"><pre><span class="hl-identifier">import_dlls</span><span class="hl-brackets">(</span><span class="hl-identifier">ids1</span><span class="hl-code">, </span><span class="hl-identifier">image_buf_ptr</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-builtin">raw_input</span><span class="hl-brackets">(</span><span class="hl-quotes">'</span><span class="hl-string">Pausing ... Hit Return for Continue :</span><span class="hl-quotes">'</span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-identifier">ids2</span><span class="hl-code"> = </span><span class="hl-identifier">build_import_descriptors</span><span class="hl-brackets">(</span><span class="hl-identifier">opt_header</span><span class="hl-code">, </span><span class="hl-identifier">image_buf_ptr</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">-------[ IMPORT INFO : AFTER IMPORTING ]-------</span><span class="hl-quotes">&quot;</span><span class="hl-code">
</span><span class="hl-identifier">dump_import_descriptors</span><span class="hl-brackets">(</span><span class="hl-identifier">ids2</span><span class="hl-code">, </span><span class="hl-identifier">image_buf_ptr</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">-----------------------------------------------</span><span class="hl-quotes">&quot;</span><span class="hl-code">
</span><span class="hl-reserved">print</span></pre></div>

<p class="paragraph">
実行結果を見ると、FirstThunk(=IAT)の内容が実際のアドレスに変更されていることを確認出来る：
<br />
</p>
<pre class="plugin_pre">
Pausing ... Hit Return for Continue :(ENTERキーを押す)
-------[ IMPORT INFO : AFTER IMPORTING ]-------
[USER32.dll]
FirstThunk: 77D0D1D2
        (Original VirtualAddress = 00A02000)
FirstThunk: 77D307EA
        (Original VirtualAddress = 00A02004)
OriginalFirstThunk: 0000204E
        (Original VirtualAddress = 00A02034)
        Hint: 011C
        Name: GetDesktopWindow
OriginalFirstThunk: 00002040
        (Original VirtualAddress = 00A02038)
        Hint: 01F8
        Name: MessageBoxA
-----------------------------------------------
</pre>

<p class="paragraph">
最後にロードしたDLL自身のエクスポート情報をダンプ表示する：
<br />
</p>
<div class="hl-main"><pre><span class="hl-identifier">export_directory</span><span class="hl-code"> = </span><span class="hl-identifier">build_export_directory</span><span class="hl-brackets">(</span><span class="hl-code">
    </span><span class="hl-identifier">opt_header</span><span class="hl-code">, </span><span class="hl-identifier">section_headers</span><span class="hl-code">, </span><span class="hl-identifier">image_buf_ptr</span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">-------[ EXPORT INFO ]-------</span><span class="hl-quotes">&quot;</span><span class="hl-code">
</span><span class="hl-identifier">dump_export_directory</span><span class="hl-brackets">(</span><span class="hl-identifier">export_directory</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">-----------------------------</span><span class="hl-quotes">&quot;</span><span class="hl-code">
</span><span class="hl-reserved">print</span><span class="hl-code">
</span><span class="hl-builtin">raw_input</span><span class="hl-brackets">(</span><span class="hl-quotes">'</span><span class="hl-string">O.K, Here we go ... Hit Return for Continue :</span><span class="hl-quotes">'</span><span class="hl-brackets">)</span></pre></div>
<p class="paragraph">
実際のダンプ表示：
<br />
</p>
<pre class="plugin_pre">
-------[ EXPORT INFO ]-------
&gt;&gt;&gt; IMAGE_EXPORT_DIRECTORY &lt;&lt;&lt;
Characteristics = 0000
TimeDateStamp = 4C108036
MajorVersion = 00
MinorVersion = 00
Name = dlltest.dll [RVA=20AC]
Base = 0001
NumberOfFunctions = 0002
NumberOfNames = 0002
AddressOfFunctions RVA = 2098
AddressOfNames RVA = 20A0
AddressOfNameOrdinals RVA = 20A8
-----------------
Functions:
        Function[0] RVA = 00001000
        Function[1] RVA = 00001040
-----------------
Names:
        Name[0] = funcA
        Name[1] = funcB
-----------------
Ordinals:
        Ordinal[0] = 0
        Ordinal[1] = 1
-----------------------------

O.K, Here we go ... Hit Return for Continue :
</pre>

<p class="paragraph">
この時点で、手動で展開したメモリイメージの実行準備が整った。
<br />
funcA, funcBのアドレスをエクスポート情報から取得してみる：
<br />
</p>
<div class="hl-main"><pre><span class="hl-identifier">addr_funcA</span><span class="hl-code"> = </span><span class="hl-identifier">image_buf_ptr</span><span class="hl-code"> + </span><span class="hl-identifier">get_export_address</span><span class="hl-brackets">(</span><span class="hl-identifier">export_directory</span><span class="hl-code">, </span><span class="hl-quotes">'</span><span class="hl-string">funcA</span><span class="hl-quotes">'</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">funcA = %08X</span><span class="hl-quotes">&quot;</span><span class="hl-code"> % </span><span class="hl-identifier">addr_funcA</span><span class="hl-code">
</span><span class="hl-identifier">addr_funcB</span><span class="hl-code"> = </span><span class="hl-identifier">image_buf_ptr</span><span class="hl-code"> + </span><span class="hl-identifier">get_export_address</span><span class="hl-brackets">(</span><span class="hl-identifier">export_directory</span><span class="hl-code">, </span><span class="hl-quotes">'</span><span class="hl-string">funcB</span><span class="hl-quotes">'</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">funcB = %08X</span><span class="hl-quotes">&quot;</span><span class="hl-code"> % </span><span class="hl-identifier">addr_funcB</span></pre></div>

<p class="paragraph">
get_export_address()は次のようになっており、エクスポート名→序数→アドレスへの変換を行う：
<br />
</p>
<div class="hl-main"><pre><span class="hl-reserved">def</span><span class="hl-code"> </span><span class="hl-identifier">get_export_address</span><span class="hl-brackets">(</span><span class="hl-identifier">d</span><span class="hl-code">, </span><span class="hl-identifier">name</span><span class="hl-brackets">)</span><span class="hl-code">:
 
  </span><span class="hl-comment"># 名前 → 序数テーブル上のインデックス番号</span><span class="hl-code">
  </span><span class="hl-identifier">i</span><span class="hl-code"> = </span><span class="hl-number">0</span><span class="hl-code">
  </span><span class="hl-identifier">found</span><span class="hl-code"> = </span><span class="hl-reserved">False</span><span class="hl-code">
  </span><span class="hl-reserved">for</span><span class="hl-code"> </span><span class="hl-identifier">v</span><span class="hl-code"> </span><span class="hl-reserved">in</span><span class="hl-code"> </span><span class="hl-identifier">d</span><span class="hl-code">.</span><span class="hl-identifier">_Names_</span><span class="hl-code">:
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-identifier">v</span><span class="hl-code"> == </span><span class="hl-identifier">name</span><span class="hl-code">:
      </span><span class="hl-identifier">found</span><span class="hl-code"> = </span><span class="hl-reserved">True</span><span class="hl-code">
      </span><span class="hl-reserved">break</span><span class="hl-code">
    </span><span class="hl-identifier">i</span><span class="hl-code"> = </span><span class="hl-identifier">i</span><span class="hl-code"> + </span><span class="hl-number">1</span><span class="hl-code">
 
  </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-reserved">not</span><span class="hl-code"> </span><span class="hl-identifier">found</span><span class="hl-code">:
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">
 
  </span><span class="hl-comment"># 序数テーブル上のインデックス番号 → 序数</span><span class="hl-code">
  </span><span class="hl-identifier">o</span><span class="hl-code"> = </span><span class="hl-identifier">d</span><span class="hl-code">.</span><span class="hl-identifier">_Ordinals_</span><span class="hl-brackets">[</span><span class="hl-identifier">i</span><span class="hl-brackets">]</span><span class="hl-code">
 
  </span><span class="hl-comment"># 序数 = EAT上のインデックス番号 → 関数アドレス</span><span class="hl-code">
  </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">d</span><span class="hl-code">.</span><span class="hl-identifier">_Functions_</span><span class="hl-brackets">[</span><span class="hl-identifier">o</span><span class="hl-brackets">]</span></pre></div>

<p class="paragraph">
以降は main2.py と同様にCFUNCTYPEでプロトタイプを用意し、取得したアドレス値を使ってctypesの関数オブジェクトを作成し、呼ぶ。
<br />
</p>
<div class="hl-main"><pre><span class="hl-identifier">prototypes</span><span class="hl-code"> = {
    </span><span class="hl-quotes">'</span><span class="hl-string">funcA</span><span class="hl-quotes">'</span><span class="hl-code"> : </span><span class="hl-identifier">ctypes</span><span class="hl-code">.</span><span class="hl-identifier">CFUNCTYPE</span><span class="hl-brackets">(</span><span class="hl-identifier">ctypes</span><span class="hl-code">.</span><span class="hl-identifier">c_int</span><span class="hl-code">, </span><span class="hl-identifier">ctypes</span><span class="hl-code">.</span><span class="hl-identifier">c_int</span><span class="hl-code">, </span><span class="hl-identifier">ctypes</span><span class="hl-code">.</span><span class="hl-identifier">c_int</span><span class="hl-brackets">)</span><span class="hl-code">,
    </span><span class="hl-quotes">'</span><span class="hl-string">funcB</span><span class="hl-quotes">'</span><span class="hl-code"> : </span><span class="hl-identifier">ctypes</span><span class="hl-code">.</span><span class="hl-identifier">CFUNCTYPE</span><span class="hl-brackets">(</span><span class="hl-identifier">ctypes</span><span class="hl-code">.</span><span class="hl-identifier">c_int</span><span class="hl-code">, </span><span class="hl-identifier">ctypes</span><span class="hl-code">.</span><span class="hl-identifier">c_int</span><span class="hl-code">, </span><span class="hl-identifier">ctypes</span><span class="hl-code">.</span><span class="hl-identifier">c_int</span><span class="hl-brackets">)</span><span class="hl-code">,
    }
 
</span><span class="hl-identifier">funcA</span><span class="hl-code"> = </span><span class="hl-identifier">prototypes</span><span class="hl-brackets">[</span><span class="hl-quotes">'</span><span class="hl-string">funcA</span><span class="hl-quotes">'</span><span class="hl-brackets">]</span><span class="hl-brackets">(</span><span class="hl-identifier">addr_funcA</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-identifier">funcB</span><span class="hl-code"> = </span><span class="hl-identifier">prototypes</span><span class="hl-brackets">[</span><span class="hl-quotes">'</span><span class="hl-string">funcB</span><span class="hl-quotes">'</span><span class="hl-brackets">]</span><span class="hl-brackets">(</span><span class="hl-identifier">addr_funcB</span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">funcA(2, 3) = %d</span><span class="hl-quotes">&quot;</span><span class="hl-code"> % </span><span class="hl-identifier">funcA</span><span class="hl-brackets">(</span><span class="hl-number">2</span><span class="hl-code">, </span><span class="hl-number">3</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">funcB(2, 3) = %d</span><span class="hl-quotes">&quot;</span><span class="hl-code"> % </span><span class="hl-identifier">funcB</span><span class="hl-brackets">(</span><span class="hl-number">2</span><span class="hl-code">, </span><span class="hl-number">3</span><span class="hl-brackets">)</span></pre></div>

<p class="paragraph">
実行結果：
<br />
</p>
<pre class="plugin_pre">
O.K, Here we go ... Hit Return for Continue : (ENTERを押す)
funcA = 00A01000
funcB = 00A01040
(メッセージボックス表示)
funcA(2, 3) = 10
(メッセージボックス表示)
funcB(2, 3) = 9
</pre>

<p class="paragraph">
以上、PythonスクリプトによるDLLの手動ロードと実行を簡単なサンプルで確認出来た。
<br />
</p>

<h3 id="id799ea5">参考</h3>

<ul><li> アレ用の何か : PEファイルフォーマット その5 ～ ベース再配置情報 ～<ul><li> <a class="externallink" href="http://hp.vector.co.jp/authors/VA050396/tech_11.html" target="_blank">http://hp.vector.co.jp/authors/VA050396/tech_11.html</a></li></ul></li></ul>

<p class="paragraph">
PEフォーマットの各情報を取得・表示するこれまでの実験：
<br />
</p>
<ul><li> <a href="./view-660.html" >日記/2010/05/25/PEフォーマットのIMAGE_DOS_HEADERを眺めてみる</a></li>
<li> <a href="./view-661.html" >日記/2010/05/25/IMAGE_NT_HEADERSとIMAGE_FILE_HEADERを覗いてみる。</a></li>
<li> <a href="./view-662.html" >日記/2010/05/25/IMAGE_OPTIONAL_HEADERを覗いてみる。</a></li>
<li> <a href="./view-663.html" >日記/2010/05/26/IMAGE_SECTION_HEADERを覗いてみる。</a></li>
<li> <a href="./view-665.html" >日記/2010/05/31/PEファイルをメモリ上に「仮」ロードするPython(作りかけ)</a></li>
<li> <a href="./view-666.html" >日記/2010/05/31/PEファイルのインポート情報を表示するPython(作りかけ)</a></li>
<li> <a href="./view-674.html" >日記/2010/06/09/PEファイルのエクスポート情報を表示するPython</a></li>
<li> <a href="./view-675.html" >日記/2010/06/09/PEファイルのインポート情報を表示するPython(一区切り)</a></li>
<li> <a href="./view-676.html" >日記/2010/06/10/PEファイルの事前バインド情報を表示するPython</a></li>
<li> <a href="./view-677.html" >日記/2010/06/10/PEファイルのDLL遅延ロード情報を表示するPython</a></li></ul>

<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-664.html" title="技術/Windows/PE(Portable Executable)フォーマットの実験/01, リンカオプション">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-707.html" title="技術/Windows/PE(Portable Executable)フォーマットの実験/03, TinyPEまとめ">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-708.html" title="技術/Windows/PE(Portable Executable)フォーマットの実験">Up</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-23.html" title="技術">技術</a>&nbsp;]</li>
</ul>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/678<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2001 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a target="_blank" href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" target="_blank" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>