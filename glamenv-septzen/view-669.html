<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>C言語系/memos/VC++/06, DLLの事前バインド(BindImageEx()) - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">C言語系/memos/VC++/06, DLLの事前バインド(BindImageEx())</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2010-06-03 01:20:09 &nbsp; / &nbsp; last updated at: 2010-06-09 21:31:04<br>
カテゴリ: <a href="category-10.html">C言語</a>&nbsp;<a href="category-8.html">Windows</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-668.html" title="C言語系/memos/VC++/05, モジュール定義ファイル(&quot;.DEF&quot;)とDLLのエクスポート">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-670.html" title="C言語系/memos/VC++/07, DLLのエクスポート転送(forwarding)">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-478.html" title="C言語系">C言語系</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
DLLの事前バインドとは、DLLがロードされた時のエクスポートシンボルのアドレスを事前に計算しておき、IATに予め書き込んでおく仕組み。
<br />
多数のDLLをロードするEXEでは、DLLのロードと再配置＋IATの書き換えで起動時間が遅くなる場合がある。DLLを事前バインドしておくことで、IATの書き換えをスキップでき起動時間の短縮に効果がある。
<br />
ただしDLLのバージョンはもとよりOSのバージョン・環境が異なれば当然、ロードされるアドレスも変わる。開発環境で事前バインドしても、実際に動作するクライアント環境ではバインドされたアドレスが無効となる可能性がある。そのため通常はインストール時に、つまりクライアント上で事前バインドを行う。
<br />
開発環境で事前バインドを試す場合は、VisualStudio付属ツールの&quot;BIND.exe&quot;か、&quot;EDITBIN.exe&quot;を使う。VSのバージョンによっては&quot;BIND.exe&quot;が無い場合もあるかも知れない。VC++2008ExpressEditionでは&quot;EDITBIN.exe&quot;が提供されている。あるいはクライアント上でのインストール時に事前バインドを行いたい場合は、イメージヘルプAPI(imagehlp.dll)のBindImageEx()APIを使う。
<br />
</p>

<p class="paragraph">
本記事ではBindImageEx()APIを使って事前バインドを試み、その影響をdumpbinなどで確認してみる。
<br />
最後にSDK提供の&quot;EDITBIN /BIND(:PATH=)&quot;オプションを使って事前バインドを試みる。
<br />
</p>

<p class="paragraph">
参考：
<br />
</p>
<ul><li> モジュールのロードを高速化する方法<ul><li> <a class="externallink" href="http://www7a.biglobe.ne.jp/~tsuneoka/win32tech/9.html" target="_blank">http://www7a.biglobe.ne.jp/~tsuneoka/win32tech/9.html</a></li></ul></li>
<li> Need for Binding an Executable to DLLs - CodeProject<ul><li> <a class="externallink" href="http://www.codeproject.com/KB/DLL/NeedBind.aspx" target="_blank">http://www.codeproject.com/KB/DLL/NeedBind.aspx</a></li></ul></li>
<li> What is DLL import binding? - The Old New Thing - Site Home - MSDN Blogs<ul><li> <a class="externallink" href="http://blogs.msdn.com/b/oldnewthing/archive/2010/03/18/9980802.aspx" target="_blank">http://blogs.msdn.com/b/oldnewthing/archive/2010/03/18/9980802.aspx</a></li></ul></li></ul>

<p class="paragraph">
対象：Visual C++ 2008 Express Edition
<br />
</p>
<pre>&gt; cl
Microsoft(R) 32-bit C/C++ Optimizing Compiler Version 15.00.30729.01 for 80x86
Copyright (C) Microsoft Corporation.  All rights reserved.
&gt; link
Microsoft (R) Incremental Linker Version 9.00.30729.01
Copyright (C) Microsoft Corporation.  All rights reserved.
</pre>

<p class="paragraph">
なお動作確認は Windows XP SP3 上で行っている。
<br />
</p>



<ul><li><a href="#id4f360b">サンプルコード</a><ul><li><a href="#id814ff2">DLL側(dll01.c, dll02.c)</a></li>
<li><a href="#idccea59">EXE側(main.c)</a></li>
<li><a href="#id9be8e3">BindImageEx()のサンプル(mybind.c)とコンパイル</a></li></ul></li>
<li><a href="#ide96184">事前バインド無し</a></li>
<li><a href="#id1dbbf5">事前バインド有り</a><ul><li><a href="#id0c45f0">最初は、DLLの方は変更せずに事前バインドを試みる。</a></li>
<li><a href="#idc2a0cb">&quot;/BASE&quot;オプションで空いているメモリ領域をベースアドレスに指定して事前バインドを試みる。</a></li>
<li><a href="#idcd06b9">&quot;/ALLOWBIND:NO&quot; リンカオプションを付けてビルドしたDLLだとどうなるか</a></li></ul></li>
<li><a href="#idac1054">その他</a><ul><li><a href="#idac96b4">ASLR(Address Space Layout Randomization)との兼ね合いについて</a></li>
<li><a href="#idd1d941">&quot;EDITBIN /BIND(:PATH=)&quot;の効能</a></li></ul></li></ul>
<hr />
<h3 id="id4f360b">サンプルコード</h3>

<p class="paragraph">
DLLとEXEのセット、およびBindImageEx()を呼ぶ &quot;mybind.c&quot; から成る。
<br />
</p>

<h4 id="id814ff2">DLL側(dll01.c, dll02.c)</h4>

<p class="paragraph">
後で&quot;/BASE&quot;の衝突を実験する為、DLLは二つ用意した。
<br />
</p>

<p class="paragraph">
dll01.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">windows.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">__declspec</span><span class="hl-brackets">(</span><span class="hl-identifier">dllexport</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">func1</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">a</span><span class="hl-code">, </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">b</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">OutputDebugString</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">func1() start</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">a</span><span class="hl-code"> + </span><span class="hl-identifier">b</span><span class="hl-code"> + </span><span class="hl-number">1</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">__declspec</span><span class="hl-brackets">(</span><span class="hl-identifier">dllexport</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">func2</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">a</span><span class="hl-code">, </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">b</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">OutputDebugString</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">func2() start</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">a</span><span class="hl-code"> + </span><span class="hl-identifier">b</span><span class="hl-code"> + </span><span class="hl-number">2</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
 
</span><span class="hl-identifier">BOOL</span><span class="hl-code"> </span><span class="hl-identifier">WINAPI</span><span class="hl-code"> </span><span class="hl-identifier">DllMain</span><span class="hl-brackets">(</span><span class="hl-identifier">HINSTANCE</span><span class="hl-code"> </span><span class="hl-identifier">hInstance</span><span class="hl-code">, </span><span class="hl-identifier">DWORD</span><span class="hl-code"> </span><span class="hl-identifier">dwReason</span><span class="hl-code">, </span><span class="hl-identifier">LPVOID</span><span class="hl-code"> </span><span class="hl-identifier">lpvReserved</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-reserved">switch</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">dwReason</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-reserved">case</span><span class="hl-code"> </span><span class="hl-identifier">DLL_PROCESS_ATTACH</span><span class="hl-code">:
        </span><span class="hl-identifier">OutputDebugString</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">dll01, DllMain() : DLL_PROCESS_ATTACH</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-reserved">case</span><span class="hl-code"> </span><span class="hl-identifier">DLL_THREAD_ATTACH</span><span class="hl-code">:
        </span><span class="hl-identifier">OutputDebugString</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">dll01, DllMain() : DLL_THREAD_ATTACH</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-reserved">case</span><span class="hl-code"> </span><span class="hl-identifier">DLL_THREAD_DETACH</span><span class="hl-code">:
        </span><span class="hl-identifier">OutputDebugString</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">dll01, DllMain() : DLL_THREAD_DETACH</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-reserved">case</span><span class="hl-code"> </span><span class="hl-identifier">DLL_PROCESS_DETACH</span><span class="hl-code">:
        </span><span class="hl-identifier">OutputDebugString</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">dll01, DllMain() : DLL_PROCESS_DETACH</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-reserved">default</span><span class="hl-code">:
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span >TRUE</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
dll02.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">windows.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">__declspec</span><span class="hl-brackets">(</span><span class="hl-identifier">dllexport</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">func3</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">a</span><span class="hl-code">, </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">b</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">OutputDebugString</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">func3() start</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">a</span><span class="hl-code"> + </span><span class="hl-identifier">b</span><span class="hl-code"> + </span><span class="hl-number">3</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">__declspec</span><span class="hl-brackets">(</span><span class="hl-identifier">dllexport</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">func4</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">a</span><span class="hl-code">, </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">b</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">OutputDebugString</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">func4() start</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">a</span><span class="hl-code"> + </span><span class="hl-identifier">b</span><span class="hl-code"> + </span><span class="hl-number">4</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
 
</span><span class="hl-identifier">BOOL</span><span class="hl-code"> </span><span class="hl-identifier">WINAPI</span><span class="hl-code"> </span><span class="hl-identifier">DllMain</span><span class="hl-brackets">(</span><span class="hl-identifier">HINSTANCE</span><span class="hl-code"> </span><span class="hl-identifier">hInstance</span><span class="hl-code">, </span><span class="hl-identifier">DWORD</span><span class="hl-code"> </span><span class="hl-identifier">dwReason</span><span class="hl-code">, </span><span class="hl-identifier">LPVOID</span><span class="hl-code"> </span><span class="hl-identifier">lpvReserved</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-reserved">switch</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">dwReason</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-reserved">case</span><span class="hl-code"> </span><span class="hl-identifier">DLL_PROCESS_ATTACH</span><span class="hl-code">:
        </span><span class="hl-identifier">OutputDebugString</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">dll02, DllMain() : DLL_PROCESS_ATTACH</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-reserved">case</span><span class="hl-code"> </span><span class="hl-identifier">DLL_THREAD_ATTACH</span><span class="hl-code">:
        </span><span class="hl-identifier">OutputDebugString</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">dll02, DllMain() : DLL_THREAD_ATTACH</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-reserved">case</span><span class="hl-code"> </span><span class="hl-identifier">DLL_THREAD_DETACH</span><span class="hl-code">:
        </span><span class="hl-identifier">OutputDebugString</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">dll02, DllMain() : DLL_THREAD_DETACH</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-reserved">case</span><span class="hl-code"> </span><span class="hl-identifier">DLL_PROCESS_DETACH</span><span class="hl-code">:
        </span><span class="hl-identifier">OutputDebugString</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">dll02, DllMain() : DLL_PROCESS_DETACH</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-reserved">default</span><span class="hl-code">:
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span >TRUE</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<h4 id="idccea59">EXE側(main.c)</h4>

<p class="paragraph">
暗黙的リンクでdll01, dll02のfunc1 - func4を順に呼ぶだけの実行ファイル。
<br />
</p>

<p class="paragraph">
main.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span class="hl-identifier">__declspec</span><span class="hl-brackets">(</span><span class="hl-identifier">dllimport</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">func1</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">a</span><span class="hl-code">, </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">b</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-identifier">__declspec</span><span class="hl-brackets">(</span><span class="hl-identifier">dllimport</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">func2</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">a</span><span class="hl-code">, </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">b</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-identifier">__declspec</span><span class="hl-brackets">(</span><span class="hl-identifier">dllimport</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">func3</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">a</span><span class="hl-code">, </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">b</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-identifier">__declspec</span><span class="hl-brackets">(</span><span class="hl-identifier">dllimport</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">func4</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">a</span><span class="hl-code">, </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">b</span><span class="hl-brackets">)</span><span class="hl-code">;
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">func1(2, 3) = %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">func1</span><span class="hl-brackets">(</span><span class="hl-number">2</span><span class="hl-code">, </span><span class="hl-number">3</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">func2(2, 3) = %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">func2</span><span class="hl-brackets">(</span><span class="hl-number">2</span><span class="hl-code">, </span><span class="hl-number">3</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">func3(2, 3) = %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">func3</span><span class="hl-brackets">(</span><span class="hl-number">2</span><span class="hl-code">, </span><span class="hl-number">3</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">func4(2, 3) = %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">func4</span><span class="hl-brackets">(</span><span class="hl-number">2</span><span class="hl-code">, </span><span class="hl-number">3</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<h4 id="id9be8e3">BindImageEx()のサンプル(mybind.c)とコンパイル</h4>

<p class="paragraph">
BindImageEx()を実行するサンプル, mybind.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">windows.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">imagehlp.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >void</span><span class="hl-code"> </span><span class="hl-identifier">PrintErrorMsg</span><span class="hl-brackets">(</span><span class="hl-identifier">DWORD</span><span class="hl-code"> </span><span class="hl-identifier">err</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">LPTSTR</span><span class="hl-code"> </span><span class="hl-identifier">lpMsgBuf</span><span class="hl-code">;
    </span><span class="hl-identifier">FormatMessage</span><span class="hl-brackets">(</span><span class="hl-identifier">FORMAT_MESSAGE_ALLOCATE_BUFFER</span><span class="hl-code">
        | </span><span class="hl-identifier">FORMAT_MESSAGE_FROM_SYSTEM</span><span class="hl-code"> 
        | </span><span class="hl-identifier">FORMAT_MESSAGE_IGNORE_INSERTS</span><span class="hl-code">,
        </span><span >NULL</span><span class="hl-code">, </span><span class="hl-identifier">err</span><span class="hl-code">,
        </span><span class="hl-identifier">MAKELANGID</span><span class="hl-brackets">(</span><span class="hl-identifier">LANG_NEUTRAL</span><span class="hl-code">, </span><span class="hl-identifier">SUBLANG_DEFAULT</span><span class="hl-brackets">)</span><span class="hl-code">,
        </span><span class="hl-brackets">(</span><span class="hl-identifier">LPTSTR</span><span class="hl-brackets">)</span><span class="hl-code">&amp;</span><span class="hl-identifier">lpMsgBuf</span><span class="hl-code">, </span><span class="hl-number">0</span><span class="hl-code">, </span><span >NULL</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">%s(%ld:0x%08X)</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">lpMsgBuf</span><span class="hl-code">, </span><span class="hl-identifier">err</span><span class="hl-code">, </span><span class="hl-identifier">err</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">LocalFree</span><span class="hl-brackets">(</span><span class="hl-identifier">lpMsgBuf</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
 
</span><span class="hl-comment">// BindImageEx()の進行状況に応じて呼ばれるcallback関数。</span><span class="hl-comment"></span><span class="hl-code">
</span><span class="hl-identifier">BOOL</span><span class="hl-code"> </span><span class="hl-identifier">StatusRoutine</span><span class="hl-brackets">(</span><span class="hl-identifier">IMAGEHLP_STATUS_REASON</span><span class="hl-code"> </span><span class="hl-identifier">Reason</span><span class="hl-code">, 
    </span><span class="hl-identifier">PSTR</span><span class="hl-code"> </span><span class="hl-identifier">ImageName</span><span class="hl-code">, </span><span class="hl-identifier">PSTR</span><span class="hl-code"> </span><span class="hl-identifier">DllName</span><span class="hl-code">, </span><span class="hl-identifier">ULONG_PTR</span><span class="hl-code"> </span><span class="hl-identifier">Va</span><span class="hl-code">, </span><span class="hl-identifier">ULONG_PTR</span><span class="hl-code"> </span><span class="hl-identifier">Parameter</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">[%s:%s] </span><span class="hl-quotes">&quot;</span><span class="hl-code">,</span><span class="hl-identifier">ImageName</span><span class="hl-code">, </span><span class="hl-identifier">DllName</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">switch</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">Reason</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-reserved">case</span><span class="hl-code"> </span><span class="hl-identifier">BindImportModuleFailed</span><span class="hl-code">:
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">BindImportModuleFailed(%d)</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">Reason</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-reserved">case</span><span class="hl-code"> </span><span class="hl-identifier">BindImportProcedureFailed</span><span class="hl-code">:
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">BindImportProcedureFailed(%d), FuncName=%s</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">Reason</span><span class="hl-code">, </span><span class="hl-identifier">Parameter</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-reserved">case</span><span class="hl-code"> </span><span class="hl-identifier">BindImportModule</span><span class="hl-code">:
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">BindImportModule(%d)</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">Reason</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-reserved">case</span><span class="hl-code"> </span><span class="hl-identifier">BindImportProcedure</span><span class="hl-code">:
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">BindImportProcedure(%d), FuncName=%s</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">Reason</span><span class="hl-code">, </span><span class="hl-identifier">Parameter</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-reserved">case</span><span class="hl-code"> </span><span class="hl-identifier">BindForwarder</span><span class="hl-code">:
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">BindForwarder(%d), FuncName=%s</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">Reason</span><span class="hl-code">, </span><span class="hl-identifier">Parameter</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-reserved">case</span><span class="hl-code"> </span><span class="hl-identifier">BindForwarderNOT</span><span class="hl-code">:
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">BindForwarderNOT(%d), FuncName=%s</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">Reason</span><span class="hl-code">, </span><span class="hl-identifier">Parameter</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-reserved">case</span><span class="hl-code"> </span><span class="hl-identifier">BindImageModified</span><span class="hl-code">:
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">BindImageModified(%d)</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">Reason</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-reserved">case</span><span class="hl-code"> </span><span class="hl-identifier">BindImageComplete</span><span class="hl-code">:
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">BindImageComplete(%d)</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">Reason</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">default</span><span class="hl-code">:
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">Reason = %d</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">Reason</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span >TRUE</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">argc</span><span class="hl-code">, </span><span >char</span><span class="hl-code"> *</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span >char</span><span class="hl-code"> </span><span class="hl-identifier">szImageName</span><span class="hl-brackets">[</span><span class="hl-identifier">MAX_PATH</span><span class="hl-brackets">]</span><span class="hl-code">;
    </span><span >char</span><span class="hl-code"> </span><span class="hl-identifier">szDllPath</span><span class="hl-brackets">[</span><span class="hl-identifier">MAX_PATH</span><span class="hl-brackets">]</span><span class="hl-code">;
    </span><span >char</span><span class="hl-code"> </span><span class="hl-identifier">szSymbolPath</span><span class="hl-brackets">[</span><span class="hl-identifier">MAX_PATH</span><span class="hl-brackets">]</span><span class="hl-code">;
    </span><span class="hl-identifier">BOOL</span><span class="hl-code"> </span><span class="hl-identifier">result</span><span class="hl-code">;
 
    </span><span class="hl-reserved">if</span><span class="hl-brackets">(</span><span class="hl-identifier">argc</span><span class="hl-code"> &lt; </span><span class="hl-number">2</span><span class="hl-brackets">)</span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">usage: %s image_file</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-number">0</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">return</span><span class="hl-code"> -</span><span class="hl-number">1</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
 
    </span><span class="hl-identifier">ZeroMemory</span><span class="hl-brackets">(</span><span class="hl-identifier">szImageName</span><span class="hl-code">, </span><span class="hl-reserved">sizeof</span><span class="hl-brackets">(</span><span class="hl-identifier">szImageName</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">ZeroMemory</span><span class="hl-brackets">(</span><span class="hl-identifier">szDllPath</span><span class="hl-code">, </span><span class="hl-reserved">sizeof</span><span class="hl-brackets">(</span><span class="hl-identifier">szDllPath</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">ZeroMemory</span><span class="hl-brackets">(</span><span class="hl-identifier">szSymbolPath</span><span class="hl-code">, </span><span class="hl-reserved">sizeof</span><span class="hl-brackets">(</span><span class="hl-identifier">szSymbolPath</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">strcpy</span><span class="hl-brackets">(</span><span class="hl-identifier">szImageName</span><span class="hl-code">, </span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-number">1</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-comment">// DLL探索PATH, シンボル探索PATH共にカレントディレクトリを指定。</span><span class="hl-comment"></span><span class="hl-code">
    </span><span class="hl-identifier">GetCurrentDirectory</span><span class="hl-brackets">(</span><span class="hl-reserved">sizeof</span><span class="hl-brackets">(</span><span class="hl-identifier">szDllPath</span><span class="hl-brackets">)</span><span class="hl-code">, </span><span class="hl-identifier">szDllPath</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">GetCurrentDirectory</span><span class="hl-brackets">(</span><span class="hl-reserved">sizeof</span><span class="hl-brackets">(</span><span class="hl-identifier">szSymbolPath</span><span class="hl-brackets">)</span><span class="hl-code">, </span><span class="hl-identifier">szSymbolPath</span><span class="hl-brackets">)</span><span class="hl-code">;
 
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">ImageName = %s</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">szImageName</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">DllPath = %s</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">szDllPath</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">szSymbolPath = %s</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">szSymbolPath</span><span class="hl-brackets">)</span><span class="hl-code">;
 
    </span><span class="hl-identifier">result</span><span class="hl-code"> = </span><span class="hl-identifier">BindImageEx</span><span class="hl-brackets">(</span><span class="hl-code">
        </span><span class="hl-number">0</span><span class="hl-code">, </span><span class="hl-comment">// 0でもOK。詳細はBindImageEx()のMSDN参照。</span><span class="hl-comment"></span><span class="hl-code">
        </span><span class="hl-identifier">szImageName</span><span class="hl-code">, 
        </span><span class="hl-identifier">szDllPath</span><span class="hl-code">, 
        </span><span class="hl-identifier">szSymbolPath</span><span class="hl-code">, 
        </span><span class="hl-brackets">(</span><span class="hl-identifier">PIMAGEHLP_STATUS_ROUTINE</span><span class="hl-brackets">)</span><span class="hl-identifier">StatusRoutine</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">!</span><span class="hl-identifier">result</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">PrintErrorMsg</span><span class="hl-brackets">(</span><span class="hl-identifier">GetLastError</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
mybind.cは予めコンパイルしておく。
<br />
</p>
<pre>&gt; cl mybind.c imagehlp.lib
</pre>

<h3 id="ide96184">事前バインド無し</h3>

<p class="paragraph">
まずは事前バインド無しの、いつも通りの手順でコンパイルしてみる。
<br />
</p>
<pre>&gt; cl /c dll01.c
&gt; link /dll dll01.obj
&gt; cl /c dll02.c
&gt; link /dll dll02.obj
&gt; cl main.c dll01.lib dll02.lib
</pre>

<p class="paragraph">
dumpbinでポイントとなる部分だけ確認する。
<br />
dll01.dll, dll02.dll：
<br />
</p>
<pre class="plugin_pre">
&gt; dumpbin /headers dll01.dll
...
FILE HEADER VALUES
...
    2102 characteristics
           Executable
           32 bit word machine
           DLL

OPTIONAL HEADER VALUES
...
    10000000 image base (10000000 to 1000CFFF)
...

&gt; dumpbin /headers dll02.dll
...
FILE HEADER VALUES
...
    2102 characteristics
           Executable
           32 bit word machine
           DLL

OPTIONAL HEADER VALUES
...
    10000000 image base (10000000 to 1000CFFF)
...
</pre>
<p class="paragraph">
どちらもベースアドレスが 0x10000000 となっている。
<br />
</p>

<p class="paragraph">
main.exeのヘッダー情報からポイントだけ見ていく：
<br />
</p>
<pre class="plugin_pre">
&gt; dumpbin /headers main.exe
...
FILE HEADER VALUES
...
             103 characteristics
                   Relocations stripped
                   Executable
                   32 bit word machine

OPTIONAL HEADER VALUES
...
          400000 image base (00400000 to 0040EFFF)
...
              10 number of directories
               0 [       0] RVA [size] of Export Directory
            B7A4 [      50] RVA [size] of Import Directory
...
               0 [       0] RVA [size] of Bound Import Directory
            A000 [     128] RVA [size] of Import Address Table Directory
...
</pre>
<p class="paragraph">
DataDirectoryに着目してみると、&quot;Bound Import Directory&quot;は空っぽになっている。
<br />
</p>

<p class="paragraph">
main.exeのインポート情報を確認してみる：
<br />
</p>
<pre class="plugin_pre">
&gt; dumpbin /imports main.exe
...
    dll01.dll
                40A110 Import Address Table
                40B904 Import Name Table
                     0 time date stamp
                     0 Index of first forwarder reference

                    0 func1
                    1 func2

    dll02.dll
                40A11C Import Address Table
                40B910 Import Name Table
                     0 time date stamp
                     0 Index of first forwarder reference

                    1 func4
                    0 func3

    KERNEL32.dll
...

  Summary

        3000 .data
        2000 .rdata
        9000 .text
</pre>
<p class="paragraph">
これが事前バインドを行うとどう変化するか、あとで見ていく。
<br />
</p>

<p class="paragraph">
デバッガ上でmain.exeを動作させ、dll01.dll, dll02.dllのロードされるアドレスを見ておく。
<br />
</p>
<table>
	<tr>
		<td> dll01.dll </td>
		<td> 0x10000000 - 0x1000D000 </td>
	</tr>
	<tr>
		<td> dll02.dll </td>
		<td> 0x00380000 - 0x0038D000 </td>
	</tr>
	<tr>
		<td> main.exe </td>
		<td> 0x00400000 - 0x0040D000 </td>
	</tr>
</table>

<p class="paragraph">
先にdll01.dllが 0x10000000 上にロードされた為、続くdll02.dllが0x00380000以降に再配置されている。
<br />
</p>

<h3 id="id1dbbf5">事前バインド有り</h3>

<h4 id="id0c45f0">最初は、DLLの方は変更せずに事前バインドを試みる。</h4>

<p class="paragraph">
DLLの方は変更しない、つまり、dll01.dll/dll02.dll共にベースアドレスはリンカのデフォルト、0x10000000になっている。
<br />
</p>

<pre class="plugin_pre">
&gt; mybind.exe main.exe
ImageName = main.exe
DllPath = C:\(...)\dll02
szSymbolPath = C:\(...)\dll02
[main.exe:dll01.dll] BindImportModule(5)
[main.exe:dll01.dll] BindImportProcedure(6), FuncName=func1
[main.exe:dll01.dll] BindImportProcedureFailed(4), FuncName=func1
[main.exe:dll02.dll] BindImportModule(5)
[main.exe:dll02.dll] BindImportProcedure(6), FuncName=func4
[main.exe:dll02.dll] BindImportProcedureFailed(4), FuncName=func4
[main.exe:KERNEL32.dll] BindImportModuleFailed(3)
[main.exe:(null)] BindImageModified(9)
[main.exe:(null)] BindImageComplete(11)Reason = 11
ハンドルが無効です。
(6:0x00000006)
</pre>
<p class="paragraph">
BindImageEx()のDllPath引数を現在ディレクトリのみにしている為、KERNEL32.dllの事前バインドはDLLが見つからず失敗している。
<br />
dll01.dll, dll02.dllについては BindImportProcedureFailed が発生している。
<br />
処理としては BindImageComplete まで、つまりバインドに失敗したDLLもあるものの、処理としては完了したようだ。
<br />
気になるのが、続く「ハンドルが無効です。」メッセージで、ロジック上はBindImageEx()APIがFALSEを返した場合、つまり失敗の場合にGetLastError()に対応したメッセージ文字列を表示する。
<br />
</p>

<p class="paragraph">
実験していた当初は、完全に失敗したと勘違いして色々条件を変えてみたりしていたが、実はこの段階で事前バインドされたAPIがEXEに書き込まれていた。
<br />
</p>

<p class="paragraph">
実際にdumpbinで確認してみる。
<br />
まずインポート情報から：
<br />
</p>
<pre class="plugin_pre">
&gt; dumpbin /imports main.exe
...
    dll01.dll
                40A110 Import Address Table
                40B904 Import Name Table
              FFFFFFFF time date stamp
              FFFFFFFF Index of first forwarder reference

      10001000      0 func1
      00000000      1 func2

    dll02.dll
                40A11C Import Address Table
                40B910 Import Name Table
              FFFFFFFF time date stamp
              FFFFFFFF Index of first forwarder reference

      10001020      1 func4
      00000000      0 func3

    KERNEL32.dll
...
  Header contains the following bound import information:
    Bound to dll01.dll [       6] Thu Jan 01 09:00:06 1970
    Bound to dll02.dll [       6] Thu Jan 01 09:00:06 1970
    Bound to KERNEL32.dll [       0] Thu Jan 01 09:00:00 1970
...
</pre>
<p class="paragraph">
dll01.dllとdll02.dllのインポート情報に変化が見られる。&quot;time date stamp&quot;と &quot;Index of first forwarder reference&quot; の全bitが1になり、また、func1, func4 については実際のアドレスを計算したと思われる値が表示されている(dll01.dll, dll02.dllともにベースアドレス(ImageBase)はリンカのデフォルトである0x10000000)。
<br />
加えて、
<br />
</p>
<pre> Header contains the following bound import information:
</pre>
<p class="paragraph">
としてヘッダー上の事前バインドされたインポート情報らしきものが表示されている。
<br />
</p>

<p class="paragraph">
続いてdumpbinのヘッダー情報を確認してみる：
<br />
</p>
<pre class="plugin_pre">
&gt; dumpbin /headers main.exe
...
    248 [      44] RVA [size] of Bound Import Directory
...
</pre>
<p class="paragraph">
大きく異なる点が、DataDirectoryの &quot;Bound Import Directory&quot; に値が設定されている点。このDataDirectoryはIMAGE_BOUND_IMPORT_DESCRIPTOR構造体の配列を参照する。IMAGE_BOUND_IMPORT_DESCRIPTOR構造体はバインドされた時のDLLのタイムスタンプとDLL名、IMAGE_BOUND_FORWARDER_REFの数を含む。
<br />
実際にデバッガ上でmemory dumpを確認すると、&quot;dumpbin /imports&quot;で得られた
<br />
</p>
<pre> Header contains the following bound import information:
   Bound to dll01.dll [       6] Thu Jan 01 09:00:06 1970
   Bound to dll02.dll [       6] Thu Jan 01 09:00:06 1970
   Bound to KERNEL32.dll [       0] Thu Jan 01 09:00:00 1970
</pre>
<p class="paragraph">
に相当するデータが設定されていた。
<br />
</p>

<p class="paragraph">
PEファイルをバイナリエディタでダンプし、IATに該当する箇所をチェックしてみると、確かにfunc1とfunc4のアドレスが書き込まれていることを確認出来る。つまり、EXEファイルの段階でIATに実際のアドレスが格納済になっていることを確認出来た。
<br />
</p>

<p class="paragraph">
デバッガで実際に動かしてみると、DLLとEXEのロードアドレスは次のようになっていた。
<br />
</p>
<table>
	<tr>
		<td> dll01.dll </td>
		<td> 0x10000000 - 0x1000D000 </td>
	</tr>
	<tr>
		<td> dll02.dll </td>
		<td> 0x00380000 - 0x0038D000 </td>
	</tr>
	<tr>
		<td> main.exe </td>
		<td> 0x00400000 - 0x0040D000 </td>
	</tr>
</table>

<p class="paragraph">
dll02.dllの方が再配置され、IATの方もそれに合わせて変更されていた。
<br />
</p>

<h4 id="idc2a0cb">&quot;/BASE&quot;オプションで空いているメモリ領域をベースアドレスに指定して事前バインドを試みる。</h4>

<p class="paragraph">
dll01.dll, dll02.dllのベースアドレスを、&quot;/BASE&quot;リンカオプションでそれぞれ衝突しない場所に設定する。
<br />
</p>
<pre class="plugin_pre">
&gt; link /dll /BASE:0x600000 dll01.obj
&gt; link /dll /BASE:0x700000 dll02.obj
&gt; mybind main.exe
ImageName = main.exe
DllPath = C:\(...)\dll02
szSymbolPath = C:\(...)\dll02
[main.exe:dll01.dll] BindImportModule(5)
[main.exe:dll01.dll] BindImportProcedure(6), FuncName=func1
[main.exe:dll01.dll] BindImportProcedureFailed(4), FuncName=func1
[main.exe:dll02.dll] BindImportModule(5)
[main.exe:dll02.dll] BindImportProcedure(6), FuncName=func4
[main.exe:dll02.dll] BindImportProcedureFailed(4), FuncName=func4
[main.exe:KERNEL32.dll] BindImportModuleFailed(3)
[main.exe:(null)] BindImageModified(9)
[main.exe:(null)] BindImageComplete(11)Reason = 11
ハンドルが無効です。
(6:0x00000006)
</pre>
<p class="paragraph">
main.exeのインポート情報を確認する：
<br />
</p>
<pre class="plugin_pre">
&gt; dumpbin /imports main.exe
(...)
    dll01.dll
                40A110 Import Address Table
                40B904 Import Name Table
              FFFFFFFF time date stamp
              FFFFFFFF Index of first forwarder reference

      00601000      0 func1
      00000000      1 func2

    dll02.dll
                40A11C Import Address Table
                40B910 Import Name Table
              FFFFFFFF time date stamp
              FFFFFFFF Index of first forwarder reference

      00701020      1 func4
      00000000      0 func3
(...)
</pre>
<p class="paragraph">
とりあえずfunc1, func4について、DLLに指定したベースアドレスに基づくアドレスが設定されているのを確認出来る。
<br />
</p>

<p class="paragraph">
デバッガで実際に動かしてみると、DLLとEXEのロードアドレスは次のようになっていた。
<br />
</p>
<table>
	<tr>
		<td> dll01.dll </td>
		<td> 0x00600000 - 0x0060D000 </td>
	</tr>
	<tr>
		<td> dll02.dll </td>
		<td> 0x00700000 - 0x0070D000 </td>
	</tr>
	<tr>
		<td> main.exe </td>
		<td> 0x00400000 - 0x0040D000 </td>
	</tr>
</table>

<p class="paragraph">
メモリ上のIATも、dll01.dll/dll02.dll共にベースアドレスに基づくアドレスが設定されていた。
<br />
</p>

<h4 id="idcd06b9">&quot;/ALLOWBIND:NO&quot; リンカオプションを付けてビルドしたDLLだとどうなるか</h4>

<p class="paragraph">
&quot;/BASE&quot;オプションに加え、&quot;/ALLOWBIND:NO&quot; リンカオプションを指定してdll01.dll/dll02.dllをビルドする。
<br />
</p>
<pre>&gt; link /dll /ALLOWBIND:NO /BASE:0x600000 dll01.obj
&gt; link /dll /ALLOWBIND:NO /BASE:0x700000 dll02.obj
</pre>

<p class="paragraph">
dll01.dll, dll02.dllのヘッダー情報を見てみると、OPTIONALヘッダの&quot;DLL characteristics&quot;で初めて&quot;0x800&quot;, &quot;Do not bind&quot;が設定されたことを確認出来る：
<br />
</p>
<pre class="plugin_pre">
&gt; dumpbin /headers dll01.dll
...
OPTIONAL HEADER VALUES
...
             800 DLL characteristics
                   Do not bind
...

&gt; dumpbin /headers dll01.dll
...
OPTIONAL HEADER VALUES
...
             800 DLL characteristics
                   Do not bind
...
</pre>

<p class="paragraph">
バインドしてみる：
<br />
</p>
<pre class="plugin_pre">
&gt; mybind main.exe
ImageName = main.exe
DllPath = C:\(...)\dll02
szSymbolPath = C:\(...)\dll02
[main.exe:dll01.dll] BindImportModule(5)
[main.exe:dll01.dll] BindImportProcedure(6), FuncName=func1
[main.exe:dll01.dll] BindImportProcedureFailed(4), FuncName=func1
[main.exe:dll02.dll] BindImportModule(5)
[main.exe:dll02.dll] BindImportProcedure(6), FuncName=func4
[main.exe:dll02.dll] BindImportProcedureFailed(4), FuncName=func4
[main.exe:KERNEL32.dll] BindImportModuleFailed(3)
[main.exe:(null)] BindImageModified(9)
[main.exe:(null)] BindImageComplete(11)Reason = 11
ハンドルが無効です。
(6:0x00000006)
</pre>

<p class="paragraph">
・・・バインドできてしまった（;´Д｀）。
<br />
リンカオプションのマニュアルを確認してみると、DLLに電子署名をしている場合にバインド不可(DLL characteristicsに0x800指定)にするオプションらしい。今回は電子署名をしていないので、問題なくバインドされてしまった可能性がある。
<br />
</p>

<h3 id="idac1054">その他</h3>

<p class="paragraph">
以下の点については余力が無い為スルー。
<br />
</p>
<ul><li> BindImageEx()がFALSEを返し、GetLastError()が6になる：にも関わらず、ファイル上はfunc1, func4について事前バインドできてしまっている件</li>
<li> func1, func4しか事前バインドできず、それ以外が失敗してしまう件</li>
<li> main.exeの&quot;Bound Import Directory&quot;で、IMAGE_BOUND_IMPORT_DESCRIPTOR構造体のTimeDateStampが何故か&quot;6&quot;(1970年云々+6秒)になってしまっている件</li>
<li> DLLに電子署名した上で&quot;/ALLOWBIND:NO&quot;を指定して、バインド不可になるか確認する件</li></ul>

<h4 id="idac96b4">ASLR(Address Space Layout Randomization)との兼ね合いについて</h4>

<p class="paragraph">
Vista, Win7以降に搭載されている ASLR(Address Space Layout Randomization) を使う場合、事前バインドによる起動時間短縮効果は無意味となる。ASLRによりランダムな再配置が発動してしまい、従って事前バインドしたアドレスが無効となり、再計算とIATの更新が発生してしまう。
<br />
</p>

<h4 id="idd1d941">&quot;EDITBIN /BIND(:PATH=)&quot;の効能</h4>

<p class="paragraph">
BindImageEx()は上手くバインド出来なかったので、SDK提供のツールEDITBINで事前バインドを試みる。
<br />
事前バインド前：
<br />
</p>
<pre class="plugin_pre">
&gt; dumpbin /imports main.exe
...
    dll01.dll
                40A110 Import Address Table
                40B904 Import Name Table
                     0 time date stamp
                     0 Index of first forwarder reference

                    0 func1
                    1 func2

    dll02.dll
                40A11C Import Address Table
                40B910 Import Name Table
                     0 time date stamp
                     0 Index of first forwarder reference

                    1 func4
                    0 func3
</pre>

<p class="paragraph">
バインド実行：
<br />
</p>
<pre>&gt; EDITBIN /BIND:PATH=. main.exe
</pre>

<p class="paragraph">
dumpbinで確認：
<br />
</p>
<pre class="plugin_pre">
&gt; dumpbin /imports main.exe
...
    dll01.dll
                40A110 Import Address Table
                40B904 Import Name Table
              FFFFFFFF time date stamp
              FFFFFFFF Index of first forwarder reference

      00601000      0 func1
      00601020      1 func2

    dll02.dll
                40A11C Import Address Table
                40B910 Import Name Table
              FFFFFFFF time date stamp
              FFFFFFFF Index of first forwarder reference

      00701020      1 func4
      00701000      0 func3
...
  Header contains the following bound import information:
    Bound to dll01.dll [4C067F22] Thu Jun 03 00:56:18 2010
    Bound to dll02.dll [4C067F26] Thu Jun 03 00:56:22 2010
    Bound to KERNEL32.dll [       0] Thu Jan 01 09:00:00 1970
</pre>

<p class="paragraph">
ここまでのバインドでは、わざと&quot;/BIND&quot;にPATH指定を行い、dll01.dll, dll02.dllが存在するカレントディレクトリを指定していた。
<br />
今度はPATH指定を省略してみる。デフォルトのDLL探索が行われ、KERNEL32.DLLの事前バインドが行われる筈である。
<br />
</p>
<pre>&gt; EDITBIN /BIND main.exe
</pre>

<p class="paragraph">
dumpbinで確認：
<br />
</p>
<pre class="plugin_pre">
&gt; dumpbin /imports main.exe
...
    dll01.dll
                40A110 Import Address Table
                40B904 Import Name Table
              FFFFFFFF time date stamp
              FFFFFFFF Index of first forwarder reference

      00601000      0 func1
      00601020      1 func2

    dll02.dll
                40A11C Import Address Table
                40B910 Import Name Table
              FFFFFFFF time date stamp
              FFFFFFFF Index of first forwarder reference

      00701020      1 func4
      00701000      0 func3

    KERNEL32.dll
                40A000 Import Address Table
                40B7F4 Import Name Table
              FFFFFFFF time date stamp
              FFFFFFFF Index of first forwarder reference

      7C80934A    266 GetTickCount
...
      7C81D37B    3FC SetStdHandle

  Header contains the following bound import information:
    Bound to dll01.dll [4C067F22] Thu Jun 03 00:56:18 2010
    Bound to dll02.dll [4C067F26] Thu Jun 03 00:56:22 2010
    Bound to KERNEL32.dll [49C4F49C] Sat Mar 21 23:07:24 2009
      Contained forwarders bound to NTDLL.DLL [49900AEF] Mon Feb 09 19:52:31 2009
</pre>
<p class="paragraph">
このようにKERNEL32.dllについても事前バインドされ、また、一部はNTDLL.dllへ転送(forward)されていることも確認出来た。
<br />
</p>

<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-668.html" title="C言語系/memos/VC++/05, モジュール定義ファイル(&quot;.DEF&quot;)とDLLのエクスポート">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-670.html" title="C言語系/memos/VC++/07, DLLのエクスポート転送(forwarding)">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-582.html" title="C言語系/memos/VC++">Up</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-478.html" title="C言語系">C言語系</a>&nbsp;]</li>
</ul>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/669<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2007 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>