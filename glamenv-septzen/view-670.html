<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>C言語系/memos/VC++/07, DLLのエクスポート転送(forwarding) - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">C言語系/memos/VC++/07, DLLのエクスポート転送(forwarding)</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2010-06-04 09:01:23 &nbsp; / &nbsp; last updated at: 2010-06-04 09:04:43<br>
カテゴリ: <a href="category-10.html">C言語</a>&nbsp;<a href="category-8.html">Windows</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-669.html" title="C言語系/memos/VC++/06, DLLの事前バインド(BindImageEx())">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-671.html" title="C言語系/memos/VC++/08, DLLの遅延読み込み(delay loading)">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-478.html" title="C言語系">C言語系</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
DLLにはエクスポートするシンボルの実体を別のDLLに転送(forward)する機能がある。例えばWindowsXP(SP3)上のKERNEL32.DLLのエクスポート情報を表示してみると、NTDLL.DLLへ転送されているシンボルがいくつか見つかる。
<br />
</p>
<pre>&gt; dumpbin /exports c:\WINDOWS\System32\kernel32.dll
...
   708  2C3          RtlCaptureContext (forwarded to NTDLL.RtlCaptureContext)
   709  2C4          RtlCaptureStackBackTrace (forwarded to NTDLL.RtlCaptureStackBackTrace)
   710  2C5          RtlFillMemory (forwarded to NTDLL.RtlFillMemory)
   711  2C6          RtlMoveMemory (forwarded to NTDLL.RtlMoveMemory)
   712  2C7          RtlUnwind (forwarded to NTDLL.RtlUnwind)
   713  2C8          RtlZeroMemory (forwarded to NTDLL.RtlZeroMemory)
...
</pre>

<p class="paragraph">
forwardingによるDLLの階層化やインポートライブラリの集約は、ライブラリやソースの構成・依存関係の整理に役立つだろう。
<br />
</p>

<p class="paragraph">
今回はモジュール定義ファイル(.def)を使ったDLLのforwardingを試してみる。
<br />
</p>

<p class="paragraph">
参考：
<br />
</p>
<ul><li> &quot;アレ用の何か&quot;より:<ul><li> DLL のエクスポート転送で遊んでみる<ul><li> <a class="externallink" href="http://hp.vector.co.jp/authors/VA050396/tech_09.html" target="_blank">http://hp.vector.co.jp/authors/VA050396/tech_09.html</a></li></ul></li></ul></li>
<li> &quot;The Old New Thing&quot;より:<ul><li> Index to the series on DLL imports and exports<ul><li> <a class="externallink" href="http://blogs.msdn.com/b/oldnewthing/archive/2006/07/27/680250.aspx" target="_blank">http://blogs.msdn.com/b/oldnewthing/archive/2006/07/27/680250.aspx</a></li></ul></li>
<li> Exported functions that are really forwarders<ul><li> <a class="externallink" href="http://blogs.msdn.com/b/oldnewthing/archive/2006/07/19/671238.aspx" target="_blank">http://blogs.msdn.com/b/oldnewthing/archive/2006/07/19/671238.aspx</a></li></ul></li>
<li> DLL forwarding is not the same as delay-loading<ul><li> <a class="externallink" href="http://blogs.msdn.com/b/oldnewthing/archive/2008/02/04/7439592.aspx" target="_blank">http://blogs.msdn.com/b/oldnewthing/archive/2008/02/04/7439592.aspx</a></li></ul></li></ul></li></ul>

<p class="paragraph">
対象：Visual C++ 2008 Express Edition
<br />
</p>
<pre>&gt; cl
Microsoft(R) 32-bit C/C++ Optimizing Compiler Version 15.00.30729.01 for 80x86
Copyright (C) Microsoft Corporation.  All rights reserved.
&gt; link
Microsoft (R) Incremental Linker Version 9.00.30729.01
Copyright (C) Microsoft Corporation.  All rights reserved.
</pre>

<p class="paragraph">
なお動作確認は Windows XP SP3 上で行っている。
<br />
</p>



<ul><li><a href="#id502185">DLL側のサンプルコード</a><ul><li><a href="#id163cab">dll01.c, dll01.def</a></li>
<li><a href="#id705993">dll02.c</a></li>
<li><a href="#id75d4b0">dll01.dll, dll02.dll のビルド</a></li></ul></li>
<li><a href="#idbc5f63">EXE側のサンプルコード</a><ul><li><a href="#id824717">暗黙的リンク(implicit-link)する main_implicit.c とビルド</a></li>
<li><a href="#id77eac4">明示的リンク(explicit-link)する main_explicit.c とビルド</a></li></ul></li>
<li><a href="#id9047af">転送先のDLLのロードタイミング</a></li>
<li><a href="#id73c60a">おまけ</a></li></ul>
<hr />
<h3 id="id502185">DLL側のサンプルコード</h3>

<p class="paragraph">
dll01.c と dll02.c, dll01.c のモジュール定義ファイル dll01.def の3本となる。
<br />
</p>

<h4 id="id163cab">dll01.c, dll01.def</h4>

<p class="paragraph">
dll01.cは&quot;funcA1()&quot;の実体を提供する。
<br />
</p>

<p class="paragraph">
dll01.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">windows.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">funcA1</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">a</span><span class="hl-code">, </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">b</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">OutputDebugString</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">funcA1() start</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">a</span><span class="hl-code"> + </span><span class="hl-identifier">b</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
 
</span><span class="hl-identifier">BOOL</span><span class="hl-code"> </span><span class="hl-identifier">WINAPI</span><span class="hl-code"> </span><span class="hl-identifier">DllMain</span><span class="hl-brackets">(</span><span class="hl-identifier">HINSTANCE</span><span class="hl-code"> </span><span class="hl-identifier">hInstance</span><span class="hl-code">, </span><span class="hl-identifier">DWORD</span><span class="hl-code"> </span><span class="hl-identifier">dwReason</span><span class="hl-code">, </span><span class="hl-identifier">LPVOID</span><span class="hl-code"> </span><span class="hl-identifier">lpvReserved</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-reserved">switch</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">dwReason</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-reserved">case</span><span class="hl-code"> </span><span class="hl-identifier">DLL_PROCESS_ATTACH</span><span class="hl-code">:
        </span><span class="hl-identifier">OutputDebugString</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">dll01, DllMain() : DLL_PROCESS_ATTACH</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-reserved">case</span><span class="hl-code"> </span><span class="hl-identifier">DLL_THREAD_ATTACH</span><span class="hl-code">:
        </span><span class="hl-identifier">OutputDebugString</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">dll01, DllMain() : DLL_THREAD_ATTACH</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-reserved">case</span><span class="hl-code"> </span><span class="hl-identifier">DLL_THREAD_DETACH</span><span class="hl-code">:
        </span><span class="hl-identifier">OutputDebugString</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">dll01, DllMain() : DLL_THREAD_DETACH</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-reserved">case</span><span class="hl-code"> </span><span class="hl-identifier">DLL_PROCESS_DETACH</span><span class="hl-code">:
        </span><span class="hl-identifier">OutputDebugString</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">dll01, DllMain() : DLL_PROCESS_DETACH</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-reserved">default</span><span class="hl-code">:
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span >TRUE</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
dll01.defで&quot;funcA1()&quot;をエクスポートする。また、&quot;funcB1()&quot;という名前でdll02.cの&quot;funcB2()&quot;をエクスポートする。これにより、&quot;funcB1()&quot;を呼ぶ場合はdll02.cの&quot;funcB2()&quot;に転送される。
<br />
dll01.def:
<br />
</p>
<pre class="plugin_pre">
LIBRARY dll01
EXPORTS
    funcA1
    funcB1 = dll02.funcB2
</pre>

<h4 id="id705993">dll02.c</h4>

<p class="paragraph">
dll02.c側では&quot;funcB2()&quot;の実体を実装する。
<br />
dll02.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">windows.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">__declspec</span><span class="hl-brackets">(</span><span class="hl-identifier">dllexport</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">funcB2</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">a</span><span class="hl-code">, </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">b</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">OutputDebugString</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">funcB2() start</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">a</span><span class="hl-code"> * </span><span class="hl-identifier">b</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
 
</span><span class="hl-identifier">BOOL</span><span class="hl-code"> </span><span class="hl-identifier">WINAPI</span><span class="hl-code"> </span><span class="hl-identifier">DllMain</span><span class="hl-brackets">(</span><span class="hl-identifier">HINSTANCE</span><span class="hl-code"> </span><span class="hl-identifier">hInstance</span><span class="hl-code">, </span><span class="hl-identifier">DWORD</span><span class="hl-code"> </span><span class="hl-identifier">dwReason</span><span class="hl-code">, </span><span class="hl-identifier">LPVOID</span><span class="hl-code"> </span><span class="hl-identifier">lpvReserved</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-reserved">switch</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">dwReason</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-reserved">case</span><span class="hl-code"> </span><span class="hl-identifier">DLL_PROCESS_ATTACH</span><span class="hl-code">:
        </span><span class="hl-identifier">OutputDebugString</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">dll02, DllMain() : DLL_PROCESS_ATTACH</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-reserved">case</span><span class="hl-code"> </span><span class="hl-identifier">DLL_THREAD_ATTACH</span><span class="hl-code">:
        </span><span class="hl-identifier">OutputDebugString</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">dll02, DllMain() : DLL_THREAD_ATTACH</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-reserved">case</span><span class="hl-code"> </span><span class="hl-identifier">DLL_THREAD_DETACH</span><span class="hl-code">:
        </span><span class="hl-identifier">OutputDebugString</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">dll02, DllMain() : DLL_THREAD_DETACH</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-reserved">case</span><span class="hl-code"> </span><span class="hl-identifier">DLL_PROCESS_DETACH</span><span class="hl-code">:
        </span><span class="hl-identifier">OutputDebugString</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">dll02, DllMain() : DLL_PROCESS_DETACH</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-reserved">default</span><span class="hl-code">:
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span >TRUE</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<h4 id="id75d4b0">dll01.dll, dll02.dll のビルド</h4>

<p class="paragraph">
最初にdll02.dllをビルドする：
<br />
</p>
<pre>&gt; cl /c dll02.c
&gt; link /dll dll02.obj
</pre>

<p class="paragraph">
次にdll01.dllをビルドする：
<br />
</p>
<pre>&gt;cl /c dll01.c
&gt;link /dll /def:dll01.def dll01.obj
...
dll01.def : error LNK2001: 外部シンボル &quot;funcB2&quot; は未解決です。
dll01.lib : fatal error LNK1120: 外部参照 1 が未解決です。
</pre>

<p class="paragraph">
dll02側のシンボルを解決出来なかったので、dll02.lib(インポートライブラリ)を追加する：
<br />
</p>
<pre>&gt; link /dll /def:dll01.def dll01.obj dll02.lib
</pre>

<p class="paragraph">
これでdll01.dll, dll02.dllがビルド出来た。
<br />
</p>

<p class="paragraph">
実際にdumpbinでエクスポート情報を確認してみる。
<br />
</p>

<p class="paragraph">
まずdll02.dllのエクスポート情報を見てみる：
<br />
</p>
<pre class="plugin_pre">
&gt; dumpbin /exports dll02.dll
...
    00000000 characteristics
    4C0715B5 time date stamp Thu Jun 03 11:38:45 2010
        0.00 version
           1 ordinal base
           1 number of functions
           1 number of names

    ordinal hint RVA      name

          1    0 00001000 funcB2
...
</pre>
<p class="paragraph">
&quot;funcB2&quot;がエクスポートされていることを確認出来る。
<br />
</p>

<p class="paragraph">
続いてdll01.dllのエクスポート情報を見てみる：
<br />
</p>
<pre class="plugin_pre">
&gt; dumpbin /exports dll01.dll
...
    00000000 characteristics
    4C0715D2 time date stamp Thu Jun 03 11:39:14 2010
        0.00 version
           1 ordinal base
           2 number of functions
           2 number of names

    ordinal hint RVA      name

          1    0 00001000 funcA1
          2    1          funcB1 (forwarded to dll02.funcB2)
...
</pre>

<p class="paragraph">
&quot;funcA1()&quot;がエクスポートされていると同時に、&quot;funcB1()&quot;がdll02(.dll)の&quot;funcB2()&quot;に転送されるようになっているのが確認出来る。
<br />
</p>

<h3 id="idbc5f63">EXE側のサンプルコード</h3>

<p class="paragraph">
暗黙的リンク(implicit-link)と明示的リンク(explicit-link)で2種類のexeを作る。
<br />
後ほどデバッガでdll02.dllのロードタイミングを比べてみる。
<br />
</p>

<h4 id="id824717">暗黙的リンク(implicit-link)する main_implicit.c とビルド</h4>

<p class="paragraph">
main_implicit.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span class="hl-identifier">__declspec</span><span class="hl-brackets">(</span><span class="hl-identifier">dllimport</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">funcA1</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">a</span><span class="hl-code">, </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">b</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-identifier">__declspec</span><span class="hl-brackets">(</span><span class="hl-identifier">dllimport</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">funcB1</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">a</span><span class="hl-code">, </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">b</span><span class="hl-brackets">)</span><span class="hl-code">;
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">funcA1(2, 3) = %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">funcA1</span><span class="hl-brackets">(</span><span class="hl-number">2</span><span class="hl-code">, </span><span class="hl-number">3</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">funcB1(2, 3) = %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">funcB1</span><span class="hl-brackets">(</span><span class="hl-number">2</span><span class="hl-code">, </span><span class="hl-number">3</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
コンパイル時は dll01.lib を指定するだけでよい。dll02.libは不要。
<br />
</p>
<pre>&gt; cl main_implicit.c dll01.lib
</pre>

<p class="paragraph">
インポート情報を見てみると&quot;dll01.dll&quot;として&quot;funcA1&quot;, &quot;funcB1&quot;がインポートされることが確認出来る：
<br />
</p>
<pre class="plugin_pre">
&gt; dumpbin /imports main_implicit.exe
...
    dll01.dll
                40A110 Import Address Table
                40B8E0 Import Name Table
                     0 time date stamp
                     0 Index of first forwarder reference

                    0 funcA1
                    1 funcB1
...
</pre>

<p class="paragraph">
実行：
<br />
</p>
<pre>&gt; main_implicit.exe
funcA1(2, 3) = 5
funcB1(2, 3) = 6
</pre>

<h4 id="id77eac4">明示的リンク(explicit-link)する main_explicit.c とビルド</h4>

<p class="paragraph">
main_explicit.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">windows.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >typedef</span><span class="hl-code"> </span><span >int</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">CALLBACK</span><span class="hl-code">* </span><span class="hl-identifier">DLLFUNC</span><span class="hl-brackets">)</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code">, </span><span >int</span><span class="hl-brackets">)</span><span class="hl-code">;
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">HINSTANCE</span><span class="hl-code"> </span><span class="hl-identifier">hDll</span><span class="hl-code">;
    </span><span class="hl-identifier">DLLFUNC</span><span class="hl-code"> </span><span class="hl-identifier">funcA1</span><span class="hl-code"> = </span><span >NULL</span><span class="hl-code">;
    </span><span class="hl-identifier">DLLFUNC</span><span class="hl-code"> </span><span class="hl-identifier">funcB1</span><span class="hl-code"> = </span><span >NULL</span><span class="hl-code">;
 
    </span><span class="hl-identifier">hDll</span><span class="hl-code"> = </span><span class="hl-identifier">LoadLibrary</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">dll01</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span >NULL</span><span class="hl-code"> == </span><span class="hl-identifier">hDll</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">dll load error.</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">1</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
 
    </span><span class="hl-identifier">funcA1</span><span class="hl-code"> = </span><span class="hl-brackets">(</span><span class="hl-identifier">DLLFUNC</span><span class="hl-brackets">)</span><span class="hl-identifier">GetProcAddress</span><span class="hl-brackets">(</span><span class="hl-identifier">hDll</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">funcA1</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">!</span><span class="hl-identifier">funcA1</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">GetProcAddress error(funcA1).</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">FreeLibrary</span><span class="hl-brackets">(</span><span class="hl-identifier">hDll</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">2</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
 
    </span><span class="hl-identifier">funcB1</span><span class="hl-code"> = </span><span class="hl-brackets">(</span><span class="hl-identifier">DLLFUNC</span><span class="hl-brackets">)</span><span class="hl-identifier">GetProcAddress</span><span class="hl-brackets">(</span><span class="hl-identifier">hDll</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">funcB1</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">!</span><span class="hl-identifier">funcB1</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">GetProcAddress error(funcB1).</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">FreeLibrary</span><span class="hl-brackets">(</span><span class="hl-identifier">hDll</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">3</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
 
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">funcA1(2, 3) = %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">funcA1</span><span class="hl-brackets">(</span><span class="hl-number">2</span><span class="hl-code">, </span><span class="hl-number">3</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">funcB1(2, 3) = %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">funcB1</span><span class="hl-brackets">(</span><span class="hl-number">2</span><span class="hl-code">, </span><span class="hl-number">3</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">FreeLibrary</span><span class="hl-brackets">(</span><span class="hl-identifier">hDll</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
ビルドではインポートライブラリ不要：
<br />
</p>
<pre>&gt; cl main_explicit.c
</pre>

<p class="paragraph">
インポート情報を見てみるとKERNEL32だけが登録されていることが確認出来る：
<br />
</p>
<pre class="plugin_pre">
&gt; dumpbin /imports main_explicit.exe
...
Dump of file main_explicit.exe

File Type: EXECUTABLE IMAGE

  Section contains the following imports:

    KERNEL32.dll
                40A000 Import Address Table
                40B7AC Import Name Table
                     0 time date stamp
                     0 Index of first forwarder reference

                  14C FreeLibrary
...
</pre>

<p class="paragraph">
実行：
<br />
</p>
<pre>&gt; main_explicit.exe
funcA1(2, 3) = 5
funcB1(2, 3) = 6
</pre>

<h3 id="id9047af">転送先のDLLのロードタイミング</h3>

<p class="paragraph">
dll01.dll, dll02.dllとも、DllMain()にOutputDebugString()を組み込んでいる。デバッガ上でデバッグログなどを確認すれば、どのタイミングでDllMain()が呼ばれた、つまりロードされたかを確認出来る。
<br />
暗黙的リンク、明示的リンクでどのように転送先のDLL、今回ならdll02.dllがロードされるのかを比べてみる。
<br />
デバッガにはOllyDbgを使用している。
<br />
</p>

<dl>
<dt> 暗黙的リンクの場合 </dt>
<dd>暗黙的リンクを使ったmain_implicit.exeの場合、EXEがロードされて実行準備が整った段階で、dll01.dll, dll02.dllともにロードされた。</dd>
<dt> 明示的リンクの場合 </dt>
<dd>
<p class="paragraph">
main_explicit.exeの場合、dll01.dllは
<br />
</p>
<pre>hDll = LoadLibrary(&quot;dll01&quot;);
</pre>
<p class="paragraph">
の段階でロードされ、DllMain()が実行される。
<br />
</p>

<p class="paragraph">
dll02.dllは
<br />
</p>
<pre>funcB1 = (DLLFUNC)GetProcAddress(hDll, &quot;funcB1&quot;);
</pre>
<p class="paragraph">
の段階でロードされ、DllMain()が実行される。恐らく&quot;funcB1&quot;のエクスポートシンボルを解決する時にdll02.dllへの転送情報を見つけ、自動的にdll02.dllをロードしているものと思われる。
<br />
</p></dd>
</dl>

<p class="paragraph">
なお、当然であるが
<br />
</p>
<pre>funcA1 = (DLLFUNC)GetProcAddress(hDll, &quot;funcA1&quot;);
</pre>
<p class="paragraph">
は&quot;dll01.dll&quot;のメモリ空間上のアドレスを返し、
<br />
</p>
<pre>funcB1 = (DLLFUNC)GetProcAddress(hDll, &quot;funcB1&quot;);
</pre>
<p class="paragraph">
は&quot;dll02.dll&quot;のメモリ空間上のアドレスを返す。
<br />
</p>

<p class="paragraph">
&quot;dll01.dll&quot;上にdll02.dll, funcB2を呼ぶようなラッパコードが生成され、そのアドレスを返す訳ではない。
<br />
</p>

<h3 id="id73c60a">おまけ</h3>

<p class="paragraph">
dll01.cのバリエーションとして、以下のようなdll03.cを用意してみた：
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">windows.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">funcA1</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">a</span><span class="hl-code">, </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">b</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">OutputDebugString</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">funcA1() start</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">a</span><span class="hl-code"> + </span><span class="hl-identifier">b</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">funcB1</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">a</span><span class="hl-code">, </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">b</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">OutputDebugString</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">funcB1() start</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">a</span><span class="hl-code"> * </span><span class="hl-identifier">b</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
 
</span><span class="hl-identifier">BOOL</span><span class="hl-code"> </span><span class="hl-identifier">WINAPI</span><span class="hl-code"> </span><span class="hl-identifier">DllMain</span><span class="hl-brackets">(</span><span class="hl-identifier">HINSTANCE</span><span class="hl-code"> </span><span class="hl-identifier">hInstance</span><span class="hl-code">, </span><span class="hl-identifier">DWORD</span><span class="hl-code"> </span><span class="hl-identifier">dwReason</span><span class="hl-code">, </span><span class="hl-identifier">LPVOID</span><span class="hl-code"> </span><span class="hl-identifier">lpvReserved</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-reserved">switch</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">dwReason</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-reserved">case</span><span class="hl-code"> </span><span class="hl-identifier">DLL_PROCESS_ATTACH</span><span class="hl-code">:
        </span><span class="hl-identifier">OutputDebugString</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">dll01, DllMain() : DLL_PROCESS_ATTACH</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-reserved">case</span><span class="hl-code"> </span><span class="hl-identifier">DLL_THREAD_ATTACH</span><span class="hl-code">:
        </span><span class="hl-identifier">OutputDebugString</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">dll01, DllMain() : DLL_THREAD_ATTACH</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-reserved">case</span><span class="hl-code"> </span><span class="hl-identifier">DLL_THREAD_DETACH</span><span class="hl-code">:
        </span><span class="hl-identifier">OutputDebugString</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">dll01, DllMain() : DLL_THREAD_DETACH</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-reserved">case</span><span class="hl-code"> </span><span class="hl-identifier">DLL_PROCESS_DETACH</span><span class="hl-code">:
        </span><span class="hl-identifier">OutputDebugString</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">dll01, DllMain() : DLL_PROCESS_DETACH</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-reserved">default</span><span class="hl-code">:
        </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span >TRUE</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
モジュール定義(dll03.def)ファイルは次の通り:
<br />
</p>
<pre class="plugin_pre">
LIBRARY dll03
EXPORTS
    funcA1
    funcB1 = dll02.funcB2
</pre>

<p class="paragraph">
defファイルでは&quot;funcB1&quot;がdll02.funcB2に転送設定されるが、dll03.cの方でもfuncB1の実体がある。
<br />
どうなるか？
<br />
</p>
<pre>&gt; cl /c dll03.c
&gt; link /dll /def:dll03.def dll03.obj
dll03.def : error LNK2001: 外部シンボル &quot;funcB2&quot; は未解決です。
dll03.lib : fatal error LNK1120: 外部参照 1 が未解決です。
</pre>
<p class="paragraph">
・・・どうやらモジュール定義ファイルが優先され、dll02が必要になるらしい。
<br />
</p>
<pre class="plugin_pre">
&gt; link /dll /def:dll03.def dll03.obj dll02.lib
&gt;dumpbin /exports dll03.dll
...
     00000000 characteristics
    4C084189 time date stamp Fri Jun 04 08:58:01 2010
        0.00 version
           1 ordinal base
           2 number of functions
           2 number of names

    ordinal hint RVA      name

          1    0 00001000 funcA1
          2    1          funcB1 (forwarded to dll02.funcB2)
</pre>

<p class="paragraph">
ちなみに
<br />
</p>
<pre>int funcB1(int a, int b)
</pre>
<p class="paragraph">
を&quot;dllexport&quot;付で
<br />
</p>
<pre>int __declspec(dllexport) funcB1(int a, int b)
</pre>
<p class="paragraph">
としてみても、リンクの段階でdll02側に転送される。モジュール定義ファイルが優先される(らしい)。
<br />
</p>

<p class="paragraph">
以上、おまけでした。
<br />
</p>

<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-669.html" title="C言語系/memos/VC++/06, DLLの事前バインド(BindImageEx())">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-671.html" title="C言語系/memos/VC++/08, DLLの遅延読み込み(delay loading)">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-582.html" title="C言語系/memos/VC++">Up</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-478.html" title="C言語系">C言語系</a>&nbsp;]</li>
</ul>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/670<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2007 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>