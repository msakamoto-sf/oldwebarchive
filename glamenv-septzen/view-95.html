<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>技術/Java/Solaris10のサービス管理とLog4j-syslogd - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">技術/Java/Solaris10のサービス管理とLog4j-syslogd</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2006-07-02 14:19:21 &nbsp; / &nbsp; last updated at: 2009-04-04 10:20:51<br>
カテゴリ: <a href="category-11.html">Java</a>&nbsp;<a href="category-18.html">Solaris</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-81.html" title="技術/Java/PostgreSQLと文字コードメモ">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-105.html" title="技術/Java/Tomcat上でJSPをJDBでデバッグとか。">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-23.html" title="技術">技術</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
お仕事で、Javaからsyslogdにログ出力する必要が生じました。しかも、Solaris上のsyslogです。
<br />
Log4jのAppenderで、syslogのプロトコルを用いてネットワーク接続で出力するSyslogAppenderがあるとの事なので、Solaris10もどうにかインストールできましたので試してみました。
<br />
</p>

<ul><li><a href="#idf68791">実験用Javaソース</a><ul><li><a href="#id279dfa">test.log4j.SyslogSample.java</a></li>
<li><a href="#id053f43">log4j.properties</a></li></ul></li>
<li><a href="#id334b4f">実験用Solaris10+syslogd環境整備</a><ul><li><a href="#id5895fb">syslogd(というよりサービス)の再起動</a><ul><li><a href="#idddf6b1">起動中のサービスの一覧</a></li>
<li><a href="#idf59228">syslogの所属するサービスは何か？</a></li>
<li><a href="#id7b136f">プロセス名からサービス名(というのか？)を取得してみる。</a></li>
<li><a href="#id83d431">manページに載っている場合もある。</a></li>
<li><a href="#idc77513">サービスの状態と詳細を確認する。</a></li>
<li><a href="#id278bd0">syslogd再起動成功</a></li></ul></li>
<li><a href="#ida9545a">ミスその１</a></li>
<li><a href="#idd4d878">ミスその２</a></li>
<li><a href="#id407349">syslogdで外部接続を許可する。</a></li>
<li><a href="#id8bf0f3">成功</a></li></ul></li>
<li><a href="#id4ea72a">Log4j + syslogd(Solaris10)</a><ul><li><a href="#id9d3666">リモートのJavaより、syslogdに飛ばす。</a></li>
<li><a href="#id11ffc3">ローカルのJavaより、syslogdを飛ばす。</a></li></ul></li>
<li><a href="#id5cf597">結論</a></li></ul>
<hr />
<h3 id="idf68791">実験用Javaソース</h3>

<p class="paragraph">
log4j-1.2.13.jarを使用した。
<br />
</p>

<h4 id="id279dfa">test.log4j.SyslogSample.java</h4>
<pre>package test.log4j;

import org.apache.log4j.Logger;

public class SyslogSample {

	public static void main(String[] args) {

		Logger logger = Logger.getLogger(&quot;syslog&quot;);
		logger.debug(&quot;--debug--&quot;);
		logger.info(&quot;--info--&quot;);
		logger.warn(&quot;--warn--&quot;);
		logger.error(&quot;--error--&quot;);
		logger.fatal(&quot;--fatal--&quot;);
	}
}
</pre>

<h4 id="id053f43">log4j.properties</h4>
<pre>log4j.appender.syslog=org.apache.log4j.net.SyslogAppender
log4j.appender.syslog.Facility=local5
log4j.appender.syslog.SyslogHost=192.168.250.50
log4j.appender.syslog.FacilityPrinting=true
log4j.appender.syslog.layout=org.apache.log4j.PatternLayout
log4j.appender.syslog.layout.ConversionPattern=AA%5p %c{1} - %m%n
log4j.appender.console=org.apache.log4j.ConsoleAppender
log4j.rootLogger=console, syslog
</pre>

<h3 id="id334b4f">実験用Solaris10+syslogd環境整備</h3>

<p class="paragraph">
Solaris上でのsyslog設定やサービスの再起動は初めてだったので、色々と試行錯誤になってしまった。
<br />
ちなみに、ローカルでの確認はloggerコマンドを用いて次のようにした。
<br />
</p>
<pre>logger -p local5.notice -t HOGE abcdefg
</pre>

<h4 id="id5895fb">syslogd(というよりサービス)の再起動</h4>

<p class="paragraph">
Solaris10では、&quot;SMF(Service Management Facility)という機能により、様々なサービスの起動・停止・再起動・依存関係を統合して管理できるようになった。今回、設定ファイル変更に伴う再起動を行うsyslogdも、SMFを通じて再起動をする。
<br />
</p>

<h5 id="idddf6b1">起動中のサービスの一覧</h5>
<pre>[root@basara /]# svcs
STATE          STIME    FMRI
legacy_run     19:21:23 lrc:/etc/rcS_d/S50sk98sol
legacy_run     19:22:23 lrc:/etc/rc2_d/S10lu
...
online         22:21:37 svc:/system/system-log:default
offline        19:21:08 svc:/application/print/ipp-listener:default
offline        19:22:12 svc:/application/print/rfc1179:default
</pre>

<h5 id="idf59228">syslogの所属するサービスは何か？</h5>
<p class="paragraph">
通常なら次のコマンドであるプロセスを対象としているサービス名を取得できる。
<br />
</p>
<pre>[root@basara /]# svcs -p sendmail
STATE          STIME    FMRI
online         19:22:23 svc:/network/smtp:sendmail
               19:22:23      376 sendmail
               19:22:23      378 sendmail
</pre>
<p class="paragraph">
しかし、syslogdに関してはこれが利用できない。
<br />
</p>

<h5 id="id7b136f">プロセス名からサービス名(というのか？)を取得してみる。</h5>
<pre>[root@basara /]# svcs -p syslogd
svcs: パターン &#039;syslogd&#039; がどのインスタンスとも一致しません
STATE          STIME    FMRI
</pre>

<h5 id="id83d431">manページに載っている場合もある。</h5>
<p class="paragraph">
そこで、ふとsyslogdのmanを確認していると・・・
<br />
</p>
<pre>$ man syslogd
...
System Administration Commands                        syslogd(1M)

     svc:/system/system-log:default

    Administrative actions on this service,  such  as  enabling,
    disabling,  or  requesting  restart,  can be performed using
    svcadm(1M). The service&#039;s status can be  queried  using  the
    svcs(1) command.
</pre>

<h5 id="idc77513">サービスの状態と詳細を確認する。</h5>
<p class="paragraph">
というわけで、
<br />
</p>
<pre>[root@basara /]# svcs -l system/system-log:default
fmri         svc:/system/system-log:default
name         system log 
有効         true
状態         online
next_state   none
state_time   2006年07月02日 (日) 22時21分37秒
logfile      /var/svc/log/system-system-log:default.log
リスタータ   svc:/system/svc/restarter:default
contract_id  109 
dependency   require_all/none svc:/milestone/sysconfig (online)
dependency   require_all/none svc:/system/filesystem/local (online)
dependency   optional_all/none svc:/system/filesystem/autofs (online)
dependency   require_all/none svc:/milestone/name-services (online)
</pre>

<p class="paragraph">
これがsyslogdのようである。下記参照。
<br />
</p>
<ul><li> <a class="externallink" href="http://solaris-user.com/solaris10_smf/manual_smf.html" target="_blank">http://solaris-user.com/solaris10_smf/manual_smf.html</a></li></ul>

<h5 id="id278bd0">syslogd再起動成功</h5>
<p class="paragraph">
以上より、次のコマンドでsyslogdを再起動できた。
<br />
</p>
<pre># svcadm restart system/system-log:default
</pre>

<h4 id="ida9545a">ミスその１</h4>
<p class="paragraph">
まず、/etc/syslog.confに次のようなエントリを追加してみた。
<br />
</p>
<pre>local5.* /var/log/log4j.log
</pre>
<p class="paragraph">
以下の点で間違い。
<br />
</p>
<ol><li> レベルに&quot;*&quot;は使用不可。レベル大小によるマッチングがあるのだから、全てを出したいのであれば&quot;debug&quot;を使用する。</li>
<li> &quot;facility.level&quot;と、ファイル名との間がスペース。他のエントリを見てみると基本、TAB区切り。</li></ol>

<p class="paragraph">
ちなみに先の間違っているエントリを使用すると、次のようなログが/var/adm/messagesに出る。
<br />
</p>
<pre>Jul  2 22:10:06 basara syslogd: line 18: unknown priority name &quot;* /var/log/log4j.log&quot;
</pre>

<h4 id="idd4d878">ミスその２</h4>
<p class="paragraph">
ログファイルを作らずに、loggerコマンドなどで試してみたところ、/var/adm/messagesに以下のログが出力された。
<br />
</p>
<pre>Jul  2 22:18:07 basara syslogd: /var/log/log4j.log: ファイルもディレクトリもありません。
</pre>
<p class="paragraph">
そこでtouchで作成してみたところ、まだ上記ログが出る。syslogdを再起動してみたら直った。
<br />
</p>

<h4 id="id407349">syslogdで外部接続を許可する。</h4>
<p class="paragraph">
次のファイルで、外部接続の許可を制御できる。
<br />
</p>
<pre>/etc/default/syslogd
</pre>
<p class="paragraph">
デフォルトで「LOG_FORMAT_REMOTE=YES」がコメントアウトされており、また、それがデフォルトである。禁止したい場合はNOを設定する。今回はリモートのJavaからの出力を試みるので、デフォルトのママにしておく。
<br />
</p>

<h4 id="id8bf0f3">成功</h4>
<p class="paragraph">
上記の注意点を参考に、syslog.confの変更およびログファイルをtouchにより作成し、syslogdの再起動を行ったところ、loggerコマンドで以下のようなログを出力できた。
<br />
</p>
<pre># tail /var/log/log4j.log
Jul  2 22:19:20 basara HOGE: [ID 702911 local5.notice] abcdefg
</pre>

<h3 id="id4ea72a">Log4j + syslogd(Solaris10)</h3>

<h4 id="id9d3666">リモートのJavaより、syslogdに飛ばす。</h4>
<p class="paragraph">
以下に、実際に出力された模様を示す。
<br />
</p>
<pre># (このタイミングでWindows側のJavaからSyslogSampleを実行) 
Message from syslogd@[192.168.250.100.11.180] at Sun Jul  2 22:23:24 2006 ...
[192.168.250.100.11.180] local5:AAFATAL syslog - --fatal--^M

# tail /var/log/log4j.log
Jul  2 22:21:40 basara HOGE: [ID 702911 local5.notice] abcdefg
Jul  2 22:23:24 [192.168.250.100.11.180] local5:AADEBUG syslog - --debug--^M
Jul  2 22:23:24 [192.168.250.100.11.180] local5:AA INFO syslog - --info--^M
Jul  2 22:23:24 [192.168.250.100.11.180] local5:AA WARN syslog - --warn--^M
Jul  2 22:23:24 [192.168.250.100.11.180] local5:AAERROR syslog - --error--^M
Jul  2 22:23:24 [192.168.250.100.11.180] local5:AAFATAL syslog - --fatal--^M
</pre>
<p class="paragraph">
以下の点がローカルのloggerと異なっている。
<br />
</p>
<ol><li> リモートIPが記載される。</li>
<li> facilityの表記のみになっている。</li>
<li> Windows上のJavaから出力した為か、末尾改行で&quot;^M&quot;が付いてしまっている。</li>
<li> loggerコマンドの&quot;-t&quot;オプションに相当するパラメータが無い。</li></ol>

<h4 id="id11ffc3">ローカルのJavaより、syslogdを飛ばす。</h4>
<p class="paragraph">
log4j.propertiesを修正し、SyslogHostを&quot;localhost&quot;にしてSolaris10上で実行してみる。
<br />
</p>
<pre>[msakamoto@basara java]$  java -cp .:./lib/log4j-1.2.13.jar test.log4j.SyslogSample 
Message from syslogd@localhost at Sun Jul  2 22:58:05 2006 ...
localhost local5:AAFATAL syslog - --fatal--
</pre>
<p class="paragraph">
実行側のコンソールに、fatalメッセージが割り込んでいるのが分かる。これは正常である。
<br />
</p>
<pre># tail /var/log/log4j.log
Jul  2 22:58:05 localhost local5:AADEBUG syslog - --debug--
Jul  2 22:58:05 localhost local5:AA INFO syslog - --info--
Jul  2 22:58:05 localhost local5:AA WARN syslog - --warn--
Jul  2 22:58:05 localhost local5:AAERROR syslog - --error--
Jul  2 22:58:05 localhost local5:AAFATAL syslog - --fatal--
</pre>
<p class="paragraph">
こちらがsyslogdの出力しているログである。&quot;AA&quot;以降がJava側で指定しているメッセージフォーマットである。
<br />
</p>

<p class="paragraph">
やはり、ローカルのloggerとフォーマットが異なる。
<br />
</p>

<h3 id="id5cf597">結論</h3>

<p class="paragraph">
Log4jのSyslogAppender経由で出力するsyslogは、ローカルでloggerコマンドにより出力するログ形式とはフォーマットが異なる。
<br />
</p>

<p class="paragraph">
ただし、上記は自分で設定したfacilityに出力した場合であり、今回仕事ではuser.errorで固定で出力する。その場合は、まだ実験していない。
<br />
</p>

<hr />
<p class="paragraph">
余談だが、この実験を終えた後、「今日一日installからここまでずう～～っと動かしっぱなしだったな」と、風呂にはいるのを兼ねて一旦PCを落とした。
<br />
その後再起動し、VMwareからSolaris10を立ち上げたら<strong> ネットワークカードの初期化に失敗してるし。 </strong>
<br />
</p>

<p class="paragraph">
急いでグラフィカルログインから（こういうときがあるから迂闊にコンソールにできない。いや、単にLinuxでいうstartxに該当する手順を知らないだけなんだけど）、svcsを叩いてみたら<strong> 見事に network/physical:default が offline になってるし。 </strong>
<br />
</p>

<p class="paragraph">
あわてて /etc/inet/hosts, ipnodes を確認してみたら<strong> localhostだけになってて、自分で指定したホスト名のエントリがいつの間にか消去されてるし。 </strong>
<br />
</p>

<p class="paragraph">
・・・誰だ？自分じゃないはず。・・・まさか、Sun Studio 11とかそのパッチの影響か・・・？確かにSun Studio 11を入れた頃には一通り環境が整いつつあったので、再起動はかけていない。
<br />
</p>

<p class="paragraph">
とりあえず急いで、対応する.savedファイルを確認してホスト名のエントリを書き戻す。
<br />
</p>
<pre># svcadm enable -r network/physical:default
</pre>
<p class="paragraph">
をやろうとすると<span class="hidden">(</span><a class="footnote" href="#footnote_95_1" id="footnote_95_1_r"  title="-rというのはdependsするサービスもまとめて起動するオプション">*1</a><span class="hidden">)</span>、maintenanceモードに入っているからと怒られる。
<br />
ん？ひょっとして
<br />
</p>
<pre># svcadm reflesh network/physical:default
</pre>
<p class="paragraph">
したのがまずかったか？もう一度svcsしてみたら確かに&quot;maintenance&quot;と表示されてしまっている。
<br />
</p>
<pre># svcadm clear network/physical:default
</pre>
<p class="paragraph">
したらmaintenanceモードが消えたので、もう一度 enable してみる。
<br />
</p>

<p class="paragraph">
これで、ようやく&quot;online&quot;になってくれた・・・。念のため再起動かけてみると、無事指定しているIPアドレスが取得できたようで、SSHからもログインできた。
<br />
</p>

<p class="paragraph">
あ～～・・・焦った・・・。
<br />
</p>

<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-81.html" title="技術/Java/PostgreSQLと文字コードメモ">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-105.html" title="技術/Java/Tomcat上でJSPをJDBでデバッグとか。">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-23.html" title="技術">技術</a>&nbsp;]</li>
</ul><div class="footnote">
<a id="footnote_95_1" href="#footnote_95_1_r">*1</a>: -rというのはdependsするサービスもまとめて起動するオプション
</div>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/95<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2001 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a target="_blank" href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" target="_blank" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>