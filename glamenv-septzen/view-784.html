<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Assembler/ForFun(x86_32)/03, x86_32用 デバッグ機能有効化 Bochs をVC++2008でビルド - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">Assembler/ForFun(x86_32)/03, x86_32用 デバッグ機能有効化 Bochs をVC++2008でビルド</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2010-09-16 15:15:05 &nbsp; / &nbsp; last updated at: 2010-09-19 20:59:41<br>
カテゴリ: <a href="category-48.html">Assembler</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-783.html" title="Assembler/ForFun(x86_32)/02, 16bit DOS with NASM">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-785.html" title="Assembler/ForFun(x86_32)/04, 16bit BIOS with NASM">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-410.html" title="Assembler">Assembler</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
MBR以降のブートローダ周りのアセンブラプログラミングを楽しむのであれば、Windows/Linuxで動作するx86エミュレータ &quot;Bochs&quot; が便利です。Windows用のインストーラEXEをHPからダウンロード出来ます。
<br />
コンパイル時にデバッグ機能を有効化すると、BIOSが立ち上がる段階からステップ実行やレジスタ内容の確認が出来ます。Windows用のインストーラでセットアップするとデバッグ機能が有効化された&quot;bochsdbg.exe&quot;も同時にインストールされるので、わざわざコンパイルする必要もありません。
<br />
</p>

<ul><li> bochs: The Open Source IA-32 Emulation Project (Home Page)<ul><li> <a class="externallink" href="http://bochs.sourceforge.net/" target="_blank">http://bochs.sourceforge.net/</a></li></ul></li></ul>

<p class="paragraph">
ところが、2010年9月時点での最新版、2.4.5のWindowsバイナリはx86_64をエミュレートするようコンパイルされています(&quot;--enable-x86-64&quot;有効)。
<br />
x86の16bitや32bitの世界をBochsのデバッグ機能で楽しみたい場合は、&quot;--enable-x86-64&quot;を無効にして(&quot;--disable-x86-64&quot;)コンパイルする必要があります。
<br />
Linux/UNIX環境であればソースを展開して &quot;./configure&quot; で次のオプションを指定すればOKです。
<br />
</p>
<pre>--disable-x86-64
--enable-debugger
--enable-disasm
</pre>

<p class="paragraph">
本記事では Windows 環境の場合にBochs-2.4.5で上記オプションでビルドする手順を紹介します。
<br />
コンパイラは Visual C++ 2008 Express Edition SP1 を使います。Cygwin/MinGWのgccによるコンパイルは本記事では扱いません。
<br />
</p>



<hr />
<ul><li><a href="#idbececb">ツールの準備</a></li>
<li><a href="#idc4b2d3">ソースの準備と日本語キーボード用patchの適用</a></li>
<li><a href="#id7c0434">&quot;./configure&quot;とビルド</a></li>
<li><a href="#id61f544">インストール</a></li>
<li><a href="#idc036d0">動作確認</a></li></ul>
<hr />
<h3 id="idbececb">ツールの準備</h3>

<ul><li> Visual C++ 2008 Express Edition SP1 : コンパイラ・リンカとして使います。Microsoftのサイトからダウンロード出来ます。</li>
<li> MSYS + MinGW : &quot;./configure&quot;スクリプトを走らせる為のUNIX環境です。ネット上で検索して適宜インストールして下さい。</li></ul>

<p class="paragraph">
&quot;./configure&quot;スクリプトを走らせるのであればCygwin環境でもOKと思われます。とりあえず本記事ではMSYS + MinGW環境で&quot;./configure&quot;を実行します。
<br />
</p>

<h3 id="idc4b2d3">ソースの準備と日本語キーボード用patchの適用</h3>

<ul><li> bochs-2.4.5.tar.gz : Bochsのサイトからダウンロード出来ます。</li>
<li> がじぇっとぼっくす<ul><li> <a class="externallink" href="http://ebisa.hp.infoseek.co.jp/bochs/index.shtml" target="_blank">http://ebisa.hp.infoseek.co.jp/bochs/index.shtml</a><ul><li> JP106/109の文字化け修正patchが配布されていますので、ここから2.4.5用のzipを入手します。</li></ul></li></ul></li></ul>

<p class="paragraph">
1. 本家のtarボールを展開します。
<br />
</p>
<pre>例：c:\work\bochs-2.4.5\
                        README
                        Makefile.in
                        ...
</pre>

<p class="paragraph">
2. &quot;がじぇっとぼっくす&quot;からダウンロードしたzipを展開し、&quot;patch&quot;フォルダ中のpatchファイルを本家tarを展開した&quot;bochs-2.4.5&quot;と同じディレクトリに置きます。
<br />
</p>

<pre>例：c:\work\
            bochs-2.4.5-dbgfix-20100430.diff
            bochs-2.4.5-jpfix-20100430.diff
            bochs-2.4.5\
                        README
                        Makefile.in
                        ...
</pre>

<p class="paragraph">
3. MSYSコンソールを開いて、patchを適用します。
<br />
</p>
<pre>例：
$ cd /c/work

$ patch --dry-run -p0 -b  &lt; bochs-2.4.5-dbgfix-20100430.diff
(エラーや気になるメッセージが無ければ &quot;--dry-run&quot; を外す)
$ patch -p0 -b  &lt; bochs-2.4.5-dbgfix-20100430.diff

$ patch --dry-run -p0 -b  &lt; bochs-2.4.5-jpfix-20100430.diff
(エラーや気になるメッセージが無ければ &quot;--dry-run&quot; を外す)
$ patch -p0 -b  &lt; bochs-2.4.5-jpfix-20100430.diff
</pre>

<h3 id="id7c0434">&quot;./configure&quot;とビルド</h3>

<p class="paragraph">
1. &quot;bochs-2.4.5/.conf.win32-vcpp&quot; の &quot;./configure&quot; オプションを以下のように修正します。
<br />
</p>
<pre class="plugin_pre">
use_debugger=&quot;enable&quot;
use_a20=&quot;enable&quot;

./configure --target=pentium-windows \
 --enable-cpu-level=6 \
 --disable-shared \
 --disable-acpi \
 --disable-x86-64 \
 --disable-vmx \
 --disable-smp \
 --disable-3dnow \
 --disable-monitor-mwait \
 --disable-gameport \
 --disable-sb16 \
 --disable-usb \
 --enable-alignment-check \
 --enable-all-optimizations \
 --enable-pci \
 --enable-vbe \
 --enable-clgd54xx \
 --enable-cdrom \
 --enable-ne2000 \
 --enable-configurable-msrs \
 --$use_a20-a20-pin \
 --$use_debugger-x86-debugger \
 --$use_debugger-debugger \
 --$use_debugger-disasm \
 --$use_debugger-debugger-gui \
 --enable-iodebug \
 --enable-show-ips \
 --with-win32 \
 --with-rfb \
 --with-nogui
</pre>

<p class="paragraph">
オプションなどはお好みに応じて調整して下さい。但し次のオプションは必須なので省略しないで下さい。
<br />
</p>
<pre>use_debugger=&quot;enable&quot;
use_a20=&quot;enable&quot;
...
--target=pentium-windows      # VC++用
--disable-x86-64              # x86_64無効化
--$use_a20-a20-pin            # A20pin有効
--$use_debugger-x86-debugger  # 以降、デバッグ機能有効
--$use_debugger-debugger
--$use_debugger-disasm
--$use_debugger-debugger-gui
</pre>

<p class="paragraph">
2. MSYSコンソールで &quot;bochs-2.4.5&quot; のディレクトリにcdし、&quot;sh .conf.win32-vcpp&quot; を実行します。
<br />
</p>

<pre>$ cd /c/work/bochs-2.4.5
$ sh .conf.win32-vcpp
</pre>

<p class="paragraph">
3. &quot;Visual Studio 2008 コマンドプロンプト&quot;を開き &quot;bochs-2.4.5&quot; にcdし、nmakeを実行します。
<br />
</p>

<pre>&gt; cd C:\work\bochs-2.4.5
&gt; nmake
</pre>

<p class="paragraph">
NOTICE: &quot;Visual Studio 2008 コマンドプロンプト&quot; でなくとも、vcvars32.batなどで環境変数を調整したコマンドプロンプト上であればOKです。
<br />
</p>

<h3 id="id61f544">インストール</h3>

<p class="paragraph">
ビルドに成功すれば、&quot;bochs-2.4.5&quot;ディレクトリ上に以下のEXEが生成されます。
<br />
</p>
<pre>bochs.exe     ... Bochs本体
bxcommit.exe  ... flat HDD イメージファイルにredologを書き出すツール
bximage.exe   ... Bochs用のFD/HDDイメージファイル作成ツール
niclist.exe   ... NICインターフェイスのリストアップ
</pre>

<p class="paragraph">
bochs.exeを実行するには、仮想マシンの設定ファイル &quot;bochsrc&quot; やBIOS/VGABIOSファイルが必要です。
<br />
</p>

<p class="paragraph">
ここでちょっと手抜きをして、Bochsの実行用ディレクトリツリー一式を、本家からコピーしてしまいます。
<br />
</p>

<p class="paragraph">
1. 本家のWindows用インストーラを使ってセットアップします。
<br />
2. ビルドしたEXEで本家のEXEを上書きコピーします。
<br />
</p>

<p class="paragraph">
必要に応じて、上書きコピーする前に本家のEXEファイルをバックアップして下さい。
<br />
</p>

<p class="paragraph">
以上でdebug機能有効＋x86_32モードでのBochsでアセンブラプログラミングを楽しめるようになります。
<br />
</p>

<p class="paragraph">
なお「USBメモリで持ち運べるようにしたい」等の理由でインストールディレクトリをコピー＋本家の方はアンインストールしてしまう場合、BXSHARE環境変数を手動で設定する必要があるので注意して下さい。また、BXSHARE環境変数ではディレクトリセパレータを&quot;/&quot;で表記する必要があります。
<br />
</p>
<pre>ex:
&gt; set PATH=C:\work\bin\Bochs-2.4.5;%PATH%
&gt; set BXSHARE=C:/work/bin/Bochs-2.4.5
</pre>

<h3 id="idc036d0">動作確認</h3>

<p class="paragraph">
とりあえずBIOSが起動することを確認してみます。
<br />
以下のような&quot;.bxrc&quot;ファイルを用意します。
<br />
</p>

<p class="paragraph">
test.bxrc:
<br />
</p>
<pre>romimage: file=$BXSHARE/BIOS-bochs-latest 
vgaromimage: file=$BXSHARE/VGABIOS-lgpl-latest
megs: 16
floppya: 1_44=foobar, status=inserted
boot: floppy
</pre>

<p class="paragraph">
&quot;floppya&quot;で指定した&quot;foobar&quot;というイメージファイルは存在しませんので、BIOSブート後にエラーとなります。
<br />
とりあえずBochsがデバッグ機能有効で起動することを確認出来ればよいので、このまま&quot;test.bxrc&quot;ファイルを指定してBochsを起動します。
<br />
</p>
<pre class="plugin_pre">
&gt; bochs -q -f test.bxrc
========================================================================
                       Bochs x86 Emulator 2.4.5
              Build from CVS snapshot, on April 25, 2010
========================================================================
00000000000i[     ] reading configuration from test.bxrc
00000000000i[     ] installing win32 module as the Bochs GUI
00000000000i[     ] Bochs x86 Emulator 2.4.5
00000000000i[     ]   Build from CVS snapshot, on April 25, 2010
00000000000i[     ] System configuration
00000000000i[     ]   processors: 1 (cores=1, HT threads=1)
00000000000i[     ]   A20 line support: yes
00000000000i[     ] CPU configuration
00000000000i[     ]   level: 6
(...)
00000000000i[     ] set SIGINT handler to bx_debug_ctrlc_handler
Next at t=0
(0) context not implemented because BX_HAVE_MAP=0
[0xfffffff0] f000:fff0 (unk. ctxt): jmp far f000:e05b         ; ea5be000f0
&lt;bochs:1&gt;
</pre>
<p class="paragraph">
ここでデバッグ用のコマンドプロンプトが表示され、デバッグコマンドの入力待ちとなります。
<br />
試しにレジスタ群を表示させる&quot;r&quot;コマンドを実行してみます。
<br />
</p>
<pre class="plugin_pre">
&lt;bochs:1&gt; r
eax: 0x00000000 0
ecx: 0x00000000 0
edx: 0x00000f00 3840
ebx: 0x00000000 0
esp: 0x00000000 0
ebp: 0x00000000 0
esi: 0x00000000 0
edi: 0x00000000 0
eip: 0x0000fff0
eflags 0x00000002: id vip vif ac vm rf nt IOPL=0 of df if tf sf zf af pf cf
</pre>
<p class="paragraph">
EAX, EBX, ... とx86_32でお馴染みのレジスタ群が表示されました。本家バイナリなど&quot;--enable-x86-64&quot;でコンパイルされると、&quot;RAX, RBX, ...&quot;というふうにx86_64で拡張されたレジスタ群が表示されます。
<br />
</p>

<p class="paragraph">
続行するには&quot;c&quot;コマンドを実行します。その他のデバッグコマンドは&quot;help&quot;コマンドで調べることができます。
<br />
</p>
<pre class="plugin_pre">
&lt;bochs:2&gt; c
00000003305i[BIOS ] $Revision: 1.247 $ $Date: 2010/04/04 19:33:50 $
00000200000i[WGUI ] dimension update x=720 y=400 fontheight=16 fontwidth=9 bpp=8
00000318042i[KBD  ] reset-disable command received
00000444800i[VBIOS] VGABios $Id: vgabios.c,v 1.69 2009/04/07 18:18:20 vruppert Exp $
00000444871i[CLVGA] VBE known Display Interface b0c0
00000444903i[CLVGA] VBE known Display Interface b0c5
00000447828i[VBIOS] VBE Bios $Id: vbe.c,v 1.62 2009/01/25 15:46:25 vruppert Exp $
00000760517i[BIOS ] Starting rombios32
00000761014i[BIOS ] Shutdown flag 0
00000761697i[BIOS ] ram_size=0x01000000
00000762175i[BIOS ] ram_end=16MB
...
00013554880i[FDD  ] attempt to read/write sector 1 with media not present
00021536598i[FDD  ] controller reset in software
00021591573p[BIOS ] &gt;&gt;PANIC&lt;&lt; No bootable device.
</pre>
<p class="paragraph">
ここで表示が止まります。
<br />
Bochsのウインドウを見てみると、&quot;PANIC&quot;ダイアログが表示されますので、&quot;Kill simulation&quot;を選択して&quot;OK&quot;をクリックして終了します。
<br />
</p>
<pre class="plugin_pre">
========================================================================
Bochs is exiting with the following message:
[BIOS ] No bootable device.
========================================================================
00021591573i[CPU0 ] CPU is in real mode (active)
00021591573i[CPU0 ] CS.d_b = 16 bit
00021591573i[CPU0 ] SS.d_b = 16 bit
00021591573i[CPU0 ] | EAX=0000040a  EBX=0000cd04  ECX=00000004  EDX=00000402
00021591573i[CPU0 ] | ESP=0000ffa8  EBP=0000ffac  ESI=000e32f8  EDI=0000ffac
00021591573i[CPU0 ] | IOPL=0 id vip vif ac vm rf nt of df if tf sf ZF af PF cf
00021591573i[CPU0 ] | SEG selector     base    limit G D
00021591573i[CPU0 ] | SEG sltr(index|ti|rpl)     base    limit G D
00021591573i[CPU0 ] |  CS:f000( 0004| 0|  0) 000f0000 0000ffff 0 0
00021591573i[CPU0 ] |  DS:0000( 0005| 0|  0) 00000000 0000ffff 0 0
00021591573i[CPU0 ] |  SS:0000( 0005| 0|  0) 00000000 0000ffff 0 0
00021591573i[CPU0 ] |  ES:07c0( 0005| 0|  0) 00007c00 0000ffff 0 0
00021591573i[CPU0 ] |  FS:0000( 0005| 0|  0) 00000000 0000ffff 0 0
00021591573i[CPU0 ] |  GS:0000( 0005| 0|  0) 00000000 0000ffff 0 0
00021591573i[CPU0 ] | EIP=00000560 (0000055f)
00021591573i[CPU0 ] | CR0=0x60000010 CR2=0x00000000
00021591573i[CPU0 ] | CR3=0x00000000 CR4=0x00000000
(0).[21591573] [0x000f055f] f000:055f (unk. ctxt): out dx, al                ; ee
00021591573i[CMOS ] Last time is 1284617497 (Thu Sep 16 15:11:37 2010)
# In bx_win32_gui_c::exit(void)!
00021591573i[CTRL ] quit_sim called with exit code 1

&gt;
</pre>

<p class="paragraph">
以上で、x86_32bit + デバッグ機能有効化されたBochsを動かせるようになりました。
<br />
</p>

<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-783.html" title="Assembler/ForFun(x86_32)/02, 16bit DOS with NASM">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-785.html" title="Assembler/ForFun(x86_32)/04, 16bit BIOS with NASM">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-790.html" title="Assembler/ForFun(x86_32)">Up</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-410.html" title="Assembler">Assembler</a>&nbsp;]</li>
</ul>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/784<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2001 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a target="_blank" href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" target="_blank" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>