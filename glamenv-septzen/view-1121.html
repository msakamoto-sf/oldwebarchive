<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Java/jarファイルの配布と実行方式 - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">Java/jarファイルの配布と実行方式</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2012-11-04 17:37:03 &nbsp; / &nbsp; last updated at: 2013-07-28 15:38:48<br>
カテゴリ: <a href="category-11.html">Java</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-1452.html" title="Java/diff(差分検出アルゴリズム)のJava実装調査メモ">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-826.html" title="Java/「Javaデザインパターン徹底攻略」読書メモ">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-457.html" title="Java">Java</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
実行可能なJavaプログラムをjarファイルで配布する場合、その形態として次の2方式をよく見かけます。
<br />
</p>
<ul><li> &quot;-jar ほげほげ.jar&quot;で実行可能な単一jarファイルでの配布 : GUIのJavaアプリで時々見かけます。OSによってはjarファイルをダブルクリックするだけで実行できるので非常にお手軽です。</li>
<li> 依存jarと、それらをclasspathに自動的に追加して実行してくれる起動スクリプト(.bat, .sh)がzipやtar.gzで一緒に配布される : 依存jarが存在する、Tomcatなどサーバ系の配布でよく目にします。</li></ul>

<p class="paragraph">
本記事ではこれらの配布と実行方式の実現方法について調べてみました。
<br />
</p>

<ul><li> サンプルコード：<ul><li> <a class="externallink" href="https://github.com/msakamoto-sf/jar-deployment-examples" target="_blank">https://github.com/msakamoto-sf/jar-deployment-examples</a></li></ul></li>
<li> JDK 1.7(64bit), Maven 3.0.4, Win7SP1(日本語版)64bit, MacOSX(10.7)64bit にてコンパイル・動作確認しています。</li></ul>



<hr />
<ul><li><a href="#ida3bee8">step1 : MANIFEST.MFを使って&quot;-jar&quot;で実行可能なjarファイルを作成する(依存jar無しの超シンプル版)</a><ul><li><a href="#idb4ca26">シンプルなJavaプロジェクト(.javaを手動でコンパイル、jarファイルも手動で作成)</a></li>
<li><a href="#idf64a71">Mavenプロジェクトで&quot;Main-Class&quot;属性を指定してみる</a></li></ul></li>
<li><a href="#id050ce8">step2 : MANIFEST.MFを使って&quot;-jar&quot;で実行可能なjarファイルを作成する(依存jar有り版)</a><ul><li><a href="#id214448">マニフェスト・ファイルののClass-Path属性の基本</a></li>
<li><a href="#ideae6e1">MavenでのClass-Path属性の指定と依存jarの集約</a></li>
<li><a href="#id5979b2">maven-assembly-pluginを使った依存jarのパッケージング</a></li></ul></li>
<li><a href="#id6f397f">コーヒーブレイク：step1-2までの参考資料</a></li>
<li><a href="#idacfc6b">step3 : batやshでjarファイルのリストを取り出しclasspathを調整する</a><ul><li><a href="#id286cd4">Windowsのbatでclasspathを調整する</a></li>
<li><a href="#id878f66">unixのsh(bash)でclasspathを調整する</a></li></ul></li>
<li><a href="#idbf43cb">step4 : Maven Application Assemblerを使う</a></li>
<li><a href="#id370509">stepX(おまけ) : 複数のjarを1つのjarに統合する各種技術</a></li></ul>
<hr />
<h3 id="ida3bee8">step1 : MANIFEST.MFを使って&quot;-jar&quot;で実行可能なjarファイルを作成する(依存jar無しの超シンプル版)</h3>

<p class="paragraph">
まずは一番シンプルな形態として、依存jarが無い状態で&quot;-jar&quot;で実行可能なjarファイルを作成してみます。
<br />
</p>

<h4 id="idb4ca26">シンプルなJavaプロジェクト(.javaを手動でコンパイル、jarファイルも手動で作成)</h4>

<p class="paragraph">
Hello.java:
<br />
</p>
<pre class="plugin_pre">
public class Hello {
    public static void main(String[] args) {
        System.out.println(&quot;Hello&quot;);
    }
}
</pre>
<p class="paragraph">
コンパイル＆実行：
<br />
</p>
<pre>$ javac Hello.java
$ java Hello
Hello
</pre>

<p class="paragraph">
単純にjarファイルを作成して実行してみます：
<br />
</p>
<pre class="plugin_pre">
$ jar cf hello-nomf.jar -C hello .

$ jar tf hello-nomf.jar
META-INF/
META-INF/MANIFEST.MF
Hello.class
Hello.java

$ java -cp hello-nomf.jar Hello
Hello
</pre>

<p class="paragraph">
このjarファイルを実行可能にするには、マニフェスト・ファイルの&quot;Main-Class&quot;属性にmain()を実行するクラス名を指定します。
<br />
以下のようなテキストファイルを用意します。最後の空行は必須です。
<br />
hello.mf:
<br />
</p>
<pre>Main-Class: Hello

</pre>

<p class="paragraph">
jar作成＆実行:
<br />
</p>
<pre>$ jar cmf hello.mf hello-mf.jar -C hello .
$ java -jar hello-mf.jar
Hello
</pre>
<p class="paragraph">
正常に&quot;-jar&quot;だけで実行できました。展開して中身を確認してみます。
<br />
</p>
<pre>$ jar xf hello-mf.jar META-INF/MANIFEST.MF
$ cat META-INF/MANIFEST.MF
Manifest-Version: 1.0
Created-By: 1.7.0_07 (Oracle Corporation)
Main-Class: Hello
</pre>

<h4 id="idf64a71">Mavenプロジェクトで&quot;Main-Class&quot;属性を指定してみる</h4>

<p class="paragraph">
MavenプロジェクトでMain-Class属性を指定してみます。
<br />
</p>

<p class="paragraph">
quickstartを使ってMavenプロジェクトを生成：
<br />
</p>
<pre class="plugin_pre">
$ mvn archetype:generate -DarchetypeArtifactId=maven-archetype-quickstart
...
Define value for property &#039;groupId&#039;: : step1-mf-mvn
Define value for property &#039;artifactId&#039;: : step1-mf-mvn
Define value for property &#039;version&#039;:  1.0-SNAPSHOT: :
Define value for property &#039;package&#039;:  step1-mf-mvn: : step1
Confirm properties configuration:
groupId: step1-mf-mvn
artifactId: step1-mf-mvn
version: 1.0-SNAPSHOT
package: step1
...


$ cat ./src/main/java/step1/App.java
package step1;

/**
 * Hello world!
 *
 */
public class App
{
    public static void main( String[] args )
    {
        System.out.println( &quot;Hello World!&quot; );
    }
}
</pre>

<p class="paragraph">
Main-Class属性を指定するには、maven-jar-pluginの&quot;&lt;archive&gt;&quot; -&gt; &quot;&lt;manifest&gt;&quot; -&gt; &quot;&lt;mainClass&gt;&quot;に指定します。
<br />
pom.xml抜粋：
<br />
</p>
<pre class="plugin_pre">
...
  &lt;build&gt;
    &lt;plugins&gt;
      &lt;plugin&gt;
        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
        &lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt;
        &lt;configuration&gt;
          &lt;archive&gt;
            &lt;manifest&gt;
              &lt;mainClass&gt;step1.App&lt;/mainClass&gt;
            &lt;/manifest&gt;
          &lt;/archive&gt;
        &lt;/configuration&gt;
      &lt;/plugin&gt;
    &lt;/plugins&gt;
  &lt;/build&gt;
...
</pre>

<p class="paragraph">
ビルド＆実行：
<br />
</p>
<pre>$ mvn package

$ java -jar target/step1-mf-mvn-1.0-SNAPSHOT.jar
Hello World!
</pre>

<p class="paragraph">
実際のMANIFEST.MFファイルの中身：
<br />
</p>
<pre class="plugin_pre">
$ jar xf target/step1-mf-mvn-1.0-SNAPSHOT.jar META-INF/MANIFEST.MF
$ cat META-INF/MANIFEST.MF
Manifest-Version: 1.0
Archiver-Version: Plexus Archiver
Created-By: Apache Maven
Built-By: FengJing
Build-Jdk: 1.7.0_07
Main-Class: step1.App
</pre>


<h3 id="id050ce8">step2 : MANIFEST.MFを使って&quot;-jar&quot;で実行可能なjarファイルを作成する(依存jar有り版)</h3>

<p class="paragraph">
step1では依存jarが無い、一番シンプルな形で確認しました。step2では、依存jarが存在する、より現実的な場合での対応方法を試してみます。
<br />
</p>

<h4 id="id214448">マニフェスト・ファイルののClass-Path属性の基本</h4>

<p class="paragraph">
マニフェスト・ファイルでは、&quot;Class-Path&quot;属性を使ってjarファイルの配置場所からの相対パスでclasspathに通したいjarを指定することが可能です。
<br />
</p>

<p class="paragraph">
サンプル:
<br />
</p>
<pre class="plugin_pre">
step2-with-jar/
  depjars-src/
    depjar1/Lib1.java, Lib1.class
    depjar2/Lib2.java, Lib2.class
  depjars-lib/
    depjar1.jar
    depjar2.jar
  Hello.java
  hello.mf
</pre>

<p class="paragraph">
Hello.javaは以下の様な内容で、depjar1.jar中の&quot;depjar1.Lib1&quot;およびdepjar2.jar中の&quot;depjar2.Lib2&quot;に依存しています。
<br />
</p>
<div class="hl-main"><pre><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">depjar1</span><span class="hl-code">.</span><span class="hl-identifier">Lib1</span><span class="hl-code">;
</span><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">depjar2</span><span class="hl-code">.</span><span class="hl-identifier">Lib2</span><span class="hl-code">;
 
</span><span class="hl-reserved">public</span><span class="hl-code"> </span><span class="hl-reserved">class</span><span class="hl-code"> </span><span class="hl-identifier">Hello</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-reserved">public</span><span class="hl-code"> </span><span >static</span><span class="hl-code"> </span><span >void</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span class="hl-identifier">String</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-code"> </span><span class="hl-identifier">args</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">a</span><span class="hl-code"> = </span><span class="hl-number">5</span><span class="hl-code">;
        </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">b</span><span class="hl-code"> = </span><span class="hl-number">3</span><span class="hl-code">;
        </span><span class="hl-identifier">System</span><span class="hl-code">.</span><span class="hl-identifier">out</span><span class="hl-code">.</span><span class="hl-identifier">println</span><span class="hl-brackets">(</span><span class="hl-identifier">Lib1</span><span class="hl-code">.</span><span class="hl-identifier">calc</span><span class="hl-brackets">(</span><span class="hl-identifier">a</span><span class="hl-code">, </span><span class="hl-identifier">b</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">System</span><span class="hl-code">.</span><span class="hl-identifier">out</span><span class="hl-code">.</span><span class="hl-identifier">println</span><span class="hl-brackets">(</span><span class="hl-identifier">Lib2</span><span class="hl-code">.</span><span class="hl-identifier">calc</span><span class="hl-brackets">(</span><span class="hl-identifier">a</span><span class="hl-code">, </span><span class="hl-identifier">b</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-brackets">}</span></pre></div>
<p class="paragraph">
コンパイル：
<br />
</p>
<pre>$ cd step2-with-jar/
$ javac -cp .:depjars-src Hello.java
</pre>

<p class="paragraph">
マニフェスト・ファイルとして以下の内容を作成し、hello.mfとして保存し、jar作成時に指定します。
<br />
hello.mf:
<br />
</p>
<pre>Main-Class: Hello
Class-Path: ./depjars-lib/depjar1.jar ./depjars-lib/depjar2.jar
</pre>

<p class="paragraph">
jarを作成し、実行します。Class-Path属性により、jarファイルからの相対パスで&quot;depjars-lib&quot;以下のjarファイルが参照され、正常に実行されました。
<br />
</p>
<pre>$ jar cmf hello.mf hello.jar Hello.class
$ jar tf hello.jar
META-INF/
META-INF/MANIFEST.MF
Hello.class
$ java -jar hello.jar
8
2
</pre>

<h4 id="ideae6e1">MavenでのClass-Path属性の指定と依存jarの集約</h4>

<p class="paragraph">
Mavenでもマニフェスト・ファイルのClass-Path属性を設定できます。&quot;mainClass&quot;を設定した時と同様、Maven Archiverの提供する&quot;addClasspath&quot;設定を使うことで、Maven側で依存しているjarを自動的にClass-Path属性にまとめてくれます。
<br />
</p>

<p class="paragraph">
step2-mvn1/pom.xml:
<br />
</p>
<pre class="plugin_pre">
&lt;project ...&gt;
  ...
  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;commons-logging&lt;/groupId&gt;
      &lt;artifactId&gt;commons-logging&lt;/artifactId&gt;
      &lt;version&gt;1.1.1&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;commons-lang&lt;/groupId&gt;
      &lt;artifactId&gt;commons-lang&lt;/artifactId&gt;
      &lt;version&gt;2.6&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;junit&lt;/groupId&gt;
      &lt;artifactId&gt;junit&lt;/artifactId&gt;
      &lt;version&gt;3.8.1&lt;/version&gt;
      &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;
  &lt;/dependencies&gt;
  &lt;build&gt;
    &lt;plugins&gt;
      &lt;plugin&gt;
        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
        &lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt;
        &lt;configuration&gt;
          &lt;archive&gt;
            &lt;manifest&gt;
              &lt;mainClass&gt;step2.App&lt;/mainClass&gt;
              &lt;!-- Class-Path属性の自動設定 --&gt;
              &lt;addClasspath&gt;true&lt;/addClasspath&gt;
              &lt;!-- Class-Path属性で&quot;lib/&quot;などprefixを付けたい時に指定 --&gt;
              &lt;classpathPrefix&gt;lib&lt;/classpathPrefix&gt;
            &lt;/manifest&gt;
          &lt;/archive&gt;
        &lt;/configuration&gt;
      &lt;/plugin&gt;
    &lt;/plugins&gt;
  &lt;/build&gt;
&lt;/project&gt;
</pre>

<p class="paragraph">
src/main/java/step2/App.java:
<br />
</p>
<div class="hl-main"><pre><span class="hl-reserved">package</span><span class="hl-code"> </span><span class="hl-identifier">step2</span><span class="hl-code">;
</span><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">org</span><span class="hl-code">.</span><span class="hl-identifier">apache</span><span class="hl-code">.</span><span class="hl-identifier">commons</span><span class="hl-code">.</span><span class="hl-identifier">logging</span><span class="hl-code">.</span><span class="hl-identifier">Log</span><span class="hl-code">;
</span><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">org</span><span class="hl-code">.</span><span class="hl-identifier">apache</span><span class="hl-code">.</span><span class="hl-identifier">commons</span><span class="hl-code">.</span><span class="hl-identifier">logging</span><span class="hl-code">.</span><span class="hl-identifier">LogFactory</span><span class="hl-code">;
</span><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">org</span><span class="hl-code">.</span><span class="hl-identifier">apache</span><span class="hl-code">.</span><span class="hl-identifier">commons</span><span class="hl-code">.</span><span class="hl-identifier">lang</span><span class="hl-code">.</span><span class="hl-identifier">WordUtils</span><span class="hl-code">;
 
</span><span class="hl-reserved">public</span><span class="hl-code"> </span><span class="hl-reserved">class</span><span class="hl-code"> </span><span class="hl-identifier">App</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span >static</span><span class="hl-code"> </span><span class="hl-identifier">Log</span><span class="hl-code"> </span><span class="hl-identifier">log</span><span class="hl-code"> = </span><span class="hl-identifier">LogFactory</span><span class="hl-code">.</span><span class="hl-identifier">getLog</span><span class="hl-brackets">(</span><span class="hl-identifier">App</span><span class="hl-code">.</span><span class="hl-reserved">class</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">public</span><span class="hl-code"> </span><span >static</span><span class="hl-code"> </span><span >void</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span class="hl-code"> </span><span class="hl-identifier">String</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-code"> </span><span class="hl-identifier">args</span><span class="hl-code"> </span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">log</span><span class="hl-code">.</span><span class="hl-identifier">fatal</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">fatal log sample</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">log</span><span class="hl-code">.</span><span class="hl-identifier">error</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">error log sample</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">log</span><span class="hl-code">.</span><span class="hl-identifier">warn</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">warn log sample</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">log</span><span class="hl-code">.</span><span class="hl-identifier">info</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">info log sample</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">log</span><span class="hl-code">.</span><span class="hl-identifier">debug</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">debug log sample</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">log</span><span class="hl-code">.</span><span class="hl-identifier">trace</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">trace log sample</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">System</span><span class="hl-code">.</span><span class="hl-identifier">out</span><span class="hl-code">.</span><span class="hl-identifier">println</span><span class="hl-brackets">(</span><span class="hl-identifier">WordUtils</span><span class="hl-code">.</span><span class="hl-identifier">swapCase</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">Hello World!</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
パッケージングして、マニフェスト・ファイルを確認してみます。
<br />
</p>
<pre>$ mvn package
$ jar xf target/step2-mvn1-1.0-SNAPSHOT.jar META-INF/MANIFEST.MF
$ cat META-INF/MANIFEST.MF
Manifest-Version: 1.0
Archiver-Version: Plexus Archiver
Created-By: Apache Maven
Built-By: FengJing
Build-Jdk: 1.7.0_07
Main-Class: step2.App
Class-Path: lib/commons-logging-1.1.1.jar lib/commons-lang-2.6.jar
</pre>

<p class="paragraph">
commons-loggingとcommons-langの依存jarがClass-Path属性に指定されていることが確認されます。
<br />
しかし、この段階ではまだ&quot;lib/&quot;ディレクトリ自体がまだ存在しないので実行できいません。&quot;lib/&quot;ディレクトリを作成し、依存jarを集約するにはmaven-dependency-pluginのcopy-dependenciesゴールを使います。
<br />
</p>

<pre>$ mvn dependency:copy-dependencies -DoutputDirectory=target/lib -DincludeScope=compile
... &quot;outputDirectory&quot;で&quot;target/lib&quot;以下にコピー
... &quot;includeScope&quot;で&quot;compile&quot;スコープの依存jarのみをコピー
</pre>

<p class="paragraph">
この時点で以下のようなjar構成になります。
<br />
</p>
<pre>step2-mvn1/target/
  step2-mvn1-1.0-SNAPSHOT.jar
  lib/
    commons-lang-2.6.jar
    commons-logging-1.1.1.jar
</pre>
<p class="paragraph">
準備出来ましたので、実行してみます。
<br />
</p>
<pre>$ java -jar target/step2-mvn1-1.0-SNAPSHOT.jar
11 04, 2012 12:38:24 午後 step2.App main
SEVERE: fatal log sample
11 04, 2012 12:38:24 午後 step2.App main
SEVERE: error log sample
11 04, 2012 12:38:24 午後 step2.App main
WARNING: warn log sample
11 04, 2012 12:38:24 午後 step2.App main
情報: info log sample
hELLO wORLD!
</pre>

<p class="paragraph">
うまく動作してくれました。
<br />
</p>

<h4 id="id5979b2">maven-assembly-pluginを使った依存jarのパッケージング</h4>

<p class="paragraph">
上で紹介した &quot;dependency:copy-dependencies&quot; はあくまでもmvnコマンドが実行できる開発環境に限定されます。実際に配布する場合はzipやtar.gzなどにパッケージングすることになり、Mavenの場合ではmaven-assembly-pluginを使って依存jarのパッケージングを自動化できます。
<br />
</p>

<p class="paragraph">
step2-mvn1のMavenプロジェクトを &quot;step2-mvn2&quot; にコピーして、pom.xmlを以下のようにします。
<br />
step2-mvn2/pom.xml:
<br />
</p>
<pre class="plugin_pre">
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
  xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd&quot;&gt;
  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
  &lt;groupId&gt;step2-mvn2&lt;/groupId&gt;
  &lt;artifactId&gt;step2-mvn2&lt;/artifactId&gt;
  &lt;packaging&gt;jar&lt;/packaging&gt;
  &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
  &lt;name&gt;step2-mvn2&lt;/name&gt;
  &lt;url&gt;http://maven.apache.org&lt;/url&gt;
  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;commons-logging&lt;/groupId&gt;
      &lt;artifactId&gt;commons-logging&lt;/artifactId&gt;
      &lt;version&gt;1.1.1&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;commons-lang&lt;/groupId&gt;
      &lt;artifactId&gt;commons-lang&lt;/artifactId&gt;
      &lt;version&gt;2.6&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;junit&lt;/groupId&gt;
      &lt;artifactId&gt;junit&lt;/artifactId&gt;
      &lt;version&gt;3.8.1&lt;/version&gt;
      &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;
  &lt;/dependencies&gt;
  &lt;build&gt;
    &lt;plugins&gt;
      &lt;plugin&gt;
        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
        &lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt;
        &lt;configuration&gt;
          &lt;archive&gt;
            &lt;manifest&gt;
              &lt;mainClass&gt;step2.App&lt;/mainClass&gt;
              &lt;!-- Class-Path属性を指定します。 --&gt;
              &lt;addClasspath&gt;true&lt;/addClasspath&gt;
              &lt;!--
                maven-assembly-pluginのデフォルトでは、
                artifactのjar自体も依存jarと同じディレクトリに
                まとめられますので、あえてclasspathPrefix
                は指定せず、アプリのjarと同じ場所に
                依存jarがあるものとします。
              --&gt;
            &lt;/manifest&gt;
          &lt;/archive&gt;
        &lt;/configuration&gt;
      &lt;/plugin&gt;
      &lt;plugin&gt;
        &lt;artifactId&gt;maven-assembly-plugin&lt;/artifactId&gt;
        &lt;version&gt;2.3&lt;/version&gt;
        &lt;configuration&gt;
          &lt;descriptors&gt;
            &lt;descriptor&gt;src/assemble/bin.xml&lt;/descriptor&gt;
          &lt;/descriptors&gt;
        &lt;/configuration&gt;
        &lt;executions&gt;
          &lt;execution&gt;
            &lt;id&gt;make-assembly&lt;/id&gt;
            &lt;phase&gt;package&lt;/phase&gt;
            &lt;goals&gt;
              &lt;goal&gt;single&lt;/goal&gt;
            &lt;/goals&gt;
          &lt;/execution&gt;
        &lt;/executions&gt;
      &lt;/plugin&gt;
    &lt;/plugins&gt;
  &lt;/build&gt;
&lt;/project&gt;
</pre>

<p class="paragraph">
maven-assembly-pluginは配布用のパッケージの&quot;assemble&quot;に利用されます。設定が複雑になりがちなこともあり、詳細な設定を外部の&quot;descriptor&quot; XMLファイルに記載し、pom.xmlではdescriptor XMLファイルの場所だけを指定しています。
<br />
</p>

<p class="paragraph">
step2-mvn2/src/assemble/bin.xml:
<br />
</p>
<pre class="plugin_pre">
&lt;assembly&gt;
  &lt;id&gt;bin&lt;/id&gt;
  &lt;formats&gt;
    &lt;!-- 今回は&quot;&lt;format&gt;&quot;としてtar.gz, tar.bz2, zipの3種類を指定します。 --&gt;
    &lt;format&gt;tar.gz&lt;/format&gt;
    &lt;format&gt;tar.bz2&lt;/format&gt;
    &lt;format&gt;zip&lt;/format&gt;
  &lt;/formats&gt;
  &lt;dependencySets&gt;
    &lt;dependencySet&gt;
      &lt;!-- artifact自身のjarを含め、依存jarをパッケージの直下に配置します。 --&gt;
      &lt;outputDirectory&gt;/&lt;/outputDirectory&gt;
      &lt;includes&gt;
        &lt;!-- 集約する対象は依存する&quot;jar&quot;のみにします。 --&gt;
        &lt;include&gt;*:jar&lt;/include&gt;
      &lt;/includes&gt;
    &lt;/dependencySet&gt;
  &lt;/dependencySets&gt;
&lt;/assembly&gt;
</pre>

<pre>$ mvn package
...
[INFO] Building tar: .../
[INFO] Building tar: .../target/step2-mvn2-1.0-SNAPSHOT-bin.tar.gz
[INFO] Building tar: .../target/step2-mvn2-1.0-SNAPSHOT-bin.tar.bz2
[INFO] Building zip: .../target/step2-mvn2-1.0-SNAPSHOT-bin.zip
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
</pre>

<p class="paragraph">
試しにtar.gzを適当なディレクトリに展開してみます。
<br />
</p>
<pre>$ tar zxf step2-mvn2-1.0-SNAPSHOT-bin.tar.gz
$ find .
.
./step2-mvn2-1.0-SNAPSHOT
./step2-mvn2-1.0-SNAPSHOT/commons-lang-2.6.jar
./step2-mvn2-1.0-SNAPSHOT/commons-logging-1.1.1.jar
./step2-mvn2-1.0-SNAPSHOT/step2-mvn2-1.0-SNAPSHOT.jar
./step2-mvn2-1.0-SNAPSHOT-bin.tar.gz
</pre>
<p class="paragraph">
実行してみます。
<br />
</p>
<pre class="plugin_pre">
$ cd ./step2-mvn2-1.0-SNAPSHOT
$ java -jar step2-mvn2-1.0-SNAPSHOT.jar
11 04, 2012 2:37:04 午後 step2.App main
SEVERE: fatal log sample
11 04, 2012 2:37:04 午後 step2.App main
SEVERE: error log sample
11 04, 2012 2:37:04 午後 step2.App main
WARNING: warn log sample
11 04, 2012 2:37:04 午後 step2.App main
情報: info log sample
hELLO wORLD!
</pre>

<p class="paragraph">
問題なく動作しています。これで、tarやzipなどで依存jarも含めて配布できるようになりました。
<br />
</p>

<h3 id="id6f397f">コーヒーブレイク：step1-2までの参考資料</h3>

<ul><li> JAR ファイルの仕様<ul><li> <a class="externallink" href="http://docs.oracle.com/javase/jp/6/technotes/guides/jar/jar.html" target="_blank">http://docs.oracle.com/javase/jp/6/technotes/guides/jar/jar.html</a></li></ul></li>
<li> Jarファイルメモ(Hishidama&#039;s java-archive Memo)<ul><li> <a class="externallink" href="http://www.ne.jp/asahi/hishidama/home/tech/java/jar.html" target="_blank">http://www.ne.jp/asahi/hishidama/home/tech/java/jar.html</a></li></ul></li>
<li> [Maven2][Java]Maven2で作ったjarプロジェクトを簡単に実行する - SOSOG<ul><li> <a class="externallink" href="http://d.hatena.ne.jp/yosisa/20110106" target="_blank">http://d.hatena.ne.jp/yosisa/20110106</a></li></ul></li>
<li> Maven Archiver<ul><li> <a class="externallink" href="http://maven.apache.org/shared/maven-archiver/" target="_blank">http://maven.apache.org/shared/maven-archiver/</a><ul><li> maven-jar-pluginなど、jarにアーカイブするときに使われているコンポーネントで、マニフェスト・ファイルの設定方法などはこちらにまとめられています。</li></ul></li></ul></li>
<li> Set Up The Classpath<ul><li> <a class="externallink" href="http://maven.apache.org/shared/maven-archiver/examples/classpath.html" target="_blank">http://maven.apache.org/shared/maven-archiver/examples/classpath.html</a><ul><li> maven-jar-pluginを使ってClass-Path属性を設定する基本的なサンプルが紹介されています。</li></ul></li></ul></li>
<li> Maven JAR Plugin<ul><li> <a class="externallink" href="http://maven.apache.org/plugins/maven-jar-plugin/" target="_blank">http://maven.apache.org/plugins/maven-jar-plugin/</a></li></ul></li>
<li> 今まで知らなかった 5 つの事項: JAR<ul><li> <a class="externallink" href="http://www.ibm.com/developerworks/jp/java/library/j-5things6.html" target="_blank">http://www.ibm.com/developerworks/jp/java/library/j-5things6.html</a></li></ul></li>
<li> JAR files revealed<ul><li> <a class="externallink" href="http://www.ibm.com/developerworks/library/j-jar/index.html" target="_blank">http://www.ibm.com/developerworks/library/j-jar/index.html</a></li></ul></li>
<li> MANIFEST.MFを使って、jarファイルをダブルクリックで実行<ul><li> <a class="externallink" href="http://www.searchman.info/tips/2130.html" target="_blank">http://www.searchman.info/tips/2130.html</a></li></ul></li>
<li> Java Tip 127: See JAR run - JavaWorld<ul><li> <a class="externallink" href="http://www.javaworld.com/javaworld/javatips/jw-javatip127.html" target="_blank">http://www.javaworld.com/javaworld/javatips/jw-javatip127.html</a></li></ul></li>
<li> MANIFEST.MFとjarファイル - 役立たずのプログラマーブログ<ul><li> <a class="externallink" href="http://blog.goo.ne.jp/linux_ekyu/e/d9fa610a5a513fe80491f2ecb99cc129" target="_blank">http://blog.goo.ne.jp/linux_ekyu/e/d9fa610a5a513fe80491f2ecb99cc129</a></li></ul></li>
<li> jarファイルの作り方(ytp.ne.jp)<ul><li> <a class="externallink" href="http://www.ytp.ne.jp/tech/java/sineruka/jarhowto.html" target="_blank">http://www.ytp.ne.jp/tech/java/sineruka/jarhowto.html</a></li></ul></li>
<li> maven-assembly-plugin で実行可能な jar ファイルを作る - Think Different - はてな版<ul><li> <a class="externallink" href="http://d.hatena.ne.jp/nanasess/20090330/1238422438" target="_blank">http://d.hatena.ne.jp/nanasess/20090330/1238422438</a></li></ul></li></ul>

<h3 id="idacfc6b">step3 : batやshでjarファイルのリストを取り出しclasspathを調整する</h3>

<p class="paragraph">
ここまではjarファイルの機能だけで実行可能にしたり依存jarの問題を対応してきました。このstep3では、Tomcatの配布パッケージで見られるようにbatやshファイルで依存関係を解決するアプローチを紹介します。
<br />
</p>

<p class="paragraph">
以前、Apache MINAを使ったechoサーバの実験でcodereposに&quot;echo_samples/act9&quot;というサンプルコードをupし、その中でこのアプローチを採用し、batやshで依存jarの一覧を取り出してclasspathに指定していますので、そちらを簡単に紹介していきます。
<br />
</p>

<p class="paragraph">
<a class="externallink" href="http://coderepos.org/share/browser/lang/java/echo_samples/act9" target="_blank">http://coderepos.org/share/browser/lang/java/echo_samples/act9</a>
<br />
</p>

<p class="paragraph">
ポイントとなるのは、act9/src/bin/ 以下に格納したbatやshになります。これらはpackagingすることで以下のように配置されます。
<br />
</p>
<pre class="plugin_pre">
echoes-act9-1.0.0/
  lib/*.jar
  ea9_*.bat
  ea9_*.sh
  echoes-act9.ini
  他、ライセンスやNTサービス登録用のbatファイルなど
</pre>

<h4 id="id286cd4">Windowsのbatでclasspathを調整する</h4>

<p class="paragraph">
Windowsでclasspathを調整しているのは ea9_env.bat と ea9_addclp.bat の2つになります。
<br />
ea9_env.bat:
<br />
</p>
<pre class="plugin_pre">
set EA9_HOME=%~dp0
set EA9_SVC_NAME=EchoesAct9
set EA9_SVC_DISPLAY_NAME=&quot;Echoes Act9&quot;
set EA9_SVC_DESCRIPTION=&quot;Echoes Act9 Service&quot;

set JAVA_OPTIONS_SRV=-Xmx200m -Xloggc:&quot;%EA9_HOME%gc.log&quot;

set CLASSPATH=
for %%I in (&quot;%EA9_HOME%lib\*.jar&quot;) do call ea9_addclp.bat &quot;%%I&quot;
</pre>
<p class="paragraph">
最後のforで、&quot;lib/*.jar&quot; をワイルドカードで指定することで1ファイルずつ展開て &quot;%I&quot; に格納し、ea9_addclp.bat に渡しています。
<br />
</p>

<p class="paragraph">
ea9_addclp.bat:
<br />
</p>
<pre>SET CLASSPATH=%1;%CLASSPATH%
</pre>

<p class="paragraph">
ea9_addclp.batの中では、単純にCLASSPATH環境変数に渡されてきたファイルパスを追加していきます。
<br />
これ、最初はea9_env.batの中だけで完結できるんじゃ・・・と試してたんですが、うまく行かなくて（理由は忘れた）、CLASSPATHの設定だけea9_addclp.batに分離してうまく動作しました。
<br />
</p>

<p class="paragraph">
実際のjava実行用batは以下のようになっていて、ea9_env.batをcallしたらそのままjavaを起動するだけです。
<br />
ea9_client.bat:
<br />
</p>
<pre>call ea9_env.bat
java -classpath %CLASSPATH% echoes.act9.client.EchoesClient &quot;%EA9_HOME%echoes-act9.ini&quot;
</pre>

<h4 id="id878f66">unixのsh(bash)でclasspathを調整する</h4>

<p class="paragraph">
unixの場合にclasspathを調整しているのは ea9_env.sh になります。調整箇所だけ抜粋します。
<br />
ea9_env.sh:
<br />
</p>
<pre>CLASSPATH=
for i in `/bin/ls lib/*.jar`; do CLASSPATH=$i:$CLASSPATH ; done
export CLASSPATH
</pre>

<p class="paragraph">
lsコマンドの出力結果をCLASSPATHに追加してるだけです。・・・ちょっとlsコマンドの挙動に依存関係が発生してしまうのが気持ち悪いですが、2010年ごろのサンプル作成時は、これでうまく動いてました・・・。
<br />
</p>

<p class="paragraph">
実行用のshは以下のようになっていて、bashの&quot;.&quot;でea9_env.shを展開して実行したら、javaを起動するだけです。
<br />
ea9_client.sh:
<br />
</p>
<pre>cd `dirname $0`
. ea9_env.sh
java -classpath $CLASSPATH echoes.act9.client.EchoesClient echoes-act9.ini
</pre>



<p class="paragraph">
以上、batやshの機能だけでclasspathを調整するサンプルの紹介でした。
<br />
</p>

<h3 id="idbf43cb">step4 : Maven Application Assemblerを使う</h3>

<p class="paragraph">
参考：
<br />
</p>
<ul><li> Mavenで配布用zipファイルを作成する - Sacrificed &amp; Exploited<ul><li> <a class="externallink" href="http://d.hatena.ne.jp/cnaos/20100102/1262430319" target="_blank">http://d.hatena.ne.jp/cnaos/20100102/1262430319</a></li></ul></li>
<li> Maven Application Assembler - Mojo Appassembler<ul><li> <a class="externallink" href="http://mojo.codehaus.org/appassembler/" target="_blank">http://mojo.codehaus.org/appassembler/</a></li></ul></li></ul>

<p class="paragraph">
step3では手作りのshやbatファイルでclasspathを調整してみましたが、Maven Application Assemblerを使うともっとちゃんとした（？）・・・その、多分、もうちょっと依存性を薄めてちゃんと動いてくれる・・・本格的？な？batやshを作ってくれるようです。
<br />
原理的には、パッケージングの段階で依存jarを収集して、プリセットされたディレクトリ構成に配置し、それを相対パスで参照するようなclasspathを埋め込んでbat/shを生成します。ですので、bat/sh内で黒魔術を使って動的にjarを探索、classpathを構築してるわけではないです。（生成されたbat/shを見てもらえれば「あ～」と納得していただけるかと。）
<br />
</p>

<p class="paragraph">
ということで、step3で紹介したechoes.act9をappassemblerで構築してみます。
<br />
</p>

<p class="paragraph">
まずpom.xmlのpluginsを以下のように修正します。
<br />
</p>
<ul><li> ポイント1 : appassemblerはあくまでもシェルスクリプトおよび依存jarの収集までを担当するだけです。実際のzip/tarボールへのパッケージングには引き続きmaven-assembly-pluginが必要です。</li>
<li> ポイント2 : appassemblerのデフォルトでは、Mavenリポジトリのディレクトリ構成で依存jarが収集されてしまい、それに合わせたclasspathが、appassemblerの生成したbat/sh中にハードコードされます。それだとCLASSPATH環境変数の文字数が、サブディレクトリに区切られる影響でやたらと長くなってしまいますので、今回はjarの収集はassembly側のdependencySetで&quot;/lib&quot;以下にflatに収集させ、appassembler側では&quot;repositoryLayout&quot;と&quot;repositoryName&quot;を&quot;flat&quot;と&quot;lib&quot;にして、assembly側で収集した&quot;/lib&quot;以下に合わせました。同時に、jar収集はassemblyのdependencySetで実施するため、appassembler側は&quot;generateRepository&quot;にfalseを指定してjar収集をしないようにします。</li></ul>

<pre class="plugin_pre">
&lt;plugin&gt;
  &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;
  &lt;artifactId&gt;appassembler-maven-plugin&lt;/artifactId&gt;
  &lt;version&gt;1.3&lt;/version&gt;
  &lt;configuration&gt;

    &lt;!-- appassembler自身は依存jarは収集しない --&gt;
    &lt;generateRepository&gt;false&lt;/generateRepository&gt;

    &lt;!-- assembly側のdependencySetで、&quot;/lib&quot; 以下に依存jarがflat構成で収集されるのに合わせる --&gt;
    &lt;repositoryName&gt;lib&lt;/repositoryName&gt;
    &lt;repositoryLayout&gt;flat&lt;/repositoryLayout&gt;

    &lt;programs&gt;
      &lt;program&gt;
        &lt;mainClass&gt;echoes.act9.server.EchoesServer&lt;/mainClass&gt;
        &lt;name&gt;ea9_server&lt;/name&gt;
      &lt;/program&gt;
      &lt;program&gt;
        &lt;mainClass&gt;echoes.act9.client.EchoesShutdown&lt;/mainClass&gt;
        &lt;name&gt;ea9_shutdown&lt;/name&gt;
      &lt;/program&gt;
      &lt;program&gt;
        &lt;mainClass&gt;echoes.act9.client.EchoesClient&lt;/mainClass&gt;
        &lt;name&gt;ea9_client&lt;/name&gt;
      &lt;/program&gt;
    &lt;/programs&gt;
  &lt;/configuration&gt;
  &lt;executions&gt;
    &lt;execution&gt;
      &lt;phase&gt;package&lt;/phase&gt;
      &lt;goals&gt;
        &lt;goal&gt;assemble&lt;/goal&gt;
      &lt;/goals&gt;
    &lt;/execution&gt;
  &lt;/executions&gt;
&lt;/plugin&gt;
&lt;plugin&gt;
  &lt;artifactId&gt;maven-assembly-plugin&lt;/artifactId&gt;
  &lt;version&gt;2.3&lt;/version&gt;
  &lt;configuration&gt;
    &lt;descriptors&gt;
      &lt;descriptor&gt;src/assemble/bin.xml&lt;/descriptor&gt;
    &lt;/descriptors&gt;
  &lt;/configuration&gt;
  &lt;executions&gt;
    &lt;execution&gt;
      &lt;id&gt;make-assembly&lt;/id&gt;
      &lt;phase&gt;package&lt;/phase&gt;
      &lt;goals&gt;
        &lt;goal&gt;single&lt;/goal&gt;
      &lt;/goals&gt;
    &lt;/execution&gt;
  &lt;/executions&gt;
&lt;/plugin&gt;
</pre>

<p class="paragraph">
src/bin/以下のsh, batは今回は使いませんので、バッサリディレクトリごと削除します。
<br />
続いてassemblyプラグインのdescriptorである src/assemble/bin.xml ファイルを以下のように修正します。
<br />
src/assemble/bin.xml:
<br />
</p>
<pre class="plugin_pre">
&lt;assembly&gt;
  &lt;id&gt;bin&lt;/id&gt;
  &lt;formats&gt;
    &lt;format&gt;tar.gz&lt;/format&gt;
    &lt;format&gt;tar.bz2&lt;/format&gt;
    &lt;format&gt;zip&lt;/format&gt;
  &lt;/formats&gt;
  &lt;fileSets&gt;
    &lt;!-- iniファイルやLICENSEファイルは従来通りパッケージ直下に配置 --&gt;
    &lt;fileSet&gt;
      &lt;directory&gt;${project.basedir}&lt;/directory&gt;
      &lt;outputDirectory&gt;/&lt;/outputDirectory&gt;
      &lt;includes&gt;
        &lt;include&gt;*.ini&lt;/include&gt;
        &lt;include&gt;LICENSE*&lt;/include&gt;
      &lt;/includes&gt;
    &lt;/fileSet&gt;
    &lt;!-- appassemblerにより生成されたbat/shは&quot;/bin&quot;以下に配置 --&gt;
    &lt;fileSet&gt;
      &lt;directory&gt;target/appassembler/bin&lt;/directory&gt;
      &lt;outputDirectory&gt;/bin&lt;/outputDirectory&gt;
    &lt;/fileSet&gt;
  &lt;/fileSets&gt;
  &lt;files&gt;
    &lt;file&gt;
      &lt;source&gt;README.txt&lt;/source&gt;
      &lt;outputDirectory&gt;/&lt;/outputDirectory&gt;
      &lt;filtered&gt;true&lt;/filtered&gt;
    &lt;/file&gt;
  &lt;/files&gt;
  &lt;!-- 依存jarは従来通り&quot;/lib&quot;以下に配置 --&gt;
  &lt;dependencySets&gt;
    &lt;dependencySet&gt;
      &lt;outputDirectory&gt;/lib&lt;/outputDirectory&gt;
      &lt;includes&gt;
        &lt;include&gt;*:jar&lt;/include&gt;
      &lt;/includes&gt;
    &lt;/dependencySet&gt;
  &lt;/dependencySets&gt;
&lt;/assembly&gt;
</pre>

<p class="paragraph">
ビルドしてみます。
<br />
</p>
<pre class="plugin_pre">
$ mvn package
$ tar ztf target/echoes-act9-1.0.0-bin.tar.gz
echoes-act9-1.0.0/echoes-act9.ini
echoes-act9-1.0.0/LICENSE.txt
echoes-act9-1.0.0/LICENSE_slf4j.txt
echoes-act9-1.0.0/bin/
echoes-act9-1.0.0/bin/ea9_client
echoes-act9-1.0.0/bin/ea9_client.bat
echoes-act9-1.0.0/bin/ea9_server
echoes-act9-1.0.0/bin/ea9_server.bat
echoes-act9-1.0.0/bin/ea9_shutdown
echoes-act9-1.0.0/bin/ea9_shutdown.bat
echoes-act9-1.0.0/lib/mina-core-1.1.7.jar
echoes-act9-1.0.0/lib/slf4j-api-1.6.1.jar
echoes-act9-1.0.0/lib/mina-integration-jmx-1.1.7.jar
echoes-act9-1.0.0/lib/log4j-1.2.16.jar
echoes-act9-1.0.0/lib/slf4j-log4j12-1.6.1.jar
echoes-act9-1.0.0/lib/echoes-act9-1.0.0.jar
echoes-act9-1.0.0/README.txt
</pre>

<p class="paragraph">
実行結果については省略します。
<br />
注意点：
<br />
</p>
<ul><li> unix用shellscriptについては実行権限がつかないため、展開後に手動でchmodするか&quot;sh bin/xxxx&quot;とする必要があります。もしかしたら設定で修正できるかも？</li>
<li> step3と異なり、echoes-act9.iniをコマンドラインから手動で指定する必要があります。このあたりは、javaコマンドに引数を設定することが可能ですので、設定次第で省略出来るかもしれません。</li></ul>

<h3 id="id370509">stepX(おまけ) : 複数のjarを1つのjarに統合する各種技術</h3>

<p class="paragraph">
One-JARやfat-jar、あるいはmaven-assembly-pluginの&quot;jar-with-dependencies&quot; descriptorでは、依存するjarを1つのjarに統合するアプローチを採用しています。その中でもさらに以下の2つのアプローチがあるようです。
<br />
</p>
<ol><li> One-JARが採用している、jarの中にjarを入れ子にして、専用のクラスローダを埋め込む。</li>
<li> 単純に依存jarを全部展開して、1つのjarにアーカイブし直す。(maven-assembly-pluginの&quot;jar-with-dependencies&quot; descriptorがこのアプローチ・・・っぽい。多分。)</li></ol>

<p class="paragraph">
確かに単純に実行の容易さだけを考えるとCoolでSmartに見えなくもないのですが、本来は別個で扱われるべきアーカイブ内容を、無理やり1つに統合してしまうので、デメリットも存在します。例えば個別のjarファイル中のマニフェスト情報はロストしてしまう可能性が高いです。これらの情報を扱うようなアプリでは致命的な問題になります。One-JARが採用する、専用のクラスローダによるjarの入れ子の場合、jar中に埋め込んだ設定ファイルを読み出すようなプログラムではクラスローダ周辺のトラブルが発生する可能性が高くなります。
<br />
便利ではありますが、落とし穴も大きい可能性がありますので、採用する場合は事前に入念な下調べが必要になると思われます。時間の都合上、本記事では参考URLを紹介するのみに止めます。
<br />
</p>

<ul><li> One-JARでアプリケーションの配布を単純化<ul><li> <a class="externallink" href="http://www.ibm.com/developerworks/jp/java/library/j-onejar/" target="_blank">http://www.ibm.com/developerworks/jp/java/library/j-onejar/</a></li></ul></li>
<li> Deliver Your Java Application in One-JAR™ !<ul><li> <a class="externallink" href="http://one-jar.sourceforge.net/" target="_blank">http://one-jar.sourceforge.net/</a></li></ul></li>
<li> Maven Fat Jar - @//メモ<ul><li> <a class="externallink" href="http://hondou.homedns.org/pukiwiki/index.php?Maven%20Fat%20Jar" target="_blank">http://hondou.homedns.org/pukiwiki/index.php?Maven%20Fat%20Jar</a></li></ul></li>
<li> Leo&#039;s Chronicle: JARファイルの中にJARを埋め込む<ul><li> <a class="externallink" href="http://leoclock.blogspot.jp/2008/08/jarjar.html" target="_blank">http://leoclock.blogspot.jp/2008/08/jarjar.html</a></li></ul></li>
<li> Leo&#039;s Chronicle: Fat Jar: Jarファイルの中にJarを埋め込む<ul><li> <a class="externallink" href="http://leoclock.blogspot.jp/2007/02/fat-jar-jarjar.html" target="_blank">http://leoclock.blogspot.jp/2007/02/fat-jar-jarjar.html</a></li></ul></li>
<li> jarを一本化するonejar-maven-pluginを使ってみた - Sacrificed &amp; Exploited<ul><li> <a class="externallink" href="http://d.hatena.ne.jp/cnaos/20100509/1273399163" target="_blank">http://d.hatena.ne.jp/cnaos/20100509/1273399163</a></li></ul></li></ul>


<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-1452.html" title="Java/diff(差分検出アルゴリズム)のJava実装調査メモ">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-826.html" title="Java/「Javaデザインパターン徹底攻略」読書メモ">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-457.html" title="Java">Up</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-457.html" title="Java">Java</a>&nbsp;]</li>
</ul>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/1121<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2007 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>