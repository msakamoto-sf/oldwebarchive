<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>技術/HTTP/FormやCookieのkey名に&quot;=&quot;を含めたらどうなるのか？ - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">技術/HTTP/FormやCookieのkey名に&quot;=&quot;を含めたらどうなるのか？</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2011-07-31 16:43:40 &nbsp; / &nbsp; last updated at: 2011-08-21 14:52:59<br>
カテゴリ: <a href="category-59.html">HTTP</a>&nbsp;<a href="category-30.html">ネットワーク</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-1364.html" title="技術/HTTP/Fenix Web Server (静的ページ開発用ローカルWebサーバ)">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-1030.html" title="技術/HTTP/JMeter負荷テストメモ">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-23.html" title="技術">技術</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
仕事中、FormやCookieのkey名に&quot;=&quot;を含めたらどうなるのだろう？という話題が出た。
<br />
</p>
<pre>&lt;input type=&quot;text&quot; name=&quot;foo=bar&quot; value=&quot;&quot; /&gt;
</pre>
<p class="paragraph">
や、
<br />
</p>
<pre>Set-Cookie: foo=bar=baz
</pre>
<p class="paragraph">
の時、どんな挙動がみられるのか？
<br />
</p>

<p class="paragraph">
ということで、FormとCookieのそれぞれについて、最初にRFC上での&quot;=&quot;の扱いについて調べ、続いて実際に動作を確認してみたメモ。
<br />
</p>


<ul><li><a href="#idb20187">Form、つまりURLのqueryやx-www-form-urlencodedの場合</a><ul><li><a href="#iddcc202">RFC2396, RFC2616, RFC3986 の調査</a></li>
<li><a href="#id5309ba">CGI, W3C HTML 4.01, RFC1866の調査</a></li>
<li><a href="#id7c99e1">実験</a></li></ul></li>
<li><a href="#id4833a6">Cookieの&quot;NAME=VALUE&quot;の場合</a><ul><li><a href="#id6a3d4d">Netscape仕様, RFC6265の調査</a></li>
<li><a href="#idb929d4">PHPでの実験</a><ul><li><a href="#idd4d54a">Chromeの場合</a></li>
<li><a href="#id82f140">IE9の場合</a></li>
<li><a href="#ida24e45">Firefox5の場合</a></li></ul></li></ul></li></ul>
<hr />
<h3 id="idb20187">Form、つまりURLのqueryやx-www-form-urlencodedの場合</h3>

<p class="paragraph">
URLのquery部分やx-www-form-urlencodedなど、Formからのsubmitなどの場合について調べてみる。
<br />
</p>

<h4 id="iddcc202">RFC2396, RFC2616, RFC3986 の調査</h4>

<p class="paragraph">
まずRFC上に何か規定がないか調べてみる。
<br />
HTTPで使われているURLについてはRFC2616で次のように記されている。(see: <a class="externallink" href="http://www.studyinghttp.net/cgi-bin/rfc.cgi?2616#Sec3.2.2" target="_blank">http://www.studyinghttp.net/cgi-bin/rfc.cgi?2616#Sec3.2.2</a> )
<br />
</p>
<pre>http_URL = &quot;http:&quot; &quot;//&quot; host [ &quot;:&quot; port ] [ abs_path [ &quot;?&quot; query ]]
</pre>

<p class="paragraph">
&quot;host&quot;や&quot;query&quot;にどのような文字を使えるのかについては、RFC2396のAppendix.A に記されている。
<br />
(see: <a class="externallink" href="http://tools.ietf.org/html/rfc2396" target="_blank">http://tools.ietf.org/html/rfc2396</a> )
<br />
</p>
<pre>A. Collected BNF for URI

     URI-reference = [ absoluteURI | relativeURI ] [ &quot;#&quot; fragment ]
     absoluteURI   = scheme &quot;:&quot; ( hier_part | opaque_part )
     relativeURI   = ( net_path | abs_path | rel_path ) [ &quot;?&quot; query ]
...
     query         = *uric
...
     uric          = reserved | unreserved | escaped
     reserved      = &quot;;&quot; | &quot;/&quot; | &quot;?&quot; | &quot;:&quot; | &quot;@&quot; | &quot;&amp;&quot; | &quot;=&quot; | &quot;+&quot; |
                     &quot;$&quot; | &quot;,&quot;
     unreserved    = alphanum | mark
     mark          = &quot;-&quot; | &quot;_&quot; | &quot;.&quot; | &quot;!&quot; | &quot;~&quot; | &quot;*&quot; | &quot;&#039;&quot; |
                     &quot;(&quot; | &quot;)&quot;

     escaped       = &quot;%&quot; hex hex
     hex           = digit | &quot;A&quot; | &quot;B&quot; | &quot;C&quot; | &quot;D&quot; | &quot;E&quot; | &quot;F&quot; |
                             &quot;a&quot; | &quot;b&quot; | &quot;c&quot; | &quot;d&quot; | &quot;e&quot; | &quot;f&quot;
</pre>

<p class="paragraph">
ここで&quot;=&quot;が&quot;reserved&quot;に含まれていることが確認できる。では&quot;reserved&quot;, &quot;unreserved&quot;の違いは何か？これについてもRFC2396の&quot;2.2. Reserved Characters&quot;以下に記されている。
<br />
</p>
<pre>2.2. Reserved Characters

  Many URI include components consisting of or delimited by, certain
  special characters.  These characters are called &quot;reserved&quot;, since
  their usage within the URI component is limited to their reserved
  purpose.  If the data for a URI component would conflict with the
  reserved purpose, then the conflicting data must be escaped before
  forming the URI.
...
2.3. Unreserved Characters

  Data characters that are allowed in a URI but do not have a reserved
  purpose are called unreserved.  These include upper and lower case
  letters, decimal digits, and a limited set of punctuation marks and
  symbols.
</pre>

<p class="paragraph">
ざっくりまとめれば、&quot;reserved&quot;に指定している文字セットはURLを構成する各パートでの区切り文字などに使われているため、データとして使うのであれば&quot;escape&quot;せよ、と書いてある。&quot;escape&quot;というのはいわゆる&quot;%&quot;+16進数で表現する「パーセントエンコーディング」となり、詳細は同RFCの&quot;2.4. Escape Sequences&quot;を参照のこと。
<br />
</p>

<p class="paragraph">
URLについてはURNと共にRFC3986にてURIに包含された。RFC3986での&quot;query&quot;について見てみる。
<br />
(see : <a class="externallink" href="http://tools.ietf.org/html/rfc3986#section-3.4" target="_blank">http://tools.ietf.org/html/rfc3986#section-3.4</a> )
<br />
</p>
<pre>3.4.  Query

  The query component contains non-hierarchical data that, along with
  data in the path component (Section 3.3), serves to identify a
  resource within the scope of the URI&#039;s scheme and naming authority
  (if any).  The query component is indicated by the first question
  mark (&quot;?&quot;) character and terminated by a number sign (&quot;#&quot;) character
  or by the end of the URI.

     query       = *( pchar / &quot;/&quot; / &quot;?&quot; )

  The characters slash (&quot;/&quot;) and question mark (&quot;?&quot;) may represent data
  within the query component.  Beware that some older, erroneous
  implementations may not handle such data correctly when it is used as
  the base URI for relative references (Section 5.1), apparently
  because they fail to distinguish query data from path data when
  looking for hierarchical separators.  However, as query components
  are often used to carry identifying information in the form of
  &quot;key=value&quot; pairs and one frequently used value is a reference to
  another URI, it is sometimes better for usability to avoid percent-
  encoding those characters.
</pre>

<p class="paragraph">
具体的な文字セットについては&quot;Appendix A.  Collected ABNF for URI&quot;参照：
<br />
</p>
<pre>Appendix A.  Collected ABNF for URI
  URI           = scheme &quot;:&quot; hier-part [ &quot;?&quot; query ] [ &quot;#&quot; fragment ]
 ...
  pchar         = unreserved / pct-encoded / sub-delims / &quot;:&quot; / &quot;@&quot;

  query         = *( pchar / &quot;/&quot; / &quot;?&quot; )
...
  pct-encoded   = &quot;%&quot; HEXDIG HEXDIG
  unreserved    = ALPHA / DIGIT / &quot;-&quot; / &quot;.&quot; / &quot;_&quot; / &quot;~&quot;
...
  sub-delims    = &quot;!&quot; / &quot;$&quot; / &quot;&amp;&quot; / &quot;&#039;&quot; / &quot;(&quot; / &quot;)&quot;
                / &quot;*&quot; / &quot;+&quot; / &quot;,&quot; / &quot;;&quot; / &quot;=&quot;
</pre>

<p class="paragraph">
RFC2396では&quot;reserved&quot;で一括りになっていたのが、やや細分化され&quot;sub-delims&quot;と&quot;:&quot;と&quot;@&quot;になっている。とはいえここでもやはり&quot;=&quot;は&quot;sub-delims&quot;扱い、つまりデータとして使うのであればパーセントエンコーディングが必要とされていることが読み取れる。
<br />
</p>

<p class="paragraph">
とはいえ、ここまでのRFC2616, RFC2396, RFC3986で記されているのは &quot;=&quot; が query における区切り文字であること迄であり、一体何を区切るのか、つまり query 自体の詳細には踏み込んでいない。
<br />
</p>

<h4 id="id5309ba">CGI, W3C HTML 4.01, RFC1866の調査</h4>

<p class="paragraph">
Webの世界ではqueryはCGIなど動的処理に使われる。そこでCGIのQUERY_STRINGの定義に何かヒントが無いか見てみる。(see : <a class="externallink" href="http://www.studyinghttp.net/cgi#QUERY_STRING" target="_blank">http://www.studyinghttp.net/cgi#QUERY_STRING</a> )
<br />
</p>
<blockquote><p class="paragraph">
検索文字列のための URL 構文は RFC 2396 [2] の section 3 にて記述される。 QUERY_STRING 値は、大文字・小文字を区別する。
<br />
</p>
<pre>QUERY_STRING = query-string
query-string = *uric
uric         = reserved | unreserved | escaped
</pre>
<p class="paragraph">
問い合わせ文字列を解析し、デコードする際、その解析の詳細や予約文字、非 US-ASCII 文字についてのサポートは、状況に依存する。 例えば、HTML 文書からのフォーム提出 [18] は、application/x-www-form-urlencoded 符号化を使用し、その場合は文字 &quot;+&quot;, &quot;&amp;&quot;, &quot;=&quot; が予約されており、非 US-ASCII 文字については ISO 8859-1 エンコーディングが使用されているであろう。
<br />
</p></blockquote>

<p class="paragraph">
ここでもquery内部の詳しいフォーマットまでは定義されていない。では、HTML文書からのフォーム提出ではどのように記されているのか見てみる。上記CGIの&quot;HTML 文書からのフォーム提出 [18] &quot;はW3Cの&quot;HTML 4.01 Specification&quot;を参照しているので、まずはHTML4.01でのフォームの仕様を調べてみる。
<br />
</p>

<p class="paragraph">
すると &quot;17.13.4 Form content types&quot; でようやく求めたいた記述が見つかった。
<br />
<a class="externallink" href="http://www.w3.org/TR/html401/interact/forms.html#h-17.13.4" target="_blank">http://www.w3.org/TR/html401/interact/forms.html#h-17.13.4</a>
<br />
</p>
<blockquote><p class="paragraph">
application/x-www-form-urlencoded
<br />
</p>

<p class="paragraph">
This is the default content type. Forms submitted with this content type must be encoded as follows:
<br />
1. Control names and values are escaped. Space characters are replaced by `+&#039;, and then reserved characters are escaped as described in [RFC1738], section 2.2: Non-alphanumeric characters are replaced by `%HH&#039;, a percent sign and two hexadecimal digits representing the ASCII code of the character. Line breaks are represented as &quot;CR LF&quot; pairs (i.e., `%0D%0A&#039;).
<br />
2. The control names/values are listed in the order they appear in the document. The name is separated from the value by `=&#039; and name/value pairs are separated from each other by `&amp;&#039;.
<br />
</p></blockquote>

<p class="paragraph">
<strong>Control names and values are escaped.</strong>この一文により、フォームのname属性はエスケープされることが規定される。
<br />
同ページの&quot;17.4 The INPUT element&quot;ではinputタグのname属性がCDATAとなっており、データの自由度は高い。
<br />
</p>

<p class="paragraph">
&quot;application/x-www-form-urlencoded&quot;についてはRFC1866(HTML 2.0)が初出・・・らしい。
<br />
</p>
<ul><li> <a class="externallink" href="http://tools.ietf.org/html/rfc1866" target="_blank">http://tools.ietf.org/html/rfc1866</a><ul><li> 8.2. Form Submission 参照</li></ul></li></ul>

<h4 id="id7c99e1">実験</h4>

<p class="paragraph">
簡単なFormを作成し、name属性に改行や空白、&quot;=&quot;などを混ぜてみる。
<br />
</p>
<pre>&lt;form action=&quot;./formtest.php&quot; method=&quot;&quot;&gt;
&lt;input type=&quot;text&quot; name=&quot; ?abc
def =
ghi /
&quot; value=&quot;foo&quot; /&gt;&lt;br /&gt;
&lt;input type=&quot;submit&quot; /&gt;
&lt;/form&gt;
</pre>

<p class="paragraph">
このようなフォームをChrome, IE9, Firefox5でsubmitしてみる。
<br />
</p>

<p class="paragraph">
Chrome, Firefox5.0:
<br />
</p>
<pre>...?+%3Fabc%0D%0Adef+%3D%0D%0Aghi+%2F%0D%0A+=foo
</pre>
<p class="paragraph">
IE9:
<br />
</p>
<pre>...?+%3Fabc%250D%250Adef+%3D%250D%250Aghi+%2F%250D%250A+=foo
</pre>
<p class="paragraph">
IE9だけ改行文字でパーセントエンコーディングが二重に処理されている・・・。
<br />
</p>

<p class="paragraph">
PHPではどのようにデコードされるか？
<br />
</p>
<pre>&lt;?php var_export($_GET);
</pre>

<p class="paragraph">
Chrome, Firefox5.0:
<br />
</p>
<pre>array (
  &#039;?abc
def_=
ghi_/
_&#039; =&gt; &#039;foo&#039;,
)
</pre>
<p class="paragraph">
IE9:
<br />
</p>
<pre>array (
  &#039;?abc%0D%0Adef_=%0D%0Aghi_/%0D%0A_&#039; =&gt; &#039;foo&#039;,
)
</pre>

<p class="paragraph">
key名の先頭のスペースは除去され、それ以外の空白は&quot;_&quot;に置換されている。改行についてはChrome, Firefoxの場合はそのままデコードされ、IEの場合は二重のパーセントエンコーディングが一回デコードされた段階になっている。
<br />
</p>

<p class="paragraph">
PHPの場合、ドットやスペースは&quot;_&quot;に置換される。これはregister_globalsにより自動的に変数に展開されていた時代、ドットが変数名を表す文字セットに含まれていなかったことが影響していると思われる。
<br />
<a class="externallink" href="http://jp.php.net/manual/ja/language.variables.external.php" target="_blank">http://jp.php.net/manual/ja/language.variables.external.php</a>
<br />
</p>
<pre>注意:
変数名のドットやスペースはアンダースコアに変換されます。
たとえば &lt;input name=&quot;a.b&quot; /&gt; は $_REQUEST[&quot;a_b&quot;] となります。
</pre>


<h3 id="id4833a6">Cookieの&quot;NAME=VALUE&quot;の場合</h3>

<p class="paragraph">
Cookieの&quot;NAME=VALUE&quot;にエンコードされていない&quot;=&quot;が含まれるとどうなるか？
<br />
</p>

<h4 id="id6a3d4d">Netscape仕様, RFC6265の調査</h4>

<p class="paragraph">
まずNetscapeの仕様を見てみる。
<br />
<a class="externallink" href="http://www.futomi.com/lecture/cookie/specification.html" target="_blank">http://www.futomi.com/lecture/cookie/specification.html</a>
<br />
</p>
<blockquote><p class="paragraph">
NAME=VALUE
<br />
</p>

<p class="paragraph">
ここには、セミコロン、カンマ、スペースを排除した文字列が入ります。セミコロン、カンマ、スペースが含まれるようなデータを設定する必要がある場合には、URLエンコードのような何かしらのエンコードが推奨されます。ただし、エンコード自体は、まったく定義されているわけではありませんし、要求されるものではありません。（日本語を扱う場合には、URLエンコードをする必要があります。）
<br />
</p></blockquote>

<p class="paragraph">
この文章からは、
<br />
</p>
<pre>NA=M%3DE=VA%3DLU=E
</pre>
<p class="paragraph">
のような極端な例に対してどう処理すれば良いのかは読み取れない。
<br />
</p>

<p class="paragraph">
念のためweb.archive.orgに残されている原文を確認してみる。
<br />
<a class="externallink" href="http://web.archive.org/web/20020803110822/http://wp.netscape.com/newsref/std/cookie_spec.html" target="_blank">http://web.archive.org/web/20020803110822/http://wp.netscape.com/newsref/std/cookie_spec.html</a>
<br />
</p>
<blockquote><p class="paragraph">
NAME=VALUE
<br />
This string is a sequence of characters excluding semi-colon, comma and white space. If there is a need to place such data in the name or value, some encoding method such as URL style %XX encoding is recommended, though no encoding is defined or required.
<br />
</p></blockquote>

<p class="paragraph">
日本語と同様である。セミコロン、カンマ、ホワイトスペースが予約語扱いでパーセントエンコーディングが必要、というのは理解できる。
<br />
&quot;=&quot;は予約語ではないのか？
<br />
</p>

<p class="paragraph">
最新のCookieはRFC6265となり、こちらを調べてみる。
<br />
<a class="externallink" href="http://www.ietf.org/rfc/rfc6265.txt" target="_blank">http://www.ietf.org/rfc/rfc6265.txt</a>
<br />
</p>
<pre class="plugin_pre">
4.1.  Set-Cookie

   The Set-Cookie HTTP response header is used to send cookies from the
   server to the user agent.

4.1.1.  Syntax

   Informally, the Set-Cookie response header contains the header name
   &quot;Set-Cookie&quot; followed by a &quot;:&quot; and a cookie.  Each cookie begins with
   a name-value-pair, followed by zero or more attribute-value pairs.
   Servers SHOULD NOT send Set-Cookie headers that fail to conform to
   the following grammar:

 set-cookie-header = &quot;Set-Cookie:&quot; SP set-cookie-string
 set-cookie-string = cookie-pair *( &quot;;&quot; SP cookie-av )
 cookie-pair       = cookie-name &quot;=&quot; cookie-value
 cookie-name       = token
 cookie-value      = *cookie-octet / ( DQUOTE *cookie-octet DQUOTE )
 cookie-octet      = %x21 / %x23-2B / %x2D-3A / %x3C-5B / %x5D-7E
                       ; US-ASCII characters excluding CTLs,
                       ; whitespace DQUOTE, comma, semicolon,
                       ; and backslash
 token             = &lt;token, defined in [RFC2616], Section 2.2&gt;
</pre>
<p class="paragraph">
先に&quot;cookie-value&quot;を構成する&quot;cookie-octet&quot;を見てみると、&quot;=&quot;(0x3D)が&quot;%x3C-5B&quot;の範囲内に含まれている。つまり特別扱いはされず、英数字と同様に&quot;cookie-value&quot;中に出てきても問題はないことになる。
<br />
&quot;cookie-name&quot;を構成する&quot;token&quot;についてはRFC2616のSection2.2を参照してみる。
<br />
<a class="externallink" href="http://www.ietf.org/rfc/rfc2616.txt" target="_blank">http://www.ietf.org/rfc/rfc2616.txt</a>
<br />
</p>
<pre>2.2 Basic Rules
(...)
Many HTTP/1.1 header field values consist of words separated by LWS
or special characters. These special characters MUST be in a quoted
string to be used within a parameter value (as defined in section
3.6).

token          = 1*&lt;any CHAR except CTLs or separators&gt;
separators     = &quot;(&quot; | &quot;)&quot; | &quot;&lt;&quot; | &quot;&gt;&quot; | &quot;@&quot;
               | &quot;,&quot; | &quot;;&quot; | &quot;:&quot; | &quot;\&quot; | &lt;&quot;&gt;
               | &quot;/&quot; | &quot;[&quot; | &quot;]&quot; | &quot;?&quot; | &quot;=&quot;
               | &quot;{&quot; | &quot;}&quot; | SP | HT
</pre>

<p class="paragraph">
これによると&quot;token&quot;には&quot;=&quot;は含まれない。つまり&quot;cookie-name&quot;には&quot;=&quot;を含まない、ということになる。
<br />
</p>

<p class="paragraph">
つまり
<br />
</p>
<pre>na=me=va=lue
</pre>
<p class="paragraph">
という例では、&quot;cookie-name&quot;には&quot;=&quot;を含まないので
<br />
</p>
<pre>cookie-name : &quot;na&quot;
&quot;=&quot;
cookie-value : &quot;me=va=lue&quot;
</pre>
<p class="paragraph">
となることが推測される。
<br />
</p>

<p class="paragraph">
RFC6265に戻ると、&quot;5.2.  The Set-Cookie Header&quot; にその推測を裏付ける記述がある。このセクションはブラウザなどのUserAgentが&quot;Set-Cookie&quot;レスポンスヘッダをどう処理すれば良いのかを記している。
<br />
少し長いが、&quot;cookie-name&quot;, &quot;cookie-value&quot;の処理を記している箇所をまるごと抜粋する。
<br />
<a class="externallink" href="http://www.ietf.org/rfc/rfc6265.txt" target="_blank">http://www.ietf.org/rfc/rfc6265.txt</a>
<br />
</p>
<pre class="plugin_pre">
5.2.  The Set-Cookie Header

   When a user agent receives a Set-Cookie header field in an HTTP
   response, the user agent MAY ignore the Set-Cookie header field in
   its entirety.  For example, the user agent might wish to block
   responses to &quot;third-party&quot; requests from setting cookies (see
   Section 7.1).

   If the user agent does not ignore the Set-Cookie header field in its
   entirety, the user agent MUST parse the field-value of the Set-Cookie
   header field as a set-cookie-string (defined below).

   NOTE: The algorithm below is more permissive than the grammar in
   Section 4.1.  For example, the algorithm strips leading and trailing
   whitespace from the cookie name and value (but maintains internal
   whitespace), whereas the grammar in Section 4.1 forbids whitespace in
   these positions.  User agents use this algorithm so as to
   interoperate with servers that do not follow the recommendations in
   Section 4.

   A user agent MUST use an algorithm equivalent to the following
   algorithm to parse a &quot;set-cookie-string&quot;:

   1.  If the set-cookie-string contains a %x3B (&quot;;&quot;) character:

          The name-value-pair string consists of the characters up to,
          but not including, the first %x3B (&quot;;&quot;), and the unparsed-
          attributes consist of the remainder of the set-cookie-string
          (including the %x3B (&quot;;&quot;) in question).

       Otherwise:

          The name-value-pair string consists of all the characters
          contained in the set-cookie-string, and the unparsed-
          attributes is the empty string.

   2.  If the name-value-pair string lacks a %x3D (&quot;=&quot;) character,
       ignore the set-cookie-string entirely.

   3.  The (possibly empty) name string consists of the characters up
       to, but not including, the first %x3D (&quot;=&quot;) character, and the
       (possibly empty) value string consists of the characters after
       the first %x3D (&quot;=&quot;) character.

   4.  Remove any leading or trailing WSP characters from the name
       string and the value string.

   5.  If the name string is empty, ignore the set-cookie-string
       entirely.

   6.  The cookie-name is the name string, and the cookie-value is the
       value string.
</pre>

<p class="paragraph">
ポイントとなるのが&quot;3.&quot;の処理で、日本語に直すと「&quot;name&quot;文字列は<strong>最初の%x3D(&quot;=&quot;)文字まで</strong>でなおかつ&quot;=&quot;自体は含まず、&quot;value&quot;文字列は最初の%x3D(&quot;=&quot;)文字列より後ろ」となる。
<br />
ここにおいてようやく、RFCに沿うなら
<br />
</p>
<pre>na=me=va=lue
</pre>
<p class="paragraph">
→
<br />
</p>
<pre>cookie-name : &quot;na&quot;
&quot;=&quot;
cookie-value : &quot;me=va=lue&quot;
</pre>
<p class="paragraph">
と解釈することが確認できた。
<br />
</p>

<h4 id="idb929d4">PHPでの実験</h4>

<p class="paragraph">
PHPで以下のようにsetcookie()を呼んでみる。
<br />
</p>
<pre>setrawcookie(&quot;abc=def%3Dghi&quot;, &quot;ABC=DEF%3DGHI&quot;);
</pre>
<p class="paragraph">
PHP 4.4.9 環境では問題なく動作したが、PHP 5.2.17環境では次のようなWarningが発生し、Set-Cookieも出力されなかった。
<br />
</p>
<pre>PHP Warning:  Cookie names can not contain any of the following &#039;=,; \t\r\n\013\014&#039; in ...
</pre>
<p class="paragraph">
setcookie()の場合も同様。
<br />
</p>

<p class="paragraph">
仕方なくheader()で直接Set-Cookieを出力し、ブラウザごとの反応を見てみた。
<br />
</p>
<pre>header(&#039;Set-Cookie: abc=def%3Dghi=ABC=DEF%3DGHI&#039;);
</pre>
<p class="paragraph">
→
<br />
</p>
<pre>HTTP/1.1 200 OK
...
Set-Cookie: abc=def%3Dghi=ABC=DEF%3DGHI
</pre>

<p class="paragraph">
PHP側でも$_COOKIEをダンプしてみる。
<br />
</p>
<pre>var_export($_COOKIE);
</pre>

<h5 id="idd4d54a">Chromeの場合</h5>

<p class="paragraph">
・オプション→高度な設定→プライバシー→コンテンツの設定→Cookie→すべてのCookieとサイトデータ...
<br />
</p>
<pre>名前：abc
コンテンツ：def%3Dghi=ABC=DEF%3DGHI
</pre>

<p class="paragraph">
・Set-Cookieされた後にブラウザが送信したCookieヘッダ：
<br />
</p>
<pre>Cookie: abc=def%3Dghi=ABC=DEF%3DGHI
</pre>

<p class="paragraph">
・PHP側の$_COOKIE:
<br />
</p>
<pre>array( &#039;abc&#039; =&gt; &#039;def=ghi=ABC=DEF=GHI&#039; )
</pre>

<h5 id="id82f140">IE9の場合</h5>

<p class="paragraph">
・アドレスバーに&quot;javascript:prompt(&#039;&#039;, document.cookie)
<br />
</p>
<pre>abc=def%3Dghi=ABC=DEF%3DGHI
</pre>

<p class="paragraph">
・Set-Cookieされた後にブラウザが送信したCookieヘッダ：
<br />
(Chromeと同じ)
<br />
</p>

<p class="paragraph">
・PHP側の$_COOKIE:
<br />
(Chromeと同じ)
<br />
</p>

<h5 id="ida24e45">Firefox5の場合</h5>

<p class="paragraph">
・&quot;Tools&quot;→&quot;Options&quot;→&quot;Privacy&quot;→&quot;History&quot;→&quot;remove individual cookies&quot;
<br />
</p>
<pre>Name:abc
Content:def%3Dghi=ABC=DEF%3DGHI
</pre>

<p class="paragraph">
・Set-Cookieされた後にブラウザが送信したCookieヘッダ：
<br />
(Chromeと同じ)
<br />
</p>

<p class="paragraph">
・PHP側の$_COOKIE:
<br />
(Chromeと同じ)
<br />
</p>


<hr />
<p class="paragraph">
3行でまとめ：
<br />
</p>
<ol><li> Formの場合：ブラウザが自動的に&quot;=&quot;をパーセントエンコードしてくれる。</li>
<li> Cookieの場合：最初の&quot;=&quot;までがname、それ以降がvalueとして扱われる。</li>
<li> PHPなど、処理系によっては独自のルールが定められているので注意。</li></ol>

<p class="paragraph">
個人的には、配列など特殊な形で渡したい場合を除き、あまり凝った記号を使わずに済ませたい。
<br />
配列などの場合は処理系の定めたフォーマットに従うことになるが、あまり逸脱したり混乱させるような記号は使わずに済ませたい。
<br />
どこに地雷が埋まっているか分からないので、なるべく安全ルートを通りたいな、と。そんな感じ。
<br />
</p>

<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-1364.html" title="技術/HTTP/Fenix Web Server (静的ページ開発用ローカルWebサーバ)">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-1030.html" title="技術/HTTP/JMeter負荷テストメモ">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-23.html" title="技術">技術</a>&nbsp;]</li>
</ul>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/1002<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2007 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>