<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>技術/TDD/DbUnitでCSV Export/Import を使うデモ + 制御コード混じりのバイナリ文字列を扱う時の注意点 - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">技術/TDD/DbUnitでCSV Export/Import を使うデモ + 制御コード混じりのバイナリ文字列を扱う時の注意点</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2013-06-23 19:45:49 &nbsp; / &nbsp; last updated at: 2013-06-23 22:39:42<br>
カテゴリ: <a href="category-11.html">Java</a>&nbsp;<a href="category-51.html">TDD</a>&nbsp;<a href="category-12.html">プログラミング</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-92.html" title="技術/Solaris10インストールメモ">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-150.html" title="技術/TDD/HttpUnit解説リンク">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-23.html" title="技術">技術</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
DbUnitでテーブルデータをCSVでExport/Importするやり方と、varcharなどに改行コードを始めとする制御コードが混ざってきた場合の注意点について簡単にまとめます。
<br />
</p>

<p class="paragraph">
参考：
<br />
</p>
<ul><li> DbUnit 公式サイト<ul><li> <a class="externallink" href="http://www.dbunit.org/" target="_blank">http://www.dbunit.org/</a></li></ul></li>
<li> DbUnitとデータ量 - 技術開発日記<ul><li> <a class="externallink" href="http://kechanzahorumon.hatenadiary.com/entry/2012/09/11/122847" target="_blank">http://kechanzahorumon.hatenadiary.com/entry/2012/09/11/122847</a></li></ul></li></ul>

<p class="paragraph">
動作確認：
<br />
</p>
<pre>DbUnit 2.4.9
</pre>

<h3 id="idea5359">CSVでExport/Importするには</h3>

<p class="paragraph">
サンプル : 
<br />
</p>
<ul><li> <a class="externallink" href="https://github.com/msakamoto-sf/javasnack/commit/f9f48bbcd3d26b0bfe36b9b24fa26df693898f38" target="_blank">https://github.com/msakamoto-sf/javasnack/commit/f9f48bbcd3d26b0bfe36b9b24fa26df693898f38</a></li></ul>

<h4 id="id549b42">CSVでExportする</h4>

<p class="paragraph">
CSVでExportするには、 org.dbunit.dataset.csv.CsvDataSetWriter のwrite()メソッドが利用できます。
<br />
</p>

<p class="paragraph">
サンプルは色々混ざってるので、CsvDataSetWriterに関する部分だけ抜き出します。
<br />
</p>
<div class="hl-main"><pre><span class="hl-identifier">File</span><span class="hl-code"> </span><span class="hl-identifier">tmpDir</span><span class="hl-code">;
</span><span class="hl-comment">//</span><span class="hl-comment"> ...</span><span class="hl-comment"></span><span class="hl-code">
</span><span class="hl-identifier">tmpDir</span><span class="hl-code"> = </span><span class="hl-identifier">FileDirHelper</span><span class="hl-code">.</span><span class="hl-identifier">createTmpDir</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-comment">//</span><span class="hl-comment">...</span><span class="hl-comment"></span><span class="hl-code">
</span><span class="hl-comment">//</span><span class="hl-comment"> export only t1, t2 table to CSV</span><span class="hl-comment"></span><span class="hl-code">
</span><span class="hl-identifier">QueryDataSet</span><span class="hl-code"> </span><span class="hl-identifier">exportDataSet</span><span class="hl-code"> = </span><span class="hl-reserved">new</span><span class="hl-code"> </span><span class="hl-identifier">QueryDataSet</span><span class="hl-brackets">(</span><span class="hl-identifier">dbunit_conn</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-identifier">exportDataSet</span><span class="hl-code">.</span><span class="hl-identifier">addTable</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">t1</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-identifier">exportDataSet</span><span class="hl-code">.</span><span class="hl-identifier">addTable</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">t2</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-identifier">CsvDataSetWriter</span><span class="hl-code">.</span><span class="hl-identifier">write</span><span class="hl-brackets">(</span><span class="hl-identifier">exportDataSet</span><span class="hl-code">, </span><span class="hl-identifier">tmpDir</span><span class="hl-brackets">)</span><span class="hl-code">;</span></pre></div>
<p class="paragraph">
write()の第一引数にはIDataSetの実装クラスのインスタンスを渡します。上の例では、対象テーブルを指定するため QueryDataSet を使っていますが、全体をダンプしたい場合は IDatabaseConnection.createDataSet() でも問題ないと思います。
<br />
</p>

<p class="paragraph">
第二引数は、出力先のディレクトリを指定したFileオブジェクトを指定します。出力に成功すると、各テーブル名 + &quot;.csv&quot;というファイルと、&quot;table-orderning.txt&quot;というテキストファイルが生成されます。&quot;table-orderning.txt&quot;は、後でCSVをimportする場合に、テーブルのインポート順序を制御出来ます。
<br />
</p>

<h4 id="id0b56b5">CSVにExportする時、カラムの「型」はどういうロジックで文字列に変換されるか？</h4>

<p class="paragraph">
CsvDataSetWriterクラスのrow()メソッドの中で、各行の各カラムの値ごとに以下のコードで&quot;&quot;囲みの文字列を生成しています。
<br />
</p>
<pre>String stringValue = DataType.asString(value);
final String quoted = quote(stringValue);
</pre>
<p class="paragraph">
org.dbunit.dataset.datatype.DataType.asString() により文字列に変換しています。DataTypeは抽象クラスになっていますが、asString() メソッド自体は実装済みで、中身は以下の1行です。
<br />
</p>
<pre>return (String)DataType.VARCHAR.typeCast(value);
</pre>
<p class="paragraph">
DataType.VARCHARは org.dbunit.dataset.datatype.StringDataType のインスタンスで、そのtypeCast()メソッドが、受け取ったObjectの実際の型に応じて文字列に変換しています。
<br />
結論からいうと、byte[]とBlobはbase64エンコードされ、それ以外は基本的に toString() の結果が採用されます。
<br />
</p>

<h4 id="id55a488">CSVからImportする</h4>

<p class="paragraph">
CsvDataSetWriterで書きだしたCSVファイルセットは、CsvDataSetでそのままIDataSetのインスタンスとしてロード出来ます。CsvDataSetのコンストラクタの第一引数に、CsvDataSetWriterで書きだしたディレクトリのFileオブジェクトを渡せば、後はDatabaseOperationなどにそのまま渡せます。
<br />
</p>
<div class="hl-main"><pre><span class="hl-identifier">IDataSet</span><span class="hl-code"> </span><span class="hl-identifier">csvDataSet</span><span class="hl-code"> = </span><span class="hl-reserved">new</span><span class="hl-code"> </span><span class="hl-identifier">CsvDataSet</span><span class="hl-brackets">(</span><span class="hl-identifier">tmpDir</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-identifier">DatabaseOperation</span><span class="hl-code">.</span><span class="hl-identifier">CLEAN_INSERT</span><span class="hl-code">.</span><span class="hl-identifier">execute</span><span class="hl-brackets">(</span><span class="hl-identifier">dbunit_conn</span><span class="hl-code">, </span><span class="hl-identifier">csvDataSet</span><span class="hl-brackets">)</span><span class="hl-code">;</span></pre></div>

<p class="paragraph">
なおCsvDataSetの実体は、CachedDataSetを継承し、以下のようにCsvProducerクラスをCachedDataSetのコンストラクタに渡しているだけです。そのため、CSVデータのインポート処理の実体はCsvProducerの方でコーディングされています。
<br />
</p>
<div class="hl-main"><pre><span class="hl-reserved">public</span><span class="hl-code"> </span><span class="hl-reserved">class</span><span class="hl-code"> </span><span class="hl-identifier">CsvDataSet</span><span class="hl-code"> </span><span class="hl-reserved">extends</span><span class="hl-code"> </span><span class="hl-identifier">CachedDataSet</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
</span><span class="hl-comment">//</span><span class="hl-comment">...</span><span class="hl-comment"></span><span class="hl-code">
    </span><span class="hl-reserved">public</span><span class="hl-code"> </span><span class="hl-identifier">CsvDataSet</span><span class="hl-brackets">(</span><span class="hl-identifier">File</span><span class="hl-code"> </span><span class="hl-identifier">dir</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-reserved">throws</span><span class="hl-code"> </span><span class="hl-identifier">DataSetException</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-reserved">super</span><span class="hl-brackets">(</span><span class="hl-reserved">new</span><span class="hl-code"> </span><span class="hl-identifier">CsvProducer</span><span class="hl-brackets">(</span><span class="hl-identifier">dir</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-brackets">}</span></pre></div>

<h4 id="idecd830">CSVからImportする時、CSVの文字列はどう処理されるのか？</h4>

<p class="paragraph">
CsvDataSetWriterが出力するCSVは、一行目がカラム名のCSVレコードで、2行目から実際のデータのCSVレコードが始まります。型情報はCSVには出力されません。
<br />
</p>

<p class="paragraph">
CSVからImportする時、文字列として読み取った各カラムの値をどうやって各型に変換しているのか、ちょっとソース追って見ましたがすぐにはわかりませんでした。
<br />
org.dbunit.dataset.csv.CsvProducer.produceFromFile(File theDataFile) 中の以下で、parseしたCSVの各カラムごとに処理しているところまでは確認できたのですが、実際の処理は&quot;_consumer&quot;インスタンス、つまりIDataSetConsumerのインスタンスで、これは IDataSetProducer.setConsumer() により恐らくDatabaseOperationなどからセットされるため、ちょっと辿りきれませんでした・・・。
<br />
</p>

<div class="hl-main"><pre><span class="hl-identifier">_consumer</span><span class="hl-code">.</span><span class="hl-identifier">startTable</span><span class="hl-brackets">(</span><span class="hl-identifier">metaData</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-reserved">for</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">i</span><span class="hl-code"> = </span><span class="hl-number">1</span><span class="hl-code"> ; </span><span class="hl-identifier">i</span><span class="hl-code"> &lt; </span><span class="hl-identifier">readData</span><span class="hl-code">.</span><span class="hl-identifier">size</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">; </span><span class="hl-identifier">i</span><span class="hl-code">++</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">List</span><span class="hl-code"> </span><span class="hl-identifier">rowList</span><span class="hl-code"> = </span><span class="hl-brackets">(</span><span class="hl-identifier">List</span><span class="hl-brackets">)</span><span class="hl-identifier">readData</span><span class="hl-code">.</span><span class="hl-identifier">get</span><span class="hl-brackets">(</span><span class="hl-identifier">i</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">Object</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-code"> </span><span class="hl-identifier">row</span><span class="hl-code"> = </span><span class="hl-identifier">rowList</span><span class="hl-code">.</span><span class="hl-identifier">toArray</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">for</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">col</span><span class="hl-code"> = </span><span class="hl-number">0</span><span class="hl-code">; </span><span class="hl-identifier">col</span><span class="hl-code"> &lt; </span><span class="hl-identifier">row</span><span class="hl-code">.</span><span class="hl-identifier">length</span><span class="hl-code">; </span><span class="hl-identifier">col</span><span class="hl-code">++</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">row</span><span class="hl-brackets">[</span><span class="hl-identifier">col</span><span class="hl-brackets">]</span><span class="hl-code"> = </span><span class="hl-identifier">row</span><span class="hl-brackets">[</span><span class="hl-identifier">col</span><span class="hl-brackets">]</span><span class="hl-code">.</span><span class="hl-identifier">equals</span><span class="hl-brackets">(</span><span class="hl-identifier">CsvDataSetWriter</span><span class="hl-code">.</span><span class="hl-identifier">NULL</span><span class="hl-brackets">)</span><span class="hl-code"> ? </span><span class="hl-reserved">null</span><span class="hl-code"> : </span><span class="hl-identifier">row</span><span class="hl-brackets">[</span><span class="hl-identifier">col</span><span class="hl-brackets">]</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-identifier">_consumer</span><span class="hl-code">.</span><span class="hl-identifier">row</span><span class="hl-brackets">(</span><span class="hl-identifier">row</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-identifier">_consumer</span><span class="hl-code">.</span><span class="hl-identifier">endTable</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;</span></pre></div>

<p class="paragraph">
ただし、一応、export -&gt; import した後のDB内容を確認してみたところ、標準的なカラムに当たり障りの無い値を入れてみた範囲では問題なくINSERTできていたので、多分「よしなに」処理してくれているのではないかなと・・・。
<br />
</p>

<h3 id="id47ba27">varcharに制御コードなどCSVでの処理が怪しくなりそうな文字が入ってくるシステムの場合</h3>

<p class="paragraph">
varcharなどの文字列フィールドに、制御コードなどCSVでの処理が怪しくなりそうな文字が入ってくるシステムの場合、ご想像の通り、まずCSVのexportで「文字化け」します。byte[], blobならexportまでなら少なくともbase64エンコードしてくれるのですが、varcharの場合は普通にStringとして処理され、CSV出力する際に1文字ずつエスケープ処理のフィルタを通過します。その際に、制御コードなどがおかしくなります。CsvDataSetWriter.escape(String) のコードを読んでみてください。
<br />
</p>

<p class="paragraph">
ではどうするか、ですが、色々考えてみたのですが、DataSetのexport/importの既存の仕組みを壊さずに安全に扱おうとしたら、CsvDataSetWriterで escape() するのではなく、もう一律にbase64エンコードしたのを&quot;&quot;囲みにしてしまい、CsvProducerの方でbase64をデコードして文字列に直してから使う、というのがどうにか許容出来る内容になりました。
<br />
</p>
<ul><li> String/varchar型だけbase64出来ないか・・・と考えたのですが：<ul><li> CsvDataSetWriterの方はある程度その判別処理を入れられても、CSV側にBase64した/してないの状態を書き込まないと、CsvProducer側で戻す/戻さないを判別できなくなります。</li>
<li> base64エンコードした/してない、の結果フラグをどこかに残そうとすると、カスタマイズ量が増えそうです。</li></ul></li>
<li> 基本、escape() に渡ってくる段階では、最終的に出力する文字列になってますので、ちょっと乱暴ですが数値や日付型など本来はbase64にする必要が無いデータについても、そのまま文字列としてbase64エンコードしてしまうようにして問題は無さそうです。</li>
<li> blob/byte[]型については、escape()に来る段階では既にbase64エンコードされていますが、いちいち判別するのは面倒くさく、そもそもテストコードで扱う性質なのでパフォーマンスは考えなくて良いので、もう一度一括でbase64エンコードしてしまうことにします。</li></ul>

<p class="paragraph">
ではCsvDataSetWriter/CsvProducerを継承したクラスを用意して、ポイントとなるメソッドだけoverrideすれば良いのか・・・となりますが、別の問題が潜んでいました。CsvDataSetWriter/CsvProducerでは、重要なメンバの幾つかというか殆どがprivate宣言されていて、継承したクラスから参照できない状況です。メソッドのoverrideに支障が出る状況でした。
<br />
</p>

<p class="paragraph">
この辺りでいい加減ブチ切れて、今回は力技で、CsvDataSetWriter/CsvDataSet/CsvProducerのソースコードをまるっとコピーして、base64エンコード/デコードが必要な箇所のみを書き換えてしまうという暴挙に走らせてもらいました。(だからprivateは嫌いだ・・・)
<br />
それが以下のコードになります。
<br />
</p>
<ul><li> <a class="externallink" href="https://github.com/msakamoto-sf/javasnack/commit/ad4d9903cd1b9d26b161b6eb162d05e6b6304f6a" target="_blank">https://github.com/msakamoto-sf/javasnack/commit/ad4d9903cd1b9d26b161b6eb162d05e6b6304f6a</a></li></ul>

<p class="paragraph">
まずCsvBase64BinarySafeDataSetWriterですが、quote()メソッドで以下のように強制的にbase64エンコードしたのを&quot;&quot;囲みにするようにしました。
<br />
</p>
<div class="hl-main"><pre><span class="hl-reserved">private</span><span class="hl-code"> </span><span class="hl-identifier">String</span><span class="hl-code"> </span><span class="hl-identifier">quote</span><span class="hl-brackets">(</span><span class="hl-identifier">String</span><span class="hl-code"> </span><span class="hl-identifier">stringValue</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-reserved">throws</span><span class="hl-code"> </span><span class="hl-identifier">UnsupportedEncodingException</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">logger</span><span class="hl-code">.</span><span class="hl-identifier">debug</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">quote(stringValue={}) - start</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">stringValue</span><span class="hl-brackets">)</span><span class="hl-code">;
 
    </span><span class="hl-comment">//</span><span class="hl-comment"> encode to base64 string</span><span class="hl-comment"></span><span class="hl-code">
    </span><span >byte</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-code"> </span><span class="hl-identifier">rawbytes</span><span class="hl-code"> = </span><span class="hl-identifier">stringValue</span><span class="hl-code">.</span><span class="hl-identifier">getBytes</span><span class="hl-brackets">(</span><span class="hl-identifier">CharsetTool</span><span class="hl-code">.</span><span class="hl-identifier">BINARY</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">String</span><span class="hl-code"> </span><span class="hl-identifier">base64encoded</span><span class="hl-code"> = </span><span class="hl-identifier">Base64</span><span class="hl-code">.</span><span class="hl-identifier">encodeBytes</span><span class="hl-brackets">(</span><span class="hl-identifier">rawbytes</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-comment">//</span><span class="hl-comment"> quote surround</span><span class="hl-comment"></span><span class="hl-code">
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-reserved">new</span><span class="hl-code"> </span><span class="hl-identifier">StringBuffer</span><span class="hl-brackets">(</span><span class="hl-identifier">QUOTE</span><span class="hl-brackets">)</span><span class="hl-code">.</span><span class="hl-identifier">append</span><span class="hl-brackets">(</span><span class="hl-identifier">base64encoded</span><span class="hl-brackets">)</span><span class="hl-code">.</span><span class="hl-identifier">append</span><span class="hl-brackets">(</span><span class="hl-identifier">QUOTE</span><span class="hl-brackets">)</span><span class="hl-code">.</span><span class="hl-identifier">toString</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
これで数値型も日付型も文字列型も、さらに制御コードが混入した文字列も、文字コードがおかしくなる前に、バイナリデータとしてbase64エンコードされます。blob/byte[]型は、既にbase64エンコードされた文字列が入ってきますが、それをもう一度base64エンコードすることになります。
<br />
</p>

<p class="paragraph">
続いて CsvBase64BinarySafeProducer では produceFromFile() のカラム列の処理を以下のように修正しました。NULL以外、全部base64デコードして使うようにしています。
<br />
</p>
<div class="hl-main"><pre><span class="hl-identifier">_consumer</span><span class="hl-code">.</span><span class="hl-identifier">startTable</span><span class="hl-brackets">(</span><span class="hl-identifier">metaData</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-reserved">for</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">i</span><span class="hl-code"> = </span><span class="hl-number">1</span><span class="hl-code"> ; </span><span class="hl-identifier">i</span><span class="hl-code"> &lt; </span><span class="hl-identifier">readData</span><span class="hl-code">.</span><span class="hl-identifier">size</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">; </span><span class="hl-identifier">i</span><span class="hl-code">++</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">List</span><span class="hl-code"> </span><span class="hl-identifier">rowList</span><span class="hl-code"> = </span><span class="hl-brackets">(</span><span class="hl-identifier">List</span><span class="hl-brackets">)</span><span class="hl-identifier">readData</span><span class="hl-code">.</span><span class="hl-identifier">get</span><span class="hl-brackets">(</span><span class="hl-identifier">i</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">Object</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-code"> </span><span class="hl-identifier">row</span><span class="hl-code"> = </span><span class="hl-identifier">rowList</span><span class="hl-code">.</span><span class="hl-identifier">toArray</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">for</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">col</span><span class="hl-code"> = </span><span class="hl-number">0</span><span class="hl-code">; </span><span class="hl-identifier">col</span><span class="hl-code"> &lt; </span><span class="hl-identifier">row</span><span class="hl-code">.</span><span class="hl-identifier">length</span><span class="hl-code">; </span><span class="hl-identifier">col</span><span class="hl-code">++</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">row</span><span class="hl-brackets">[</span><span class="hl-identifier">col</span><span class="hl-brackets">]</span><span class="hl-code">.</span><span class="hl-identifier">equals</span><span class="hl-brackets">(</span><span class="hl-identifier">CsvDataSetWriter</span><span class="hl-code">.</span><span class="hl-identifier">NULL</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
            </span><span class="hl-identifier">row</span><span class="hl-brackets">[</span><span class="hl-identifier">col</span><span class="hl-brackets">]</span><span class="hl-code"> = </span><span class="hl-reserved">null</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code"> </span><span class="hl-reserved">else</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
            </span><span >byte</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-code"> </span><span class="hl-identifier">rawbytes</span><span class="hl-code"> = </span><span class="hl-identifier">Base64</span><span class="hl-code">.</span><span class="hl-identifier">decode</span><span class="hl-brackets">(</span><span class="hl-identifier">row</span><span class="hl-brackets">[</span><span class="hl-identifier">col</span><span class="hl-brackets">]</span><span class="hl-code">.</span><span class="hl-identifier">toString</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
            </span><span class="hl-identifier">row</span><span class="hl-brackets">[</span><span class="hl-identifier">col</span><span class="hl-brackets">]</span><span class="hl-code"> = </span><span class="hl-reserved">new</span><span class="hl-code"> </span><span class="hl-identifier">String</span><span class="hl-brackets">(</span><span class="hl-identifier">rawbytes</span><span class="hl-code">, </span><span class="hl-identifier">CharsetTool</span><span class="hl-code">.</span><span class="hl-identifier">BINARY</span><span class="hl-brackets">)</span><span class="hl-code">;
            
        </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-identifier">_consumer</span><span class="hl-code">.</span><span class="hl-identifier">row</span><span class="hl-brackets">(</span><span class="hl-identifier">row</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-identifier">_consumer</span><span class="hl-code">.</span><span class="hl-identifier">endTable</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;</span></pre></div>

<p class="paragraph">
以上のようにカスタマイズしたクラスを使って、実際に0x00 - 0xFFまでの文字列やバイナリデータをexport/importして最終的に戻せたことを確認しているのが、DbUnitCsvUsageTest.javaの customExportAndImportForControlCodeStrings() メソッドになります。
<br />
</p>
<div class="hl-main"><pre><span class="hl-code">@</span><span class="hl-identifier">Test</span><span class="hl-code">
</span><span class="hl-reserved">public</span><span class="hl-code"> </span><span >void</span><span class="hl-code"> </span><span class="hl-identifier">customExportAndImportForControlCodeStrings</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">
        </span><span class="hl-reserved">throws</span><span class="hl-code"> </span><span class="hl-identifier">IOException</span><span class="hl-code">, </span><span class="hl-identifier">DatabaseUnitException</span><span class="hl-code">, </span><span class="hl-identifier">SQLException</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">IDatabaseConnection</span><span class="hl-code"> </span><span class="hl-identifier">dbunit_conn</span><span class="hl-code"> = </span><span class="hl-reserved">new</span><span class="hl-code"> </span><span class="hl-identifier">DatabaseConnection</span><span class="hl-brackets">(</span><span class="hl-identifier">conn</span><span class="hl-brackets">)</span><span class="hl-code">;
 
    </span><span class="hl-comment">//</span><span class="hl-comment"> cache(save) expected data snap-shot.</span><span class="hl-comment"></span><span class="hl-code">
    </span><span class="hl-identifier">IDataSet</span><span class="hl-code"> </span><span class="hl-identifier">expectedDataSet</span><span class="hl-code"> = </span><span class="hl-reserved">new</span><span class="hl-code"> </span><span class="hl-identifier">CachedDataSet</span><span class="hl-brackets">(</span><span class="hl-code">
            </span><span class="hl-identifier">dbunit_conn</span><span class="hl-code">.</span><span class="hl-identifier">createDataSet</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
 
    </span><span class="hl-comment">//</span><span class="hl-comment"> H2DB can store and load binary string to varchar column safely.</span><span class="hl-comment"></span><span class="hl-code">
    </span><span class="hl-identifier">Set</span><span class="hl-code">&lt;</span><span class="hl-identifier">T4</span><span class="hl-code">&gt; </span><span class="hl-identifier">a</span><span class="hl-code"> = </span><span class="hl-reserved">new</span><span class="hl-code"> </span><span class="hl-identifier">T4</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">.</span><span class="hl-identifier">findAll</span><span class="hl-brackets">(</span><span class="hl-identifier">conn</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">for</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">T4</span><span class="hl-code"> </span><span class="hl-identifier">a2</span><span class="hl-code"> : </span><span class="hl-identifier">a</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">assertEquals</span><span class="hl-brackets">(</span><span class="hl-identifier">a2</span><span class="hl-code">.</span><span class="hl-identifier">stringField</span><span class="hl-code">, </span><span class="hl-identifier">UnsignedByte</span><span class="hl-code">.</span><span class="hl-identifier">create0x00to0xFFString</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
 
    </span><span class="hl-comment">//</span><span class="hl-comment"> export t4 using base64 binary safely csv dataset writer.</span><span class="hl-comment"></span><span class="hl-code">
    </span><span class="hl-identifier">QueryDataSet</span><span class="hl-code"> </span><span class="hl-identifier">exportDataSet</span><span class="hl-code"> = </span><span class="hl-reserved">new</span><span class="hl-code"> </span><span class="hl-identifier">QueryDataSet</span><span class="hl-brackets">(</span><span class="hl-identifier">dbunit_conn</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">exportDataSet</span><span class="hl-code">.</span><span class="hl-identifier">addTable</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">t4</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">CsvBase64BinarySafeDataSetWriter</span><span class="hl-code">.</span><span class="hl-identifier">write</span><span class="hl-brackets">(</span><span class="hl-identifier">exportDataSet</span><span class="hl-code">, </span><span class="hl-identifier">tmpDir</span><span class="hl-brackets">)</span><span class="hl-code">;
 
    </span><span class="hl-comment">//</span><span class="hl-comment"> clear &amp; insert from exported CSV using base64 binary safely csv data producer.</span><span class="hl-comment"></span><span class="hl-code">
    </span><span class="hl-identifier">IDataSet</span><span class="hl-code"> </span><span class="hl-identifier">csvDataSet</span><span class="hl-code"> = </span><span class="hl-reserved">new</span><span class="hl-code"> </span><span class="hl-identifier">CsvBase64BinarySafeDataSet</span><span class="hl-brackets">(</span><span class="hl-identifier">tmpDir</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">DatabaseOperation</span><span class="hl-code">.</span><span class="hl-identifier">CLEAN_INSERT</span><span class="hl-code">.</span><span class="hl-identifier">execute</span><span class="hl-brackets">(</span><span class="hl-identifier">dbunit_conn</span><span class="hl-code">, </span><span class="hl-identifier">csvDataSet</span><span class="hl-brackets">)</span><span class="hl-code">;
 
    </span><span class="hl-identifier">IDataSet</span><span class="hl-code"> </span><span class="hl-identifier">actualDataSet</span><span class="hl-code"> = </span><span class="hl-identifier">dbunit_conn</span><span class="hl-code">.</span><span class="hl-identifier">createDataSet</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">Assertion</span><span class="hl-code">.</span><span class="hl-identifier">assertEquals</span><span class="hl-brackets">(</span><span class="hl-identifier">expectedDataSet</span><span class="hl-code">.</span><span class="hl-identifier">getTable</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">t4</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">,
            </span><span class="hl-identifier">actualDataSet</span><span class="hl-code">.</span><span class="hl-identifier">getTable</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">t4</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>
<p class="paragraph">
0x00-0xFFが混入していることを意識させない、他のDataSet処理と同じ仕組を使って違和感のないコードに仕上がっています。
<br />
</p>


<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-92.html" title="技術/Solaris10インストールメモ">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-150.html" title="技術/TDD/HttpUnit解説リンク">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-23.html" title="技術">技術</a>&nbsp;]</li>
</ul>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/1195<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2001 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a target="_blank" href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" target="_blank" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>