<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Python/Gray Hat Python : reader&#039;s memo - Glamenv-Septzen(en)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index-en.html" title="Glamenv-Septzen(en)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(en)(archive)</a>


<h1 style="margin-bottom: 10px;">Python/Gray Hat Python : reader&#039;s memo</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
created at: 2010-11-04 10:36:10 &nbsp; / &nbsp; last updated at: 2017-01-14 23:54:34<br>
category: <a href="category-en-13.html">Python</a>&nbsp;<a href="category-en-5.html">x86</a>&nbsp;</div>

<div class="data_body">
<p class="paragraph">
&quot;Gray Hat Python&quot; is awesome book. This tells us how Python script language helps, extends, and automates reverse engineering and debugging works.
<br />
Python and reverse engineering tools presented in this book are almost opensource project (except IDA Pro), so you can begin your Gray-Hat-Python exercize without any moneys, dollers, yens.
<br />
</p>

<p class="paragraph">
<a class="externallink" href="https://www.amazon.co.jp/dp/1593271921" target="_blank">Amazon | Gray Hat Python: Python Programming for Hackers and Reverse Engineers | Seitz, Justin | Python</a>
<br />
</p>

<p class="paragraph">
But sadly, there&#039;s some errors in example script and unexpected runtime-errors. Some of them are purely mistaken, some of them are caused by tools/libs version ups (we can&#039;t stop these version ups, because it&#039;s open-source.).
<br />
So I left my reading memos, covering these errors and avoiding affections from version-ups per every chapters.
<br />
</p>

<p class="paragraph">
And 1st, I reccomend you to read update informations from official &quot;Gray Hat Python&quot; book site:
<br />
</p>
<ul><li> Gray Hat Python:<ul><li> <a class="externallink" href="http://nostarch.com/ghpython.htm" target="_blank">http://nostarch.com/ghpython.htm</a></li></ul></li></ul>

<p class="paragraph">
I bought this book at 2010.06.27. If you buy newer version than me, some problems/errors in this article may have been fixed.
<br />
</p>

<p class="paragraph">
And my environment:
<br />
</p>
<pre>OS : Windows XP SP3 Japanese
CPU : Intel PentiumM (cenntrino) 1.2GHz
RAM : 1GB
Python : Python 2.5 (MSI installer), C:\Python25\python.exe
(Python 2.5.2 (r252:60911, Feb 21 2008, 13:11:45) [MSC v.1310 32 bit (Intel)] on win32)

Compiler : Microsoft Visual C++ 2008 Express Edition SP1
&gt; cl 
Microsoft(R) 32-bit C/C++ Optimizing Compiler Version 15.00.30729.01 for 80x86
Copyright (C) Microsoft Corporation.  All rights reserved.
&gt; link
Microsoft (R) Incremental Linker Version 9.00.30729.01
Copyright (C) Microsoft Corporation.  All rights reserved.
</pre>



<ul><li><a href="#id36af9b">Chapter 3 : BUILDING A WINDOWS DEBUGGER</a></li>
<li><a href="#id5e8e7d">Chapter 7 : DLL AND CODE INJECTION</a></li>
<li><a href="#ide1afa0">Chapter 9 : SULLEY</a></li>
<li><a href="#id1246f8">Chapter 10 : FUZZING WINDOWS DRIVERS</a></li></ul>
<hr />
<h3 id="id36af9b">Chapter 3 : BUILDING A WINDOWS DEBUGGER</h3>

<p class="paragraph">
Install PyDBG HowTo : see <a href="./view-en-13.html" >Python/Installing pydasm and pydbg with Python 2.5, WinXP, VC++2008 Express Edition</a>
<br />
</p>

<dl>
<dt> 32p, my_test.py </dt>
<dd>
<pre>debugger.attach(...)
debugger.detach()
</pre>
<p class="paragraph">
→
<br />
</p>
<pre>debugger.attach(...)
debugger.run()
debugger.detach()
</pre></dd>
<dt> 46p, printf_loop.py </dt>
<dd>

<pre>while 1:
    msvcrt.printf(&quot;Loop iteration %d!\n&quot; % counter)
</pre>
<p class="paragraph">
→
<br />
</p>
<pre>while 1:
    msvcrt.printf(&quot;Loop iteration %d!\n&quot;, counter)
</pre>

<p class="paragraph">
Later, in &quot;Chapter 4&quot; 58p printf_random.py exercise, upper version doesn&#039;t work as this book shows, but 2nd version works.
<br />
(This problem has been fixed in zip archive which you download from official site.)
<br />
</p>
</dd>
<dt> 46p - 47p, 0xCC is not restored </dt>
<dd>
<p class="paragraph">
Software breakpoints, 0xCC is not restored yet, so execution flow becomes illegal errors.
<br />
</p></dd>
<dt> 46p - 47p, output messages </dt>
<dd>
<p class="paragraph">
Displayed output messages are different from what you punched from source code in this book.
<br />
In this step, you should download source code from official site ( <a class="externallink" href="http://nostarch.com/ghpython.htm" target="_blank">http://nostarch.com/ghpython.htm</a> ).
<br />
</p></dd>
<dt> 49p, my_debugger.py </dt>
<dd>

<pre>elif self.exception == exception_single_steop:
   self.exception_handler_single_step()
</pre>
<p class="paragraph">
→
<br />
</p>
<pre>elif self.exception == exception_single_steop:
   continue_status = self.exception_handler_single_step()
</pre>
</dd>
<dt> 50p, my_debugger.py </dt>
<dd>

<p class="paragraph">
&quot;DBG_EXCEPTION_NOT_HANDLED&quot; 1st appears, but my_debugger_defines.py downloaded from official site doesn&#039;t include this definition.
<br />
Add to your my_debugger_defines.py by hand : 
<br />
</p>
<pre>DBG_EXCEPTION_NOT_HANDLED = 0x80010001
</pre>
</dd>
<dt> 53p, &quot;VirtualQuery&quot; prototype </dt>
<dd>

<pre>SIZE_T WINAPI VirtualQuery(
    HANDLE hProcess,
    ...
</pre>
<p class="paragraph">
→
<br />
</p>
<pre>SIZE_T WINAPI VirtualQueryEx(
    HANDLE hProcess,
    ...
</pre>

<p class="paragraph">
&quot;VirtualQuery()&quot; doesn&#039;t take other process handle, but &quot;VirtualQueryEx()&quot; does.
<br />
</p></dd>
</dl>

<h3 id="id5e8e7d">Chapter 7 : DLL AND CODE INJECTION</h3>

<dl>
<dt> 102p, code_injection.py </dt>
<dd>

<pre>kernel32      = windll.kernel32
pid           = int(sys.argv[1])
pid_to_kill   = sys.argv[2]

if not sys.argv[1] or not sys.argv[2]:
    print &quot;Code Injector: ./code_injector.py &lt;PID to inject&gt; &lt;PID to Kill&gt;&quot;
    sys.exit(0)
</pre>
<p class="paragraph">
&quot;sys.argv&quot; check timing is wrong.
<br />
→
<br />
</p>
<pre>if len(sys.argv) &lt; 3:
    print &quot;Code Injector: ./codeinjector.py &lt;PID to inject&gt; &lt;PID to kill&gt;&quot;
    sys.exit(0)

kernel32 = windll.kernel32
pid = sys.argv[1]
pid_to_kill = sys.argv[2]
</pre>
</dd>
<dt> 106p, backdoor.py </dt>
<dd>

<p class="paragraph">
In book version:
<br />
</p>
<pre>PAGE_EXECUTE_READWRITE = 0x40
...
    arg_address = kernel32.VirtualAllocEx(
        h_process, 0, len(data), VIRTUAL_MEM,  PAGE_EXECUTE_READWRITE)
</pre>
<p class="paragraph">
It&#039;s correct. Memory area for code injection must be allocated with executable flag.
<br />
</p>

<p class="paragraph">
But zip archive version is wrong:
<br />
</p>
<pre>PAGE_READWRITE     =     0x04
...
    arg_address = kernel32.VirtualAllocEx( 
    h_process, 0, len(data), VIRTUAL_MEM, PAGE_READWRITE)
</pre>

<p class="paragraph">
For backdoor.py, I recommend not to believe zip version backdoor.py.
<br />
</p></dd>
</dl>

<h3 id="ide1afa0">Chapter 9 : SULLEY</h3>

<p class="paragraph">
How to install pcapy on my environment with WinPcap-4.1.x ? : <a href="./view-en-14.html" >Python/Compile &amp; Installing Pcapy with latest WinPcap-4.1.x</a>
<br />
</p>

<dl>
<dt> 131p, ftp_session.py </dt>
<dd>

<p class="paragraph">
Book version is correct, but in zip archive version, double quotation became &#039;“&#039; and &#039;”&#039;. This result:
<br />
</p>
<pre>SyntaxError: Non-ASCII character &#039;\xe2&#039;
</pre>
<p class="paragraph">
→ Fix it by hand, or, punch book version from scratch.
<br />
</p>
</dd>
</dl>

<h3 id="id1246f8">Chapter 10 : FUZZING WINDOWS DRIVERS</h3>

<dl>
<dt> 143p </dt>
<dd>

<pre>C:\WINDOWS\System32\beep.sys
</pre>
<p class="paragraph">
→ In my Windows XP SP3, beep.sys exists:
<br />
</p>
<pre>C:\WINDOWS\System32\drivers\beep.sys
</pre>
</dd>
<dt> 142p - </dt>
<dd>

<p class="paragraph">
(This is NOT book error, but driverlib.py error in ImmunityDebugger.)
<br />
</p>

<p class="paragraph">
In Nov.2010, I downloaded Immunity Debugger Ver 1.73.
<br />
driverlib.py included in v1.73 has some these log() lines : 
<br />
</p>
<pre>self.imm.log(&quot;...(mes)...&quot;, address=...)
</pre>
<p class="paragraph">
This makes errors.
<br />
</p>

<p class="paragraph">
&quot;imm&quot;, &quot;immlib.Debugger&quot; class instance, has 2 log methods:
<br />
</p>
<pre>def log(self, msg)
</pre>
<p class="paragraph">
and
<br />
</p>
<pre>def Log(self, msg, address = 0xbadf00d ,highlight = False, gray = False , focus = 0)
</pre>

<p class="paragraph">
&quot;log()&quot; (all small case) takes only 1 string argument, but &quot;Log()&quot; (heading char is large case) takes other default arguments.
<br />
</p>

<p class="paragraph">
Now, grep &quot;log&quot; in your driverlib.py (C:\Program Files\Immunity Inc\Immunity Debugger\Libs\driverlib.py) and replace &quot;log()&quot; to &quot;Log()&quot; if it passes other arguments.
<br />
</p>
</dd>
</dl>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/en/view/16<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2001 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a target="_blank" href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" target="_blank" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>