<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>技術/TDD/JavaにおけるUnitTest時のMockオブジェクトの導入手法 - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">技術/TDD/JavaにおけるUnitTest時のMockオブジェクトの導入手法</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2009-10-02 10:11:49 &nbsp; / &nbsp; last updated at: 2009-10-03 13:33:10<br>
カテゴリ: <a href="category-11.html">Java</a>&nbsp;<a href="category-51.html">TDD</a>&nbsp;<a href="category-12.html">プログラミング</a>&nbsp;</div>

<div class="data_body">
<p class="paragraph">
JavaでJUnitを使った単体テストのコードを書く時、Mockオブジェクトを使いたい、という場合がある。
<br />
例えばテスト対象のインスタンスメソッドの中で、トランザクションやデータベースの接続クラスのインスタンスをnewしていたりする時、
<br />
単体テストコードを作る為にMockのトランザクション/DB接続クラスに差し替えたい、というケース。
<br />
</p>

<p class="paragraph">
次のIBM developerworks の記事では、テスト対象のメソッドのインターフェイスを変えずに内部だけをリファクタリングし、
<br />
Mockオブジェクトに差し替える手法が紹介されている。
<br />
</p>
<ul><li> &quot;Unit testing with mock objects&quot;<ul><li> <a class="externallink" href="http://www.ibm.com/developerworks/library/j-mocktest.html" target="_blank">http://www.ibm.com/developerworks/library/j-mocktest.html</a></li></ul></li></ul>

<p class="paragraph">
以下に、大まかなリファクタリングの流れやポイントを抜き書きする。
<br />
なおMockオブジェクトとは何か、テストコードを書く時どう便利か、などについては他の記事・書籍を参照の事。
<br />
</p>

<p class="paragraph">
（追記）
<br />
Mockオブジェクト作成の部分に限って言えば、Javaの場合は2009/10現在であればEasyMockやjMockライブラリがあるので、実際はそちらを使った方が良いかも知れない。
<br />
</p>
<ul><li> EasyMock : Home<ul><li> <a class="externallink" href="http://www.easymock.org/" target="_blank">http://www.easymock.org/</a></li></ul></li>
<li> jMock - A Lightweight Mock Object Library for Java<ul><li> <a class="externallink" href="http://www.jmock.org/" target="_blank">http://www.jmock.org/</a></li></ul></li></ul>




<h3 id="id15dfe7">リファクタリングの流れ</h3>

<p class="paragraph">
まずリファクタリング前のテスト対象のコードを示す。
<br />
</p>
<div class="hl-main"><pre><span class="hl-reserved">class</span><span class="hl-code"> </span><span class="hl-identifier">Application</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
  </span><span class="hl-comment">//</span><span class="hl-comment">...</span><span class="hl-comment"></span><span class="hl-code">
  </span><span class="hl-reserved">public</span><span class="hl-code"> </span><span >void</span><span class="hl-code"> </span><span class="hl-identifier">run</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">View</span><span class="hl-code"> </span><span class="hl-identifier">v</span><span class="hl-code"> = </span><span class="hl-reserved">new</span><span class="hl-code"> </span><span class="hl-identifier">View</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">v</span><span class="hl-code">.</span><span class="hl-identifier">display</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-comment">//</span><span class="hl-comment">...</span><span class="hl-comment"></span><span class="hl-code">
  </span><span class="hl-brackets">}</span><span class="hl-code">
  </span><span class="hl-comment">//</span><span class="hl-comment">...</span><span class="hl-comment"></span><span class="hl-code">
</span><span class="hl-brackets">}</span></pre></div>
<p class="paragraph">
Applicationクラスのインスタンスメソッドrun()をテストしたいが、ここでViewクラスをMockオブジェクトにしたい。
<br />
</p>

<p class="paragraph">
元記事で紹介している手法では、まずApplicationクラスの中でprotectedなfactoryメソッドを用意する。
<br />
</p>
<div class="hl-main"><pre><span class="hl-reserved">class</span><span class="hl-code"> </span><span class="hl-identifier">Application</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
  </span><span class="hl-comment">//</span><span class="hl-comment">...</span><span class="hl-comment"></span><span class="hl-code">
  </span><span class="hl-reserved">public</span><span class="hl-code"> </span><span >void</span><span class="hl-code"> </span><span class="hl-identifier">run</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">View</span><span class="hl-code"> </span><span class="hl-identifier">v</span><span class="hl-code"> = </span><span class="hl-identifier">createView</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">v</span><span class="hl-code">.</span><span class="hl-identifier">display</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-comment">//</span><span class="hl-comment">...</span><span class="hl-comment"></span><span class="hl-code">
  </span><span class="hl-brackets">}</span><span class="hl-code">
  </span><span class="hl-reserved">protected</span><span class="hl-code"> </span><span class="hl-identifier">View</span><span class="hl-code"> </span><span class="hl-identifier">createView</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-reserved">new</span><span class="hl-code"> </span><span class="hl-identifier">View</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
  </span><span class="hl-brackets">}</span><span class="hl-code">
  </span><span class="hl-comment">//</span><span class="hl-comment">...</span><span class="hl-comment"></span><span class="hl-code">
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
そしてテストコード側では、インナークラスを利用してその場でcreateView()メソッドをMockオブジェクトを返すようにしたApplicationクラスを作り、
<br />
それをテスト対象とする。
<br />
</p>
<div class="hl-main"><pre><span class="hl-reserved">class</span><span class="hl-code"> </span><span class="hl-identifier">ApplicationTest</span><span class="hl-code"> </span><span class="hl-reserved">extends</span><span class="hl-code"> </span><span class="hl-identifier">TestCase</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
  </span><span class="hl-comment">//</span><span class="hl-comment"> まずMockとなるViewクラスとそのインスタンスを用意しておく。</span><span class="hl-comment"></span><span class="hl-code">
  </span><span class="hl-identifier">MockView</span><span class="hl-code"> </span><span class="hl-identifier">mockView</span><span class="hl-code"> = </span><span class="hl-reserved">new</span><span class="hl-code"> </span><span class="hl-identifier">MockView</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
  </span><span class="hl-comment">//</span><span class="hl-comment"> この例では単純に&quot;display()メソッドが呼ばれたか?&quot;だけを後でassert出来るようにしておく。</span><span class="hl-comment"></span><span class="hl-code">
  </span><span class="hl-reserved">private</span><span class="hl-code"> </span><span class="hl-reserved">class</span><span class="hl-code"> </span><span class="hl-identifier">MockView</span><span class="hl-code"> </span><span class="hl-reserved">extends</span><span class="hl-code"> </span><span class="hl-identifier">View</span><span class="hl-code">
  </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span >boolean</span><span class="hl-code"> </span><span class="hl-identifier">isDisplayed</span><span class="hl-code"> = </span><span class="hl-reserved">false</span><span class="hl-code">;
    </span><span class="hl-reserved">public</span><span class="hl-code"> </span><span >void</span><span class="hl-code"> </span><span class="hl-identifier">display</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
      </span><span class="hl-identifier">isDisplayed</span><span class="hl-code"> = </span><span class="hl-reserved">true</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">public</span><span class="hl-code"> </span><span >void</span><span class="hl-code"> </span><span class="hl-identifier">validate</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
      </span><span class="hl-identifier">assertTrue</span><span class="hl-brackets">(</span><span class="hl-identifier">isDisplayed</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
  </span><span class="hl-brackets">}</span><span class="hl-code">
 
  </span><span class="hl-comment">//</span><span class="hl-comment"> 実際のテストコード</span><span class="hl-comment"></span><span class="hl-code">
  </span><span class="hl-reserved">public</span><span class="hl-code"> </span><span >void</span><span class="hl-code"> </span><span class="hl-identifier">testApplication</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-comment">//</span><span class="hl-comment"> ここで、createView()だけ差し替えたApplicationクラス(の派生クラス)を</span><span class="hl-comment"></span><span class="hl-code">
    </span><span class="hl-comment">//</span><span class="hl-comment"> インナークラスで作る。これによりMockのViewを使ってrun()が実行される。</span><span class="hl-comment"></span><span class="hl-code">
    </span><span class="hl-identifier">Application</span><span class="hl-code"> </span><span class="hl-identifier">a</span><span class="hl-code"> = </span><span class="hl-reserved">new</span><span class="hl-code"> </span><span class="hl-identifier">Application</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
      </span><span class="hl-reserved">protected</span><span class="hl-code"> </span><span class="hl-identifier">View</span><span class="hl-code"> </span><span class="hl-identifier">createView</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">mockView</span><span class="hl-code">;
      </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-brackets">}</span><span class="hl-code">;
    </span><span class="hl-identifier">a</span><span class="hl-code">.</span><span class="hl-identifier">run</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">mockView</span><span class="hl-code">.</span><span class="hl-identifier">validate</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
  </span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-brackets">}</span></pre></div>

<h3 id="id4b1085">基本手順</h3>

<p class="paragraph">
先の例で示したリファクタリング作業を、言葉で説明すると次のようになる。
<br />
まず用語を整理しておく。
<br />
</p>

<ol><li> テスト対象オブジェクト(target object)</li>
<li> 関連オブジェクト(collaborator object) : テスト対象オブジェクトによりnewされたり、取得されるオブジェクト</li>
<li> Mockオブジェクト : 関連オブジェクトの中で、Mockにする派生クラス or 実装クラスとそのインスタンス</li>
<li> 特異オブジェクト(specialization object) : Mockオブジェクトを使うようにリファクタリングされたテスト対象オブジェクト</li></ol>

<p class="paragraph">
以上の用語を用い、手順を説明する。
<br />
</p>

<ol><li> テスト対象オブジェクトの中でnewするかsetter/getterなどから取得される関連オブジェクトを洗い出しておく。</li>
<li><em>Extract Method</em>を関連オブジェクトのnew/取得部分に適用し、factoryメソッドを作る。(Martin Fowlerの「Refactoring: Improving the Design of Existing Code (Hardcover)」 110p 参照)</li>
<li> factoryメソッドについては、テスト対象オブジェクトとそのサブクラスからアクセス可能にしておく。Javaであればprotectedメソッドにしておく。</li>
<li> テストコードの中で、関連オブジェクトと同じインターフェイスのMockオブジェクトを作る。</li>
<li> テストコードの中で、テスト対象オブジェクトの派生クラスである特異オブジェクトを作る。</li>
<li> 特異オブジェクトの中で、テストを通せるよう、factoryメソッドを上書きしてMockオブジェクトを返すようにする。</li>
<li> (オプション) 元々のテスト対象オブジェクトのfactoryメソッドが、Mockオブジェクトではなく本来の関連オブジェクトを返す事をテストする。</li></ol>

<h3 id="ida3c85b">リファクタリング例</h3>

<p class="paragraph">
銀行のATM装置のテストを書く場面をサンプルとして、リファクタリングをしてみる。
<br />
Mockオブジェクトを導入する前の単体テストコードを以下に示す。
<br />
</p>
<div class="hl-main"><pre><span class="hl-comment">//</span><span class="hl-comment"> 引き落としの確認</span><span class="hl-comment"></span><span class="hl-code">
</span><span class="hl-reserved">public</span><span class="hl-code"> </span><span >void</span><span class="hl-code"> </span><span class="hl-identifier">testCheckingWithdrawal</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
  </span><span class="hl-comment">//</span><span class="hl-comment"> 開始時点での残高</span><span class="hl-comment"></span><span class="hl-code">
  </span><span >float</span><span class="hl-code"> </span><span class="hl-identifier">startingBalance</span><span class="hl-code"> = </span><span class="hl-identifier">balanceForTestCheckingAccount</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
 
  </span><span class="hl-identifier">AtmGui</span><span class="hl-code"> </span><span class="hl-identifier">atm</span><span class="hl-code"> = </span><span class="hl-reserved">new</span><span class="hl-code"> </span><span class="hl-identifier">AtmGui</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
  </span><span class="hl-identifier">insertCardAndInputPin</span><span class="hl-brackets">(</span><span class="hl-identifier">atm</span><span class="hl-brackets">)</span><span class="hl-code">;
 
  </span><span class="hl-identifier">atm</span><span class="hl-code">.</span><span class="hl-identifier">pressButton</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">Withdraw</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">; </span><span class="hl-comment">//</span><span class="hl-comment"> 引き落とし</span><span class="hl-comment"></span><span class="hl-code">
  </span><span class="hl-identifier">atm</span><span class="hl-code">.</span><span class="hl-identifier">pressButton</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">Checking</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
  </span><span class="hl-identifier">atm</span><span class="hl-code">.</span><span class="hl-identifier">pressButtons</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">1</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">0</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">0</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">0</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">0</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
  </span><span class="hl-identifier">assertContains</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">$100.00</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">atm</span><span class="hl-code">.</span><span class="hl-identifier">getDisplayContents</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
  </span><span class="hl-identifier">atm</span><span class="hl-code">.</span><span class="hl-identifier">pressButton</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">Continue</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
 
  </span><span class="hl-identifier">assertEquals</span><span class="hl-brackets">(</span><span class="hl-identifier">startingBalance</span><span class="hl-code"> - </span><span class="hl-number">100</span><span class="hl-code">, </span><span class="hl-identifier">balanceForTestCheckingAccount</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
引き落としに対応するAtmGuiクラスのコードは以下のようなものとする。
<br />
</p>
<div class="hl-main"><pre><span class="hl-reserved">private</span><span class="hl-code"> </span><span class="hl-identifier">Status</span><span class="hl-code"> </span><span class="hl-identifier">doWithdrawal</span><span class="hl-brackets">(</span><span class="hl-identifier">Account</span><span class="hl-code"> </span><span class="hl-identifier">account</span><span class="hl-code">, </span><span >float</span><span class="hl-code"> </span><span class="hl-identifier">amount</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
  </span><span class="hl-identifier">Transaction</span><span class="hl-code"> </span><span class="hl-identifier">transaction</span><span class="hl-code"> = </span><span class="hl-reserved">new</span><span class="hl-code"> </span><span class="hl-identifier">Transaction</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
  </span><span class="hl-identifier">transaction</span><span class="hl-code">.</span><span class="hl-identifier">setSourceAccount</span><span class="hl-brackets">(</span><span class="hl-identifier">account</span><span class="hl-brackets">)</span><span class="hl-code">;
  </span><span class="hl-identifier">transaction</span><span class="hl-code">.</span><span class="hl-identifier">setDestAccount</span><span class="hl-brackets">(</span><span class="hl-identifier">myCashAccount</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
  </span><span class="hl-identifier">transaction</span><span class="hl-code">.</span><span class="hl-identifier">setAmount</span><span class="hl-brackets">(</span><span class="hl-identifier">amount</span><span class="hl-brackets">)</span><span class="hl-code">;
  </span><span class="hl-identifier">transaction</span><span class="hl-code">.</span><span class="hl-identifier">process</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
  </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">transaction</span><span class="hl-code">.</span><span class="hl-identifier">successful</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">dispense</span><span class="hl-brackets">(</span><span class="hl-identifier">amount</span><span class="hl-brackets">)</span><span class="hl-code">;
  </span><span class="hl-brackets">}</span><span class="hl-code">
  </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">transaction</span><span class="hl-code">.</span><span class="hl-identifier">getStatus</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
このやり方は動く事は動く。しかしチェック対象のアカウントの残高が直接マイナスされるため、この単体テストの前後のテストコードに影響する怖れがある。
<br />
対処法としては、例えばテストコード中に前提条件に必要な残高の値をチェックしたり、あるいは補正するコードを実装する手法があるが、テストや実装コードが複雑になる。
<br />
ここではMockオブジェクトを導入するリファクタリングにより、実際のTransactionクラスではなくMockのTransactionを使うようにしてみる。
<br />
</p>

<p class="paragraph">
まず関連オブジェクトはTransactionなので、それのfactoryメソッド(protected)を導入する。
<br />
</p>
<div class="hl-main"><pre><span class="hl-reserved">private</span><span class="hl-code"> </span><span class="hl-identifier">Status</span><span class="hl-code"> </span><span class="hl-identifier">doWithdrawal</span><span class="hl-brackets">(</span><span class="hl-identifier">Account</span><span class="hl-code"> </span><span class="hl-identifier">account</span><span class="hl-code">, </span><span >float</span><span class="hl-code"> </span><span class="hl-identifier">amount</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
  </span><span class="hl-identifier">Transaction</span><span class="hl-code"> </span><span class="hl-identifier">transaction</span><span class="hl-code"> = </span><span class="hl-identifier">createTransaction</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">; </span><span class="hl-comment">//</span><span class="hl-comment"> &quot;new Transaction()&quot;から修正</span><span class="hl-comment"></span><span class="hl-code">
  </span><span class="hl-identifier">transaction</span><span class="hl-code">.</span><span class="hl-identifier">setSourceAccount</span><span class="hl-brackets">(</span><span class="hl-identifier">account</span><span class="hl-brackets">)</span><span class="hl-code">;
  </span><span class="hl-identifier">transaction</span><span class="hl-code">.</span><span class="hl-identifier">setDestAccount</span><span class="hl-brackets">(</span><span class="hl-identifier">myCashAccount</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
  </span><span class="hl-identifier">transaction</span><span class="hl-code">.</span><span class="hl-identifier">setAmount</span><span class="hl-brackets">(</span><span class="hl-identifier">amount</span><span class="hl-brackets">)</span><span class="hl-code">;
  </span><span class="hl-identifier">transaction</span><span class="hl-code">.</span><span class="hl-identifier">process</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
  </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">transaction</span><span class="hl-code">.</span><span class="hl-identifier">successful</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">dispense</span><span class="hl-brackets">(</span><span class="hl-identifier">amount</span><span class="hl-brackets">)</span><span class="hl-code">;
  </span><span class="hl-brackets">}</span><span class="hl-code">
  </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">transaction</span><span class="hl-code">.</span><span class="hl-identifier">getStatus</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
 
</span><span class="hl-comment">//</span><span class="hl-comment"> 追加したfactoryメソッド</span><span class="hl-comment"></span><span class="hl-code">
</span><span class="hl-reserved">protected</span><span class="hl-code"> </span><span class="hl-identifier">Transaction</span><span class="hl-code"> </span><span class="hl-identifier">createTransaction</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
  </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-reserved">new</span><span class="hl-code"> </span><span class="hl-identifier">Transaction</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
テストクラスの方で、MockTransactionクラスをメンバクラスとして定義する。
<br />
</p>
<div class="hl-main"><pre><span class="hl-reserved">private</span><span class="hl-code"> </span><span class="hl-identifier">MockTransaction</span><span class="hl-code"> </span><span class="hl-reserved">extends</span><span class="hl-code"> </span><span class="hl-identifier">Transaction</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
 
  </span><span class="hl-reserved">private</span><span class="hl-code"> </span><span >boolean</span><span class="hl-code"> </span><span class="hl-identifier">processCalled</span><span class="hl-code"> = </span><span class="hl-reserved">false</span><span class="hl-code">;
 
  </span><span class="hl-comment">//</span><span class="hl-comment"> 実際の処理が行われないよう、process()メソッドをオーバーライドしておく。</span><span class="hl-comment"></span><span class="hl-code">
  </span><span class="hl-reserved">public</span><span class="hl-code"> </span><span >void</span><span class="hl-code"> </span><span class="hl-identifier">process</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">processCalled</span><span class="hl-code"> = </span><span class="hl-reserved">true</span><span class="hl-code">;
    </span><span class="hl-identifier">setStatus</span><span class="hl-brackets">(</span><span class="hl-identifier">Status</span><span class="hl-code">.</span><span class="hl-identifier">SUCCESS</span><span class="hl-brackets">)</span><span class="hl-code">;
  </span><span class="hl-brackets">}</span><span class="hl-code">
 
  </span><span class="hl-comment">//</span><span class="hl-comment"> Mockが正常に呼ばれたかassertするために使う</span><span class="hl-comment"></span><span class="hl-code">
  </span><span class="hl-reserved">public</span><span class="hl-code"> </span><span >void</span><span class="hl-code"> </span><span class="hl-identifier">validate</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">assertTrue</span><span class="hl-brackets">(</span><span class="hl-identifier">processCalled</span><span class="hl-brackets">)</span><span class="hl-code">;
  </span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
最後に、MockTransactionクラスを使うようにした特異オブジェクトをテストコードの中で作成する。
<br />
</p>
<div class="hl-main"><pre><span class="hl-reserved">public</span><span class="hl-code"> </span><span >void</span><span class="hl-code"> </span><span class="hl-identifier">testCheckingWithdrawal</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
 
  </span><span class="hl-identifier">mockTransaction</span><span class="hl-code"> = </span><span class="hl-reserved">new</span><span class="hl-code"> </span><span class="hl-identifier">MockTransaction</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
 
  </span><span class="hl-comment">//</span><span class="hl-comment"> Mockを使うようにした特異オブジェクトを作成</span><span class="hl-comment"></span><span class="hl-code">
  </span><span class="hl-identifier">AtmGui</span><span class="hl-code"> </span><span class="hl-identifier">atm</span><span class="hl-code"> = </span><span class="hl-reserved">new</span><span class="hl-code"> </span><span class="hl-identifier">AtmGui</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
      </span><span class="hl-reserved">protected</span><span class="hl-code"> </span><span class="hl-identifier">Transaction</span><span class="hl-code"> </span><span class="hl-identifier">createTransaction</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">mockTransaction</span><span class="hl-code">;
      </span><span class="hl-brackets">}</span><span class="hl-code">
  </span><span class="hl-brackets">}</span><span class="hl-code">;
 
  </span><span class="hl-identifier">insertCardAndInputPin</span><span class="hl-brackets">(</span><span class="hl-identifier">atm</span><span class="hl-brackets">)</span><span class="hl-code">;
 
  </span><span class="hl-identifier">atm</span><span class="hl-code">.</span><span class="hl-identifier">pressButton</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">Withdraw</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
  </span><span class="hl-identifier">atm</span><span class="hl-code">.</span><span class="hl-identifier">pressButton</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">Checking</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
  </span><span class="hl-identifier">atm</span><span class="hl-code">.</span><span class="hl-identifier">pressButtons</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">1</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">0</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">0</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">0</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">0</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
  </span><span class="hl-identifier">assertContains</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">$100.00</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">atm</span><span class="hl-code">.</span><span class="hl-identifier">getDisplayContents</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
  </span><span class="hl-identifier">atm</span><span class="hl-code">.</span><span class="hl-identifier">pressButton</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">Continue</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
 
  </span><span class="hl-identifier">assertEquals</span><span class="hl-brackets">(</span><span class="hl-number">100</span><span class="hl-number">.00</span><span class="hl-code">, </span><span class="hl-identifier">mockTransaction</span><span class="hl-code">.</span><span class="hl-identifier">getAmount</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
  </span><span class="hl-identifier">assertEquals</span><span class="hl-brackets">(</span><span class="hl-identifier">TEST_CHECKING_ACCOUNT</span><span class="hl-code">, </span><span class="hl-identifier">mockTransaction</span><span class="hl-code">.</span><span class="hl-identifier">getSourceAccount</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
  </span><span class="hl-identifier">assertEquals</span><span class="hl-brackets">(</span><span class="hl-identifier">TEST_CASH_ACCOUNT</span><span class="hl-code">, </span><span class="hl-identifier">mockTransaction</span><span class="hl-code">.</span><span class="hl-identifier">getDestAccount</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
  </span><span class="hl-identifier">mockTransaction</span><span class="hl-code">.</span><span class="hl-identifier">validate</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
こうすることで、残高の前提条件を気にする事は無くなり、Transactionオブジェクトに渡した値が正常である事をもって、引き落とし処理の確認と出来る。
<br />
<strong>実際に前後の残高をチェックするのは、AtmGuiクラスとTransactionクラスの結合した時の挙動に関わってくる為、結合テストでチェックする事としておく。</strong>
<br />
この例では単体テストの意味を、あくまでもテスト対象のオブジェクトのI/Oのみをチェックするものとしている。
<br />
ここでのテスト対象はAtmGuiであるので、AtmGuiがTransactionオブジェクトと予期したとおりにコミュニケーションできていれば問題ないものとしている。
<br />
</p>

<h3 id="idd47403">インナークラスの使用について</h3>

<p class="paragraph">
ATMの例ではAtmGuiのcreateTransactionメソッドのみをインナークラスで派生させオーバーライドしている。今回は1メソッドをオーバーライドすることで簡単に対処できた。
<br />
他のテストで別のメソッドをオーバーライドしたい場合などは、インナークラスではなく普通のクラスとしてまとめた方がよいかも知れない。
<br />
</p>

<p class="paragraph">
もう一つ、インナークラスを使った理由としてはMockオブジェクトを簡単に共有できるからという理由がある。
<br />
インナークラス内からは、その外部の変数にアクセスできる。そのため、テストコード中でnewしたMockTransactionインスタンスをそのまま、Mockのfactoryメソッドが返すようになっている。
<br />
</p>

<p class="paragraph">
インナークラスからその外部へのアクセスについては、マルチスレッドや再入問題(re-entrant)が絡む場合は注意する事(synchronizedで保護するなど)。
<br />
</p>

<h3 id="id4b3d98">本当はMockではなくTransactionを使っているか？のテスト</h3>

<p class="paragraph">
上のATMの例では、実際のコードではMockTransactionではないホンモノのTransactionを使っているか？という点をテスト出来ていない。
<br />
これをテストするには、下記のようにcreateTransaction()メソッドの戻り値のクラスをチェックする。
<br />
</p>
<div class="hl-main"><pre><span class="hl-identifier">AtmGui</span><span class="hl-code"> </span><span class="hl-identifier">atm</span><span class="hl-code"> = </span><span class="hl-reserved">new</span><span class="hl-code"> </span><span class="hl-identifier">AtmGui</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-identifier">Transaction</span><span class="hl-code"> </span><span class="hl-identifier">t</span><span class="hl-code"> = </span><span class="hl-identifier">atm</span><span class="hl-code">.</span><span class="hl-identifier">createTransaction</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-identifier">assertTrue</span><span class="hl-brackets">(</span><span class="hl-code">!</span><span class="hl-brackets">(</span><span class="hl-identifier">t</span><span class="hl-code"> </span><span class="hl-reserved">instanceof</span><span class="hl-code"> </span><span class="hl-identifier">MockTransaction</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;</span></pre></div>
<p class="paragraph">
このテストを通す為には以下の条件が満たされている必要がある。
<br />
</p>
<ol><li> createTransaction()がprotectedであること。</li>
<li> テストクラスがAtmGuiと同じpackageにあること。</li></ol>

<p class="paragraph">
なおAtmGuiとcreateTransaction()がpublicである場合は、テストクラスのpackageは何処でも構わない
<br />
</p>

<p class="paragraph">
ちなみに、以下のassertは今回は使えない。
<br />
</p>
<pre>assertTrue(t instanceof Transaction)
</pre>
<p class="paragraph">
なぜならMockTransactionはTransactionの派生である為、MockTransactionオブジェクトが返された場合もこのassertは成立してしまうからである。
<br />
</p>

<h3 id="id2f808a">From factory method to abstract factory</h3>

<p class="paragraph">
元記事では、ここで&quot;From factory method to abstract factory&quot;というセクションがあり抽象ファクトリを導入してみてはどうか、という意見に対する反論が載せられている。
<br />
詳細は元記事を参照して貰うとして、こちらでは自分自身の意見をまとめてみる。（概要としては元記事とあまり変わらない・・・とは思ってます）
<br />
</p>

<p class="paragraph">
話題になっているのは、要するにテスト対象のインターフェイス（返値や引数）を変えてもっとテストしやすくしてはどうか、という事なのだけれど、それは主従が逆転してしまうのではないか。
<br />
テストの為にインターフェイスを変えるのはやりすぎだ、という事。
<br />
またそれに関連して、新しいクラス/インスタンスとのコミュニケーションを追加するのは、テストする時の相互作用を増やしてしまうので良くないのでは、と言う事。
<br />
</p>

<p class="paragraph">
自分の基本的な認識としては、「リファクタリング」は外部インターフェイスを変えずに内部を改修する為の手法であるため、インターフェイスを変えてしまうのはリファクタリングの範疇を超える。
<br />
今回のATMの例では、publicメソッドのインターフェイスは変えずに、内部でcreateTransaction()を用意する事で何とか対処できた。これはリファクタリングの範疇内であると考えている。
<br />
</p>

<p class="paragraph">
テストコードの複雑さについては、Mockオブジェクトを利用した場合も、利用せずに残高のチェックや補正用のコードを実装した場合も、あまり「複雑さ」という点では変わらないと思う。
<br />
むしろインナークラスが出てきたりするので、その辺を押さえたレベルのJavaプログラマでないとテストコードを理解したり、自分なりのテストを追加するのもままならない。
<br />
</p>

<p class="paragraph">
ただし、ここで注目すべきはむしろテストコードの「副作用」だと考えている。
<br />
残高チェックや補正用コードをテストの為に実装するのは、そもそも元のテストコードが副作用を持っていたからである。
<br />
テストコード間で副作用があるために、その副作用を抑える為にあれやこれやと「テスト用ユーティリティクラス/メソッド」が実装されていく事になる。
<br />
そのためにコード量が増えて複雑さが増したとして、それでも副作用自体は残っているわけであるから、いつかどこかで綻びが出てくる。
<br />
そしてその都度、あれやこれやとテスト間の影響をデバッグしたりして調査する事になる。
<br />
</p>

<p class="paragraph">
であるならば、複雑さ(コード量/Javaプログラマに要求される技量)が増えたとしても副作用それ自体を減少させる方向に向かった方が良い。
<br />
そのための手法の一つが、今回元記事で紹介されているリファクタリング例であると考える。
<br />
</p>

<p class="paragraph">
まぁ実際問題、テストコードというのは書くのが難しい・・・。YakiBikiでもそうだったけど。
<br />
どこまで単体テストの範疇にするのか、という問題もあるし。というかそこを間違えると、テストコード作成の難易度が一気に上下する。
<br />
とりあえず、今回の元記事で紹介されているリファクタリングの手法をストックしておき、どこかで使えると良いのだけれど・・・。
<br />
</p>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/448<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2001 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a target="_blank" href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" target="_blank" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>