<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>C言語系/「デーモン君のソース探検」読書メモ/A03, ttyname(3) - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">C言語系/「デーモン君のソース探検」読書メモ/A03, ttyname(3)</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2010-02-03 19:32:51 &nbsp; / &nbsp; last updated at: 2010-02-03 19:35:05<br>
カテゴリ: <a href="category-32.html">BSD</a>&nbsp;<a href="category-10.html">C言語</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-574.html" title="C言語系/「デーモン君のソース探検」読書メモ/A02, tee(1)">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-576.html" title="C言語系/「デーモン君のソース探検」読書メモ/A04, isatty(3)">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-478.html" title="C言語系">C言語系</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
お題：ttyname(3)が端末のデバイスファイル名を取得する仕組みを調査せよ
<br />
</p>

<p class="paragraph">
※この章は「デーモン君のソース探検」に載っていませんが、msakamoto-sf自身が個人的に興味を持って調べ、&quot;Appendix&quot;として読書メモシリーズに入れてありますのでご注意下さい。
<br />
</p>



<ul><li><a href="#idc489d6">ttyname(3), ttyname.c</a></li>
<li><a href="#id4c1e84">devname(3)</a></li>
<li><a href="#ide16122">dev_mkdb(8), dev_mkdb.c</a></li></ul>
<hr />
<h3 id="idc489d6">ttyname(3), ttyname.c</h3>

<p class="paragraph">
まずソースファイルの場所を調べる。
<br />
</p>
<pre>$ locate ttyname
/usr/share/man/cat3/ttyname.0
/usr/share/man/man3/ttyname.3
/usr/src/lib/libc/gen/ttyname.3
/usr/src/lib/libc/gen/ttyname.c
</pre>

<p class="paragraph">
ソースコードはコンパクトになっている。oldttyname()については本筋と離れるので省略する。
<br />
</p>
<pre class="plugin_pre">
static char buf[sizeof(_PATH_DEV) + MAXNAMLEN] = _PATH_DEV;

char *
ttyname(fd)
  int fd;
{
  struct stat sb;
  struct termios ttyb;
  DB *db;
  DBT data, key;
  struct {
    mode_t type;
    dev_t dev;
  } bkey;

  _DIAGASSERT(fd != -1);

  /* Must be a terminal. */
  if (tcgetattr(fd, &amp;ttyb) &lt; 0)
    return (NULL);
  /* Must be a character device. */
  if (fstat(fd, &amp;sb) || !S_ISCHR(sb.st_mode))
    return (NULL);

  if ((db = dbopen(_PATH_DEVDB, O_RDONLY, 0, DB_HASH, NULL)) != NULL) {
    memset(&amp;bkey, 0, sizeof(bkey));
    bkey.type = S_IFCHR;
    bkey.dev = sb.st_rdev;
    key.data = &amp;bkey;
    key.size = sizeof(bkey);
    if (!(db-&gt;get)(db, &amp;key, &amp;data, 0)) {
      memmove(buf + sizeof(_PATH_DEV) - 1, data.data,
          data.size);
      (void)(db-&gt;close)(db);
      return (buf);
    }
    (void)(db-&gt;close)(db);
  }
  return (oldttyname(&amp;sb));
}
</pre>
<p class="paragraph">
変数宣言の後tcgetattr()とfstat(2)により、引数で渡されたファイル記述子が端末に結びついていて、キャラクタデバイスであることをチェックしている。
<br />
その後 dbopen(3) により&quot;_PATH_DEVDB&quot; で指定されたデータベースファイルをオープンし、S_IFCHRとfstat(2)で取得したstat構造体のst_rdevメンバ(=デバイスファイルのデバイスタイプ)をキーとしてエントリを取得、bufにdataをコピーする。
<br />
</p>

<h3 id="id4c1e84">devname(3)</h3>

<p class="paragraph">
ここまででttyname(3)の調査としては問題ないが、いきなり_PATH_DEVDBをdbopen(3)で操作しているのが気になる。続いて&quot;_PATH_DEVDB&quot;について調べてみる。
<br />
</p>

<p class="paragraph">
&quot;_PATH_DEVDB&quot;は paths.h で定義されている。
<br />
paths.h:
<br />
</p>
<pre>#define _PATH_DEVDB     &quot;/var/run/dev.db&quot;
...
#define _PATH_DEV       &quot;/dev/&quot;
</pre>

<p class="paragraph">
たまたまttyname.cと同じディレクトリにdevname.cがあるのを見つけ、devname.3というmanページもあった。devname.cはdevname(3)のソースコードになっていて、デバイス名を取得する関数としてより汎用的なインターフェイスになっている。
<br />
</p>
<pre class="plugin_pre">
DEVNAME(3)                NetBSD Programmer&#039;s Manual                DEVNAME(3)

NAME
     devname - get device name

LIBRARY
     Standard C Library (libc, -lc)

SYNOPSIS
     #include &lt;stdlib.h&gt;
     #include &lt;sys/stat.h&gt;

     char *
     devname(dev_t dev, mode_t type);

(...)

FILES
     /var/run/dev.db  Device database file.

SEE ALSO
     stat(2), dev_mkdb(8)
</pre>
<p class="paragraph">
manページを見てみると、&quot;SEE ALSO&quot;に &quot;dev_mkdb(8)&quot; というのがある。manページを確認してみると、ズバリ、&quot;/dev&quot; データベースを作成するコマンドになっていた。
<br />
</p>
<pre class="plugin_pre">
DEV_MKDB(8)             NetBSD System Manager&#039;s Manual             DEV_MKDB(8)

NAME
     dev_mkdb - create /dev database

SYNOPSIS
     dev_mkdb [-o database] [directory]

(...)

SEE ALSO
     ps(1), stat(2), db(3), devname(3), kvm_nlist(3), ttyname(3), kvm_mkdb(8)
</pre>
<p class="paragraph">
NetBSD1.6の場合、システム起動時に次のrcスクリプトで実行されるようになっている。
<br />
</p>
<pre>/etc/rc.d/sysdb
</pre>

<p class="paragraph">
このコマンドはdb(3)で操作可能なhashタイプのデータベースを &quot;/var/run/dev.db&quot; (=&quot;_PATH_DEVDB&quot;)に作成する。ファイルタイプとst_rdevをキーとして全てのキャラクタデバイスとブロックデバイス名を格納する。
<br />
</p>

<h3 id="ide16122">dev_mkdb(8), dev_mkdb.c</h3>

<p class="paragraph">
dev_mkdbの実行ファイル・ソースファイルの場所は次の通り：
<br />
</p>
<pre>$ locate dev_mkdb
/usr/sbin/dev_mkdb
...
/usr/src/usr.sbin/dev_mkdb/dev_mkdb.c
</pre>

<p class="paragraph">
dev_mkdb.cのソースのポイントをざっくりと見ていく。
<br />
</p>

<p class="paragraph">
まず&quot;_PATH_DEV&quot; = &quot;/dev&quot; ディレクトリをfts_open(3)で開く。以降、fts(3)関数を使ってファイル階層をトラバースしていく。
<br />
</p>
<pre class="plugin_pre">
char path_dev[MAXPATHLEN + 1] = _PATH_DEV;

/* (...) */

pathv[0] = path_dev;
pathv[1] = NULL;
ftsp = fts_open(pathv, FTS_PHYSICAL, NULL);
</pre>
<p class="paragraph">
次のポイントはdbopen(3)で、DB_HASHを指定してオープンしている。dbtmpはこの時点で適切なファイル名(=_PATH_DEVDB)に調整されている。
<br />
</p>
<pre>db = dbopen(dbtmp, O_CREAT|O_EXCL|O_EXLOCK|O_RDWR|O_TRUNC,
                   S_IRUSR|S_IWUSR|S_IRGRP|S_IROTH, DB_HASH, NULL);
</pre>
<p class="paragraph">
そしてfts_read()で各ファイルに対してファイルタイプとst_rdevをキーに、ファイル名をDBに追加していく：
<br />
</p>
<pre class="plugin_pre">
/*
 * Keys are a mode_t followed by a dev_t.  The former is the type of
 * the file (mode &amp; S_IFMT), the latter is the st_rdev field.  Note
 * that the structure may contain padding, so we have to clear it
 * out here.
 */
memset(&amp;bkey, 0, sizeof(bkey));
key.data = &amp;bkey;
key.size = sizeof(bkey);
data.data = buf;
while ((p = fts_read(ftsp)) != NULL) {
  switch (p-&gt;fts_info) {
  case FTS_DEFAULT:
    st = p-&gt;fts_statp;
    break;
  default:
    continue;
  }

  /* Create the key. */
  if (S_ISCHR(st-&gt;st_mode))
    bkey.type = S_IFCHR;
  else if (S_ISBLK(st-&gt;st_mode))
    bkey.type = S_IFBLK;
  else
    continue;
  bkey.dev = st-&gt;st_rdev;

  /*
   * Create the data; nul terminate the name so caller doesn&#039;t
   * have to.  Skip path_dev and slash.
   */
  strlcpy(buf, p-&gt;fts_path + (strlen(path_dev) + 1), sizeof(buf));
  data.size = p-&gt;fts_pathlen - (strlen(path_dev) + 1) + 1;
  if ((*db-&gt;put)(db, &amp;key, &amp;data, 0)) {
    err(1, &quot;dbput %s&quot;, dbtmp);
  }
}
(void)(*db-&gt;close)(db);
fts_close(ftsp);
</pre>

<p class="paragraph">
ところで細かい部分になってしまうが、DBを作成する時はファイル名の&quot;_PATH_DEV&quot;部分は削り落として登録するようになっている。
<br />
</p>
<pre>strlcpy(buf, p-&gt;fts_path + (strlen(path_dev) + 1), sizeof(buf));
</pre>
<p class="paragraph">
path_devは_PATH_DEVで初期化されているので、例えばfts_pathが
<br />
</p>
<pre>/dev/abc01
</pre>
<p class="paragraph">
なら、実際にbufにコピーされるのは
<br />
</p>
<pre>abc01
</pre>
<p class="paragraph">
になる。また登録時のデータ長も、丁度path_dev(=&quot;_PATH_DEV&quot;)分短くなるよう調整されている：
<br />
</p>
<pre>data.size = p-&gt;fts_pathlen - (strlen(path_dev) + 1) + 1;
</pre>

<p class="paragraph">
少しでも実行時のDBファイルサイズを減らそうという努力が伺える。
<br />
ttyname.cの方では、値を取り出すところで &quot;_PATH_DEV&quot; がうまく補完されるようになっている。まず取り出す領域を&quot;_PATH_DEV&quot;で初期化しておく。
<br />
</p>
<pre>static char buf[sizeof(_PATH_DEV) + MAXNAMLEN] = _PATH_DEV;
</pre>
<p class="paragraph">
そして取り出す時にmemmove()を使い、オフセットを&quot;_PATH_DEV&quot;分だけずらしている：
<br />
</p>
<pre>memmove(buf + sizeof(_PATH_DEV) - 1, data.data, data.size);
</pre>
<p class="paragraph">
これにより、丁度
<br />
</p>
<pre>&quot;/dev/&quot; + &quot;abc01&quot;
</pre>
<p class="paragraph">
という形でデバイス名が復元される。
<br />
</p>

<p class="paragraph">
以上でttyname(3)がデバイス名を取得する仕組みが判明した。システム起動時にdev_mkdb(8)が &quot;/dev/&quot; ディレクトリをもとにデバイス情報のDBを生成するようになっており、ttyname(3)およびdevname(3)はそのDBからデバイス名を取得するようになっている。
<br />
</p>

<p class="paragraph">
今回のお題については、ここまで。
<br />
</p>

<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-574.html" title="C言語系/「デーモン君のソース探検」読書メモ/A02, tee(1)">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-576.html" title="C言語系/「デーモン君のソース探検」読書メモ/A04, isatty(3)">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-546.html" title="C言語系/「デーモン君のソース探検」読書メモ">Up</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-478.html" title="C言語系">C言語系</a>&nbsp;]</li>
</ul>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/575<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2001 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a target="_blank" href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" target="_blank" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>