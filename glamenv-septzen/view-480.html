<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>C言語系/memos/gmake - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">C言語系/memos/gmake</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2009-11-16 18:25:55 &nbsp; / &nbsp; last updated at: 2009-11-16 18:29:26<br>
カテゴリ: <a href="category-10.html">C言語</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-488.html" title="C言語系/memos/gettext">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-484.html" title="C言語系/memos/libtool">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-478.html" title="C言語系">C言語系</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
GNU make コマンドの使い方を自分用にメモしておく。
<br />
なお、十人十色に書かれた「Makefileの書き方」ドキュメントが既に広くWeb上に存在する。
<br />
従ってこちらのメモでは、Makefileの細かい部分までメモする事はなく、あくまでも自分用のざっくりとしたリファレンスとして書き付けておく。
<br />
</p>

<p class="paragraph">
特に記述がない場合はCentOS 5.2 の GNU Make 3.81 のmanページを元にしている。その他のUNIX環境やWindowsのmakeについてはそれぞれ独自の機能拡張、あるいはGNU Makeにのみ実装されている機能、などがあると思うので、特に自動定義の変数や拡張子(SUFFIXES)に応じた事前定義のルールについてはそれぞれの環境で、都度manやドキュメントを調べる必要がある。
<br />
</p>

<ul><li> GNU Make 本家マニュアル(HTML1ページバージョン)<ul><li> <a class="externallink" href="http://www.gnu.org/software/make/manual/make.html" target="_blank">http://www.gnu.org/software/make/manual/make.html</a></li></ul></li></ul>




<ul><li><a href="#id389aac">書き方の基本</a><ul><li><a href="#idd0912a">バックスラッシュの扱いについて</a></li>
<li><a href="#idcf8244">コマンド行頭の&quot;@&quot;, &quot;-&quot;</a></li>
<li><a href="#idd05216">コマンド行で&quot;cd&quot;する時や複数行のシェルを実行する時の注意点</a></li>
<li><a href="#id1f7244">&quot;.PHONY&quot;ターゲット</a></li></ul></li>
<li><a href="#idb8c75f">変数</a><ul><li><a href="#id825408">基本的な自動変数</a></li>
<li><a href="#id99d8fe">暗黙のルール(Implicit Rule)により使用される変数</a></li>
<li><a href="#iddf2532">変数の一時的な上書き</a></li></ul></li>
<li><a href="#id83a1aa">ルール</a><ul><li><a href="#id4c0be5">.SUFFIXESを用いたルール</a></li>
<li><a href="#id1d1e31">&quot;%&quot;によるパターンを用いたルール</a></li></ul></li>
<li><a href="#idcfe14f">GNU Make で便利そうなコマンドラインオプション</a></li></ul>
<hr />
<h3 id="id389aac">書き方の基本</h3>

<p class="paragraph">
ファイル名は、Makefile/makefileなどにする。GNU Makeの場合は&quot;-f&quot;オプションで任意のファイル名を指定できるが、&quot;Makefile&quot;という頭大文字で始める場合が多い。
<br />
</p>

<pre class="plugin_pre">
#コメント
変数名 = 値

ターゲット: 依存物
(TAB)コマンド
</pre>
<p class="paragraph">
なお、少なくとも GNU Makeの場合は以下のように&quot;;&quot;に続けてコマンドを書く事も出来る。
<br />
</p>
<pre>ターゲット: 依存物; コマンド1
(TAB)コマンド2
</pre>

<h4 id="idd0912a">バックスラッシュの扱いについて</h4>

<p class="paragraph">
バックスラッシュを使う事で、
<br />
</p>
<ol><li> 長い行を複数行に分割できる。（バックスラッシュの直後には改行文字だけを残すようにした方が良いだろう）</li>
<li> ワイルドカードをエスケープできる。</li></ol>

<p class="paragraph">
ただし、シェルスクリプトの途中でバックスラッシュを使う場合は展開されるとどうなるかに注意する必要がある。また Windows の場合はバックスラッシュがディレクトリ区切り文字になるため、パス名部分はそのままバックスラッシュとして使える。ただしその代わりワイルドカード文字が使えなくなる。もしワイルドカード文字による展開機能を使いたい場合は、通常のスラッシュ(&quot;/&quot;)をディレクトリ区切り文字として使う事。
<br />
特にシェルスクリプトが混在している中でのバックスラッシュについては、GNU Makeの本家マニュアルを&quot;backslash&quot;で検索して慎重に確認しつつ使う方が良いだろう。
<br />
</p>

<h4 id="idcf8244">コマンド行頭の&quot;@&quot;, &quot;-&quot;</h4>

<p class="paragraph">
行頭の&quot;@&quot;は、コマンド行自体は表示しない事を意味する。
<br />
</p>
<pre>sample:
    @echo &quot;ABCDEFG&quot;
</pre>
<p class="paragraph">
→ &quot;ABCDEFG&quot; とだけ表示される。&quot;echo ABCDEFG&quot;と表示されるわけではない。
<br />
</p>

<p class="paragraph">
行頭の&quot;-&quot;は、実行したコマンドの終了ステータスが0以外の場合も実行を継続する事を意味する。
<br />
</p>
<pre>sample:
    @echo &quot;cleaning directory start.&quot;
    -$(RM) foobar/*
    @echo &quot;done.&quot;
</pre>
<p class="paragraph">
→ &quot;foobar&quot;ディレクトリが無くとも、&quot;done.&quot;まで表示される。
<br />
</p>

<h4 id="idd05216">コマンド行で&quot;cd&quot;する時や複数行のシェルを実行する時の注意点</h4>

<pre>sample:
    cd ./foobar/
    $(RM) abc.txt
</pre>
<p class="paragraph">
上記のような場合、コマンド行が分かれている為 &quot;$(RM) abc.txt&quot; は &quot;./foobar/&quot; 内ではなく、カレントディレクトリ内で実行される。
<br />
cdしてその中で何かさせたい場合は、&quot;;&quot;で分割して一行に収める。
<br />
</p>
<pre>sample:
    cd ./foobar/ ; $(RM) abc.txt
</pre>

<p class="paragraph">
またforなどを使った複数行のシェルを実行する場合も、コマンド行を分けずに、バックスラッシュで分割して記述する。
<br />
</p>
<pre>sample:
    for f in ./html/*.html; do \
        cp $$f /opt/foobar/html \
    done
</pre>

<h4 id="id1f7244">&quot;.PHONY&quot;ターゲット</h4>

<p class="paragraph">
&quot;.PHONY&quot;ターゲットの依存物に指定したターゲットは、実在のファイルやディレクトリではなく常に更新されたものとして扱われる。また、GNU Makeの場合は暗黙のルール(Implicit Rule)の検索も行われなくなる為、パフォーマンスを向上させる。
<br />
具体的には&quot;all&quot;や&quot;install&quot;, &quot;clean&quot;などのターゲットを&quot;.PHONY&quot;に指定する。
<br />
</p>
<pre>.PHONY: all install clean
</pre>
<p class="paragraph">
これにより、これらのターゲットで設定されているコマンドは「常に」実行されるようになる。もしMakefileと同じディレクトリに&quot;all&quot;や&quot;clean&quot;など同名のファイル・ディレクトリが有っても、それらの更新日時は無視される。
<br />
</p>

<p class="paragraph">
例：
<br />
</p>
<pre class="plugin_pre">
.PHONY: all

all: prog1 prog2 prog3

prog1: dep1; touch prog1
prog2: dep2; touch prog2
prog3: dep3; touch prog3

dep1: ; touch dep1
dep2: ; touch dep2
dep3: ; touch dep3
</pre>

<p class="paragraph">
.PHONYの詳細はGNU Make本家ドキュメントを参照。
<br />
</p>

<h3 id="idb8c75f">変数</h3>

<p class="paragraph">
マクロとも呼ばれる。
<br />
</p>

<h4 id="id825408">基本的な自動変数</h4>

<p class="paragraph">
$@ : ターゲット名
<br />
</p>

<p class="paragraph">
$&lt; : 依存物の先頭
<br />
</p>

<p class="paragraph">
$^ : そのターゲットで指定されている依存物全て(GNU Makeのみ？)
<br />
</p>

<p class="paragraph">
$$ : &quot;$&quot;それ自体(変数ではないけど一応ここで紹介)
<br />
</p>

<h4 id="id99d8fe">暗黙のルール(Implicit Rule)により使用される変数</h4>

<p class="paragraph">
C言語に関連した主要なのを数点メモしておく。括弧内はCentOS 5.2 GNU Make 3.81で確認したデフォルト値。
<br />
</p>

<table>
	<tr>
		<td> RM </td>
		<td> ファイル削除用コマンド(rm -f) </td>
	</tr>
	<tr>
		<td> CC </td>
		<td> Cコンパイラ(cc) </td>
	</tr>
	<tr>
		<td> CPP </td>
		<td> Cプリプロセッサ($(CC) -E) </td>
	</tr>
	<tr>
		<td> CXX </td>
		<td> C++コンパイラ(g++) </td>
	</tr>
	<tr>
		<td> LD </td>
		<td> リンカ(ld) </td>
	</tr>
	<tr>
		<td> CFLAGS </td>
		<td> $(CC)に与えるオプション </td>
	</tr>
	<tr>
		<td> CPPFLAGS </td>
		<td> $(CPP)に与えるオプション </td>
	</tr>
	<tr>
		<td> CXXFLAGS </td>
		<td> $(CXX)に与えるオプション </td>
	</tr>
	<tr>
		<td> LDFLAGS </td>
		<td> リンク時に指定するオプション </td>
	</tr>
</table>

<p class="paragraph">
他の環境のMakeでも暗黙のルールで使われるかは不明だが、合わせておいた方がメンテもし易いだろう。
<br />
</p>

<h4 id="iddf2532">変数の一時的な上書き</h4>

<p class="paragraph">
make実行時に &quot;変数名=値&quot; 形式でコマンドライン引数で指定する事により、Makefile中の値を上書きできる。
<br />
</p>

<pre>$ more Makefile
VAR1=abc

all:
    @echo &quot;VAR1=$(VAR1)&quot;
</pre>

<pre>$ make
VAR1=abc
$ make VAR1=foo
VAR1=foo
</pre>

<h3 id="id83a1aa">ルール</h3>

<p class="paragraph">
暗黙のルール(Implicit Rule)についてはプラットフォーム毎のMake実装依存が大きい為、メモしない。
<br />
自分でルール定義をする場合に良く使う基本パターンのみをメモしておく。
<br />
</p>

<h4 id="id4c0be5">.SUFFIXESを用いたルール</h4>

<pre>.SUFFIXES  # 空指定する事により、これ以前に定義されている.SUFFIXESを無効化
.SUFFIXES .c .o # &quot;*.c&quot;, &quot;*.o&quot; をsuffixルール対象にする

# suffixルール：&quot;*.o&quot; は &quot;*.c&quot; に依存する
.c.o:
    $(CC) $(CFLAGS) -c -o $@ $&lt;
</pre>

<h4 id="id1d1e31">&quot;%&quot;によるパターンを用いたルール</h4>

<p class="paragraph">
（GNU以外のMakeで実装されているかは不明。）
<br />
</p>

<p class="paragraph">
suffixルールの弱点は、指定したsuffix以外のsuffixファイルを依存物に含める事が出来ない点にある。
<br />
</p>

<pre>.c.o: foo.h
    $(CC) $(CFLAGS) -c -o $@ $&lt;
</pre>

<p class="paragraph">
上記のようにすると、&quot;.c.o&quot;がターゲットになり、&quot;foo.h&quot;が依存物となってしまう。
<br />
</p>

<p class="paragraph">
GNU Makeの場合、パターンルール(pattern rule)を使って以下のように書ける。
<br />
</p>
<pre>%.o: %.c foo.h
    $(CC) $(CFLAGS) -c -o $@ $&lt;
</pre>

<h3 id="idcfe14f">GNU Make で便利そうなコマンドラインオプション</h3>

<table>
	<tr>
		<td> -f ファイル名 </td>
		<td> makefile名を指定 </td>
	</tr>
	<tr>
		<td> -n </td>
		<td> 実行するコマンドの表示だけを行い、実際の実行を行わない。 </td>
	</tr>
	<tr>
		<td> -t </td>
		<td> コマンドを実行せずにファイルにタッチする(実際にはファイルを変更せず、最新の印を付ける)。このオプションを使うと見かけ上コマンドが実行されたことになり、後で起動する make をだますことができる。 </td>
	</tr>
</table>

<hr />
<p class="paragraph">
以下のML記事にある通り、GNU Makeは様々なMakeから色々と機能を取り込んでいる。中には由来が不明の機能も多数有るようだ。
<br />
</p>
<ul><li> BSD make vs. GNU make<ul><li> <a class="externallink" href="http://lists.freebsd.org/pipermail/freebsd-questions/2007-April/147533.html" target="_blank">http://lists.freebsd.org/pipermail/freebsd-questions/2007-April/147533.html</a></li></ul></li></ul>

<p class="paragraph">
他のプラットフォームのMakeでも動くようなMakefileを書こうとすると相当苦労しそうである。いっそ、GNU MakeオンリーやそれぞれのプラットフォームのMakeオンリーの書き方にした方が楽かも知れない。
<br />
</p>

<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-488.html" title="C言語系/memos/gettext">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-484.html" title="C言語系/memos/libtool">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-478.html" title="C言語系">C言語系</a>&nbsp;]</li>
</ul>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/480<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2007 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>