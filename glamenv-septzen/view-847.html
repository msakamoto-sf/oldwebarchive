<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>C言語系/「デーモン君のソース探検」読書メモ/A07, nohup(1) - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">C言語系/「デーモン君のソース探検」読書メモ/A07, nohup(1)</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2010-11-23 12:00:16 &nbsp; / &nbsp; last updated at: 2010-11-23 12:02:59<br>
カテゴリ: <a href="category-32.html">BSD</a>&nbsp;<a href="category-10.html">C言語</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-846.html" title="C言語系/「デーモン君のソース探検」読書メモ/A06, su(1)">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-848.html" title="C言語系/「デーモン君のソース探検」読書メモ/A08, pause(3), sigsuspend(2)">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-478.html" title="C言語系">C言語系</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
お題：nohup(1)コマンドが、端末からログアウトしても終了しないように子プロセスを起動する仕組みを調査せよ
<br />
</p>

<p class="paragraph">
※この章は「デーモン君のソース探検」に載っていませんが、msakamoto-sf自身が個人的に興味を持って調べ、&quot;Appendix&quot;として読書メモシリーズに入れてありますのでご注意下さい。
<br />
</p>



<ul><li><a href="#idf33342">nohup(1)を使ってみる</a><ul><li><a href="#ida3e174">簡単なプログラムでnohup(1)の効果を確認</a></li>
<li><a href="#id169ae5">シグナル強制終了→printf()の内部バッファリングが消滅→fflush()で解決</a></li>
<li><a href="#id7ff93a">nohup(1)をバックグラウンドで使ってみる</a></li>
<li><a href="#id1364f4">nohup(1)でバックグランド実行→端末終了→プログラムグループやセッションはどうなる？</a></li></ul></li>
<li><a href="#id147495">nohup(1)のソースコード</a><ul><li><a href="#id8afb24">fork-exec時のシグナルハンドラの引継ぎ</a></li></ul></li></ul>
<hr />

<h3 id="idf33342">nohup(1)を使ってみる</h3>

<pre>$ which nohup
/usr/bin/nohup
$ man 1 nohup
</pre>

<p class="paragraph">
nohup(1)から起動されたプログラムはSIGHUPを無視する、つまり端末からログアウトしてもバックグランドで動き続ける。
<br />
</p>

<h4 id="ida3e174">簡単なプログラムでnohup(1)の効果を確認</h4>

<p class="paragraph">
標準出力と標準エラー出力に文字を出力するだけの簡単なプログラムを作成し、nohup(1)の効果を確認する。
<br />
nohuptest.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">unistd.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">argc</span><span class="hl-code">, </span><span >char</span><span class="hl-code"> *</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">i</span><span class="hl-code"> = </span><span class="hl-number">0</span><span class="hl-code">;
    </span><span class="hl-reserved">for</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">;;</span><span class="hl-identifier">i</span><span class="hl-code">++</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">fprintf</span><span class="hl-brackets">(</span><span class="hl-identifier">stdout</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">stdout, i = %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">i</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">fprintf</span><span class="hl-brackets">(</span><span class="hl-identifier">stderr</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">stderr, i = %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">i</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">sleep</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>
<p class="paragraph">
コンパイルし、まずはnohup(1)を使わずに実行してみる：
<br />
</p>
<pre class="plugin_pre">
$ gcc -o nohuptest nohuptest.c
$ ./nohuptest
stdout, i = 0
stderr, i = 0
stdout, i = 1
stderr, i = 1
stdout, i = 2
stderr, i = 2
^C
$
</pre>
<p class="paragraph">
続いてnohup(1)を使ってみる。
<br />
</p>
<pre class="plugin_pre">
$ nohup ./nohuptest
sending output to nohup.out
^C
$ cat nohup.out
stderr, i = 0
stderr, i = 1
stderr, i = 2
stderr, i = 3
stderr, i = 4
</pre>
<p class="paragraph">
&quot;&amp;&quot;はつけなかったのでnohupがフォアグラウンドのまま動作している。nohuptestのstderrがnohup.outにリダイレクトされるのはmanpageに書いてあるとおり。しかし、stdoutの出力が保存されていない。
<br />
</p>

<h4 id="id169ae5">シグナル強制終了→printf()の内部バッファリングが消滅→fflush()で解決</h4>

<p class="paragraph">
stdoutの出力がnohup.outに出力されていないのが気になり、単独でリダイレクトさせてみる：
<br />
</p>
<pre>$ ./nohuptest &gt; std.out
stderr, i = 0
stderr, i = 1
stderr, i = 2
^C
$ wc -c std.out
       0 std.out
</pre>
<p class="paragraph">
何も保存されていない。
<br />
</p>

<p class="paragraph">
いろいろ試してみたところ、たとえば次のようにプロセスが正常終了する場合は正常にリダイレクトされることが分かった。
<br />
</p>
<div class="hl-main"><pre><span >int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">argc</span><span class="hl-code">, </span><span >char</span><span class="hl-code"> *</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">i</span><span class="hl-code">;
    </span><span class="hl-reserved">for</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">i</span><span class="hl-code"> = </span><span class="hl-number">0</span><span class="hl-code">; </span><span class="hl-identifier">i</span><span class="hl-code"> &lt; </span><span class="hl-number">10</span><span class="hl-code"> ;</span><span class="hl-identifier">i</span><span class="hl-code">++</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">fprintf</span><span class="hl-brackets">(</span><span class="hl-identifier">stdout</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">Hello %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">i</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">sleep</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>
<p class="paragraph">
しかし、この場合であっても途中で&quot;^C&quot;でシグナルにより強制終了させた場合、リダイレクト先が空っぽのままであった。
<br />
</p>

<p class="paragraph">
・・・もしかして、標準C関数のprintf()って内部でバッファリングしてて、シグナルにより強制終了の場合は内部バッファが書き出されずにプロセス終了→リダイレクト先は空っぽのまま、という流れか？
<br />
</p>

<p class="paragraph">
ということで、fflush()を挟んでみたところ、ちゃんとシグナル強制終了の場合でもリダイレクト先にこれまでの出力内容が保存されていた。
<br />
</p>

<p class="paragraph">
この問題で1時間ほど時間をとられたが、再開する。結構凹んだ。
<br />
なお、あくまでもNetBSD 1.6で発生した現象であって、他のUNIX環境でも同様に発生するかは不明。libcの内部実装に依存するだろう。
<br />
</p>

<p class="paragraph">
fflush()付きのnohuptest.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">unistd.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">argc</span><span class="hl-code">, </span><span >char</span><span class="hl-code"> *</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">i</span><span class="hl-code"> = </span><span class="hl-number">0</span><span class="hl-code">;
    </span><span class="hl-reserved">for</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">;;</span><span class="hl-identifier">i</span><span class="hl-code">++</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">fprintf</span><span class="hl-brackets">(</span><span class="hl-identifier">stdout</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">stdout, i = %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">i</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">fflush</span><span class="hl-brackets">(</span><span class="hl-identifier">stdout</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">fprintf</span><span class="hl-brackets">(</span><span class="hl-identifier">stderr</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">stderr, i = %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">i</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">fflush</span><span class="hl-brackets">(</span><span class="hl-identifier">stderr</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">sleep</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
これでnohup.outにstdout/stderrの両方が出力されるようになった。
<br />
</p>

<h4 id="id7ff93a">nohup(1)をバックグラウンドで使ってみる</h4>

<p class="paragraph">
バックグランドで動作させてみる：
<br />
</p>
<pre class="plugin_pre">
$ nohup ./nohuptest &amp;
[1] 280
$ sending output to nohup.out # コマンドライン入力ではなくて、nohupの出力

$ jobs
[1]+  Running                 nohup ./nohuptest &amp;
$ ps
PID TT STAT    TIME COMMAND
206 p0 Ss+  0:00.04 -bash
211 p1 Ss   0:00.01 -bash
280 p1 S    0:00.02 ./nohuptest
281 p1 R+   0:00.00 ps
215 p2 Ss   0:00.00 -bash
</pre>
<p class="paragraph">
この時点でnohupを起動した端末からlogoutしてみる。他の端末からログインしてみると、&quot;./nohuptest&quot;プロセスが動き続けていることが分かる。また、nohup.outへの出力も続いている。
<br />
</p>
<pre>$ ps
PID TT  STAT    TIME COMMAND
206 p0  Ss+  0:00.04 -bash
280 p1- S    0:00.02 ./nohuptest
215 p2  Ss   0:00.02 -bash
285 p2  R+   0:00.00 ps
</pre>

<p class="paragraph">
SIGHUPには反応しないので、SIGINTで終了させる。
<br />
</p>
<pre>$ kill -INT 280
$ ps
PID TT STAT    TIME COMMAND
206 p0 Ss+  0:00.04 -bash
215 p2 Ss   0:-1.99 -bash
288 p2 R+   0:00.00 ps
$
</pre>

<h4 id="id1364f4">nohup(1)でバックグランド実行→端末終了→プログラムグループやセッションはどうなる？</h4>

<p class="paragraph">
nohup(1)でバックグランド実行し、端末を終了させた場合、プログラムグループやセッション、制御端末はどうなるか？
<br />
</p>

<p class="paragraph">
before(端末終了前)
<br />
</p>
<pre class="plugin_pre">
$ ps wx -o pid,ppid,pgid,jobc,sess,tpgid,tsess,tty,stat,command
PID PPID PGID JOBC   SESS TGPID    TSESS TTY   STAT COMMAND
205  203  203    0 c8c5c0 30001        0 ??    S    sshd: msakamoto@ttyp0
214  212  212    0 c8c880 30001        0 ??    S    sshd: msakamoto@ttyp2
296  294  294    0 c99200 30001        0 ??    S    sshd: msakamoto@ttyp1
531  529  529    0 cac780 30001        0 ??    S    sshd: msakamoto@ttyp3
206  205  206    0 bf9000   542 c0bf9000 ttyp0 Ss   -bash
533  206  533    1 bf9000   542 c0bf9000 ttyp0 T    man ps
534  533  533    1 bf9000   542 c0bf9000 ttyp0 T    sh -c less /usr/share/man//cat1/ps.0
535  534  533    1 bf9000   542 c0bf9000 ttyp0 T    less /usr/share/man//cat1/ps.0
539  206  539    1 bf9000   542 c0bf9000 ttyp0 T    man printf
540  539  539    1 bf9000   542 c0bf9000 ttyp0 T    sh -c less /usr/share/man//cat1/printf.0
541  540  539    1 bf9000   542 c0bf9000 ttyp0 T    less /usr/share/man//cat1/printf.0
542  206  542    1 bf9000   542 c0bf9000 ttyp0 S+   less /etc/hosts
297  296  297    0 c99f00   556 c0c99f00 ttyp1 Ss   -bash
552  297  552    1 c99f00   556 c0c99f00 ttyp1 S    ./nohuptest
553  297  553    1 c99f00   556 c0c99f00 ttyp1 T    man chdir
554  553  553    1 c99f00   556 c0c99f00 ttyp1 T    sh -c less /usr/share/man//cat2/chdir.0
555  554  553    1 c99f00   556 c0c99f00 ttyp1 T    less /usr/share/man//cat2/chdir.0
556  297  556    1 c99f00   556 c0c99f00 ttyp1 S+   man bash
561  556  556    1 c99f00   556 c0c99f00 ttyp1 S+   sh -c less /tmp//man.00556a
562  561  556    1 c99f00   556 c0c99f00 ttyp1 S+   less /tmp//man.00556a
215  214  215    0 cacfc0   546 c0cacfc0 ttyp2 Ss   -bash
543  215  543    1 cacfc0   546 c0cacfc0 ttyp2 T    man sh
544  543  543    1 cacfc0   546 c0cacfc0 ttyp2 T    sh -c less /usr/share/man//cat1/sh.0
545  544  543    1 cacfc0   546 c0cacfc0 ttyp2 T    less /usr/share/man//cat1/sh.0
546  215  546    1 cacfc0   546 c0cacfc0 ttyp2 S+   man cat
547  546  546    1 cacfc0   546 c0cacfc0 ttyp2 S+   sh -c less /usr/share/man//cat1/cat.0
548  547  546    1 cacfc0   546 c0cacfc0 ttyp2 S+   less /usr/share/man//cat1/cat.0
532  531  532    0 c8c8c0   563 c0c8c8c0 ttyp3 Ss   -bash
563  532  563    1 c8c8c0   563 c0c8c8c0 ttyp3 R+   ps wx -o pid
</pre>
<p class="paragraph">
→ nohuptest プロセスに関して整形：
<br />
</p>
<pre class="plugin_pre">
sshd: msakamoto@ttyp1 (PID=296, 制御端末=??)
  &gt; [セッショングループ SESS=c99200, 制御端末=ttyp1]
    -bash (PID=297, セッションリーダー)
      &gt; [プログラムグループ PGID=552] : Sleeping (STAT=T)
        ./nohuptest (PID=552)
      &gt; [プログラムグループ PGID=553 : Stopped (STAT=T)
        man chdir (PID=553)
        sh -c less /usr/share/man//cat2/chdir.0
        less /usr/share/man//cat2/chdir.0
      &gt; [プログラムグループ PGID=556] : Foreground (STAT=S+)
        man bash (PID=556)
        sh -c less /tmp//man.00556a
        less /tmp//man.00556a
</pre>

<p class="paragraph">
after(端末終了後)
<br />
</p>
<pre class="plugin_pre">
$ ps wx -o pid,ppid,pgid,jobc,sess,tpgid,tsess,tty,stat,command
PID PPID PGID JOBC   SESS TGPID    TSESS TTY   STAT COMMAND
205  203  203    0 c8c5c0 30001        0 ??    S    sshd: msakamoto@ttyp0
214  212  212    0 c8c880 30001        0 ??    S    sshd: msakamoto@ttyp2
531  529  529    0 cac780 30001        0 ??    S    sshd: msakamoto@ttyp3
206  205  206    0 bf9000   542 c0bf9000 ttyp0 Ss   -bash
533  206  533    1 bf9000   542 c0bf9000 ttyp0 T    man ps
534  533  533    1 bf9000   542 c0bf9000 ttyp0 T    sh -c less /usr/share/man//cat1/ps.0
535  534  533    1 bf9000   542 c0bf9000 ttyp0 T    less /usr/share/man//cat1/ps.0
539  206  539    1 bf9000   542 c0bf9000 ttyp0 T    man printf
540  539  539    1 bf9000   542 c0bf9000 ttyp0 T    sh -c less /usr/share/man//cat1/printf.0
541  540  539    1 bf9000   542 c0bf9000 ttyp0 T    less /usr/share/man//cat1/printf.0
542  206  542    1 bf9000   542 c0bf9000 ttyp0 S+   less /etc/hosts
552    1  552    0 c99f00 30001        0 ttyp1 S    ./nohuptest
215  214  215    0 cacfc0   546 c0cacfc0 ttyp2 Ss   -bash
543  215  543    1 cacfc0   546 c0cacfc0 ttyp2 T    man sh
544  543  543    1 cacfc0   546 c0cacfc0 ttyp2 T    sh -c less /usr/share/man//cat1/sh.0
545  544  543    1 cacfc0   546 c0cacfc0 ttyp2 T    less /usr/share/man//cat1/sh.0
546  215  546    1 cacfc0   546 c0cacfc0 ttyp2 S+   man cat
547  546  546    1 cacfc0   546 c0cacfc0 ttyp2 S+   sh -c less /usr/share/man//cat1/cat.0
548  547  546    1 cacfc0   546 c0cacfc0 ttyp2 S+   less /usr/share/man//cat1/cat.0
532  531  532    0 c8c8c0   564 c0c8c8c0 ttyp3 Ss   -bash
564  532  564    1 c8c8c0   564 c0c8c8c0 ttyp3 R+   ps wx -o pid
</pre>

<p class="paragraph">
nohuptestプロセスに注目すると、親プロセスIDがinit(PID=1)に変更され、制御端末のプロセスグループ(TGPID)・セッション(TSESS)がクリアされていることが分かる。TGPIDの&quot;30001&quot;というのは他のデーモンプロセスと同じ値。
<br />
</p>

<p class="paragraph">
nohup(1)の動作確認と、端末終了後のプロセスの状態を確認できたところで、いよいよソースを読んでみる。
<br />
</p>

<h3 id="id147495">nohup(1)のソースコード</h3>

<p class="paragraph">
場所：
<br />
</p>
<pre>$ locate nohup
...
/usr/src/usr.bin/nohup/Makefile
/usr/src/usr.bin/nohup/nohup.1
/usr/src/usr.bin/nohup/nohup.c
$ wc -l /usr/src/usr.bin/nohup/nohup.c
     149 /usr/src/usr.bin/nohup/nohup.c
</pre>

<p class="paragraph">
open(2), dup2(2), signal(3), isatty(3) をmanページなどで予習・復習しておくとよい。
<br />
</p>

<p class="paragraph">
ヘッダーやコメントを含めても149行と短い。さっそくmain()関数を見てみる。短いので、解説はコメントとして埋め込んだ。
<br />
</p>
<div class="hl-main"><pre><span >int</span><span class="hl-code">
</span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span class="hl-identifier">argc</span><span class="hl-code">, </span><span class="hl-identifier">argv</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">argc</span><span class="hl-code">;
    </span><span >char</span><span class="hl-code"> **</span><span class="hl-identifier">argv</span><span class="hl-code">;
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">exit_status</span><span class="hl-code">;
 
    </span><span class="hl-reserved">while</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">getopt</span><span class="hl-brackets">(</span><span class="hl-identifier">argc</span><span class="hl-code">, </span><span class="hl-identifier">argv</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code"> != -</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
            </span><span class="hl-identifier">usage</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-identifier">argc</span><span class="hl-code"> -= </span><span class="hl-identifier">optind</span><span class="hl-code">;
    </span><span class="hl-identifier">argv</span><span class="hl-code"> += </span><span class="hl-identifier">optind</span><span class="hl-code">;
 
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">argc</span><span class="hl-code"> &lt; </span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">
            </span><span class="hl-identifier">usage</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
 
    </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> 標準出力が端末に接続されていれば、
       dofile()中でnohup.outに切り替える </span><span class="hl-mlcomment">*/</span><span class="hl-code">
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">isatty</span><span class="hl-brackets">(</span><span class="hl-identifier">STDOUT_FILENO</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">
        </span><span class="hl-identifier">dofile</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
 
    </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> 標準エラー出力が端末に接続されていれば、
       標準エラー出力のファイル記述子を標準出力に接続する。
       (上のdofile()で標準エラー出力はnohup.outに接続済み)
    </span><span class="hl-mlcomment">*/</span><span class="hl-code">
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">isatty</span><span class="hl-brackets">(</span><span class="hl-identifier">STDERR_FILENO</span><span class="hl-brackets">)</span><span class="hl-code"> &amp;&amp; </span><span class="hl-identifier">dup2</span><span class="hl-brackets">(</span><span class="hl-identifier">STDOUT_FILENO</span><span class="hl-code">, </span><span class="hl-identifier">STDERR_FILENO</span><span class="hl-brackets">)</span><span class="hl-code"> == -</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> may have just closed stderr </span><span class="hl-mlcomment">*/</span><span class="hl-code">
        </span><span class="hl-brackets">(</span><span >void</span><span class="hl-brackets">)</span><span class="hl-identifier">fprintf</span><span class="hl-brackets">(</span><span class="hl-identifier">stdin</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">nohup: %s</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">strerror</span><span class="hl-brackets">(</span><span class="hl-identifier">errno</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-identifier">EXIT_MISC</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
 
    </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> 制御端末から送られるSIGHUPを無視する </span><span class="hl-mlcomment">*/</span><span class="hl-code">
    </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> The nohup utility shall take the standard action for all signals
       except that SIGHUP shall be ignored. </span><span class="hl-mlcomment">*/</span><span class="hl-code">
    </span><span class="hl-brackets">(</span><span >void</span><span class="hl-brackets">)</span><span class="hl-identifier">signal</span><span class="hl-brackets">(</span><span class="hl-identifier">SIGHUP</span><span class="hl-code">, </span><span class="hl-identifier">SIG_IGN</span><span class="hl-brackets">)</span><span class="hl-code">;
 
    </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> プログラムの実行 </span><span class="hl-mlcomment">*/</span><span class="hl-code">
    </span><span class="hl-identifier">execvp</span><span class="hl-brackets">(</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-number">0</span><span class="hl-brackets">]</span><span class="hl-code">, &amp;</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-number">0</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">exit_status</span><span class="hl-code"> = </span><span class="hl-brackets">(</span><span class="hl-identifier">errno</span><span class="hl-code"> == </span><span class="hl-identifier">ENOENT</span><span class="hl-brackets">)</span><span class="hl-code"> ? </span><span class="hl-identifier">EXIT_NOTFOUND</span><span class="hl-code"> : </span><span class="hl-identifier">EXIT_NOEXEC</span><span class="hl-code">;
    </span><span class="hl-brackets">(</span><span >void</span><span class="hl-brackets">)</span><span class="hl-identifier">fprintf</span><span class="hl-brackets">(</span><span class="hl-identifier">stderr</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">nohup: %s: %s</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-number">0</span><span class="hl-brackets">]</span><span class="hl-code">, </span><span class="hl-identifier">strerror</span><span class="hl-brackets">(</span><span class="hl-identifier">errno</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-identifier">exit_status</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
dofile()のソースを見てみる。特に難しいところは無い。
<br />
</p>
<div class="hl-main"><pre><span >static</span><span class="hl-code"> </span><span >void</span><span class="hl-code">
</span><span class="hl-identifier">dofile</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">fd</span><span class="hl-code">;
    </span><span >char</span><span class="hl-code"> *</span><span class="hl-identifier">p</span><span class="hl-code">, </span><span class="hl-identifier">path</span><span class="hl-brackets">[</span><span class="hl-identifier">MAXPATHLEN</span><span class="hl-brackets">]</span><span class="hl-code">;
 
    </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> If the standard output is a terminal, all output written to
       its standard output shall be appended to the end of the file
       nohup.out in the current directory.  If nohup.out cannot be
       created or opened for appending, the output shall be appended
       to the end of the file nohup.out in the directory specified
       by the HOME environment variable.
 
       If a file is created, the file's permission bits shall be
       set to S_IRUSR | S_IWUSR. </span><span class="hl-mlcomment">*/</span><span class="hl-code">
</span><span >#define</span><span class="hl-code"> </span><span class="hl-identifier">FILENAME</span><span class="hl-code">        </span><span class="hl-quotes">&quot;</span><span class="hl-string">nohup.out</span><span class="hl-quotes">&quot;</span><span ></span><span class="hl-code">
    </span><span class="hl-identifier">p</span><span class="hl-code"> = </span><span class="hl-identifier">FILENAME</span><span class="hl-code">;
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-brackets">(</span><span class="hl-identifier">fd</span><span class="hl-code"> = </span><span class="hl-identifier">open</span><span class="hl-brackets">(</span><span class="hl-identifier">p</span><span class="hl-code">, </span><span class="hl-identifier">O_RDWR</span><span class="hl-code">|</span><span class="hl-identifier">O_CREAT</span><span class="hl-code">|</span><span class="hl-identifier">O_APPEND</span><span class="hl-code">, </span><span class="hl-identifier">S_IRUSR</span><span class="hl-code">|</span><span class="hl-identifier">S_IWUSR</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> &gt;= </span><span class="hl-number">0</span><span class="hl-brackets">)</span><span class="hl-code">
        </span><span class="hl-reserved">goto</span><span class="hl-code"> </span><span class="hl-identifier">dupit</span><span class="hl-code">;
 
    </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> 現在ディレクトリにnohup.outを作成できなければ、$HOMEの下に作成してみる </span><span class="hl-mlcomment">*/</span><span class="hl-code">
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-brackets">(</span><span class="hl-identifier">p</span><span class="hl-code"> = </span><span class="hl-identifier">getenv</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">HOME</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> != </span><span >NULL</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-brackets">(</span><span >void</span><span class="hl-brackets">)</span><span class="hl-identifier">strcpy</span><span class="hl-brackets">(</span><span class="hl-identifier">path</span><span class="hl-code">, </span><span class="hl-identifier">p</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">(</span><span >void</span><span class="hl-brackets">)</span><span class="hl-identifier">strcat</span><span class="hl-brackets">(</span><span class="hl-identifier">path</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">/</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">(</span><span >void</span><span class="hl-brackets">)</span><span class="hl-identifier">strcat</span><span class="hl-brackets">(</span><span class="hl-identifier">path</span><span class="hl-code">, </span><span class="hl-identifier">FILENAME</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-brackets">(</span><span class="hl-identifier">fd</span><span class="hl-code"> = </span><span class="hl-identifier">open</span><span class="hl-brackets">(</span><span class="hl-identifier">p</span><span class="hl-code"> = </span><span class="hl-identifier">path</span><span class="hl-code">, </span><span class="hl-identifier">O_RDWR</span><span class="hl-code">|</span><span class="hl-identifier">O_CREAT</span><span class="hl-code">|</span><span class="hl-identifier">O_APPEND</span><span class="hl-code">, </span><span class="hl-identifier">S_IRUSR</span><span class="hl-code">|</span><span class="hl-identifier">S_IWUSR</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> &gt;= </span><span class="hl-number">0</span><span class="hl-brackets">)</span><span class="hl-code">
            </span><span class="hl-reserved">goto</span><span class="hl-code"> </span><span class="hl-identifier">dupit</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-brackets">(</span><span >void</span><span class="hl-brackets">)</span><span class="hl-identifier">fprintf</span><span class="hl-brackets">(</span><span class="hl-identifier">stderr</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">nohup: can't open a nohup.out file.</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-identifier">EXIT_MISC</span><span class="hl-brackets">)</span><span class="hl-code">;
 
    </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> nohup.outのファイル記述子を標準出力のファイル記述子に接続 </span><span class="hl-mlcomment">*/</span><span class="hl-code">
</span><span class="hl-identifier">dupit</span><span class="hl-code">:  </span><span class="hl-brackets">(</span><span >void</span><span class="hl-brackets">)</span><span class="hl-identifier">lseek</span><span class="hl-brackets">(</span><span class="hl-identifier">fd</span><span class="hl-code">, </span><span class="hl-number">0</span><span class="hl-identifier">L</span><span class="hl-code">, </span><span class="hl-identifier">SEEK_END</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">dup2</span><span class="hl-brackets">(</span><span class="hl-identifier">fd</span><span class="hl-code">, </span><span class="hl-identifier">STDOUT_FILENO</span><span class="hl-brackets">)</span><span class="hl-code"> == -</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-brackets">(</span><span >void</span><span class="hl-brackets">)</span><span class="hl-identifier">fprintf</span><span class="hl-brackets">(</span><span class="hl-identifier">stderr</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">nohup: %s</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">strerror</span><span class="hl-brackets">(</span><span class="hl-identifier">errno</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-identifier">EXIT_MISC</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-brackets">(</span><span >void</span><span class="hl-brackets">)</span><span class="hl-identifier">fprintf</span><span class="hl-brackets">(</span><span class="hl-identifier">stderr</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">sending output to %s</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">p</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<h4 id="id8afb24">fork-exec時のシグナルハンドラの引継ぎ</h4>

<p class="paragraph">
nohup(1)ではSIGHUPをSIG_IGNに設定した後、exec(2)している。つまりnohup(1)で起動したプロセスは、別プロセスで書き換えられる。
<br />
となると気になるのが、「シグナルハンドラの引継ぎ」である。動作している以上は引き継がれているのだろうが、たとえばSIG_IGNやSIG_DFL以外、つまりカスタムのシグナルハンドラをインストールしていた場合はどうなるのか？
<br />
</p>

<p class="paragraph">
答えは&quot;Advanced UNIX Programming&quot;(AUP) 2nd Edition, p623, &quot;9.1.10 Effect of fork, pthread_create, and exec on Singals&quot;に書かれていた。見やすいようインデントを変更して引用する。
<br />
</p>
<pre class="plugin_pre">
1. Signal actions: 
After a fork, 
    the child inherits all signal actions.
After an exec, 
    singlas set to SIG_DFL remain that way:
    signals set to SIG_IGN remain that way,
        except for SIGCHLD, which may be set to SIG_IGN or SIG_DFL,
         as the implementation chooses;
    caught signals are set to SIG_DFL.
As all actions are process-wide, pthread_create has no effect.
</pre>

<p class="paragraph">
上記と同様の説明はOpenGroupのexec(2)にも記載されている。&quot;Advanced Programming in the UNIX Environment 2nd&quot;(APUE)の方には残念ながら、ここまで詳しい説明は見当たらなかった。
<br />
</p>

<p class="paragraph">
日本語で。
<br />
</p>
<ol><li> fork(2)はプロセスのコピーなので、シグナルハンドラは全て引き継がれる。</li>
<li> exec(2)の場合、<ol><li> SIG_DFLは引継ぎ。</li>
<li> SIG_IGN → SIGCHLD 以外は引継ぎ。</li>
<li> 呼び出し元のプロセスイメージ上のシグナルハンドラが設定されているものはSIG_DFLに上書き。</li></ol></li></ol>

<p class="paragraph">
nohup(1)はSIG_IGNをSIGHUPに設定しているので、exec(2)後も引き継がれていることが確認できた。
<br />
</p>

<hr />
<p class="paragraph">
以上でnohup(1)が端末終了後もプロセスをバックグランドで続行させる仕組みが判明した。
<br />
</p>
<ol><li> exec(2)でSIG_IGN設定が引き継がれる仕組みを使い、SIGHUPにSIG_IGNを設定後exec(2)している。</li>
<li> 標準出力・標準エラー出力が端末に接続されていた場合は、nohup.outに切り替える。</li></ol>

<p class="paragraph">
今回のお題については、ここまで。
<br />
</p>

<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-846.html" title="C言語系/「デーモン君のソース探検」読書メモ/A06, su(1)">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-848.html" title="C言語系/「デーモン君のソース探検」読書メモ/A08, pause(3), sigsuspend(2)">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-546.html" title="C言語系/「デーモン君のソース探検」読書メモ">Up</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-478.html" title="C言語系">C言語系</a>&nbsp;]</li>
</ul>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/847<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2007 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>