<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Groovy/Grails/HttpServletResponseを使う + SiteMeshは無効化する。 - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">Groovy/Grails/HttpServletResponseを使う + SiteMeshは無効化する。</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2012-10-13 16:58:33 &nbsp; / &nbsp; last updated at: 2012-10-13 17:00:11<br>
カテゴリ: <a href="category-70.html">Grails</a>&nbsp;<a href="category-68.html">Groovy</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-1143.html" title="Groovy/Grails/GSPだけをGrailsから切り離して使えるか？(2013-02-02時点)">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-1111.html" title="Groovy/Grails/同じコントローラクラス名を、パッケージだけ分けて共存できるか？">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-1101.html" title="Groovy">Groovy</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
GrailsのView機能では、デフォルトではSiteMeshによりレイアウトおよびGSPのレンダリングを行います。
<br />
しかしHTMLではなく、ナマのバイナリデータを出力したい時や、あるいは完全に独自の出力を特定のアクションでだけ行いたい、などで、Grailsのデフォルトビューを無効化したい場合もあります。そのような場合の対処方法、逆に言えばきちんと対処しておかないと「なんでこんな現象が！？」と目を白黒させてドツボにハマりますので、その辺を本記事では紹介していきます。
<br />
</p>



<ul><li><a href="#id998aaa">画像を出力する位なら簡単なんだけど・・・(Content-Type: image/jpeg)</a></li>
<li><a href="#ide1303a">&quot;Content-Type: text/html&quot; で response.outputStream を使うと何故か404になってしまう</a></li>
<li><a href="#id6c77e3">404の原因とSiteMeshの無効化</a></li>
<li><a href="#id3afa3a">Controllerからアクセスできる&quot;response&quot;の実体は？</a></li>
<li><a href="#id03fb5d">参考資料</a></li></ul>

<hr />

<h3 id="id998aaa">画像を出力する位なら簡単なんだけど・・・(Content-Type: image/jpeg)</h3>

<p class="paragraph">
画像やバイナリデータの直接出力を実装したい場合は、Controllerからアクセスできるresponse(HttpServletResponse)を使ってOutputStreamにバイナリデータを出力します。
<br />
<a class="externallink" href="http://grails.org/doc/latest/ref/Servlet%20API/response.html" target="_blank">http://grails.org/doc/latest/ref/Servlet%20API/response.html</a> より：
<br />
</p>
<pre class="plugin_pre">
class BookController {
    def downloadFile() {
        byte[] bytes = // read bytes
        response.outputStream &lt;&lt; bytes
    }
}
</pre>

<p class="paragraph">
ContentTypeまで指定してみます。JPEG画像を直接出力したい場合ですと、次のようになります。
<br />
</p>
<pre>class SampleImageController {
    def index() {
        def input = servletContext.getResourceAsStream(&quot;/WEB-INF/sample.jpg&quot;)
        response.contentType = &quot;image/jpeg&quot;
        response.outputStream &lt;&lt; input
    }
}
</pre>

<h3 id="ide1303a">&quot;Content-Type: text/html&quot; で response.outputStream を使うと何故か404になってしまう</h3>

<p class="paragraph">
同じ要領で他のデータ、あるいはバイナリにも対応できます。しかしContentTypeに&quot;text/html&quot;を指定して、outputStream経由で出力しようとすると、なぜかHTTPステータスコード404が返されてしまい、Tomcatのデフォルトの404エラー画面が表示されます。
<br />
</p>
<pre class="plugin_pre">
class SampleHtmlDownloadController {
    def index() {
        response.contentType = &quot;text/html&quot;
        response.outputStream &lt;&lt; &quot;&lt;html&gt;&lt;body&gt;test&lt;/body&gt;&lt;/html&gt;&quot;
    }
}

-&gt;
HTTP Status 404 - .../WEB-INF/grails-app/views/sampleHtmlDownload/index.jsp
</pre>

<p class="paragraph">
404ではなくIllegalStateExceptionが発生しGrailsのエラー画面が表示された場合もありました。職場で発生していたのでエラー画面とかはお見せできないのですが、どうも、Controller内でHttpServletResponseのOutputStreamに出力し終わっている、にも関わらず、SiteMesh側でgetWriter()経由で出力しようとしたためのIllegalStateExceptionのようでした。
<br />
・・・が、こちらの現象は家では再現しなかったため、厳密にどの条件が当てはまると404になる or IllegalStateExceptionが発生するかまではわかりませんでした。いずれにせよ、どちらも後述の対応で回避できます。
<br />
</p>

<p class="paragraph">
ちなみに、&quot;/views/.../index.gsp&quot; を空っぽで作成してみると、outputStreamに出力したデータはごっそり無視されてしまい、空っぽのindex.gspの中身が表示されておしまいになります。勘弁してくれよと言いたくなります。
<br />
(´・ω・`)
<br />
</p>

<h3 id="id6c77e3">404の原因とSiteMeshの無効化</h3>

<p class="paragraph">
さて404が発生する理由ですが、ざっと調べたところ、GrailsのSiteMeshのデフォルト設定では&quot;text/html&quot;のContent-Typeが指定されたら、自動的にSiteMeshによるGSPレンダリング処理が発生するようです。そのため、SiteMeshがデフォルトのビューファイルを見に行ったが見つからない、ということで404が発生した・・・多分、そんな経緯だと思います。Grailsの内部コードまでは調査していませんので断言できません(；´∀｀)
<br />
</p>

<p class="paragraph">
Grails 2.1.1の場合、&quot;(GrailsApp)/web-app/WEB-INF/sitemesh.xml&quot; というのがあり、デフォルトでは以下の様なXMLでした。
<br />
</p>
<pre class="plugin_pre">
&lt;sitemesh&gt;
    &lt;page-parsers&gt;
        &lt;parser content-type=&quot;text/html&quot;
            class=&quot;org.codehaus.groovy.grails.web.sitemesh.GrailsHTMLPageParser&quot; /&gt;
        &lt;parser content-type=&quot;text/html;charset=ISO-8859-1&quot;
            class=&quot;org.codehaus.groovy.grails.web.sitemesh.GrailsHTMLPageParser&quot; /&gt;
        &lt;parser content-type=&quot;text/html;charset=UTF-8&quot;
            class=&quot;org.codehaus.groovy.grails.web.sitemesh.GrailsHTMLPageParser&quot; /&gt;
    &lt;/page-parsers&gt;

    &lt;decorator-mappers&gt;
        &lt;mapper class=&quot;org.codehaus.groovy.grails.web.sitemesh.GrailsLayoutDecoratorMapper&quot; /&gt;
    &lt;/decorator-mappers&gt;
&lt;/sitemesh&gt;
</pre>
<p class="paragraph">
中身はよくわかりませんが、雰囲気的に、&quot;text/html&quot;でcharsetがiso-8859とutf8の場合はGrailsHTMLPageParserが発動してしまう、そんな感じがします。
<br />
</p>

<p class="paragraph">
となりますと、一番単純な回避策としては&quot;text/html&quot;のContentTypeを使わない、となりますが、そもそもHTMLのデータを出力したい場合は回避しようがありません。&quot;text/html&quot;にしないとブラウザ側で正常に表示できません（多分）。
<br />
ということで、なんとかして&quot;text/html&quot;のままでSiteMeshを回避する方法ですが、ちゃんと存在します。
<br />
</p>

<p class="paragraph">
1. sitemesh.xmlの&quot;&lt;sitemesh&gt;&quot;タグの下に以下の一行を書き足します。
<br />
</p>
<pre>&lt;excludes file=&quot;/WEB-INF/sitemesh-excludes.xml&quot; /&gt;
</pre>

<p class="paragraph">
2. &quot;/WEB-INF/sitemesh-excludes.xml&quot; を以下の内容で作成します。
<br />
</p>
<pre>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;sitemesh-excludes&gt;
  &lt;excludes&gt;
    &lt;pattern&gt;(URLパスパターンマッチ文字列)&lt;/pattern&gt;
    &lt;!-- 複数設定可能 --&gt;
    &lt;pattern&gt;/foo&lt;/pattern&gt;
    &lt;pattern&gt;/bar/action1&lt;/pattern&gt;
    &lt;pattern&gt;/baz/**/download&lt;/pattern&gt;
  &lt;/excludes&gt;
&lt;/sitemesh-excludes&gt;
</pre>

<p class="paragraph">
今回は例示した SampleImageController, SampleHtmlDownloadController のコントローラの各アクションを除外設定にしてみます：
<br />
</p>
<pre class="plugin_pre">
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;sitemesh-excludes&gt;
  &lt;excludes&gt;
    &lt;pattern&gt;/sampleImage/*&lt;/pattern&gt;
    &lt;pattern&gt;/sampleHtmlDownload/*&lt;/pattern&gt;
  &lt;/excludes&gt;
&lt;/sitemesh-excludes&gt;
</pre>

<p class="paragraph">
sitemesh.xml関連の設定を追加したら、Grailsの再起動が必要でした。(clean/compileまでは不要)
<br />
</p>

<p class="paragraph">
これで無事、本来outputStreamに出力したデータがGrailsからのHTTPレスポンスに出力されました！
<br />
</p>

<pre class="plugin_pre">
HTTP/1.1 200 OK
Server: Apache-Coyote/1.1
Content-Type: text/html
Date: Sat, 13 Oct 2012 07:39:05 GMT
Content-Length: 30

&lt;html&gt;&lt;body&gt;test&lt;/body&gt;&lt;/html&gt;
</pre>

<h3 id="id3afa3a">Controllerからアクセスできる&quot;response&quot;の実体は？</h3>

<p class="paragraph">
※Grails 2.1.1 の場合です。
<br />
</p>

<p class="paragraph">
Controllerからアクセスできる&quot;response&quot;の実体ですが、SiteMeshの有効・無効で切り替わります。
<br />
</p>

<p class="paragraph">
SiteMeshが有効なControllerの場合、&quot;response&quot;は<strong>org.codehaus.groovy.grails.web.sitemesh.GrailsContentBufferingResponse のインスタンスです。</strong>試しに &quot;println response.dump()&quot; などを入れてみるとすぐに確認できます。
<br />
</p>

<p class="paragraph">
sitemesh.xmlなどにより無効化された場合、&quot;response&quot;は org.apache.catalina.connector.ResponseFacade のインスタンスでした。これは&quot;run-app&quot;したことでTomcatのコンテナが起動したため、HttpServletResponseのTomcatによる実装であると想像されます。
<br />
</p>

<h3 id="id03fb5d">参考資料</h3>

<p class="paragraph">
SiteMesh関連：
<br />
</p>
<ul><li> sitemesh (SiteMesh)<ul><li> <a class="externallink" href="https://github.com/sitemesh" target="_blank">https://github.com/sitemesh</a></li></ul></li>
<li> OpenSymphony, RIP (2000 - 2011)<ul><li> <a class="externallink" href="http://www.opensymphony.com/sitemesh/dm.html" target="_blank">http://www.opensymphony.com/sitemesh/dm.html</a></li></ul></li>
<li> Home - SiteMesh 2 - SiteMesh Wiki<ul><li> <a class="externallink" href="http://wiki.sitemesh.org/display/sitemesh/Home" target="_blank">http://wiki.sitemesh.org/display/sitemesh/Home</a></li></ul></li></ul>

<p class="paragraph">
当初はOpenSymphony上で他のプロダクトと一緒に開発されていたようですが、それぞれがOSSとして成熟していったことにより、OpenSymphonyは解散となりそれぞれ独立していったようです。SiteMeshのサイトも、現在は <a class="externallink" href="http://wiki.sitemesh.org/" target="_blank">http://wiki.sitemesh.org/</a> に移動しています。2012年現在、Grails 2.1.1ではSiteMesh 2.4が使用されています。
<br />
</p>


<p class="paragraph">
GrailsでSiteMeshを何とかして無効化しようと力の限り足掻いた人たち：
<br />
</p>
<ul><li> How to prevent Grails from rendering the default view? - Stack Overflow<ul><li> <a class="externallink" href="http://stackoverflow.com/questions/5708654/how-to-prevent-grails-from-rendering-the-default-view" target="_blank">http://stackoverflow.com/questions/5708654/how-to-prevent-grails-from-rendering-the-default-view</a></li></ul></li>
<li> Grails - user - How to avoid sitemesh<ul><li> <a class="externallink" href="http://grails.1312388.n4.nabble.com/How-to-avoid-sitemesh-td3464471.html" target="_blank">http://grails.1312388.n4.nabble.com/How-to-avoid-sitemesh-td3464471.html</a></li></ul></li>
<li> [#GRAILS-1223] setting response.contentType to text/html causes exception - Grails JIRA<ul><li> <a class="externallink" href="http://jira.grails.org/browse/GRAILS-1223" target="_blank">http://jira.grails.org/browse/GRAILS-1223</a></li></ul></li>
<li> [#GRAILS-5770] Make it possible to by pass GSP Sitemesh preprocessing for a GSP file with a page directive - Grails JIRA<ul><li> <a class="externallink" href="http://jira.grails.org/browse/GRAILS-5770" target="_blank">http://jira.grails.org/browse/GRAILS-5770</a></li></ul></li>
<li> [#GRAILS-5773] Add support for excluding uri&#039;s from Sitemesh processing in a Grails way (in UrlMappings etc) - Grails JIRA<ul><li> <a class="externallink" href="http://jira.grails.org/browse/GRAILS-5773" target="_blank">http://jira.grails.org/browse/GRAILS-5773</a></li></ul></li></ul>


<p class="paragraph">
GrailsPageResponseWrapper.deactivateSiteMesh()というメソッドが存在した・・・らしい、のですが、少なくともGrails 2.1.1 では存在しないようです。
<br />
</p>

<p class="paragraph">
今回紹介したのはsitemesh.xml経由でSiteMeshの除外URLを設定する方式でした。ControllerのActionからプログラムでON/OFF出来る確実な方法が調べきれなかったんです。まだGrailsの内部構造が良く分かってないので、もしかしたら実はこんな方法が・・・というのも将来見つかるかもしれません。
<br />
</p>

<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-1143.html" title="Groovy/Grails/GSPだけをGrailsから切り離して使えるか？(2013-02-02時点)">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-1111.html" title="Groovy/Grails/同じコントローラクラス名を、パッケージだけ分けて共存できるか？">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-1101.html" title="Groovy">Groovy</a>&nbsp;]</li>
</ul>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/1114<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2001 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a target="_blank" href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" target="_blank" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>