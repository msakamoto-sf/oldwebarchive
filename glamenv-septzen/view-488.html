<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>C言語系/memos/gettext - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">C言語系/memos/gettext</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2009-11-18 16:05:11 &nbsp; / &nbsp; last updated at: 2009-11-18 20:22:15<br>
カテゴリ: <a href="category-10.html">C言語</a>&nbsp;<a href="category-20.html">Linux</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-577.html" title="C言語系/memos/gcc/関数の属性機能(&quot;__attribute__&quot;)">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-480.html" title="C言語系/memos/gmake">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-478.html" title="C言語系">C言語系</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
GNU gettext の自分用メモ
<br />
</p>

<ul><li> GNU gettext 本家<ul><li> <a class="externallink" href="http://www.gnu.org/software/gettext/" target="_blank">http://www.gnu.org/software/gettext/</a></li></ul></li>
<li> GNU gettext HTMLドキュメント(1ページ版)<ul><li> <a class="externallink" href="http://www.gnu.org/software/gettext/manual/gettext.html" target="_blank">http://www.gnu.org/software/gettext/manual/gettext.html</a></li></ul></li></ul>



<ul><li><a href="#id72bee7">基本的な流れ</a><ul><li><a href="#id812f4b">最初のソースコード準備からpoファイル作成、moファイルへのコンパイルと配置まで</a><ul><li><a href="#idccecc5">&quot;xgettext&quot;で検出する為のマクロ定義を埋め込み、翻訳対象文字列に適用する。</a></li>
<li><a href="#idc55c9e">setlocale()など必要な前処理の呼び出しと、コンパイルして一旦Cロカールで動作確認</a></li>
<li><a href="#ideb9e2f">xgettextでメッセージを抽出 → &quot;*.pot&quot; → &quot;*.po&quot;翻訳</a></li>
<li><a href="#id4366d7">msgfmtでコンパイル → &quot;*.mo&quot;ファイルを配置・動作確認</a></li></ul></li>
<li><a href="#id8b0409">ソースコードが変更された場合のメンテナンス作業</a><ul><li><a href="#idb45a81">xgettextでメッセージ抽出、msgmergeでマージ</a></li>
<li><a href="#id270815">msgfmtでコンパイル→動作確認</a></li></ul></li></ul></li>
<li><a href="#ide47dd1">Autoconf/Automakeに組み込みたい</a></li></ul>
<hr />
<h3 id="id72bee7">基本的な流れ</h3>

<p class="paragraph">
・最初のソースコード準備からpoファイル作成、moファイルへのコンパイルまで
<br />
</p>
<ol><li> ソースコードを準備する。</li>
<li> &quot;xgettext&quot;で検出する為のマクロ定義を埋め込む。</li>
<li> 翻訳したい文字列に対して、マクロを適用する。</li>
<li> setlocale()など必要な前処理やヘッダファイルインクルードを組み込む。</li>
<li> コンパイルして一旦Cロカールで動作確認</li>
<li> xgettextでメッセージを抽出し、&quot;*.pot&quot;(poのテンプレートファイル)生成</li>
<li> &quot;*.pot&quot;ファイルを&quot;*.po&quot;にリネームし、翻訳。</li>
<li> msgfmtで&quot;*.po&quot;ファイルを&quot;*.mo&quot;ファイルにコンパイル。</li>
<li> &quot;*.mo&quot;ファイルをbindtextdomain()やtextdomain()で指定したパッケージ名+&quot;.mo&quot;にリネームし、ロカール用ディレクトリに置く。</li></ol>

<p class="paragraph">
・ソースコードが変更された場合のメンテナンス作業
<br />
</p>
<ol><li> xgettextでメッセージを抽出し、&quot;*.pot&quot;(poのテンプレートファイル)生成</li>
<li> msgmergeで&quot;*.po&quot;ファイルにマージ、翻訳。</li>
<li> msgfmtでコンパイルし、パッケージ名+&quot;.mo&quot;にリネーム、ロカール用ディレクトリに配置。</li></ol>

<p class="paragraph">
GNU gettext HTMLドキュメント, &quot;1.5 Overview of GNU gettext&quot; よりファイル関連図を抜粋する(元の図から、&quot;PO Compendium&quot;という要素が分かりづらかったので取り除いてあります)<span class="hidden">(</span><a class="footnote" href="#footnote_488_1" id="footnote_488_1_r"  title="&quot;*.gmo&quot;ファイルというのは、&quot;GNU gettextのサポートするmoファイルフォーマット&quot;という意味。moファイルのバイナリフォーマットはシステムによって差異があり、GNU gettextがサポートしないフォーマットの場合もある。この図では特にGNU gettextのmoフォーマットである事を意味するため、&quot;.gmo&quot;としている。">*1</a><span class="hidden">)</span>。
<br />
</p>
<pre>Original C Sources ─&gt; Preparation ─&gt; Marked C Sources ──┐
                                                            │
                 ┌─&lt;── GNU gettext Library              │
┌── make &lt;──┤                                         │
│               └─&lt;─────────────┬─────┘
│                                              │
│        ┌─&lt;─ PACKAGE.pot &lt;─ xgettext &lt;──┘
│        │         │
│        │         └─────&gt;─────┐
│        │                                ├─&gt; PO editor ─┐
│        ├─&gt; msgmerge ──&gt; LANG.po ─&gt;─┘                │
│        │                                                  │
│        └───&lt;───&lt;───┐                            │
│                              ├─── New LANG.po &lt;────┘
│  ┌─ LANG.gmo &lt;─ msgfmt &lt;─┘
│  │
│  └─&gt; install ──&gt; /.../LANG/PACKAGE.mo ──┐
│                                               ├───&gt; &quot;Hello world!&quot;
└─&gt; install ───&gt; /.../bin/PROGRAM ─────┘
</pre>

<h4 id="id812f4b">最初のソースコード準備からpoファイル作成、moファイルへのコンパイルと配置まで</h4>

<p class="paragraph">
下記のような簡単なサンプルコードに対して、徐々にgettext対応を肉付けしていく。
<br />
test.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >char</span><span class="hl-code"> *</span><span class="hl-identifier">msg</span><span class="hl-code"> = </span><span class="hl-quotes">&quot;</span><span class="hl-string">GNU gettext excersize</span><span class="hl-quotes">&quot;</span><span class="hl-code">;
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">puts</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">Hello, World!</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">puts</span><span class="hl-brackets">(</span><span class="hl-identifier">msg</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>
<pre>$ gcc -Wall -o test test.c
$ ./test
Hello, World!
GNU gettext excersize
</pre>

<h5 id="idccecc5">&quot;xgettext&quot;で検出する為のマクロ定義を埋め込み、翻訳対象文字列に適用する。</h5>

<p class="paragraph">
例えば次のようなメッセージであれば、
<br />
</p>
<pre>puts(&quot;Hello, World!&quot;);
</pre>
<p class="paragraph">
このようにするのが基本となる。
<br />
</p>
<pre>puts(gettext(&quot;Hello, World!&quot;));
</pre>
<p class="paragraph">
ただしこのままだとキータイプ数が多い上、test.cにおける
<br />
</p>
<pre>char *msg = &quot;...&quot;;
</pre>
<p class="paragraph">
にも対応できない。グローバル変数に対して下記のようなコードは書けない。
<br />
</p>
<pre>char *msg = gettext(&quot;...&quot;);
</pre>

<p class="paragraph">
このため、GNU gettext HTMLドキュメントでは次のマクロを定義する事を奨めている。
<br />
まず、普通に &quot;puts(...)&quot; に埋め込めるマクロを定義する。
<br />
</p>
<pre>#define _(String) gettext (String)
</pre>

<p class="paragraph">
次にグローバル変数の初期化などに使うマクロを定義する。
<br />
</p>
<pre>#define gettext_noop(String) (String)
#define N_(String) gettext_noop (String)
</pre>
<p class="paragraph">
このマクロを次のように埋め込む事で、グローバル変数の初期値に対してもマクロを適用できる。なぜなら、結局&quot;N_&quot;マクロは何も加工しないからである。
<br />
</p>
<pre>char *msg = N_(&quot;GNU gettext excersize&quot;);
...
puts(_(msg));
</pre>
<p class="paragraph">
何も加工しない&quot;N_&quot;マクロをわざわざ定義したのは、続く&quot;xgettext&quot;でも検出できるようにする為である。
<br />
</p>

<p class="paragraph">
これで、test.cは次のようになる。
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >#define</span><span class="hl-code"> </span><span class="hl-identifier">_</span><span class="hl-brackets">(</span><span class="hl-identifier">String</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">gettext</span><span class="hl-brackets">(</span><span class="hl-identifier">String</span><span class="hl-brackets">)</span><span ></span><span class="hl-code">
</span><span >#define</span><span class="hl-code"> </span><span class="hl-identifier">N_</span><span class="hl-brackets">(</span><span class="hl-identifier">String</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">gettext_noop</span><span class="hl-brackets">(</span><span class="hl-identifier">String</span><span class="hl-brackets">)</span><span ></span><span class="hl-code">
</span><span >#define</span><span class="hl-code"> </span><span class="hl-identifier">gettext_noop</span><span class="hl-brackets">(</span><span class="hl-identifier">String</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">String</span><span class="hl-brackets">)</span><span ></span><span class="hl-code">
 
</span><span >char</span><span class="hl-code"> *</span><span class="hl-identifier">msg</span><span class="hl-code"> = </span><span class="hl-identifier">N_</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">GNU gettext excersize</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">puts</span><span class="hl-brackets">(</span><span class="hl-identifier">_</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">Hello, World!</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">puts</span><span class="hl-brackets">(</span><span class="hl-identifier">_</span><span class="hl-brackets">(</span><span class="hl-identifier">msg</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<h5 id="idc55c9e">setlocale()など必要な前処理の呼び出しと、コンパイルして一旦Cロカールで動作確認</h5>

<p class="paragraph">
setlocale()では環境変数からロカール名を取得するようにする。bindtextdomain(), textdomain()でドメイン名とメッセージカタログディレクトリを設定する。ドメインとは、gettext()の翻訳するmsgidのセットのこと。
<br />
今回はドメイン名は&quot;test&quot;, メッセージカタログディレクトリは&quot;.&quot;起点とした。
<br />
</p>

<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> setlocale() </span><span class="hl-mlcomment">*/</span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">locale.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> bindtextdomain(), textdomain() </span><span class="hl-mlcomment">*/</span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">libintl.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >#define</span><span class="hl-code"> </span><span class="hl-identifier">_</span><span class="hl-brackets">(</span><span class="hl-identifier">String</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">gettext</span><span class="hl-brackets">(</span><span class="hl-identifier">String</span><span class="hl-brackets">)</span><span ></span><span class="hl-code">
</span><span >#define</span><span class="hl-code"> </span><span class="hl-identifier">N_</span><span class="hl-brackets">(</span><span class="hl-identifier">String</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">gettext_noop</span><span class="hl-brackets">(</span><span class="hl-identifier">String</span><span class="hl-brackets">)</span><span ></span><span class="hl-code">
</span><span >#define</span><span class="hl-code"> </span><span class="hl-identifier">gettext_noop</span><span class="hl-brackets">(</span><span class="hl-identifier">String</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">String</span><span class="hl-brackets">)</span><span ></span><span class="hl-code">
 
</span><span >char</span><span class="hl-code"> *</span><span class="hl-identifier">msg</span><span class="hl-code"> = </span><span class="hl-identifier">N_</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">GNU gettext excersize</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> ロカール名を環境変数から取得 </span><span class="hl-mlcomment">*/</span><span class="hl-code">
    </span><span class="hl-identifier">setlocale</span><span class="hl-brackets">(</span><span class="hl-identifier">LC_ALL</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> ドメイン名&quot;test&quot;のメッセージカタログディレクトリをカレントディレクトリに設定 </span><span class="hl-mlcomment">*/</span><span class="hl-code">
    </span><span class="hl-identifier">bindtextdomain</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">test</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">.</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> ドメイン名を&quot;test&quot;に設定 </span><span class="hl-mlcomment">*/</span><span class="hl-code">
    </span><span class="hl-identifier">textdomain</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">test</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
 
    </span><span class="hl-identifier">puts</span><span class="hl-brackets">(</span><span class="hl-identifier">_</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">Hello, World!</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">puts</span><span class="hl-brackets">(</span><span class="hl-identifier">_</span><span class="hl-brackets">(</span><span class="hl-identifier">msg</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<pre>$ gcc -Wall -o test test.c
$ ./test
Hello, World!
GNU gettext excersize
</pre>

<h5 id="ideb9e2f">xgettextでメッセージを抽出 → &quot;*.pot&quot; → &quot;*.po&quot;翻訳</h5>

<p class="paragraph">
基本：
<br />
</p>
<pre>xgettext -kキーワード -o XXYY.pot 抽出対象ファイル群
</pre>

<p class="paragraph">
キーワードに&quot;_&quot;, &quot;N_&quot;の二種類を指定することで、両方のマクロが適用された翻訳対象文字列を抽出できる。
<br />
</p>
<pre>$ xgettext -k&quot;_&quot; -k&quot;N_&quot; -o test.pot test.c
$ cp test.pot test.po
</pre>

<p class="paragraph">
とりあえず&quot;Content-Type&quot;に文字コードを設定し、他、空になっているmsgstrに日本語翻訳文字列を埋め込む。
<br />
</p>
<pre>&quot;Content-Type: text/plain; charset=CHARSET\n&quot;
→ とりあえずUTF-8で埋め込むので、UTF-8にしておく。EUC-JPとかでもOK.
&quot;Content-Type: text/plain; charset=UTF-8\n&quot;
...
#: test.c:9
msgid &quot;GNU gettext excersize&quot;
msgstr &quot;GNU gettext 練習サンプル&quot;

#: test.c:16
msgid &quot;Hello, World!&quot;
msgstr &quot;こんにちは、世界！&quot;
</pre>

<h5 id="id4366d7">msgfmtでコンパイル → &quot;*.mo&quot;ファイルを配置・動作確認</h5>

<p class="paragraph">
基本：
<br />
</p>
<pre>msgfmt -o XXYY.mo foo.po
</pre>

<p class="paragraph">
今回は以下のようにコンパイルした。
<br />
</p>
<pre>$ msgfmt -o test.mo test.po
</pre>

<p class="paragraph">
メッセージカタログディレクトリの起点は&quot;.&quot;にしてあるので、ディレクトリを作成してmoファイルを配置する。
<br />
</p>
<pre>$ mkdir -p ja/LC_MESSAGES
$ cp test.mo ja/LC_MESSAGES/test.mo
</pre>
<p class="paragraph">
途中の*.poや*.moファイルは偶々ドメイン名と同じにして作業していたが、最終的にLC_MESSAGES/以下に配置される時にドメイン名.moになっていればよい。途中ファイルについては好きなファイル名にしても問題ない。
<br />
</p>

<p class="paragraph">
動作確認：
<br />
</p>
<pre>$ LANG=C ./test
Hello, World!
GNU gettext excersize
$ LANG=ja_JP.UTF-8 ./test
こんにちは、世界！
GNU gettext 練習サンプル
</pre>

<h4 id="id8b0409">ソースコードが変更された場合のメンテナンス作業</h4>

<p class="paragraph">
次のようにtest.cを修正してみる。
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">locale.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">libintl.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >#define</span><span class="hl-code"> </span><span class="hl-identifier">_</span><span class="hl-brackets">(</span><span class="hl-identifier">String</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">gettext</span><span class="hl-brackets">(</span><span class="hl-identifier">String</span><span class="hl-brackets">)</span><span ></span><span class="hl-code">
</span><span >#define</span><span class="hl-code"> </span><span class="hl-identifier">N_</span><span class="hl-brackets">(</span><span class="hl-identifier">String</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">gettext_noop</span><span class="hl-brackets">(</span><span class="hl-identifier">String</span><span class="hl-brackets">)</span><span ></span><span class="hl-code">
</span><span >#define</span><span class="hl-code"> </span><span class="hl-identifier">gettext_noop</span><span class="hl-brackets">(</span><span class="hl-identifier">String</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">String</span><span class="hl-brackets">)</span><span ></span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">setlocale</span><span class="hl-brackets">(</span><span class="hl-identifier">LC_ALL</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">bindtextdomain</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">test</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">.</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">textdomain</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">test</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
 
    </span><span class="hl-identifier">puts</span><span class="hl-brackets">(</span><span class="hl-identifier">_</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">Hello, World!!</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">puts</span><span class="hl-brackets">(</span><span class="hl-identifier">_</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">How are you?</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>
<p class="paragraph">
変更点：
<br />
</p>
<ul><li> &quot;Hello, World&quot;の末尾の&quot;!&quot;が、1個→2個に増えた。</li>
<li> &quot;How are you?&quot;メッセージの追加</li>
<li> &quot;GNU gettext excersize&quot; の削除</li></ul>

<pre>$ gcc -Wall -o test test.c
$ ./test
Hello, World!!
How are you?
</pre>

<h5 id="idb45a81">xgettextでメッセージ抽出、msgmergeでマージ</h5>

<p class="paragraph">
基本：
<br />
</p>
<pre>msgmerge マージ先poファイル マージ元potファイル -o マージ結果出力poファイル
</pre>

<pre>$ xgettext -k&quot;_&quot; -k&quot;N_&quot; -o test.pot test.c
$ msgmerge test.po test.pot -o new_test.po
.. 完了.
</pre>

<p class="paragraph">
new_test.po:
<br />
</p>
<pre class="plugin_pre">
...

#: test.c:14
#, fuzzy
msgid &quot;Hello, World!!&quot;
msgstr &quot;こんにちは、世界！&quot;

#: test.c:15
msgid &quot;How are you?&quot;
msgstr &quot;&quot;

#~ msgid &quot;GNU gettext excersize&quot;
#~ msgstr &quot;GNU gettext 練習サンプル&quot;
</pre>

<pre>#, fuzzy
</pre>
<p class="paragraph">
→元のmsgidから少しだけ変更された場合に付く特殊なフラグコメント。&quot;#, fuzzy&quot;付のエントリはmsgfmtからは「翻訳済」とは見なされない。
<br />
</p>

<pre>#~ msgid ...
#~ msgstr ...
</pre>
<p class="paragraph">
→obsoleteなメッセージで、使われなくなったmsgid, msgstrを意味する。
<br />
</p>

<p class="paragraph">
とりあえず以下のように書き換えておく。
<br />
</p>
<pre>#: test.c:14
msgid &quot;Hello, World!!&quot;
msgstr &quot;こんにちは、世界！！&quot;

#: test.c:15
msgid &quot;How are you?&quot;
msgstr &quot;御機嫌如何？&quot;
</pre>

<h5 id="id270815">msgfmtでコンパイル→動作確認</h5>

<pre>$ msgfmt new_test.po -o test.mo
$ cp test.mo ja/LC_MESSAGES/
cp: `ja/LC_MESSAGES/test.mo&#039; を上書きしてもよろしいですか(yes/no)? yes
</pre>

<pre>$ gcc -Wall -o test test.c
$ LANG=C ./test
Hello, World!!
How are you?
$ LANG=ja_JP.UTF-8 ./test
こんにちは、世界！！
御機嫌如何？
</pre>

<h3 id="ide47dd1">Autoconf/Automakeに組み込みたい</h3>

<p class="paragraph">
GNU gettext HTMLドキュメントの &quot;13 The Maintainer&#039;s View&quot; に詳細が載っている為、ここではポイントとなる手順だけを示す。
<br />
</p>
<ol><li> m4ディレクトリを用意し、トップのMakefile.amで &quot;ACLOCAL_AMFLAGS = -I ./m4&quot; を指定しておく。</li>
<li> Autoconfによるconfigureスクリプトまで生成させたら、&quot;gettextize -c --intl&quot; を実行する。poディレクトリ＋ファイル群の作成、m4ディレクトリへのマクロファイルコピー、configure.ac,Makefile.amなどが自動調整される。</li>
<li> po/POTFILES.in へメッセージ抽出対象のソースファイルを列挙する。</li>
<li> po/Makevars.template を po/Makevars にリネーム or コピーする。</li>
<li> configure.acに以下のマクロを追加<ol><li> AC_CANONICAL_HOST : AM_GNU_GETTEXTがconfigu.guess, config.subを必要としているため。</li>
<li> AM_GNU_SOURCE, AM_GNU_GETTEXT</li>
<li> AC_CONFIG_FILESに intl/Makefile, po/Makefile.in を追加</li></ol></li></ol>

<p class="paragraph">
メンテナンス：
<br />
</p>
<ul><li> テンプレートの更新：&quot;cd po/; make (POT名).pot-update&quot;</li>
<li> メッセージカタログ(ロカール)の追加：po/LINGUASにロカール名を追加</li>
<li> カタログの更新とコンパイル：&quot;make update-po&quot; or &quot;make&quot;</li></ul>

<p class="paragraph">
gettextの無効化：
<br />
</p>
<ul><li> configure時に &quot;--disable-nls&quot; オプションを指定する。</li>
<li> ENABLE_NLSマクロが未定義になる為、#ifndefなどで #include &lt;libintl.h&gt; を #include &quot;gettext.h&quot; にする。</li>
<li> gettext.hはシステムに入っているlibディレクトリなどからコピーしてくる。ただし、gettext.h自体はシステムディレクトリにインストールしないように注意する。</li></ul>

<hr />
<p class="paragraph">
以下、GNU Libtool HTMLドキュメントでの主な見出しをポイントしておく。(見出しの番号については2009/11時点のものなので、将来変更される可能性がある) 
<br />
</p>
<ul><li> &quot;xgettext&quot;によるPOテンプレートファイルの生成機能を詳しく知りたい<ul><li> &quot;5 Making the PO Template File&quot; 以下参照</li></ul></li>
<li> &quot;msgfmt&quot;, &quot;msgmerge&quot; の他にどんな&quot;msgXXXX&quot;ツールがあるか知りたい<ul><li> &quot;9 Manipulating PO Files&quot; 以下参照</li></ul></li>
<li> &quot;msgfmt&quot;の詳細を知りたい、逆方向の変換ツール&quot;msgunfmt&quot;を知りたい、GNU MOファイルのフォーマットを知りたい<ul><li> &quot;10 Producing Binary MO Files&quot; 以下参照</li></ul></li>
<li> Autoconf/Automakeとの連携の詳細を知りたい<ul><li> &quot;13 The Maintainer&#039;s View&quot; 以下参照</li></ul></li></ul>

<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-577.html" title="C言語系/memos/gcc/関数の属性機能(&quot;__attribute__&quot;)">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-480.html" title="C言語系/memos/gmake">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-478.html" title="C言語系">C言語系</a>&nbsp;]</li>
</ul><div class="footnote">
<a id="footnote_488_1" href="#footnote_488_1_r">*1</a>: &quot;*.gmo&quot;ファイルというのは、&quot;GNU gettextのサポートするmoファイルフォーマット&quot;という意味。moファイルのバイナリフォーマットはシステムによって差異があり、GNU gettextがサポートしないフォーマットの場合もある。この図では特にGNU gettextのmoフォーマットである事を意味するため、&quot;.gmo&quot;としている。
</div>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/488<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2001 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a target="_blank" href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" target="_blank" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>