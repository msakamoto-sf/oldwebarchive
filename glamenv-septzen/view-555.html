<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>C言語系/「デーモン君のソース探検」読書メモ/11, file(1) - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">C言語系/「デーモン君のソース探検」読書メモ/11, file(1)</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2010-01-14 22:10:23 &nbsp; / &nbsp; last updated at: 2010-01-14 22:12:56<br>
カテゴリ: <a href="category-32.html">BSD</a>&nbsp;<a href="category-10.html">C言語</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-554.html" title="C言語系/「デーモン君のソース探検」読書メモ/10, tail(1)">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-563.html" title="C言語系/「デーモン君のソース探検」読書メモ/12, script(1)">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-478.html" title="C言語系">C言語系</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
お題：&quot;file&quot;コマンドがELFファイルを認識する流れを追跡せよ。
<br />
</p>

<p class="paragraph">
※今回はあまり細かい所は見ずに、ざっと関数呼び出しの流れだけを俯瞰するに留めます。「デーモン君のソース探検」の方でも、fileコマンドのソース自体がそれなりに量があるためか細かいコードは紹介されて居らず、ELFファイルの解析までの関数呼び出しフローとELFファイルの構造がメインになっています。
<br />
</p>




<p class="paragraph">
まずfileコマンドと、判定に使うmagicファイル関連のmanページは以下の通り。
<br />
</p>
<pre>man 1 file
man 5 magic
</pre>
<p class="paragraph">
NetBSD1.6の場合、magicファイルは &quot;/usr/share/misc/magic&quot; に存在する。他のUNIXの場合は/etc/magicの場合もあるかも。
<br />
</p>

<p class="paragraph">
ソースは
<br />
</p>
<pre>/usr/src/usr.bin/file
</pre>
<p class="paragraph">
にある。複数のヘッダーやソースファイルに分割されている。また、magicファイルはmakeの途中に、magdir/以下のファイル群を集約されて生成されるようになっている。
<br />
READMEファイルに簡単に各ファイルの解説があるのでここに載せておく。
<br />
</p>
<pre class="plugin_pre">
apprentice.c - parses /etc/magic to learn magic
ascmagic.c - third &amp; last set of tests, based on hardwired assumptions.
core - not included in distribution due to mailer limitations.
debug.c - includes -c printout routine
file.1 - man page for the command
magic.4 - man page for the magic file, courtesy Guy Harris.
        Install as magic.4 on USG and magic.5 on V7 or Berkeley; cf Makefile.
file.c - main program
file.h - header file
fsmagic.c - first set of tests the program runs, based on filesystem info
is_tar.c, tar.h - knows about tarchives (courtesy John Gilmore).
magdir - directory of /etc/magic pieces
        magdir/Makefile - ADJUST THIS FOR YOUR CONFIGURATION
names.h - header file for ascmagic.c
softmagic.c - 2nd set of tests, based on /etc/magic
readelf.[ch] - Stand-alone elf parsing code.
compress.c - on-the-fly decompression.
print.c - print results, errors, warnings.
</pre>
<p class="paragraph">
今回のテーマに関連してくるのは以下のファイルになる。
<br />
</p>
<ul><li> メインプログラムである file.c</li>
<li> magicファイルの解析を行う apprentice.c</li>
<li> magicファイルの解析結果を使って判定する softmagic.c</li>
<li> ELFファイルの解析を行う readelf.c, readelf.h</li></ul>

<p class="paragraph">
それでは駆け足でELF判定までの流れを追ってみる。
<br />
</p>

<p class="paragraph">
file.cのmain()の半分以上はオプション解析のコードになっている。その中で、magicファイルの構文解析を行うapprentice()関数が一度だけ呼ばれるようになっている。次のようなコードをmain()中でよく見かける。app変数がフラグとなり、一度だけ行われるようにロックされている。apprentice()関数はapprentice.cの中で定義されている。今回はその中身までは踏み込まない。
<br />
</p>
<pre>if (!app) {
        ret = apprentice(magicfile, action);
        if (action)
                exit(ret);
        app = 1;
}
</pre>
<p class="paragraph">
オプション解析とapprentice()によるmagicファイルの構文解析が完了すれば、コマンドラインで指定された各ファイルについてprocess()関数を実行していく。
<br />
</p>
<pre>for (; optind &lt; argc; optind++)
    process(argv[optind], wid);
</pre>

<p class="paragraph">
process()関数はfile.cの後半に定義されている。process()関数の詳細は割愛し、ELF判定に関連する部分だけピックアップする。
<br />
まずtryit()関数を実行する。
<br />
</p>
<pre>if (nbytes == 0)
        ckfputs(iflag ? &quot;application/x-empty&quot; : &quot;empty&quot;, stdout);
else {
        buf[nbytes++] = &#039;\0&#039;;   /* null-terminate it */
        match = tryit(inname, buf, nbytes, zflag);
}
</pre>
<p class="paragraph">
tryit()関数では zmagic(), softmagic(), ascmagic() の順番に判定関数を実行していき、判定できた時点で&#039;z&#039;, &#039;s&#039;, &#039;a&#039;をそれぞれ返す。
<br />
</p>
<pre class="plugin_pre">
int
tryit(fn, buf, nb, zfl)
    const char *fn;         /* file name*/
    unsigned char *buf;     /* buffer */
    int nb, zfl;
{
    /* ... */

    /* try compression stuff */
    if (zfl &amp;&amp; zmagic(fn, buf, nb))
            return &#039;z&#039;;

    /* try tests in /etc/magic (or surrogate magic file) */
    if (softmagic(buf, nb))
            return &#039;s&#039;;

    /* try known keywords, check whether it is ASCII */
    if (ascmagic(buf, nb))
            return &#039;a&#039;;

    /* ... */
}
</pre>
<p class="paragraph">
process()関数に戻ると、もしtryit()でsoftmagic()による判定となれば続けてtryelf()によるELFの判定関数を実行している。
<br />
</p>
<pre>if (match == &#039;s&#039; &amp;&amp; nbytes &gt; 5) {
        /* ... */
        tryelf(fd, buf, nbytes);
}
</pre>
<p class="paragraph">
たとえELFでなくとも、softmagic()で判定となればtryelf()も自動的に呼ばれる流れになっている。
<br />
softmagic()はsoftmagic.cで定義されており、magicファイルの構文解析結果を用いて、どれかにマッチすれば1を返すようになっている。
<br />
</p>

<p class="paragraph">
tryelf()に進むと、これはreadelf.cで定義されている。ELFで実行可能なファイルの場合にプログラムヘッダーを解析し、続けてセクションヘッダーを解析するのが次のコードブロック：
<br />
</p>
<pre class="plugin_pre">
if (getu16(swap, elfhdr.e_type) == ET_EXEC) {
    dophn_exec(class, swap,
        fd,
        getu32(swap, elfhdr.e_phoff),
        getu16(swap, elfhdr.e_phnum),
        getu16(swap, elfhdr.e_phentsize));
}
doshn(class, swap,
    fd,
    getu32(swap, elfhdr.e_shoff),
    getu16(swap, elfhdr.e_shnum),
    getu16(swap, elfhdr.e_shentsize));
</pre>
<p class="paragraph">
上のコードブロックは32bit用で、本当はこの下に64bit用で同様のコードブロックが続いている。
<br />
</p>

<p class="paragraph">
dophn_exec()ではプログラムヘッダーを一つ一つ見ていき、情報を表示している。
<br />
</p>
<pre class="plugin_pre">
static void
dophn_exec(class, swap, fd, off, num, size)
    /* ... */
{
/* ... */
for ( ; num; num--) {
    if (read(fd, ph_addr, ph_size) == -1)
            error(&quot;read failed (%s).\n&quot;, strerror(errno));

    switch (ph_type) {
    case PT_DYNAMIC:
        linking_style = &quot;dynamically&quot;;
        break;
    case PT_INTERP:
        shared_libraries = &quot; (uses shared libs)&quot;;
        break;
    case PT_NOTE:
        /* NOTE関連はかなり細かく色々解析している */
    }
}
printf(&quot;, %s linked%s&quot;, linking_style, shared_libraries);
}
</pre>

<p class="paragraph">
続いてdoshn()を見てみると、セクションヘッダーを見ていきセクションタイプで&quot;SHT_SYMTAB&quot;のセクションが見つかれば&quot;, not stripped&quot;と表示し、一つも&quot;SHT_SYMTAB&quot;セクションが見つからない場合は &quot;, stripped&quot; と表示している。
<br />
</p>
<pre class="plugin_pre">
static void
doshn(class, swap, fd, off, num, size)
    /* ... */
{
    Elf32_Shdr sh32;
    Elf64_Shdr sh64;

    /* ... */

    for ( ; num; num--) {
            if (read(fd, sh_addr, sh_size) == -1)
                    error(&quot;read failed (%s).\n&quot;, strerror(errno));
            if (shs_type == SHT_SYMTAB /* || shs_type == SHT_DYNSYM */) {
                    (void) printf (&quot;, not stripped&quot;);
                    return;
            }
    }
    (void) printf (&quot;, stripped&quot;);
}
</pre>

<p class="paragraph">
なお、ELF関連の構造体や定数だが file/readelf.h を使っている。そのためNetBSD1.6の
<br />
</p>
<pre>/usr/include/elf.h
</pre>
<p class="paragraph">
とは構造体の名前や細かいメンバ名、定数名などが異なっているので注意が必要。
<br />
</p>

<p class="paragraph">
以上、駆け足でELF判定までの流れを見てきた。ELFの構造自体の解説は「デーモン君のソース探検」本文、あるいはバイナリ系で詳しいWebページも増えてきているので、WikipediaやGoogleで探してみて欲しい。
<br />
</p>

<p class="paragraph">
今回のお題については、ここまで。
<br />
</p>

<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-554.html" title="C言語系/「デーモン君のソース探検」読書メモ/10, tail(1)">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-563.html" title="C言語系/「デーモン君のソース探検」読書メモ/12, script(1)">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-546.html" title="C言語系/「デーモン君のソース探検」読書メモ">Up</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-478.html" title="C言語系">C言語系</a>&nbsp;]</li>
</ul>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/555<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2007 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>