<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>技術/Windows/PE(Portable Executable)フォーマットの実験 - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">技術/Windows/PE(Portable Executable)フォーマットの実験</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2010-07-14 21:42:15 &nbsp; / &nbsp; last updated at: 2010-07-14 22:29:05<br>
カテゴリ: <a href="category-48.html">Assembler</a>&nbsp;<a href="category-8.html">Windows</a>&nbsp;<a href="category-50.html">hacks</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-1096.html" title="技術/Windows/NTFSの外付けHDDのファイルにアクセス出来ない時は・・・(takeown, icacls)">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-664.html" title="技術/Windows/PE(Portable Executable)フォーマットの実験/01, リンカオプション">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-23.html" title="技術">技術</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
Windowsで使われている実行ファイルのフォーマット、PE(Portable Executable)関連のトピック集。
<br />
</p>


<hr />
<ul>
<li><a href="./view-664.html">技術/Windows/PE(Portable Executable)フォーマットの実験/01, リンカオプション</a></li>
<li><a href="./view-678.html">技術/Windows/PE(Portable Executable)フォーマットの実験/02, 再配置情報で遊ぼう！</a></li>
<li><a href="./view-707.html">技術/Windows/PE(Portable Executable)フォーマットの実験/03, TinyPEまとめ</a></li>
<li><a href="./view-710.html">技術/Windows/PE(Portable Executable)フォーマットの実験/04, 各種構造体のサイズ</a></li>
</ul>

<hr />
<ul><li><a href="#id11979b">これからPEフォーマットを学びたい人向けの進め方ガイド</a><ul><li><a href="#id0bb4f6">STEP 0 : (option) OllyDbgを使ってみよう！</a></li>
<li><a href="#id350f7a">STEP 1 : PEフォーマットを覗いてみよう！</a></li>
<li><a href="#id49275c">STEP 2 : COFF ObjectファイルやCOFF LIBファイルを覗いてみよう！</a></li>
<li><a href="#id69e7d4">STEP 3 : 仕上げ：&quot;Tiny PE&quot;でアセンブラを駆使して小さな実行ファイルを作れるようになろう！</a></li>
<li><a href="#iddc7773">STEP 4 : IATの書き換え、Hook、DLL Injectionの世界へ・・・</a></li>
<li><a href="#idfa719f">STEP 5 : PEフォーマットの助けを使わずにAPIを使う。</a></li>
<li><a href="#ida013b4">STEP 6 : リバースエンジニアリング(バイナリ解析)対抗技術を学ぶ。</a></li></ul></li></ul>
<hr />
<h3 id="id11979b">これからPEフォーマットを学びたい人向けの進め方ガイド</h3>

<p class="paragraph">
PEフォーマットを使って色々げへへな世界を味わいたい人向けに、どういう順番で学習を進めていけば良いのか簡単にまとめてみました。
<br />
</p>

<h4 id="id0bb4f6">STEP 0 : (option) OllyDbgを使ってみよう！</h4>

<p class="paragraph">
（興味のある人だけ）
<br />
別にOllyDbgに限定する必要はなく、マシン語レベルでデバッグできるソフトがあれば、それの使い方を簡単でもよいので学んでおこう！アセンブラも勉強しておくと尚良し！
<br />
プロセスのメモリ空間に展開されたPEフォーマットをじっくりと観察出来るので、理解も進むよ！
<br />
マシン語レベルのデバッガを使えるようになると、今まで見えなかったOSやCPUの挙動が見えてくるので楽しさも倍増！
<br />
</p>

<h4 id="id350f7a">STEP 1 : PEフォーマットを覗いてみよう！</h4>

<p class="paragraph">
まずはPEフォーマットの概要を掴み、WinNT.hを頼りにPythonやC/C++でPEフォーマットをダンプするプログラムを作ってみよう！視界がグンと広がるよ！
<br />
</p>

<ul><li> アレ用の何か<ul><li> <a class="externallink" href="http://hp.vector.co.jp/authors/VA050396/index.html" target="_blank">http://hp.vector.co.jp/authors/VA050396/index.html</a><ul><li> PEファイルフォーマット その1 ～ その5</li></ul></li></ul></li>
<li> Matt Pietrek氏によるPEフォーマット解説, &quot;Inside Windows: An In-Depth Look into the Win32 Portable Executable File Format&quot;<ul><li> Part1 : <a class="externallink" href="http://msdn.microsoft.com/en-us/magazine/cc301805.aspx" target="_blank">http://msdn.microsoft.com/en-us/magazine/cc301805.aspx</a></li>
<li> Part2 : <a class="externallink" href="http://msdn.microsoft.com/en-us/magazine/cc301808.aspx" target="_blank">http://msdn.microsoft.com/en-us/magazine/cc301808.aspx</a></li></ul></li></ul>

<p class="paragraph">
※「アレ用の何か」ではAPI HookingやDLL Injectionまで扱ってますが、STEP 1の段階でそこまで突っ込まなくても大丈夫だよ！慌てずに・・・。
<br />
</p>

<h4 id="id49275c">STEP 2 : COFF ObjectファイルやCOFF LIBファイルを覗いてみよう！</h4>

<p class="paragraph">
PEフォーマットを覗けるようになったら、その一歩手前のオブジェクト(COFF Object)ファイルも簡単に覗けるようになるよ！併せてCOFF LIBファイルのフォーマットも理解しちゃおう！コンパイラやリンカの仕組みも絡んでくるディープな世界へようこそ！
<br />
</p>

<ul><li> アレ用の何か<ul><li> <a class="externallink" href="http://hp.vector.co.jp/authors/VA050396/index.html" target="_blank">http://hp.vector.co.jp/authors/VA050396/index.html</a><ul><li> PEファイルフォーマット その1 ～ その5</li></ul></li></ul></li>
<li> Matt Pietrek氏によるMicrosoft System Journal(MSJ), &quot;Under the Hood&quot;シリーズ<ul><li> July 1997, OBJファイルフォーマットとリンカの仕組み<ul><li> <a class="externallink" href="http://www.microsoft.com/msj/0797/hood0797.aspx" target="_blank">http://www.microsoft.com/msj/0797/hood0797.aspx</a></li></ul></li>
<li> April 1998, LIBファイルフォーマット<ul><li> <a class="externallink" href="http://www.microsoft.com/msj/0498/hood0498.aspx" target="_blank">http://www.microsoft.com/msj/0498/hood0498.aspx</a></li></ul></li></ul></li></ul>

<p class="paragraph">
※「アレ用の何か」ではCRT(C RunTime library)の関数のhookingを題材にしていますが、そこまで突っ込まなくてもOK！まずはPythonやC/C++で簡単なユーティリティを作って、自力で覗けるようになることを目指そう！
<br />
</p>

<h4 id="id69e7d4">STEP 3 : 仕上げ：&quot;Tiny PE&quot;でアセンブラを駆使して小さな実行ファイルを作れるようになろう！</h4>

<p class="paragraph">
そろそろPEファイルのHEXダンプも見慣れてきた頃かな？
<br />
では「仕上げ」として、アセンブラを使ってPEファイルの各種ヘッダーを自分で用意し、100バイト前後の小さな(Tiny)実行ファイルを作ってみよう！
<br />
トリッキーなテクニックも使うので、理解するのは大変だろうけど、これまでの知識の総動員となるので復習も兼ねた腕試しだ！
<br />
</p>

<ul><li> Tiny PE<ul><li> <a class="externallink" href="http://www.phreedom.org/solar/code/tinype/" target="_blank">http://www.phreedom.org/solar/code/tinype/</a></li></ul></li></ul>

<p class="paragraph">
※アセンブラの知識が必須だよ！
<br />
</p>

<h4 id="iddc7773">STEP 4 : IATの書き換え、Hook、DLL Injectionの世界へ・・・</h4>

<p class="paragraph">
ちょっと怪しげな香りが漂ってきたね。
<br />
「アレ用の何か」やcodeprojectのサイトで、IATの書き換えやHook、DLL Injection、PEファイル(DLL)の疑似ロードなどを学ぼう！
<br />
</p>

<ul><li> アレ用の何か<ul><li> <a class="externallink" href="http://hp.vector.co.jp/authors/VA050396/index.html" target="_blank">http://hp.vector.co.jp/authors/VA050396/index.html</a><ul><li> PEファイルフォーマット その3, その5</li></ul></li></ul></li>
<li> APIHijack - A Library for easy DLL function hooking. - CodeProject<ul><li> <a class="externallink" href="http://www.codeproject.com/kb/dll/apihijack.aspx" target="_blank">http://www.codeproject.com/kb/dll/apihijack.aspx</a></li></ul></li></ul>

<h4 id="idfa719f">STEP 5 : PEフォーマットの助けを使わずにAPIを使う。</h4>

<p class="paragraph">
どういうことかというと、IATを使わず、純粋に実行コードが自力でプロセスにロードされているDLLのエキスポート情報からAPIのアドレスを取得し、呼び出してみようということ。
<br />
これを応用すると、任意の実行コードをPEフォーマットに挿入することが出来るようになる。悪用厳禁！
<br />
</p>

<ul><li> Wizard Bible vol.17 (2005,4,29), 第1章<ul><li> <a class="externallink" href="http://wizardbible.org/17/17.txt" target="_blank">http://wizardbible.org/17/17.txt</a></li></ul></li>
<li> Wizard Bible vol.19 (2005,7,31), 第10章<ul><li> <a class="externallink" href="http://wizardbible.org/19/19.txt" target="_blank">http://wizardbible.org/19/19.txt</a></li></ul></li>
<li> Inject your code to a Portable Executable file - CodeProject<ul><li> <a class="externallink" href="http://www.codeproject.com/KB/system/inject2exe.aspx" target="_blank">http://www.codeproject.com/KB/system/inject2exe.aspx</a></li></ul></li></ul>

<h4 id="ida013b4">STEP 6 : リバースエンジニアリング(バイナリ解析)対抗技術を学ぶ。</h4>

<p class="paragraph">
ここまで来たら行けるところまで行ってみる？
<br />
バイナリ解析で必ず出くわす、アンチリバースエンジニアリングの世界を覗いてみよう！
<br />
</p>

<ul><li> Wizard Bible vol.32 (2007,4,6), 第2章, 第3章, 第4章<ul><li> <a class="externallink" href="http://wizardbible.org/32/32.txt" target="_blank">http://wizardbible.org/32/32.txt</a></li></ul></li>
<li> Wizard Bible vol.33 (2007,5,8), 第3章<ul><li> <a class="externallink" href="http://wizardbible.org/33/33.txt" target="_blank">http://wizardbible.org/33/33.txt</a></li></ul></li>
<li> An Anti-Reverse Engineering Guide - CodeProject<ul><li> <a class="externallink" href="http://www.codeproject.com/KB/security/AntiReverseEngineering.aspx" target="_blank">http://www.codeproject.com/KB/security/AntiReverseEngineering.aspx</a></li></ul></li></ul>

<p class="paragraph">
お仕事で「二重起動を防止したい」「シリアルナンバーの入力を回避されたくない」等の依頼が来ても、もう困らない・・・ようになる？かも！
<br />
</p>

<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-1096.html" title="技術/Windows/NTFSの外付けHDDのファイルにアクセス出来ない時は・・・(takeown, icacls)">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-664.html" title="技術/Windows/PE(Portable Executable)フォーマットの実験/01, リンカオプション">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-703.html" title="技術/Windows">Up</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-23.html" title="技術">技術</a>&nbsp;]</li>
</ul>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/708<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2007 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>