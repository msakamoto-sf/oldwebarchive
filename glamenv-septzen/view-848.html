<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>C言語系/「デーモン君のソース探検」読書メモ/A08, pause(3), sigsuspend(2) - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">C言語系/「デーモン君のソース探検」読書メモ/A08, pause(3), sigsuspend(2)</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2010-11-23 19:15:41 &nbsp; / &nbsp; last updated at: 2010-11-24 09:22:43<br>
カテゴリ: <a href="category-32.html">BSD</a>&nbsp;<a href="category-10.html">C言語</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-847.html" title="C言語系/「デーモン君のソース探検」読書メモ/A07, nohup(1)">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-849.html" title="C言語系/「デーモン君のソース探検」読書メモ/A09, write(2) + O_APPEND">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-478.html" title="C言語系">C言語系</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
お題：pause(3)関数を使う上での問題点と、sigsuspend(2)による対処法を検討せよ
<br />
</p>

<p class="paragraph">
※この章は「デーモン君のソース探検」に載っていませんが、msakamoto-sf自身が個人的に興味を持って調べ、&quot;Appendix&quot;として読書メモシリーズに入れてありますのでご注意下さい。
<br />
</p>

<p class="paragraph">
（今回の内容は、&quot;Advanced UNIX Programming 2nd Ed&quot;(AUP), &quot;9.2 Waiting for Signal&quot; のパクリです。）
<br />
</p>



<ul><li><a href="#id854887">pause(3)の使い方</a></li>
<li><a href="#id3b0a93">pause(3)のソースコード</a></li>
<li><a href="#id68510c">いくつかのシグナル系関数の復習</a><ul><li><a href="#ida828fe">sigaction()の復習</a><ul><li><a href="#id2ec9fc">SIGUSR1で実験 : getchar()中にSIGUSR1を受けて終了</a></li>
<li><a href="#id7aa1ac">SIGUSR1で実験その２ : SA_RESTART付けてgetchar()続行</a></li></ul></li>
<li><a href="#id848e0e">sigprocmask()の復習</a><ul><li><a href="#ide79c45">sigprocmask()とpause()を組み合わせてみる</a></li>
<li><a href="#id3eff6f">sigprocmask()とpause()を組み合わせてみる、ただしSIGUSR2のハンドラは未設定</a></li></ul></li>
<li><a href="#idd831ae">sigsuspend()の復習</a><ul><li><a href="#idfb07c9">sigsuspend()の復習、ただしSIGUSR2のシグナルハンドラ未設定</a></li>
<li><a href="#id386061">sigfilset() -&gt; sigsuspend() : 無限wait</a></li>
<li><a href="#id6187fb">sigemptyset() -&gt; sigsuspend() : とにかく何でも良いのでシグナル受信で待機解除</a></li></ul></li></ul></li>
<li><a href="#id740d32">pause(3)が問題となる場面とsigsuspend(2)による対処</a><ul><li><a href="#idcb098e">実例 : 親子プロセスでfork()直後に同期をとる例</a></li></ul></li>
<li><a href="#id758f90">sigwait(3) (pthread_signal(3)) の利用</a><ul><li><a href="#id475423">事前block無しでsigwait(3)を使ってみる</a></li>
<li><a href="#iddc371b">事前block後にsigwait(3)を使ってみる</a></li>
<li><a href="#id31a564">実例 : 親子プロセスでfork()直後に同期をとる例でsigwait()を使ってみる</a></li></ul></li>
<li><a href="#idfd0d2e">まとめ</a></li></ul>
<hr />
<h3 id="id854887">pause(3)の使い方</h3>

<p class="paragraph">
何かしらのシグナルを受信し、シグナルハンドラが実行されるまで待機する。
<br />
</p>

<p class="paragraph">
pause1.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">unistd.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">signal.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">errno.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >void</span><span class="hl-code"> </span><span class="hl-identifier">sig_usr</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">signo</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sig_usr : signo=%d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">signo</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">argc</span><span class="hl-code">, </span><span >char</span><span class="hl-code"> *</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span >struct</span><span class="hl-code"> </span><span class="hl-identifier">sigaction</span><span class="hl-code"> </span><span class="hl-identifier">sa</span><span class="hl-code">;
        </span><span class="hl-identifier">memset</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">sa</span><span class="hl-code">, </span><span class="hl-number">0</span><span class="hl-code">, </span><span class="hl-reserved">sizeof</span><span class="hl-brackets">(</span><span class="hl-identifier">sa</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">sa</span><span class="hl-code">.</span><span class="hl-identifier">sa_handler</span><span class="hl-code"> = </span><span class="hl-identifier">sig_usr</span><span class="hl-code">;
        </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">-</span><span class="hl-number">1</span><span class="hl-code"> == </span><span class="hl-identifier">sigaction</span><span class="hl-brackets">(</span><span class="hl-identifier">SIGUSR1</span><span class="hl-code">, &amp;</span><span class="hl-identifier">sa</span><span class="hl-code">, </span><span >NULL</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
                </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sigaction</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
                </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code">
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">pid = %d, pause start...</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">getpid</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">pause</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">pause end.</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<pre>$ make pause1  # 手抜きしてmakeのデフォルトルールでコンパイル
pid = 797, pause start...
(別端末から kill -USR1 797)
sig_usr : signo=30
pause end.
$
</pre>

<h3 id="id3b0a93">pause(3)のソースコード</h3>

<pre>$ locate pause
...
/usr/src/lib/libc/gen/pause.3
/usr/src/lib/libc/gen/pause.c
...
</pre>

<p class="paragraph">
/usr/src/lib/libc/gen/pause.c:
<br />
</p>
<div class="hl-main"><pre><span class="hl-mlcomment">/*</span><span class="hl-mlcomment">
 * Backwards compatible pause.
 </span><span class="hl-mlcomment">*/</span><span class="hl-code">
</span><span >int</span><span class="hl-code">
</span><span class="hl-identifier">pause</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">sigset_t</span><span class="hl-code"> </span><span class="hl-identifier">omask</span><span class="hl-code">;
 
        </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> 現在のシグナルマスクを取得 </span><span class="hl-mlcomment">*/</span><span class="hl-code">
        </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">sigprocmask</span><span class="hl-brackets">(</span><span class="hl-identifier">SIG_BLOCK</span><span class="hl-code">, </span><span >NULL</span><span class="hl-code">, &amp;</span><span class="hl-identifier">omask</span><span class="hl-brackets">)</span><span class="hl-code"> == -</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">
                </span><span class="hl-reserved">return</span><span class="hl-code"> -</span><span class="hl-number">1</span><span class="hl-code">;
 
        </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> omaskにセットされているもの「以外の」シグナルを
           受信するまで待機 </span><span class="hl-mlcomment">*/</span><span class="hl-code">
        </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">sigsuspend</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">omask</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
以上より、pause(3)の仕組みは次の２ステップになる。
<br />
</p>
<ol><li> 現在block中のシグナルマスクを取得し、</li>
<li> blockしていないシグナルを受信してシグナルハンドラから戻るまで待機</li></ol>

<p class="paragraph">
今回のお題については、ここまで・・・としたいところだが、お題の内容が「pause(3)の問題点とsigsuspend(2)による対処法」である以上、このままでは不十分である。
<br />
pause(3), sigsuspend(2) ともにシグナルが到着するまで待機する点は共通だが、pause(3)の使用が問題となる場面、およびsigsuspend(2)による対処法を &quot;Advanced UNIX Programming 2nd Ed&quot; &quot;9.2 Waiting for Signal&quot; をお手本に読み解いてみる。
<br />
</p>

<h3 id="id68510c">いくつかのシグナル系関数の復習</h3>

<p class="paragraph">
ウォーミングアップとして単純なサンプル(codepiece)をいくつか作成し、シグナル系の関数を復習してみる。
<br />
なお各システムコールや関数のプロトタイプ・引数・戻り値の仕様などは省略する。各自manpageを参照のこと。
<br />
</p>

<p class="paragraph">
（以下のソースコードではシグナルハンドラ中でasync-signal-safeでないprintf()を使っている。本来、シグナルハンドラ中ではwrite()などasync-signal-safeな関数のみを使う。今回はサンプルコードということで簡略のためprintf()を使っている。実務でのプログラミングにおいては注意が必要。）
<br />
</p>


<h4 id="ida828fe">sigaction()の復習</h4>

<p class="paragraph">
sigaction()を復習してみる。
<br />
</p>

<h5 id="id2ec9fc">SIGUSR1で実験 : getchar()中にSIGUSR1を受けて終了</h5>

<p class="paragraph">
sig01.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">unistd.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">signal.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">errno.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >void</span><span class="hl-code"> </span><span class="hl-identifier">sig_usr</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">signo</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sig_usr : signo=%d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">signo</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">argc</span><span class="hl-code">, </span><span >char</span><span class="hl-code"> *</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span >struct</span><span class="hl-code"> </span><span class="hl-identifier">sigaction</span><span class="hl-code"> </span><span class="hl-identifier">sa</span><span class="hl-code">;
        </span><span class="hl-identifier">memset</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">sa</span><span class="hl-code">, </span><span class="hl-number">0</span><span class="hl-code">, </span><span class="hl-reserved">sizeof</span><span class="hl-brackets">(</span><span class="hl-identifier">sa</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">sa</span><span class="hl-code">.</span><span class="hl-identifier">sa_handler</span><span class="hl-code"> = </span><span class="hl-identifier">sig_usr</span><span class="hl-code">;
        </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">-</span><span class="hl-number">1</span><span class="hl-code"> == </span><span class="hl-identifier">sigaction</span><span class="hl-brackets">(</span><span class="hl-identifier">SIGUSR1</span><span class="hl-code">, &amp;</span><span class="hl-identifier">sa</span><span class="hl-code">, </span><span >NULL</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
                </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sigaction</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
                </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code">
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">my pid = %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">getpid</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">EOF</span><span class="hl-code"> == </span><span class="hl-identifier">getchar</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
                </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">getchar()</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code">
        </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<pre>$ make sig01 # makeのデフォルトルールでコンパイル：手抜き。
$ ./sig01
my pid = 760
(別端末：$ kill -USR1 760)
sig_usr : signo=30
getchar(): Interrupted system call
$ # getchar()の入力を待たずに終了
</pre>

<h5 id="id7aa1ac">SIGUSR1で実験その２ : SA_RESTART付けてgetchar()続行</h5>

<p class="paragraph">
sig02.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">unistd.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">signal.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">errno.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >void</span><span class="hl-code"> </span><span class="hl-identifier">sig_usr</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">signo</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sig_usr : signo=%d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">signo</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">argc</span><span class="hl-code">, </span><span >char</span><span class="hl-code"> *</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span >struct</span><span class="hl-code"> </span><span class="hl-identifier">sigaction</span><span class="hl-code"> </span><span class="hl-identifier">sa</span><span class="hl-code">;
        </span><span class="hl-identifier">memset</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">sa</span><span class="hl-code">, </span><span class="hl-number">0</span><span class="hl-code">, </span><span class="hl-reserved">sizeof</span><span class="hl-brackets">(</span><span class="hl-identifier">sa</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">sa</span><span class="hl-code">.</span><span class="hl-identifier">sa_handler</span><span class="hl-code"> = </span><span class="hl-identifier">sig_usr</span><span class="hl-code">;
        </span><span class="hl-identifier">sa</span><span class="hl-code">.</span><span class="hl-identifier">sa_flags</span><span class="hl-code"> = </span><span class="hl-identifier">SA_RESTART</span><span class="hl-code">;
        </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">-</span><span class="hl-number">1</span><span class="hl-code"> == </span><span class="hl-identifier">sigaction</span><span class="hl-brackets">(</span><span class="hl-identifier">SIGUSR1</span><span class="hl-code">, &amp;</span><span class="hl-identifier">sa</span><span class="hl-code">, </span><span >NULL</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
                </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sigaction</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
                </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code">
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">my pid = %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">getpid</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">EOF</span><span class="hl-code"> == </span><span class="hl-identifier">getchar</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
                </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">getchar()</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code">
        </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
シグナルを受けてシグナルハンドラが実行された後も、getchar()は中断されずに入力を待ち続ける。
<br />
</p>
<pre class="plugin_pre">
$ make sig02
$ ./sig02
my pid = 769
(別端末：$ kill -USR1 769)
sig_usr : signo=30
(別端末：$ kill -USR1 769, 二回目)
sig_usr : signo=30
a
$
</pre>

<h4 id="id848e0e">sigprocmask()の復習</h4>

<p class="paragraph">
sigprocmask()を復習してみる。
<br />
</p>

<p class="paragraph">
sig03.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">unistd.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">signal.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">errno.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >void</span><span class="hl-code"> </span><span class="hl-identifier">sig_usr</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">signo</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sig_usr : signo=%d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">signo</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">argc</span><span class="hl-code">, </span><span >char</span><span class="hl-code"> *</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">c</span><span class="hl-code">;
    </span><span class="hl-identifier">sigset_t</span><span class="hl-code"> </span><span class="hl-identifier">new_ss</span><span class="hl-code">, </span><span class="hl-identifier">old_ss</span><span class="hl-code">;
    </span><span >struct</span><span class="hl-code"> </span><span class="hl-identifier">sigaction</span><span class="hl-code"> </span><span class="hl-identifier">sa</span><span class="hl-code">;
 
 
    </span><span class="hl-identifier">memset</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">sa</span><span class="hl-code">, </span><span class="hl-number">0</span><span class="hl-code">, </span><span class="hl-reserved">sizeof</span><span class="hl-brackets">(</span><span class="hl-identifier">sa</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">sa</span><span class="hl-code">.</span><span class="hl-identifier">sa_handler</span><span class="hl-code"> = </span><span class="hl-identifier">sig_usr</span><span class="hl-code">;
    </span><span class="hl-identifier">sa</span><span class="hl-code">.</span><span class="hl-identifier">sa_flags</span><span class="hl-code"> = </span><span class="hl-identifier">SA_RESTART</span><span class="hl-code">;
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">-</span><span class="hl-number">1</span><span class="hl-code"> == </span><span class="hl-identifier">sigaction</span><span class="hl-brackets">(</span><span class="hl-identifier">SIGUSR1</span><span class="hl-code">, &amp;</span><span class="hl-identifier">sa</span><span class="hl-code">, </span><span >NULL</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sigaction</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">; </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">my pid = %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">getpid</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
 
    </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> SIGUSR1をブロックし、受信しても
       保留状態(pending)にして、シグナルハンドラ
       を実行しない </span><span class="hl-mlcomment">*/</span><span class="hl-code">
    </span><span class="hl-identifier">sigemptyset</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">new_ss</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">sigaddset</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">new_ss</span><span class="hl-code">, </span><span class="hl-identifier">SIGUSR1</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">-</span><span class="hl-number">1</span><span class="hl-code"> == </span><span class="hl-identifier">sigprocmask</span><span class="hl-brackets">(</span><span class="hl-identifier">SIG_BLOCK</span><span class="hl-code">, &amp;</span><span class="hl-identifier">new_ss</span><span class="hl-code">, &amp;</span><span class="hl-identifier">old_ss</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sigprocmask</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">; </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
 
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">input char:</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">c</span><span class="hl-code"> = </span><span class="hl-identifier">getchar</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">your input : %c</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">c</span><span class="hl-brackets">)</span><span class="hl-code">;
 
    </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> SIGUSR1ブロック前の状態に戻す
       = SIGUSR1のブロックを解除する。すでにSIGUSR1を受信し
       pendingになっていた場合は、この後直ちにSIGUSR1の
       シグナルハンドラが実行される </span><span class="hl-mlcomment">*/</span><span class="hl-code">
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">-</span><span class="hl-number">1</span><span class="hl-code"> == </span><span class="hl-identifier">sigprocmask</span><span class="hl-brackets">(</span><span class="hl-identifier">SIG_SETMASK</span><span class="hl-code">, &amp;</span><span class="hl-identifier">old_ss</span><span class="hl-code">, </span><span >NULL</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sigprocmask</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">; </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
 
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
実行し、getchar()中にSIGUSR1を送信してみる：
<br />
</p>
<pre class="plugin_pre">
$ make sig03
cc -O2   -o sig03 sig03.c
$ ./sig03
my pid = 1019
(別端末から kill -USR1 1019)
input char:a
your input : a
sig_usr : signo=30
$
</pre>

<p class="paragraph">
block解除後にSIGUSR1のシグナルハンドラが実行されている。
<br />
</p>

<h5 id="ide79c45">sigprocmask()とpause()を組み合わせてみる</h5>

<ol><li> SIGUSR1とSIGUSR2にシグナルハンドラをセットする。</li>
<li> SIGUSR1をブロックする。</li>
<li> ブロック中にpause()を呼び、SIGUSR2の受信を期待して待機する。</li>
<li> pause()復帰後、SIGUSR1のブロックを解除する。</li></ol>

<p class="paragraph">
sig04.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">unistd.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">signal.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">errno.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >void</span><span class="hl-code"> </span><span class="hl-identifier">sig_usr</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">signo</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sig_usr : signo=%d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">signo</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">argc</span><span class="hl-code">, </span><span >char</span><span class="hl-code"> *</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">c</span><span class="hl-code">;
        </span><span class="hl-identifier">sigset_t</span><span class="hl-code"> </span><span class="hl-identifier">new_ss</span><span class="hl-code">, </span><span class="hl-identifier">old_ss</span><span class="hl-code">;
        </span><span >struct</span><span class="hl-code"> </span><span class="hl-identifier">sigaction</span><span class="hl-code"> </span><span class="hl-identifier">sa</span><span class="hl-code">;
 
        </span><span class="hl-identifier">memset</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">sa</span><span class="hl-code">, </span><span class="hl-number">0</span><span class="hl-code">, </span><span class="hl-reserved">sizeof</span><span class="hl-brackets">(</span><span class="hl-identifier">sa</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">sa</span><span class="hl-code">.</span><span class="hl-identifier">sa_handler</span><span class="hl-code"> = </span><span class="hl-identifier">sig_usr</span><span class="hl-code">;
        </span><span class="hl-identifier">sa</span><span class="hl-code">.</span><span class="hl-identifier">sa_flags</span><span class="hl-code"> = </span><span class="hl-identifier">SA_RESTART</span><span class="hl-code">;
        </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">-</span><span class="hl-number">1</span><span class="hl-code"> == </span><span class="hl-identifier">sigaction</span><span class="hl-brackets">(</span><span class="hl-identifier">SIGUSR1</span><span class="hl-code">, &amp;</span><span class="hl-identifier">sa</span><span class="hl-code">, </span><span >NULL</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
                </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sigaction</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">; </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code">
        </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">-</span><span class="hl-number">1</span><span class="hl-code"> == </span><span class="hl-identifier">sigaction</span><span class="hl-brackets">(</span><span class="hl-identifier">SIGUSR2</span><span class="hl-code">, &amp;</span><span class="hl-identifier">sa</span><span class="hl-code">, </span><span >NULL</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
                </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sigaction</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">; </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code">
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">my pid = %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">getpid</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
 
        </span><span class="hl-identifier">sigemptyset</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">new_ss</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">sigaddset</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">new_ss</span><span class="hl-code">, </span><span class="hl-identifier">SIGUSR1</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">-</span><span class="hl-number">1</span><span class="hl-code"> == </span><span class="hl-identifier">sigprocmask</span><span class="hl-brackets">(</span><span class="hl-identifier">SIG_BLOCK</span><span class="hl-code">, &amp;</span><span class="hl-identifier">new_ss</span><span class="hl-code">, &amp;</span><span class="hl-identifier">old_ss</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
                </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sigprocmask</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">; </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code">
 
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">pause start...</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">pause</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">pause end.</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
 
        </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">-</span><span class="hl-number">1</span><span class="hl-code"> == </span><span class="hl-identifier">sigprocmask</span><span class="hl-brackets">(</span><span class="hl-identifier">SIG_SETMASK</span><span class="hl-code">, &amp;</span><span class="hl-identifier">old_ss</span><span class="hl-code">, </span><span >NULL</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
                </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sigprocmask</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">; </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code">
 
        </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
実行し、pause()中にSIGUSR1, SIGUSR2を順に送信してみる：
<br />
</p>
<pre class="plugin_pre">
$ make sig04
cc -O2   -o sig04 sig04.c
$ ./sig04
my pid = 842
pause start...
(別端末から kill -USR1 842)
(別端末から kill -USR2 842)
sig_usr : signo=31
pause end.
sig_usr : signo=30
$
</pre>

<p class="paragraph">
SIGUSR1送信時点ではpause()が解除されず、SIGUSR2を送信してシグナルハンドラ実行後pause()から復帰、ブロックされていたSIGUSR1がシグナルハンドラに送られたことがわかる。
<br />
</p>

<h5 id="id3eff6f">sigprocmask()とpause()を組み合わせてみる、ただしSIGUSR2のハンドラは未設定</h5>

<p class="paragraph">
sig04.cと同じだが、SIGUSR2には特にシグナルハンドラを設定せずデフォルトのままとしている。
<br />
sig05.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">unistd.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">signal.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">errno.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >void</span><span class="hl-code"> </span><span class="hl-identifier">sig_usr</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">signo</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sig_usr : signo=%d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">signo</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">argc</span><span class="hl-code">, </span><span >char</span><span class="hl-code"> *</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">c</span><span class="hl-code">;
        </span><span class="hl-identifier">sigset_t</span><span class="hl-code"> </span><span class="hl-identifier">new_ss</span><span class="hl-code">, </span><span class="hl-identifier">old_ss</span><span class="hl-code">;
        </span><span >struct</span><span class="hl-code"> </span><span class="hl-identifier">sigaction</span><span class="hl-code"> </span><span class="hl-identifier">sa</span><span class="hl-code">;
 
        </span><span class="hl-identifier">memset</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">sa</span><span class="hl-code">, </span><span class="hl-number">0</span><span class="hl-code">, </span><span class="hl-reserved">sizeof</span><span class="hl-brackets">(</span><span class="hl-identifier">sa</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">sa</span><span class="hl-code">.</span><span class="hl-identifier">sa_handler</span><span class="hl-code"> = </span><span class="hl-identifier">sig_usr</span><span class="hl-code">;
        </span><span class="hl-identifier">sa</span><span class="hl-code">.</span><span class="hl-identifier">sa_flags</span><span class="hl-code"> = </span><span class="hl-identifier">SA_RESTART</span><span class="hl-code">;
        </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">-</span><span class="hl-number">1</span><span class="hl-code"> == </span><span class="hl-identifier">sigaction</span><span class="hl-brackets">(</span><span class="hl-identifier">SIGUSR1</span><span class="hl-code">, &amp;</span><span class="hl-identifier">sa</span><span class="hl-code">, </span><span >NULL</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
                </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sigaction</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">; </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code">
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">my pid = %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">getpid</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
 
        </span><span class="hl-identifier">sigemptyset</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">new_ss</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">sigaddset</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">new_ss</span><span class="hl-code">, </span><span class="hl-identifier">SIGUSR1</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">-</span><span class="hl-number">1</span><span class="hl-code"> == </span><span class="hl-identifier">sigprocmask</span><span class="hl-brackets">(</span><span class="hl-identifier">SIG_BLOCK</span><span class="hl-code">, &amp;</span><span class="hl-identifier">new_ss</span><span class="hl-code">, &amp;</span><span class="hl-identifier">old_ss</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
                </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sigprocmask</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">; </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code">
 
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">pause start...</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">pause</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">pause end.</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
 
        </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">-</span><span class="hl-number">1</span><span class="hl-code"> == </span><span class="hl-identifier">sigprocmask</span><span class="hl-brackets">(</span><span class="hl-identifier">SIG_SETMASK</span><span class="hl-code">, &amp;</span><span class="hl-identifier">old_ss</span><span class="hl-code">, </span><span >NULL</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
                </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sigprocmask</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">; </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code">
 
        </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
実行し、pause()中にSIGUSR1, SIGUSR2を順に送信してみる：
<br />
</p>
<pre class="plugin_pre">
$ make sig05
cc -O2   -o sig05 sig05.c
$ ./sig05
my pid = 863
pause start...
(別端末から kill -USR1 863)
(別端末から kill -USR2 863)
User defined signal 2
</pre>

<p class="paragraph">
SIGUSR2受信時点でデフォルトのシグナルハンドラが処理され、プロセスが終了したことが分かる。
<br />
</p>

<h4 id="idd831ae">sigsuspend()の復習</h4>

<p class="paragraph">
ブロックしたいsigset_tを渡すと一時的にシグナルマスクを切り替え、ブロック対象外のシグナルを受信するまで待機する。
<br />
シグナルマスクの切り替えと待機までをatomicに行ってくれる。
<br />
sig06.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">unistd.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">signal.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">errno.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >void</span><span class="hl-code"> </span><span class="hl-identifier">sig_usr</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">signo</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sig_usr : signo=%d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">signo</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">argc</span><span class="hl-code">, </span><span >char</span><span class="hl-code"> *</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">c</span><span class="hl-code">;
        </span><span class="hl-identifier">sigset_t</span><span class="hl-code"> </span><span class="hl-identifier">new_ss</span><span class="hl-code">, </span><span class="hl-identifier">old_ss</span><span class="hl-code">;
        </span><span >struct</span><span class="hl-code"> </span><span class="hl-identifier">sigaction</span><span class="hl-code"> </span><span class="hl-identifier">sa</span><span class="hl-code">;
 
        </span><span class="hl-identifier">memset</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">sa</span><span class="hl-code">, </span><span class="hl-number">0</span><span class="hl-code">, </span><span class="hl-reserved">sizeof</span><span class="hl-brackets">(</span><span class="hl-identifier">sa</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">sa</span><span class="hl-code">.</span><span class="hl-identifier">sa_handler</span><span class="hl-code"> = </span><span class="hl-identifier">sig_usr</span><span class="hl-code">;
        </span><span class="hl-identifier">sa</span><span class="hl-code">.</span><span class="hl-identifier">sa_flags</span><span class="hl-code"> = </span><span class="hl-identifier">SA_RESTART</span><span class="hl-code">;
        </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">-</span><span class="hl-number">1</span><span class="hl-code"> == </span><span class="hl-identifier">sigaction</span><span class="hl-brackets">(</span><span class="hl-identifier">SIGUSR1</span><span class="hl-code">, &amp;</span><span class="hl-identifier">sa</span><span class="hl-code">, </span><span >NULL</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
                </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sigaction</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">; </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code">
        </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">-</span><span class="hl-number">1</span><span class="hl-code"> == </span><span class="hl-identifier">sigaction</span><span class="hl-brackets">(</span><span class="hl-identifier">SIGUSR2</span><span class="hl-code">, &amp;</span><span class="hl-identifier">sa</span><span class="hl-code">, </span><span >NULL</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
                </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sigaction</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">; </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code">
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">my pid = %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">getpid</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
 
        </span><span class="hl-identifier">sigemptyset</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">new_ss</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">sigaddset</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">new_ss</span><span class="hl-code">, </span><span class="hl-identifier">SIGUSR1</span><span class="hl-brackets">)</span><span class="hl-code">;
 
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sigsuspend start...</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">sigsuspend</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">new_ss</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sigsuspend end.</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
 
        </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
実行し、SIGUSR1, SIGUSR2と順に送信してみる：
<br />
</p>
<pre class="plugin_pre">
$ make sig06
cc -O2   -o sig06 sig06.c
$ ./sig06
my pid = 882
sigsuspend start...
(別端末から kill -USR1 882)
(別端末から kill -USR2 882)
sig_usr : signo=31
sig_usr : signo=30
sigsuspend end.
$
</pre>
<p class="paragraph">
SIGUSR1を送信しても、一時的にblockされているので反応しない。SIGUSR2を送信するとシグナルハンドラが実行されsigsuspend()から復帰する。このとき自動的にSIGUSR1をblockしていたマスクも解除されるので、即座にSIGUSR1の分のシグナルハンドラが実行される。&quot;sigsuspend end.&quot;の表示は、その後に出力される。
<br />
</p>

<h5 id="idfb07c9">sigsuspend()の復習、ただしSIGUSR2のシグナルハンドラ未設定</h5>

<p class="paragraph">
sig06.cと同様だが、SIGUSR2のシグナルハンドラを未設定にしておく。
<br />
sig07.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">unistd.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">signal.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">errno.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >void</span><span class="hl-code"> </span><span class="hl-identifier">sig_usr</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">signo</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sig_usr : signo=%d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">signo</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">argc</span><span class="hl-code">, </span><span >char</span><span class="hl-code"> *</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">c</span><span class="hl-code">;
        </span><span class="hl-identifier">sigset_t</span><span class="hl-code"> </span><span class="hl-identifier">new_ss</span><span class="hl-code">, </span><span class="hl-identifier">old_ss</span><span class="hl-code">;
        </span><span >struct</span><span class="hl-code"> </span><span class="hl-identifier">sigaction</span><span class="hl-code"> </span><span class="hl-identifier">sa</span><span class="hl-code">;
 
        </span><span class="hl-identifier">memset</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">sa</span><span class="hl-code">, </span><span class="hl-number">0</span><span class="hl-code">, </span><span class="hl-reserved">sizeof</span><span class="hl-brackets">(</span><span class="hl-identifier">sa</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">sa</span><span class="hl-code">.</span><span class="hl-identifier">sa_handler</span><span class="hl-code"> = </span><span class="hl-identifier">sig_usr</span><span class="hl-code">;
        </span><span class="hl-identifier">sa</span><span class="hl-code">.</span><span class="hl-identifier">sa_flags</span><span class="hl-code"> = </span><span class="hl-identifier">SA_RESTART</span><span class="hl-code">;
        </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">-</span><span class="hl-number">1</span><span class="hl-code"> == </span><span class="hl-identifier">sigaction</span><span class="hl-brackets">(</span><span class="hl-identifier">SIGUSR1</span><span class="hl-code">, &amp;</span><span class="hl-identifier">sa</span><span class="hl-code">, </span><span >NULL</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
                </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sigaction</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">; </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code">
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">my pid = %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">getpid</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
 
        </span><span class="hl-identifier">sigemptyset</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">new_ss</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">sigaddset</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">new_ss</span><span class="hl-code">, </span><span class="hl-identifier">SIGUSR1</span><span class="hl-brackets">)</span><span class="hl-code">;
 
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sigsuspend start...</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">sigsuspend</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">new_ss</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sigsuspend end.</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
 
        </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
実行し、SIGUSR1, SIGUSR2と順に送信してみる：
<br />
</p>
<pre class="plugin_pre">
$ make sig07
cc -O2   -o sig07 sig07.c
$ ./sig07
my pid = 895
sigsuspend start...
(別端末から kill -USR1 895)
(別端末から kill -USR2 895)
User defined signal 2
$
</pre>

<p class="paragraph">
pause()のときと同じく、SIGUSR2のデフォルトハンドラに処理されたため、SIGUSR2受信によりプロセスが終了している。
<br />
</p>

<h5 id="id386061">sigfilset() -&gt; sigsuspend() : 無限wait</h5>

<p class="paragraph">
sigsuspend()に渡すsigset_tだが、全てのシグナルをセットするとどうなるだろうか？
<br />
全てのシグナルをblockするため、SIGTERMとSIGKILL以外は反応しない無限waitが予想される。
<br />
</p>

<p class="paragraph">
sig08.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">unistd.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">signal.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">errno.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >void</span><span class="hl-code"> </span><span class="hl-identifier">sig_usr</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">signo</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sig_usr : signo=%d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">signo</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">argc</span><span class="hl-code">, </span><span >char</span><span class="hl-code"> *</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">c</span><span class="hl-code">;
        </span><span class="hl-identifier">sigset_t</span><span class="hl-code"> </span><span class="hl-identifier">new_ss</span><span class="hl-code">, </span><span class="hl-identifier">old_ss</span><span class="hl-code">;
        </span><span >struct</span><span class="hl-code"> </span><span class="hl-identifier">sigaction</span><span class="hl-code"> </span><span class="hl-identifier">sa</span><span class="hl-code">;
 
 
        </span><span class="hl-identifier">memset</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">sa</span><span class="hl-code">, </span><span class="hl-number">0</span><span class="hl-code">, </span><span class="hl-reserved">sizeof</span><span class="hl-brackets">(</span><span class="hl-identifier">sa</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">sa</span><span class="hl-code">.</span><span class="hl-identifier">sa_handler</span><span class="hl-code"> = </span><span class="hl-identifier">sig_usr</span><span class="hl-code">;
        </span><span class="hl-identifier">sa</span><span class="hl-code">.</span><span class="hl-identifier">sa_flags</span><span class="hl-code"> = </span><span class="hl-identifier">SA_RESTART</span><span class="hl-code">;
        </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">-</span><span class="hl-number">1</span><span class="hl-code"> == </span><span class="hl-identifier">sigaction</span><span class="hl-brackets">(</span><span class="hl-identifier">SIGUSR1</span><span class="hl-code">, &amp;</span><span class="hl-identifier">sa</span><span class="hl-code">, </span><span >NULL</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
                </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sigaction</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">; </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code">
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">my pid = %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">getpid</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
 
        </span><span class="hl-identifier">sigfillset</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">new_ss</span><span class="hl-brackets">)</span><span class="hl-code">;
 
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sigsuspend start...</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">sigsuspend</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">new_ss</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sigsuspend end.</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
 
        </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
実行し、いくつか送信してみる：
<br />
</p>
<pre class="plugin_pre">
$ make sig08
cc -O2   -o sig08 sig08.c
$ ./sig08
my pid = 908
sigsuspend start...
(別端末から kill -USR1 -&gt; 無反応)
(別端末から kill -USR2 -&gt; 無反応)
(別端末から kill -INT -&gt; 無反応)
(別端末から kill -HUP -&gt; 無反応)
(別端末から kill -KILL)
Killed
$
</pre>
<p class="paragraph">
SIGINT, SIGHUP, SIGQUIT, SIGTERM, SIGCONT, SIGALRM, SIGABRT, SIGBUS, SIGSEGV などが無反応。
<br />
SIGSTOPを送るとバックグランドジョブに切り替わる。
<br />
SIGTERMすら無反応なので、終了にはSIGKILLを送信する。
<br />
</p>

<h5 id="id6187fb">sigemptyset() -&gt; sigsuspend() : とにかく何でも良いのでシグナル受信で待機解除</h5>

<p class="paragraph">
sigsuspend()に渡すsigset_tだが、空のsigset_tを渡すと、全シグナルでblock解除となる。
<br />
何でもよいのでシグナルを受信したら待機解除したい場合に有効だろう。
<br />
sig09.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">unistd.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">signal.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">errno.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >void</span><span class="hl-code"> </span><span class="hl-identifier">sig_usr</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">signo</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sig_usr : signo=%d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">signo</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">argc</span><span class="hl-code">, </span><span >char</span><span class="hl-code"> *</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">c</span><span class="hl-code">;
        </span><span class="hl-identifier">sigset_t</span><span class="hl-code"> </span><span class="hl-identifier">new_ss</span><span class="hl-code">, </span><span class="hl-identifier">old_ss</span><span class="hl-code">;
        </span><span >struct</span><span class="hl-code"> </span><span class="hl-identifier">sigaction</span><span class="hl-code"> </span><span class="hl-identifier">sa</span><span class="hl-code">;
 
        </span><span class="hl-identifier">memset</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">sa</span><span class="hl-code">, </span><span class="hl-number">0</span><span class="hl-code">, </span><span class="hl-reserved">sizeof</span><span class="hl-brackets">(</span><span class="hl-identifier">sa</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">sa</span><span class="hl-code">.</span><span class="hl-identifier">sa_handler</span><span class="hl-code"> = </span><span class="hl-identifier">sig_usr</span><span class="hl-code">;
        </span><span class="hl-identifier">sa</span><span class="hl-code">.</span><span class="hl-identifier">sa_flags</span><span class="hl-code"> = </span><span class="hl-identifier">SA_RESTART</span><span class="hl-code">;
        </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">-</span><span class="hl-number">1</span><span class="hl-code"> == </span><span class="hl-identifier">sigaction</span><span class="hl-brackets">(</span><span class="hl-identifier">SIGUSR1</span><span class="hl-code">, &amp;</span><span class="hl-identifier">sa</span><span class="hl-code">, </span><span >NULL</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
                </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sigaction</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">; </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code">
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">my pid = %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">getpid</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
 
        </span><span class="hl-identifier">sigemptyset</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">new_ss</span><span class="hl-brackets">)</span><span class="hl-code">;
 
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sigsuspend start...</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">sigsuspend</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">new_ss</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sigsuspend end.</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
 
        </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
実行してみる : SIGUSR1でシグナルハンドラ実行後、待機解除となっている。
<br />
</p>
<pre class="plugin_pre">
$ make sig09
cc -O2   -o sig09 sig09.c
$ ./sig09
my pid = 929
sigsuspend start...
(別端末から kill -USR1 929)
sig_usr : signo=30
sigsuspend end.
$
</pre>

<h3 id="id740d32">pause(3)が問題となる場面とsigsuspend(2)による対処</h3>

<dl>
<dt> 異なる点 </dt>
<dd>
<ul><li> pause(3)はシグナルマスクを選べない。</li>
<li> sigsuspend(2)はシグナルマスクを選べる上に、シグナルマスクの変更・待機・復帰時にシグナルマスクを戻す、までをatomicに行ってくれる。</li></ul></dd>
<dt> pause(3)が問題となる場面 </dt>
<dd>
<p class="paragraph">
上で述べた異なる点と関連して、一時的にblockしたいシグナルを変更してシグナル受信を待機するときはpause(3)だと問題が発生する。
<br />
</p>
<pre>/* (1) */ sigprocmask(SIG_SETMASK, &amp;temp_block_sigset, &amp;old);
/* (2) */ pause();
/* (3) */ sigprocmask(SIG_SETMASK, &amp;old, NULL);
</pre>

<p class="paragraph">
このようにシグナルマスクの変更(1)と待機(2)が分離してしまうため、(1)と(2)の間に、不測のシグナルを受信しシグナルハンドラが実行される可能性がある。もしそのシグナルが、pause()が期待しているものだとすれば、pause()で待機する前にシグナルハンドラを実行し終えてしまうため、本来望んでいたタイミングから外れてしまう。もしも一度しか受信されないものだとすれば、二度と来ないシグナルをpause()で無限に待機してしまう可能性がある。
<br />
</p></dd>
<dt> sigsuspend(2)による対処 </dt>
<dd>
<p class="paragraph">
上記pause(3)の問題を解消するのがsigsuspend(2)となり、内部的にatomic処理される。
<br />
</p>
<pre>sigsuspend(&amp;temp_block_sigset);
</pre>

<p class="paragraph">
よって上記pause(3)のようなタイミングずれに伴う問題を回避できる。
<br />
</p></dd>
</dl>

<h4 id="idcb098e">実例 : 親子プロセスでfork()直後に同期をとる例</h4>

<p class="paragraph">
&quot;Advanced UNIX Programming 2nd Ed&quot;, &quot;9.2.3 sigsuspend System Call&quot;を元ネタとして、やや噛み砕いてみていく。
<br />
</p>

<p class="paragraph">
ex01:
<br />
</p>
<pre class="plugin_pre">
void foo(void)
{
  if (0 == fork()) {
    printf(&quot;child\n&quot;);
    exit(EXIT_SUCCESS);
  }
  printf(&quot;parent\n&quot;);
  return;
}
</pre>
<p class="paragraph">
ここで確実に
<br />
</p>
<pre>parent
child
</pre>
<p class="paragraph">
の順に表示されるようにしたい。つまり、子プロセスは親プロセスの準備が整うまで待機したい。
<br />
</p>

<p class="paragraph">
（以降、変数宣言や初期化、エラー処理などを大幅に省略した、擬似コードに近いソースコードで解説を続けます）
<br />
</p>

<p class="paragraph">
シグナルを使うパターンだと、一番単純なのが子プロセスがpause()で待機、親プロセスが無害なシグナルを送信して子プロセスの待機を解除する方式が考えられる。
<br />
</p>

<p class="paragraph">
ex02:
<br />
</p>
<pre class="plugin_pre">
/* とりあえず中身は空っぽでよい */
void sighandler(int signo) {}

void foo(void)
{
  pid_t pid;
  if (0 == (pid = fork())) {        /* (1) */
    struct sigaction sa;
    sa.sa_handler = sighandler;
    sigaction(SIGUSR1, &amp;sa, NULL);  /* (2) */
    pause();                        /* (3) */
    printf(&quot;child\n&quot;);
    exit(EXIT_SUCCESS);
  }
  printf(&quot;parent\n&quot;);
  kill(pid, SIGUSR1);
  return;
}
</pre>

<p class="paragraph">
しかし、&quot;(1) - (2)&quot;の間 or &quot;(2) - (3)&quot;の間、つまり子プロセスがpause()を呼ぶ前に親プロセスがSIGUSR1を送信する可能性があり、その場合は期待した動作にならない。
<br />
</p>

<p class="paragraph">
まずは&quot;(2) - (3)&quot;間でSIGUSR1が送信された場合にそなえ、グローバルなフラグ変数を導入する。
<br />
ex03:
<br />
</p>
<pre class="plugin_pre">
volatile sig_atomic_t got_sig;
void sighandler(int signo) { got_sig = 1; }

void foo(void)
{
  pid_t pid;
  got_sig = 0;
  if (0 == (pid = fork())) {        /* (1) */
    struct sigaction sa;
    sa.sa_handler = sighandler;
    sigaction(SIGUSR1, &amp;sa, NULL);  /* (2) */
    while (!got_sig) {
      pause();                      /* (3) */
    }
    printf(&quot;child\n&quot;);
    exit(EXIT_SUCCESS);
  }
  printf(&quot;parent\n&quot;);
  kill(pid, SIGUSR1);
  return;
}
</pre>

<p class="paragraph">
これにより、&quot;(2) - (3)&quot;間でSIGUSR1を受信した場合はpause()せずに&quot;child&quot;を出力する。なぜならSIGUSR1を受信したということはparent側が準備完了したことを意味するからだ。
<br />
</p>

<p class="paragraph">
しかしまだ &quot;(1) - (2)&quot; 間でSIGUSR1を受信してしまう可能性は残っている。そこで、子プロセスにfork()した直後にSIGUSR1をsigprocmask()でblockし、pause()の直前でSIGUSR1のblockを解除してみる。
<br />
ex04:
<br />
</p>
<pre class="plugin_pre">
volatile sig_atomic_t got_sig;
void sighandler(int signo) { got_sig = 1; }

void foo(void)
{
  pid_t pid;
  got_sig = 0;
  if (0 == (pid = fork())) {        /* (1) */

    sigset_t newss, oldss;
    sigemptyset(&amp;newss);
    sigaddset(&amp;newss, SIGUSR1);
    sigprocmask(SIG_BLOCK, &amp;newss, &amp;oldss);  /* (2) */

    struct sigaction sa;
    sa.sa_handler = sighandler;
    sigaction(SIGUSR1, &amp;sa, NULL);  /* (3) */

    sigprocmask(SIG_SETMASK, &amp;oldss, NULL);  /* (4) */
    while (!got_sig) {
      pause();                      /* (5) */
    }
    printf(&quot;child\n&quot;);
    exit(EXIT_SUCCESS);
  }
  printf(&quot;parent\n&quot;);
  kill(pid, SIGUSR1);
  return;
}
</pre>
<p class="paragraph">
しかしこれもまだ十分ではない。&quot;(1)-(2)&quot;の間に親プロセスがSIGUSR1を送信してしまう可能性がある。
<br />
つまり子プロセスがfork()した時点で、すでにSIGUSR1がblockされている必要がある。
<br />
</p>

<p class="paragraph">
ここで、fork()時にはシグナルマスクがコピーされる仕様を利用し、fork()する前にSIGUSR1をblockしてしまう。
<br />
ex05:
<br />
</p>
<pre class="plugin_pre">
volatile sig_atomic_t got_sig;
void sighandler(int signo) { got_sig = 1; }

void foo(void)
{
  pid_t pid;
  got_sig = 0;
  sigset_t newss, oldss;
  sigemptyset(&amp;newss);
  sigaddset(&amp;newss, SIGUSR1);
  sigprocmask(SIG_BLOCK, &amp;newss, &amp;oldss);

  if (0 == (pid = fork())) {        /* (1) */
    struct sigaction sa;
    sa.sa_handler = sighandler;
    sigaction(SIGUSR1, &amp;sa, NULL);  /* (2) */
    sigprocmask(SIG_SETMASK, &amp;oldss, NULL);  /* (3) */
    while (!got_sig) {
      pause();                      /* (4) */
    }
    printf(&quot;child\n&quot;);
    exit(EXIT_SUCCESS);
  }
  printf(&quot;parent\n&quot;);
  kill(pid, SIGUSR1);
  return;
}
</pre>

<p class="paragraph">
しかしまだ &quot;(3) - (4)&quot; の間でSIGUSR1が送信される可能性がある。&quot;(3)&quot;が無ければこの「隙間」も消えるが、SIGUSR1はblockされたままなのでSIGUSR1受信によるpause()解除も行えなくなってしまう。
<br />
</p>

<p class="paragraph">
<strong>「一時的にblockするシグナルマスクを変更→シグナル受信待機」をatomicに行いたい、つまりsigsuspend(2)の出番となる。</strong>
<br />
</p>

<p class="paragraph">
ex06:
<br />
</p>
<pre class="plugin_pre">
volatile sig_atomic_t got_sig;
void sighandler(int signo) { got_sig = 1; }

void foo(void)
{
  pid_t pid;
  got_sig = 0;
  sigset_t newss, oldss;
  sigemptyset(&amp;newss);
  sigaddset(&amp;newss, SIGUSR1);
  sigprocmask(SIG_BLOCK, &amp;newss, &amp;oldss);

  if (0 == (pid = fork())) {        /* (1) */
    struct sigaction sa;
    sa.sa_handler = sighandler;
    sigaction(SIGUSR1, &amp;sa, NULL);  /* (2) */
    sigsuspend(&amp;oldss);
    printf(&quot;child\n&quot;);
    exit(EXIT_SUCCESS);
  }
  printf(&quot;parent\n&quot;);
  kill(pid, SIGUSR1);
  return;
}
</pre>

<p class="paragraph">
以上がpause(3)が不適切で、sigsuspend(2)により対処可能な実例である。
<br />
</p>

<h3 id="id758f90">sigwait(3) (pthread_signal(3)) の利用</h3>

<p class="paragraph">
Real Time Signal と Thread がサポートされている場合、より簡単に使えるsigwait(3)が利用できるかもしれない。
<br />
</p>

<pre>int sigwait(const sigset_t *restrict set, int *restrict sig);
</pre>
<p class="paragraph">
受信したいシグナルをsetに設定する。シグナルマスクの変更と受信待機をatomicに処理してくれる。
<br />
アプリケーション側でシグナルハンドラを設定していないシグナルについても対応しているのが嬉しい。
<br />
</p>

<p class="paragraph">
（なおsigwait(3)は「デーモン君のソース探検」で使っているNetBSD 1.6では未対応。以降のサンプルはCentOS 5.x上で確認している。）
<br />
</p>

<p class="paragraph">
もし対象シグナルがblockされていて、sigwait()呼び出し前にすでに受信されてpending状態になっていれば、sigwait()は待機せずに呼び出し元に戻り、シグナル番号をsig引数にセットする。
<br />
もし対象シグナルがblockされていて、sigwait()呼び出し前にまだ受信されていなければ、sigwait()は受信するまで待機する。受信後、sigwait()はシグナルハンドラに配送される前にシグナルをクリアしてしまう点に注意が必要。
<br />
</p>

<p class="paragraph">
sigwait()呼び出し前に対象シグナルがblockされていない、シグナルマスクに設定されていない場合、アプリケーションがシグナルハンドラを登録していなければデフォルトのシグナルハンドラが実行され、登録していればsigwait()から戻るが、sigwait()がシグナルをクリアしてしまうのでアプリケーションが登録したシグナルハンドラは実行されない。ただしこれはCentOS5.xで実験した結果に基づいており、<strong>AUPやAPUEでは事前のシグナルマスクによるblock無しでのsigwait()は推奨されていない。</strong>
<br />
</p>

<h4 id="id475423">事前block無しでsigwait(3)を使ってみる</h4>

<p class="paragraph">
sig10.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">string.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">unistd.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">signal.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">errno.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >void</span><span class="hl-code"> </span><span class="hl-identifier">sig_usr</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">signo</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sig_usr: signo = %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">signo</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">argc</span><span class="hl-code">, </span><span >char</span><span class="hl-code"> *</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">signum</span><span class="hl-code">;
    </span><span class="hl-identifier">sigset_t</span><span class="hl-code"> </span><span class="hl-identifier">target_ss</span><span class="hl-code">;
    </span><span >struct</span><span class="hl-code"> </span><span class="hl-identifier">sigaction</span><span class="hl-code"> </span><span class="hl-identifier">sa</span><span class="hl-code">;
 
    </span><span class="hl-identifier">memset</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">sa</span><span class="hl-code">, </span><span class="hl-number">0</span><span class="hl-code">, </span><span class="hl-reserved">sizeof</span><span class="hl-brackets">(</span><span class="hl-identifier">sa</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">sa</span><span class="hl-code">.</span><span class="hl-identifier">sa_handler</span><span class="hl-code"> = </span><span class="hl-identifier">sig_usr</span><span class="hl-code">;
    </span><span class="hl-identifier">sa</span><span class="hl-code">.</span><span class="hl-identifier">sa_flags</span><span class="hl-code"> = </span><span class="hl-identifier">SA_RESTART</span><span class="hl-code">;
    </span><span class="hl-identifier">sigaction</span><span class="hl-brackets">(</span><span class="hl-identifier">SIGUSR1</span><span class="hl-code">, &amp;</span><span class="hl-identifier">sa</span><span class="hl-code">, </span><span >NULL</span><span class="hl-brackets">)</span><span class="hl-code">;
 
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">my pid = %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">getpid</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
 
    </span><span class="hl-identifier">sigemptyset</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">target_ss</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">sigaddset</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">target_ss</span><span class="hl-code">, </span><span class="hl-identifier">SIGUSR1</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">sigaddset</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">target_ss</span><span class="hl-code">, </span><span class="hl-identifier">SIGUSR2</span><span class="hl-brackets">)</span><span class="hl-code">;
 
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sigwait start...</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">sigwait</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">target_ss</span><span class="hl-code">, &amp;</span><span class="hl-identifier">signum</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sigwait end, signum = %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">signum</span><span class="hl-brackets">)</span><span class="hl-code">;
 
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
コンパイル・実行し、アプリケーション側でシグナルハンドラをインストールしているSIGUSR1を別端末から送信してみる：
<br />
</p>
<pre class="plugin_pre">
$ make sig10
$ ./sig10
my pid = 3991
sigwait start...
(別端末から kill -USR1)
sigwait end, signum = 10
$
</pre>
<p class="paragraph">
sigwait()から戻ってきているが、シグナルハンドラは実行されていない。
<br />
</p>

<p class="paragraph">
続いて、アプリケーション側でシグナルハンドラをインストールしていないSIGUSR2を別端末から送信してみる：
<br />
</p>
<pre class="plugin_pre">
$ ./sig10
my pid = 3992
sigwait start...
(別端末から kill -USR2)
ユーザ定義シグナル 2
$
</pre>
<p class="paragraph">
システムのデフォルト挙動となり、sigwait()から戻ったのか戻っていないのか不明なままプロセスが終了した。
<br />
</p>

<h4 id="iddc371b">事前block後にsigwait(3)を使ってみる</h4>

<p class="paragraph">
SIGUSR1, SIGUSR2 をblockした後、sigwait()を呼んでみる。SIGUSR1にはアプリケーション側でシグナルハンドラをインストールしておく。
<br />
</p>

<p class="paragraph">
sig11.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">string.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">unistd.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">signal.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">errno.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >void</span><span class="hl-code"> </span><span class="hl-identifier">sig_usr</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">signo</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sig_usr: signo = %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">signo</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">argc</span><span class="hl-code">, </span><span >char</span><span class="hl-code"> *</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">signum</span><span class="hl-code">;
    </span><span class="hl-identifier">sigset_t</span><span class="hl-code"> </span><span class="hl-identifier">target_ss</span><span class="hl-code">, </span><span class="hl-identifier">old_ss</span><span class="hl-code">;
    </span><span >struct</span><span class="hl-code"> </span><span class="hl-identifier">sigaction</span><span class="hl-code"> </span><span class="hl-identifier">sa</span><span class="hl-code">;
 
    </span><span class="hl-identifier">memset</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">sa</span><span class="hl-code">, </span><span class="hl-number">0</span><span class="hl-code">, </span><span class="hl-reserved">sizeof</span><span class="hl-brackets">(</span><span class="hl-identifier">sa</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">sa</span><span class="hl-code">.</span><span class="hl-identifier">sa_handler</span><span class="hl-code"> = </span><span class="hl-identifier">sig_usr</span><span class="hl-code">;
    </span><span class="hl-identifier">sa</span><span class="hl-code">.</span><span class="hl-identifier">sa_flags</span><span class="hl-code"> = </span><span class="hl-identifier">SA_RESTART</span><span class="hl-code">;
    </span><span class="hl-identifier">sigaction</span><span class="hl-brackets">(</span><span class="hl-identifier">SIGUSR1</span><span class="hl-code">, &amp;</span><span class="hl-identifier">sa</span><span class="hl-code">, </span><span >NULL</span><span class="hl-brackets">)</span><span class="hl-code">;
 
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">my pid = %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">getpid</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
 
    </span><span class="hl-identifier">sigemptyset</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">target_ss</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">sigaddset</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">target_ss</span><span class="hl-code">, </span><span class="hl-identifier">SIGUSR1</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">sigaddset</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">target_ss</span><span class="hl-code">, </span><span class="hl-identifier">SIGUSR2</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">sigprocmask</span><span class="hl-brackets">(</span><span class="hl-identifier">SIG_BLOCK</span><span class="hl-code">, &amp;</span><span class="hl-identifier">target_ss</span><span class="hl-code">, &amp;</span><span class="hl-identifier">old_ss</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">SIGUSR1, SIGUSR2 blocking, hit return then sigwait start:</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">getchar</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
 
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sigwait start...</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">sigwait</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">target_ss</span><span class="hl-code">, &amp;</span><span class="hl-identifier">signum</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">sigwait end, signum = %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">signum</span><span class="hl-brackets">)</span><span class="hl-code">;
 
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">hit return then unblock SIGUSR1, SIGUSR2:</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">getchar</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
 
    </span><span class="hl-identifier">sigprocmask</span><span class="hl-brackets">(</span><span class="hl-identifier">SIG_SETMASK</span><span class="hl-code">, &amp;</span><span class="hl-identifier">old_ss</span><span class="hl-code">, </span><span >NULL</span><span class="hl-brackets">)</span><span class="hl-code">;
 
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">end.</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
コンパイル・実行してみる。まずはsigwait()を呼ぶ前にSIGUSR1を送信しておく。
<br />
</p>
<pre class="plugin_pre">
$ make sig11
$ ./sig11
my pid = 4615
SIGUSR1, SIGUSR2 blocking, hit return then sigwait start:
(別端末から kill -USR1) (RETURN)
sigwait start...
sigwait end, signum = 10
hit return then unblock SIGUSR1, SIGUSR2:
end.
$
</pre>
<p class="paragraph">
既にpending状態になっていたため、sigwait()は待機せず戻る。sigwait()によりクリアされたのでSIGUSR1はシグナルハンドラに配送されていない。
<br />
</p>

<p class="paragraph">
sigwait()の後にSIGUSR1を送信してみる。
<br />
</p>
<pre class="plugin_pre">
$ ./sig11
my pid = 4681
SIGUSR1, SIGUSR2 blocking, hit return then sigwait start:
sigwait start...
(待機に入る)
(別端末から kill -USR1)
sigwait end, signum = 10
hit return then unblock SIGUSR1, SIGUSR2:
end.
$
</pre>
<p class="paragraph">
待機に入った後、別端末からSIGUSR1を送信するとsigwait()より戻り、シグナルハンドラは実行されず処理続行となっている。
<br />
</p>

<p class="paragraph">
アプリケーション側でシグナルハンドラを未設定の、SIGUSR2をsigwait()実行前に送信してみる。
<br />
</p>
<pre class="plugin_pre">
$ ./sig11
my pid = 4708
SIGUSR1, SIGUSR2 blocking, hit return then sigwait start:
(別端末から kill -USR2) (RETURN)
sigwait start...
sigwait end, signum = 12
hit return then unblock SIGUSR1, SIGUSR2:
end.
$
</pre>
<p class="paragraph">
SIGUSR1のときと同様である。
<br />
</p>

<p class="paragraph">
結果は省略するが、sigwait()呼出し後にSIGUSR2を送信した場合もSIGUSR1と同様である。
<br />
</p>

<h4 id="id31a564">実例 : 親子プロセスでfork()直後に同期をとる例でsigwait()を使ってみる</h4>

<p class="paragraph">
sigwait()を使うことで、アプリケーション側でのシグナルハンドラのインストールが不要となる。
<br />
</p>

<p class="paragraph">
ex07:
<br />
</p>
<pre class="plugin_pre">
void foo(void)
{
  pid_t pid;
  sigset_t newss, oldss;
  sigemptyset(&amp;newss);
  sigaddset(&amp;newss, SIGUSR1);
  sigprocmask(SIG_BLOCK, &amp;newss, &amp;oldss);

  if (0 == (pid = fork())) {
    int signo;
    sigwait(&amp;newss, &amp;signo);
    printf(&quot;child\n&quot;);
    exit(EXIT_SUCCESS);
  }
  printf(&quot;parent\n&quot;);
  kill(pid, SIGUSR1);
  return;
}
</pre>

<h3 id="idfd0d2e">まとめ</h3>

<p class="paragraph">
以上でpause(3)関数を使う上での問題点と、sigsuspend(2)による対処法が判明した。
<br />
</p>
<ol><li> どちらもシグナルを受信するまで待機する機能がある。</li>
<li> pause(3)関数は待機解除となるシグナルを選択できない(現在のシグナルマスクに依存)が、sigsuspend(2)は選択できる。</li>
<li> sigsuspend(2)はシグナルマスクの変更・待機・復帰時のシグナルマスクの復元をatomicに実行できる。</li>
<li> 一時的にシグナルマスクを変更して待機したい場合、pause(3)関数ではsigprocmask(2)と組み合わせる必要があり、どうしてもタイミングの問題(&quot;window of time&quot;)が発生する。<ol><li> その場合は、atomicに処理してくれるsigsuspend(2)を使うとよい。</li></ol></li>
<li> RealTimeSingalとThreadがサポートされているならば、sigwait(3)を使ってもよい。</li></ol>

<p class="paragraph">
今回のお題については、ここまで。
<br />
</p>

<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-847.html" title="C言語系/「デーモン君のソース探検」読書メモ/A07, nohup(1)">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-849.html" title="C言語系/「デーモン君のソース探検」読書メモ/A09, write(2) + O_APPEND">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-546.html" title="C言語系/「デーモン君のソース探検」読書メモ">Up</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-478.html" title="C言語系">C言語系</a>&nbsp;]</li>
</ul>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/848<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2007 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>