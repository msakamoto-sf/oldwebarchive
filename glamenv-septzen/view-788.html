<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Assembler/ForFun(x86_32)/06, 32bit Windows with NASM - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">Assembler/ForFun(x86_32)/06, 32bit Windows with NASM</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2010-09-19 14:52:01 &nbsp; / &nbsp; last updated at: 2010-09-19 20:58:42<br>
カテゴリ: <a href="category-48.html">Assembler</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-787.html" title="Assembler/ForFun(x86_32)/05, 16bit BIOS with GNU as">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-789.html" title="Assembler/ForFun(x86_32)/07, 32bit Linux with GNU as">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-410.html" title="Assembler">Assembler</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
これまでDOSやBIOS上でのアセンブラプログラミングを体験してきました。
<br />
本記事ではWindows上での32bitアセンブラプログラミングを体験してみます。
<br />
</p>

<p class="paragraph">
アセンブラはNASMを使い、リンカはVisualC++2008 Express Edition SP1のlink.exeを使います。
<br />
</p>


<ul><li><a href="#id87cb6d">&quot;Hello, World!&quot; printf()版</a></li>
<li><a href="#ida76fc6">&quot;Hello, World!&quot; Win32 API - MessageBox()版</a></li>
<li><a href="#id25f93a">CRTを使わない &quot;Hello, World!&quot;</a><ul><li><a href="#idff85a8">&quot;Hello, World!&quot; console without CRT</a></li>
<li><a href="#id33763f">&quot;Hello, World!&quot; win32-gui without CRT</a></li></ul></li>
<li><a href="#ide05eb6">まとめ</a></li></ul>
<hr />
<h3 id="id87cb6d">&quot;Hello, World!&quot; printf()版</h3>

<p class="paragraph">
まずはC言語での定番、printf(&quot;Hello, World!&quot;) をアセンブラで書いてみましょう。
<br />
main(), printf()ともに呼び出し規約はcdeclなので、アセンブラレベルでは&quot;_&quot;を頭につけて、CRTライブラリとのリンク時に名前解決出来るようにしておきます。また &quot;_main&quot;はCRTライブラリ側からリンクされる為&quot;global&quot;を指定して公開します。&quot;_printf&quot;については本体がCRTライブラリにあるため、&quot;extern&quot;を指定して他のモジュールからインポートするシンボルであることを明示します。
<br />
</p>

<p class="paragraph">
参考：<a href="./view-617.html" >C言語系/呼び出し規約/x86/cdecl</a>
<br />
</p>

<p class="paragraph">
hello1.asm:
<br />
</p>
<pre class="plugin_pre">
global _main
extern _printf

section .text
_main:
    PUSH EBP
    MOV EBP, ESP

    PUSH msg
    CALL _printf

    MOV EAX, 2

    MOV ESP, EBP
    POP EBP
    RET

section .data

msg:
    db `Win32\r\nWorld!`, 0
</pre>

<p class="paragraph">
コンパイル：
<br />
</p>
<pre>&gt; nasm -fwin32 hello1.asm
</pre>
<p class="paragraph">
ここで注意ですが、出力フォーマット&quot;-f&quot;オプションには&quot;win32&quot;を指定します。歴史的な理由で、&quot;obj&quot;を指定するとOMF(Borlandコンパイラなどが使うオブジェクトファイル形式で、COFFとは異なる)、また&quot;coff&quot;を指定するとDJGPPというDOS用に移植したgcc向けのフォーマットで出力されてしまいます。
<br />
紛らわしいですが、Visual C++ のリンカで扱えるCOFF形式で出力するには、&quot;-fwin32&quot;を指定します。
<br />
</p>

<p class="paragraph">
これでhello1.objが生成されます。リンクして実行してみます。&quot;_main&quot;があるので自動的にコンソールアプリケーションとしてリンクされます。msvcrt.libを明示的に指定します。
<br />
</p>
<pre>&gt; link /OUT:hello1.exe hello1.obj msvcrt.lib
&gt; hello1.exe
Win32
World!
&gt; echo %ERRORLEVEL%
2
</pre>

<p class="paragraph">
&quot;_main&quot;の戻り値(EAX)は、コマンドプロンプト上では&quot;%ERRORLEVEL%&quot;環境変数として取得出来ます。
<br />
</p>

<p class="paragraph">
なおリンクではマルチスレッド対応のDLLリンク形式である&quot;msvcrt.lib&quot;を使っています。静的リンクやデバッグバージョンを使う場合は他のCRTライブラリを指定します。VC++が提供しているCRTライブラリについては下記MSDNを参照して下さい。
<br />
</p>

<ul><li> &quot;MSDN Library&quot; &gt; &quot;Development Tools and Languages&quot; &gt; &quot;Visual Studio 2010&quot; &gt; &quot;Visual Studio&quot; &gt; &quot;Visual Studio Languages&quot; &gt; &quot;Visual C++&quot; &gt; &quot;Visual C++ Reference&quot; &gt; &quot;Visual C++ Libraries Reference&quot; &gt; &quot;Run-Time Library&quot; &gt; &quot;C Run-Time Libraries&quot;<ul><li> <a class="externallink" href="http://msdn.microsoft.com/en-us/library/abx4dbyh.aspx" target="_blank">http://msdn.microsoft.com/en-us/library/abx4dbyh.aspx</a></li></ul></li></ul>

<h3 id="ida76fc6">&quot;Hello, World!&quot; Win32 API - MessageBox()版</h3>

<p class="paragraph">
今度はGUIアプリケーションとして Win32API の MessageBox() 関数で&quot;Hello, World!&quot;を表示してみます。
<br />
MessageBox()にもASCII版のMessageBoxA()とUnicode版のMessageBoxW()がありますが、今回はASCII版を使います。
<br />
呼び出し規約はWINAPI、つまりstdcall呼び出し規約を使います。( <a href="./view-616.html" >C言語系/呼び出し規約/x86/stdcall</a> )
<br />
WinMain()やMessageBoxA()のシンボル名は、アセンブラ中では&quot;_&quot;を接頭辞とし、&quot;@&quot; + スタック上に積まれた引数のバイト数 を接尾辞とします。WinMain()もMessageBoxA()も4バイトの引数を4つ取りますので、&quot;@16&quot;を後ろにつけます。
<br />
</p>

<p class="paragraph">
hello2.asm:
<br />
</p>
<pre class="plugin_pre">
global _WinMain@16
extern _MessageBoxA@16

section .text
_WinMain@16:
    PUSH EBP
    MOV EBP, ESP

    PUSH 0
    PUSH caption
    PUSH msg
    PUSH 0
    CALL _MessageBoxA@16

    MOV EAX, 2

    MOV ESP, EBP
    POP EBP
    RET 16

section .data

caption:
    db &quot;Hello, &quot;, 0

msg:
    db `Win32\r\nWorld!`, 0
</pre>

<p class="paragraph">
コンパイル：
<br />
</p>
<pre>&gt; nasm -fwin32 hello2.asm
</pre>

<p class="paragraph">
リンク：
<br />
</p>
<pre>&gt; link /OUT:hello2.exe hello2.obj user32.lib msvcrt.lib
</pre>

<p class="paragraph">
実行するとメッセージボックスが表示され、OKボタンで終了します。
<br />
なお、Win32GUIアプリケーションの場合に&quot;ERRORLEVEL&quot;で終了コードを取り出すには一工夫必要です。
<br />
というのは、単純にコマンドプロンプトからGUIアプリケーションを起動すると、コマンドプロンプト側はGUIアプリケーションの終了を待ちません。コマンドプロンプトでは続けて別のアプリケーションやコマンドを実行出来るようになっており、GUIアプリケーションの戻り値を受け取れません。
<br />
これを回避するには、コマンドプロンプトのstartコマンド + &quot;/wait&quot;オプション付きでGUIアプリケーションを実行します。起動されたGUIアプリケーションの終了を待ち、&quot;ERRORLEVEL&quot;で終了コードを取得することが出来ます。
<br />
</p>
<pre>&gt; start /wait hello2.exe
(メッセージボックスのOKボタンをクリックするまで、コマンドプロンプトに戻らない)
&gt; echo %ERRORLEVEL%
2
</pre>

<p class="paragraph">
ERRORLEVELの詳細とGUIアプリでの取得方法については、下記リンクなどを参考にして下さい。
<br />
</p>
<ul><li> How do I get the application exit code from a Windows command line? - Stack Overflow<ul><li> <a class="externallink" href="http://stackoverflow.com/questions/334879/how-do-i-get-the-application-exit-code-from-a-windows-command-line" target="_blank">http://stackoverflow.com/questions/334879/how-do-i-get-the-application-exit-code-from-a-windows-command-line</a><ul><li> ERRORLEVEL環境変数が紹介されています。</li></ul></li></ul></li>
<li> Setting the MS-DOS Errorlevel in a Program<ul><li> <a class="externallink" href="http://support.microsoft.com/kb/57658" target="_blank">http://support.microsoft.com/kb/57658</a><ul><li> 元々はMS-DOS時代に INT 21h, AH=4Ch で戻り値を指定していたことが書かれています。</li></ul></li></ul></li>
<li> ERRORLEVEL is not %ERRORLEVEL%<ul><li> <a class="externallink" href="http://blogs.msdn.com/b/oldnewthing/archive/2008/09/26/8965755.aspx" target="_blank">http://blogs.msdn.com/b/oldnewthing/archive/2008/09/26/8965755.aspx</a><ul><li> ERRORLEVELと環境変数としての%ERRORLEVEL%の違いが書かれています。</li></ul></li></ul></li>
<li> why doesn&#039;t winmain set the errorlevel? - Stack Overflow<ul><li> <a class="externallink" href="http://stackoverflow.com/questions/592075/why-doesnt-winmain-set-the-errorlevel" target="_blank">http://stackoverflow.com/questions/592075/why-doesnt-winmain-set-the-errorlevel</a><ul><li> WinMain()を使ったGUIアプリケーションの場合のERRORLEVELの取得について書かれています。</li></ul></li></ul></li></ul>

<h3 id="id25f93a">CRTを使わない &quot;Hello, World!&quot;</h3>

<p class="paragraph">
これまでのサンプルではいずれもVisual C++が提供するCRT(C RunTime library)である&quot;msvcrt.lib&quot;をリンクしてきました。今度はCRTを使わないWin32アセンブラプログラミングを体験してみましょう。
<br />
</p>

<p class="paragraph">
CRTを使わない場合、エントリポイントとなる関数を自分で用意する必要があります。通常のWinMain(), main()などはCRTが提供する真のエントリポイントが呼ばれた後、CRTが必要とする様々な前処理やC++ならグローバルオブジェクトのコンストラクタ処理などが呼ばれた後に実行されます。CRTを使わない場合、そうした処理も自前で実装する必要があります。本記事の場合は、サンプルとして極めて単純な処理しか行わないので、そうした下準備は不要となり、すぐにメイン処理に進むことが出来ます。
<br />
</p>

<p class="paragraph">
CRTを使う場合、エントリポイントのアドレスはリンカが自動的に決定してくれます。main()関数が定義してあればコンソールアプリケーションとしてリンクし、CRT中のmainCRTStartup()をエントリポイントに設定します。WinMain()関数が定義してあればGUIアプリケーションとしてリンクし、CRT中のWinMainCRTStartup()をエントリポイントに設定します。
<br />
CRTを使わない場合、自分で用意したエントリポイントを &quot;/ENTRY&quot; リンカオプションで指定します。また、コンソール/GUIアプリケーションの区別も、&quot;/SUBSYSTEM&quot; リンカオプションで指定します。コンソールアプリケーションの場合のエントリポイントはcdel規約、GUIアプリケーションの場合のエントリポイントはstdcall規約にします。
<br />
</p>

<p class="paragraph">
CRT中のエントリポイントと &quot;/ENTRY&quot; リンカオプションの詳細は下記MSDNを参照して下さい。
<br />
</p>
<ul><li> &quot;MSDN Library&quot; &gt; &quot;Development Tools and Languages&quot; &gt; &quot;Visual Studio .NET&quot; &gt; &quot;Visual C++&quot; &gt; &quot;Building a C/C++ Program&quot; &gt; &quot;C/C++ Building Reference&quot; &gt; &quot;Linking&quot; &gt; &quot;Linker Options&quot; &gt; &quot;/ENTRY (Entry-Point Symbol)&quot;<ul><li> <a class="externallink" href="http://msdn.microsoft.com/en-us/library/f9t8842e.aspx" target="_blank">http://msdn.microsoft.com/en-us/library/f9t8842e.aspx</a></li></ul></li></ul>

<h4 id="idff85a8">&quot;Hello, World!&quot; console without CRT</h4>

<p class="paragraph">
まずコンソール版をCRT無しにしてみます。CRTが無いとprintf()等が使えなくなりますので、Win32 APIだけでコンソールに出力してみます。
<br />
GetStdHandle(STD_OUTPUT_HANDLE)で標準出力のファイルハンドルを取得し、WriteFile()を使って文字列を書き込みます。両APIの詳細についてはMSDNを参照して下さい。
<br />
</p>

<p class="paragraph">
ソースコードは次のようになります。
<br />
hello3.asm:
<br />
</p>
<pre class="plugin_pre">
global _MyEntry
extern _GetStdHandle@4
extern _WriteFile@20

section .text
_MyEntry:
    PUSH EBP
    MOV EBP, ESP

    SUB ESP, 8
    ; スタック上に確保したローカル変数を見やすくする為のマクロ
    %define hFile EBP - 4
    %define lpNumberOfBytesWritten EBP - 8

    ; HANDLE hFile = GetStdHandle(STD_OUTPUT_HANDLE);
    PUSH -11  ; STD_OUTPUT_HANDLE
    CALL _GetStdHandle@4
    MOV [hFile], EAX

    ; WriteFile() arguments
    ; __inout_opt  LPOVERLAPPED lpOverlapped
    PUSH 0
    ; __out_opt LPDWORD lpNumberOfBytesWritten
    LEA EAX, [lpNumberOfBytesWritten]
    PUSH EAX
    ; __in DWORD nNumberOfBytesToWrite
    MOV EAX, [msg_len]
    PUSH EAX
    ; __in LPCVOID lpBuffer
    PUSH msg
    ; __in HANDLE hFile
    MOV EAX, [hFile]
    PUSH EAX
    CALL _WriteFile@20

    MOV ESP, EBP
    POP EBP
    RET

section .data

msg:
    db `Win32\r\nWorld!`, 0
msg_len:
    dd $ - msg
</pre>

<p class="paragraph">
コンパイル＋リンク＋実行：
<br />
</p>
<pre>&gt; nasm -fwin32 hello3.asm
&gt; link /OUT:hello3.exe /ENTRY:MyEntry /SUBSYSTEM:CONSOLE hello3.obj kernel32.lib
&gt; hello3
Win32
World!
&gt; echo %ERRORLEVEL%
1
</pre>
<p class="paragraph">
WriteFile()が成功を返したEAX = 1がそのままプロセスの戻り値になっていることが確認出来ます。
<br />
</p>

<h4 id="id33763f">&quot;Hello, World!&quot; win32-gui without CRT</h4>

<p class="paragraph">
続いてMessageBox()を使ったサンプルを、CRT無しに対応させてみます。
<br />
こちらは元々MessageBoxA()呼び出しだけなので、そのままWinMainをエントリポイントに指定出来ます。
<br />
</p>

<p class="paragraph">
hello2.asmそのままでは面白くないので、&quot;WinMain&quot;を&quot;MyWinMain&quot;にリネームし、戻り値も変えてみました。
<br />
hello4.asm:
<br />
</p>
<pre class="plugin_pre">
global _MyWinMain@16
extern _MessageBoxA@16

section .text
_MyWinMain@16:
    PUSH EBP
    MOV EBP, ESP

    PUSH 0
    PUSH caption
    PUSH msg
    PUSH 0
    CALL _MessageBoxA@16

    MOV EAX, 4

    MOV ESP, EBP
    POP EBP
    RET 16

section .data

caption:
    db &quot;Hello, &quot;, 0

msg:
    db `Win32\r\nWorld!`, 0
</pre>

<p class="paragraph">
コンパイル＋リンク＋実行：
<br />
</p>
<pre>&gt; nasm -fwin32 hello4.asm
&gt; link /OUT:hello4.exe /ENTRY:MyWinMain /SUBSYSTEM:WINDOWS hello4.obj user32.lib
&gt; start /wait hello4.exe
(メッセージボックスのOKボタンをクリックするまで、コマンドプロンプトに戻らない)
&gt; echo %ERRORLEVEL%
4
</pre>

<h3 id="ide05eb6">まとめ</h3>

<p class="paragraph">
NASMとVC++の提供するリンカを使って、Win32アセンブラプログラミングを体験しました。
<br />
</p>

<p class="paragraph">
今回はVC++のリンカを使いましたが、フリーのWin32用リンカとして&quot;ALink&quot;や&quot;GoLink&quot;などもあります。また&quot;GoLink&quot;開発元では、アセンブラ/リソースコンパイラ/デバッガも開発されています。
<br />
</p>
<ul><li> Jeremy Gordon&#039;s Windows+assembler source page<ul><li> <a class="externallink" href="http://www.godevtool.com/" target="_blank">http://www.godevtool.com/</a></li></ul></li>
<li> ALINK<ul><li> <a class="externallink" href="http://alink.sourceforge.net/" target="_blank">http://alink.sourceforge.net/</a></li></ul></li></ul>

<p class="paragraph">
NASMでのWin32アセンブラプログラミングはWeb上にも資料が豊富に存在し、お手軽・お気軽に始められる環境だと言えます。
<br />
但し記事によってはNASM以外のツールチェインが異なる場合があり、GoLinkを使っていたりMSYS/MinGW環境だったりしますので、そこだけ注意が必要でしょう。
<br />
</p>

<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-787.html" title="Assembler/ForFun(x86_32)/05, 16bit BIOS with GNU as">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-789.html" title="Assembler/ForFun(x86_32)/07, 32bit Linux with GNU as">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-790.html" title="Assembler/ForFun(x86_32)">Up</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-410.html" title="Assembler">Assembler</a>&nbsp;]</li>
</ul>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/788<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2001 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a target="_blank" href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" target="_blank" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>