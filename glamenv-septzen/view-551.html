<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>日記/2010/01/13/jonesforthのgasによるコンパイルと&quot;--build-id&quot;オプションなど - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">日記/2010/01/13/jonesforthのgasによるコンパイルと&quot;--build-id&quot;オプションなど</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2010-01-13 02:06:46 &nbsp; / &nbsp; last updated at: 2010-01-13 02:27:55<br>
カテゴリ: <a href="category-48.html">Assembler</a>&nbsp;</div>

<div class="data_body">
<p class="paragraph">
docs.komagata.orgの「ガチ鬱プログラマー日記」のRSSフィードを読んでいると、暫く前からjonesforthというアセンブラで書かれたForth処理系をLinuxのgasでコンパイルしようとして上手く行かなかったり、謎のオプションでエラーになったりトラブルに突き当たっている。
<br />
</p>
<ul><li> GAS - Hello, world - p0t<ul><li> <a class="externallink" href="http://docs.komagata.org/4431" target="_blank">http://docs.komagata.org/4431</a></li></ul></li>
<li> make, gas.vim, jonesforth - p0t<ul><li> <a class="externallink" href="http://docs.komagata.org/4438" target="_blank">http://docs.komagata.org/4438</a></li></ul></li>
<li> ELFのbuild ID noteって何？ - p0t<ul><li> <a class="externallink" href="http://docs.komagata.org/4439" target="_blank">http://docs.komagata.org/4439</a></li></ul></li></ul>

<p class="paragraph">
同じくアセンブラに手を出した人間として、捨てておくわけにはいかない。
<br />
というわけで自分もCentOS5.2(古っ)上でjonesforthのコンパイルに挑戦してみた。
<br />
</p>



<p class="paragraph">
ldとgasのバージョンは以下の通り：
<br />
</p>
<pre>$ ld --version
GNU ld version 2.17.50.0.6-6.el5 20061020
...
$ as --version
GNU assembler 2.17.50.0.6-6.el5 20061020
...
</pre>




<p class="paragraph">
jonesforthのサイトURLは以下：
<br />
</p>
<ul><li> FORTH<ul><li> <a class="externallink" href="http://www.annexia.org/forth" target="_blank">http://www.annexia.org/forth</a></li></ul></li></ul>

<p class="paragraph">
&quot;Download&quot;の&quot;jonesforth.s.txt&quot;をローカルにダウンロードし、&quot;jonesforth.S&quot;にリネームする。
<br />
ソースコードを見てみると、FORTH処理系の概要や実装方法、gasアセンブラの簡単な説明からコンパイルオプションまで至れりつくせりなドキュメントが埋め込まれている。
<br />
・・・これでコンパイルできないって、かなり涙目。
<br />
</p>

<p class="paragraph">
ということで、ソースコード中で指示されている通りにgccを動かしてみる。
<br />
</p>
<pre>$ gcc -m32 -nostdlib -static -Wl,-Ttext,0 -Wl,--build-id=none -o jonesforth jonesforth.S
/usr/bin/ld: unrecognized option &#039;--build-id=none&#039;
/usr/bin/ld: use the --help option for usage information
collect2: ld はステータス 1 で終了しました
</pre>
<p class="paragraph">
・・・涙目。
<br />
</p>

<p class="paragraph">
binutilsのldコマンドが &quot;--build-id&quot; オプションを認識出来なくて失敗している。p0tの記事でも調査されたようだが、うまく解決できていないようだ。
<br />
</p>

<p class="paragraph">
Google先生の助けを借りて、ldや&quot;--build-id&quot;について検索していく内に、やはりldコマンドのバージョンが若干古いらしいことと、&quot;--build-id&quot;オプションは指定しなくても問題ない事が分かってきた。
<br />
</p>

<p class="paragraph">
まずGNU binutils本家のサイトを調べてみると、バージョン2.18で&quot;--build-id&quot;オプションが追加された旨がldのNEWSファイルに記されていた。
<br />
</p>
<ul><li> <a class="externallink" href="http://sourceware.org/cgi-bin/cvsweb.cgi/~checkout~/src/ld/NEWS?rev=1.111&amp;content-type=text/plain&amp;cvsroot=src" target="_blank">http://sourceware.org/cgi-bin/cvsweb.cgi/~checkout~/src/ld/NEWS?rev=1.111&amp;content-type=text/plain&amp;cvsroot=src</a></li></ul>
<pre>Changes in 2.18:

* Linker sources now released under version 3 of the GNU General Public
  License.

* ELF: New --build-id option to generate a unique per-binary identifier
  embedded in a note section.
...
</pre>

<p class="paragraph">
GNU binutils本家から辿れる、最新2.20のldのinfoファイルを見てみる。
<br />
</p>
<ul><li> <a class="externallink" href="http://sourceware.org/binutils/docs-2.20/ld/index.html" target="_blank">http://sourceware.org/binutils/docs-2.20/ld/index.html</a></li>
<li> → &quot;2. Invocation&quot; → &quot;2.1 Command Line Options&quot;<ul><li> <a class="externallink" href="http://sourceware.org/binutils/docs-2.20/ld/Options.html#Options" target="_blank">http://sourceware.org/binutils/docs-2.20/ld/Options.html#Options</a></li></ul></li></ul>

<pre>--build-id
--build-id=style
    Request creation of .note.gnu.build-id ELF note section. 
    ...
</pre>

<p class="paragraph">
ファイルを識別する為のユニークなビットフィールドを &quot;.note.gnu.build-id&quot; というELFのnoteセクションに埋め込む。
<br />
styleには以下の値を指定出来る。
<br />
</p>
<table>
	<tr>
		<td> &quot;uuid&quot; </td>
		<td> 128 random bits </td>
	</tr>
	<tr>
		<td> &quot;sha1&quot; </td>
		<td> 160-bit SHA1 hash </td>
	</tr>
	<tr>
		<td> &quot;md5&quot; </td>
		<td> 128-bit MD5 hash </td>
	</tr>
	<tr>
		<td> &quot;0x&quot; + hexdigits </td>
		<td> 任意の16進数 </td>
	</tr>
</table>
<p class="paragraph">
styleが省略された場合は &quot;sha1&quot; を指定したものと見なされる。
<br />
特別なstyleとして &quot;none&quot; を指定すると、&quot;--build-id&quot; の機能を無効化する。
<br />
</p>

<p class="paragraph">
&quot;--build-id&quot;を調べていると、最近のLinuxディストリビューションで&quot;--build-id&quot;の有効化についてのドキュメントが見つかった。
<br />
</p>
<ul><li> [PATCH 7/7] Use --build-id ld option<ul><li> <a class="externallink" href="http://linux.derkeiler.com/Mailing-Lists/Kernel/2007-07/msg03946.html" target="_blank">http://linux.derkeiler.com/Mailing-Lists/Kernel/2007-07/msg03946.html</a></li></ul></li>
<li> Releases/FeatureBuildId - FedoraProject<ul><li> <a class="externallink" href="https://fedoraproject.org/wiki/Releases/FeatureBuildId#Put_a_build_ID_into_every_binary" target="_blank">https://fedoraproject.org/wiki/Releases/FeatureBuildId#Put_a_build_ID_into_every_binary</a></li></ul></li>
<li> Build ID - openSUSE<ul><li> <a class="externallink" href="http://en.opensuse.org/Build_ID" target="_blank">http://en.opensuse.org/Build_ID</a></li></ul></li></ul>

<p class="paragraph">
&quot;.note.gnu.build-id&quot;セクションは実行時にプロセスイメージにロードされる。もしkernelがサポートしていればコアダンプファイルに含まれるようになる。
<br />
OpenSUSEやFedoraProjectでこの機能を使うようになった背景として、FedoraProjectのページの&quot;1.1 Summary&quot;に以下の2点が挙げられている。(OpenSUSEの方も似たような事情のようだ)
<br />
</p>
<ul><li> コアダンプから、正しいバージョンのバイナリを探せるようにする</li>
<li> デバッグ情報のチェック処理の最適化 - ファイル全体のチェックサム計算などを回避する為。</li></ul>

<p class="paragraph">
前掲のFedoraProjectのページを見てみると
<br />
</p>
<pre>The Linux binutils-2.17.50.0.17 release includes this, in f8test1.
binutils-2.17.50.0.17-3 and later in Rawhide have the feature.
</pre>
<p class="paragraph">
というような記述があるが、バックポートでもされたのだろうか。
<br />
</p>

<p class="paragraph">
いずれにせよ、自分が使っているバージョンのld(2.17.50.0.6)ではサポートされていないのは確実である。
<br />
</p>

<p class="paragraph">
jonesforthに戻ると、以上の情報から &quot;-Wl,--build-id=none&quot; オプションはそもそも&quot;--build-id&quot;機能を無効化している。よって、&quot;--build-id&quot;オプションをサポートしていないバージョンのldでは指定する必要が無いと予想される。
<br />
</p>

<p class="paragraph">
実際にこのオプションを削った状態でコンパイルに挑戦してみる。
<br />
</p>
<pre>$ gcc -m32 -nostdlib -static -Wl,-Ttext,0  -o jonesforth jonesforth.S
$ echo $?
0
$ file jonesforth
jonesforth: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), statically linked, not stripped
</pre>
<p class="paragraph">
コンパイルに成功した。
<br />
</p>

<p class="paragraph">
続けてjonesforthのサイトからサンプルスクリプトファイルをダウンロードし、実行してみる。以下のコマンドサンプルがjonesforth.Sファイル中のドキュメントにあったので、試してみた。
<br />
</p>
<pre>$ cat jonesforth.f - | ./jonesforth
強制終了
</pre>
<p class="paragraph">
強制終了してしまった。試しにjonesforth単体で動かしてみる。
<br />
</p>
<pre>$ ./jonesforth
強制終了
$ echo $?
137
</pre>

<p class="paragraph">
ぱっと見、次に怪しいのはこのオプションである。
<br />
</p>
<pre>-Wl,-Ttext,0
</pre>
<p class="paragraph">
ldのヘルプを見てみると
<br />
</p>
<pre>-Ttext ADDRESS              Set address of .text section
</pre>
<p class="paragraph">
とあるし、infoファイルにも
<br />
</p>
<pre>`-Ttext ORG&#039;
     Same as -section-start, with `.bss&#039;, `.data&#039; or `.text&#039; as the
     SECTIONNAME.
</pre>
<p class="paragraph">
とある。0が指定されているのだから、&quot;.text&quot;セクションの開始アドレスを&quot;0&quot;にする意味になる。
<br />
</p>

<p class="paragraph">
&quot;--save-temps&quot;, &quot;-v&quot;オプションをつけて途中生成物の保存＆gccドライバの詳細メッセージを表示させる。
<br />
</p>
<pre class="plugin_pre">
$ gcc -v --save-temps -m32 -nostdlib -static -Wl,-Ttext,0  -o jonesforth jonesforth.S
Using built-in specs.
Target: i386-redhat-linux
...
 as -V -Qy -o jonesforth.o jonesforth.s
GNU assembler version 2.17.50.0.6-6.el5 (i386-redhat-linux) using BFD version 2.17.50.0.6-6.el5 20061020
 /usr/libexec/gcc/i386-redhat-linux/4.1.2/collect2 \
     -m elf_i386
     --hash-style=gnu
     -static
     -o jonesforth
     -L/usr/lib/gcc/i386-redhat-linux/4.1.2
     -L/usr/lib/gcc/i386-redhat-linux/4.1.2
     -L/usr/lib/gcc/i386-redhat-linux/4.1.2/../../..
     -Ttext 0
     jonesforth.o

$ ls
jonesforth*  jonesforth.S  jonesforth.f  jonesforth.o  jonesforth.s

$ readelf -S jonesforth
There are 8 section headers, starting at offset 0x1d04:

Section Headers:
  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al
  [ 0]                   NULL            00000000 000000 000000 00      0   0  0
  [ 1] .text             PROGBITS        00000000 001000 0005ba 00  AX  0   0  4
  [ 2] .rodata           PROGBITS        000005bc 0015bc 0006d0 00   A  0   0  4
  [ 3] .data             PROGBITS        00001c8c 001c8c 000044 00  WA  0   0  4
  [ 4] .bss              NOBITS          00002000 001cd0 003000 00  WA  0   0 4096
  [ 5] .shstrtab         STRTAB          00000000 001cd0 000034 00      0   0  1
  [ 6] .symtab           SYMTAB          00000000 001e44 001650 10      7  40  4
  [ 7] .strtab           STRTAB          00000000 003494 000dcc 00      0   0  1
Key to Flags:
  W (write), A (alloc), X (execute), M (merge), S (strings)
  I (info), L (link order), G (group), x (unknown)
  O (extra OS processing required) o (OS specific), p (processor specific)

$ readelf -h jonesforth
ELF Header:
  Magic:   7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00
  Class:                             ELF32
  Data:                              2&#039;s complement, little endian
  Version:                           1 (current)
  OS/ABI:                            UNIX - System V
  ABI Version:                       0
  Type:                              EXEC (Executable file)
  Machine:                           Intel 80386
  Version:                           0x1
  Entry point address:               0xe
  Start of program headers:          52 (bytes into file)
  Start of section headers:          7428 (bytes into file)
  Flags:                             0x0
  Size of this header:               52 (bytes)
  Size of program headers:           32 (bytes)
  Number of program headers:         2
  Size of section headers:           40 (bytes)
  Number of section headers:         8
  Section header string table index: 5
</pre>
<p class="paragraph">
&quot;.text&quot;セクションがアドレス0から開始され、エントリポイントのアドレスが0xeになっている。&quot;.text&quot;セクションを逆アセンブルしてみる。
<br />
</p>
<pre class="plugin_pre">
$ objdump -d -S -j .text jonesforth | less
jonesforth:     file format elf32-i386

Disassembly of section .text:

00000000 &lt;DOCOL&gt;:
   0:   8d 6d fc                lea    0xfffffffc(%ebp),%ebp
   3:   89 75 00                mov    %esi,0x0(%ebp)
   6:   83 c0 04                add    $0x4,%eax
   9:   89 c6                   mov    %eax,%esi
   b:   ad                      lods   %ds:(%esi),%eax
   c:   ff 20                   jmp    *(%eax)

0000000e &lt;_start&gt;:
   e:   fc                      cld
   f:   89 25 98 1c 00 00       mov    %esp,0x1c98
  15:   bd 00 40 00 00          mov    $0x4000,%ebp
  1a:   e8 7e 05 00 00          call   59d &lt;set_up_data_segment&gt;
  1f:   be bc 05 00 00          mov    $0x5bc,%esi
  24:   ad                      lods   %ds:(%esi),%eax
  25:   ff 20                   jmp    *(%eax)
...
</pre>

<p class="paragraph">
gdbでデバッグしてみる。
<br />
</p>
<pre class="plugin_pre">
$ gdb jonesforth
GNU gdb Red Hat Linux (6.5-37.el5_2.2rh)
...

(gdb) b _start
Breakpoint 1 at 0xe
(gdb) run
Starting program: /home/msakamoto/in_vitro/lang.asm/jonesforth/jonesforth
Couldn&#039;t get registers: そのようなプロセスはありません.
</pre>

<p class="paragraph">
・・・なーんか、そろそろ深みに嵌りそうな気がしてきた・・・。
<br />
</p>

<p class="paragraph">
ちょっと &quot;-Wl,-Ttext,0&quot; による影響の詳細追跡は置いておき、とにかく怪しいオプションなのだから削ってみる。
<br />
</p>
<pre class="plugin_pre">
$ gcc -v -m32 -nostdlib -static -o jonesforth jonesforth.S
Using built-in specs.
Target: i386-redhat-linux
...
 as -V -Qy -o /tmp/ccgxvdKK.o /tmp/ccEEORGU.s
GNU assembler version 2.17.50.0.6-6.el5 (i386-redhat-linux) using BFD version 2.17.50.0.6-6.el5 20061020
 /usr/libexec/gcc/i386-redhat-linux/4.1.2/collect2 
     -m elf_i386
     --hash-style=gnu
     -static
     -o jonesforth
     -L/usr/lib/gcc/i386-redhat-linux/4.1.2
     -L/usr/lib/gcc/i386-redhat-linux/4.1.2
     -L/usr/lib/gcc/i386-redhat-linux/4.1.2/../../..
     /tmp/ccgxvdKK.o

$ readelf -S jonesforth
There are 8 section headers, starting at offset 0xd78:

Section Headers:
  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al
  [ 0]                   NULL            00000000 000000 000000 00      0   0  0
  [ 1] .text             PROGBITS        08048074 000074 0005ba 00  AX  0   0  4
  [ 2] .rodata           PROGBITS        08048630 000630 0006d0 00   A  0   0  4
  [ 3] .data             PROGBITS        08049d00 000d00 000044 00  WA  0   0  4
  [ 4] .bss              NOBITS          0804a000 000d44 003000 00  WA  0   0 4096
  [ 5] .shstrtab         STRTAB          00000000 000d44 000034 00      0   0  1
  [ 6] .symtab           SYMTAB          00000000 000eb8 001650 10      7  40  4
  [ 7] .strtab           STRTAB          00000000 002508 000dcc 00      0   0  1
Key to Flags:
  W (write), A (alloc), X (execute), M (merge), S (strings)
  I (info), L (link order), G (group), x (unknown)
  O (extra OS processing required) o (OS specific), p (processor specific)

$ readelf -h jonesforth
ELF Header:
  Magic:   7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00
  Class:                             ELF32
  Data:                              2&#039;s complement, little endian
  Version:                           1 (current)
  OS/ABI:                            UNIX - System V
  ABI Version:                       0
  Type:                              EXEC (Executable file)
  Machine:                           Intel 80386
  Version:                           0x1
  Entry point address:               0x8048082
  Start of program headers:          52 (bytes into file)
  Start of section headers:          3448 (bytes into file)
  Flags:                             0x0
  Size of this header:               52 (bytes)
  Size of program headers:           32 (bytes)
  Number of program headers:         2
  Size of section headers:           40 (bytes)
  Number of section headers:         8
  Section header string table index: 5

$ objdump -d -S -j .text jonesforth | less

jonesforth:     file format elf32-i386

Disassembly of section .text:

08048074 &lt;DOCOL&gt;:
 8048074:       8d 6d fc                lea    0xfffffffc(%ebp),%ebp
 8048077:       89 75 00                mov    %esi,0x0(%ebp)
 804807a:       83 c0 04                add    $0x4,%eax
 804807d:       89 c6                   mov    %eax,%esi
 804807f:       ad                      lods   %ds:(%esi),%eax
 8048080:       ff 20                   jmp    *(%eax)

08048082 &lt;_start&gt;:
 8048082:       fc                      cld
 8048083:       89 25 0c 9d 04 08       mov    %esp,0x8049d0c
 8048089:       bd 00 c0 04 08          mov    $0x804c000,%ebp
 804808e:       e8 7e 05 00 00          call   8048611 &lt;set_up_data_segment&gt;
 8048093:       be 30 86 04 08          mov    $0x8048630,%esi
 8048098:       ad                      lods   %ds:(%esi),%eax
 8048099:       ff 20                   jmp    *(%eax)
...
</pre>

<p class="paragraph">
いつも見慣れた&quot;0x80480..&quot;近辺のアドレスに&quot;_start&quot;シンボルが移動した。雰囲気的にイケそうな感じがするので、試してみる。
<br />
</p>
<pre>$ ./jonesforth
(Ctrl-D)
$ echo $?
0
</pre>

<p class="paragraph">
イケそうなので、サンプルスクリプトに再挑戦してみる。
<br />
</p>
<pre>$ cat jonesforth.f - | ./jonesforth
JONESFORTH VERSION 47
14499 CELLS REMAINING
OK
$ echo $?
0
</pre>

<p class="paragraph">
・・・ようやく動いた・・・。
<br />
</p>

<p class="paragraph">
ところが話はここで終わっていない。以下の記事によると、そもそもgasの時点でエラーが沢山表示されてしまうとのこと。
<br />
</p>
<ul><li> ELFのbuild ID noteって何？ - p0t<ul><li> <a class="externallink" href="http://docs.komagata.org/4439" target="_blank">http://docs.komagata.org/4439</a></li></ul></li></ul>

<pre>$ as -o jonesforth.o jonesforth.S
</pre>
<p class="paragraph">
実際に試してみたところ、同様に大量のエラーメッセージが表示された。
<br />
しかし・・・&quot;.S&quot;ファイルを直接asに食べさせているのが気になる。もう一度、上でコンパイル＆実行に成功したオプションでのgccの詳細を見てみる。
<br />
</p>
<pre class="plugin_pre">
$ gcc -v -m32 -nostdlib -static -o jonesforth jonesforth.S
Using built-in specs.
Target: i386-redhat-linux
...
 /usr/libexec/gcc/i386-redhat-linux/4.1.2/cc1 -E -lang-asm -quiet -v jonesforth.S -m32 -mtune=generic -o /tmp/ccFU9F94.s
存在しないディレクトリ &quot;/usr/lib/gcc/i386-redhat-linux/4.1.2/../../../../i386-redhat-linux/include&quot; を無視します
#include &quot;...&quot; の探索はここから始まります:
#include &lt;...&gt; の探索はここから始まります:
 /usr/local/include
 /usr/lib/gcc/i386-redhat-linux/4.1.2/include
 /usr/include
探索リストの終わり
 as -V -Qy -o /tmp/ccC32TCa.o /tmp/ccFU9F94.s
GNU assembler version 2.17.50.0.6-6.el5 (i386-redhat-linux) using BFD version 2.17.50.0.6-6.el5 20061020
 /usr/libexec/gcc/i386-redhat-linux/4.1.2/collect2 (省略)
</pre>
<p class="paragraph">
一旦&quot;cc1&quot;, プリプロセッサを通してその出力をasに食わせている。
<br />
</p>

<p class="paragraph">
試しに手動で同じコマンドを実行してみる。まずプリプロセッサの結果を&quot;jonesforth.asm&quot;に保存してみる。
<br />
</p>
<pre class="plugin_pre">
$ cpp -E -lang-asm -quiet -v jonesforth.S -m32 -mtune=generic -o jonesforth.asm
Using built-in specs.
cpp: unrecognized option &#039;-quiet&#039;
Target: i386-redhat-linux
...

 /usr/libexec/gcc/i386-redhat-linux/4.1.2/cc1 -E -lang-asm -quiet -v jonesforth.S -o jonesforth.asm -m32 -mtune=generic
存在しないディレクトリ &quot;/usr/lib/gcc/i386-redhat-linux/4.1.2/../../../../i386-redhat-linux/include&quot; を無視します
#include &quot;...&quot; の探索はここから始まります:
#include &lt;...&gt; の探索はここから始まります:
 /usr/local/include
 /usr/lib/gcc/i386-redhat-linux/4.1.2/include
 /usr/include
探索リストの終わり
cpp: -lang-asm: リンクが完了しなかったのでリンカの入力ファイルは使われませんでした

$ cat jonesforth.asm
# 1 &quot;jonesforth.S&quot;
# 1 &quot;&lt;built-in&gt;&quot;
# 1 &quot;&lt;コマンドライン&gt;&quot;
# 1 &quot;jonesforth.S&quot;
(...)
 .set JONES_VERSION,47
# 306 &quot;jonesforth.S&quot;
 .macro NEXT
 lodsl
 jmp *(%eax)
 .endm
(...)
</pre>
<p class="paragraph">
うまく動いたようだ。続いてこれを、gasに入力してみる。
<br />
</p>
<pre class="plugin_pre">
$ as -V -Qy -o jonesforth_asm.o jonesforth.asm
GNU assembler version 2.17.50.0.6-6.el5 (i386-redhat-linux) using BFD version 2.17.50.0.6-6.el5 20061020

$ echo $?
0

$ file jonesforth_asm.o
jonesforth_asm.o: ELF 32-bit LSB relocatable, Intel 80386, version 1 (SYSV), not stripped
</pre>
<p class="paragraph">
ここまでも無事動いているようだ。最後に、リンクしてみる。
<br />
</p>
<pre class="plugin_pre">
$ ld \
     -m elf_i386 \
     --hash-style=gnu \
     -static \
     -o jonesforth_byhand \
     ./jonesforth_asm.o

$ cat jonesforth.f - | ./jonesforth_byhand
JONESFORTH VERSION 47
14499 CELLS REMAINING
OK

$ echo $?
0
</pre>
<p class="paragraph">
問題ないようだ。
<br />
</p>

<p class="paragraph">
jonesforthのソースコードでは、
<br />
</p>
<pre>/* ... */
</pre>
<p class="paragraph">
形式のコメントが大量に使われている。一方、msakamoto-sf自身がこれまで経験してきたアセンブラのコメント形式は
<br />
</p>
<pre>#...
</pre>
<p class="paragraph">
形式だった。
<br />
</p>

<p class="paragraph">
恐らく
<br />
</p>
<pre>/* ... */
</pre>
<p class="paragraph">
形式のコメントを除去する為にプリプロセッサを通す必要があり、そのため、直接asに入力してもエラーとなってしまう。それが、&quot;asでコンパイル出来ない&quot;問題の原因(の、少なくとも一つ)であることが予想される。
<br />
</p>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/551<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2007 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>