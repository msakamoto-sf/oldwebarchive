<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>PHP/HTML_QuickFormメモ/20050601/addRuleの引数のハック - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">PHP/HTML_QuickFormメモ/20050601/addRuleの引数のハック</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2005-06-01 22:12:12 &nbsp; / &nbsp; last updated at: 2008-12-21 22:17:24<br>
カテゴリ: <a href="category-6.html">PHP</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-43.html" title="PHP/ADODB/セッションデータの暗号化メモ">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-44.html" title="PHP/HTML_QuickFormメモ/20050601/裏技その１">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-25.html" title="PHP">PHP</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
HTML_QuickForm::addRule()の引数で一部不明なのがありましたので、ちょっとハックしてみました。
<br />
</p>

<p class="paragraph">
形式 :
<br />
</p>
<pre>void addRule(
    string $element, 
    string $message, 
    string $type, 
   [string $format = null], 
   [string $validation = &#039;server&#039;], 
   [boolean $reset = false], 
   [boolean $force = false])
</pre>

<p class="paragraph">
中身：
<br />
</p>
<table>
	<tr>
		<td> string </td>
		<td> $element </td>
		<td> Form element name </td>
	</tr>
	<tr>
		<td> string </td>
		<td> $message </td>
		<td> Message to display for invalid data </td>
	</tr>
	<tr>
		<td> string </td>
		<td> $type </td>
		<td> Rule type, use getRegisteredRules() to get types </td>
	</tr>
	<tr>
		<td> string </td>
		<td> $format </td>
		<td> (optional)Required for extra rule data </td>
	</tr>
	<tr>
		<td> string </td>
		<td> $validation </td>
		<td> (optional)Where to perform validation: &quot;server&quot;, &quot;client&quot; </td>
	</tr>
	<tr>
		<td> boolean </td>
		<td> $reset </td>
		<td> Client-side validation: reset the form element <br /> to its original value if there is an error? </td>
	</tr>
	<tr>
		<td> boolean </td>
		<td> $force </td>
		<td> Force the rule to be applied, <br /> even if the target form element does not exist </td>
	</tr>
</table>
<p class="paragraph">
$element, $message, $type, $validation, $reset, $forceまでは、まあ、英語の解説でわかるんですよ。
<br />
<strong> 問題は $format 引数。 </strong>
<br />
</p>

<p class="paragraph">
HTML_QuickForm::addRule()をハックしてみると、
<br />
</p>
<pre>$this-&gt;_rules[$element][] = array(
    &#039;type&#039;        =&gt; $type,
    &#039;format&#039;      =&gt; $format,
    &#039;message&#039;     =&gt; $message,
    &#039;validation&#039;  =&gt; $validation,
    &#039;reset&#039;       =&gt; $reset,
    &#039;dependent&#039;   =&gt; $dependent
    );
</pre>
<p class="paragraph">
みたくなってて、内部の$_rules[]に連想配列でセットされてます。んで、これが使われているところはメインはHTML_QuickForm::validate()なのでちょっと調べてみます。
<br />
</p>
<pre>function validate() {
    ...
    $registry =&amp; HTML_QuickForm_RuleRegistry::singleton();
    ...
    $result = $registry-&gt;validate(
        $rule[&#039;type&#039;], 
        $submitValue, 
        $rule[&#039;format&#039;], ...);
</pre>
<p class="paragraph">
のように使われてました<span class="hidden">(</span><a class="footnote" href="#footnote_45_1" id="footnote_45_1_r"  title="ちなみにformatの後の...は、$rules[&#039;howmany&#039;]がセットされていればtrue, いなければfalseで、これはHTML_QuickForm_RuleRegistryのvalidate()のmultipleに影響します。">*1</a><span class="hidden">)</span>。
<br />
結構後の方まで引きずってます。んで、HTML_QuickForm_RuleRegistryというのは、結局Ruleの統合インターフェイスですな。シングルトンですから、ぶっちゃけファクトリーみたいなもんです。中身は。
<br />
んで、それのvalidateを調べてみます。
<br />
</p>
<pre>function validate($ruleName, $values, $options = null, $multiple = false) {
   ...
   $rule =&amp; $this-&gt;getRule($ruleName);
   ...
   return $rule-&gt;validate($values, $options);
}
</pre>
<table>
	<tr>
		<th> HTML_QuickForm::validate() </th>
		<th> HTML_QuickForm_RuleRegistry::validate() </th>
	</tr>
	<tr>
		<td> $rule[&#039;type&#039;] </td>
		<td> $ruleName </td>
	</tr>
	<tr>
		<td> $submitValue </td>
		<td> $values </td>
	</tr>
	<tr>
		<td> $rule[&#039;format&#039;] </td>
		<td> $options </td>
	</tr>
	<tr>
		<td> 注<span class="hidden">(</span><a class="footnote" href="#footnote_45_2" id="footnote_45_2_r"  title="is_array($submitValue) &amp;&amp; !isset($rule[&#039;howmany&#039;])の場合true, でなければfalse">*2</a><span class="hidden">)</span> </td>
		<td> $multiple </td>
	</tr>
</table>

<p class="paragraph">
えーっとですね・・・ちょっと疲れてきましたが。
<br />
getRuleっつーのはあれですな、Validation系クラスのFactroyデザインパターンのインターフェイスです。ですから結局のところ、Rule/ディレクトリ以下の各クラスのvalidate()メソッドが呼び出されるわけです。最終的に・・・
<br />
</p>
<table>
	<tr>
		<th> HTML_QuickForm </th>
		<th> HTML_QuickForm_RuleRegistry </th>
		<th> 各Ruleクラス </th>
	</tr>
	<tr>
		<td> $submitValue </td>
		<td> $values<span class="hidden">(</span><a class="footnote" href="#footnote_45_3" id="footnote_45_3_r"  title="配列の場合はforeachで分解される">*3</a><span class="hidden">)</span> </td>
		<td> $value </td>
	</tr>
	<tr>
		<td> $format </td>
		<td> $options </td>
		<td> $option </td>
	</tr>
</table>
<p class="paragraph">
みたく受け渡されていきます。 <span style="font-size: 20px"> ・・・$formatという引数名、おかしくない？・・・ </span>
<br />
素直に$optionsとか、$rule_paramsとかつけてくれてればもうちょっとわかりやすいのに。
<br />
</p>

<p class="paragraph">
ちなみに、HTML_QuickFormのパッケージではRule/以下は次のファイルしかありません。
<br />
</p>
<ul><li> Callback.php</li>
<li> Compare.php</li>
<li> Email.php</li>
<li> Range.php</li>
<li> Regex.php</li>
<li> Required.php</li></ul>

<p class="paragraph">
このうち、少なくともCallback.phpとRegex.phpで$optionが、ひいては$format引数が使用されています。たとえばCallback.phpでしたら、コールバック関数(call_user_func)に唯一PHPスクリプトからプログラマーが渡せる引数として利用されていますし、Regex.phpでは同様で、内部で分岐こそしていますが、基本的にはpreg_matchに渡す正規表現として使用されています。
<br />
</p>

<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-43.html" title="PHP/ADODB/セッションデータの暗号化メモ">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-44.html" title="PHP/HTML_QuickFormメモ/20050601/裏技その１">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-25.html" title="PHP">PHP</a>&nbsp;]</li>
</ul><div class="footnote">
<a id="footnote_45_1" href="#footnote_45_1_r">*1</a>: ちなみにformatの後の...は、$rules[&#039;howmany&#039;]がセットされていればtrue, いなければfalseで、これはHTML_QuickForm_RuleRegistryのvalidate()のmultipleに影響します。<br />
<a id="footnote_45_2" href="#footnote_45_2_r">*2</a>: is_array($submitValue) &amp;&amp; !isset($rule[&#039;howmany&#039;])の場合true, でなければfalse<br />
<a id="footnote_45_3" href="#footnote_45_3_r">*3</a>: 配列の場合はforeachで分解される
</div>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/45<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2007 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>