<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>日記/2007/06/07/Xhwlayメモ - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">日記/2007/06/07/Xhwlayメモ</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2007-06-07 23:47:39 &nbsp; / &nbsp; last updated at: 2008-12-22 23:51:05<br>
カテゴリ: <a href="category-16.html">Xhwlay</a>&nbsp;</div>

<div class="data_body">
<p class="paragraph">
※PokoXとして妄想していた時分の記録
<br />
</p>

<h3 id="id543d1d">魔術は成立した。</h3>

<p class="paragraph">
発端は、「で、そもそも何でFSM入れるんだっけ？」だ。
<br />
理由は一つ。限定的遷移を行わせたい。つまり、CSRF対策だ。
<br />
で、昨夜、ソースをゼロベースで手を出し始めたが、フロー定義のyamlファイルのスキーマの解説を書いているうちに、「・・・なんでここまでする必要があるんだ・・・。」という気になってきたのだ。
<br />
CSRF対策？限定的遷移？そもそも、FSMを用いるメリットは何だ？なぜわざわざFSMを導入する？
<br />
理由は一つ、限定的遷移。つまり、ある実行ポイントから次の実行ポイントに移るときに、その遷移が、正規のものであることを保障できる・・・手法として、FSMがある意味、「そのまんま」当てはまったからだ。
<br />
ちょっとまて、と。別に・・・遷移を設定ファイルに記述されたとおりに保障する仕掛けさえあれば、FSMを使わずともよくね？
<br />
結局、「現在の実行ポイント」をstoreし、identifyする機構を設け、そのうえで、ある実行ポイントに遷移するとき、「現在の実行ポイントからの遷移先として正規か？」をチェックし、チェックOKなら遷移、チェックNGならデフォルトの実行ポイントに強制リダイレクト。というのがもともとの、筋のはずだ。
<br />
これを応用することにより、CSRFを防げ、しかもDouble-POSTも防止できる。
<br />
</p>

<p class="paragraph">
・・・別に、FSM使わなくても良いじゃん。
<br />
しかも、だ。うれしいことに、PokoXはもともと「ストーリー」という概念で実行ポイントを定義している。
<br />
ま、ちょっと定義している概念階層は上下しちゃってるんだけど。
<br />
じゃあ・・・PokoXのストーリーに、そう、「ロック・イン」（固定する、箱に入れる、閉じ込める、出られなくする）できるようにすれば良いのでは？
<br />
(lock in よりはlock onかなあ・・・。連結する、自動追尾する、みたいな表現。)
<br />
</p>

<p class="paragraph">
PokoX自体は、何度か使ったけど結局「モジュール・チェイン」は使わない。（まあ、モジュール・ディスパッチは場合により使う、程度。）なので、今度の改造のときは（もちろんパラダイムが変わるのでPokoX2の予定だった）
<br />
</p>
<pre>&quot;aci.action&quot; =&gt; &quot;クラス名&quot;
</pre>
<p class="paragraph">
程度にしようと思ってた。実際問題、モジュールargsも滅多に使わない。もともと固定的な設定値を埋め込めるようにするためのマージンだったけど、設定値はアプリ定義の仕組みで行うのがほとんど($_MEMORIESとか。)だったので使ってない。
<br />
</p>

<p class="paragraph">
まあ、DI-Containerはおいしいけど・・・。無くても動くし。
<br />
</p>

<p class="paragraph">
なので、こんな感じかなあ。argsは、attrsにまとめちゃおう。
<br />
</p>
<pre>$story = array(
	&quot;*.*&quot; =&gt; array(
		&quot;class&quot; =&gt; &quot;your.business.logic.class&quot;,
		&quot;lock&quot; =&gt; &quot;on&quot;,
		&quot;attrs&quot; =&gt; array(), // 省略可能
		&quot;next&quot; =&gt; array(&quot;new&quot;, &quot;edit&quot;, &quot;delete&quot;),
		),
</pre>

<p class="paragraph">
例えば、ユーザーの一覧を出して、新規作成や編集はウィザード形式、削除は単発、みたいなのだとこんな感じ。で、これだと、&quot;ヘルプ&quot;画面はフロー制限外。つまりlock-onされてなくてもオッケー。
<br />
まず、PokoX自体のlock-onモードはデフォルト&quot;on&quot;という設定を可能なこと。これにより、&quot;lock&quot; =&gt; &quot;on&quot;は省略可能になる。逆にlock-offポイントを明示的に指定する必要がある。
<br />
</p>

<p class="paragraph">
・・・というよりか、
<br />
</p>
<ul><li> ロックするのが&quot;lock-on&quot;, </li>
<li> ロック解除(ID破棄)が&quot;lock-off&quot;。</li>
<li> IDロックが不要なページは、&quot;lock-free&quot;と表現すべきか。</li></ul>

<p class="paragraph">
あと、そろそろ、&quot;story&quot;じゃなくて&quot;page&quot;という表現にしようか。
<br />
</p>

<pre>$page = array(
&quot;*.list&quot; =&gt; &quot;*.*&quot;,
&quot;*.*&quot; =&gt; array(
	&quot;class&quot; =&gt; &quot;UserList.class.php&quot;,
	&quot;next&quot; =&gt; array(&quot;new&quot;, &quot;edit&quot;, &quot;delete&quot;)
	),
&quot;*.new&quot; =&gt; array(&quot;class&quot; =&gt; &quot;UserCreate_1.class.php&quot;,
	&quot;next&quot; =&gt; array(&quot;list&quot;, &quot;new1&quot;)
	),
&quot;*.new1&quot; =&gt; array(..., &quot;next&quot; =&gt; array(&quot;new&quot;, &quot;new2&quot;)),
&quot;*.new2&quot; =&gt; array(..., &quot;next&quot; =&gt; array(&quot;new&quot;, &quot;new1&quot;, &quot;new3&quot;)),
&quot;*.new3&quot; =&gt; array(..., &quot;next&quot; =&gt; array(&quot;new&quot;, &quot;new1&quot;, &quot;new2&quot;, &quot;new_last&quot;)),
&quot;*.new_last&quot; =&gt; array(...,
	&quot;lock&quot; =&gt; &quot;off&quot;,
	&quot;next&quot; =&gt; array(&quot;list&quot;)
	),
&quot;*.help&quot; =&gt; array(..., &quot;lock&quot; =&gt; &quot;free&quot;),
</pre>

<p class="paragraph">
例えば、いきなり&quot;*.new&quot;を叩く場合。lock-idが発行されておらず、しかもlock-onモードなので、lock-idが発行され、&quot;*.*&quot;にmodule-dispatchされる。
<br />
lock-idに対しては、現在の<strong> bookmark(栞) </strong>を&quot;*&quot;に設定される。
<br />
ここで、例えば&quot;...?ロックID=...&amp;page=new&quot;というリンクがクリックされたとする。
<br />
ロックIDが与えられているので、設定されているbookmarkをロードする。
<br />
→&quot;*&quot;になる。で、&quot;*&quot;の&quot;next&quot;を見てみると、&quot;new&quot;がある。つまり、許可されているため、&quot;*.new&quot;のモジュールが実行される。
<br />
また、&quot;bookmark&quot;を進める。
<br />
ではlistからいきなり、&quot;new1&quot;ストーリーがリクエストされたとする。
<br />
</p>
<pre>bookmark-&gt;&quot;*&quot;-&gt;&quot;next&quot; = array()
</pre>
<p class="paragraph">
の中に無いため、warningのErrroStackを発行し、bookmarkの&quot;*&quot;を実行する。
<br />
で、&quot;new_last&quot;まで到達した場合。&quot;new3&quot;までbookmarkが進んだ状態で
<br />
</p>
<pre>&quot;page=new_last&quot;
</pre>
<p class="paragraph">
がリクエストされると、
<br />
</p>
<pre>bookmark -&gt; &quot;new3&quot; -&gt; next=&gt;array(&quot;new_last&quot;) -&gt; &quot;new_last&quot;
</pre>
<p class="paragraph">
で、new_lastが実行される。この後、&quot;lock&quot;が&quot;off&quot;であるため、ここが一つの&quot;lock-id&quot;に対する終端モジュール。
<br />
つまり、lock-idと紐づいているbookmark情報が破棄される。
<br />
</p>

<p class="paragraph">
途中で&quot;page=help&quot;がリクエストされた場合：
<br />
</p>
<pre>bookmark -&gt; &quot;...&quot; -&gt; &quot;lock-free&quot; -&gt; そのまま&quot;help&quot;実行。bookmarkは更新しない。
</pre>
<p class="paragraph">
helpのViewで、ちゃんとlock-idがリンクに埋め込まれていれば、bookmarkはそのままなので、&quot;lock-on&quot;されたストーリーがそのまま継続される。
<br />
</p>

<h3 id="id111e94">Guardian-Hookについて。</h3>

<p class="paragraph">
上記処理は・・・まあ当然、PokoXのコアが実行することになるのだけれども。
<br />
当然、callbackを設定することでlock-idとlock-on, nextの判別処理にHookできる。
<br />
PRE_GUARD_HOOK : 戻り値は以下。
<br />
</p>
<ul><li> PRE_GUARD_OK ... リクエストされたpageへ進んでよい。</li>
<li> PRE_GUARD_NG ... pageへ進めない。bookmarkされたpageを実行。</li>
<li> PRE_GUARD_DEFAULT ... デフォルトのGuardianへ処理を委譲。</li></ul>

<p class="paragraph">
・・・HOOKよりかは、&amp;$pokoxを渡すとか、PokoXへのDIとかで、すなおにメソッド内で処理を委譲させた方が良いかも。あるいは、多分Storyコアでいっぺんに処理できる類じゃないから、
<br />
</p>
<pre>$guards = array(
	&quot;/new.*/&quot; =&gt; array(&quot;callback_for_new_action_guards&quot;)
	);
</pre>
<p class="paragraph">
みたく、正規表現かけられる形にするとか。こうすれば、上記例では、&quot;new3&quot;まで言った後に、（例えばタブナビゲーションとかで）new1まで戻ったとしよう。
<br />
で、new1から再び&quot;new3&quot;に行きたいとき・・・guards側で、例えばFlowScopeにstackされている値を読んで、条件が満たされていれば、設定ファイル上はN.G.だけど、guards側で通す、ということも可能になる。
<br />
</p>

<p class="paragraph">
あとは、PokoXコアとして、MRTNはデフォルトに。まあ・・・そこら辺は今まで温めていた通りで。
<br />
</p>

<p class="paragraph">
ViewかActionかは、モジュールが判別すべき。フレームワーク側で引きずらない！
<br />
</p>

<p class="paragraph">
あと、やっぱ、いい加減、DIコンテナ使おう。・・・いろいろと幅も広がるだろうし・・・。
<br />
</p>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/62<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2001 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a target="_blank" href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" target="_blank" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>