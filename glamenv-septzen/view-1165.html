<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Groovy/お手軽Web開発(GroovyServlet, Java, Gradle, Tomcat) - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">Groovy/お手軽Web開発(GroovyServlet, Java, Gradle, Tomcat)</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2013-03-17 21:10:41 &nbsp; / &nbsp; last updated at: 2013-03-17 21:17:58<br>
カテゴリ: <a href="category-68.html">Groovy</a>&nbsp;<a href="category-11.html">Java</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-1214.html" title="Groovy/groovy.transform : &quot;@Canonical&quot;, &quot;@Immutable&quot;">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-1183.html" title="Groovy/真・超お手軽Web開発(Groovy-1.8 + Jetty8, 201304版)">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-1101.html" title="Groovy">Groovy</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
<a href="./view-1103.html" >Groovy/超お手軽Web開発(Groovy-1.8 + Jetty8, 201209版)</a> でGroovyServletを使った非常にミニマルなWeb開発環境を紹介しました。今回はもう少し掘り下げて、実際にServletやJavaソースを組み合わせ、Tomcat上でclassファイルの自動リロード(Context auto reload)も有効にした「サクサク開発」が出来る構成を作ってみたので、紹介します。
<br />
</p>

<p class="paragraph">
サンプル：
<br />
</p>
<ul><li> <a class="externallink" href="https://github.com/msakamoto-sf/java-groovy-gradle-war-sample1/tree/5359ba6592892a73201b28d2f7e18eaa583b0937" target="_blank">https://github.com/msakamoto-sf/java-groovy-gradle-war-sample1/tree/5359ba6592892a73201b28d2f7e18eaa583b0937</a><ul><li> このサンプル自体は今後も調整を続ける可能性があるので、本記事で紹介している時点でのソースツリーは厳密には上記のものになります。</li></ul></li></ul>

<p class="paragraph">
<strong>ポイント：gradle-tomcat-plugin を使う + Java/Groovyクラスファイルの出力先を&quot;/WEB-INF/classes/&quot;以下に設定する。</strong>
<br />
</p>

<p class="paragraph">
gradle-tomcat-plugin:
<br />
</p>
<ul><li> bmuschko/gradle-tomcat-plugin · GitHub<ul><li><ul><li> <a class="externallink" href="https://github.com/bmuschko/gradle-tomcat-plugin" target="_blank">https://github.com/bmuschko/gradle-tomcat-plugin</a></li></ul></li></ul></li>
<li> vladvoic/tomcatGradleExample · GitHub<ul><li> <a class="externallink" href="https://github.com/vladvoic/tomcatGradleExample" target="_blank">https://github.com/vladvoic/tomcatGradleExample</a></li></ul></li>
<li> Gradle Community Forums - Using gradle-tomcat-plugin<ul><li> <a class="externallink" href="http://forums.gradle.org/gradle/topics/using_gradle_tomcat_plugin" target="_blank">http://forums.gradle.org/gradle/topics/using_gradle_tomcat_plugin</a></li></ul></li></ul>

<p class="paragraph">
検証環境：
<br />
</p>
<pre>Win7 64bit
JDK7 64bit
Gradle 1.4
</pre>

<h3 id="idf4f0c0">サンプルの構成</h3>

<p class="paragraph">
以下のように、実際に開発の現場で使いそうなポイントを組み込んでいます。
<br />
</p>
<ul><li> &quot;gradle tomcatRun&quot; したあと、別のターミナルから&quot;gradle classes&quot;とかすれば、Tomcatがcontextをリロードしてくれるので「サクサク開発」が出来る。<ul><li> 今回検証したのはコマンドラインとエディタを使った連携まで。EclipseやIntelliJ IDEAでも確実に「サクサク開発」を実践できるかまでは未検証。</li></ul></li>
<li> JavaソースとGroovyソースを組み合わせている。(JavaソースからGroovyソースのクラスを参照している)<ul><li> <a href="./view-1163.html" >Groovy/Gradle/Mixing Java and Groovy</a> のテクニックを使ってます。</li></ul></li>
<li> Java/GroovyコンパイラにJavaソースのバージョンとか文字コード指定、デバッグON/OFFフラグを設定している。</li></ul>

<p class="paragraph">
ということで、ソースの詳細についてはGitHubで眺めていただき、ポイントとなる部分だけを紹介していきます。
<br />
</p>

<h3 id="idd2e35a">ポイント1 : Tomcatによるクラスファイル自動リロード -&gt;「サクサク開発」</h3>

<p class="paragraph">
gradle-tomcat-pluginでは、&quot;tomcatRun&quot;タスクでTomcatを立ち上げる際に、Contextの&quot;relodable&quot;をデフォルトで有効化します。
<br />
これにより、&quot;/WEB-INF/classes&quot;および&quot;/WEB-INF/lib&quot;以下のファイルに変更があれば、Tomcat側で自動的にContextをリロードしてくれます。
<br />
ターミナルを3つ立ち上げ、1つは&quot;gralde tomcatRun&quot;でTomcatを起動させておき、2つ目ではエディタを立ちあげてソースファイルを編集し、3つ目で&quot;gradle classes&quot;を実行する、のような形で、コンパイルされたクラスを即座にTomcatに反映させる「サクサク開発」が実践出来ます。
<br />
</p>

<p class="paragraph">
ただし注意点が1つあります。GradleのJava/Groovyクラスファイル出力先はデフォルトでは以下のディレクトリです。
<br />
</p>
<pre>build/classes/...
</pre>
<p class="paragraph">
また、warプラグインが想定するデフォルトの&quot;/WEB-INF/&quot;ディレクトリは以下になります。
<br />
</p>
<pre>src/main/webapp/WEB-INF/...
</pre>
<p class="paragraph">
gradle-tomcat-pluginは、クラスファイルの出力先を設定から取得してContextに追加し、起動するため、基本的に上記のようなデフォルトのままでも起動自体は問題ありません。<strong>しかし、TomcatがContextのリロードをしてくれるのはあくまでも &quot;/WEB-INF/classes&quot; や &quot;/WEB-INF/lib&quot; の中が更新された場合であり、 &quot;build/classes&quot; 以下が更新されてもスルーしてしまい、Contextはリロードされません。</strong>
<br />
</p>

<p class="paragraph">
解決策として、以下のようにJava/Groovyクラスファイルの出力先を&quot;src/main/webapp/WEB-INF/classes&quot;に設定してしまいます。
<br />
build.gradle:
<br />
</p>
<pre>...

sourceSets.main.output.classesDir = &#039;src/main/webapp/WEB-INF/classes&#039;

...
</pre>

<p class="paragraph">
これにより、&quot;gradle classes&quot;すると &quot;src/main/webapp/WEB-INF/classes&quot; 以下にクラスファイルを出力してくれますので、Tomcat側で変更を検出し、Contextをreloadしてくれます。
<br />
</p>

<p class="paragraph">
また、このままですと&quot;gradle clean&quot;した時に &quot;src/main/webapp/WEB-INF/classes&quot; を削除してくれませんので、&quot;clean&quot;タスクを以下のようにカスタマイズします。
<br />
</p>
<pre>clean {
    // add customized class output path to deletion targets of &#039;clean&#039; task.
    delete &lt;&lt; &#039;src/main/webapp/WEB-INF/classes&#039;
}
</pre>

<p class="paragraph">
これにより、&quot;gradle clean&quot;すると &quot;build/&quot; 以下に加え、&quot;/WEB-INF/classes&quot; も削除してくれます(※ただし、上記cleanタスクのカスタマイズは、「ん～、こんな感じでイケんじゃね？」と試してみたらうまく行ってくれただけですので、もしかしたら厳密にはカスタマイズ方法勘違いしてるかもしれません。)
<br />
</p>

<p class="paragraph">
なお、あまりいじり過ぎたり何度もreloadが発生すると、Contextのreloadで以下のようなメッセージが表示されます。「怪しそうだな」と感じたら一旦Tomcatを停止して立ち上げ直すと良いのは、他のEclipseやIntelliJなどでの「サクサク開発」と同じです。
<br />
</p>

<pre class="plugin_pre">
$ gradle tomcatRun
:compileJava UP-TO-DATE
:compileGroovy
:processResources
:classes
:tomcatRun
Started Tomcat Server
The Server is running at http://localhost:8090/warsample1
(...)
The web application [/warsample1] created a ThreadLocal with key of type \
[org.codehaus.groovy.reflection.ClassInfo.ThreadLocalMapHandler] \
(value [org.codehaus.groovy.reflection.ClassInfo$ThreadLocalMapHandler@64658ba0]) \
and a value of type [java.lang.ref.SoftReference] \
(value [java.lang.ref.SoftReference@46b1e8de]) \
but failed to remove it when the web application was stopped. \
Threads are going to be renewed over time to try and avoid a probable memory leak.
(...)
</pre>

<p class="paragraph">
また、これで &quot;gradle war&quot; したwarファイルの中を覗いてみると、以下のようにクラスファイルのエントリが重複してしまっています。
<br />
</p>
<pre class="plugin_pre">
$ jar tf build/libs/warsample1-1.0.0.war
...
WEB-INF/classes/net/glamenvseptzen/quickstart/
WEB-INF/classes/net/glamenvseptzen/quickstart/AdjustedGroovyServlet.class
WEB-INF/classes/net/glamenvseptzen/quickstart/HelloServlet.class
WEB-INF/classes/net/glamenvseptzen/quickstart/MyGroovyUtil.class
WEB-INF/classes/net/glamenvseptzen/quickstart/MyStringUtil.class
WEB-INF/classes/net/glamenvseptzen/quickstart/ToolKit.class
WEB-INF/classes/net/glamenvseptzen/quickstart/AdjustedGroovyServlet.class
WEB-INF/classes/net/glamenvseptzen/quickstart/HelloServlet.class
WEB-INF/classes/net/glamenvseptzen/quickstart/MyGroovyUtil.class
WEB-INF/classes/net/glamenvseptzen/quickstart/MyStringUtil.class
WEB-INF/classes/net/glamenvseptzen/quickstart/ToolKit.class
...
</pre>

<p class="paragraph">
ただし、展開すればちゃんと一つのみになっていますので、ひとまず心配はいりません。実際に単独でセットアップしたTomcatにdeployし、正常に動作することを動作確認しております。
<br />
</p>

<h3 id="id88c4f1">ポイント2 : JavaソースからGroovyのソースを参照</h3>

<p class="paragraph">
<a href="./view-1163.html" >Groovy/Gradle/Mixing Java and Groovy</a> のテクニックを使ってます。以下のように、mainとtestの両方の &quot;SourceSet&quot; でJavaのソース指定を空っぽにして、Groovy側のコンパイラでコンパイルするように調整をしています。
<br />
build.gradle:
<br />
</p>
<pre class="plugin_pre">
...

[sourceSets.main, sourceSets.test].each {
    // compile java and groovy file at same time.
    it.groovy.srcDirs += it.java.srcDirs
    // disable java compilation
    it.java.srcDirs = []
}

...
</pre>

<h3 id="id4d4d6a">ポイント3 : Javaソースのバージョン, 文字コード, デバッグ情報埋め込みの指定</h3>

<p class="paragraph">
GradleのJavaコンパイルのタスクも、Groovyコンパイルのタスクも、どちらも&quot;Compile&quot;タスクの型から派生しています。ということで、以下のようにすることでJava/Groovyの両方で共通してJavaソースのバージョン, 文字コード, デバッグ情報の埋め込みを設定できます。
<br />
</p>
<pre class="plugin_pre">
tasks.withType(Compile) {
    sourceCompatibility = &#039;1.7&#039;
    targetCompatibility = &#039;1.7&#039;
    options.encoding = &#039;UTF-8&#039;
    options.debug = true
}
</pre>

<h3 id="id8a0f41">その他参考情報など</h3>

<p class="paragraph">
EclipseとGraldeの連携という観点で色々と挑戦されているようです。
<br />
</p>
<ul><li> Gradleを使ったWebアプリケーションのさくさく開発（セットアップ編） - splash of waters<ul><li> <a class="externallink" href="http://d.hatena.ne.jp/jappy/20130307/1362668792" target="_blank">http://d.hatena.ne.jp/jappy/20130307/1362668792</a></li></ul></li></ul>

<p class="paragraph">
今回、&quot;tomcatRun&quot;まではgradle-tomcat-pluginのおかげでスンナリ動いてくれましたが、Contextのリロードについて &quot;/WEB-INF/classes&quot; 「しか」見ないということに気づかず、数時間以上「おかしい・・・なんで &quot;build/classes/...&quot; 以下のファイルはちゃんと更新されてるのに、Tomcat側で反映してくれないんだ・・・」と悩んでました。
<br />
gradle-tomcat-pluginの過去のIssueなどを漁っているうちに、&quot;tomcatGradleExample&quot;を見つけて「あれ～？？こっちはやっぱりちゃんとリロードしてくれる・・・どこが違うんだ・・・？」と見比べているうちに「あ、こっちは&quot;/WEB-INF/classes&quot;に出力するようにカスタマイズしてる。もしかして・・・」とTomcatのドキュメントとかソースまで手繰り寄せ、「やっぱり、&quot;/WEB-INF/classes|lib&quot;以下しか決め打ちで見てないんだ・・・」と確認でき、それでようやく、「じゃぁカスタマイズするか～。あ、でも、&quot;tomcatGradleExample&quot;って&quot;gradle clean&quot;しても&quot;/WEB-INF/classes&quot; 以下に残っちゃうよな・・・cleanタスクもカスタマイズが必要だ。」となり、それでようやくなんとか安定して動くようになった次第です。
<br />
</p>

<p class="paragraph">
あと、一応サンプルにはGradle添付のJettyプラグインも使えるようにしてます。ただ、こちらではContextの自動リロードをしてくれなかったのでスルーしてます。なんかGradle添付のJettyプラグイン、設定出来るパラメータも少ないし、gradle-tomcat-pluginと比べると大分見劣りがしてしまう・・・。
<br />
</p>

<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-1214.html" title="Groovy/groovy.transform : &quot;@Canonical&quot;, &quot;@Immutable&quot;">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-1183.html" title="Groovy/真・超お手軽Web開発(Groovy-1.8 + Jetty8, 201304版)">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-1101.html" title="Groovy">Up</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-1101.html" title="Groovy">Groovy</a>&nbsp;]</li>
</ul>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/1165<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2001 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a target="_blank" href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" target="_blank" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>