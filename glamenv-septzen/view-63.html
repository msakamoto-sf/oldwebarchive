<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>日記/2007/07/01/Xhwlayメモ - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">日記/2007/07/01/Xhwlayメモ</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2007-07-01 23:52:31 &nbsp; / &nbsp; last updated at: 2008-12-22 23:56:37<br>
カテゴリ: <a href="category-16.html">Xhwlay</a>&nbsp;</div>

<div class="data_body">
<h3 id="id5179da">Xhwlayの読み方</h3>

<ul><li> 「ズーレイ」(&quot;ズー&quot;にアクセント)</li>
<li> 「ズレイ」(&quot;レイ&quot;にアクセント)</li></ul>

<p class="paragraph">
英語だと後者になるようですが、元々とある漫画の「ブーレイ騎士団」という名前が頭をかすめた時に思いついた名前ですので、前者を推したいところです。
<br />
</p>

<p class="paragraph">
・・・が、2008年12月現在は作者自身が後者の&quot;レイ&quot;にアクセントを置いた方で読んでます。
<br />
</p>

<h3 id="id985c96">概要</h3>

<p class="paragraph">
Piece Framework を強く意識し、ステートフルな画面遷移を行う為の、シンプルなコントローラです。フレームワークではありません。Piece Frameworkを意識していますが、ステート保持のコンセプトはFSM(Finite State Machine)ではなく、ページの流れを一つの「本」(Book)と捉え、ユーザーに現在表示するべきページを「栞」(Bookmark)として保持するような仕掛けにしています。従ってActiveStateやViewStateなどの区分けは存在しません。従来通りの「ページ - アクション」マッピングの思想を引き継いでいます。一応、Guardに相当する「Barrier」(バリア)を設定することが可能です。ページ遷移を特定条件でブロックするときなどに使います<span class="hidden">(</span><a class="footnote" href="#footnote_63_1" id="footnote_63_1_r"  title="例えば入力値のvalidationなど">*1</a><span class="hidden">)</span>。
<br />
</p>

<p class="paragraph">
例によりValidatorやORM、さらにロギングなどの連携は一切手を出していません。好きなように作り込んで下さい。
<br />
</p>

<p class="paragraph">
PokoXの上位版の予定でしたが、互換性は無くなります。当初はPokoX 2.0 を予定していましたが、後述の理由により名前を変更し、ゼロから作り直しました。
<br />
</p>

<h3 id="iddad3d7">名前を変えた理由</h3>

<p class="paragraph">
&quot;pokox&quot;で検索すると、かなりの数のハンドルネームが引っかかってしまいました。このご時世、本当に「ユニーク」な名前を考案するのは至難の業のようです。新しい名称は、とりあえず 2007/04 - 06 現在、Google上では他に存在しないようです。
<br />
</p>

<h3 id="id014c87">何故Pieceを使わないか</h3>

<p class="paragraph">
フローエンジンのコアとなる、Piece-Flowと StageHand_FSM のソースを読んでも、何をやっているのかよく分からなかったというのが原因です。発端がそこで、「FSMワケわかんねー！」となり、「じゃあ、自分で作ってしまえ」と例により暴走が始まりました。ソースちゃんと読めよ、と言われても、暴走し出すと傲慢な性格がむき出しになりますので、何を言われても大して心に・・・とめないように、努力はしてます。
<br />
</p>

<p class="paragraph">
後付の理由ですが、ステートフルなページ遷移を行うフレームワークの仲間を増やしたいな、と。フレームワークじゃなくてライブラリですが。
<br />
</p>

<h3 id="idd1999e">今何やってるの？</h3>

<p class="paragraph">
2007-07-01 現在、目下コーディング &amp; 単体テスト中で、機能をシェイプアップ中です。sf.netにプロジェクトは登録できましたが、まだCVSには入れていません。
<br />
</p>

<p class="paragraph">
この後の予定ですが、とりあえず一通り終わったら1.0.0-RCとしてCVSに入れて、リリースファイルに登録したら、そのままYakiBikiに移る予定です。8月位になるかな・・・。
<br />
</p>

<p class="paragraph">
YakiBikiでの実装によるフィードバックを入れて、とりあえず1.0.0としてリリースする予定です。ドキュメントもYakiBikiで書きたいところですし。
<br />
</p>

<h3 id="iddf4058">Piece Framework 勉強会の影響</h3>

<p class="paragraph">
非常に刺激的でした。また、帰り道幾つか思いついた設計変更を。ここから下は作者以外の人は読み飛ばしちゃって下さい。
<br />
</p>

<h4 id="id31d7e9">skipRender()の削除</h4>

<p class="paragraph">
よくよく考えたら、PageActorがreturn nullすればお仕舞いなので、二重にrender()の起動チェックをおこなう必要は無いと結論づけました。後述のXhwlay_Varsの導入とも関連しますが、なるべくXhwlay_AbstractRunnerインスタンスの持ち回りを避けたいというのもあり、もともとPageActorのエントリポイントに、skipRender()させたい為に Runnerインスタンスを渡していましたが、まあ、これで不要になるかなと。
<br />
</p>

<h4 id="id832359">Xhwlay_Vars の導入</h4>

<p class="paragraph">
今までは pageName や aci, bookmarkContainerId などを stdClass に押し込んでましたが、これも、Runnerインスタンスの持ち回りの遠因になっていましたのでやめます。 Xhwlay周りで値を持ち回したい場合は、Xhwlay_Vars を用いましょう、と。
<br />
</p>
<pre>Xhwlay_Vars::isset($key, $domain = &#039;*&#039;)
Xhwlay_Vars::unset($key, $domain = &#039;*&#039;)
Xhwlay_Vars::get($key, $default = null, $domain = &#039;*&#039;)
Xhwlay_Vars::set($key, $val, $domain = &#039;*&#039;)
define(&#039;XHWLAY_VARS_DOMAIN_DEFAULT&#039;, &#039;*&#039;)
</pre>
<p class="paragraph">
あまり複雑な設定値を持たせたいわけではなく、単にスカラー値やサイズの小さい配列を入れる予定ですので、これで十分かと。refにするかは、ビミョー。
<br />
</p>

<p class="paragraph">
今後は、pageNameやaciなどは
<br />
</p>
<pre>Xhwlay_Vars::get(XHWLAY_VARS_PAGE_KEY); // pageName
Xhwlay_Vars::get(XHWLAY_VARS_ACI_KEY);      // ACI
Xhwlay_Vars::get(XHWLAY_VARS_BCID_KEY);     // bookmarkContainerId
</pre>
<p class="paragraph">
みたいな感じにアクセスするようになります。def値も切っておかないと・・・。
<br />
</p>

<p class="paragraph">
また、XHWLAY_VARS_PAGE_KEYで取得できるのはあくまでも&quot;filtered&quot;された値になります。BCIDも同様。リクエストされた「生の」値を取得するには、
<br />
</p>
<pre>Xhwlay_Vars::get(XHWLAY_VARS_PAGE_KEY, &#039;&#039;, XHWLAY_VARS_DOMAIN_REQUEST);
Xhwlay_Vars::get(XHWLAY_VARS_BCID_KEY, &#039;&#039;, XHWLAY_VARS_DOMAIN_REQUEST);
</pre>
<p class="paragraph">
とするようにすべきかもしれません。
<br />
</p>

<p class="paragraph">
書いておいてなんですが、Xhwlayでは基本的にクラスは単数形を使う方針ですので、Xhwlay_Var, XHWLAY_VAR_*となる可能性大。
<br />
</p>

<h4 id="idb83cf5">Bookmarkコンテナの自動drop</h4>

<p class="paragraph">
AbstractRunnerのコアレベルでは、Bookmarkのdropは行いますが Bookmark Container の drop はしていません。しかし、Bookmark Container ID が第二のセッションIDとなり得る以上、きちんとdropをしないとBCIDに対する固定値攻撃などが発生しかねません。
<br />
次の「総HOOK化」とも関連しますが、Bookmark の drop の後に、Bookmarkの数が0になっていれば Bookmark Container も破棄するようなHOOKをデフォルトで仕掛けておくべきでしょう。それに関連して、Bookmarkの数をcountするIFをBookmark Containerに追加しておくべきでした。
<br />
</p>

<h4 id="id6deeb9">総HOOK化</h4>

<p class="paragraph">
・・・総、とまでは行かなくても、現段階でAbstractRunnerのimplement/extend先での実装を想定している setup(), terminate()などは、
<br />
</p>
<pre>push($hookpoint, $callback);
pop($hookpoint);
</pre>
<p class="paragraph">
的にすべきかもしれません。Xhwlay_Hookの登場か！？・・・それも、アリか・・・。
<br />
</p>

<h4 id="id5ff17a">RunnerにgetInstance()を追加</h4>

<p class="paragraph">
総HOOK化とも関連します。また、開発者をどこまで野放しにするかのバランス感覚の話になります。当初は、PageActorの開発だけに注目して欲しくて、その外の世界にはあまり触らせないようにしていました。が、Hook化の事も考えると、どうしてもRunnerに触りたい、少なくともBookmark ContainerやConfig, Rendererに直に触りたいがその場合はまずRunnerにアクセスしなければならない。そうした時に、引数で一々Runnerの参照を渡すのも、かなり面倒です。
<br />
</p>

<p class="paragraph">
実はPageActorやBarrierActorのインターフェイスにもまだ迷いがあって、Xhwlay_Vars の導入を決めたのはこれら開発者用のIFがPokoXの時ほどお気楽・お手軽に決定できていない、というのがあります。であるならば、とりあえず情報にはアクセスできるようにしておき、徒に書き換えたときに何が発生するのかは保証外として単体テストもそこまでは通しませんよ・・・と線引きをしてもいいかな、というなんだか情けない妥協の結果が、Runner::getInstance()の導入経緯となります。
<br />
</p>

<pre>function execute(&amp;$runner, $pageName, &amp;$bookmark, $params)
</pre>

<p class="paragraph">
これが、今考えているPageActorのIFです。&amp;$bookmark, $params は変える気はありません。どう考えても、今後設計が変わっても、必須のものであろうからです。しかし$pageName, $runnerは何の為にあるのか？と問われると、必須である理由はあまりなく単に「外部情報としてこの二つがあれば事足りるだろう」と考えていたからです。
<br />
しかし、外部情報として何が必要かは、たった一人の開発者が全てを予想できるものでは無いでしょう。であれば、もう、拘らずに全解放してしまっても良いのではないか。
<br />
</p>

<p class="paragraph">
もちろん Runner::setXXYY 系は軒並み、final &amp; protected となり、規律としては外部から呼び出すことはできなくなります。get のみが public となります。
<br />
</p>

<p class="paragraph">
・・・と書いてみたら、なんだか随分激しい仕様変更のような気もしてきました。特に「総Hook化」でのpop/pushは使い方次第ではコアのフローを完全に書き換えることができる悪魔のような仕様になりそうです。Hookの中でHookを書き換え、実行順序を変えたり、コアでデフォルトで設定されていたHookをPOPで破棄し、代わりに独自Hookを詰め直す・・・ということも可能。
<br />
</p>

<p class="paragraph">
うわぁ。
<br />
</p>

<h4 id="id6b0206">Story自体のBookmarkモードの取得や影響度についての修正。</h4>

<p class="paragraph">
PieceではStateFull/StateLessを、Flow自体ではなくUnityの方のYAMLで切り替えられるようになっていたのに触発されて。
<br />
一応Story自体にBookmarkモードを埋め込むことを「デフォルトの」使い方としますが、Runner側でも &quot;requireBookmark&quot; というHOOKポイントを用意しようかなと思います。
<br />
</p>

<p class="paragraph">
Runnerは現状、以下のコードでstory自体のBookmarkモードを検査しています。
<br />
</p>
<pre>if ( $this-&gt;_config-&gt;needsBookmark(...) ) {
</pre>
<p class="paragraph">
これが以下のようになります。本番はもうちょっとifブロックをまとめ直すかも・・・。
<br />
</p>
<pre>Xhwlay_Hook::invoke(&quot;requireBookmark&quot;);
$overWrited = Xhwlay_Var::get(&#039;requreBookmark&#039;, null); // 未設定であれば上書きは無かったとする。
if ( !is_null($overWrited) ) {
    if ( Xhwlay_Var::get(&#039;requiredBookmark&#039;) ) {
        // 上書きでBookmark ON
    } else {
        // 上書きでBookmark OFF
    }
} else {
    if ( $this-&gt;_config-&gt;needsBookmark(...) ) {
        // 通常のStory/Page重視のBookmark ON
...
</pre>

<p class="paragraph">
以上より、登録しておくべきHookは以下のようになります。処理はサンプルです。
<br />
</p>

<pre>class User_Hooks {
    function overwrite_story_bookmark() {
        $aci = Xhwlay_Var::get(XHWLAY_VAR_ACI_KEY);
        if ( $aci == &#039;anonymous&#039; ) {
            Xhwlay_Var::set(&quot;requireBookmark&quot;, false); // ACI = &#039;anonymous&#039;なら強制的にBookmarkOFF
            return;
        }

        $page = Xhwlay_Var::get(XHWLAY_VAR_PAGE_KEY);
        switch(&quot;$page.$aci&quot;) {
            case &quot;page1.admin&quot; : 
                Xhwlay_Var::set(&quot;requireBookmark&quot;, true); // Bookmarkを強制的にON
                break;
        }
    }
}

Xhwlay_Hook::push(array(&#039;User_Hooks&#039;, &#039;overwrite_story_bookmark&#039;));
</pre>

<p class="paragraph">
・・・え・・・？何気なく書いちゃったけど、ACIとページ名によってHOOK側で強制的にBookmarkのON/OFFを切り替えられるのか？・・・ま、いっか。
<br />
</p><div class="footnote">
<a id="footnote_63_1" href="#footnote_63_1_r">*1</a>: 例えば入力値のvalidationなど
</div>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/63<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2001 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a target="_blank" href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" target="_blank" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>