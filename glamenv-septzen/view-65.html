<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>日記/2007/07/12/Xhwlayメモ - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">日記/2007/07/12/Xhwlayメモ</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2007-07-12 00:02:08 &nbsp; / &nbsp; last updated at: 2008-12-23 00:04:00<br>
カテゴリ: <a href="category-16.html">Xhwlay</a>&nbsp;</div>

<div class="data_body">
<p class="paragraph">
とりあえず、getInstanceでインスタンス毎に分離できる形にして Xhwlay_Hook, TestCaseまで一通り終了。以降はいよいよ心臓部であるRunnerを作り直す。恐らくAbstractは消えて、Xhwlay_Runner_Baseみたくリネームされるのではないか？Invokerをとりあえず実装しちゃう。これによりAbstractな箇所が多分、無くなるはずだから。
<br />
</p>

<p class="paragraph">
あと重要な意志決定をいくつか。
<br />
</p>
<ul><li> HOOKのInvoke順なんだけど、結局 First-Pushed, First-Called に固定した。</li>
<li> HOOK中から動的に実行中のHook-Stackのpush/pop機能は、少なくとも現時点では実装しないことにした。</li>
<li> ErrorStackを見てのHookチェインの自動停止は実装しないことにした。(escape()の手動callで一本化)</li></ul>

<h3 id="id709a74">Invoke順を First-Pushed, First-Called 固定</h3>

<p class="paragraph">
実際の使い方を考慮すると、pushする順とはすなわち、設定ファイルなどに記述する順となる場合が圧倒的多数だろう。
<br />
例えばyamlファイルに以下のように記述したhookを実行するような実装をdeveloperが作ったとして、実行順序がこの逆になるような仕様が果たして分かりやすく使いやすいと言えるだろうか？直観的で誤解を招かないと言えるだろうか？
<br />
</p>
<pre>- hooks:
 - user_hook:
   - hook1
   - hook2
   - hook3
</pre>

<p class="paragraph">
こうした場合、もっとも自然な実行順序は設定順、すなわち先にpushした順であるのは殆どの人が同意するはずである。
<br />
</p>

<p class="paragraph">
もう一つの消極的理由としては、実行順序を将来的に変更するようになった場合、後方互換性を確保する為、恐らくattributeに順序を設定するのでは無かろうか？そうなると、恐らくinvoke()やその周りのインターフェイスを変える必要はなくなり、単にsetAttributeすれば良いだけになるだろう。
<br />
となると、現行のテストケースがそのまま使える。
<br />
変更箇所はおそらくinvoke()の内部だけに留められる筈であろう。であるならば、本当に必要になったその時に実装を考えても、今のところは困らないと考えた。
<br />
</p>

<p class="paragraph">
他に考慮したケースは、システム側でpushしておいたHookに、developerコードが追加でpushしたい場合。
<br />
</p>
<pre>class hoge_fw_runner {
function init() {
    $h =&amp; Xhwlay_Hook(&#039;init&#039;);
    $h-&gt;pushCallback(array(&amp;$this, &quot;start_session&quot;));
    $h-&gt;pushCallback(array(&amp;$this, &quot;restore_user_context&quot;));
}
function run() {
    $h =&amp; Xhwlay_Hook(&#039;init&#039;);
    $h-&gt;invoke();
    ...
}
}
</pre>
<p class="paragraph">
上記のようなクラスを用い、例えば次のように実行する場合。
<br />
</p>
<pre>&lt;?php
require_once(&#039;your_framework_files&#039;);
/*
 * エントリポイント用の各種設定コード・処理
 */
hoge_fw_runner::run();
?&gt;
</pre>
<p class="paragraph">
この場合、run()メソッドを呼ぶ前に &quot;init&quot;HOOKにdeveloper-hookをpushできるか？させるべきか？を考える。
<br />
安直なプログラマーであれば、run()する前に自分で&quot;ini&quot;HOOKにpushしてしまうかも知れない。
<br />
</p>
<pre>$h =&amp; Xhwlay_Hook(&quot;init&quot;);
$h-&gt;pushCallback(...);
hoge_fw_runner::run();
</pre>
<p class="paragraph">
しかしこれでは、hoge_fw_runner::init()中の設定と干渉する。
<br />
</p>

<p class="paragraph">
もしinvoke順を、First-Push,  Last-Calledにしておく、あるいは選択できるのであればこれに対応できる。
<br />
</p>

<p class="paragraph">
しかし、果たしてそうするべきだろうか？init()の中では実際に、First-Push, First-Callを期待して、先にstart_sessionが呼ばれるように調整してあるというのに！！
<br />
</p>
<pre>    $h-&gt;pushCallback(array(&amp;$this, &quot;start_session&quot;));
    $h-&gt;pushCallback(array(&amp;$this, &quot;restore_user_context&quot;));
</pre>
<p class="paragraph">
こうした場合、一番王道な方法はhoge_fw_runner自体を派生し、init()をオーバーライドするべきだろう。
<br />
</p>
<pre>&lt;?php
require_once(&#039;your_framework_files&#039;);
class custom_fw_runner extends hoge_fw_runner {
function init() {
    hoge_fw_runner::init(); // PHP5なら、parent::init() で済む？
    $h =&amp; Xhwlay_Hook(&quot;init&quot;);
    $h-&gt;pushCallback(&#039;your_own_hooks&#039;);
}

/*
 * エントリポイント用の各種設定コード・処理
 */

custom_fw_runner::run();
?&gt;
</pre>
<p class="paragraph">
どうしても&quot;start_session&quot;の前にオリジナルのHOOKを入れたいのであれば、親クラスのinit()を呼ぶ前に入れればよい。
<br />
</p>
<pre>function init() {
    $h =&amp; Xhwlay_Hook(&quot;init&quot;);
    $h-&gt;pushCallback(&#039;your_own_hooks_1&#039;);

    hoge_fw_runner::init(); // PHP5なら、parent::init() で済む？

    $h-&gt;pushCallback(&#039;your_own_hooks_2&#039;);
}
</pre>

<p class="paragraph">
このような考慮の結果、特にinvoke順は First-Push, FirstCallでも問題ないとの結論に達した。
<br />
</p>

<h3 id="id64cbcc">HOOK中からの動的なHOOK-Chainの操作の保留</h3>

<p class="paragraph">
まずコードと仕様が複雑になる。escape()と組み合わされた場合も考慮すると、いささかややこしい。
<br />
で、その複雑なコードとややこしさが、果たして実際の実装要求と等価か？と考えると、不安。
<br />
</p>

<p class="paragraph">
つまり、現状まだそこまで使うようなシーンが思い浮かばないのだ。「できたらいいな」ではあるが、しかしその実体は「理論的に可能な遊び」に近い。従って、まだ本気で取り上げるべきでもない。
<br />
</p>

<p class="paragraph">
一応その下準備として、invoke()中では一旦hook-callbackのstack配列をコピーし、そのコピーでもってinvokeチェインを回している。
<br />
</p>
<pre>$copy_hook_stacks = $this-&gt;_callbacks;
foreach ( $copy_hook_stacks as $callback) {
...
}
</pre>
<p class="paragraph">
みたいな感じ。これにより、万一HOOK中でpush/popCallbackが行われても影響(被害?)を押さえられる。回しているのはコピーされたHOOKだからだ。
<br />
</p>

<p class="paragraph">
もしも本気で初期の構想で使いたい場合は、HOOK中からオリジナルのHOOKを呼び、escape()するのが良いかも知れない。
<br />
</p>

<h3 id="id9f1f82">ErrorStackを見てのHookチェインの自動停止は実装しないことにした。</h3>

<p class="paragraph">
これは構想のミス。当初はオリジナルのパッケージで挙げられたErrorStackを検出しようとしたが、Xhwlay_ErrorStackではパッケージ名でエラーを取得できなかった・・・のを、忘れてた。つまり、Xhwlay_ErrorStackでは不可能。
<br />
</p>

<p class="paragraph">
なので、escape()に一本化することにした。まあ、Invoking中のHOOK-Chainを止めるのはdeveloperの明確な意志に基づく、ということで。
<br />
</p>

<h3 id="id0e8dd8">うっかり寝過ごしてもう朝の9時半だよ、間に合わないよ。</h3>

<p class="paragraph">
と言うことで午前半休にして、Xhwlay_Runnerに取りかかる。
<br />
</p>

<p class="paragraph">
とりあえず、RendererにstdClassでaci, pageName, bookmarkContainerId割り振っていたけど、いろいろ考えて、止める。
<br />
代わりにXhwlay_Varに
<br />
</p>
<pre>XHWLAY_VAR_NAMESPACE_VIEW
</pre>
<p class="paragraph">
を追加して、これにセットするようRunnerを修正。それに伴い、AbstractRendererと、唯一getRequest()使っていたIncludeを修正し、SimpleTestまで終了。
<br />
</p>

<p class="paragraph">
あと、Rendererでsetup()やterminate()はHOOK実行に実装。また、setup()後にaci/pageName/BookmarkContainerId取ってるところを、ホワイトリストで文字種チェックをかけるよう、 _cleanup_outparam()というメソッドを追加してそれを通すよう修正。
<br />
また、これらのアウトパラムの最大文字数をRunnerに定義し、_cleanup_outparamでは &quot;/ ... /m&quot;で複数行対応でチェックするよう実装。
<br />
</p>

<p class="paragraph">
ただし_cleanup_outparamは未テスト。
<br />
</p>

<p class="paragraph">
invokePage, Barrier系は実装する旨TODOで書き付けておく。
<br />
</p>

<p class="paragraph">
他、AbstractRunnerは Xhwlay_Runnerにリネームし、ディレクトリを一つ上に上げた。Testも追随。&amp;br;
<br />
但し、まだ古い方は削除するのちょっと待ち。
<br />
</p>

<p class="paragraph">
そんな感じ。
<br />
</p>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/65<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2001 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a target="_blank" href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" target="_blank" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>