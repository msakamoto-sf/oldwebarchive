<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>C言語系/「デーモン君のソース探検」読書メモ/04, uuencode(1),uudecode(1) - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">C言語系/「デーモン君のソース探検」読書メモ/04, uuencode(1),uudecode(1)</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2010-01-09 18:05:57 &nbsp; / &nbsp; last updated at: 2010-01-10 15:47:29<br>
カテゴリ: <a href="category-32.html">BSD</a>&nbsp;<a href="category-10.html">C言語</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-543.html" title="C言語系/「デーモン君のソース探検」読書メモ/03, getchar(3)">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-545.html" title="C言語系/「デーモン君のソース探検」読書メモ/05, locate(1)">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-478.html" title="C言語系">C言語系</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
お題：uuencode(1)の符号化・復号化の仕組みを追跡せよ。
<br />
</p>




<h3 id="id6e1530">uuencodeの使い方とフォーマット</h3>

<p class="paragraph">
uuencodeの使い方：
<br />
</p>
<pre>uuencode [file] name
</pre>
<p class="paragraph">
fileが指定されない場合は標準入力から読み込まれる。nameは出力に含まれ、uudecodeが復元する時に必要となる。
<br />
</p>

<p class="paragraph">
適当なバイナリファイル&quot;testbin&quot;を用意し、uuencode結果を&quot;testbin.u&quot;に保存する。また、復元した時にファイル名が&quot;alternate&quot;となるようにする：
<br />
</p>
<pre>$ cat testbin | uuencode alternate &gt; testbin.u
</pre>
<p class="paragraph">
uudecodeで戻してみる。
<br />
</p>
<pre>$ uudecode testbin.u
$ cmp alternate testbin
$ echo $?
0
</pre>
<p class="paragraph">
同一のファイルに復元された。
<br />
</p>

<p class="paragraph">
uuencodeコマンドの使い方は &quot;man 1 uuencode&quot;, uuencodeの符号化の仕組みは &quot;man 5 uuencode&quot; に載っている。
<br />
<a class="externallink" href="http://www.jp.freebsd.org/cgi/mroff.cgi?subdir=man&amp;lc=1&amp;cmd=&amp;man=uuencode&amp;dir=jpman-5.4.0/man&amp;sect=5" target="_blank">http://www.jp.freebsd.org/cgi/mroff.cgi?subdir=man&amp;lc=1&amp;cmd=&amp;man=uuencode&amp;dir=jpman-5.4.0/man&amp;sect=5</a>
<br />
</p>

<p class="paragraph">
ざっと確認してみる。まず本来のバイト数は5738バイト、3で割ると2余る点に注意：
<br />
</p>
<pre>$ wc -c testbin
    5738 testbin
(= 1912 * 3 + 2)
</pre>
<p class="paragraph">
headコマンドでヘッダ行を確認してみる。
<br />
</p>
<pre>$ head -n 2 testbin.u
begin 644 alternate
M?T5,1@$!`0````````````(``P`!````)(8$&quot;#0```&quot;P#````````#0`(``&amp;
</pre>
<p class="paragraph">
&quot;begin 644 alternate(LF)&quot;がヘッダ行になる。
<br />
続いて本体データのエンコードされたデータ行が始まる。一行は改行を含み最大62文字。最初の１文字はその行の&quot;エンコードする前の&quot;バイト数 + 0x20(=空白)となっている。
<br />
上の例なら、先頭は&quot;M&quot;:
<br />
</p>
<pre>M = 0x4D = 10進77 (ASCIIコード)
→バイト数は 0x20(=10進32) を引いた、45バイト。
</pre>
<p class="paragraph">
uuencodeでは3バイト=24bitを単位として6bit x 4つに分割していくようになっている。
<br />
6bitということは10進で 0 - 63 となり、これに 0x20, 10進32, 空白文字のASCIIコードを足すことで、ASCIIコードの10進で32 - 95まで、すなわち数字・大文字アルファベット・あといくつかの記号文字に符号化できる。
<br />
45バイトと言うことは360bit, 6bitで分割すればちょうど60になる。すなわち、符号化された結果のASCIIコードの文字数は60文字になる：
<br />
</p>
<pre>M(=45バイト→符号化すると60文字) + 符号化された60文字 + (改行)
</pre>
<p class="paragraph">
で、ちょうど一行62文字になっていることが確認出来た。
<br />
</p>

<p class="paragraph">
つづいてtailコマンドでトレーラ行近くを確認してみる。
<br />
</p>
<pre>$ tail -n 3 testbin.u
77W)E9VES=&amp;5R7V9R86UE7VEN9F\`,0H`
`
end
</pre>

<p class="paragraph">
逆から見ていって、まず&quot;end&quot;がトレーラ行になる。その上の
<br />
</p>
<pre>`
</pre>
<p class="paragraph">
一文字の行は、本体データの終わりを意味していて、本体データそれ自体には含まれない、只のマーカー(印)。値としては&quot;`&quot;、つまり復号化すれば0になる。
<br />
その上の行が、本体データの最後の行になる。
<br />
</p>
<pre>77W)E9VES=&amp;5R7V9R86UE7VEN9F\`,0H`
</pre>
<p class="paragraph">
符号化前のデータのバイト数を表す先頭1文字は &quot;7&quot;, ASCIIコード10進で 55 , 空白文字の10進32を引けば 23 となる。
<br />
一方、符号化された文字数は32文字、つまり
<br />
</p>
<pre>32 x 6bit = 192bit = 24 x 8bit
</pre>
<p class="paragraph">
で、復号化すると24バイトになってしまう。
<br />
ここで元ファイルのサイズが、3で割ると2余る5738バイトだったことを思い出す。
<br />
uuencode(5)の仕様では、もし3で割ってあまりがでた場合はゴミデータをくっつけることで8bit x 3に揃えることが分かる。
<br />
よって最終行の意味するところは、
<br />
</p>
<pre>7(=23バイト) + 3で揃える為にゴミデータが追加され、24バイトとして符号化された32文字 + (改行)
</pre>
<p class="paragraph">
となり、仕様通りであることが確認出来た。
<br />
</p>

<p class="paragraph">
この辺りでソースコード探索に入る：
<br />
</p>
<pre>$ locate uuencode
...
/usr/src/usr.bin/uuencode/uuencode.c
$ locate uudecode
...
/usr/src/usr.bin/uudecode/uudecode.c
</pre>

<h3 id="id9c119a">uuencode.cによる符号化処理</h3>

<p class="paragraph">
まずはuuencode.cを見てみる。シンプルな作りで、符号化の中心的な処理は次のコードが担当している。
<br />
</p>
<div class="hl-main"><pre><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> ENC is the basic 1 character encoding function to make a char printing </span><span class="hl-mlcomment">*/</span><span class="hl-code">
</span><span >#define</span><span class="hl-code"> </span><span class="hl-identifier">ENC</span><span class="hl-brackets">(</span><span class="hl-identifier">c</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-brackets">(</span><span class="hl-identifier">c</span><span class="hl-brackets">)</span><span class="hl-code"> ? </span><span class="hl-brackets">(</span><span class="hl-brackets">(</span><span class="hl-identifier">c</span><span class="hl-brackets">)</span><span class="hl-code"> &amp; </span><span class="hl-number">077</span><span class="hl-brackets">)</span><span class="hl-code"> + ' ': '`'</span><span class="hl-brackets">)</span><span ></span><span class="hl-code">
 
</span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment">
 * copy from in to out, encoding as you go along.
 </span><span class="hl-mlcomment">*/</span><span class="hl-code">
</span><span >static</span><span class="hl-code"> </span><span >void</span><span class="hl-code">
</span><span class="hl-identifier">encode</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">ch</span><span class="hl-code">, </span><span class="hl-identifier">n</span><span class="hl-code">;
    </span><span >char</span><span class="hl-code"> *</span><span class="hl-identifier">p</span><span class="hl-code">;
    </span><span >char</span><span class="hl-code"> </span><span class="hl-identifier">buf</span><span class="hl-brackets">[</span><span class="hl-number">80</span><span class="hl-brackets">]</span><span class="hl-code">;
 
    </span><span class="hl-reserved">while</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-brackets">(</span><span class="hl-identifier">n</span><span class="hl-code"> = </span><span class="hl-identifier">fread</span><span class="hl-brackets">(</span><span class="hl-identifier">buf</span><span class="hl-code">, </span><span class="hl-number">1</span><span class="hl-code">, </span><span class="hl-number">45</span><span class="hl-code">, </span><span class="hl-identifier">stdin</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> &gt; </span><span class="hl-number">0</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">ch</span><span class="hl-code"> = </span><span class="hl-identifier">ENC</span><span class="hl-brackets">(</span><span class="hl-identifier">n</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">putchar</span><span class="hl-brackets">(</span><span class="hl-identifier">ch</span><span class="hl-brackets">)</span><span class="hl-code"> == </span><span class="hl-identifier">EOF</span><span class="hl-brackets">)</span><span class="hl-code">
            </span><span class="hl-reserved">break</span><span class="hl-code">;
        </span><span class="hl-reserved">for</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">p</span><span class="hl-code"> = </span><span class="hl-identifier">buf</span><span class="hl-code">; </span><span class="hl-identifier">n</span><span class="hl-code"> &gt; </span><span class="hl-number">0</span><span class="hl-code">; </span><span class="hl-identifier">n</span><span class="hl-code"> -= </span><span class="hl-number">3</span><span class="hl-code">, </span><span class="hl-identifier">p</span><span class="hl-code"> += </span><span class="hl-number">3</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
            </span><span class="hl-identifier">ch</span><span class="hl-code"> = *</span><span class="hl-identifier">p</span><span class="hl-code"> &gt;&gt; </span><span class="hl-number">2</span><span class="hl-code">;
            </span><span class="hl-identifier">ch</span><span class="hl-code"> = </span><span class="hl-identifier">ENC</span><span class="hl-brackets">(</span><span class="hl-identifier">ch</span><span class="hl-brackets">)</span><span class="hl-code">;
            </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">putchar</span><span class="hl-brackets">(</span><span class="hl-identifier">ch</span><span class="hl-brackets">)</span><span class="hl-code"> == </span><span class="hl-identifier">EOF</span><span class="hl-brackets">)</span><span class="hl-code">
                </span><span class="hl-reserved">break</span><span class="hl-code">;
            </span><span class="hl-identifier">ch</span><span class="hl-code"> = </span><span class="hl-brackets">(</span><span class="hl-brackets">(</span><span class="hl-code">*</span><span class="hl-identifier">p</span><span class="hl-code"> &lt;&lt; </span><span class="hl-number">4</span><span class="hl-brackets">)</span><span class="hl-code"> &amp; </span><span class="hl-number">060</span><span class="hl-brackets">)</span><span class="hl-code"> | </span><span class="hl-brackets">(</span><span class="hl-brackets">(</span><span class="hl-identifier">p</span><span class="hl-brackets">[</span><span class="hl-number">1</span><span class="hl-brackets">]</span><span class="hl-code"> &gt;&gt; </span><span class="hl-number">4</span><span class="hl-brackets">)</span><span class="hl-code"> &amp; </span><span class="hl-number">017</span><span class="hl-brackets">)</span><span class="hl-code">;
            </span><span class="hl-identifier">ch</span><span class="hl-code"> = </span><span class="hl-identifier">ENC</span><span class="hl-brackets">(</span><span class="hl-identifier">ch</span><span class="hl-brackets">)</span><span class="hl-code">;
            </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">putchar</span><span class="hl-brackets">(</span><span class="hl-identifier">ch</span><span class="hl-brackets">)</span><span class="hl-code"> == </span><span class="hl-identifier">EOF</span><span class="hl-brackets">)</span><span class="hl-code">
                </span><span class="hl-reserved">break</span><span class="hl-code">;
            </span><span class="hl-identifier">ch</span><span class="hl-code"> = </span><span class="hl-brackets">(</span><span class="hl-brackets">(</span><span class="hl-identifier">p</span><span class="hl-brackets">[</span><span class="hl-number">1</span><span class="hl-brackets">]</span><span class="hl-code"> &lt;&lt; </span><span class="hl-number">2</span><span class="hl-brackets">)</span><span class="hl-code"> &amp; </span><span class="hl-number">074</span><span class="hl-brackets">)</span><span class="hl-code"> | </span><span class="hl-brackets">(</span><span class="hl-brackets">(</span><span class="hl-identifier">p</span><span class="hl-brackets">[</span><span class="hl-number">2</span><span class="hl-brackets">]</span><span class="hl-code"> &gt;&gt; </span><span class="hl-number">6</span><span class="hl-brackets">)</span><span class="hl-code"> &amp; </span><span class="hl-number">03</span><span class="hl-brackets">)</span><span class="hl-code">;
            </span><span class="hl-identifier">ch</span><span class="hl-code"> = </span><span class="hl-identifier">ENC</span><span class="hl-brackets">(</span><span class="hl-identifier">ch</span><span class="hl-brackets">)</span><span class="hl-code">;
            </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">putchar</span><span class="hl-brackets">(</span><span class="hl-identifier">ch</span><span class="hl-brackets">)</span><span class="hl-code"> == </span><span class="hl-identifier">EOF</span><span class="hl-brackets">)</span><span class="hl-code">
                </span><span class="hl-reserved">break</span><span class="hl-code">;
            </span><span class="hl-identifier">ch</span><span class="hl-code"> = </span><span class="hl-identifier">p</span><span class="hl-brackets">[</span><span class="hl-number">2</span><span class="hl-brackets">]</span><span class="hl-code"> &amp; </span><span class="hl-number">077</span><span class="hl-code">;
            </span><span class="hl-identifier">ch</span><span class="hl-code"> = </span><span class="hl-identifier">ENC</span><span class="hl-brackets">(</span><span class="hl-identifier">ch</span><span class="hl-brackets">)</span><span class="hl-code">;
            </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">putchar</span><span class="hl-brackets">(</span><span class="hl-identifier">ch</span><span class="hl-brackets">)</span><span class="hl-code"> == </span><span class="hl-identifier">EOF</span><span class="hl-brackets">)</span><span class="hl-code">
                </span><span class="hl-reserved">break</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code">
        </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">putchar</span><span class="hl-brackets">(</span><span class="hl-code">'\</span><span class="hl-identifier">n</span><span class="hl-code">'</span><span class="hl-brackets">)</span><span class="hl-code"> == </span><span class="hl-identifier">EOF</span><span class="hl-brackets">)</span><span class="hl-code">
            </span><span class="hl-reserved">break</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">ferror</span><span class="hl-brackets">(</span><span class="hl-identifier">stdin</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">
        </span><span class="hl-identifier">err</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">read error.</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">ch</span><span class="hl-code"> = </span><span class="hl-identifier">ENC</span><span class="hl-brackets">(</span><span class="hl-code">'\</span><span class="hl-number">0</span><span class="hl-code">'</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">(</span><span >void</span><span class="hl-brackets">)</span><span class="hl-identifier">putchar</span><span class="hl-brackets">(</span><span class="hl-identifier">ch</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">(</span><span >void</span><span class="hl-brackets">)</span><span class="hl-identifier">putchar</span><span class="hl-brackets">(</span><span class="hl-code">'\</span><span class="hl-identifier">n</span><span class="hl-code">'</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>
<p class="paragraph">
まずwhileから見てみる。
<br />
</p>
<pre>while ((n = fread(buf, 1, 45, stdin)) &gt; 0) {
</pre>
<p class="paragraph">
標準入力から、1バイト単位で45バイトを読み、&quot;char buf[80]&quot;に格納している。また&quot;int n&quot;には読み込まれたバイト数が格納される。なお入力ファイル名が指定された場合は、main()にて、freopen(3)を使って指定されたファイル名のファイルハンドルがstdinにセットされている。
<br />
続いてバイト数に対してENCマクロが適用される。
<br />
</p>
<pre>ch = ENC(n);
</pre>
<p class="paragraph">
この直後に&quot;putchar(ch)&quot;があることから、ここでENCマクロが返す値が、uuencodeで符号化された本体データ一行の、「バイト数を表す先頭一文字」であることが予想される。
<br />
</p>

<p class="paragraph">
ENCマクロの中身を見てみる。
<br />
</p>
<pre>#define ENC(c) ((c) ? ((c) &amp; 077) + &#039; &#039;: &#039;`&#039;)
</pre>
<p class="paragraph">
分解してみる。
<br />
</p>
<pre>if (c) {
    return ( (c) &amp; 077 ) + &#039; &#039;;
} else {
    return &#039;`&#039;;
}
</pre>
<p class="paragraph">
まずcが0の場合は、&#039;`&#039;が返される。なぜ&#039;`&#039;(ASCIIコード10進96)なのかはuudecodeの処理で明らかになる。
<br />
cが1以上の場合は、&#039;077&#039;がANDマスクされ、その結果に&#039; &#039;(SP, ASCIIコード10進32)を加算して返す。
<br />
&#039;077&#039;というのは、先頭に0が来ているので8進数(octal)である。ビットに戻せば、丁度
<br />
</p>
<pre>111 111 (binary)
  7   7 (octal)
</pre>
<p class="paragraph">
となり、6bitのマスクになることが分かる。
<br />
つまりENCマクロが、6bit分を取り出した値に32を足すという符号化処理を担当していることが分かる。
<br />
</p>
<pre>if (putchar(ch) == EOF)
    break;
</pre>
<p class="paragraph">
この&quot;putchar() -&gt; EOFならbreak&quot;という処理は以降のforループでも使われている。これは単純に、putchar()がEOFを返すという殆どあり得ない自体を想定した、万が一の予防線である。エラー処理を無視すれば、単純に&quot;int ch&quot; = ENCマクロの結果をputchar()して出力している、という意味になる。
<br />
</p>

<p class="paragraph">
これで、データ行の先頭１文字、その行に含まれている元データのバイト数を出力出来た。
<br />
以降forループで、元データを3バイト単位で処理していく。
<br />
</p>
<pre>for (p = buf; n &gt; 0; n -= 3, p += 3) {
</pre>
<p class="paragraph">
pはfreadで格納されたbufの先頭に初期化される。nはfreadで読み込んだバイト数。つまりこのforループで、バッファを3バイトずつ処理していくことになる。なお、条件判断の &quot;n &gt; 0&quot; と条件成立後に &quot;n -= 3&quot; していることから、もし読み込んだバイト数が3の倍数に満たない場合でも、余りの部分もこのループで処理されることが分かる。
<br />
</p>

<p class="paragraph">
ループの内部を見ていく。分かりやすいコードになっているので、コメントで解説を入れていく。
<br />
</p>
<pre>/* 2bit右シフトすることで、最初の1バイトの先頭6bitがchに代入される。 */
ch = *p &gt;&gt; 2;
ch = ENC(ch);
if (putchar(ch) == EOF) /* 24bit中6bit単位の1文字目を出力 */
    break;

/* (1) 最初の1バイトを4bit左シフト + 8進60でマスク
 * = 12345678 → 56780000 &amp; 110 000 → 00780000：最初の1バイトの下位2bit
 * (2) 2バイト目を4bit右シフト + 8進17でマスク
 * = 12345678 → 00001234 &amp; 001 111 → 00001234 : 2バイト目の上位4bit
 * (3) (1) OR (2)
 * = 00780000 OR 00001234 → 00781234
 * 以上で、24bit中6bit単位の2文字目を取得
 */
ch = ((*p &lt;&lt; 4) &amp; 060) | ((p[1] &gt;&gt; 4) &amp; 017);
ch = ENC(ch);
if (putchar(ch) == EOF) /* 24bit中6bit単位の2文字目を出力 */
    break;

/* (1) 2バイト目を2bit左シフト + 8進74でマスク
 * = 12345678 → 34567800 &amp; 111 100 → 00567800 : 2バイト目の下位4bit
 * (2) 3バイト目を6bit右シフト + 8進3でマスク
 * = 12345678 → 00000012 &amp; 000 011 → 00000012 : 3バイト目の上位2bit
 * (3) (1) OR (2)
 * = 00567800 OR 00000012 → 00567812
 * 以上で、24bit中6bit単位の3文字目を取得
 */
ch = ((p[1] &lt;&lt; 2) &amp; 074) | ((p[2] &gt;&gt; 6) &amp; 03);
ch = ENC(ch);
if (putchar(ch) == EOF) /* 24bit中6bit単位の3文字目を出力 */
    break;

/* 3バイト目を 8進77 でマスク
 * = 12345678 &amp; 111 111 → 00345678 : 3バイト目の下位6bit
 * 以上で、24bit中6bit単位の4文字目を取得
 */
ch = p[2] &amp; 077;
ch = ENC(ch);
if (putchar(ch) == EOF) /* 24bit中6bit単位の4文字目を出力 */
    break;
</pre>

<p class="paragraph">
以上で24bit単位で処理していく符号化の実装を理解出来た。
<br />
なお、データが読み込まれるバッファ領域がwhileループでは一切クリアされず、次々にfreadされていく点に注意したい。
<br />
例えば最後のwhileループで20バイト読み込まれたとすると、
<br />
</p>
<pre>buf[0] - buf[19]
</pre>
<p class="paragraph">
までは読み込まれたデータで上書きされるが、
<br />
</p>
<pre>buf[20] - buf[44]
</pre>
<p class="paragraph">
の間は、直前のfread()で読み込まれたデータが残ってしまっている。
<br />
するとforループの最後のループ処理では、
<br />
</p>
<pre>buf[18], buf[19], buf[20]
</pre>
<p class="paragraph">
が処理され、buf[20]が3の倍数に合わせる為にくっつくゴミデータとなることが分かる。
<br />
</p>

<p class="paragraph">
uuencodeによる符号化処理は以上となる。続いてuudecodeのソースから、復号化処理の内部を見てみる。
<br />
</p>

<h3 id="id752ba5">uudecode.cによる復号化処理</h3>

<p class="paragraph">
uudecodeはヘッダ行の検出や内容の妥当性チェックなどが入っている。本体データの復号化処理だけを抜き出してみる。
<br />
</p>
<div class="hl-main"><pre><span >static</span><span class="hl-code"> </span><span >int</span><span class="hl-code">
</span><span class="hl-identifier">decode</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">n</span><span class="hl-code">;
    </span><span >char</span><span class="hl-code"> </span><span class="hl-identifier">ch</span><span class="hl-code">, *</span><span class="hl-identifier">p</span><span class="hl-code">;
    </span><span >char</span><span class="hl-code"> </span><span class="hl-identifier">buf</span><span class="hl-brackets">[</span><span class="hl-identifier">MAXPATHLEN</span><span class="hl-brackets">]</span><span class="hl-code">;
    </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> ... </span><span class="hl-mlcomment">*/</span><span class="hl-code">
    </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> for each input line </span><span class="hl-mlcomment">*/</span><span class="hl-code">
    </span><span class="hl-reserved">for</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">;;</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">!</span><span class="hl-identifier">fgets</span><span class="hl-brackets">(</span><span class="hl-identifier">p</span><span class="hl-code"> = </span><span class="hl-identifier">buf</span><span class="hl-code">, </span><span class="hl-reserved">sizeof</span><span class="hl-brackets">(</span><span class="hl-identifier">buf</span><span class="hl-brackets">)</span><span class="hl-code">, </span><span class="hl-identifier">stdin</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
            </span><span class="hl-identifier">warnx</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">%s: short file.</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">filename</span><span class="hl-brackets">)</span><span class="hl-code">;
            </span><span class="hl-reserved">return</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code">
</span><span >#define</span><span class="hl-code"> </span><span class="hl-identifier">DEC</span><span class="hl-brackets">(</span><span class="hl-identifier">c</span><span class="hl-brackets">)</span><span class="hl-code">  </span><span class="hl-brackets">(</span><span class="hl-brackets">(</span><span class="hl-brackets">(</span><span class="hl-identifier">c</span><span class="hl-brackets">)</span><span class="hl-code"> - ' '</span><span class="hl-brackets">)</span><span class="hl-code"> &amp; </span><span class="hl-number">077</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> single character decode </span><span class="hl-mlcomment">*/</span><span ></span><span class="hl-code">
        </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment">
         * `n' is used to avoid writing out all the characters
         * at the end of the file.
         </span><span class="hl-mlcomment">*/</span><span class="hl-code">
        </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-brackets">(</span><span class="hl-identifier">n</span><span class="hl-code"> = </span><span class="hl-identifier">DEC</span><span class="hl-brackets">(</span><span class="hl-code">*</span><span class="hl-identifier">p</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> &lt;= </span><span class="hl-number">0</span><span class="hl-brackets">)</span><span class="hl-code">
                </span><span class="hl-reserved">break</span><span class="hl-code">;
        </span><span class="hl-reserved">for</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">++</span><span class="hl-identifier">p</span><span class="hl-code">; </span><span class="hl-identifier">n</span><span class="hl-code"> &gt; </span><span class="hl-number">0</span><span class="hl-code">; </span><span class="hl-identifier">p</span><span class="hl-code"> += </span><span class="hl-number">4</span><span class="hl-code">, </span><span class="hl-identifier">n</span><span class="hl-code"> -= </span><span class="hl-number">3</span><span class="hl-brackets">)</span><span class="hl-code">
            </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">n</span><span class="hl-code"> &gt;= </span><span class="hl-number">3</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
                </span><span class="hl-identifier">ch</span><span class="hl-code"> = </span><span class="hl-identifier">DEC</span><span class="hl-brackets">(</span><span class="hl-identifier">p</span><span class="hl-brackets">[</span><span class="hl-number">0</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code"> &lt;&lt; </span><span class="hl-number">2</span><span class="hl-code"> | </span><span class="hl-identifier">DEC</span><span class="hl-brackets">(</span><span class="hl-identifier">p</span><span class="hl-brackets">[</span><span class="hl-number">1</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code"> &gt;&gt; </span><span class="hl-number">4</span><span class="hl-code">;
                </span><span class="hl-identifier">putchar</span><span class="hl-brackets">(</span><span class="hl-identifier">ch</span><span class="hl-brackets">)</span><span class="hl-code">;
                </span><span class="hl-identifier">ch</span><span class="hl-code"> = </span><span class="hl-identifier">DEC</span><span class="hl-brackets">(</span><span class="hl-identifier">p</span><span class="hl-brackets">[</span><span class="hl-number">1</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code"> &lt;&lt; </span><span class="hl-number">4</span><span class="hl-code"> | </span><span class="hl-identifier">DEC</span><span class="hl-brackets">(</span><span class="hl-identifier">p</span><span class="hl-brackets">[</span><span class="hl-number">2</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code"> &gt;&gt; </span><span class="hl-number">2</span><span class="hl-code">;
                </span><span class="hl-identifier">putchar</span><span class="hl-brackets">(</span><span class="hl-identifier">ch</span><span class="hl-brackets">)</span><span class="hl-code">;
                </span><span class="hl-identifier">ch</span><span class="hl-code"> = </span><span class="hl-identifier">DEC</span><span class="hl-brackets">(</span><span class="hl-identifier">p</span><span class="hl-brackets">[</span><span class="hl-number">2</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code"> &lt;&lt; </span><span class="hl-number">6</span><span class="hl-code"> | </span><span class="hl-identifier">DEC</span><span class="hl-brackets">(</span><span class="hl-identifier">p</span><span class="hl-brackets">[</span><span class="hl-number">3</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">;
                </span><span class="hl-identifier">putchar</span><span class="hl-brackets">(</span><span class="hl-identifier">ch</span><span class="hl-brackets">)</span><span class="hl-code">;
            </span><span class="hl-brackets">}</span><span class="hl-code">
            </span><span class="hl-reserved">else</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
                </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">n</span><span class="hl-code"> &gt;= </span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
                    </span><span class="hl-identifier">ch</span><span class="hl-code"> = </span><span class="hl-identifier">DEC</span><span class="hl-brackets">(</span><span class="hl-identifier">p</span><span class="hl-brackets">[</span><span class="hl-number">0</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code"> &lt;&lt; </span><span class="hl-number">2</span><span class="hl-code"> | </span><span class="hl-identifier">DEC</span><span class="hl-brackets">(</span><span class="hl-identifier">p</span><span class="hl-brackets">[</span><span class="hl-number">1</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code"> &gt;&gt; </span><span class="hl-number">4</span><span class="hl-code">;
                    </span><span class="hl-identifier">putchar</span><span class="hl-brackets">(</span><span class="hl-identifier">ch</span><span class="hl-brackets">)</span><span class="hl-code">;
                </span><span class="hl-brackets">}</span><span class="hl-code">
                </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">n</span><span class="hl-code"> &gt;= </span><span class="hl-number">2</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
                    </span><span class="hl-identifier">ch</span><span class="hl-code"> = </span><span class="hl-identifier">DEC</span><span class="hl-brackets">(</span><span class="hl-identifier">p</span><span class="hl-brackets">[</span><span class="hl-number">1</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code"> &lt;&lt; </span><span class="hl-number">4</span><span class="hl-code"> | </span><span class="hl-identifier">DEC</span><span class="hl-brackets">(</span><span class="hl-identifier">p</span><span class="hl-brackets">[</span><span class="hl-number">2</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code"> &gt;&gt; </span><span class="hl-number">2</span><span class="hl-code">;
                    </span><span class="hl-identifier">putchar</span><span class="hl-brackets">(</span><span class="hl-identifier">ch</span><span class="hl-brackets">)</span><span class="hl-code">;
                </span><span class="hl-brackets">}</span><span class="hl-code">
                </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">n</span><span class="hl-code"> &gt;= </span><span class="hl-number">3</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
                    </span><span class="hl-identifier">ch</span><span class="hl-code"> = </span><span class="hl-identifier">DEC</span><span class="hl-brackets">(</span><span class="hl-identifier">p</span><span class="hl-brackets">[</span><span class="hl-number">2</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code"> &lt;&lt; </span><span class="hl-number">6</span><span class="hl-code"> | </span><span class="hl-identifier">DEC</span><span class="hl-brackets">(</span><span class="hl-identifier">p</span><span class="hl-brackets">[</span><span class="hl-number">3</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">;
                    </span><span class="hl-identifier">putchar</span><span class="hl-brackets">(</span><span class="hl-identifier">ch</span><span class="hl-brackets">)</span><span class="hl-code">;
                </span><span class="hl-brackets">}</span><span class="hl-code">
            </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
forによる無限ループで、標準入力から1行ずつ読み取りbufに格納している。
<br />
</p>
<pre>for (;;) {
    if (!fgets(p = buf, sizeof(buf), stdin)) {
</pre>
<p class="paragraph">
入力ファイル名が指定された場合は、main()にて、freopen(3)を使って指定されたファイル名のファイルハンドルがstdinにセットされているのはuuencodeの時と同様である。
<br />
</p>

<p class="paragraph">
続いてDECマクロが定義されている。
<br />
</p>
<pre>#define DEC(c)  (((c) - &#039; &#039;) &amp; 077) /* single character decode */
</pre>
<p class="paragraph">
これはuuencode.cのENCマクロの逆で、空白文字(ASCIIコード 10進32)を引いて、8進77 = 6bitのビットマスクを使い、6bit分を取り出している。
<br />
続く次のif文とbreakは、行の先頭文字をデコード = 元データのバイト数をnに格納し、もしそれが0(=本体データの終端)であればfor()ループを抜ける処理になっている。
<br />
</p>
<pre>if ((n = DEC(*p)) &lt;= 0)
    break;
</pre>
<p class="paragraph">
その後、以下のforブロックで行の2文字目以降=符号化されたデータを4文字単位で処理していく。
<br />
</p>
<pre>for (++p; n &gt; 0; p += 4, n -= 3)
</pre>
<p class="paragraph">
forブロックの中身については、uuencodeでのビット操作を逆転させていることが分かる。uuencodeでビットシフトやビットマスク処理を見ているので、uudecode側での細かい説明は省略する。
<br />
</p>

<p class="paragraph">
以上でuudecode側の復号化処理も見ることが出来た。
<br />
最後に、uuencode側のENCマクロで残っていた謎に決着をつける。
<br />
</p>

<h3 id="id8d9a95">0が&quot;`&quot;にエンコードされる理由</h3>

<p class="paragraph">
ここで、uuencode側でのENCマクロをもう一度見直したい。
<br />
</p>
<pre>#define ENC(c) ((c) ? ((c) &amp; 077) + &#039; &#039;: &#039;`&#039;)
</pre>
<p class="paragraph">
cが0の時、わざわざ&#039;`&#039;を返すようにしている。なぜ 0 + &#039; &#039;(ASCIIコード 10進32)をそのまま返さないのか？が謎として残っていた。
<br />
</p>

<p class="paragraph">
これについては「デーモン君のソース探検」にて歴史と絡めて解説されている。
<br />
簡単にまとめると、SystemV初期のuuencodeは空白文字にエンコードしていた。しかし当時のネットワークの一部に、行末の空白文字を削ってしまうメールゲートウェイがあったため、それに対応する為仕様が変更された。
<br />
空白文字でも、削除されない為の空白以外の文字でも、デコードすると同じ値に戻るように・・・それで採用されたのが&#039;`&#039;文字になる。
<br />
</p>

<p class="paragraph">
もう一度DECマクロを見てみる。
<br />
</p>
<pre>#define DEC(c)  (((c) - &#039; &#039;) &amp; 077)
</pre>
<p class="paragraph">
もしもcが空白文字の場合は、当然0になる。
<br />
cが&#039;`&#039;の場合：
<br />
</p>
<pre>&#039;`&#039; = ASCIIコード 10進96
→ &#039;`&#039; - &#039; &#039;(ASCIIコード10進32) = 10進64
→ 10進64を2進にすると、b1000000
→ 8進77 (111 111) でANDして下位6bitを取り出すと、000 000 = 0
</pre>
<p class="paragraph">
として、こちらも0になる。
<br />
</p>

<p class="paragraph">
このように、下位6bitを取り出してちょうど0になりかつ図形文字の範囲に収まっている&#039;`&#039;が、空白文字と互換を維持する為の代替として採用された。
<br />
</p>

<p class="paragraph">
今回のお題については、ここまで。
<br />
</p>

<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-543.html" title="C言語系/「デーモン君のソース探検」読書メモ/03, getchar(3)">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-545.html" title="C言語系/「デーモン君のソース探検」読書メモ/05, locate(1)">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-546.html" title="C言語系/「デーモン君のソース探検」読書メモ">Up</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-478.html" title="C言語系">C言語系</a>&nbsp;]</li>
</ul>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/544<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2007 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>