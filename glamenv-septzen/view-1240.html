<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>読書メモ/「めんどうくさいWebセキュリティ」 - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">読書メモ/「めんどうくさいWebセキュリティ」</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2013-10-13 19:35:24 &nbsp; / &nbsp; last updated at: 2013-10-13 19:39:23<br>
カテゴリ: <a href="category-59.html">HTTP</a>&nbsp;<a href="category-13.html">Web</a>&nbsp;<a href="category-23.html">セキュリティ</a>&nbsp;<a href="category-46.html">読書</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-1331.html" title="読書メモ/「まんがでわかる 7つの習慣」">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-879.html" title="読書メモ/「オペレーティングシステム入門」(CQ出版社)">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-404.html" title="読書">読書</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
邦題：「めんどうくさいWebセキュリティ」(原著：&quot;The Tangled Web: A Guide to Securing Modern Web Applications&quot;)
<br />
</p>

<p class="paragraph">
付箋挟んだ箇所のメモ書き。
<br />
</p>

<a href="https://www.amazon.co.jp/dp/4798128090" target="_blank">めんどうくさいWebセキュリティ | Michal Zalewski, 上野 宣, 新丈 径 |本 | 通販 | Amazon</a><br>

<a href="https://www.amazon.co.jp/dp/1593273886" target="_blank">Amazon | The Tangled Web: A Guide to Securing Modern Web Applications | Zalewski, Michal | Cryptography</a><br>

<hr />
<p class="paragraph">
以下、付箋メモ：
<br />
</p>


<p class="paragraph">
p37, 「もう一度、すべてをひとつに」の&quot;NOTE&quot;
<br />
&quot;Internet ExplorerはURL中の任意の箇所でスラッシュの代わりにバックスラッシュ(\)を使用することができます。&quot;
<br />
∑(ﾟДﾟ)　うそ～ん
<br />
</p>

<p class="paragraph">
p59, 「HTTP/0.9をサポートし続けていると……」
<br />
本文中の例だと、ブラウザは <a class="externallink" href="http://example.com:25/" target="_blank">http://example.com:25/</a> とかに誘導されたのか？実際にローカルで実験用のSMTPサーバを立ちあげてアクセスしてみたところ、確かにSMTPサーバからのエラー文字列がブラウザ上に表示された。ただし、使用したSMTPサーバ( <a class="externallink" href="http://nilhcem.github.io/FakeSMTP/" target="_blank">http://nilhcem.github.io/FakeSMTP/</a> )の仕様か、受け付けたコマンド文字列はエコーバックせず、エラーメッセージのみが表示された。
<br />
</p>

<p class="paragraph">
SMTPはあくまでも例であり、テキストベースのプロトコルを用いたサービス全般に対して、HTTP/0.9をサポートするUserAgentには同様の問題があると考えるべきか。
<br />
</p>

<p class="paragraph">
p59, 「改行文字の扱いにまつわる微妙な問題」
<br />
</p>
<pre>Set-Cookie: abc=[CR][CR]&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hi[CR][LF]
</pre>
<p class="paragraph">
→これ、適当なカスタムヘッダで試してみたけど、IE10で修正されたのか、ちゃんとCRCR以降は読み捨てされ、その後ろのHTMLコンテンツが表示されることは無かった。(F12による開発者コンソールで確認)
<br />
実験用ダミーサーバスクリプト(groovy):
<br />
</p>
<pre class="plugin_pre">
char cr = 0x0d;
char lf = 0x0a;
StringBuilder sb = new StringBuilder();
sb.append(cr);
sb.append(lf);
String crlf = sb.toString();
sb = new StringBuilder();
sb.append(cr);
sb.append(cr);
String crcr = sb.toString();

def server = new ServerSocket(5000);
while(true) {
    server.accept() { socket -&gt;
        socket.withStreams { input, output -&gt;
            // ignore input and just serve dummy content
            output.withWriter { writer -&gt;
                writer &lt;&lt; &quot;HTTP/1.1 200 OK&quot; + crlf;
                writer &lt;&lt; &quot;Content-Type: text/html&quot; + crlf;
                writer &lt;&lt; &quot;X-Custom-Header1: abc=def&quot; + crcr + &quot;hellohello&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hi&lt;/h1&gt;&lt;/body&gt;&quot; + crlf;
                writer &lt;&lt; &quot;Pragma: nocache&quot; + crlf + crlf;
                writer &lt;&lt; &quot;&lt;html&gt;&lt;body&gt;Hello World! It&#039;s ${new Date()}&lt;/body&gt;&lt;/html&gt;&quot;;
            }
        }
    }
}
</pre>

<p class="paragraph">
64p, 「セミコロンで区切られたヘッダの値」
<br />
66p, 「ヘッダの文字セットとエンコーディングスキーム」
<br />
この辺は、アップロードされたファイルを、任意のファイル名でダウンロードするようなWebサイトを作った経験がある人なら大いに参考になりそう。「日本語ファイル名の扱い」という地雷もあるし、ブラウザのサポート状況などかなり悩ましい問題。&quot;Content-Disposition&quot;を扱う時はこのあたりを一読しておいて損はない。
<br />
</p>

<p class="paragraph">
68p, 「Refererヘッダの振る舞い」
<br />
Refererヘッダが含まれないのはどんな時か、というのが端的にまとめられているので、サーバ側でRefererヘッダを何かしらの処理に使う時は、一度さっと目を通しておくと良いかも。
<br />
</p>

<p class="paragraph">
79p,「キャッシュの振る舞い」
<br />
セキュリティを考慮する必要のない静的なコンテンツについてキャッシュさせたい、あるいは逆に、センシティブな情報を動的に出力するプログラムでキャッシュを無効化したい、などの場合に一読しておくと良いかも。また企業ネットワークで使う想定の場合、途中のProxyでのキャッシュも想定すると、HTTPSにするとかも必要かも。「スターバックスでPCを使ったあとには、ブラウザキャッシュを削除しておくというのは非常によい考え」・・・昨今ならスマホのブラウザのキャッシュも該当するかも？
<br />
</p>

<p class="paragraph">
81p,「HTTPクッキーのセマンティクス」
<br />
&quot;HTTP仕様ではクッキー値はquoted-string形式を使用するものと述べられている（～）のに対して、この構文を実際に識別するのがFirefoxとOperaだけである点があります。&quot;
<br />
う～ん・・・以下のスクリプトでFirefox 24.0 / IE 10.0 で試してみたが、いずれも引用符(0x22)含みのCookie、ちゃんと引用符として扱ってくれて、FFとIEで引用符の認識で差が出てるようには見えなかった・・・。ひとまず、スペース(0x20)含ませてみたところ、そこで終わりにせずちゃんとスペースの後ろまで値として認識してくれたのが面白かった(FF/IE共)。
<br />
</p>
<pre class="plugin_pre">
def server = new ServerSocket(5000);
while(true) {
    server.accept() { socket -&gt;
        socket.withStreams { input, output -&gt;
            // ignore input and just serve dummy content
            output.withWriter { writer -&gt;
                writer &lt;&lt; &quot;HTTP/1.1 200 OK\r\n&quot;;
                writer &lt;&lt; &quot;Content-Type: text/html\r\n&quot;;
                writer &lt;&lt; &quot;Set-Cookie: foo1=include space1\r\n&quot;;
                writer &lt;&lt; &quot;Set-Cookie: foo2=\&quot;include space2\&quot;\r\n&quot;;
                writer &lt;&lt; &quot;Set-Cookie: abc=\&quot;12 3\\\&quot;45 6\&quot;\r\n&quot;;
                writer &lt;&lt; &quot;Set-Cookie: def=ABC\&quot;DEF\r\n&quot;;
                writer &lt;&lt; &quot;\r\n&quot;;
                writer &lt;&lt; &quot;&lt;html&gt;&lt;body&gt;Hello World! It&#039;s ${new Date()}&quot;;
                writer &lt;&lt; &quot;&lt;script&gt;alert(document.cookie);&lt;/script&gt;\r\n&quot;;
                writer &lt;&lt; &quot;&lt;/body&gt;&lt;/html&gt;&quot;;
            }
        }
    }
}
</pre>


<p class="paragraph">
86p,「HTTP認証」
<br />
「～そのスレッドを閲覧しているユーザーには、いきなりよくわからないパスワード要求画面が表示されます。～」
<br />
こ、こえ～
<br />
</p>

<p class="paragraph">
91p,「セキュリティエンジニアリングチェック表」
<br />
→Content-DispositionヘッダーとSet-Cookieのセクションは読んでおいて損はない。
<br />
</p>

<p class="paragraph">
100p,「HTMLパーサーの振る舞いを理解する」
<br />
「おおっ！？」ってなったのが、
<br />
</p>
<pre>&lt;img ... title=&quot;&quot;onerror=&quot;alert(1)&quot;&gt;
</pre>
<p class="paragraph">
に続く、
<br />
</p>
<pre>&lt;img ... title=``onerror=`alert(1)`&gt;
</pre>
<p class="paragraph">
の例。バッククォートも認識されるらしい。
<br />
・・・が、IE10で試してみたところ、以下のエラーが開発者ツールのコンソールに表示され、alert()は動作しなかった。
<br />
「HTML1410: 引用符で囲まれていない属性値が無効です。引用符で囲まれていない属性値に (&quot;)、(&#039;)、(&lt;)、(=)、または (`) を含めることはできません。 」
<br />
</p>


<p class="paragraph">
IEの場合の等号(&quot;=&quot;)処理も驚き。
<br />
</p>
<pre>&lt;img src=test.jpg?value=&quot;&gt;Yes, we are still inside a tag!&quot;&gt;
</pre>
<p class="paragraph">
・・・だが、これもIE10で試したところ、互換モードを色々いじってみても&quot;&gt;Yes, we are...&quot;はちゃんとタグの外になり、属性としては認識されていない。
<br />
</p>

<p class="paragraph">
103p,「エンティティエンコーディング」(Entity Encoding)
<br />
HTMLの属性内でのEntityEncodingを行う場合は、ここのセクションに目を通しておく必要がありそう。
<br />
またXHTMLを使う場合はさらに注意が必要。
<br />
</p>

<p class="paragraph">
120p,「@ディレクティブとXBLバインディング」
<br />
FirefoxではXBLというのがあるんだ・・・。
<br />
</p>

<p class="paragraph">
144p,「標準オブジェクト階層」
<br />
「location.*データを使用して、新規に文字列（特にHTMLもしくはJavaScriptコード）を構築する際には、何らかの方法でこれがエスケープされていると仮定することは危険なので注意してください。」
<br />
</p>

<p class="paragraph">
151p,「スクリプトの文字エンコーディング」
<br />
「エスケープコードは識別子のなかでのみ使用可能であり、構文に影響をおよぼす記号を置き換えても動作はしません。」
<br />
</p>
<pre>\u0061lert(&quot;...&quot;);
</pre>
<p class="paragraph">
→XSSを防ぐために、入り口でBlackList的に&quot;alert&quot;などの識別子をフィルタリングorブロックしようとすると、この仕様により簡単にすり抜けてしまう。
<br />
</p>


<p class="paragraph">
158p,「プレーンテキストファイル」
<br />
「JavaScriptの正式なMIMEタイプはapplication/javascriptです。これはRFC4329で規定されています。」
<br />
・・・ホンマや・・・。ってか、&quot;application/ecmascript&quot;(拡張子 &quot;.es&quot;)というのもあるのか・・・。
<br />
</p>


<p class="paragraph">
192p,「document.domain」
<br />
えっ、document.domain って上書き出来るの！？
<br />
ただし、お互いに通信しようとする双方で合わせる必要があるらしい。
<br />
</p>

<p class="paragraph">
195p,「ブラウザの認証情報とのやり取り」
<br />
・・ここの、CSRFでログインさせ、「自傷行為」と呼ばれるXSS脆弱性を悪用するシナリオが、よく理解できません・・・。どこでどうSOPの同期状態が関連するのか？
<br />
</p>

<p class="paragraph">
196p,「XMLHttpRequestにおける同一生成元ポリシー」
<br />
XMLHttpRequestのsetRequestHeader()で設定できるヘッダと、BlackList対策について。
<br />
</p>


<p class="paragraph">
201p, 「クッキーのセキュリティポリシー」
<br />
</p>

<p class="paragraph">
Cookieのpath属性があてにならない「こともある」という表現が使われているが、path属性はあくまでもCookieの有効範囲でしか影響せず、JavaScriptのSOPはpath制限なんて無いためそちらで自由に触られる、という話か？path属性を指定していても役に立たない、具体的なケースがイメージ出来ない・・・。path属性の制限がブラウザによりぶっ壊れてる、とかなら分かりやすいのだけれど、JS側のSOPとの食い違いでどんな影響が出るのかが分からない。&quot;<a class="externallink" href="http://asp.example.com/fooCompnay/" target="_blank">http://asp.example.com/fooCompnay/</a>&quot; と &quot;<a class="externallink" href="http://asp.example.com/barCompany/" target="_blank">http://asp.example.com/barCompany/</a>&quot; とで、Cookieはpath属性で分離されてても、JSでのXHRなどは素通しされてしまう、というようなことを言っているのだろうか？
<br />
</p>

<p class="paragraph">
secure属性についても言及有り。HTTPとHTTPSで、同じ名前のCookieをsecure属性無し/有りで管理すると混乱しそう。
<br />
</p>

<p class="paragraph">
211p,「ポリシーフィアルとスニッフィングのリスク」
<br />
</p>

<p class="paragraph">
Adobeのcrossdomain.xml、およびMicrosoft Silverlightでの注意点について。
<br />
</p>

<p class="paragraph">
228p,「javascript:URLとvbscript:URLにおける継承」
<br />
いわゆる「ブックマークレット」で、アドレスバーでjavascript:スキームに遷移すると、遷移前のドキュメントのSOPでJavaScriptが動作しますが、それの危険性について。
<br />
遷移の方法によって、さらにブラウザによって、拒否したりSOPの継承もとが変化したりと複雑。
<br />
</p>

<p class="paragraph">
236p,「フレームハイジャック」
<br />
生成元とフレームの遷移に関する、鬱になるようなややこしい話題。ちなみに、ここではあくまでもフレーム間の遷移アクションについての解説になっており、「クリックジャッキング」については 240p からの「不要なフレーム表示」で解説されてる。
<br />
</p>

<p class="paragraph">
243p,「ドメインを超えたコンテンツのインクルード」
<br />
CSS構文解析でのフォールトトレランス性の高さに起因する、クロスドメインでCSSを読み込んだ場合に発生しうる重要情報の漏えいについて。
<br />
→ちょっとわかりづらかったので、解説されてるシナリオを噛み砕くとこういう状況で合ってるか？
<br />
1. サイトAでは、ログインしているユーザに紐づく重要情報を表示するページA-1があり、そこにはユーザが入力された文字列が表示される箇所がある。特にこのシナリオでは、URLパラメータに渡された文字列がレスポンスHTML中に出力される。
<br />
2. 上記ページA-1では、URLパラメータに渡す文字列を工夫することで、CSSとして誤って解釈した場合に、&quot;background-image&quot; のURLとして重要情報が含まれてしまうような挙動をしてしまう。
<br />
3. サイトBは攻撃者が用意した罠サイトで、サイトAのページA-1をわざとCSSとしてインクルードするようになっている。この時、2.で説明したようにして、&quot;background-image&quot; のURLで攻撃者のサイトを引っ張ってくるようにしておく。これにより、&quot;background-image&quot;のリソースをブラウザがロードする際に、攻撃者のサイト上のURLにアクセスすることになるが、URLの後ろにCSSとして誤って解釈された、重要情報のHTMLソースが付加されてしまう。
<br />
4. 攻撃者はサイトBに、被害者のブラウザを誘導する。
<br />
5. 被害者のブラウザが既にサイトAでログイン済みだった場合、CSSとしてページA-1を読み込む。「被害者に紐づく」重要情報が出力されたページA-1は、攻撃者が埋め込んでおいたURLパラメータにより誤ってCSSとして解釈され、&quot;background-image&quot; のURLをロードする際に、被害者に紐付いた重要情報をURLに付加して、攻撃者のサーバにリクエストを送信する。
<br />
6. 攻撃者は被害者の重要情報を不正に入手する。
<br />
</p>

<p class="paragraph">
268p, 「Content-Typeの特殊な値」
<br />
今度、ファイルを添付ファイルとしてDLさせるWebアプリを作る場合、今度は &quot;application/octet-stream&quot; ではなくて、&quot;application/binary&quot; を使おう・・・。
<br />
また、PATH_INFOによるコンテンツの誤認識にも注意。
<br />
</p>

<p class="paragraph">
292p,「ポップアップフィルタ」
<br />
最近は目にすること少なくなった・・・と思うんですが、なんかFacebookとかGoogleのOAuth認証使うサイトでたまに見たりします。
<br />
大分制限が加えられているようですが、この辺を扱う際は、ここを読んでおくと良さそうです。
<br />
</p>

<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-1331.html" title="読書メモ/「まんがでわかる 7つの習慣」">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-879.html" title="読書メモ/「オペレーティングシステム入門」(CQ出版社)">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-404.html" title="読書">読書</a>&nbsp;]</li>
</ul>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/1240<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2007 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>