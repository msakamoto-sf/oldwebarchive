<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>日記/2011/02/28/System.Reflection.Emitでの動的コード生成が謎の挙動を示す。 - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">日記/2011/02/28/System.Reflection.Emitでの動的コード生成が謎の挙動を示す。</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2011-02-28 17:32:58 &nbsp; / &nbsp; last updated at: 2011-02-28 17:43:15<br>
カテゴリ: <a href="category-56.html">.NET</a>&nbsp;</div>

<div class="data_body">
<p class="paragraph">
<a href="./view-925.html" >読書メモ/&quot;Advanced .NET Debugging&quot;</a>で紹介した&quot;ADND本&quot;だが、Chapter4のサンプル、04CodeGenがおかしな挙動を示す。
<br />
System.Reflection.Emitを使って、DynamicMethodとILGeneratorとで実行時にCLRのコードを出力しメソッドを作り、JITコンパイルを経て実際に呼んでみるサンプル。どんなコードを出力するかというと、int引数を二つ取り、足し算した結果を返すだけのシンプルなコードだ。
<br />
04CodeGen.cs:
<br />
</p>
<pre class="plugin_pre">
using System;
using System.Text;
using System.Reflection.Emit;

namespace Advanced.NET.Debugging.Chapter4
{
    class CodeGen
    {
        private delegate int Add(int a, int b);

        public static void Main()
        {
            Type[] args={typeof(int), typeof(int)};
            DynamicMethod dyn = new 
                DynamicMethod(&quot;Add&quot;, 
                              typeof(int), 
                              new Type[] { typeof(int), typeof(int) }, 
                              typeof(CodeGen), 
                              true);
            ILGenerator gen = dyn.GetILGenerator();
            gen.Emit(OpCodes.Ldarg_1);
            gen.Emit(OpCodes.Ldarg_2);
            gen.Emit(OpCodes.Add);
            gen.Emit(OpCodes.Ret);

            Add a= (Add) dyn.CreateDelegate(typeof(Add));
            Console.WriteLine(&quot;Press any key to invoke Add method&quot;);
            Console.ReadKey();
            int ret = a(1, 2);
            Console.WriteLine(&quot;1+2={0}&quot;, ret);
        }
    }
}
</pre>
<p class="paragraph">
・・・が。
<br />
</p>
<pre>&gt; 04CodeGen.exe
Press any key to invoke Add method
1+2=4
</pre>

<pre>( ﾟдﾟ)ﾎﾟｶｰﾝ

(つд⊂)ｺﾞｼｺﾞｼ

( ﾟДﾟ)・・・はぁぁああ！！？？？
</pre>

<p class="paragraph">
デバッグしてみる。環境はWin7(32bit)でCLR2.0(.NET 2.0, 3.0, 3.5) + CLR4.0両方入り。
<br />
</p>


<pre class="plugin_pre">
Microsoft (R) Windows Debugger Version 6.12.0002.633 X86
Copyright (c) Microsoft Corporation. All rights reserved.

CommandLine: 04CodeGen.exe
Symbol search path is: ...
Executable search path is: 
ModLoad: 00e40000 00e48000   04CodeGen.exe
ModLoad: 77ac0000 77bfd000   ntdll.dll
ModLoad: 71ed0000 71f1a000   C:\Windows\SYSTEM32\MSCOREE.DLL
ModLoad: 76440000 76514000   C:\Windows\system32\KERNEL32.dll
ModLoad: 75d50000 75d9a000   C:\Windows\system32\KERNELBASE.dll
(1ca8.284): Break instruction exception - code 80000003 (first chance)
eax=00000000 ebx=00000000 ecx=0028f3d8 edx=77b06344 esi=fffffffe edi=00000000
eip=77b5ebbe esp=0028f3f4 ebp=0028f420 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
ntdll!LdrpDoDebuggerBreak+0x2c:
77b5ebbe cc              int     3
0:000&gt; g
ModLoad: 761c0000 76260000   C:\Windows\system32\ADVAPI32.dll
...
ModLoad: 6c5a0000 6c5fb000   C:\Windows\Microsoft.NET\Framework\v2.0.50727\mscorjit.dll
</pre>
<p class="paragraph">
&quot;Press any key to invoke Add method&quot;が表示されたところでCTRL-BREAKでDebuggerに戻す。
<br />
</p>
<pre class="plugin_pre">
(1ca8.1c34): Break instruction exception - code 80000003 (first chance)
eax=7ffdb000 ebx=00000000 ecx=00000000 edx=77b5d7eb esi=00000000 edi=00000000
eip=77af3370 esp=03c8ff44 ebp=03c8ff70 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
ntdll!DbgBreakPoint:
77af3370 cc              int     3
0:003&gt; .loadby sos mscorwks
0:003&gt; .load sosex
0:003&gt; bp mscorjit!CILJit::compileMethod
0:003&gt; g
Breakpoint 0 hit
eax=6c5f7268 ebx=0028e7f8 ecx=6c5e514c edx=00000011 esi=003763d0 edi=00000000
eip=6c5a5dbb esp=0028e63c ebp=0028e6a4 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
mscorjit!CILJit::compileMethod:
6c5a5dbb 55              push    ebp
0:000&gt; kb 3
ChildEBP RetAddr  Args to Child              
0028e638 6967cacc 6c5f7268 0028e7f8 0028e770 mscorjit!CILJit::compileMethod
0028e6a4 6967cb65 00391f18 0028e7f8 0028e770 mscorwks!invokeCompileMethodHelper+0x72
0028e6e8 6967cbd8 00391f18 0028e7f8 0028e770 mscorwks!invokeCompileMethod+0x31
0:000&gt; dd 0028e770 
0028e770  00153208 001535f9 00392978 00000004
          ^^^^^^^^ これを&quot;!dumpmd&quot;する
...
0:000&gt; !dumpmd 00153208 
Method Name: DynamicClass.Add(Int32, Int32)
Class: 00153164
MethodTable: 001531c8
mdToken: 06000000
Module: 00152c5c
IsJitted: no
CodeAddr: ffffffff
0:000&gt; !dumpil 00153208 
This is dynamic IL. Exception info is not reported at this time.
If a token is unresolved, run &quot;!do &lt;addr&gt;&quot; on the addr given
in parenthesis. You can also look at the token table yourself, by
running &quot;!DumpArray 01a5755c&quot;.

IL_0000: ldarg.1 
IL_0001: ldarg.2 
IL_0002: add 
IL_0003: ret 
</pre>
<p class="paragraph">
IL自体も書籍と実際のソースの通りなんだけど。
<br />
</p>
<pre class="plugin_pre">
0:000&gt; !bpmd -md 00153208 
MethodDesc = 00153208
This DynamicMethodDesc is not yet JITTED. Placing memory breakpoint at 00153228
0:000&gt; g
Unable to insert breakpoint 2 at 0018ce80, Win32 error 0n299
    &quot;ReadProcessMemory 要求または WriteProcessMemory 要求の一部だけを完了しました。&quot;
The breakpoint was set with BP.  If you want breakpoints
to track module load/unload state you must use BU.
bp2 at 0018ce80 failed
WaitForEvent failed
eax=00000000 ebx=002e00a8 ecx=00153228 edx=0018ce80 esi=00000000 edi=00000008
eip=695319c4 esp=0028eadc ebp=0028eae8 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
mscorwks!CompareExchangeMP+0x8:
695319c4 c20400          ret     4
</pre>
<p class="paragraph">
メッセージが気になるけど、とりあえず止まってくれたのでもう一度&quot;!dumpmd&quot;してJITされたコードを逆アセンブルしてみる。
<br />
</p>
<pre class="plugin_pre">
0:002&gt; !dumpmd 00153208 
Method Name: DynamicClass.Add(Int32, Int32)
Class: 00153164
MethodTable: 001531c8
mdToken: 06000000
Module: 00152c5c
IsJitted: yes
CodeAddr: 002e00a8
          ^^^^^^^^ これを&quot;!U&quot;してみる。
0:002&gt; !U 002e00a8
Normal JIT generated code
DynamicClass.Add(Int32, Int32)
Begin 002e00a8, size 24
&gt;&gt;&gt; 002e00a8 55              push    ebp
002e00a9 8bec            mov     ebp,esp
002e00ab 83ec08          sub     esp,8
002e00ae 894dfc          mov     dword ptr [ebp-4],ecx
002e00b1 8955f8          mov     dword ptr [ebp-8],edx
002e00b4 833d142e150000  cmp     dword ptr ds:[152E14h],0
002e00bb 7405            je      002e00c2
002e00bd e867b24a69      call    mscorwks!JIT_DbgIsJustMyCode (6978b329)
002e00c2 8b45f8          mov     eax,dword ptr [ebp-8]
^^^^^^^^ ここにbpしてみる。
002e00c5 030424          add     eax,dword ptr [esp]
002e00c8 8be5            mov     esp,ebp
002e00ca 5d              pop     ebp
002e00cb c3              ret
0:002&gt; bl
 0 e 6c5a5dbb     0001 (0001)  0:**** mscorjit!CILJit::compileMethod
 2 e 0018ce80     0001 (0001)  0:**** 
0:002&gt; bc 0
0:002&gt; bc 2
0:002&gt; bl
0:002&gt; bp 002e00c2 
0:002&gt; g
Breakpoint 0 hit
eax=00153208 ebx=0028ed2c ecx=00000001 edx=00000002 esi=003763d0 edi=00000000
eip=002e00c2 esp=0028ec60 ebp=0028ec68 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
002e00c2 8b45f8          mov     eax,dword ptr [ebp-8] ss:0023:0028ec60=00000002
0:000&gt; p
eax=00000002 ebx=0028ed2c ecx=00000001 edx=00000002 esi=003763d0 edi=00000000
eip=002e00c5 esp=0028ec60 ebp=0028ec68 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
002e00c5 030424          add     eax,dword ptr [esp]  ss:0023:0028ec60=00000002
0:000&gt; p
eax=00000004 ebx=0028ed2c ecx=00000001 edx=00000002 esi=003763d0 edi=00000000
eip=002e00c8 esp=0028ec60 ebp=0028ec68 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
002e00c8 8be5            mov     esp,ebp
</pre>
<p class="paragraph">
・・・この時点でEAX=4となっている。
<br />
詳しいデバッグログは省くが、このルーチンに入った時点ではECX = 第一引数, EDX=第二引数がセットされている。つまり
<br />
ECX = 1, EDX = 2
<br />
となっている。
<br />
</p>

<pre>sub     esp,8
mov     dword ptr [ebp-4],ecx
mov     dword ptr [ebp-8],edx
</pre>

<p class="paragraph">
で、この時点でECX, EDX がそれぞれEBPからの相対位置を使ってコピーされる。
<br />
なので、
<br />
</p>
<pre>mov     eax,dword ptr [ebp-8]
</pre>
<p class="paragraph">
この次の
<br />
</p>
<pre>add     eax,dword ptr [esp]
</pre>
<p class="paragraph">
は、本来は
<br />
</p>
<pre>add     eax,dword ptr [ebp-4]
</pre>
<p class="paragraph">
じゃないとおかしくないか？
<br />
</p>

<p class="paragraph">
Visual C# 2008 Express Edition (.NET Framework 3.5)でコンパイルしてみる：
<br />
</p>
<pre class="plugin_pre">
&gt; csc 04CodeGen.cs
Microsoft (R) Visual C# 2008 Compiler version 3.5.30729.4926
for Microsoft (R) .NET Framework version 3.5
Copyright (C) Microsoft Corporation. All rights reserved.

&gt; 04CodeGen.exe
Press any key to invoke Add method
1+2=71
</pre>

<pre>(  д )   ﾟ ﾟ
</pre>


<p class="paragraph">
Visual C# 2010 Express Edition (CLR 4)でコンパイルしてみる：
<br />
</p>
<pre class="plugin_pre">
&gt; csc 04CodeGen.cs
Microsoft (R) Visual C# 2010 Compiler version 4.0.30319.1
Copyright (C) Microsoft Corporation. All rights reserved.

&gt; 04CodeGen.exe
Press any key to invoke Add method
1+2=75
</pre>

<pre>(    )       д         ﾟ ﾟ
</pre>

<p class="paragraph">
謎。とりあえずこの機能、使わないでおこう・・・。<br />
</p>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/926<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2001 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a target="_blank" href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" target="_blank" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>