<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>技術/HTTP/URLエンコードで 0x20(スペース) を &quot;+&quot; にすべきか &quot;%20&quot; にすべきか - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">技術/HTTP/URLエンコードで 0x20(スペース) を &quot;+&quot; にすべきか &quot;%20&quot; にすべきか</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2013-03-23 22:18:13 &nbsp; / &nbsp; last updated at: 2017-11-19 16:15:33<br>
カテゴリ: <a href="category-19.html">HTML</a>&nbsp;<a href="category-59.html">HTTP</a>&nbsp;<a href="category-30.html">ネットワーク</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-1350.html" title="技術/HTTP/REST設計思想の &quot;Stateless&quot; との付き合い方">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-1009.html" title="技術/HTTP/セッション固定化関連メモ(SessionFixation,SessionAdoption)">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-23.html" title="技術">技術</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
※時間がないとか、だらだらとRFCの解説を読んでる暇が無い方は、末尾のまとめ部分だけ目を通していただければ十分かと。
<br />
</p>

<p class="paragraph">
URLのpath中やquery中、POSTリクエストボディ中で、0x20のスペースを、&quot;+&quot;に変換するのが「正しい」のか、&quot;%20&quot;にするのが「正しい」のか、わからなくなってきたのでちょっと調べてみました。
<br />
ただしRFCの全文を熟読してるわけではないので、言い回しや表現はもとより理解そのものが間違ってる可能性もあるので、話半分程度に参考にしてください。
<br />
</p>

<p class="paragraph">
&quot;+&quot;を使うべきか、&quot;%20&quot;を使うべきか、よく迷う箇所：
<br />
</p>
<ul><li> URLのパス中</li>
<li> URLのクエリ中</li>
<li> &quot;application/x-www-form-urlencoded&quot; 形式中<ul><li> URLのクエリ中</li>
<li> POSTメソッドのリクエストボディ中</li></ul></li></ul>

<p class="paragraph">
stackoverflowでも、特にPHPで「rawurlencode()とurlencode()あるけど、どう違うんだよ！？」というのでよく質問されるようです。
<br />
</p>

<ul><li> urlencode - when to encode space to plus (+) and when to %20? - Stack Overflow<ul><li> <a class="externallink" href="http://stackoverflow.com/questions/2678551/when-to-encode-space-to-plus-and-when-to-20" target="_blank">http://stackoverflow.com/questions/2678551/when-to-encode-space-to-plus-and-when-to-20</a></li></ul></li>
<li> html - In a URL Should spaces be encoded using %20 or +? - Stack Overflow<ul><li> <a class="externallink" href="http://stackoverflow.com/questions/1211229/in-a-url-should-spaces-be-encoded-using-20-or" target="_blank">http://stackoverflow.com/questions/1211229/in-a-url-should-spaces-be-encoded-using-20-or</a></li></ul></li>
<li> PHP - urlencode vs rawurlencode? - Stack Overflow<ul><li> <a class="externallink" href="http://stackoverflow.com/questions/996139/php-urlencode-vs-rawurlencode" target="_blank">http://stackoverflow.com/questions/996139/php-urlencode-vs-rawurlencode</a></li></ul></li></ul>

<p class="paragraph">
<strong>2017-11-19追記 : URIのエスケープについて、その歴史や微妙な差異など、こちらの調査報告が非常に精密にまとめられているのでオススメです！</strong>
<br />
</p>
<ul><li> &quot;9 URIのエスケープ&quot;, 情報セキュリティ技術動向調査（2009 年下期）：IPA 独立行政法人 情報処理推進機構<ul><li> <a class="externallink" href="https://www.ipa.go.jp/security/fy21/reports/tech1-tg/b_09.html" target="_blank">https://www.ipa.go.jp/security/fy21/reports/tech1-tg/b_09.html</a></li>
<li> もう、この資料があればこの記事要らなかったんじゃないかというほど詳しいです。</li></ul></li></ul>

<p class="paragraph">
<strong>2014-03-16追記 : PHPのurlencode()とrawurlencode()の詳しい経緯についてはこのスライドがスゴイ！</strong>
<br />
</p>
<ul><li> お前は PHP の歴史的な理由の数を覚えているのか<ul><li> <a class="externallink" href="http://www.slideshare.net/ebihara/php-32340906" target="_blank">http://www.slideshare.net/ebihara/php-32340906</a></li></ul></li></ul>



<p class="paragraph">
目次：
<br />
</p>
<ul><li><a href="#iddbc6ef">RFC1738, Uniform Resource Locators (URL), 1994-12</a></li>
<li><a href="#id0ca1f0">RFC1808, Relative Uniform Resource Locators, 1995-06</a></li>
<li><a href="#idd57437">RFC2396, Uniform Resource Identifiers (URI): Generic Syntax, 1998-08</a></li>
<li><a href="#id5ea2f0">RFC3986, Uniform Resource Identifier (URI): Generic Syntax, 2005-01</a></li>
<li><a href="#ida66133">URLを組み立てる側と、解析する側の食い違い</a></li>
<li><a href="#ida0b625">スペースを&quot;+&quot;にするのは &quot;application/x-www-form-urlencoded&quot; 由来？</a></li>
<li><a href="#id074ee9">PHPでは&quot;+&quot;をどう受け付けるか</a></li>
<li><a href="#id296b0c">Java Servletでは&quot;+&quot;をどう受け付けるか</a></li>
<li><a href="#idb2ebd3">java.net.URLENcoderはどうなっているか</a></li>
<li><a href="#id9c3a4f">java.net.URLEncoderを実際に使ってみる</a><ul><li><a href="#idd8a9f9">URLエンコードの練習</a></li></ul></li>
<li><a href="#idb783f7">収拾がつかなくなってきたのでまとめ</a></li></ul>
<hr />
<h3 id="iddbc6ef">RFC1738, Uniform Resource Locators (URL), 1994-12</h3>

<p class="paragraph">
&quot;URLエンコード&quot;について扱う様々な記事から参照されてるRFCその1(多分)。
<br />
</p>

<p class="paragraph">
<a class="externallink" href="http://www.ietf.org/rfc/rfc1738.txt" target="_blank">http://www.ietf.org/rfc/rfc1738.txt</a>
<br />
</p>

<p class="paragraph">
RFC1738ではHTTPの他にFTP/GOPHER/TELNETなど様々なスキームでのURLを取り上げてます。
<br />
その中で、以下の記号はURLを解析するときの区切り文字とかに使う特殊文字として定義されてます。なので、ホスト名とかパス中とかクエリ中には、使えないっぽい。
<br />
</p>
<pre>reserved       = &quot;;&quot; | &quot;/&quot; | &quot;?&quot; | &quot;:&quot; | &quot;@&quot; | &quot;&amp;&quot; | &quot;=&quot;
</pre>
<p class="paragraph">
英数字に加え、以下の記号が、&quot;unreserved&quot;として普通に使ってオッケーな記号。
<br />
</p>
<pre>safe           = &quot;$&quot; | &quot;-&quot; | &quot;_&quot; | &quot;.&quot; | &quot;+&quot;
extra          = &quot;!&quot; | &quot;*&quot; | &quot;&#039;&quot; | &quot;(&quot; | &quot;)&quot; | &quot;,&quot;
...
unreserved     = alpha | digit | safe | extra
</pre>
<p class="paragraph">
さらに、実はRFC1738時点ではHTTPのPATHや&quot;?&quot;以降の&quot;sedarch&quot;部分の定義が以下のようになってました。
<br />
</p>
<pre>httpurl        = &quot;http://&quot; hostport [ &quot;/&quot; hpath [ &quot;?&quot; search ]]
hpath          = hsegment *[ &quot;/&quot; hsegment ]
hsegment       = *[ uchar | &quot;;&quot; | &quot;:&quot; | &quot;@&quot; | &quot;&amp;&quot; | &quot;=&quot; ]
search         = *[ uchar | &quot;;&quot; | &quot;:&quot; | &quot;@&quot; | &quot;&amp;&quot; | &quot;=&quot; ]
</pre>
<p class="paragraph">
なので、実は以下の様なURLもRFC1738に適合してる筈です。今時見かけたらぎょっとするようなURLですが。
<br />
</p>
<pre>http://www.example.com/hello!@my&amp;na+me=$jonny;(good):morning?good;(even+ing!:i@am&amp;bob=thanx&#039;
</pre>
<p class="paragraph">
・・・多分、適合してる筈（震え声）。
<br />
ただし、ややこしいんだけど&quot;URL&quot;全体を表現する文字としては上記でオッケーなんだけど、&quot;reserved&quot;は区切り文字とかの特殊文字で、「データ」の内容は表さない。URLを受け取った処理系が以下のように分割する「可能性がある」、ということかも。データとして &quot;+&quot; や &quot;$&quot; は残る感じです。
<br />
</p>
<pre>http
www.example.com
hello!
my
na+me
$jonny
(good)
morning
good
(even+ing!
i
am
bob
thanx&#039;
</pre>

<h3 id="id0ca1f0">RFC1808, Relative Uniform Resource Locators, 1995-06</h3>

<p class="paragraph">
<a class="externallink" href="http://www.ietf.org/rfc/rfc1808.txt" target="_blank">http://www.ietf.org/rfc/rfc1808.txt</a>
<br />
</p>

<p class="paragraph">
これはちょっとマイナーかも。今回のテーマとはあんまり絡んでないようです。
<br />
RFC1738では、「相対パス」について深く突っ込んでないです。
<br />
そこで、RFC1808では、HTML中など現在参照している「コンテキスト」＝文脈から、相対パスを解釈して絶対パスに変換する仕組みを取り上げてます。この段階では特に&quot;+&quot;の扱いは変更されてないです。
<br />
</p>

<h3 id="idd57437">RFC2396, Uniform Resource Identifiers (URI): Generic Syntax, 1998-08</h3>

<p class="paragraph">
<a class="externallink" href="http://www.ietf.org/rfc/rfc2396.txt" target="_blank">http://www.ietf.org/rfc/rfc2396.txt</a>
<br />
</p>

<p class="paragraph">
&quot;URLエンコード&quot;について扱う様々な記事から参照されてるRFCその2(多分)。
<br />
&quot;URI&quot;の一般的な文法について取り上げてます。
<br />
<em>RFC2396で、&quot;+&quot;文字が&quot;reserved&quot;に移動してます。</em>
<br />
さらに厄介なことに、どうもここから&quot;reserved&quot;の意味が微妙に変わってるっぽい・・・。
<br />
</p>

<pre class="plugin_pre">
G.2. Modifications from both RFC 1738 and RFC 1808

...

The plus &quot;+&quot;, dollar &quot;$&quot;, and comma &quot;,&quot; characters have been added to
those in the &quot;reserved&quot; set, since they are treated as reserved
within the query component.
</pre>

<p class="paragraph">
ではこの時点で使える文字はどうなってるのかというと、まず&quot;reserved&quot;な文字は以下になり、&quot;+&quot;や&quot;$&quot;が加わってます。
<br />
</p>
<pre>reserved      = &quot;;&quot; | &quot;/&quot; | &quot;?&quot; | &quot;:&quot; | &quot;@&quot; | &quot;&amp;&quot; | &quot;=&quot; | &quot;+&quot; | &quot;$&quot; | &quot;,&quot;
</pre>
<p class="paragraph">
で、エスケープなしでそのまま使える文字は英数字に加え以下の&quot;mark&quot;文字：
<br />
</p>
<pre>mark          = &quot;-&quot; | &quot;_&quot; | &quot;.&quot; | &quot;!&quot; | &quot;~&quot; | &quot;*&quot; | &quot;&#039;&quot; | &quot;(&quot; | &quot;)&quot;
unreserved    = alphanum | mark
</pre>
<p class="paragraph">
上記を組み合わせた、以下の文字種が定義されてます。&quot;pchar&quot;は、&quot;unreserved&quot;に &quot;;&quot;, &quot;/&quot;, &quot;?&quot; 以外の&quot;reserved&quot;文字を加えたもの。
<br />
</p>
<pre>pchar         = unreserved | escaped | &quot;:&quot; | &quot;@&quot; | &quot;&amp;&quot; | &quot;=&quot; | &quot;+&quot; | &quot;$&quot; | &quot;,&quot;
uric          = reserved | unreserved | escaped
</pre>
<p class="paragraph">
URLのpathとquery中に使える文字は以下のようになってます。
<br />
</p>
<pre>segment       = *pchar *( &quot;;&quot; param )
param         = *pchar
query         = *uric
</pre>

<p class="paragraph">
&quot;reserved&quot;に&quot;+&quot;が加わったことで、どう影響がでるかというと
<br />
</p>
<pre>http://www.example.com/abc/def+ghi/jkl?hello=bob+alice
</pre>
<p class="paragraph">
が、（もしかしたら）受け付ける処理系が
<br />
</p>
<pre>http://www.example.com/
abc
def
ghi
jkl
hello
bob
alice
</pre>
<p class="paragraph">
という風に見ちゃうかもしれない、という「可能性が」あるということみたいです。「データ」として表記するのには使えない・・・って何を言ってるんだか分かんなくなってきました・・・。
<br />
</p>

<p class="paragraph">
とはいえ、&quot;G.2.&quot;にある通りもともと&quot;+&quot;が&quot;reserved&quot;に移されたのは&quot;+&quot;がquery中で予約文字として扱われ始めた経緯があった筈です。これは &quot;application/x-www-form-urlencoded&quot; が使われ始めたから、という理由と、あるいはHTTP以外のスキームで&quot;+&quot;が区切り文字として使われ始めたから、という２つの可能性が考えられます。
<br />
</p>

<p class="paragraph">
URLというのは、印刷物など様々な経路でやり取りされるものであるため、エンコードなどによる影響を受け無いように、URLとして使える文字についていろいろ工夫を重ねていて、もちろんこの段階でも&quot;+&quot;は使えるのだけれど、区切り文字などに使われる特殊文字扱いになった、という事かもしれません。
<br />
</p>

<h3 id="id5ea2f0">RFC3986, Uniform Resource Identifier (URI): Generic Syntax, 2005-01</h3>

<p class="paragraph">
<a class="externallink" href="http://www.ietf.org/rfc/rfc3986.txt" target="_blank">http://www.ietf.org/rfc/rfc3986.txt</a>
<br />
</p>

<p class="paragraph">
&quot;URLエンコード&quot;について扱う様々な記事から参照されてるRFCその3(多分)。
<br />
RFC2396を&quot;obsoleted&quot;にして、こっちが最新のURIの文法定義だよ！ということでPHPのrawurlencode()はこっちに従ってます。
<br />
</p>

<p class="paragraph">
とりあえず、&quot;reserved&quot;がさらに増えてます。
<br />
</p>

<pre class="plugin_pre">
2.2.  Reserved Characters
...
reserved    = gen-delims / sub-delims
gen-delims  = &quot;:&quot; / &quot;/&quot; / &quot;?&quot; / &quot;#&quot; / &quot;[&quot; / &quot;]&quot; / &quot;@&quot;
sub-delims  = &quot;!&quot; / &quot;$&quot; / &quot;&amp;&quot; / &quot;&#039;&quot; / &quot;(&quot; / &quot;)&quot; / &quot;*&quot; / &quot;+&quot; / &quot;,&quot; / &quot;;&quot; / &quot;=&quot;
</pre>


<h3 id="ida66133">URLを組み立てる側と、解析する側の食い違い</h3>

<p class="paragraph">
RFC1738とRFC3986では、&quot;reserved&quot;が大分変わってます。そのため、URLを組み立てる側と、解析する側とで&quot;reserved&quot;文字種が異なる場合にトラブルになる場合があるようです。
<br />
</p>

<ul><li> 実際に、JavaScript側がRFC2396で、URLを受け付けるRails側がRFC3986だったため、&quot;&#039;&quot;の扱いで食い違いが発生し、Rails側で正常に処理できなかった例：<ul><li> URIに使ってよい文字の話 - RFC2396 と RFC3986 - 本当は怖い情報科学</li>
<li> <a class="externallink" href="http://d.hatena.ne.jp/keisukefukuda/20080321/p1" target="_blank">http://d.hatena.ne.jp/keisukefukuda/20080321/p1</a></li></ul></li></ul>

<p class="paragraph">
なお、PHP5では http_build_query() というURLエンコードされたqueryを組み立てる関数がありますが、RFC1738に則ってエンコードするのか、RFC3986に則ってエンコードするのか指定するパラメータが存在します。
<br />
</p>
<ul><li> <a class="externallink" href="http://php.net/manual/en/function.http-build-query.php" target="_blank">http://php.net/manual/en/function.http-build-query.php</a><ul><li> &quot;enc_type&quot;の解説で、RFC1738タイプだとスペースをplus記号(+)にして、RFC3986だと&quot;%20&quot;にするとあります。</li></ul></li></ul>


<h3 id="ida0b625">スペースを&quot;+&quot;にするのは &quot;application/x-www-form-urlencoded&quot; 由来？</h3>

<p class="paragraph">
RFC1738, RFC2396, RFC3986 はいずれもURLで使える文字については定義していますが、本記事のテーマであるURLクエリやPOSTデータでスペースを&quot;+&quot;にするというマッピングについてはスルーしてます。
<br />
</p>

<p class="paragraph">
スペースを&quot;+&quot;にするというマッピングは、HTMLの仕様で「Formでsubmitされた時、フォームの値をどうやってサーバに送るか」で定義されてます。
<br />
</p>

<ul><li> HTML4, Forms in HTML documents<ul><li> <a class="externallink" href="http://www.w3.org/TR/html401/interact/forms.html" target="_blank">http://www.w3.org/TR/html401/interact/forms.html</a><ul><li> &quot;17.13.4 Form content types&quot; : &quot;... Space characters are replaced by `+&#039; ...&quot;</li>
<li> ここで &quot;application/x-www-form-urlencoded&quot; ではスペースが&quot;+&quot;に変換されるルールが出てきています。</li></ul></li></ul></li>
<li> HTML5(20110525), 4.10.18 Association of controls and forms — HTML5<ul><li> <a class="externallink" href="http://www.w3.org/TR/2011/WD-html5-20110525/association-of-controls-and-forms.html" target="_blank">http://www.w3.org/TR/2011/WD-html5-20110525/association-of-controls-and-forms.html</a><ul><li> &quot;4.10.22.5 URL-encoded form data&quot; : &quot;... The character is a U+0020 SPACE character : Replace the character with a single U+002B PLUS SIGN character (+). ...&quot;</li></ul></li></ul></li>
<li> 4.10.18.3 Association of controls and forms — HTML Standard<ul><li> <a class="externallink" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/association-of-controls-and-forms.html" target="_blank">http://www.whatwg.org/specs/web-apps/current-work/multipage/association-of-controls-and-forms.html</a><ul><li> &quot;4.10.22.6 URL-encoded form data&quot; : w3cと同じ記述あり。0x20は&quot;+&quot;に変換。</li></ul></li></ul></li></ul>

<p class="paragraph">
・・・よくよく考えると、なんでわざわざスペースを&quot;+&quot;にマッピングしたんでしょうか。 &quot;application/x-www-form-urlencoded&quot; 周りの処理でも、明らかにスペースと&quot;+&quot;だけ扱いが違うんですよね・・・。他はもうpercent-encodingしろ、で終わってるのに、これだけ&quot;+&quot;にしてる。そもそもこれさえ無ければ、こんな記事書くのに時間かける必要もなかったんですが・・・。
<br />
</p>

<h3 id="id074ee9">PHPでは&quot;+&quot;をどう受け付けるか</h3>

<p class="paragraph">
PHPでは&quot;+&quot;も&quot;%20&quot;も、0x20に戻してるようです：
<br />
</p>
<ul><li> PHP :: Request #39078 :: Plus sign in URL arg received as space<ul><li> <a class="externallink" href="https://bugs.php.net/bug.php?id=39078" target="_blank">https://bugs.php.net/bug.php?id=39078</a></li></ul></li></ul>

<h3 id="id296b0c">Java Servletでは&quot;+&quot;をどう受け付けるか</h3>

<p class="paragraph">
ちょっと古いですがServlet Specification Version 2.3で、HttpUtilsクラスの&quot;parsePostData&quot;, &quot;parseQueryString()&quot;で以下のように&quot;+&quot;をスペースに変換するとありました。・・・とはいえ、Version 2.3も大分昔で、しかも2.3の時点でHttpUtilsが&quot;Deprecated&quot;されてますので、今も通用するかは不明ですが・・・。
<br />
</p>

<pre class="plugin_pre">
SRV.15.1.15.2 Methods

...

parsePostData(int, ServletInputStream)

The keys and values in the hashtable are stored in their decoded form, 
so any + characters are converted to spaces, and characters sent in hexadecimal 
nota-tion (like%xx) are converted to ASCII characters.

...

parseQueryString(String)

The keys and values in the hashtable are stored in their decoded form, so any
+ characters are converted to spaces, and characters sent in hexadecimal notation 
(like%xx) are converted to ASCII characters.
</pre>

<p class="paragraph">
Servlet Specification 3.0のPDFも確認してみたんですが、queryやpostの&quot;+&quot;の扱いについては特に記載されてないようです。
<br />
</p>

<h3 id="idb2ebd3">java.net.URLENcoderはどうなっているか</h3>

<ul><li> URLEncoder (Java Platform SE 6)<ul><li> <a class="externallink" href="http://docs.oracle.com/javase/jp/6/api/java/net/URLEncoder.html" target="_blank">http://docs.oracle.com/javase/jp/6/api/java/net/URLEncoder.html</a><ul><li> application/x-www-form-urlencoded形式に変換するためのものですので、スペースは&quot;+&quot;に変換します。</li>
<li> 英数字以外でそのまま残すのは、「.」、「-」、「<span class="plugin_pre_inline">*</span>」、および「_」だけのようです。 <span class="plugin_pre_inline">*</span> についてはRFC3986で&quot;reserved&quot;になったので、受け付ける側で特殊扱いしてしまう可能性があるかも・・・。</li></ul></li></ul></li></ul>

<ul><li> .NETのURLエンコードとJavaのURLエンコードの違いに嵌る : t_tanaka<ul><li> <a class="externallink" href="http://dev.worksap.co.jp/Members/t_tanaka/2011/03/30/dotnet-java-urlencode/" target="_blank">http://dev.worksap.co.jp/Members/t_tanaka/2011/03/30/dotnet-java-urlencode/</a><ul><li> &quot;+&quot;の扱いで嵌ったわけではないようですが、処理系によって微妙な差異があって、そこの調整怖いという話。</li></ul></li></ul></li>
<li> Java and RFC 3986 URI encoding - Stack Overflow<ul><li> <a class="externallink" href="http://stackoverflow.com/questions/5864954/java-and-rfc-3986-uri-encoding" target="_blank">http://stackoverflow.com/questions/5864954/java-and-rfc-3986-uri-encoding</a><ul><li> JavaでRFC3986に則ったURLエンコードをするにはどうすれば？というトピック。Sprintのコンポーネント使えよ！とか、URLEncodingしたあとにreplaceAll(&quot;+&quot;, &quot;%20&quot;)すればいい、とか。</li></ul></li></ul></li></ul>

<h3 id="id9c3a4f">java.net.URLEncoderを実際に使ってみる</h3>

<p class="paragraph">
Groovy使ってますけど、勘弁して下さい：
<br />
</p>
<pre>def java_url_papssthru_and = &#039;.-*_, +&quot;\&#039;.-*_, +&quot;\&#039;&#039;
println URLEncoder.encode(java_url_papssthru_and, &#039;UTF-8&#039;)
def rfc3986_reserved = &#039;:/?#[]@!$&amp;\&#039;()*+,;=:/?#[]@!$&amp;\&#039;()*+,;=&#039;
println URLEncoder.encode(rfc3986_reserved, &#039;UTF-8&#039;)
</pre>
<p class="paragraph">
→
<br />
</p>
<pre>.-*_%2C+%2B%22%27.-*_%2C+%2B%22%27
%3A%2F%3F%23%5B%5D%40%21%24%26%27%28%29*%2B%2C%3B%3D%3A%2F%3F%23%5B%5D%40%21%24%26%27%28%29*%2B%2C%3B%3D
</pre>
<p class="paragraph">
やっぱり、スペースは&quot;+&quot;で、アスタリスクはそのままになってます。
<br />
</p>

<p class="paragraph">
というわけで、RFC3986に合うようにスペースは&quot;%20&quot;に、アスタリスクは&quot;%2A&quot;に変換してみました。
<br />
</p>
<pre>def String rfc3986(String s, String cs)
{
    URLEncoder.encode(s, cs).replace(&#039;+&#039;, &#039;%20&#039;).replace(&#039;*&#039;, &#039;%2A&#039;)
}

println rfc3986(java_url_papssthru_and, &#039;UTF-8&#039;)
println rfc3986(rfc3986_reserved, &#039;UTF-8&#039;)
</pre>
<p class="paragraph">
→
<br />
</p>
<pre>.-%2A_%2C%20%2B%22%27.-%2A_%2C%20%2B%22%27
%3A%2F%3F%23%5B%5D%40%21%24%26%27%28%29%2A%2B%2C%3B%3D%3A%2F%3F%23%5B%5D%40%21%24%26%27%28%29%2A%2B%2C%3B%3D
</pre>
<p class="paragraph">
これなら、RFC3986でアスタリスクとか特殊扱いする処理系でもちゃんとデータとして扱えるURLを生成できそう。
<br />
</p>

<h4 id="idd8a9f9">URLエンコードの練習</h4>

<p class="paragraph">
web_escape_t1.groovy:(UTF-8で保存)
<br />
</p>
<pre class="plugin_pre">
@Grapes([
@Grab(group=&#039;org.apache.commons&#039;, module=&#039;commons-lang3&#039;, version=&#039;3.1&#039;),
])

import org.apache.commons.lang3.*

def s1 = &quot;Hello, \&quot;&gt;/&amp;&lt;&#039; world. こんにちは&quot;
println StringEscapeUtils.escapeHtml4(s1)
println StringEscapeUtils.escapeXml(s1)
def japanese_hello = &quot;&lt;&#039;こんにちは &amp; everybody!! \&quot;/&gt;&quot;
println StringEscapeUtils.escapeJava(japanese_hello)
println StringEscapeUtils.escapeEcmaScript(japanese_hello)
println URLEncoder.encode(japanese_hello, &#039;UTF-8&#039;)
println URLEncoder.encode(japanese_hello, &#039;Windows-31J&#039;)
println URLEncoder.encode(japanese_hello, &#039;euc-jp&#039;)
def java_url_papssthru_and = &#039;.-*_, +&quot;\&#039;.-*_, +&quot;\&#039;&#039;
println URLEncoder.encode(java_url_papssthru_and, &#039;UTF-8&#039;)
def rfc3986_reserved = &#039;:/?#[]@!$&amp;\&#039;()*+,;=:/?#[]@!$&amp;\&#039;()*+,;=&#039;
println URLEncoder.encode(rfc3986_reserved, &#039;UTF-8&#039;)

println &quot;abc def ghi def GHI&quot;.replace(&quot;def&quot;, &quot;!&quot;)

def String rfc3986(String s, String cs)
{
    URLEncoder.encode(s, cs).replace(&#039;+&#039;, &#039;%20&#039;).replace(&#039;*&#039;, &#039;%2A&#039;)
}

println rfc3986(java_url_papssthru_and, &#039;UTF-8&#039;)
println rfc3986(rfc3986_reserved, &#039;UTF-8&#039;)
</pre>

<p class="paragraph">
実行結果：
<br />
</p>
<pre class="plugin_pre">
Hello, &amp;quot;&amp;gt;/&amp;amp;&amp;lt;&#039; world. こんにちは
Hello, &amp;quot;&amp;gt;/&amp;amp;&amp;lt;&amp;apos; world. こんにちは
&lt;&#039;\u7E3A\u8599\uFF53\u7E3A\uFF6B\u7E3A\uFF61\u7E3A\uFF6F &amp; everybody!! \&quot;/&gt;
&lt;\&#039;\u7E3A\u8599\uFF53\u7E3A\uFF6B\u7E3A\uFF61\u7E3A\uFF6F &amp; everybody!! \&quot;\/&gt;
%3C%27%E7%B8%BA%E8%96%99%EF%BD%93%E7%B8%BA%EF%BD%AB%E7%B8%BA%EF%BD%A1%E7%B8%BA%EF%BD%AF+%26+everybody%21%21+%22%2F%3E
%3C%27%E3%81%93%E3%82%93%E3%81%AB%E3%81%A1%E3%81%AF+%26+everybody%21%21+%22%2F%3E
%3C%27%E5%E1%C6%E5%A3%F3%E5%E1%8E%AB%E5%E1%8E%A1%E5%E1%8E%AF+%26+everybody%21%21+%22%2F%3E
.-*_%2C+%2B%22%27.-*_%2C+%2B%22%27
%3A%2F%3F%23%5B%5D%40%21%24%26%27%28%29*%2B%2C%3B%3D%3A%2F%3F%23%5B%5D%40%21%24%26%27%28%29*%2B%2C%3B%3D
abc ! ghi ! GHI
.-%2A_%2C%20%2B%22%27.-%2A_%2C%20%2B%22%27
%3A%2F%3F%23%5B%5D%40%21%24%26%27%28%29%2A%2B%2C%3B%3D%3A%2F%3F%23%5B%5D%40%21%24%26%27%28%29%2A%2B%2C%3B%3D
</pre>

<h3 id="idb783f7">収拾がつかなくなってきたのでまとめ</h3>

<p class="paragraph">
0x20のURL中での表記の問題は、２つの観点が混ざっています。
<br />
</p>
<ol><li> URLを表現するときに使える文字の扱い<ol><li> これはさらに、「URLを作る側の動作」と「URLを解釈する側の動作」に分かれます。</li></ol></li>
<li> HTMLの仕様で定まっている、 &quot;application/x-www-form-urlencoded&quot; での扱い</li></ol>

<p class="paragraph">
まず後者の、HTML側の仕様ですが、これはHTML5になっても相変わらず、フォームで入力された0x20は &quot;application/x-www-form-urlencoded&quot; のMIME型では &quot;+&quot; に変換されます。なんでこれだけこうなってしまったのか、それはそれで興味があるんですが、ニート時代ならまだしも定職についてる今現在はそんな余裕は無い・・・。
<br />
つまり、スペースが&quot;+&quot;に変換されてPOSTリクエストボディやURLのquery中に現れるのは、当分は変わることはありません。
<br />
</p>

<p class="paragraph">
これはすなわち、<em>URLやPOSTメソッドを受け付ける側でも</em>&quot;+&quot;について特別な考慮が必要であることを意味します。
<br />
特別な考慮が必要なのは、&quot;+&quot;文字だけではありません。URL・・・というかURIで表現できるスキームは種類がありますので、それぞれで共通して、URIを解釈するときの分割などに用いる特殊文字がいくつかあります。そしてその特殊文字は、時代の移り変わりとともに変化してきました。
<br />
この変化の影響として、URIを生成する処理系と、URIを解釈する処理系とで特殊文字のセットが食い違うと予想通りに動作しない現象も出て来ました。特に、URIを生成する処理系が特殊文字が少ない時点での仕様(RFC1738, 2396)に基いていて、解釈する側の処理系が特殊文字が増えたRFC3986に基いていた場合に、生成する処理系では特殊文字として扱われずそのまま埋め込まれていた一部の文字が、解釈する側の処理系では特殊文字として特殊な扱われ方をしたため、予想通りにURIを処理してくれない、というトラブルに発展する場合があるようです。
<br />
</p>

<p class="paragraph">
URIを生成するユーティリティライブラリ等では、初期のバージョンはRFC1738に沿っていました。しかし上記のように、特殊文字が増えたRFC3986が登場したため、<del>PHPのrawurlencode()のように</del>(2014-03-16 修正) RFC3986に対応した新しいライブラリ関数を用意した処理系もあります。Javaのjava.net.URLEncoder()についてはRFC3986には特に追従していません。アスタリスクについて注意が必要になる可能性がありますが、若干のコーディングにより、容易にRFC3986にも対応したラッパーメソッドを作成出来ます。
<br />
</p>

<p class="paragraph">
実際のところ、RFCで規定しているのはURI中で使える文字種についてです。実際にCGIやServletなどWebアプリケーションレイヤーでどうquery文字列やPOSTリクエストボディを扱うのかは、その処理系に依存します。PHPやJava Servletにおいては、最新のバージョンでも &quot;+&quot; と &quot;%20&quot; を等しく0x20に変換してくれるようです。
<br />
</p>

<p class="paragraph">
また発散してきたのでもう一度整理し直すと、結局のところ「URIを生成する側は、可能な限り特殊文字が増えた最新のURIの仕様に合わせる」「URIを解釈する側は、古いURIの仕様で作られたURIについても解釈できたほうがベター」という状況のようです・・・多分（震え声）。
<br />
</p>

<ol><li> URIを生成する側<ol><li> HTMLの仕様で定まっている、 &quot;application/x-www-form-urlencoded&quot;<ol><li> URLのquery、およびPOSTメソッドのリクエストボディに使われる。</li>
<li> 0x20が &quot;+&quot; に変換されるが、特殊扱いはそれだけ。RFC3986で&quot;reserved&quot;指定の文字は軒並みpercent-encodeされるっぽいので、基本的には問題無さそう。</li></ol></li>
<li> PHPのurlencode(), rawurlencode()<ol><li><del>urlencode()はRFC1738, rawurlencode()はRFC3986 に従っている。</del></li>
<li><del>URIを生成する側は最新の仕様に合わせたほうが良い、という観点から、rawurlencode()を使ったほうが安全かも、という程度かも？（震え声）</del></li>
<li> 2014-03-16 : 次のスライド資料の方が詳しいので、そちらを参照 : <a class="externallink" href="http://www.slideshare.net/ebihara/php-32340906" target="_blank">http://www.slideshare.net/ebihara/php-32340906</a></li></ol></li>
<li> Javaのjava.net.URLEncoder()<ol><li> 基本的にRFC1738ベースだが、0x20とアスタリスク(0x2A)以外はRFC3986でも問題ない形に変換してくれる。</li>
<li> どうしてもRFC3986に厳密に従いたかったら、encode()したあとにさらに&quot;+&quot;とアスタリスクを&quot;%20&quot;と&quot;%2A&quot;に変換するラッパーを自作すれば良い。</li></ol></li>
<li> JavaScriptのencodeURIComponent()<ol><li> RFC2396ベースで、RFC3986で&quot;reserved&quot;に移動している一部の文字をそのまま残してしまうため、URIを解釈する受け手によっては問題となる事例あり。これもやっぱり変換ラッパーを自作すれば良さそう。</li></ol></li></ol></li>
<li> URIを解釈する側<ol><li> 基本的にプログラマーがどうこうできる余地は少ない。</li>
<li> PHP, Java Servletでは &quot;+&quot; も &quot;%20&quot; もどちらも 0x20 に戻してくれるので安心。</li>
<li> それ以外の、RFC1738/2396で &quot;unreserved&quot; だったのに RFC3986 で &quot;reserved&quot; に移動された文字を受け付けた場合にどうなるかはちょっと不明。実験してみて！</li></ol></li></ol>

<p class="paragraph">
土曜日一日潰して、一体何をやっているんだと言いたくなってくる・・・。しかし、お金が絡まないこうした調べ事は楽しいですね！！
<br />
</p>


<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-1350.html" title="技術/HTTP/REST設計思想の &quot;Stateless&quot; との付き合い方">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-1009.html" title="技術/HTTP/セッション固定化関連メモ(SessionFixation,SessionAdoption)">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-23.html" title="技術">技術</a>&nbsp;]</li>
</ul>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/1170<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2001 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a target="_blank" href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" target="_blank" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>