<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>日記/2009/11/03/8259A(PIC)のIOポート番号が謎だった件 - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">日記/2009/11/03/8259A(PIC)のIOポート番号が謎だった件</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2009-11-03 18:06:53 &nbsp; / &nbsp; last updated at: 2009-11-03 19:54:00<br>
カテゴリ: <a href="category-48.html">Assembler</a>&nbsp;</div>

<div class="data_body">
<p class="paragraph">
<a href="https://www.amazon.co.jp/dp/4798022543" target="_blank">作りながら学ぶOSカーネル―保護モードプログラミングの基本と実践</a>
<br />
</p>

<p class="paragraph">
を、暫く前からだらだらと読み進めていて、ようやく４章の割り込みの所に到達した。
<br />
で、PIC(Programmable Interrupt Controller)の初期化と割り込みハンドラのソースコードの部分で基礎的な知識が無かった故に「？？」となってしまった部分があるのでメモしておく。
<br />
</p>

<p class="paragraph">
103pからの「ソース4-6 kernel2.asm」で、デフォルトの割り込みハンドラ&quot;isr_ignore&quot;とTimer用割り込みハンドラ&quot;isr_32_timer&quot;で、
<br />
</p>
<pre>MOV AL, 0x20
OUT 0x20, AL
</pre>
<p class="paragraph">
というのが出てくるが、これの解説がどうも載っていない。コメントも無い。
<br />
</p>

<p class="paragraph">
また100pから始まる「ソース4-5 boot2.asm」にもPICの初期化処理で&quot;OUT&quot;命令が出てくるが、そのIOポートが次の4種類出てくる。
<br />
</p>
<pre>OUT 0x20, AL
OUT 0x21, AL
OUT 0xA0, AL
OUT 0xA1, AL
</pre>

<p class="paragraph">
この違いについて調べてみた。本の解説にもあるとおり、割り込みはIntelの8259Aというコントローラ(とその互換chip)が担当しているとの事で、PIC 8259Aを中心に色々Googleに訊いてまわる事になった。
<br />
</p>

<h3 id="id0e182c">8259Aへのコマンド・データ指示とIOポート番号について</h3>

<p class="paragraph">
8259Aの物理的な構造としてD0-D7pin, A0pinが今回の件に関連している。PICの初期化や内部レジスタの操作にはA0pin, D0-D7pinで行う。データバスを介して行われるPICの処理命令(Command Words)とA0pinの関係についてまずまとめる。初期化処理系(ICWx)は一度のみ、操作処理系(OCWx)は初期化完了後は何度でも呼べる。
<br />
</p>

<ul><li> 初期化処理系(ICW : Initialization Command Words)<ul><li> ICW1(A0=0) : PICの初期化実行</li>
<li> ICW2(A0=1) : 割り込み番号のベクタアドレス(上乗せ値)の指定</li>
<li> ICW3(A0=1) : マスター・スレーブの連結方法の指定</li>
<li> ICW4(A0=1) : 追加命令</li></ul></li>
<li> 操作処理系(OCW : Operation Command Words)<ul><li> OCW1(A0=1) : IRQ番号のmask設定</li>
<li> OCW2(A0=0) : EOI(End of Interruption)指示</li>
<li> OCW3(A0=0) : &quot;スペシャルマスク&quot;設定</li></ul></li></ul>

<p class="paragraph">
前述のboot2.asm, kernel2.asmで使われているのはICW1-4, OCW1-2である。それぞれをOUTで指定する時のIOポートアドレスをA0pinの状態と比べてみる。
<br />
</p>
<table>
	<tr>
		<td> ICW1 </td>
		<td> A0=0 </td>
		<td> OUT 0x20/0xA0 </td>
	</tr>
	<tr>
		<td> ICW2 </td>
		<td> A0=1 </td>
		<td> OUT 0x21/0xA1 </td>
	</tr>
	<tr>
		<td> ICW3 </td>
		<td> A0=1 </td>
		<td> OUT 0x21/0xA1 </td>
	</tr>
	<tr>
		<td> ICW4 </td>
		<td> A0=1 </td>
		<td> OUT 0x21/0xA1 </td>
	</tr>
	<tr>
		<td> OCW1 </td>
		<td> A0=1 </td>
		<td> OUT 0x21/0xA1 </td>
	</tr>
	<tr>
		<td> OCW2 </td>
		<td> A0=0 </td>
		<td> OUT 0x20/0xA0 </td>
	</tr>
</table>

<p class="paragraph">
このように、0x20/0xA0ならA0=0, 0x21/0xA1ならA0=1というように対応している。
<br />
</p>

<p class="paragraph">
結論から言うと、このA0pin/D0-D7pinとIOポート番号の対応はBIOSのPOST処理により設定される。
<br />
</p>

<p class="paragraph">
命令の種類として、A0pin = 0 のものは主に初期化処理や内部レジスタの状態を変更する命令、 A0pin = 1 のものは内部レジスタの値を直接操作したり、アドレスoffsetを操作する透過的なデータ操作命令として、以下のような分類にしているようだ。A0pinのON/OFF切り替えはCPU内部で行われているものと思われる<span class="hidden">(</span><a class="footnote" href="#footnote_468_1" id="footnote_468_1_r"  title="さすがにここまでは追跡できなかった">*1</a><span class="hidden">)</span>。
<br />
</p>
<table>
	<tr>
		<td> 0x20/0xA0 </td>
		<td> 初期化命令, EOI指示(ICW1, OCW2, OCW3) </td>
	</tr>
	<tr>
		<td> 0x21/0xA1 </td>
		<td> マスク/値の設定(ICW2, ICW3, ICW4, OCW1) </td>
	</tr>
</table>

<p class="paragraph">
ICW4は追加命令なので0x20/0xA0の方がふさわしいように思えるが、それ以外はおおむね分類として合っているように思われる。
<br />
</p>

<p class="paragraph">
ここで、boot2.asm, kernel2.asm のソースに戻って見直してみる。
<br />
</p>

<p class="paragraph">
まずboot2.asmでは、ICW1-4の設定を行うところは順に 0x20/0xA0(ICW1), 0x21/0xA1(ICW2-4) へOUTしている。
<br />
また
<br />
</p>
<pre>mov al, 0xFF ; スレーブPICの全ての割り込みを
out 0xA1, al ; 防いでおく。
dw 0x00eb, 0x00eb
mov al, 0xFB ; マスターPICのIRQ2番を除いた、
out 0x21, al ; 全ての割り込みを防いでおく。
</pre>
<p class="paragraph">
ここの部分は OCW1、mask設定になる為これも 0x21/0xA1へのOUTとなっている。
<br />
</p>

<p class="paragraph">
kernel2.asmの無限ループへ入る直前、
<br />
</p>
<pre>mov al, 0xFE ; 防いでおいた割り込み中、
out 0x21, al ; タイマーだけを有効にする。
</pre>
<p class="paragraph">
こちらもOCW1, mask設定で 0x21へのOUTとなっている。
<br />
</p>

<p class="paragraph">
今回の調査に駆り立てたきっかけである、isr_ignore, isr_32_timerの次の箇所を読み解いてみる。
<br />
</p>
<pre>mov al, 0x20
out 0x20, al
</pre>
<p class="paragraph">
まず0x20へのOUTで、0x20というコマンド値は OCW2, EOI指定である。8259Aの仕様では0x20は「非指定EOI」である。
<br />
</p>

<h3 id="idb29f91">OCW2, EOI(End of Interruption)指示について</h3>

<p class="paragraph">
ここでEOIの意味について簡単にまとめておく。
<br />
</p>

<p class="paragraph">
8259Aの内部レジスタには以下の３つがある。
<br />
</p>
<ul><li> Interrupt Request Register (IRR) : 割り込み信号は受け取ったが、まだCPUに送られていないIRQ番号のbitが1になっている。</li>
<li> In-Sevice Register (ISR) : CPUに送られ、INTA待ちのIRQ番号のbitが1になっている。</li>
<li> Interrupt Mask Register (IMR) : 割り込みを受信するIRQ番号のbitmask</li></ul>

<p class="paragraph">
PICはEOIを受け付けると、該当するISRビットを&quot;0&quot;にする。これにより、次の割り込みが受け付けられるようになる。EOIには次の３種類がある。
<br />
</p>

<ul><li> 自動EOI（Automatic EOI）<ul><li> 自動EOIはICW4のAEOIビットが&quot;1&quot;になっている場合のみ有効。CPUが割り込みを受け付け、INTAが出た時点で自動的にISRがリセットされる。</li></ul></li>
<li> 非指定EOI（Non-Specific EOI）<ul><li> ISRの中でもっとも優先度の高いものをPICが自動判定し、クリアする。通常はIRQ番号が低いほど優先度が高いと見なされる。</li></ul></li>
<li> 指定EOI（Specific EOI）<ul><li> 割り込み番号を特定したい場合に使う。bit0-2で割り込み番号を指定する。</li></ul></li></ul>

<p class="paragraph">
boot2.asmのICW4ではAEOIビットがズバリ、&quot;0&quot;になっている。このため割り込みハンドラの中でOCW2, EOIコマンドを発行する必要があった。非指定EOIを使っているのは、割り込み番号を特に指定する必要のない小規模な実験コードだからだろう。
<br />
</p>

<h3 id="idcad895">参考資料</h3>

<ul><li> &quot;パソコンのレガシィI/O活用大全&quot;<ul><li> <a class="externallink" href="http://www.cqpub.co.jp/column/books/2001a/34331PC_Legacy/default.htm" target="_blank">http://www.cqpub.co.jp/column/books/2001a/34331PC_Legacy/default.htm</a></li>
<li> 絶版。Amazonでもコレクター商品として19,980円とかついてる。</li></ul></li>
<li> &quot;Operating Systems Development - 8259A PIC Microcontroller&quot;, by Mike &quot;Crypter&quot; 2007<ul><li> <a class="externallink" href="http://www.brokenthorn.com/Resources/OSDevPic.html" target="_blank">http://www.brokenthorn.com/Resources/OSDevPic.html</a><ul><li> 英語だが、かなり詳しい。A0pinとIOポート番号のmappingがBIOSで制御されてるのはこのリソースで知った。</li></ul></li></ul></li>
<li> &quot;Input/Output Base Address - Wikipedia, the free encyclopedia&quot;<ul><li> <a class="externallink" href="http://en.wikipedia.org/wiki/Input/Output_Base_Address" target="_blank">http://en.wikipedia.org/wiki/Input/Output_Base_Address</a></li></ul></li>
<li> &quot;Programmable Interrupt Controller - Wikipedia, the free encyclopedia&quot;<ul><li> <a class="externallink" href="http://en.wikipedia.org/wiki/Programmable_Interrupt_Controller" target="_blank">http://en.wikipedia.org/wiki/Programmable_Interrupt_Controller</a><ul><li> 電子計算機系の技術を調べる時は、やはり英語版のWikipediaの方が充実している。</li></ul></li></ul></li>
<li> &quot;I/O Ports and Controllers on IBM Compatibles and PS/2&quot;<ul><li> <a class="externallink" href="http://www.os2site.com/sw/info/memory/ports.txt" target="_blank">http://www.os2site.com/sw/info/memory/ports.txt</a><ul><li> IOポート番号一覧。どうやって調べたのか知りたい・・・。</li></ul></li></ul></li>
<li> &quot;8259A PROGRAMMABLE INTERRUPT CONTROLLER (8259A 8259A-2)&quot;<ul><li> <a class="externallink" href="http://bochs.sourceforge.net/techspec/intel-8259a-pic.pdf.gz" target="_blank">http://bochs.sourceforge.net/techspec/intel-8259a-pic.pdf.gz</a><ul><li> bochsのサイトに何故かあった8259Aのデータシート。ちゃんと文章がテキストとして検索できるようになっていたので、こちらを参考にした。</li></ul></li></ul></li></ul>

<hr />
<p class="paragraph">
IOポート番号や8259Aの仕様など、非常にハード寄りの部分の調査になった為、それなりに大変だった。ここまで調べたが、かといって8259Aの仕様を完全に理解したのかと言われると否。今回はA0pinとIOポート番号のmappingがどこで行われているのかを最優先にして資料を流し読みしたため、ICWやOCWの各命令詳細やPICの内部ダイアグラムまで追っかけたわけではない。
<br />
486アーキテクチャなどのハード系はインターネットが一般に広まる1995年以前に完成していた為、Google先生に訊いてもなかなか日本語で分かりやすい資料が見つからず、結局英語資料の方が役に立った。
<br />
</p>

<p class="paragraph">
しかし近年のアーキテクチャではAPICとしてCPUのコアに統合されているらしく、これを使うと数十の割り込みコントローラを連結させたりする事も出来るらしい。非常に奥が深い世界なのだと思い知らされた。<br />
</p><div class="footnote">
<a id="footnote_468_1" href="#footnote_468_1_r">*1</a>: さすがにここまでは追跡できなかった
</div>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/468<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2007 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>