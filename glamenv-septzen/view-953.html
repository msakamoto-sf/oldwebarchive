<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>技術/Linux/手作りLinuxシステム/04. Boot from CD (kernel-2.6.x) - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">技術/Linux/手作りLinuxシステム/04. Boot from CD (kernel-2.6.x)</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2011-04-16 15:27:10 &nbsp; / &nbsp; last updated at: 2011-04-29 15:37:47<br>
カテゴリ: <a href="category-20.html">Linux</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-952.html" title="技術/Linux/手作りLinuxシステム/03. BusyBoxとuClibcを組み合わせる">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-958.html" title="技術/Linux/手作りLinuxシステム/05. Boot from Network(PXE) (kernel-2.6.x)">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-23.html" title="技術">技術</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
今回はCD/DVDからのLinuxシステムの起動を目指します。
<br />
1.4MBの制限が無くなりますので、容量をあまり気にせずkernelの設定やユーザーランドを構築できます。
<br />
ローカルHDDのマウントなどは考えません。単純にISOイメージ上に格納されたbzImage(Linuxカーネル)と、kernel-2.6以降で利用出来るようになったcpio形式のInitial RAM Disk(initrd)だけで起動します。ルートファイルシステムはkernelパラメータに &quot;root=/dev/ram0&quot; を指定することで、initrdをそのまま使います。
<br />
</p>

<p class="paragraph">
また、今回は &quot;Buildroot&quot; を使ってuClibc, BusyBoxのビルドとルートファイルシステムの構築を行ってみます。
<br />
</p>

<p class="paragraph">
initrd, initramfsの違いについては &quot;DEBUG HACKS&quot;, hack #64 を参照してください。
<br />
</p>
<a href="https://www.amazon.co.jp/dp/4873114047" target="_blank">Amazon.co.jp: Debug Hacks -デバッグを極めるテクニック&amp;ツール : 吉岡 弘隆, 大和 一洋, 大岩 尚宏, 安部 東洋, 吉田 俊輔: 本</a><br>

<p class="paragraph">
initrdやInitial RAM Disk関連のカーネルパラメータ、カーネル設定については豊富なWeb資料と共に、カーネルソースツリーの
<br />
</p>
<pre>Documentation/
    blockdev/ramdisk.txt
    devices.txt
    initrd.txt
    filesystems/tmpfs.txt
</pre>
<p class="paragraph">
も参考になります。
<br />
</p>



<ul><li><a href="#idaf27c4">Buildrootを使ってみる</a></li>
<li><a href="#id79e4f5">最小構成でkernelをビルド</a></li>
<li><a href="#id7d8f4e">ISOイメージの作成と動作確認</a><ul><li><a href="#id918226">上手く起動しない時は・・・</a></li>
<li><a href="#id83ec7c">おまけ１：日本語106キーボードを使えるようにする</a></li>
<li><a href="#id588fee">おまけ２：Buildrootのtoolchainを使ってHelloWorldをコンパイルしてみる</a></li></ul></li></ul>
<hr />
<h3 id="idaf27c4">Buildrootを使ってみる</h3>

<p class="paragraph">
参考：
<br />
</p>
<ul><li> Buildroot<ul><li> <a class="externallink" href="http://buildroot.uclibc.org/" target="_blank">http://buildroot.uclibc.org/</a></li></ul></li>
<li> Buildrootドキュメント(Latest stable release)<ul><li> <a class="externallink" href="http://buildroot.uclibc.org/downloads/buildroot.html" target="_blank">http://buildroot.uclibc.org/downloads/buildroot.html</a></li></ul></li>
<li> 連載記事「いますぐ使える！ BusyBox活用術」 － ＠IT MONOist<ul><li> <a class="externallink" href="http://monoist.atmarkit.co.jp/fembedded/index/busyboxtech.html" target="_blank">http://monoist.atmarkit.co.jp/fembedded/index/busyboxtech.html</a></li></ul></li></ul>

<p class="paragraph">
Buildrootをダウンロードします。今回は buildroot-2011.02.tar.bz2 を使います。
<br />
</p>
<pre>$ pwd
/home/msakamoto/reduced.linux
$ ls
... buildroot-2011.02.tar.bz2 ...
$ tar jxf buildroot-2011.02.tar.bz2
</pre>
<p class="paragraph">
また、Buildrootのソースコードダウンロード先ディレクトリを作っておきます。Buildrootの設定でダウンロード先を指定することで、ダウンロードファイルを一箇所にまとめて共通化できます。
<br />
</p>
<pre>$ pwd
/home/msakamoto/reduced.linux
$ mkdir buildroot-dl
</pre>
<p class="paragraph">
環境変数で指定する方法もあります。詳しくはBuildrootのドキュメントを参照してください。
<br />
</p>

<p class="paragraph">
今回のビルドディレクトリを作成します。 &quot;04_cdboot&quot; を親ディレクトリとし、Buildroot用に &quot;br&quot; という子ディレクトリを作成します。
<br />
</p>
<pre>$ pwd
/home/msakamoto/reduced.linux
$ mkdir -p 04_cdboot/br
</pre>

<p class="paragraph">
一旦 &quot;allnoconfig&quot; でBuildrootの設定を初期化します。
<br />
</p>
<pre>$ pwd
/home/msakamoto/reduced.linux
$ make -C `pwd`/buildroot-2011.02 O=`pwd`/04_cdboot/br allnoconfig
</pre>

<p class="paragraph">
Buildrootの設定を調整していきます。
<br />
</p>
<pre>$ cd 04_cdboot/br/
$ make menuconfig
</pre>
<p class="paragraph">
以下のようにオプションを調整します。
<br />
</p>
<pre>BR2_DL_DIR=&quot;$(TOPDIR)/dl&quot;
→
BR2_DL_DIR=&quot;/home/msakamoto/reduced.linux/buildroot-dl&quot;

# BusyBoxをビルドします。
BR2_PACKAGE_BUSYBOX=y

# ルートファイルシステムのイメージファイルををcpio形式で作成します。
BR2_TARGET_ROOTFS_CPIO=y

</pre>
<p class="paragraph">
ビルドします。
<br />
</p>
<pre>$ make all
</pre>

<p class="paragraph">
ビルドに成功すると、ビルドディレクトリの下に &quot;images/rootfs.cpio&quot;, &quot;images/rootfs.cpio.gz&quot; というファイルが作成されます。これがcpio形式でアーカイブされたルートファイルシステムのイメージファイルになります。
<br />
</p>

<h3 id="id79e4f5">最小構成でkernelをビルド</h3>

<p class="paragraph">
続いてCDブートするための最小構成のカーネルをビルドします。
<br />
まず、ビルドディレクトリを作成します。
<br />
</p>
<pre>$ pwd
/home/msakamoto/reduced.linux/04_cdboot
$ mkdir kernel
</pre>

<p class="paragraph">
カーネルは <a href="./view-941.html" >技術/Linux/手作りLinuxシステム/01. Boot from Floppy Disk (kernel-2.6.x)</a> で展開したソースツリー(kernel-2.6.38.2)を流用します。Buildroot側ではtoolchainのコンパイルにkernel-2.6.37.2を使ってますが・・・まぁ、今回は目をつぶる方向で。（Buildroot側でLinux Kernelのコンパイルを有効化すると、toolchainで使うヘッダーと同じバージョンのkernelを使うよう設定することも可能です。ただ今回はこれ以上カーネルソースを展開してHDD容量を消費したくなかったので、Buildrootの外側で既に展開していたkernelソースを使ってしまいます）
<br />
</p>

<p class="paragraph">
allnoconfigで設定を初期化します。
<br />
</p>
<pre>$ make -C ../linux-2.6.38.2 O=`pwd`/kernel allnoconfig
$ cd kernel
$ make menuconfig
</pre>

<p class="paragraph">
以下のオプションを有効化します。モジュール化はせず、カーネルに組み込みます。
<br />
</p>
<pre>CONFIG_BLK_DEV_INITRD
CONFIG_BINFMT_ELF
</pre>
<p class="paragraph">
CONFIG_BLK_DEV_INITRDを有効化するときは、&quot;make menuconfig&quot;で
<br />
</p>
<pre>General setup ---&gt;
    Initial RAM filesystem and RAM disk (initramfs/initrd) support
</pre>
<p class="paragraph">
のチェックをONにすることをお薦めします。圧縮ファイルの展開関連のオプションも自動的に有効化されます。
<br />
</p>

<p class="paragraph">
ビルドします。&quot;bzImage&quot;が生成されればOKです。
<br />
</p>
<pre>$ make bzImage
...
  BUILD   arch/x86/boot/bzImage
Root device is (253, 0)
Setup is 14008 bytes (padded to 14336 bytes).
System is 770 kB
CRC 5b2917a6
Kernel: arch/x86/boot/bzImage is ready  (#1)
</pre>

<h3 id="id7d8f4e">ISOイメージの作成と動作確認</h3>

<p class="paragraph">
mkisofsと、syslinuxが提供しているisolinuxを使ってブート可能なISOイメージを作成します。
<br />
</p>

<p class="paragraph">
本シリーズで使用している開発マシン、CentOS 5.5 での両パッケージのバージョン：
<br />
</p>
<pre>syslinux-3.11-4
mkisofs-2.01-10.7.el5
</pre>

<p class="paragraph">
ISOLINUX参考：
<br />
</p>
<ul><li> ISOLINUX - Syslinux Wiki<ul><li> <a class="externallink" href="http://syslinux.zytor.com/wiki/index.php/ISOLINUX" target="_blank">http://syslinux.zytor.com/wiki/index.php/ISOLINUX</a></li></ul></li></ul>

<p class="paragraph">
まずISOイメージに対応するディレクトリを作成します。
<br />
</p>
<pre>$ pwd
/home/msakamoto/reduced.linux/04_cdboot
$ mkdir cdimage
</pre>
<p class="paragraph">
&quot;cdimage/&quot; 以下のディレクトリツリーがISOイメージに変換されます。
<br />
</p>

<p class="paragraph">
まずカーネルとルートファイルシステムのイメージファイルをコピーしてきます。rootfsについてはファイル名を短くしておきます。
<br />
</p>
<pre>$ cp kernel/arch/x86/boot/bzImage cdimage/
$ cp br/images/rootfs.cpio.gz cdimage/rootfs.gz
</pre>

<p class="paragraph">
続いて &quot;isolinux&quot; というディレクトリを作成し、その中にsyslinuxで提供されている isolinux.bin をコピーします。
<br />
</p>
<pre>$ mkdir -p cdimage/isolinux
$ rpm -ql syslinux
...
/usr/lib/syslinux/isolinux.bin
...
$ cp /usr/lib/syslinux/isolinux.bin cdimage/isolinux/
</pre>

<p class="paragraph">
isolinux.cfgを作成します。改行はCRLFにして編集してください。(vimなら &quot;:set fileformat=dos&quot; で保存)
<br />
</p>
<pre>$ vim cdimage/isolinux/isolinux.cfg
</pre>

<p class="paragraph">
isolinux.cfg:
<br />
</p>
<pre>default linux
label linux
  kernel /bzImage
  append initrd=/rootfs.gz root=/dev/ram0
</pre>
<p class="paragraph">
&quot;root=/dev/ram0&quot; でinitrd(Initial RAM Disk)をルートファイルシステムとしてそのまま使い続けるようにしています。もちろん、rootfs.gzの中には &quot;/dev/ram0&quot; デバイスノードが作成されていることが条件です。&quot;cpio -t &lt; br/images/rootfs.cpio&quot; などでcpioアーカイブの中身を確認してみてください。
<br />
initrdと&quot;root=/dev/ram0&quot;の解説はカーネルソースツリーの Documentation/initrd.txt などを参照してください。
<br />
</p>

<p class="paragraph">
mkisofsでISOイメージを作成します。
<br />
</p>
<pre>$ mkisofs -o output.iso \
   -b isolinux/isolinux.bin \
   -c isolinux/boot.cat \
   -no-emul-boot \
   -boot-load-size 4 \
   -boot-info-table \
   cdimage
</pre>

<p class="paragraph">
output.isoをVMware仮想マシンのCD/DVDイメージファイルに設定し、起動してみます。
<br />
</p>

<p class="paragraph">
<a href="./../images/reduced.linux/04_01.png" title="" target="_blank"><img src="./../images/reduced.linux/04_01.png" alt="" title=""  /></a>
<br />
</p>

<p class="paragraph">
<a href="./../images/reduced.linux/04_02.png" title="" target="_blank"><img src="./../images/reduced.linux/04_02.png" alt="" title=""  /></a>
<br />
</p>

<p class="paragraph">
<a href="./../images/reduced.linux/04_03.png" title="" target="_blank"><img src="./../images/reduced.linux/04_03.png" alt="" title=""  /></a>
<br />
</p>

<p class="paragraph">
<a href="./../images/reduced.linux/04_04.png" title="" target="_blank"><img src="./../images/reduced.linux/04_04.png" alt="" title=""  /></a>
<br />
</p>

<p class="paragraph">
無事ログインシェル、およびrootログインまで辿り着きました！(パスワードは空になっています)
<br />
</p>

<h4 id="id918226">上手く起動しない時は・・・</h4>

<dl>
<dt> &quot;Could not find ramdisk ...&quot; と表示され、&quot;boot&quot;プロンプトに戻ってしまう </dt>
<dd>
<p class="paragraph">
→ &quot;Could not find ramdisk...&quot;というメッセージはsyslinux側が表示しています。
<br />
</p>
<ol><li> ISOイメージ内のルート(&quot;/&quot;)からフルパスで指定する。</li>
<li> ファイル名を短くしておく。</li></ol>

<p class="paragraph">
などの対処で解決できると思います。
<br />
</p></dd>
<dt> 上記以外のトラブル </dt>
<dd>
<p class="paragraph">
メッセージが表示されるのであれば、kernelソースやsyslinuxのソースをgrepし、どちらが出力しているのか切り分け、その後Web等で検索してみてください。
<br />
syslinux側の場合は、isolinux-debug.bin を使ってデバッグメッセージを表示させてみてください(ISOLINUXのドキュメント参照)。
<br />
</p></dd>
</dl>

<h4 id="id83ec7c">おまけ１：日本語106キーボードを使えるようにする</h4>

<p class="paragraph">
これまでずっと英語キーボード設定のまま話を進めてきました。本シリーズの趣旨としてまずは最低限度動作する環境を構築することを優先したため、キーボードなどユーザー環境については無視してきました。
<br />
しかしBuildrootを使うことで、ユーザーランドのアプリケーションもスムーズに導入できるようになりましたので、ここで日本語106キーボードを使えるようにしてみます。
<br />
</p>

<p class="paragraph">
やり方は簡単で、Buildrootの設定で
<br />
</p>
<pre>Package Selection for the target  ---&gt;
    Hardware handling  ---&gt;
        kbd
</pre>
<p class="paragraph">
をチェックして有効化し、&quot;make&quot;しなおします。新しいrootfs.cpio.gzができたら、上記と同様 cdimage/rootfs.gz に上書きコピーしてmkisofsしなおします。
<br />
</p>

<p class="paragraph">
新しいISOイメージで起動したらrootでログインし、
<br />
</p>
<pre># cd /usr/share/keymaps/i386/qwerty
# loadkeys jp106.map.gz
</pre>
<p class="paragraph">
すれば日本語106キーボードが使えるようになります。
<br />
</p>

<h4 id="id588fee">おまけ２：Buildrootのtoolchainを使ってHelloWorldをコンパイルしてみる</h4>

<p class="paragraph">
Buildrootがビルドしたtoolchain(gcc, binutils)は &quot;出力ディレクトリ/host&quot; 以下に保存されています。これをBuildrootの外部で使うには、単純に &quot;出力ディレクトリ/host/usr/bin&quot; にPATHを通せばOKです。
<br />
</p>
<pre class="plugin_pre">
$ pwd
/home/msakamoto/reduced.linux/04_cdboot
$ pushd br/host/usr/bin/
$ ls
faked* ... fakeroot* ... i386-linux-gcc@ ...
$ export PATH=`pwd`:$PATH
$ popd
$ cat helloworld.c
#include &lt;stdio.h&gt;
#include &lt;linux/version.h&gt;

int main(int argc, char *argv[])
{
    int i;
    printf(&quot;Hello, World! LINUX_VERSION_CODE=%ld\n&quot;, LINUX_VERSION_CODE);
    for (i = 0; i &lt; argc; i++) {
        printf(&quot;args[%d]=[%s]\n&quot;, i, argv[i]);
    }
    return 0;
}

$ which i386-linux-gcc
~/reduced.linux/04_cdboot/br/host/usr/bin/i386-linux-gcc
$ i386-linux-gcc -o helloworld helloworld.c
...
$ readelf -x .interp helloworld

Hex dump of section &#039;.interp&#039;:
  0x080480f4 732e6362 696c4375 2d646c2f 62696c2f /lib/ld-uClibc.s
  0x08048104                            00302e6f o.0.
</pre>

<p class="paragraph">
実行ファイル helloworld をルートファイルシステムに組み込みます。ルートファイルシステムをカスタマイズする簡単な方法としては、 &quot;出力ディレクトリ/target/&quot; の下に直接ファイルをコピーし、&quot;make&quot;しなおすだけというのがあります。この方法を使ってみます。
<br />
</p>
<pre>$ cp helloworld br/target/
$ cd br
$ make
</pre>
<p class="paragraph">
新しいrootfs.cpio.gzが生成されたので、これまでと同様の手順でISOイメージを再生成します。
<br />
</p>

<p class="paragraph">
ルートファイルシステムをカスタマイズするその他の方法についてはBuildrootのドキュメントを参照してください。
<br />
</p>

<p class="paragraph">
仮想マシンを起動してみます。
<br />
</p>

<p class="paragraph">
<a href="./../images/reduced.linux/04_05.png" title="" target="_blank"><img src="./../images/reduced.linux/04_05.png" alt="" title=""  /></a>
<br />
</p>

<p class="paragraph">
無事helloworldが動きました！
<br />
</p>

<hr />
<p class="paragraph">
以上でCDブートのLinuxシステムの構築記事は終わりです。次回はいよいよPXEを使ったネットワークブートに挑戦します。
<br />
</p>

<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-952.html" title="技術/Linux/手作りLinuxシステム/03. BusyBoxとuClibcを組み合わせる">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-958.html" title="技術/Linux/手作りLinuxシステム/05. Boot from Network(PXE) (kernel-2.6.x)">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-940.html" title="技術/Linux/手作りLinuxシステム">Up</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-23.html" title="技術">技術</a>&nbsp;]</li>
</ul>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/953<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2001 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a target="_blank" href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" target="_blank" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>