<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Perl/codepiece/signal01 - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">Perl/codepiece/signal01</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2007-03-14 21:59:42 &nbsp; / &nbsp; last updated at: 2008-12-24 22:07:11<br>
カテゴリ: <a href="category-21.html">Perl</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-138.html" title="Perl/codepiece/setuid03">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-111.html" title="Perl/codepiece/static_vars1">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-109.html" title="Perl">Perl</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
<strong> シグナルは非常に扱いが難しいです。ここにまとめた文章は依然として「メモ」扱いです。より正確で厳密な記述に、将来書き換えられる可能性もありますし、あるいはそうした外部リソースのリンクが追記される可能性があります。つまり・・・あの、その、これ、まだ私的なメモの段階なので、あんまり信用されるとちょっとまずいです。という感じです。 </strong>
<br />
</p>

<h3 id="idc1bbe5">簡単なように見えて面倒くさいシグナル処理</h3>

<p class="paragraph">
Inter Process Communication (IPC) でのシグナル(signal)は、非常に奥が深い。というのも
<br />
</p>
<ol><li> マルチスレッドプログラミングにおいてどうなるのか？</li>
<li> シグナルハンドラの処理中に、同じシグナルを受信して同じシグナルハンドラに入ってしまう、いわゆる&quot;再突入問題&quot;(<strong> re-entrant problem </strong>)をどう処理するか？</li>
<li> シグナルハンドラ中で&quot;re-entrant&quot;でない<span class="hidden">(</span><a class="footnote" href="#footnote_110_1" id="footnote_110_1_r"  title="プロセス中で同時に呼ばれることを想定せず、プロセスコンテキスト中でグローバル変数を裏側で持ってしまっている、標準関数など">*1</a><span class="hidden">)</span>関数を呼ぶとどうなるか？</li></ol>

<p class="paragraph">
などなど、&quot;同時性&quot;についてかなり面倒くさい考慮が必要になる機構だからだ。
<br />
</p>

<p class="paragraph">
Cから使えるAPIにしても、以下の二系統が存在する。
<br />
</p>
<ol><li> 初期に作られた&quot;signal(2)&quot;システムコール</li>
<li> POSIXで制定された&quot;sigaction(2)&quot;系のシステムコール</li></ol>

<p class="paragraph">
一般に関数のI/Fが簡便であるのはsignal(2)の方である。シグナルをブロックしたり、ブロック対象のシグナルを細かく制御したりする場合、また子プロセスの終了を緻密に検出したい場合などは、sigaction(2)系を用いると良いらしい。
<br />
</p>

<h3 id="idb56dcf">シグナル関係のURL</h3>

<ul><li> perldoc<ul><li> IPCとしてのSignal : <a class="externallink" href="http://perldoc.perl.org/perlipc.html#Signals" target="_blank">http://perldoc.perl.org/perlipc.html#Signals</a></li>
<li> 遅延(&quot;Deferred&quot;)シグナルについて : <a class="externallink" href="http://perldoc.perl.org/perlipc.html#Deferred-Signals-" target="_blank">http://perldoc.perl.org/perlipc.html#Deferred-Signals-</a>(Safe-Signals)</li>
<li> &quot;sigtrap&quot;プラグマ : <a class="externallink" href="http://perldoc.perl.org/sigtrap.html" target="_blank">http://perldoc.perl.org/sigtrap.html</a></li>
<li> POSIX signal : <a class="externallink" href="http://perldoc.perl.org/POSIX.html" target="_blank">http://perldoc.perl.org/POSIX.html</a></li></ul></li>
<li> Cライブラリの解説(Linux JMan)<ul><li> signal(2) : <a class="externallink" href="http://www.linux.or.jp/JM/html/LDP_man-pages/man2/signal.2.html" target="_blank">http://www.linux.or.jp/JM/html/LDP_man-pages/man2/signal.2.html</a></li>
<li> sigaction(2) : <a class="externallink" href="http://www.linux.or.jp/JM/html/LDP_man-pages/man2/sigaction.2.html" target="_blank">http://www.linux.or.jp/JM/html/LDP_man-pages/man2/sigaction.2.html</a></li>
<li> sigprocmask(2) : <a class="externallink" href="http://www.linux.or.jp/JM/html/LDP_man-pages/man2/sigprocmask.2.html" target="_blank">http://www.linux.or.jp/JM/html/LDP_man-pages/man2/sigprocmask.2.html</a></li>
<li> sigsetopts(3) : <a class="externallink" href="http://www.linux.or.jp/JM/html/LDP_man-pages/man3/sigsetops.3.html" target="_blank">http://www.linux.or.jp/JM/html/LDP_man-pages/man3/sigsetops.3.html</a></li></ul></li>
<li> 他、POSIX系のサンプルや&quot;re-entrant&quot;問題を扱っているHP<ul><li> <a class="externallink" href="http://www.nurs.or.jp/~sug/soft/super/signal.htm" target="_blank">http://www.nurs.or.jp/~sug/soft/super/signal.htm</a></li>
<li> <a class="externallink" href="http://d.hatena.ne.jp/yupo5656/20060114/p1" target="_blank">http://d.hatena.ne.jp/yupo5656/20060114/p1</a></li></ul></li></ul>

<h3 id="id1eda43">Perlでのシグナル操作はCライブラリの signal(3) ベース</h3>

<p class="paragraph">
前掲のperlipcで&quot;signal(3)&quot;で検索すれば見つかるが、Perlでのシグナル処理は基本的にsignal(3)をベースにしている。そのため、sigprocmask(2)やsigsetopts(3)を経由したシグナルのブロッキングはそのままではできない。(POSIXを利用すれば別だが、そうすると次にメモした&quot;Deferred&quot;シグナル機構を迂回してしまう。)
<br />
</p>

<p class="paragraph">
シグナルのブロッキングについては、&quot;local&quot;を用いた巧妙な手法がperlipcに載っている。
<br />
</p>
<pre>sub sig_blocked {
    local $SIG{ALRM} = &#039;IGNORE&#039;;
    &amp;blocked_routine;
}
sub blocked_routine {
    # SIGALRMについてブロック中である
}
</pre>

<p class="paragraph">
&quot;local&quot;により、%SIGの元の値はスタックに積まれ、sig_blockedを抜けると戻される。blocked_routine()中はSIGALRMを受信しても無視されるようになる。
<br />
</p>

<h3 id="idc49aae">Perl 5.7.3 以降の&quot;Deferred&quot;シグナル機構(コード最適指向の遅延シグナル検出機構？)</h3>

<p class="paragraph">
perlipcに専用の節が設けられているほど重要である。
<br />
</p>

<p class="paragraph">
つまり、Perl 5.7.3 以降については、%SIGを用いる限り、<strong> Perlの内部処理中にシグナルハンドラに飛ぶような事は無くなった </strong>と言うことらしい。
<br />
たとえIOを処理中であっても、Perlは内部で<strong> 適当に区切りの良いところで </strong>シグナルが受信されたかチェックしており、もしIO読み書き中でも、シグナルハンドラ処理後ちゃんと再開してくれるらしい。内部的には、Perlはopコードを順繰りに読み進めているわけだが、ちょうどopコードの切れ目のタイミングでシグナルをチェックしてくれているらしい<span class="hidden">(</span><a class="footnote" href="#footnote_110_2" id="footnote_110_2_r"  title="これも幾つかの&quot;safe point&quot;の一例であり、他にもPerlが&quot;safe point&quot;と認めているタイミングで、シグナルのフラグをチェックしているようである。">*2</a><span class="hidden">)</span>。
<br />
これにより、例えばopコードそれ自体の処理中(メモリIOが発生するタイミングなど)で突然シグナルハンドラに飛んでしまう、というような事はなくなり、全般的に安定性の向上につながっているようだ。
<br />
</p>

<h3 id="id2be179">POSIX モジュールベースも利用可能(但し&quot;Deffered&quot;シグナルは意味無しに?)</h3>

<p class="paragraph">
sigaction(2)系を使用したい場合、POSIXモジュールからクラスや関数が提供されている。詳細はPOSIXモジュールのperldocを参照。
<br />
</p>

<p class="paragraph">
但し、perlipcの&quot;Deferred&quot;シグナルの節でもきっちり釘を刺されているが、POSIXを使用する場合、%SIGによる&quot;Deferred&quot;シグナル機構の恩恵を享受できなくなる。つまりPerl内部処理中にシグナルハンドラに入ることによるメモリ・IOの不具合が発生しうるという点に注意する必要がある。
<br />
</p>

<h3 id="id135d73">結局詳細は&quot;Perl Cookbook&quot;待ち？</h3>

<p class="paragraph">
載ってるかなあ・・・。Amazonに注文はしてありますが、まだ届いてないです。
<br />
</p>

<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-138.html" title="Perl/codepiece/setuid03">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-111.html" title="Perl/codepiece/static_vars1">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-109.html" title="Perl">Perl</a>&nbsp;]</li>
</ul><div class="footnote">
<a id="footnote_110_1" href="#footnote_110_1_r">*1</a>: プロセス中で同時に呼ばれることを想定せず、プロセスコンテキスト中でグローバル変数を裏側で持ってしまっている、標準関数など<br />
<a id="footnote_110_2" href="#footnote_110_2_r">*2</a>: これも幾つかの&quot;safe point&quot;の一例であり、他にもPerlが&quot;safe point&quot;と認めているタイミングで、シグナルのフラグをチェックしているようである。
</div>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/110<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2007 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>