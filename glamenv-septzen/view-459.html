<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Java/clas3hift/失敗談 - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">Java/clas3hift/失敗談</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2009-10-12 19:42:14 &nbsp; / &nbsp; last updated at: 2009-10-12 19:42:58<br>
カテゴリ: <a href="category-11.html">Java</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-458.html" title="Java/clas3hift">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-1072.html" title="Java/com.sun.tools.javac.Main, Compiler API, tools.jar 今昔メモ">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-457.html" title="Java">Java</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
clas3hiftで挫折した経緯についてつらつらと。
<br />
</p>

<ul><li> clas3hift, Apache License 2.0<ul><li> <a class="externallink" href="http://code.google.com/p/clas3hift/" target="_blank">http://code.google.com/p/clas3hift/</a></li></ul></li></ul>

<p class="paragraph">
<a href="./view-458.html" >Java/clas3hift</a> でclas3hiftを紹介したが、現実的には殆ど使えない。SandBox環境でインナークラス・ネストクラス記法が使えないのは不便だし、なにより差し替え対象となるクラスに制限が大きすぎる。
<br />
</p>

<p class="paragraph">
10/10, 11, 12 の３連休をclas3hiftに費やした(実際には正味二日間ほど)が、どこで躓いたのか、何故あんなに制限だらけになっているのか、振り返ってみたい。なお思いつくままに適当に書いていくので、実際に手を動かした順番にはなっていない。
<br />
</p>



<ul><li><a href="#id822ded">SandBoxでインナークラス・ネストクラスが使えないので躓いた</a></li>
<li><a href="#id52e833">クラスの差し替えでBCELを導入した件</a></li>
<li><a href="#ide04ae7">なぜ差し替えクラスでnewしたらJVMがハングするのか</a></li>
<li><a href="#id842ed7">なぜ差し替えクラスではstaticフィールドが使えないか</a></li>
<li><a href="#id63a630">BCELを使った簡易Dumper</a></li>
<li><a href="#id7c33bb">最後に</a></li></ul>
<hr />
<h3 id="id822ded">SandBoxでインナークラス・ネストクラスが使えないので躓いた</h3>

<p class="paragraph">
clas3hiftのSandBoxはインライン記法が使えない。実は実験コードを作っていた当初はインライン記法で作っていた。
<br />
</p>
<div class="hl-main"><pre><span class="hl-comment">//</span><span class="hl-comment"> 実験してた時のコード。Clas3hiftがやってる事をmain()の中でやってる感じ。</span><span class="hl-comment"></span><span class="hl-code">
</span><span class="hl-reserved">public</span><span class="hl-code"> </span><span class="hl-reserved">class</span><span class="hl-code"> </span><span class="hl-identifier">Main</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-reserved">public</span><span class="hl-code"> </span><span >static</span><span class="hl-code"> </span><span >void</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span class="hl-identifier">String</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-code"> </span><span class="hl-identifier">args</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-reserved">throws</span><span class="hl-code"> </span><span class="hl-identifier">Exception</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">MyClassLoader</span><span class="hl-code"> </span><span class="hl-identifier">MyCL2</span><span class="hl-code"> = </span><span class="hl-reserved">new</span><span class="hl-code"> </span><span class="hl-identifier">MyClassLoader</span><span class="hl-brackets">(</span><span class="hl-identifier">Main</span><span class="hl-code">.</span><span class="hl-reserved">class</span><span class="hl-code">.</span><span class="hl-identifier">getClassLoader</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">MyCL2</span><span class="hl-code">.</span><span class="hl-identifier">register</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">Foo0</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">Foo1</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">SandBox</span><span class="hl-code"> </span><span class="hl-identifier">sb2</span><span class="hl-code"> = </span><span class="hl-identifier">MyCL2</span><span class="hl-code">.</span><span class="hl-identifier">surround</span><span class="hl-brackets">(</span><span class="hl-reserved">new</span><span class="hl-code"> </span><span class="hl-identifier">SandBox</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
            </span><span class="hl-reserved">public</span><span class="hl-code"> </span><span >void</span><span class="hl-code"> </span><span class="hl-identifier">sandbox</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
                </span><span class="hl-identifier">String</span><span class="hl-code"> </span><span class="hl-identifier">s</span><span class="hl-code"> = </span><span class="hl-identifier">Foo0</span><span class="hl-code">.</span><span class="hl-identifier">getName</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
                </span><span class="hl-identifier">System</span><span class="hl-code">.</span><span class="hl-identifier">out</span><span class="hl-code">.</span><span class="hl-identifier">println</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">foobar = </span><span class="hl-quotes">&quot;</span><span class="hl-code"> + </span><span class="hl-identifier">s</span><span class="hl-brackets">)</span><span class="hl-code">;
            </span><span class="hl-brackets">}</span><span class="hl-code">
        </span><span class="hl-brackets">}</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">sb2</span><span class="hl-code">.</span><span class="hl-identifier">sandbox</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-brackets">}</span></pre></div>
<p class="paragraph">
注意したいのは、staticメソッドの中でインナークラスを作っている点。
<br />
これで動いていたので、喜んでJUnitのテストコードに組み込んだ。
<br />
</p>
<pre>@Test
public void Cla() throws ClassNotFoundException {
    Clas3hift cs = new Clas3hift();
    cs.play(new SandBox() {
        public void sandbox(Map&lt;String, Object&gt; result) {
        }
    });
}
</pre>
<p class="paragraph">
ところが、JUnitのテストコードの場合はインスタンス化され、インスタンスメソッドとして実行される。
<br />
インスタンスメソッド内でのインナークラスの場合、Javaコンパイラがコンパイル時に外部インスタンスへの参照を注入する為のフィールドとコンストラクタを自動的に組み込んでしまう。
<br />
例えばSandBoxを使ってこういうクラスを作ってみる。
<br />
</p>
<div class="hl-main"><pre><span class="hl-reserved">public</span><span class="hl-code"> </span><span class="hl-reserved">class</span><span class="hl-code"> </span><span class="hl-identifier">Test</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-reserved">public</span><span class="hl-code"> </span><span >void</span><span class="hl-code"> </span><span class="hl-identifier">m1</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">SandBox</span><span class="hl-code"> </span><span class="hl-identifier">sb</span><span class="hl-code"> = </span><span class="hl-reserved">new</span><span class="hl-code"> </span><span class="hl-identifier">SandBox</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
            </span><span class="hl-reserved">public</span><span class="hl-code"> </span><span >void</span><span class="hl-code"> </span><span class="hl-identifier">sandbox</span><span class="hl-brackets">(</span><span class="hl-identifier">Map</span><span class="hl-code">&lt;</span><span class="hl-identifier">String</span><span class="hl-code">, </span><span class="hl-identifier">Object</span><span class="hl-code">&gt; </span><span class="hl-identifier">result</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-brackets">}</span><span class="hl-code">
        </span><span class="hl-brackets">}</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-brackets">}</span></pre></div>
<p class="paragraph">
インナークラスは&quot;Test$1&quot;というクラス名で、Test$1.classに出力される。これをjavapで解析してみると・・・
<br />
</p>
<pre class="plugin_pre">
&gt; javap -c Test$1
Compiled from &quot;Test.java&quot;
class Test$1 extends java.lang.Object implements junit.extensions.clas3hift.SandBox{
final Test this$0;

Test$1(Test);
  Code:
   0:   aload_0
   1:   aload_1
   2:   putfield        #1; //Field this$0:LTest;
   5:   aload_0
   6:   invokespecial   #2; //Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V
   9:   return

public void sandbox(java.util.Map);
  Code:
   0:   return

}
</pre>
<p class="paragraph">
&quot;this$0&quot;フィールドが増えているし、コンストラクタの引数に外部のTestクラスが必要になったりしている。Javaコードに戻せばこんな感じだろう。
<br />
</p>
<div class="hl-main"><pre><span class="hl-reserved">class</span><span class="hl-code"> </span><span class="hl-identifier">Test</span><span class="hl-code">$</span><span class="hl-number">1</span><span class="hl-code"> </span><span class="hl-reserved">extends</span><span class="hl-code"> </span><span class="hl-identifier">java</span><span class="hl-code">.</span><span class="hl-identifier">lang</span><span class="hl-code">.</span><span class="hl-identifier">Object</span><span class="hl-code"> </span><span class="hl-reserved">implements</span><span class="hl-code"> </span><span class="hl-identifier">junit</span><span class="hl-code">.</span><span class="hl-identifier">extensions</span><span class="hl-code">.</span><span class="hl-identifier">clas3hift</span><span class="hl-code">.</span><span class="hl-identifier">SandBox</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span >final</span><span class="hl-code"> </span><span class="hl-identifier">Test</span><span class="hl-code"> </span><span class="hl-reserved">this</span><span class="hl-code">$</span><span class="hl-number">0</span><span class="hl-code">;
    </span><span class="hl-identifier">Test</span><span class="hl-code">$</span><span class="hl-number">1</span><span class="hl-brackets">(</span><span class="hl-identifier">Test</span><span class="hl-code"> </span><span class="hl-identifier">t</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-reserved">this</span><span class="hl-code">$</span><span class="hl-number">0</span><span class="hl-code"> = </span><span class="hl-identifier">t</span><span class="hl-code">;
        </span><span class="hl-reserved">super</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-comment">//</span><span class="hl-comment"> ...</span><span class="hl-comment"></span><span class="hl-code">
</span><span class="hl-brackets">}</span></pre></div>
<p class="paragraph">
と言うわけで、実験時はstaticメソッド内でインナークラス化していたためコンストラクタはそのままだったが、JUnitのテストコードになるとコンストラクタが外部クラスに依存して書き換わってしまう。
<br />
clas3hift側としては外部クラス名がどうなるかなど分かりようも無いし、外部クラスを取り出す上手い方法も分からない。そのため、今のところは別クラスにSandBoxを分離する方針にしている。
<br />
</p>

<p class="paragraph">
思いつきで対応させるなら、以下のような対処になるだろうか。
<br />
</p>
<ol><li> Clas3hiftのコンストラクタで、インナークラス使用時の外部クラスのインスタンスを取るようなのを追加する。</li>
<li> SandBoxのクラスを独自CLで定義し、SandBoxインスタンスを生成する時に、上で取得したインスタンスを引数に取るコンストラクタが定義されているかチェックし、定義されていればそちらを使う。</li></ol>

<h3 id="id52e833">クラスの差し替えでBCELを導入した件</h3>

<p class="paragraph">
実験を開始した当初はまさかBCELを導入する事になるなど思っていなかった。
<br />
独自CLのregister(String, String)メソッドも、実は最初は以下のように、差し替えるクラスのClassオブジェクトを取っていた。
<br />
</p>
<pre>register(String name, Class new_class)
</pre>
<p class="paragraph">
使う時も
<br />
</p>
<pre>CL.register(&quot;test.stub.Foo0&quot;, test.stub.Foo1.class);
</pre>
<p class="paragraph">
というのを想定していた。register()メソッドの中身はすごい単純で、
<br />
</p>
<pre>register(String old, Class new_class) {
    this._replaces.put(old, new_class);
}
</pre>
<p class="paragraph">
だけだった。独自CLでオーバーライドしているloadClass()は次のようになっているので、一見、これでOKな気がしていた。
<br />
</p>
<pre>protected final Class loadClass(String name, boolean resolve)
    throws ClassNotFoundException 
{
    Class clazz = (Class)_replaces.get(name);
    if (null != clazz) {
        return clazz;
    } else {
        ClassLoader parent = getParent();
        Class r = super.loadClass(name, resolve);
        return r;
    }
}
</pre>
<p class="paragraph">
これで、SandBox中で
<br />
</p>
<pre>Foo0.staticMethod()
</pre>
<p class="paragraph">
というのが出てくれば、loadClass()がtest.stub.Foo1クラスを返すようになるからいけるだろうと踏んでいたのだが・・・どうしても
<br />
</p>
<pre>java.lang.NoClassDefFoundError: test/stub/Foo0
</pre>
<p class="paragraph">
という例外が出てしまう。
<br />
</p>

<p class="paragraph">
この段になってようやく、「あ、loadしたクラス名が実際は違うからエラーになるのか」という事に気づき、ここで「クラス名はクラスの中身にあるから・・・バイトコード弄らないと駄目かーーーー！！！」ということで、BCELを使い始めた次第。
<br />
</p>

<h3 id="ide04ae7">なぜ差し替えクラスでnewしたらJVMがハングするのか</h3>

<p class="paragraph">
BCELを導入して、とりあえず差し替えてみてstaticメソッドの戻り値が切り替わり、良かった良かった・・・と喜んだのも束の間だった。
<br />
「よし、ではインスタンスを作成してみて、インスタンスメソッドも切り替わるか確認してみよう」と以下のようなコードを書いた。
<br />
</p>
<pre>public void sandbox(Map&lt;String, Object&gt; result) {
    // ...
    Foo0 o = null;
    o = new Foo0();
    // ...
}
</pre>
<p class="paragraph">
Foo0は裏側でFoo1に差し替えられている。Foo1はFoo0を継承している。
<br />
すると、JVMが new のところでCPU使用率フルに達し、応答しなくなる現象が発生した。
<br />
</p>

<p class="paragraph">
BCELでクラスのメソッドのコードをダンプしたりしてようやく原因が分かった。
<br />
まずFoo0クラスを厳密に書いてみると、次のようになっていた。
<br />
</p>
<div class="hl-main"><pre><span class="hl-reserved">public</span><span class="hl-code"> </span><span class="hl-reserved">class</span><span class="hl-code"> </span><span class="hl-identifier">Foo0</span><span class="hl-code"> </span><span class="hl-reserved">extends</span><span class="hl-code"> </span><span class="hl-identifier">java</span><span class="hl-code">.</span><span class="hl-identifier">lang</span><span class="hl-code">.</span><span class="hl-identifier">Object</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-reserved">public</span><span class="hl-code"> &lt;</span><span class="hl-identifier">init</span><span class="hl-code">&gt;</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-reserved">super</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">; </span><span class="hl-comment">//</span><span class="hl-comment"> = java.lang.Object.&lt;init&gt;()</span><span class="hl-comment"></span><span class="hl-code">
    </span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-brackets">}</span></pre></div>
<p class="paragraph">
&quot;&lt;init&gt;&quot;というのはバイトコードレベルでのコンストラクタメソッド名になる。
<br />
次にFoo1のクラスを示すと、次のようになる。
<br />
</p>
<div class="hl-main"><pre><span class="hl-reserved">public</span><span class="hl-code"> </span><span class="hl-reserved">class</span><span class="hl-code"> </span><span class="hl-identifier">Foo1</span><span class="hl-code"> </span><span class="hl-reserved">extends</span><span class="hl-code"> </span><span class="hl-identifier">Foo0</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-reserved">public</span><span class="hl-code"> &lt;</span><span class="hl-identifier">init</span><span class="hl-code">&gt;</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-reserved">super</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">; </span><span class="hl-comment">//</span><span class="hl-comment"> = Foo0.&lt;init&gt;()</span><span class="hl-comment"></span><span class="hl-code">
    </span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-brackets">}</span></pre></div>
<p class="paragraph">
Foo0, Foo1のコンストラクタは指定していなかった為、上に示したのはJavaコンパイラが作成したデフォルトコンストラクタになる。
<br />
</p>

<p class="paragraph">
さて、Clas3hiftがBCELでFoo1クラスを書き換えるのは、クラス名とその親クラス名である。もちろんその前に、Foo0クラスは &quot;Foo0$(衝突しないランダムコード)&quot; というクラス名に置き換えてdefineClass()している。よってFoo1は次のように書き換わる。
<br />
</p>
<div class="hl-main"><pre><span class="hl-reserved">public</span><span class="hl-code"> </span><span class="hl-reserved">class</span><span class="hl-code"> </span><span class="hl-identifier">Foo0</span><span class="hl-code"> </span><span class="hl-reserved">extends</span><span class="hl-code"> </span><span class="hl-identifier">Foo0</span><span class="hl-code">$</span><span class="hl-brackets">(</span><span class="hl-code">衝突しないランダムコード</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-reserved">public</span><span class="hl-code"> &lt;</span><span class="hl-identifier">init</span><span class="hl-code">&gt;</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-reserved">super</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">; </span><span class="hl-comment">//</span><span class="hl-comment"> = Foo0.&lt;init&gt;()</span><span class="hl-comment"></span><span class="hl-code">
    </span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-brackets">}</span></pre></div>
<p class="paragraph">
コンストラクタの中までは書き換えていない。よって、この状態で
<br />
</p>
<pre>new Foo0()
</pre>
<p class="paragraph">
したら、Foo0.&lt;init&gt;()の中でやはりFoo0.&lt;init&gt;()が呼ばれるという無限ループに突入する。
<br />
</p>

<p class="paragraph">
同様の理由で、Foo1側ではFoo0のstaticメソッドを呼び出せない。つまりFoo0のstaticメソッドをオーバーライドし、条件によってはFoo0側に委譲することが出来ない。
<br />
</p>
<div class="hl-main"><pre><span class="hl-reserved">class</span><span class="hl-code"> </span><span class="hl-identifier">Foo1</span><span class="hl-code"> </span><span class="hl-reserved">extends</span><span class="hl-code"> </span><span class="hl-identifier">Foo0</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-reserved">public</span><span class="hl-code"> </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">calcABC</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">arg</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-number">100</span><span class="hl-code"> == </span><span class="hl-identifier">arg</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
            </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">101</span><span class="hl-code">; </span><span class="hl-comment">//</span><span class="hl-comment"> for test return</span><span class="hl-comment"></span><span class="hl-code">
        </span><span class="hl-brackets">}</span><span class="hl-code"> </span><span class="hl-reserved">else</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
            </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">Foo0</span><span class="hl-code">.</span><span class="hl-identifier">calcABC</span><span class="hl-brackets">(</span><span class="hl-identifier">arg</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-brackets">}</span></pre></div>
<p class="paragraph">
このようなstaticメソッドは作れない。なぜなら、Foo0.calcABC()の部分まではBCELで書き換えていない為、コンストラクタと同様、 argが100以外の場合は Foo0.calcABC() -&gt; Foo0.calcABC() -&gt; Foo0.calcABC()... と無限ループに突入してしまうからである。
<br />
</p>

<p class="paragraph">
これに対処しようとしたら、差し替え用のFoo1クラスのメソッドのインストラクションを逐一チェックし、Foo0クラスを参照しているところをFoo0$(衝突しないランダムコード)に置換する必要がある。そこまでできる技術力が今は無かった為、やむなく、インスタンスを作って使うタイプのクラスはサポート外とした。
<br />
</p>

<h3 id="id842ed7">なぜ差し替えクラスではstaticフィールドが使えないか</h3>

<p class="paragraph">
まず以下のようなFoo0, Foo1クラスを用意する。
<br />
</p>
<pre>public class Foo0 {
    static String name = &quot;Foo0&quot;;
}
</pre>

<pre>public class Foo1 extends Foo0 {
    public Foo1() {}
    static String name = &quot;Foo1&quot;;
}
</pre>

<p class="paragraph">
Foo1クラスを、BCELを使ってダンプする。ダンプには後述のDumperクラスを使う。
<br />
</p>
<pre class="plugin_pre">
&gt; java -cp .;bcel-5.2.jar Dumper Foo1
==============================================
classname = Foo1
superclassname = Foo0
----------------------------------------------
----------------------------------------------
fields[0] = static String name
  name = name
  sign = Ljava/lang/String;
  synthetic = false
----------------------------------------------
methods[0] = public void &lt;init&gt;()
  name = &lt;init&gt;
  sign = ()V
  synthetic = false
  ret = void
  code = Code(max_stack = 1, max_locals = 1, code_length = 5)
0:    aload_0
1:    invokespecial     Foo0.&lt;init&gt; ()V (1)
4:    return

Attribute(s) =
LineNumber(0, 2)

methods[1] = static void &lt;clinit&gt;()
  name = &lt;clinit&gt;
  sign = ()V
  synthetic = false
  ret = void
  code = Code(max_stack = 1, max_locals = 0, code_length = 6)
0:    ldc               &quot;Foo1&quot; (2)
2:    putstatic         Foo1.name Ljava/lang/String; (3)
5:    return

Attribute(s) =
LineNumber(0, 3)

==============================================
</pre>
<p class="paragraph">
staticフィールドが登場する為、&quot;&lt;clinit&gt;&quot;というクラス初期化用のメソッドがコンパイラにより追加されている。次の2行を見てみる。
<br />
</p>
<pre>0:    ldc               &quot;Foo1&quot; (2)
2:    putstatic         Foo1.name Ljava/lang/String; (3)
</pre>
<p class="paragraph">
このように、ここでもしっかり&quot;Foo1.name&quot;フィールドとしてクラス名がセットされてしまっている。
<br />
</p>

<p class="paragraph">
Clas3hiftの現時点(2009/10)の実装ではこれまで見てきたように、メソッド内部のインストラクションまでは書き換えていない。
<br />
従って、もしこれをClas3hiftでテストしようとすると、Foo1がFoo0にリネームされてdefineClass()され、そのクラス初期化で &quot;Foo1.name&quot; フィールドに値をセットしようとする。Foo1クラスは当然Foo0にリネームされているので見つからない。
<br />
</p>

<p class="paragraph">
・・・というのが、差し替えるクラスにはstaticフィールドが使えなくなった理由である。
<br />
</p>

<h3 id="id63a630">BCELを使った簡易Dumper</h3>

<p class="paragraph">
BCELを使うと、&quot;javap -c -s&quot; と同等の情報が取得できるようになる。Clas3hiftのように、BCELのJavaClassで操作していてクラスのバイトコードがオンメモリにしか存在しない場合は、次のようなダンプクラスがあると便利である。Clas3hiftのコードにも、似たようなコードを組み込んである。
<br />
</p>
<div class="hl-main"><pre><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">org</span><span class="hl-code">.</span><span class="hl-identifier">apache</span><span class="hl-code">.</span><span class="hl-identifier">bcel</span><span class="hl-code">.</span><span class="hl-identifier">Repository</span><span class="hl-code">;
</span><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">org</span><span class="hl-code">.</span><span class="hl-identifier">apache</span><span class="hl-code">.</span><span class="hl-identifier">bcel</span><span class="hl-code">.</span><span class="hl-identifier">classfile</span><span class="hl-code">.</span><span class="hl-identifier">JavaClass</span><span class="hl-code">;
</span><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">org</span><span class="hl-code">.</span><span class="hl-identifier">apache</span><span class="hl-code">.</span><span class="hl-identifier">bcel</span><span class="hl-code">.</span><span class="hl-identifier">classfile</span><span class="hl-code">.</span><span class="hl-identifier">Method</span><span class="hl-code">;
</span><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">org</span><span class="hl-code">.</span><span class="hl-identifier">apache</span><span class="hl-code">.</span><span class="hl-identifier">bcel</span><span class="hl-code">.</span><span class="hl-identifier">classfile</span><span class="hl-code">.</span><span class="hl-identifier">Field</span><span class="hl-code">;
 
</span><span class="hl-reserved">public</span><span class="hl-code"> </span><span class="hl-reserved">class</span><span class="hl-code"> </span><span class="hl-identifier">Dumper</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-reserved">public</span><span class="hl-code"> </span><span >static</span><span class="hl-code"> </span><span >void</span><span class="hl-code"> </span><span class="hl-identifier">dump</span><span class="hl-brackets">(</span><span class="hl-identifier">Class</span><span class="hl-code"> </span><span class="hl-identifier">clazz</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-reserved">throws</span><span class="hl-code"> </span><span class="hl-identifier">Exception</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">JavaClass</span><span class="hl-code"> </span><span class="hl-identifier">jc</span><span class="hl-code"> = </span><span class="hl-identifier">Repository</span><span class="hl-code">.</span><span class="hl-identifier">lookupClass</span><span class="hl-brackets">(</span><span class="hl-identifier">clazz</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">Dumper</span><span class="hl-code">.</span><span class="hl-identifier">dump</span><span class="hl-brackets">(</span><span class="hl-identifier">jc</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">public</span><span class="hl-code"> </span><span >static</span><span class="hl-code"> </span><span >void</span><span class="hl-code"> </span><span class="hl-identifier">dump</span><span class="hl-brackets">(</span><span class="hl-identifier">String</span><span class="hl-code"> </span><span class="hl-identifier">clazz</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-reserved">throws</span><span class="hl-code"> </span><span class="hl-identifier">Exception</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">JavaClass</span><span class="hl-code"> </span><span class="hl-identifier">jc</span><span class="hl-code"> = </span><span class="hl-identifier">Repository</span><span class="hl-code">.</span><span class="hl-identifier">lookupClass</span><span class="hl-brackets">(</span><span class="hl-identifier">clazz</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">Dumper</span><span class="hl-code">.</span><span class="hl-identifier">dump</span><span class="hl-brackets">(</span><span class="hl-identifier">jc</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">public</span><span class="hl-code"> </span><span >static</span><span class="hl-code"> </span><span >void</span><span class="hl-code"> </span><span class="hl-identifier">dump</span><span class="hl-brackets">(</span><span class="hl-identifier">JavaClass</span><span class="hl-code"> </span><span class="hl-identifier">jc</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-reserved">throws</span><span class="hl-code"> </span><span class="hl-identifier">Exception</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">String</span><span class="hl-code"> </span><span class="hl-identifier">s</span><span class="hl-code"> = </span><span class="hl-identifier">jc</span><span class="hl-code">.</span><span class="hl-identifier">getClassName</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">System</span><span class="hl-code">.</span><span class="hl-identifier">out</span><span class="hl-code">.</span><span class="hl-identifier">println</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">==============================================</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">System</span><span class="hl-code">.</span><span class="hl-identifier">out</span><span class="hl-code">.</span><span class="hl-identifier">println</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">classname = </span><span class="hl-quotes">&quot;</span><span class="hl-code"> + </span><span class="hl-identifier">s</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">s</span><span class="hl-code"> = </span><span class="hl-identifier">jc</span><span class="hl-code">.</span><span class="hl-identifier">getSuperclassName</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">System</span><span class="hl-code">.</span><span class="hl-identifier">out</span><span class="hl-code">.</span><span class="hl-identifier">println</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">superclassname = </span><span class="hl-quotes">&quot;</span><span class="hl-code"> + </span><span class="hl-identifier">s</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">System</span><span class="hl-code">.</span><span class="hl-identifier">out</span><span class="hl-code">.</span><span class="hl-identifier">println</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">----------------------------------------------</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">String</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-code"> </span><span class="hl-identifier">interfaces</span><span class="hl-code"> = </span><span class="hl-identifier">jc</span><span class="hl-code">.</span><span class="hl-identifier">getInterfaceNames</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">for</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">i</span><span class="hl-code"> = </span><span class="hl-number">0</span><span class="hl-code">; </span><span class="hl-identifier">i</span><span class="hl-code"> &lt; </span><span class="hl-identifier">interfaces</span><span class="hl-code">.</span><span class="hl-identifier">length</span><span class="hl-code">; </span><span class="hl-identifier">i</span><span class="hl-code">++</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
            </span><span class="hl-identifier">System</span><span class="hl-code">.</span><span class="hl-identifier">out</span><span class="hl-code">.</span><span class="hl-identifier">println</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">interface[</span><span class="hl-quotes">&quot;</span><span class="hl-code"> + </span><span class="hl-identifier">i</span><span class="hl-code"> + </span><span class="hl-quotes">&quot;</span><span class="hl-string">] = </span><span class="hl-quotes">&quot;</span><span class="hl-code"> + </span><span class="hl-identifier">interfaces</span><span class="hl-brackets">[</span><span class="hl-identifier">i</span><span class="hl-brackets">]</span><span class="hl-code">.</span><span class="hl-identifier">toString</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code">
        </span><span class="hl-identifier">System</span><span class="hl-code">.</span><span class="hl-identifier">out</span><span class="hl-code">.</span><span class="hl-identifier">println</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">----------------------------------------------</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">Field</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-code"> </span><span class="hl-identifier">fields</span><span class="hl-code"> = </span><span class="hl-identifier">jc</span><span class="hl-code">.</span><span class="hl-identifier">getFields</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">for</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">i</span><span class="hl-code"> = </span><span class="hl-number">0</span><span class="hl-code">; </span><span class="hl-identifier">i</span><span class="hl-code"> &lt; </span><span class="hl-identifier">fields</span><span class="hl-code">.</span><span class="hl-identifier">length</span><span class="hl-code">; </span><span class="hl-identifier">i</span><span class="hl-code">++</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
            </span><span class="hl-identifier">System</span><span class="hl-code">.</span><span class="hl-identifier">out</span><span class="hl-code">.</span><span class="hl-identifier">println</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">fields[</span><span class="hl-quotes">&quot;</span><span class="hl-code"> + </span><span class="hl-identifier">i</span><span class="hl-code"> + </span><span class="hl-quotes">&quot;</span><span class="hl-string">] = </span><span class="hl-quotes">&quot;</span><span class="hl-code"> + </span><span class="hl-identifier">fields</span><span class="hl-brackets">[</span><span class="hl-identifier">i</span><span class="hl-brackets">]</span><span class="hl-code">.</span><span class="hl-identifier">toString</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
            </span><span class="hl-identifier">System</span><span class="hl-code">.</span><span class="hl-identifier">out</span><span class="hl-code">.</span><span class="hl-identifier">println</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">  name = </span><span class="hl-quotes">&quot;</span><span class="hl-code"> + </span><span class="hl-identifier">fields</span><span class="hl-brackets">[</span><span class="hl-identifier">i</span><span class="hl-brackets">]</span><span class="hl-code">.</span><span class="hl-identifier">getName</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
            </span><span class="hl-identifier">System</span><span class="hl-code">.</span><span class="hl-identifier">out</span><span class="hl-code">.</span><span class="hl-identifier">println</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">  sign = </span><span class="hl-quotes">&quot;</span><span class="hl-code"> + </span><span class="hl-identifier">fields</span><span class="hl-brackets">[</span><span class="hl-identifier">i</span><span class="hl-brackets">]</span><span class="hl-code">.</span><span class="hl-identifier">getSignature</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
            </span><span class="hl-identifier">System</span><span class="hl-code">.</span><span class="hl-identifier">out</span><span class="hl-code">.</span><span class="hl-identifier">println</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">  synthetic = </span><span class="hl-quotes">&quot;</span><span class="hl-code"> + </span><span class="hl-identifier">fields</span><span class="hl-brackets">[</span><span class="hl-identifier">i</span><span class="hl-brackets">]</span><span class="hl-code">.</span><span class="hl-identifier">isSynthetic</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code">
        </span><span class="hl-identifier">System</span><span class="hl-code">.</span><span class="hl-identifier">out</span><span class="hl-code">.</span><span class="hl-identifier">println</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">----------------------------------------------</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">Method</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-code"> </span><span class="hl-identifier">methods</span><span class="hl-code"> = </span><span class="hl-identifier">jc</span><span class="hl-code">.</span><span class="hl-identifier">getMethods</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">for</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">i</span><span class="hl-code"> = </span><span class="hl-number">0</span><span class="hl-code">; </span><span class="hl-identifier">i</span><span class="hl-code"> &lt; </span><span class="hl-identifier">methods</span><span class="hl-code">.</span><span class="hl-identifier">length</span><span class="hl-code">; </span><span class="hl-identifier">i</span><span class="hl-code">++</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
            </span><span class="hl-identifier">System</span><span class="hl-code">.</span><span class="hl-identifier">out</span><span class="hl-code">.</span><span class="hl-identifier">println</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">methods[</span><span class="hl-quotes">&quot;</span><span class="hl-code"> + </span><span class="hl-identifier">i</span><span class="hl-code"> + </span><span class="hl-quotes">&quot;</span><span class="hl-string">] = </span><span class="hl-quotes">&quot;</span><span class="hl-code"> + </span><span class="hl-identifier">methods</span><span class="hl-brackets">[</span><span class="hl-identifier">i</span><span class="hl-brackets">]</span><span class="hl-code">.</span><span class="hl-identifier">toString</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
            </span><span class="hl-identifier">System</span><span class="hl-code">.</span><span class="hl-identifier">out</span><span class="hl-code">.</span><span class="hl-identifier">println</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">  name = </span><span class="hl-quotes">&quot;</span><span class="hl-code"> + </span><span class="hl-identifier">methods</span><span class="hl-brackets">[</span><span class="hl-identifier">i</span><span class="hl-brackets">]</span><span class="hl-code">.</span><span class="hl-identifier">getName</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
            </span><span class="hl-identifier">System</span><span class="hl-code">.</span><span class="hl-identifier">out</span><span class="hl-code">.</span><span class="hl-identifier">println</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">  sign = </span><span class="hl-quotes">&quot;</span><span class="hl-code"> + </span><span class="hl-identifier">methods</span><span class="hl-brackets">[</span><span class="hl-identifier">i</span><span class="hl-brackets">]</span><span class="hl-code">.</span><span class="hl-identifier">getSignature</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
            </span><span class="hl-identifier">System</span><span class="hl-code">.</span><span class="hl-identifier">out</span><span class="hl-code">.</span><span class="hl-identifier">println</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">  synthetic = </span><span class="hl-quotes">&quot;</span><span class="hl-code"> + </span><span class="hl-identifier">methods</span><span class="hl-brackets">[</span><span class="hl-identifier">i</span><span class="hl-brackets">]</span><span class="hl-code">.</span><span class="hl-identifier">isSynthetic</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
            </span><span class="hl-identifier">System</span><span class="hl-code">.</span><span class="hl-identifier">out</span><span class="hl-code">.</span><span class="hl-identifier">println</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">  ret = </span><span class="hl-quotes">&quot;</span><span class="hl-code"> + </span><span class="hl-identifier">methods</span><span class="hl-brackets">[</span><span class="hl-identifier">i</span><span class="hl-brackets">]</span><span class="hl-code">.</span><span class="hl-identifier">getReturnType</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
            </span><span class="hl-identifier">System</span><span class="hl-code">.</span><span class="hl-identifier">out</span><span class="hl-code">.</span><span class="hl-identifier">println</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">  code = </span><span class="hl-quotes">&quot;</span><span class="hl-code"> + </span><span class="hl-identifier">methods</span><span class="hl-brackets">[</span><span class="hl-identifier">i</span><span class="hl-brackets">]</span><span class="hl-code">.</span><span class="hl-identifier">getCode</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code">
        </span><span class="hl-identifier">System</span><span class="hl-code">.</span><span class="hl-identifier">out</span><span class="hl-code">.</span><span class="hl-identifier">println</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">==============================================</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">public</span><span class="hl-code"> </span><span >static</span><span class="hl-code"> </span><span >void</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span class="hl-identifier">String</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-code"> </span><span class="hl-identifier">args</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-reserved">throws</span><span class="hl-code"> </span><span class="hl-identifier">Exception</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">Dumper</span><span class="hl-code">.</span><span class="hl-identifier">dump</span><span class="hl-brackets">(</span><span class="hl-identifier">args</span><span class="hl-brackets">[</span><span class="hl-number">0</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-brackets">}</span></pre></div>

<h3 id="id7c33bb">最後に</h3>

<p class="paragraph">
Javaのクラスについて初めて疑問を覚えたのが、JDBCのサンプルコードに出てきた
<br />
</p>
<pre>// JDBCドライバのロード
Class.forName(&quot;org.postgresql.Driver&quot;);
</pre>
<p class="paragraph">
である。初学者にとってはお馴染みであり、かつ「呪文」として「よく分からないけどこうしておく」という慣用句だと思う。
<br />
</p>

<p class="paragraph">
「・・・何コレ？」
<br />
というのが多分Classクラス、つまりJavaのクラスを読み込む仕組みについて疑問を覚えた最初だと思う。Javaは会社に入ってから覚えたので、多分2004年の春だと思う。
<br />
</p>

<p class="paragraph">
その後、2007年の5月位に、社内の技術研修でJavaの講師をする事になった。講師といっても、初心者向けにJavaを構成する技術要素であるとか、Javaと付き合う時にどの辺を押さえておくと楽か、JavaとOOPの関連は？という気軽なトピックを話した。
<br />
自分自身が疑問に感じていた &quot;Class.forName()&quot; について調べる機会としてIBMのdeveloperWorksの記事などにも手を広げ、ようやくClassLoaderであるとか、Servletコンテナでjarファイルの置き場所を間違えるとなんで動きがおかしくなるのかとか、ClassLoaderの委譲の仕組みとかを学ぶ事が出来た。
<br />
JavaVMSpecificationに初めて目を通したのもこの時だった。
<br />
</p>

<p class="paragraph">
で、2009年の10月、仕事で外の人達が作ったJavaのソースコードに機能を追加する事になった。
<br />
・・・単体テストコードが無かった。そして、中枢部分がstaticメソッドの集合であるユーティリティクラスを使いまくっていた為、単体テストコードを自分で書く余力も無かった。というか、そういった場合にどう単体テストコードを書けばよいのか見当が付かなかった。
<br />
</p>

<p class="paragraph">
というわけで、「実行時に、動的に、裏側で」クラスを差し替える Clas3hift (とその初期実験コード) に手を出す事になった。・・・といっても3連休だけだけど。
<br />
</p>

<p class="paragraph">
ようやくここで、実際にClassLoaderを作り、loadClass()を上書きし、defineClass()を使い、ClassLoaderのgetResourceAsStream()でCLASSPATH上のクラスファイルを読み出したりとかのコードを自分で試行錯誤しながら作る事が出来た。
<br />
さらにBCELにも手を出す事になった。社内研修の時の調査で JavaVM Spec に目を通し、バイトコードやインストラクション、classファイルのフォーマットについて「なんとなく」ではあるが頭に残っていたのが役に立った。
<br />
</p>

<p class="paragraph">
実に2004年から数えて5年目、ようやくClassLoaderの呪縛から解放された、とつくづく思う。自分の場合、こういう非常に低水準な部分での疑問について中々忘れる事が出来ず、ちまちまと別の仕事とかで手がかりを拾い集めたり偶然出会いつつ、数年後にようやく全て理解できた、というケースが大変多い。（その頃には世間はずっと先に進んでいるのだが・・・）
<br />
</p>

<p class="paragraph">
BCELは素直に面白いライブラリだと思う。バイト配列から実行時にクラスを定義できるJavaの柔軟さも、改めて面白いし便利だと思う。
<br />
締まりが付いていないが、そうした面白い世界を味わえたのだけでも、Clas3hiftに手を出した意義はあったと思う。
<br />
</p>

<p class="paragraph">
テストコードの書き方については、xUnitパターンや&quot;WORKING EFFECTIVELY with LEGACY CODE&quot;をきちんと読まなければ駄目だな、と思った。
<br />
王道を知らないから随分遠回りしている、とTDDについては特にそう思う。
<br />
</p>

<p class="paragraph">
最後の最後に、 clas3hift についてご意見や提案・突っ込みなどありましたら msakamoto-sf までメール下さい。「既にこういうライブラリで実装されているよ」という情報は特に歓迎します。
<br />
</p>

<p class="paragraph">
msakamoto-sf メールアドレス : <a class="maillink" href="mailto:%73%61%6b%61%6d%6f%74%6f%2d%67%73%79%63%2d%33%73%40%67%6c%61%6d%65%6e%76%2d%73%65%70%74%7a%65%6e%2e%6e%65%74">&#x73;&#x61;&#x6b;&#x61;&#x6d;&#x6f;&#x74;&#x6f;&#x2d;&#x67;&#x73;&#x79;&#x63;&#x2d;&#x33;&#x73;&#x40;&#x67;&#x6c;&#x61;&#x6d;&#x65;&#x6e;&#x76;&#x2d;&#x73;&#x65;&#x70;&#x74;&#x7a;&#x65;&#x6e;&#x2e;&#x6e;&#x65;&#x74;</a>
<br />
</p>






<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-458.html" title="Java/clas3hift">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-1072.html" title="Java/com.sun.tools.javac.Main, Compiler API, tools.jar 今昔メモ">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-458.html" title="Java/clas3hift">Up</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-457.html" title="Java">Java</a>&nbsp;]</li>
</ul>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/459<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2007 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>