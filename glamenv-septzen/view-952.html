<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>技術/Linux/手作りLinuxシステム/03. BusyBoxとuClibcを組み合わせる - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">技術/Linux/手作りLinuxシステム/03. BusyBoxとuClibcを組み合わせる</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2011-04-12 16:43:04 &nbsp; / &nbsp; last updated at: 2011-04-29 15:38:02<br>
カテゴリ: <a href="category-20.html">Linux</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-943.html" title="技術/Linux/手作りLinuxシステム/02. Boot from Floppy Disk (kernel-2.4.x)">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-953.html" title="技術/Linux/手作りLinuxシステム/04. Boot from CD (kernel-2.6.x)">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-23.html" title="技術">技術</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
<a href="./view-941.html" >技術/Linux/手作りLinuxシステム/01. Boot from Floppy Disk (kernel-2.6.x)</a> で使用したBusyBoxですが、Linuxカーネルのヘッダーファイルをincludeしています。2011年4月現在、BusyBoxのFAQ( <a class="externallink" href="http://www.busybox.net/FAQ.html" target="_blank">http://www.busybox.net/FAQ.html</a> )にも
<br />
</p>
<pre>Programming questions &gt;
 8. Tips and tricks &gt;
  Including kernel headers
</pre>
<p class="paragraph">
という項目で「本当は避けたほうが良いんだけど、どうしてもincludeしなくちゃならない場面もある」云々と書かれています。
<br />
特に設定を行っていない場合、ホストマシンのインクルードパスが使われるので、ホストマシンにインストールされた&quot;kernel-headers&quot;パッケージ提供のヘッダーファイルが参照されます。
<br />
</p>

<p class="paragraph">
どうせなら、ターゲットのLinuxカーネルヘッダを参照したいですよね。
<br />
</p>

<p class="paragraph">
となるとlibcライブラリもターゲットのLinuxに合わせたいところです。しかしglibcはMB単位の大きさになってしまうのでフロッピーに収まりません。
<br />
そこで今回取り上げるのが uClibc という組み込み向けにコンパクト化されたCライブラリです。
<br />
</p>
<ul><li> uClibc<ul><li> <a class="externallink" href="http://www.uclibc.org/" target="_blank">http://www.uclibc.org/</a></li></ul></li></ul>

<p class="paragraph">
つまり
<br />
</p>
<pre>ターゲットのLinuxヘッダー + uClibc + BusyBox
</pre>
<p class="paragraph">
の組み合わせにすればBusyBoxが参照するヘッダーも、リンクするライブラリも、全てターゲットとするLinuxに合わせることが出来ます。
<br />
</p>

<p class="paragraph">
この手法は組み込みの世界でも使われているらしく、@ITのMONOistで連載記事が公開されています。大いに参考にさせてもらいました、ありがとうございます。
<br />
</p>
<ul><li> 連載記事「いますぐ使える！ BusyBox活用術」 － ＠IT MONOist<ul><li> <a class="externallink" href="http://monoist.atmarkit.co.jp/fembedded/index/busyboxtech.html" target="_blank">http://monoist.atmarkit.co.jp/fembedded/index/busyboxtech.html</a></li></ul></li></ul>

<p class="paragraph">
ということで、今回は kernel-2.6.x のFDブートの発展形というか改良型としてルートファイルシステム上のアプリケーションを BusyBox + uClibc で構築してみます。加えて、簡単なHelloWorldもuClibcをリンクするようコンパイル、動作確認してみましょう。
<br />
</p>



<ul><li><a href="#id4833ad">Linuxカーネルのヘッダーファイルのインストール (make headers_install)</a></li>
<li><a href="#id1bdf8e">uClibcの入手とビルド</a><ul><li><a href="#id455665">準備</a></li>
<li><a href="#id83e360">uClibcの設定</a></li>
<li><a href="#id9c9de2">uClibc, helloworld, ret1のビルド</a></li></ul></li>
<li><a href="#id3ce622">uClibcと動的リンクしたBusyBoxのビルド</a></li>
<li><a href="#id39997b">うまく動かないときは</a></li></ul>
<hr />
<h3 id="id4833ad">Linuxカーネルのヘッダーファイルのインストール (make headers_install)</h3>

<p class="paragraph">
最初に行うのがLinuxカーネルで
<br />
</p>
<pre>make headers_install
</pre>
<p class="paragraph">
です。
<br />
</p>

<p class="paragraph">
<a href="./view-941.html" >技術/Linux/手作りLinuxシステム/01. Boot from Floppy Disk (kernel-2.6.x)</a> の時点でのディレクトリ構成を復習します。
<br />
</p>
<pre>/home/msakamoto/reduced.linux/
  linux-2.6.38.2/      ... オリジナルのソースディレクトリ
  01_boot_from_fd_2.6/ ... ビルド用の出力ディレクトリ
</pre>

<p class="paragraph">
この構成ですと、単純に以下のオプションを指定すれば今回使うLinuxヘッダーを参照してくれそうです。
<br />
</p>
<pre>-nostdinc
-I/home/msakamoto/reduced.linux/01_boot_from_fd_2.6/include
-I/home/msakamoto/reduced.linux/linux-2.6.38.2/include
-I/home/msakamoto/reduced.linux/linux-2.6.38.2/arch/x86/include 
</pre>

<p class="paragraph">
ところが、実際にこれを指定してコンパイルしてみると次の警告が発生します。
<br />
</p>
<pre>.../linux-2.6.38.2/include/linux/types.h:13:2: warning: \
#warning &quot;Attempt to use kernel headers from user space, \
see http://kernelnewbies.org/KernelHeaders&quot;
</pre>
<p class="paragraph">
&quot;see&quot;で示されたURLを見てみると、Linuxカーネルのヘッダーファイルを正しく参照するには
<br />
</p>
<pre>make headers_install
</pre>
<p class="paragraph">
してインストールした先を参照すれば良いことが分かります。
<br />
</p>

<p class="paragraph">
一応 &quot;make help&quot; で説明を見てみます：
<br />
</p>
<pre>$ cd /home/msakamoto/reduced.linux/01_boot_from_fd_2.6
$ make help
...
  headers_install - Install sanitised kernel headers to INSTALL_HDR_PATH
                   (default: /home/msakamoto/reduced.linux/01_boot_from_fd_2.6/usr)
...
</pre>
<p class="paragraph">
デフォルトのインストール先を確認できました。ビルドディレクトリからの相対パスになっているので、そのままmakeしてみます。
<br />
</p>
<pre>$ make headers_install
make -C /home/msakamoto/reduced.linux/linux-2.6.38.2 \
     O=/home/msakamoto/reduced.linux/01_boot_from_fd_2.6/. \
     headers_install
  CHK     include/linux/version.h
  HOSTCC  scripts/unifdef
  INSTALL include/asm-generic (34 files)
...
$ cd usr/include/
$ pwd
/home/msakamoto/reduced.linux/01_boot_from_fd_2.6/usr/include
$ ls
asm/  asm-generic/  drm/  linux/  mtd/  rdma/  scsi/  sound/  video/  xen/
</pre>
<p class="paragraph">
ホストマシンの &quot;/usr/include/&quot; 以下と同様なレイアウトでカーネルヘッダーが配置されました。ここのパスをuClibc, BusyBoxをビルドするときのインクルードパスに指定します。
<br />
</p>

<h3 id="id1bdf8e">uClibcの入手とビルド</h3>

<p class="paragraph">
前掲のuClibcの公式HPからダウンロードします。今回は uClibc-0.9.31.tar.bz2 を使いました。
<br />
</p>

<pre>$ pwd
/home/msakamoto/reduced.linux
$ ls
... uClibc-0.9.31.tar.bz2 ...
$ tar jxf uClibc-0.9.31.tar.bz2
$ cd uClibc-0.9.31
</pre>

<h4 id="id455665">準備</h4>

<p class="paragraph">
<a href="./view-949.html" >技術/Linux/uClibc/03, x86(32bit) PC環境でuClibcを試す</a> を参考に &quot;libc/misc/time/time.c&quot;, &quot;extra/scripts/install_headers.sh&quot; を修正します。
<br />
今回は &quot;03_bb_and_uclibc&quot; というディレクトリを新たに作り、そのなかで実験してみます。
<br />
</p>
<pre>$ mkdir /home/msakamoto/reduced.linux/03_bb_and_uclibc
</pre>

<p class="paragraph">
<a href="./view-949.html" >技術/Linux/uClibc/03, x86(32bit) PC環境でuClibcを試す</a> で紹介したMakefile, ret1.c, helloworld.c, specs を流用します。&quot;uclibc_test/&quot; を作って実験した環境があれば、コピーします。
<br />
</p>
<pre>$ pushd ./uclibc_test
$ cp Makefile ret1.c helloworld.c specs ../03_bb_and_uclibc/
$ popd
</pre>

<p class="paragraph">
uClibcの実行環境のインストール先は、前々回作成したルートファイルシステムを流用します。uClibcのビルド後もhelloworld, ret1のビルドで使いますので、別端末でログインし、マウントしたままにしておきます。
<br />
</p>
<pre>$ pwd
/home/msakamoto/reduced.linux/03_bb_and_uclibc
$ cp ../01_boot_from_fd_2.6/root_fs.img ./
$ su
# mount root_fs.img /mnt/loop0 -t ext2 -o loop
</pre>

<p class="paragraph">
Makefile中のディレクトリパス, RUNTIME_INTERP, PREFIXを修正します。またret1, helloworld静的リンクは行わないので該当ターゲットを削除します。さらに crtX.o の指定などは specs ファイルで行いますので、関連するリンカオプションを修正します。細かい所も修正していますので、修正漏れが無いよう注意してください。
<br />
Makefile:
<br />
</p>
<pre class="plugin_pre">
# オリジナルのソースツリー
UCLIBC_SRC_DIR=/home/msakamoto/reduced.linux/uClibc-0.9.31

# 実験環境のルートディレクトリ
TEST_DIR=/home/msakamoto/reduced.linux/03_bb_and_uclibc

# ターゲットとなるLinuxのヘッダーファイルのディレクトリ
LINUX_KERNEL_HEADER=/home/msakamoto/reduced.linux/01_boot_from_fd_2.6/usr/include

# &quot;make O=...&quot; で指定するビルドディレクトリ
UCLIBC_BUILD_DIR=$(TEST_DIR)/build_uclibc

# 開発用のヘッダーとライブラリのインストール先
UCLIBC_DEV_DIR=$(TEST_DIR)/dev

# 実行時に使うライブラリとローダ(ld-uClibc)のインストール先
UCLIBC_RUNTIME_DIR=/mnt/loop0

# アプリケーションをリンクするときに指定するローダのフルパス
UCLIBC_RUNTIME_INTERP=/lib/ld-uClibc.so.0
# 注意！ &quot;実行時の&quot; フルパスを指定すること！

# インストール時のprefix指定
PREFIX_INSTALL_DEV=PREFIX=$(UCLIBC_DEV_DIR)
PREFIX_INSTALL_RUNTIME=PREFIX=$(UCLIBC_RUNTIME_DIR)
# これを有効にする意味は後述

# 以下、helloworld, ret1のビルドオプション

CFLAGS=-nostdinc \
        -I$(UCLIBC_DEV_DIR)/usr/include \
        -I$(LINUX_KERNEL_HEADER) \
        -isystem /usr/lib/gcc/i386-redhat-linux/4.1.2/include-fixed \
        -isystem /usr/lib/gcc/i386-redhat-linux/4.1.2/include

LDFLAGS=-specs specs \
        -L $(UCLIBC_RUNTIME_DIR)/lib \
        -L $(UCLIBC_DEV_DIR)/usr/lib

TARGETS=ret1 helloworld

# デフォルトのmakeターゲットは個人的な好みでhelpターゲットにしてます。
help:
        @echo &quot;targets:&quot;
        @echo &quot;  uclibc-menuconfig&quot;
        @echo &quot;  uclibc-build&quot;
        @echo &quot;  uclibc-clean&quot;
        @echo &quot;  testbuild ($(TARGETS))&quot;
        @echo &quot;  clean (remove *.o and $(TARGETS))&quot;

# 以下、uClibc用ショートカットターゲット

uclibc-menuconfig:
        $(MAKE) -C $(UCLIBC_SRC_DIR) O=$(UCLIBC_BUILD_DIR) menuconfig

uclibc-build:
        $(MAKE) -C $(UCLIBC_SRC_DIR) O=$(UCLIBC_BUILD_DIR) all
        $(MAKE) -C $(UCLIBC_SRC_DIR) O=$(UCLIBC_BUILD_DIR) $(PREFIX_INSTALL_DEV) install_dev
        # インストール先はrootでないと書き込めないため、sudoを追加
        sudo $(MAKE) -C $(UCLIBC_SRC_DIR) O=$(UCLIBC_BUILD_DIR) $(PREFIX_INSTALL_RUNTIME) install_runtime

uclibc-clean:
        $(MAKE) -C $(UCLIBC_SRC_DIR) O=$(UCLIBC_BUILD_DIR) realclean
        rm -rf $(UCLIBC_DEV_DIR)
        # インストール先はrootでないと書き込めないため、sudoを追加
        sudo rm -rf $(UCLIBC_RUNTIME_DIR)/lib

# 以下、ret1, helloworld用ターゲット

.SUFFIXES: .c .o

.c.o:
        $(CC) $(CFLAGS) -c -o $@ $&lt;

testbuild: $(TARGETS)

ret1: ret1.o
        $(CC) $(LDFLAGS) -o $@ $&lt;

helloworld: helloworld.o
        $(CC) $(LDFLAGS) -o $@ $&lt;

clean:
        rm -f *.o
        rm -f $(TARGETS)

</pre>

<p class="paragraph">
specsファイル：
<br />
</p>
<pre class="plugin_pre">
*uclibc_dev_path:
/home/msakamoto/reduced.linux/03_bb_and_uclibc/dev/

*uclibc_crt_path:
%(uclibc_dev_path)usr/lib/

*uclibc_runtime_path:
/mnt/loop0/

*endfile:
%(uclibc_crt_path)crtn.o

*startfile:
%(uclibc_crt_path)crt1.o %(uclibc_crt_path)crti.o

*dynamic_linker:
%(uclibc_runtime_path)lib/ld-uClibc.so.0

</pre>

<h4 id="id83e360">uClibcの設定</h4>

<p class="paragraph">
uClibcの設定ファイルを準備します。まずは &quot;defconfig&quot; で初期化します。
<br />
</p>
<pre>$ pwd
/home/msakamoto/reduced.linux/03_bb_and_uclibc
$ make -C /home/msakamoto/reduced.linux/uClibc-0.9.31 O=`pwd`/build_uclibc defconfig
</pre>

<p class="paragraph">
&quot;make uclibc-menuconfig&quot; で menuconfig を起動します。
<br />
</p>
<pre>$ pwd
/home/msakamoto/reduced.linux/03_bb_and_uclibc
$ make uclibc-menuconfig
</pre>
<p class="paragraph">
defconfigで生成された .config と、設定後の .config の差分を下記に示します。これを参考にmenuconfigを設定するか、patchコマンドでpatchをあててください。
<br />
</p>
<pre class="plugin_pre">
$ pwd
/home/msakamoto/reduced.linux/03_bb_and_uclibc
$ cd build_uclibc
$ diff -u defconfig .config
--- defconfig   2011-04-12 14:42:48.000000000 +0900
+++ .config     2011-04-12 15:58:22.000000000 +0900
@@ -1,7 +1,7 @@
 #
 # Automatically generated make config: don&#039;t edit
 # Version: 0.9.31
-# Tue Apr 12 14:42:48 2011
+# Tue Apr 12 15:58:22 2011
 #
 # TARGET_alpha is not set
 # TARGET_arm is not set
@@ -68,7 +68,7 @@
 # DO_C99_MATH is not set
 # DO_XSI_MATH is not set
 # UCLIBC_HAS_FENV is not set
-KERNEL_HEADERS=&quot;/usr/include&quot;
+KERNEL_HEADERS=&quot;/home/msakamoto/reduced.linux/01_boot_from_fd_2.6/usr/include&quot;
 HAVE_DOT_CONFIG=y

 #
@@ -88,7 +88,7 @@
 LDSO_RUNPATH=y
 LDSO_SEARCH_INTERP_PATH=y
 UCLIBC_CTOR_DTOR=y
-# LDSO_GNU_HASH_SUPPORT is not set
+LDSO_GNU_HASH_SUPPORT=y
 HAS_NO_THREADS=y
 # LINUXTHREADS_OLD is not set
 # LINUXTHREADS_NEW is not set
@@ -146,7 +146,9 @@
 UCLIBC_HAS_SOCKET=y
 UCLIBC_HAS_IPV4=y
 # UCLIBC_HAS_IPV6 is not set
-# UCLIBC_HAS_RPC is not set
+UCLIBC_HAS_RPC=y
+# UCLIBC_HAS_FULL_RPC is not set
+# UCLIBC_HAS_REENTRANT_RPC is not set
 # UCLIBC_USE_NETLINK is not set
 # UCLIBC_HAS_BSD_RES_CLOSE is not set
 UCLIBC_HAS_COMPAT_RES_STATE=y
@@ -211,10 +213,10 @@
 #
 # Library Installation Options
 #
-RUNTIME_PREFIX=&quot;/usr/$(TARGET_ARCH)-linux-uclibc/&quot;
-DEVEL_PREFIX=&quot;/usr/$(TARGET_ARCH)-linux-uclibc/usr/&quot;
+RUNTIME_PREFIX=&quot;/&quot;
+DEVEL_PREFIX=&quot;/usr&quot;
 MULTILIB_DIR=&quot;lib&quot;
-HARDWIRED_ABSPATH=y
+# HARDWIRED_ABSPATH is not set

 #
 # Security options
</pre>

<dl>
<dt> なぜ LDSO_GNU_HASH_SUPPORT を有効にするのか？ </dt>
<dd><a href="./view-948.html" >技術/Linux/uClibc/02, &quot;symbol &#039;stdout&#039;: can&#039;t resolve symbol in lib&quot; の対処</a> 参照。</dd>
<dt> なぜ UCLIBC_HAS_RPC を有効にするのか？ </dt>
<dd>BusyBoxのmountコマンドで必要です。</dd>
<dt> RUNTIME_PREFIX, DEVEL_PREFIX 値について </dt>
<dd>RUNTIME_PREFIXについてはインストール先でのルートファイルシステム構成に合わせました。RUNTIME_PREFIX + MULTILIB_DIR がsoファイルのインストール先になりますので、&quot;/&quot;としました。DEVEL_PREFIXについては実験環境の中にセットアップするので特にTARGET_ARCHを含めて区別する必要がありません。そのため単に&quot;/usr&quot;とし、&quot;install_dev&quot;ターゲット実行時にPREFIXで実験環境の中にインストールさせています。&quot;install_runtime&quot;ターゲットでも同様、PREFIXを指定することでloopbackマウントしたrootfsにインストールさせています。</dd>
</dl>

<h4 id="id9c9de2">uClibc, helloworld, ret1のビルド</h4>

<p class="paragraph">
&quot;root_fs.img&quot;が &quot;/mnt/loop0&quot; にloopbackマウントされていることを確認したら、いよいよビルドしてみます。
<br />
</p>
<pre>$ pwd
/home/msakamoto/reduced.linux/03_bb_and_uclibc
$ make uclibc-build
$ make testbuild
$ readelf -x .interp ret1

Hex dump of section &#039;.interp&#039;:
  0x080480f4 6c2f6269 6c2f3070 6f6f6c2f 746e6d2f /mnt/loop0/lib/l
  0x08048104     0030 2e6f732e 6362696c 43752d64 d-uClibc.so.0.
</pre>

<p class="paragraph">
.interpセクションを確認してみると、 &quot;/lib/ld-uClibc.so.0&quot; ではなく、&quot;/mnt/loop0&quot;が頭に付いてしまっています。
<br />
これは specs ファイルでdynamic_linkerを「開発環境でのフルパス」で指定していることが原因です。
<br />
本来であれば LFS(Linux From Scratch) ドキュメントにあるようにchrootした環境で開発するとか、実行環境と開発環境の構成を合わせるなどしておくべきでしょうが、今回はそこまで調整しません。
<br />
手抜き対応として、 &quot;/mnt/loop0&quot; を &quot;/&quot; へのシンボリックリンクとして作成してルートファイルシステムを騙しておきます。
<br />
</p>
<pre class="plugin_pre">
# cd /mnt/loop0/
# ls
bin  dev  etc  helloworld  lib  linuxrc  lost+found  proc  ret1  sbin  usr
# mkdir mnt
# cd mnt/
# ln -s / loop0
# ls -l
合計 0
lrwxrwxrwx 1 root root 1  4月 12 16:05 loop0 -&gt; /
</pre>
<p class="paragraph">
これで実行環境で &quot;/mnt/loop0/lib/ld-uClibc.so.0&quot; をインタープリタとして実行すると、シンボリックリンクにより実際に起動されるのは &quot;/lib/ld-uClibc.so.0&quot; になります。
<br />
</p>

<p class="paragraph">
まだroot_fs.imgはマウントしたままにしておき、とりあえずret1とhelloworldを実行してみましょう。
<br />
</p>
<pre>$ ./ret1; echo $?
1
$ ./helloworld abc def
Hello, World! LINUX_VERSION_CODE=132646
args[0]=[./helloworld]
args[1]=[abc]
args[2]=[def]
</pre>
<p class="paragraph">
ホストマシンでは上手く動いてくれました。ld-uClibc.soがロードされることを確認したい場合はstraceでトレースしてみてください。
<br />
</p>

<p class="paragraph">
ではいよいよhelloworld, ret1をルートファイルシステムにコピーします。
<br />
</p>
<pre>$ sudo cp ret1 helloworld /mnt/loop0
</pre>
<p class="paragraph">
root_fs.imgをアンマウントします。
<br />
</p>
<pre># umount /mnt/loop0
</pre>

<p class="paragraph">
root_fs.imgをVMwareホストマシンに転送し、前々回で作成したfdimageを使ってLinuxを起動、root_fs.imgをマウントし、helloworld, ret1を実行してみます。
<br />
→成功しました！
<br />
<a href="./../images/reduced.linux/03_01.png" title="" target="_blank"><img src="./../images/reduced.linux/03_01.png" alt="" title=""  /></a>
<br />
</p>

<h3 id="id3ce622">uClibcと動的リンクしたBusyBoxのビルド</h3>

<p class="paragraph">
ではいよいよ本題となるBusyBoxのビルドです。まずallnoconfigで設定ファイルを初期化します。
<br />
</p>
<pre>$ pwd
/home/msakamoto/reduced.linux/03_bb_and_uclibc
$ mkdir build_bb
$ cd ../busybox-1.18.4
$ make O=/home/msakamoto/reduced.linux/03_bb_and_uclibc/build_bb allnoconfig
</pre>

<p class="paragraph">
続いて前々回にビルドしたBusyBoxの設定をコピーし、make menuconfigします。
<br />
</p>
<pre>$ cd ..
$ cp 01_busy_box_build/.config 03_bb_and_uclibc/build_bb/
cp: `03_bb_and_uclibc/build_bb/.config&#039; を上書きしてもよろしいですか(yes/no)? yes
$ cd 03_bb_and_uclibc/build_bb/
</pre>
<p class="paragraph">
以下のオプションのチェックを外して下さい。
<br />
</p>
<pre>Busybox Settings ---&gt;
    Build Options ---&gt;
        Build BusyBox as a static binary (no shared libs)
</pre>
<p class="paragraph">
これで動的リンクでビルドするようになります。
<br />
</p>

<p class="paragraph">
さらに .config をエディタで開き、CONFIG_EXTRA_CFLAGSに以下の値を設定してください。表示の都合上折り返していますが、 &quot; - &quot; 間は一行で続けて書きます。
<br />
</p>
<pre>CONFIG_EXTRA_CFLAGS=&quot;
  -nostdinc
  -I/home/msakamoto/reduced.linux/03_bb_and_uclibc/dev/usr/include
  -I/home/msakamoto/reduced.linux/01_boot_from_fd_2.6/usr/include
  -isystem /usr/lib/gcc/i386-redhat-linux/4.1.2/include-fixed
  -isystem /usr/lib/gcc/i386-redhat-linux/4.1.2/include
&quot;
</pre>

<p class="paragraph">
BusyBoxではLDFLAGSをmenuconfig or .config経由で設定できません。make時に環境変数として渡します。
<br />
</p>
<pre>$ export LDFLAGS=&quot;-specs /home/msakamoto/reduced.linux/03_bb_and_uclibc/specs \
-L/home/msakamoto/reduced.linux/03_bb_and_uclibc/dev/usr/lib \
-L/mnt/loop0/lib&quot;
</pre>

<p class="paragraph">
では、実際にビルドしてみましょう。
<br />
</p>
<pre>$ make all
</pre>
<p class="paragraph">
ビルドに成功したら、.interpセクションとサイズを確認してみます。
<br />
</p>
<pre>$ readelf -x .interp busybox

Hex dump of section &#039;.interp&#039;:
  0x08048114 6c2f6269 6c2f3070 6f6f6c2f 746e6d2f /mnt/loop0/lib/l
  0x08048124     0030 2e6f732e 6362696c 43752d64 d-uClibc.so.0.
$ wc -c busybox
117588 busybox
</pre>
<p class="paragraph">
helloworldと同じld-uClibcを差しており、サイズもぐっと減りました。
<br />
</p>

<p class="paragraph">
ルートファイルシステムにインストールしてみます。
<br />
</p>
<pre>$ su
# make CONFIG_PREFIX=/mnt/loop0 install
</pre>
<p class="paragraph">
※sudoでは途中でエラーになってしまいました。suしてからであれば問題ありませんでした。
<br />
</p>

<p class="paragraph">
dfで容量を見てみると、わずか424KBでBusyBox + uClibc + helloworldが収まるようになりました！
<br />
</p>
<pre>$ df -h
Filesystem          サイズ  使用  残り 使用% マウント位置
...
/.../root_fs.img      1.4M  424K  916K  32% /mnt/loop0
</pre>

<p class="paragraph">
umountして仮想マシンに読み込ませてみます。
<br />
→ shell, mount, psコマンドが動いてます：
<br />
<a href="./../images/reduced.linux/03_02.png" title="" target="_blank"><img src="./../images/reduced.linux/03_02.png" alt="" title=""  /></a>
<br />
</p>

<p class="paragraph">
→ helloworld, ret1も動いてます：
<br />
<a href="./../images/reduced.linux/03_03.png" title="" target="_blank"><img src="./../images/reduced.linux/03_03.png" alt="" title=""  /></a>
<br />
</p>

<h3 id="id39997b">うまく動かないときは</h3>

<p class="paragraph">
動的リンク周りでエラーになる場合は、uClibc, helloworld/ret1, BusyBoxそれぞれのコンパイルオプションやインストール先を確認して下さい。
<br />
</p>
<ol><li> uClibcでのinstall_dev, install_runtime ターゲットにおけるインストール先の確認</li>
<li> ルートファイルシステムで、 &quot;/mnt/loop0&quot; が &quot;/&quot; へのシンボリックリンクになっていることを確認。</li>
<li> helloworld, ret1 でのコンパイル・リンカオプションでuClibcを参照しているか確認。<strong>→まずは helloworld, ret1が正常に動作する段階を目指してください。</strong></li>
<li> BusyBoxのCONFIG_EXTRA_CFLAGS, LDFLAGSの確認。</li></ol>

<p class="paragraph">
各ステップで細かいディレクトリ調整が要求されます。まずは <a href="./view-949.html" >技術/Linux/uClibc/03, x86(32bit) PC環境でuClibcを試す</a> を参考に、PC環境でuClibcを使ったhelloworld, ret1の動的リンクが正常に動作する環境を構築してみてください。FD用ルートファイルシステム向けの調整やBusyBoxのビルドはその発展形です。
<br />
</p>

<hr />
<p class="paragraph">
次回はkernel-2.6.xを使ってCD-ROMブートに挑戦します。kernel-2.4は次回以降は使いません。
<br />
容量にも余裕が出来ますので、uClibcやBusyBoxで他のオプションも有効化し、機能強化を図ります。
<br />
またBuildrootにも挑戦し、今回のような手動によるディレクトリ調整の手間を省いてみます。
<br />
</p>

<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-943.html" title="技術/Linux/手作りLinuxシステム/02. Boot from Floppy Disk (kernel-2.4.x)">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-953.html" title="技術/Linux/手作りLinuxシステム/04. Boot from CD (kernel-2.6.x)">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-940.html" title="技術/Linux/手作りLinuxシステム">Up</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-23.html" title="技術">技術</a>&nbsp;]</li>
</ul>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/952<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2001 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a target="_blank" href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" target="_blank" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>