<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Java/ServletとJSESSIONIDのURL管理 - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">Java/ServletとJSESSIONIDのURL管理</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2012-06-17 21:15:59 &nbsp; / &nbsp; last updated at: 2012-06-17 21:28:23<br>
カテゴリ: <a href="category-11.html">Java</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-1266.html" title="Java/Serializeメモ">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-1346.html" title="Java/Socket, InetAddressにおけるDNS名前解決の仕組みと networkaddress.cache.ttl">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-457.html" title="Java">Java</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
Servletプログラミングでセッションを使うとき、Cookieをクリアしたブラウザでアクセスすると初回のPOSTやGET遷移でだけ、URLに&quot;;jsessionid=xxxxyyyy...&quot;というのが付加される。
<br />
以前から、これはServletコンテナが独自に実装してくれた機能なのか、Servletの仕様としてそうなっているのかが気になっていた。先日お仕事中にその辺りを調べる必要が生じたので、数年越しに自分の中でこの&quot;;jsessionid=xxxxyyyy...&quot;について決着をつける。
<br />
</p>



<ul><li><a href="#id07b2ab">Servletの仕様を確認</a><ul><li><a href="#id36181d">Servlet 2.5</a></li>
<li><a href="#id287445">Servlet 3.0</a></li></ul></li>
<li><a href="#idef24ee">セッション固定化の問題と、URLからのセッションID漏えいの問題</a></li>
<li><a href="#iddf64c4">TomcatとJettyの場合</a><ul><li><a href="#idc6c8b5">Tomcatの場合</a><ul><li><a href="#id652d01">JavaEEのバージョン/Servletバージョン/Tomcatバージョン</a></li>
<li><a href="#idd4cd8a">デフォルト状態</a></li>
<li><a href="#id52ac84">JSESSIONIDの変更とURL Rewritingの無効化</a></li>
<li><a href="#id869fcd">Tomcat全体でのセッションCookie名の変更</a></li>
<li><a href="#id0d28b7">Tomcat7, disableURLRewriting, Servlet 3.0</a></li>
<li><a href="#idf0c882">JSESSIONIDと&quot;;jsessionid=&quot;のどちらが優先されるか。(Tomcat 6.0.35, Tomcat 7.0.16)</a></li></ul></li>
<li><a href="#id35e835">Jettyの場合</a><ul><li><a href="#idd4cd8a">デフォルト状態</a></li>
<li><a href="#id52ac84">JSESSIONIDの変更とURL Rewritingの無効化</a></li>
<li><a href="#id1432e5">JSESSIONIDと&quot;;jsessionid=&quot;のどちらが優先されるか。(jetty-hightide-7.6.4.v20120524)</a></li></ul></li></ul></li>
<li><a href="#id571109">まとめ：ServletプログラミングでURLセッション管理を無効化するには</a></li></ul>
<hr />
<h3 id="id07b2ab">Servletの仕様を確認</h3>

<p class="paragraph">
JSESSIONIDや&quot;;jsessionid=&quot;がどこで定められているのかというと、Servletの仕様で定められています。
<br />
これらはJSRとして入手・参照可能です。
<br />
</p>
<ul><li> JSR 53: JavaTM Servlet 2.3 and JavaServer PagesTM 1.2 Specifications<ul><li> <a class="externallink" href="http://jcp.org/en/jsr/detail?id=53" target="_blank">http://jcp.org/en/jsr/detail?id=53</a></li></ul></li>
<li> JSR 154: JavaTM Servlet 2.4 Specification<ul><li> <a class="externallink" href="http://jcp.org/en/jsr/detail?id=154" target="_blank">http://jcp.org/en/jsr/detail?id=154</a></li>
<li> Servlet 2.5はServlet 2.4のMaintenance Releaseとしてリリースされています。</li></ul></li>
<li> JSR 315: JavaTM Servlet 3.0 Specification<ul><li> <a class="externallink" href="http://jcp.org/en/jsr/detail?id=315" target="_blank">http://jcp.org/en/jsr/detail?id=315</a></li></ul></li></ul>

<p class="paragraph">
以下に簡単に主なバージョンとリリース年月についてまとめます。Version 2.3以降のリリース年月についてはJSR上での&quot;Start&quot;を元にしています。
<br />
</p>
<table>
	<tr>
		<td> Version 1.0 </td>
		<td> 1997-06 by Sun Microsystems </td>
	</tr>
	<tr>
		<td> Version 2.3 </td>
		<td> 2001-09 Final Release Start, JSR53 (Java Community PRocess, with JSP 1.2 Specs) </td>
	</tr>
	<tr>
		<td> Version 2.4 </td>
		<td> 2003-11 Final Release Start, JSR154 </td>
	</tr>
	<tr>
		<td> Version 2.5 </td>
		<td> 2007-09 Maintenance Release 2 Start, JSR154 </td>
	</tr>
	<tr>
		<td> Version 3.0 </td>
		<td> 2009-12 Final Release Start, JSR315 </td>
	</tr>
</table>

<h4 id="id36181d">Servlet 2.5</h4>

<p class="paragraph">
今回主に取り上げるTomcat6, Jetty7で対応しているServlet 2.5の仕様を確認すると、&quot;SRV.7.1 Session Tracking Mechanisms&quot;で以下のように記されています。
<br />
</p>
<blockquote><p class="paragraph">
SRV.7.1.1 Cookies
<br />
</p>

<p class="paragraph">
Session tracking through HTTP cookies is the most used session tracking mechanism and is required to be supported by all servlet containers. 
<br />
The container sends a cookie to the client. The client will then return the cookie on each subsequent request to the server, unambiguously associating the request with a session. The name of the session tracking cookie must be JSESSIONID.
<br />
(...)
<br />
SRV.7.1.3 URL Rewriting
<br />
</p>

<p class="paragraph">
URL rewriting is the lowest common denominator of session tracking. When a client will not accept a cookie, URL rewriting may be used by the server as the basisfor session tracking. URL rewriting involves adding data, a session ID, to the URL path that is interpreted by the container to associate the request with a session. 
<br />
The session ID must be encoded as a path parameter in the URL string. The name of the parameter must be jsessionid. Here is an example of a URL containing encoded path information:
<br />
<a class="externallink" href="http://www.myserver.com/catalog/index.html;jsessionid=1234" target="_blank">http://www.myserver.com/catalog/index.html;jsessionid=1234</a>
<br />
</p></blockquote>

<p class="paragraph">
JSESSIONIDについては&quot;must be&quot;、つまりセッション維持のCookieの名前はJSESSIONID「でなければならない」となっています。また&quot;;jsessionid=&quot;についても&quot;must be&quot;で同様となっています。
<br />
</p>

<p class="paragraph">
もちろん後で確認するようにTomcatやJettyなど実際のServletコンテナでは、設定によってこれらを変更することも可能となっています。
<br />
クライアントがCookieを使えない場合ですが、&quot;When a client will not accept a cookie, URL rewriting<strong>may be used</strong>by the server as the basisfor session tracking.&quot;とあります。ですので厳密にはURL Rewritingは使わなくても良いと考えられ、実際に後で確認するようにTomcat 6.0.30以上やJetty7ではURL Rewritingの無効化が設定可能です。
<br />
とはいえ、以下のようにCookieが使えないHTTPクライアントもサポートする必要があると定められていることからURL Rewritingによるセッション維持は必須の機能となっているようです。
<br />
</p>
<blockquote><p class="paragraph">
SRV.7.1.4 Session Integrity
<br />
</p>

<p class="paragraph">
Web containers must be able to support the HTTP session while servicing HTTP requests from clients that do not support the use of cookies. To fulfill this requirement, Web containers commonly support the URL rewriting mechanism.
<br />
</p></blockquote>

<h4 id="id287445">Servlet 3.0</h4>

<p class="paragraph">
Servlet 3.0では、JSESSIONIDやURL Rewritingについて以下の変更がされています。
<br />
</p>
<ul><li> JSESSIONIDという名前はカスタマイズOKになった。またカスタマイズした場合は&quot;;jsessionid=&quot;の部分もそれに合わせてOKになった。</li>
<li> Cookie管理の場合は&quot;HttpOnly&quot;属性を設定可能なことが必須となった。</li>
<li> URL RewritingについてはセッションIDの漏えいの可能性が生じること、可能であればCookieまたはSSLでのセッション維持を使うこと、という文章が追加された。</li></ul>

<p class="paragraph">
簡単に原文を紹介して終わりにします。
<br />
</p>

<blockquote><p class="paragraph">
7.1.1 Cookies
<br />
</p>

<p class="paragraph">
Session tracking through HTTP cookies is the most used session tracking mechanism and is required to be supported by all servlet containers.
<br />
The container sends a cookie to the client. The client will then return the cookie on each subsequent request to the server, unambiguously associating the request with a session. The standard name of the session tracking cookie must be JSESSIONID, which must be supported by all 3.0 compliant containers. Containers may allow the name of the session tracking cookie to be customized through container specific configuration.
<br />
All servlet containers MUST provide an ability to configure whether or not the container marks the session tracking cookie as HttpOnly. The established configuration must apply to all contexts for which a context specific configuration has not been established (see SessionCookieConfig javadoc for more details).
<br />
If a web application configures a custom name for its session tracking cookies, the same custom name will also be used as the name of the URI parameter if the session id is encoded in the URL (provided that URL rewriting has been enabled).
<br />
(...)
<br />
7.1.3 URL Rewriting
<br />
</p>

<p class="paragraph">
URL rewriting is the lowest common denominator of session tracking. When a client will not accept a cookie, URL rewriting may be used by the server as the basis for session tracking. URL rewriting involves adding data, a session ID, to the URL path that is interpreted by the container to associate the request with a session. 
<br />
The session ID must be encoded as a path parameter in the URL string. The name of the parameter must be jsessionid. Here is an example of a URL containing encoded path information:
<br />
<a class="externallink" href="http://www.myserver.com/catalog/index.html;jsessionid=1234" target="_blank">http://www.myserver.com/catalog/index.html;jsessionid=1234</a>
<br />
URL rewriting exposes session identifiers in logs, bookmarks, referer headers, cached HTML, and the URL bar. URL rewriting should not be used as a session tracking mechanism where cookies or SSL sessions are supported and suitable.
<br />
</p></blockquote>

<h3 id="idef24ee">セッション固定化の問題と、URLからのセッションID漏えいの問題</h3>

<p class="paragraph">
URLでセッションIDを指定できる状態だと、セッション固定化の問題やURLからのセッションID漏えいの問題が発生します。
<br />
PC/スマホ向けのServletアプリは基本的にはCookieでセッションを管理していると思います。その場合、URLからのセッションID漏えいの問題の影響は無いと考えられます。
<br />
しかしServletの仕様によりURLからもセッションIDを受け入れてしまう状態であれば、セッション固定化の問題を考える必要があります。セッション固定化では攻撃者が用意したセッションIDを被害者に使わせ、被害者にログインさせるなどして攻撃者はセッション情報を入手しなりすまし等に悪用します。URLからセッションIDを指定できるということは、攻撃者が用意したセッションID付きのURLに被害者を誘導し、ログインなどの操作を行わせることが可能です。セッション固定化を悪用するための入り口の一つになってしまうことが考えられます。もちろん、セッション固定化の対策がきちんとされていれば、URLからセッションIDを指定できても問題にはつながらないと考えられます。
<br />
</p>

<p class="paragraph">
この点については最後のまとめで考えてみました。
<br />
</p>

<h3 id="iddf64c4">TomcatとJettyの場合</h3>

<p class="paragraph">
TomcatとJettyについて、Cookieを無効にした状態でアクセスし、初期状態でURL-Rewritingによるセッション管理が有効となるか確認してみます。
<br />
</p>

<h4 id="idc6c8b5">Tomcatの場合</h4>

<p class="paragraph">
今回はTomcat 6.0.35に含まれている&quot;examples&quot;アプリのSessionのサンプルを使って、JSESSIONIDや&quot;;jsessionid=&quot; URL Rewritingの動作を確認してみました。
<br />
</p>

<p class="paragraph">
Tomcat6系はServlet 2.5を実装していますので、基本的にはJSESSIONID + &quot;;jsessionid&quot;によるURL Rewritingが有効化されています。しかし設定によりWebアプリごとにJSESSIONIDの名前を変更できます。また、<strong>Tomcat 6.0.30 以上であれば、URL Rewritingを無効化したりすることが可能です。</strong>
<br />
</p>

<ul><li> <a class="externallink" href="http://tomcat.apache.org/tomcat-6.0-doc/changelog.html" target="_blank">http://tomcat.apache.org/tomcat-6.0-doc/changelog.html</a><ul><li> → Tomcat 6.0.30, Catalina, 49811: Add an option to disable URL rewriting on a per Context basis. (markt)</li>
<li> 以下のBugzillaが6.0.30で組み込まれています：<ul><li> Bug 49811   [PATCH] Disable UrlRewriting</li>
<li> <a class="externallink" href="https://issues.apache.org/bugzilla/show_bug.cgi?id=49811" target="_blank">https://issues.apache.org/bugzilla/show_bug.cgi?id=49811</a></li></ul></li></ul></li></ul>

<h5 id="id652d01">JavaEEのバージョン/Servletバージョン/Tomcatバージョン</h5>

<p class="paragraph">
JavaEE/Servlet/対応したTomcatのバージョンをまとめておきます。
<br />
</p>
<table>
	<tr>
		<td> JavaEE6 </td>
		<td> Servlet 3.0, JSP2.2 </td>
		<td> Tomcat 7以上 </td>
	</tr>
	<tr>
		<td> JavaEE5 </td>
		<td> Servlet 2.5, JSP 2.1 </td>
		<td> Tomcat 6以上 </td>
	</tr>
	<tr>
		<td> J2EE 1.4 </td>
		<td> Servlet 2.4, JSP 2.0 </td>
		<td> Tomcat 5.x, 5.5.x以上 </td>
	</tr>
	<tr>
		<td> J2EE 1.3 </td>
		<td> Servlet 2.3 JSP 1.2 </td>
		<td> Tomcat 4.x </td>
	</tr>
</table>

<h5 id="idd4cd8a">デフォルト状態</h5>

<p class="paragraph">
デフォルト状態では&quot;examples&quot;で特にsession関連の設定は行われておりません。Tomcatであれば&quot;conf/Catalina/&lt;hostname&gt;/&quot;以下の&quot;&lt;Context名&gt;.xml&quot;でWebアプリごとのコンテキスト設定を行えますが、デフォルトでは&quot;examples&quot;アプリ用の設定ファイルはありません。
<br />
</p>

<p class="paragraph">
この状態で、Burpを使って常にリクエストからCookieヘッダーを除去するようにしたProxyを通してアクセスします。
<br />
まずテストアプリのSessionサンプルは以下のURLでアクセスできました。
<br />
</p>
<pre>http://localhost:8080/examples/servlets/servlet/SessionExample
</pre>
<p class="paragraph">
すると以下の様なレスポンスを受信しました。
<br />
</p>
<pre class="plugin_pre">
HTTP/1.1 200 OK
Server: Apache-Coyote/1.1
Set-Cookie: JSESSIONID=6B9DBEF80A2B62BC04E80FD73E7B14CA; Path=/examples
Content-Type: text/html
Content-Length: 1270
Date: Sun, 17 Jun 2012 09:03:22 GMT

&lt;html&gt;
...
&lt;form action=&quot;SessionExample;jsessionid=6B9DBEF80A2B62BC04E80FD73E7B14CA&quot; method=POST&gt;
</pre>

<p class="paragraph">
JSESSIONID Cookieが発行され、また&quot;&lt;form&gt;&quot;のaction属性に&quot;;jsessionid=&quot;が埋め込まれていることが確認されます。
<br />
</p>

<p class="paragraph">
BurpによりブラウザからのCookieヘッダを削除した状態でそのままサンプルアプリを操作してみると、&quot;;jsessionid=&quot;だけで正常にサンプルアプリを操作できることが確認されました
<br />
</p>

<h5 id="id52ac84">JSESSIONIDの変更とURL Rewritingの無効化</h5>

<p class="paragraph">
conf/Catalina/localhost/examples.xmlを以下の内容で保存します。
<br />
</p>
<pre class="plugin_pre">
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;Context disableURLRewriting=&quot;true&quot; sessionCookieName=&quot;MYSESSID&quot; /&gt;
</pre>
<p class="paragraph">
セッションのCookie名に&quot;MYSESSID&quot;を指定し、6.0.30以降で指定可能になった&quot;disableURLRewriting&quot;でURL Rewritingを無効化します。
<br />
Tomcatによりコンテキストがリロードされた後、以下のURLにアクセスしました。
<br />
</p>
<pre>http://localhost:8080/examples/servlets/servlet/SessionExample
</pre>
<p class="paragraph">
CookieもBurpにより削除され、URLにも指定されていないため以下のようなレスポンスを受信しました。
<br />
</p>
<pre class="plugin_pre">
HTTP/1.1 200 OK
Server: Apache-Coyote/1.1
Set-Cookie: MYSESSID=3C117B729074A4EF6A3C38127E5E1D1E; Path=/examples; HttpOnly
Content-Type: text/html
Content-Length: 1138
Date: Sun, 17 Jun 2012 09:19:31 GMT

&lt;html&gt;
...
&lt;form action=&quot;SessionExample&quot; method=POST&gt;
</pre>
<p class="paragraph">
&quot;Set-Cookie&quot;で発行されるCookie名がXMLで指定した MYSESSID&quot; になっています。また、先ほどと違い、&quot;&lt;form&gt;&quot;要素の&quot;action&quot;属性のURLに&quot;;jsessionid=&quot;がありません。
<br />
</p>

<p class="paragraph">
このままBurpによりCookieが削除される設定で操作をすると、毎回Set-Cookieされるため、セッション情報の変更などサンプルアプリの一部の機能が動かなくなりました。
<br />
</p>

<p class="paragraph">
なお&quot;disableURLRewriting&quot;はTomcat6系の、6.0.30以降でのみ使えます。Tomcat5系、Tomcat 6.0.29以前、Tomcat7系では使えません。Tomcat7系であればServlet 3.0に対応していますので、web.xmlによりCookieのみ＋URL Rewriting無しを指定できます。
<br />
</p>

<h5 id="id869fcd">Tomcat全体でのセッションCookie名の変更</h5>

<p class="paragraph">
Javaのシステムプロパティを使うことで、Tomcat全体でセッションCookie名を変更できます。但しこれはアプリごとのContext設定を上書きしてしまいますので、実用上のメリットは薄いかもしれません。
<br />
</p>

<ul><li> Apache Tomcat Configuration Reference (6.0.35) - System Properties<ul><li> <a class="externallink" href="http://tomcat.apache.org/tomcat-6.0-doc/config/systemprops.html" target="_blank">http://tomcat.apache.org/tomcat-6.0-doc/config/systemprops.html</a></li></ul></li>
<li> [Tomcat] How to change default JSESSIONID cookie/parameter identifier @Digizol<ul><li> <a class="externallink" href="http://www.digizol.org/2010/10/jsessionid-tomcat-cookie-change-default.html" target="_blank">http://www.digizol.org/2010/10/jsessionid-tomcat-cookie-change-default.html</a></li></ul></li></ul>

<blockquote><p class="paragraph">
Sessions
<br />
</p>

<p class="paragraph">
org.apache.catalina.SESSION_COOKIE_NAME
<br />
An alternative name for the session cookie. Defaults to JSESSIONID. Note that the Servlet specification requires this to be JSESSIONID. You should not rely on being able to change this.
<br />
</p>

<p class="paragraph">
org.apache.catalina.SESSION_PARAMETER_NAME
<br />
An alternative name for the session path parameter. Defaults to jsessionid. Note that the Servlet specification requires this to be jsessionid. You should not rely on being able to change this.
<br />
</p></blockquote>

<h5 id="id0d28b7">Tomcat7, disableURLRewriting, Servlet 3.0</h5>

<p class="paragraph">
Tomcat7系ではServlet 3.0が実装されました。その結果、Servlet 3.0の仕様としてweb.xmlにセッション維持の方法を明示できるようになりました。その影響として、<strong>disableURLRewritingは不要とされTomcat7のContext設定では実装されていません。</strong>
<br />
</p>

<p class="paragraph">
Servlet 3.0ではセッション維持の方法にCookieのみを用いる場合、web.xmlに以下の記述を追加します。
<br />
</p>
<pre>&lt;session-config&gt;
  &lt;tracking-mode&gt;COOKIE&lt;/tracking-mode&gt;
&lt;/session-config&gt;
</pre>

<p class="paragraph">
&quot;&lt;tracking-mode&gt;&quot;には他にも&quot;URL&quot;と&quot;SSL&quot;を組み合わせて指定可能なようです。
<br />
</p>

<p class="paragraph">
参考：
<br />
</p>
<ul><li> Servlet 3.0でのweb.xmlのxsd<ul><li> <a class="externallink" href="http://java.sun.com/xml/ns/javaee/web-common_3_0.xsd" target="_blank">http://java.sun.com/xml/ns/javaee/web-common_3_0.xsd</a></li></ul></li>
<li> Tomcat 7も対応したServlet 3.0の変更点 後編 (3/3) - ＠IT<ul><li> <a class="externallink" href="http://www.atmarkit.co.jp/fjava/rensai4/tomcat7_02/03.html" target="_blank">http://www.atmarkit.co.jp/fjava/rensai4/tomcat7_02/03.html</a></li></ul></li>
<li> 感想： 体系的に学ぶ 安全なWebアプリケーションの作り方 - penultimate diary<ul><li> <a class="externallink" href="http://d.hatena.ne.jp/penult/20110606/1307374235" target="_blank">http://d.hatena.ne.jp/penult/20110606/1307374235</a></li></ul></li>
<li> What&#039;s New in Tomcat 7 | Andrius Miasnikovas&#039;s Blog<ul><li> <a class="externallink" href="http://andrius.miasnikovas.lt/2010/07/whats-new-in-tomcat-7/" target="_blank">http://andrius.miasnikovas.lt/2010/07/whats-new-in-tomcat-7/</a></li></ul></li>
<li> Servlet 3.0 ≪ JBoss<ul><li> <a class="externallink" href="http://middlewaremagic.com/jboss/?tag=servlet-3-0" target="_blank">http://middlewaremagic.com/jboss/?tag=servlet-3-0</a></li></ul></li></ul>

<h5 id="idf0c882">JSESSIONIDと&quot;;jsessionid=&quot;のどちらが優先されるか。(Tomcat 6.0.35, Tomcat 7.0.16)</h5>

<p class="paragraph">
既にTomcat6.0系では検証記事がありますが、自分でも確認してみました。
<br />
</p>
<ul><li> [Java][小ネタ] Cookie の JSESSIONID と URL の jsessionid= どちらが優先されるか。<ul><li> <a class="externallink" href="http://d.hatena.ne.jp/tksmd/20090903" target="_blank">http://d.hatena.ne.jp/tksmd/20090903</a></li></ul></li></ul>

<p class="paragraph">
結果(Tomcat 6.0.35)：
<br />
</p>
<table>
	<tr>
		<td>デフォルト状態：disableURLRewriting指定なし(=有効)</td>
		<td>Cookie優先</td>
	</tr>
	<tr>
		<td>disableURLRewriting=&quot;true&quot;</td>
		<td>Cookie優先</td>
	</tr>
</table>
<p class="paragraph">
結果(Tomcat 7.0.16)：
<br />
</p>
<table>
	<tr>
		<td>デフォルト状態：&lt;tracking-mode&gt;指定なし</td>
		<td>Cookie優先</td>
	</tr>
	<tr>
		<td>&lt;tracking-mode&gt;COOKIE&lt;/tracking-mode&gt;のみ指定</td>
		<td>Cookie優先</td>
	</tr>
</table>

<p class="paragraph">
リクエスト-レスポンス例(上記4パターン全てで同じ挙動)：
<br />
</p>
<pre class="plugin_pre">
[request]
GET /examples/servlets/servlet/SessionExample;jsessionid=CA3FABDC2A12AF2CA7F33AEABF13280D HTTP/1.1
Host: localhost:8080
User-Agent: Mozilla/5.0 (Windows NT 6.1; rv:13.0) Gecko/20100101 Firefox/13.0.1
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: ja,en-us;q=0.7,en;q=0.3
Accept-Encoding: gzip, deflate
Proxy-Connection: keep-alive
Cookie: JSESSIONID=BFC3212F70EE1BB1D88B9AF9077FC0F7

;;BFC3...が自分のブラウザに発行されたセッションID
;;CA3F...が別ブラウザに発行されたセッションID

[response]
HTTP/1.1 200 OK
Server: Apache-Coyote/1.1
Content-Type: text/html
Content-Length: 1170
Date: Sun, 17 Jun 2012 09:43:10 GMT

&lt;html&gt;
...
&lt;h3&gt;Sessions Example&lt;/h3&gt;
Session ID: BFC3212F70EE1BB1D88B9AF9077FC0F7
</pre>
<p class="paragraph">
→&quot;;jsessionid=&quot;で指定されたセッションIDは無視され、Cookieで送信したセッションIDが使われていることが確認されました。
<br />
</p>

<p class="paragraph">
このように<strong>既にCookieがセットされた状態であれば</strong>URLではなくCookieの値をセッションIDとして使います。ではCookieが空、つまりそのサイトに初回アクセスしたり、ログアウトされてセッションがクリアされた状態で&quot;;jsessionid=&quot;付きのURLにアクセスするとどうなるかというと、URL Rewriting ON/OFFに応じて以下のようになります。
<br />
</p>
<ul><li> Tomcat 6.0.35<ul><li> URL Rewriting ON/OFF共：<ul><li> &quot;;jsessionid=&quot;で指定された値がセッションIDとしてServlet側では使われます。</li></ul></li></ul></li>
<li> Tomcat 7.0.16<ul><li> &lt;tracking-mode&gt;指定なし：<ul><li> &quot;;jsessionid=&quot;で指定された値がセッションIDとしてServlet側では使われます。</li></ul></li>
<li> &lt;tracking-mode&gt;COOKIE&lt;/tracking-mode&gt;のみ指定:<ul><li> &quot;;jsessionid=&quot;で指定された値は無視され、新たなセッションIDがSet-Cookieされます。</li></ul></li></ul></li></ul>

<p class="paragraph">
<strong>Tomcat 6.0.35では&quot;;jsessionid=&quot;指定されたCookieをそのまま受け入れてしまっています。</strong>これは、&quot;disableURLRewriting&quot;はあくまでも「URLのRewriting」の設定であってセッション維持の方法の指定ではない=&quot;;jsessionid=&quot;で指定された値が受け入れられる挙動には影響しない、ということが想像されます。
<br />
一方でTomcat7のServlet 3.0での&quot;&lt;tracking-mode&gt;&quot;はURL Rewritingだけでなくセッション維持の方法そのものを指定しているため、COOKIEとした場合Cookieのみが受け入れられ、&quot;;jsessionid=&quot;の指定は無視されているということが想像されます。
<br />
</p>

<h4 id="id35e835">Jettyの場合</h4>

<p class="paragraph">
今回は jetty-hightide-7.6.4.v20120524 を使って、Jettyに最初から含まれているtest.war中のSessionサンプルプログラムの動作を確認してみました。
<br />
</p>

<ul><li> Jetty (web server) - Wikipedia, the free encyclopedia<ul><li> <a class="externallink" href="http://en.wikipedia.org/wiki/Jetty_" target="_blank">http://en.wikipedia.org/wiki/Jetty_</a>(Web_server)</li></ul></li></ul>

<p class="paragraph">
Jetty-7系はServlet 2.5を実装していますので、基本的にはJSESSIONID + &quot;;jsessionid&quot;によるURL Rewritingが有効化されています。しかし設定によりWebアプリごとにJSESSIONIDの名前を変更できたり、URL Rewritingを無効化したりすることが可能です。
<br />
</p>

<ul><li> Jetty/Howto/SessionIds - Eclipsepedia<ul><li> <a class="externallink" href="http://wiki.eclipse.org/Jetty/Howto/SessionIds" target="_blank">http://wiki.eclipse.org/Jetty/Howto/SessionIds</a></li></ul></li></ul>

<h5 id="idd4cd8a">デフォルト状態</h5>

<p class="paragraph">
contexts/test.xml ではデフォルトでは特にsession関連の設定は行われていません。以下がコメントアウトされているだけです。
<br />
</p>
<pre> &lt;!-- disable cookies 
 &lt;Get name=&quot;sessionHandler&quot;&gt;
    &lt;Get name=&quot;sessionManager&quot;&gt;
       &lt;Set name=&quot;usingCookies&quot; type=&quot;boolean&quot;&gt;false&lt;/Set&gt;
    &lt;/Get&gt;
 &lt;/Get&gt;
 --&gt;
</pre>

<p class="paragraph">
この状態で、Burpを使って常にリクエストからCookieヘッダーを除去するようにしたProxyを通してアクセスします。
<br />
まずテストアプリのSessionサンプルは以下のURLでアクセスできました。
<br />
</p>
<pre>http://localhost:8080/test/session/
</pre>
<p class="paragraph">
&quot;No Session&quot;と表示され、&quot;New Session&quot;というボタンが表示されているのでクリックすると以下のような302リダイレクトレスポンスを受信しました。
<br />
</p>
<pre class="plugin_pre">
HTTP/1.1 302 Found
Date: Sun, 17 Jun 2012 07:43:15 GMT
Set-Cookie: JSESSIONID=spzyfhy235vg562pm2yeydof;Path=/test
Expires: Thu, 01 Jan 1970 00:00:00 GMT
Location: http://localhost:8080/test/session/;jsessionid=spzyfhy235vg562pm2yeydof?R=1
Content-Length: 0
Server: Jetty(7.6.4.v20120524)
</pre>
<p class="paragraph">
JSESSIONID Cookieが発行され、さらにLocationでは&quot;;jsessinid=&quot;によりURLでセッションIDを指定するURLにリダイレクトさせています。
<br />
ブラウザはLocationで指定されたURLに遷移しますが、この時、BurpによりCookieヘッダーを削除したリクエストがサーバに送信されました。
<br />
</p>
<pre class="plugin_pre">
GET /test/session/;jsessionid=spzyfhy235vg562pm2yeydof?R=1 HTTP/1.1
Host: localhost:8080
User-Agent: Mozilla/5.0 (Windows NT 6.1; rv:13.0) Gecko/20100101 Firefox/13.0.1
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: ja,en-us;q=0.7,en;q=0.3
Accept-Encoding: gzip, deflate
Proxy-Connection: keep-alive
Referer: http://localhost:8080/test/session/
</pre>
<p class="paragraph">
その結果、レスポンスHTML中の&quot;&lt;form&gt;&quot;タグは以下のようにURL Rewritingされたaction属性がセットされました。
<br />
</p>
<pre>&lt;h1&gt;Session Dump Servlet:&lt;/h1&gt;
&lt;form action=&quot;/test/session/;jsessionid=spzyfhy235vg562pm2yeydof&quot; method=&quot;post&quot;&gt;
&lt;b&gt;ID:&lt;/b&gt; spzyfhy235vg562pm2yeydof&lt;br/&gt;
...
</pre>
<p class="paragraph">
そのままサンプルプログラムの機能としてセッションへのNameとValueペアの追加や更新、削除が正常に実行できました。
<br />
</p>

<h5 id="id52ac84">JSESSIONIDの変更とURL Rewritingの無効化</h5>

<p class="paragraph">
contexts/test.xmlに以下の設定を追加してみます。（上書き保存すると自動的にコンテキストがリロードされます）
<br />
</p>
<pre class="plugin_pre">
&lt;Configure class=&quot;org.eclipse.jetty.webapp.WebAppContext&quot;&gt;
...

  &lt;Get name=&quot;sessionHandler&quot;&gt;
     &lt;Set name=&quot;sessionManager&quot;&gt;
         &lt;New class=&quot;org.eclipse.jetty.server.session.HashSessionManager&quot;&gt;
            &lt;Set name=&quot;sessionCookie&quot;&gt;MYSESSID&lt;/Set&gt;
            &lt;Set name=&quot;sessionIdPathParameterName&quot;&gt;none&lt;/Set&gt;
         &lt;/New&gt;
     &lt;/Set&gt;
  &lt;/Get&gt;

...
&lt;/Configure&gt;
</pre>
<p class="paragraph">
sessionIdPathParameterName に &quot;none&quot; を指定することで、&quot;;jsessionid=&quot;のURL Rewritingが無効化されます。
<br />
コンテキストがリロードされた後、以下のURLにアクセスしました。
<br />
</p>
<pre>http://localhost:8080/test/session/
</pre>
<p class="paragraph">
CookieはBurpにより削除され、URLにも指定されていないので、以下のような&quot;No Session&quot;レスポンスを受信しました。
<br />
</p>
<pre>&lt;h1&gt;Session Dump Servlet:&lt;/h1&gt;
&lt;form action=&quot;/test/session/&quot; method=&quot;post&quot;&gt;
&lt;H3&gt;No Session&lt;/H3&gt;
&lt;input type=&quot;submit&quot; name=&quot;Action&quot; value=&quot;New Session&quot;/&gt;
</pre>
<p class="paragraph">
&quot;New Session&quot;ボタンをクリックすると、以下の302リダイレクトレスポンスを受信しました。
<br />
</p>
<pre class="plugin_pre">
HTTP/1.1 302 Found
Date: Sun, 17 Jun 2012 07:56:52 GMT
Set-Cookie: MYSESSID=1lj1lzunafwtim2g5gy0wsrkd;Path=/test
Expires: Thu, 01 Jan 1970 00:00:00 GMT
Location: http://localhost:8080/test/session/?R=0
Content-Length: 0
Server: Jetty(7.6.4.v20120524)
</pre>

<p class="paragraph">
&quot;Set-Cookie&quot;で発行されるCookie名がXMLで指定した MYSESSID&quot; になっています。また、先ほどと違い、Locationのりダイレクト先に&quot;;jsessionid=&quot;がありません。
<br />
ブラウザはLocationで指定されたURLに遷移しますが、途中のBurpによりCookieヘッダが削除されたリクエストがJettyに送信されました。その結果、セッションが無いものとServlet側では認識され、再度&quot;No Session&quot;レスポンスを受信しました。
<br />
</p>

<h5 id="id1432e5">JSESSIONIDと&quot;;jsessionid=&quot;のどちらが優先されるか。(jetty-hightide-7.6.4.v20120524)</h5>

<p class="paragraph">
Tomcat6(Servlet 2.5)の比較としてjetty-hightide-7.6.4.v20120524について確認してみました。
<br />
先に結論ですが、jettyの場合は &lt;Set name=&quot;sessionIdPathParameterName&quot;&gt;none&lt;/Set&gt; を指定することでServlet側は&quot;;jsessionid=&quot;で指定された値を無視します。但しURL Rewriteについては&quot;;jsessionid=&quot;で指定された値が使われるため、CookieとURL Rewriteされる値がチグハグな状態になります。
<br />
</p>

<p class="paragraph">
1. jetty-hightide-7.6.4.v20120524, &lt;Set name=&quot;sessionIdPathParameterName&quot;&gt;none&lt;/Set&gt;
<br />
</p>

<p class="paragraph">
1-a. Cookie + &quot;;jsessionid=&quot;両方を指定
<br />
</p>
<pre class="plugin_pre">
GET /test/session/;jsessionid=wzf5bjy9k3kxqjif7faaj172 HTTP/1.1
Host: localhost:8080
User-Agent: Mozilla/5.0 (Windows NT 6.1; rv:13.0) Gecko/20100101 Firefox/13.0.1
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: ja,en-us;q=0.7,en;q=0.3
Accept-Encoding: gzip, deflate
Proxy-Connection: keep-alive
Cookie: JSESSIONID=1xxlrptfiimi2iw5spo1kueas


HTTP/1.1 200 OK
Date: Sun, 17 Jun 2012 10:47:51 GMT
Content-Type: text/html;charset=ISO-8859-1
Content-Length: 1068
Server: Jetty(7.6.4.v20120524)

&lt;h1&gt;Session Dump Servlet:&lt;/h1&gt;
&lt;form action=&quot;/test/session/;jsessionid=wzf5bjy9k3kxqjif7faaj172&quot; method=&quot;post&quot;&gt;
&lt;b&gt;ID:&lt;/b&gt; 1xxlrptfiimi2iw5spo1kueas&lt;br/&gt;
...
</pre>
<p class="paragraph">
→ServletにはCookieで送信した値が受け入れられているが、URL Rewritingで使われているのは&quot;;jsessionid=&quot;で指定した値。
<br />
</p>

<p class="paragraph">
1-b. Cookie削除, &quot;;jsessionid=&quot;のみを指定
<br />
</p>
<pre class="plugin_pre">
GET /test/session/;jsessionid=wzf5bjy9k3kxqjif7faaj172 HTTP/1.1
Host: localhost:8080
User-Agent: Mozilla/5.0 (Windows NT 6.1; rv:13.0) Gecko/20100101 Firefox/13.0.1
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: ja,en-us;q=0.7,en;q=0.3
Accept-Encoding: gzip, deflate
Proxy-Connection: keep-alive


HTTP/1.1 200 OK
Date: Sun, 17 Jun 2012 10:48:08 GMT
Content-Type: text/html;charset=ISO-8859-1
Content-Length: 193
Server: Jetty(7.6.4.v20120524)

&lt;h1&gt;Session Dump Servlet:&lt;/h1&gt;
&lt;form action=&quot;/test/session/;jsessionid=wzf5bjy9k3kxqjif7faaj172&quot; method=&quot;post&quot;&gt;
&lt;H3&gt;No Session&lt;/H3&gt;
&lt;input type=&quot;submit&quot; name=&quot;Action&quot; value=&quot;New Session&quot;/&gt;
</pre>
<p class="paragraph">
→&quot;No Session&quot;と判定されているが、&quot;&lt;form&gt;&quot;要素の&quot;action&quot;属性には&quot;;jsessionid=&quot;で指定した値でそのままURL RewriteされたURLが埋め込まれています。なお、このまま&quot;New Session&quot;をクリックすると以下のようになります(Burpにより強制的にCookieを削除して送っています)：
<br />
</p>
<pre class="plugin_pre">
POST /test/session/;jsessionid=wzf5bjy9k3kxqjif7faaj172 HTTP/1.1
Host: localhost:8080
User-Agent: Mozilla/5.0 (Windows NT 6.1; rv:13.0) Gecko/20100101 Firefox/13.0.1
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: ja,en-us;q=0.7,en;q=0.3
Accept-Encoding: gzip, deflate
Proxy-Connection: keep-alive
Referer: http://localhost:8080/test/session/;jsessionid=wzf5bjy9k3kxqjif7faaj172?R=4
Content-Type: application/x-www-form-urlencoded
Content-Length: 18

Action=New+Session

HTTP/1.1 302 Found
Date: Sun, 17 Jun 2012 10:53:24 GMT
Set-Cookie: JSESSIONID=1c69qt9s3qjnr1s2s0ez300q;Path=/test
Expires: Thu, 01 Jan 1970 00:00:00 GMT
Location: http://localhost:8080/test/session/;jsessionid=wzf5bjy9k3kxqjif7faaj172?R=5
Content-Length: 0
Server: Jetty(7.6.4.v20120524)

GET /test/session/;jsessionid=wzf5bjy9k3kxqjif7faaj172?R=5 HTTP/1.1
Host: localhost:8080
User-Agent: Mozilla/5.0 (Windows NT 6.1; rv:13.0) Gecko/20100101 Firefox/13.0.1
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: ja,en-us;q=0.7,en;q=0.3
Accept-Encoding: gzip, deflate
Proxy-Connection: keep-alive
Referer: http://localhost:8080/test/session/;jsessionid=wzf5bjy9k3kxqjif7faaj172?R=4

HTTP/1.1 200 OK
Date: Sun, 17 Jun 2012 10:53:25 GMT
Content-Type: text/html;charset=ISO-8859-1
Content-Length: 193
Server: Jetty(7.6.4.v20120524)

&lt;h1&gt;Session Dump Servlet:&lt;/h1&gt;
&lt;form action=&quot;/test/session/;jsessionid=wzf5bjy9k3kxqjif7faaj172&quot; method=&quot;post&quot;&gt;
&lt;H3&gt;No Session&lt;/H3&gt;
&lt;input type=&quot;submit&quot; name=&quot;Action&quot; value=&quot;New Session&quot;/&gt;
</pre>
<p class="paragraph">
ここでCookieを有効にしてもう一度&quot;New Session&quot;をクリックします。
<br />
</p>
<pre class="plugin_pre">
HTTP/1.1 302 Found
Date: Sun, 17 Jun 2012 10:53:53 GMT
Set-Cookie: JSESSIONID=k2jt9gwim4t09qyip8hmbxu6;Path=/test
Expires: Thu, 01 Jan 1970 00:00:00 GMT
Location: http://localhost:8080/test/session/;jsessionid=wzf5bjy9k3kxqjif7faaj172?R=6
Content-Length: 0
Server: Jetty(7.6.4.v20120524)

GET /test/session/;jsessionid=wzf5bjy9k3kxqjif7faaj172?R=6 HTTP/1.1
Host: localhost:8080
User-Agent: Mozilla/5.0 (Windows NT 6.1; rv:13.0) Gecko/20100101 Firefox/13.0.1
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: ja,en-us;q=0.7,en;q=0.3
Accept-Encoding: gzip, deflate
Proxy-Connection: keep-alive
Referer: http://localhost:8080/test/session/;jsessionid=wzf5bjy9k3kxqjif7faaj172?R=5
Cookie: JSESSIONID=k2jt9gwim4t09qyip8hmbxu6

HTTP/1.1 200 OK
Date: Sun, 17 Jun 2012 10:53:54 GMT
Content-Type: text/html;charset=ISO-8859-1
Content-Length: 1043
Server: Jetty(7.6.4.v20120524)

&lt;h1&gt;Session Dump Servlet:&lt;/h1&gt;
&lt;form action=&quot;/test/session/;jsessionid=wzf5bjy9k3kxqjif7faaj172&quot; method=&quot;post&quot;&gt;
&lt;b&gt;ID:&lt;/b&gt; k2jt9gwim4t09qyip8hmbxu6&lt;br/&gt;
...
</pre>

<p class="paragraph">
結論から言うと、Jetty7で&lt;Set name=&quot;sessionIdPathParameterName&quot;&gt;none&lt;/Set&gt;とした場合、URL Rewritingに使われるのは&quot;;jsessionid=&quot;で指定された値であるものの、実際にServletが処理で使っているのはCookieの値となります。
<br />
</p>

<p class="paragraph">
2. jetty-hightide-7.6.4.v20120524, デフォルト
<br />
</p>

<p class="paragraph">
2-a. Cookie + &quot;;jsessionid=&quot;両方を指定
<br />
</p>
<pre class="plugin_pre">
GET /test/session/;jsessionid=ku2aqgtv6zefbk4on821ebaa HTTP/1.1
Host: localhost:8080
User-Agent: Mozilla/5.0 (Windows NT 6.1; rv:13.0) Gecko/20100101 Firefox/13.0.1
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: ja,en-us;q=0.7,en;q=0.3
Accept-Encoding: gzip, deflate
Proxy-Connection: keep-alive
Cookie: JSESSIONID=1hkvypdmvxe5wrmgbf8zz3fqz

HTTP/1.1 200 OK
Date: Sun, 17 Jun 2012 11:02:18 GMT
Content-Type: text/html;charset=ISO-8859-1
Content-Length: 997
Server: Jetty(7.6.4.v20120524)

&lt;h1&gt;Session Dump Servlet:&lt;/h1&gt;
&lt;form action=&quot;/test/session/&quot; method=&quot;post&quot;&gt;
&lt;b&gt;ID:&lt;/b&gt; 1hkvypdmvxe5wrmgbf8zz3fqz&lt;br/&gt;
</pre>
<p class="paragraph">
→&quot;;jsessionid=&quot;で指定した値は完全に無視され、&quot;&lt;form&gt;&quot;要素の&quot;action&quot;属性もURL Rewriteされていません。
<br />
</p>

<p class="paragraph">
2-b. Cookie削除, &quot;;jsessionid=&quot;のみを指定
<br />
</p>
<pre class="plugin_pre">
GET /test/session/;jsessionid=ku2aqgtv6zefbk4on821ebaa HTTP/1.1
Host: localhost:8080
User-Agent: Mozilla/5.0 (Windows NT 6.1; rv:13.0) Gecko/20100101 Firefox/13.0.1
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: ja,en-us;q=0.7,en;q=0.3
Accept-Encoding: gzip, deflate
Proxy-Connection: keep-alive

HTTP/1.1 200 OK
Date: Sun, 17 Jun 2012 11:04:25 GMT
Content-Type: text/html;charset=ISO-8859-1
Content-Length: 1070
Server: Jetty(7.6.4.v20120524)

&lt;h1&gt;Session Dump Servlet:&lt;/h1&gt;
&lt;form action=&quot;/test/session/;jsessionid=ku2aqgtv6zefbk4on821ebaa&quot; method=&quot;post&quot;&gt;
&lt;b&gt;ID:&lt;/b&gt; ku2aqgtv6zefbk4on821ebaa&lt;br/&gt;
...
</pre>
<p class="paragraph">
→Servlet側で&quot;;jsessionid=&quot;で指定された値を受け入れ、さらにURL Rewritingでも使っていることが確認されました。
<br />
</p>


<h3 id="id571109">まとめ：ServletプログラミングでURLセッション管理を無効化するには</h3>

<ul><li><strong>Servlet 3.0以上に対応したServletコンテナを使用するのが確実な方法と考えられます。</strong></li>
<li> TomcatやJettyで確認したように、Servlet 2.5対応のServletコンテナにおいても URL Rewriting によるセッション維持を無効化できるよう独自に対応しているものがあります。</li>
<li> 問題１：ブラウザの履歴やブックマーク、リンク等によるセッションIDの漏えい<ul><li> これを防ぐという目的においては、それらの独自対応により効果があると考えられます。</li></ul></li>
<li> 問題２：セッション固定化の問題で、攻撃者が用意したセッションを使わせるための誘導用URLに悪用される<ul><li> Cookieと&quot;;jsessionid=&quot;とで異なるセッションIDが指定された場合、少なくともTomcat6とJetty7においては、Cookieで指定された方をServlet側で取得できます。従って&quot;;jsessionid=&quot;によるセッション固定化の問題を考慮しなければならないのは、「対象サイトのCookieが空の状態の被害者が、攻撃者が用意した&quot;;jsessionid=&quot;付きURLに誘導された場合」であると考えられます。</li>
<li> Servlet2.5系までのコンテナによるURL Rewriting無効化独自対応については、それがURL Rewriting「だけ」を無効化するのか、&quot;;jsessionid=&quot;によるセッションIDの受け入れまで含めて無効化しているのかについてはServletコンテナにより異なるようです。<ul><li> もしセッションIDの受け入れまで含めて無効化してくれるのであれば、「対象サイトのCookieが空の状態の被害者が、攻撃者が用意した&quot;;jsessionid=&quot;付きURLに誘導された場合」でも問題無いと考えることができそうです。</li>
<li> もし&quot;;jsessionid=&quot;については依然として受け入れてしまうのであれば、Cookie空状態での誘導ケースについては問題が残っていると考えることができそうです。</li></ul></li></ul></li></ul>

<p class="paragraph">
もし完全にセッションIDを制御下に置きたいのであれば、ServletコンテナすなわちServletの仕様で提供されているセッション機構を使うのでなく、独自のセッション管理機構を開発した方が良いのかもしれません・・・。
<br />
</p>

<p class="paragraph">
他、参考になったURL：
<br />
</p>
<ul><li> WEB開発メモ: 初回アクセス時のjsessionidを非表示にする<ul><li> <a class="externallink" href="http://buzzmemo.blogspot.jp/2010/03/jsessionid.html" target="_blank">http://buzzmemo.blogspot.jp/2010/03/jsessionid.html</a></li></ul></li>
<li> 最初のアクセスで;jsessionidを表示させない方法 - ひがやすを blog<ul><li> <a class="externallink" href="http://d.hatena.ne.jp/higayasuo/20080724/1216889790" target="_blank">http://d.hatena.ne.jp/higayasuo/20080724/1216889790</a></li></ul></li>
<li> strutsのjsessionid - ぐだぐだ日記<ul><li> <a class="externallink" href="http://d.hatena.ne.jp/izuno4t/20041105/1099587280" target="_blank">http://d.hatena.ne.jp/izuno4t/20041105/1099587280</a></li></ul></li>
<li> TomcatのJSESSIONIDに悩んだら<ul><li> <a class="externallink" href="http://neta.ywcafe.net/001172.html" target="_blank">http://neta.ywcafe.net/001172.html</a></li></ul></li></ul>

<hr />
<p class="paragraph">
あとがき：
<br />
</p>

<p class="paragraph">
OWASPとかWASCも調べてみたんですが、Servletの&quot;;jsessionid=&quot;の記事が見つかりませんでした。Session管理系の話題でもスルーされているようです。
<br />
とまれ、数年来の疑問が解決しましたので気分的にはすっきりしました。
<br />
LL言語であれば変数のシリアライズが比較的簡単に出来るので、独自のセッション機構を開発するのは割りと敷居が低いのですが、Java Servletとなりますと、特にレプリケーションなどで複数インスタンス間で同期を取ることを考えるとJavaオブジェクトのSerializeをしなければなりませんので大変そうです。Servletコンテナの1インスタンス内で完結するのであれば他にやり用はあるかもしれませんが・・・。
<br />
</p>


<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-1266.html" title="Java/Serializeメモ">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-1346.html" title="Java/Socket, InetAddressにおけるDNS名前解決の仕組みと networkaddress.cache.ttl">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-457.html" title="Java">Up</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-457.html" title="Java">Java</a>&nbsp;]</li>
</ul>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/1093<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2001 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a target="_blank" href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" target="_blank" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>