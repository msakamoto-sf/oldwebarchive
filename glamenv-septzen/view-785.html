<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Assembler/ForFun(x86_32)/04, 16bit BIOS with NASM - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">Assembler/ForFun(x86_32)/04, 16bit BIOS with NASM</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2010-09-17 13:15:40 &nbsp; / &nbsp; last updated at: 2010-09-19 20:59:21<br>
カテゴリ: <a href="category-48.html">Assembler</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-784.html" title="Assembler/ForFun(x86_32)/03, x86_32用 デバッグ機能有効化 Bochs をVC++2008でビルド">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-787.html" title="Assembler/ForFun(x86_32)/05, 16bit BIOS with GNU as">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-410.html" title="Assembler">Assembler</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
x86エミュレータであるBochsを使うことで、BIOSレベルでのプログラミングを楽しむことが出来ます。
<br />
今回はNASMを使って&quot;Hello, World!&quot;を出力させてみましょう。
<br />
</p>

<p class="paragraph">
なお、本記事ではMaster Boot Record (MBR)を使ったアセンブラプログラミングの詳細は解説しません。すでに入門レベルは経験済みの読者を想定しています。
<br />
</p>



<hr />
<ul><li><a href="#ideb2d5f">Bochsの準備</a></li>
<li><a href="#ideed9af">&quot;Hello, World!&quot; : INT 10h - AH=13h 版</a></li>
<li><a href="#id7749ff">&quot;Hello, World!&quot; : ビデオメモリに直接書き込む版</a></li>
<li><a href="#id8a2865">まとめと参考記事</a></li></ul>
<hr />
<h3 id="ideb2d5f">Bochsの準備</h3>

<p class="paragraph">
最初にBochsが使う仮想マシン設定ファイルを用意します。拡張子は一般的に&quot;.bxrc&quot;とすることが多いようです。
<br />
Bochs付属のサンプルを使っても良いですが、最低限度の機能があれば良いので、次の5行だけでもOKです。
<br />
hello.bxrc:
<br />
</p>
<pre>romimage: file=$BXSHARE/BIOS-bochs-latest 
vgaromimage: file=$BXSHARE/VGABIOS-lgpl-latest
megs: 16
floppya: 1_44=hello1.img, status=inserted
boot: floppy
</pre>

<p class="paragraph">
フロッピーからのBOOTにのみ対応し、16MBのメインメモリ、フロッピーイメージは&quot;hello1.img&quot;で挿入された状態で起動します。
<br />
</p>

<p class="paragraph">
では、これから&quot;hello1.img&quot;を作ってみましょう。
<br />
</p>

<h3 id="ideed9af">&quot;Hello, World!&quot; : INT 10h - AH=13h 版</h3>

<p class="paragraph">
BIOSのINT 10hがビデオ関連の割り込みになっています。
<br />
まず最初に、改行コードなども扱ってくれる INT 10h - AH=13h 割り込みを使って表示させてみます。
<br />
INT 10h - AH=13h 割り込みでは画面のページ番号やカーソル位置などを設定しておく必要があります。
<br />
ページ番号は INT 10h - AH=0Fh , カーソル位置は INT 10h - 03h で取得出来ますので、事前に呼んでおきます。
<br />
</p>

<p class="paragraph">
ソースコードは次のようになります。
<br />
hello1.asm:
<br />
</p>
<pre class="plugin_pre">
org 0H
bits 16

    JMP 0x07C0:start ; far jmp, update CS to 0x07C0

start:
    ; copy CS(0x07C0) to DS, ES
    MOV AX, CS
    MOV DS, AX
    MOV ES, AX

    ; get current video mode
    XOR AX, AX
    XOR BX, BX
    MOV AH, 0FH
    INT 10H
    ; active page num =&gt; BH

    ; get cursor position and size
    MOV AH, 03H
    INT 10H
    ; (row, column) =&gt; (DH, DL)

    ; write string
    MOV AH, 13H
    MOV AL, 1 ; bit0 = 1 =&gt; update cursor
    ; BH = page num # already set by INT10H/AH=0FH
    MOV BL, 11111001B ; character attribute, blinking, bg=light gray, fg=light blue
    MOV CX, [hellomsg_len] ; string length
    ; DH, DL (row, column) already set by INT10H/AH=03H
    PUSH BP
    MOV BP, hellomsg
    INT 10H
    POP BP

    JMP $

hellomsg_0:
hellomsg: db `Hello, \r\nBIOS World!\r\n`
hellomsg_len: dw $ - hellomsg_0

times 510-($-$$) db 0
    dw 0xAA55
</pre>

<p class="paragraph">
MBRは0x7C00以降に読み込まれます。念のため、far jmpを使ってCSを更新しておきます。
<br />
MBRですので、510バイト0埋め + &quot;0xAA55&quot;が必要です。NASMですと以下の記述で実現出来ます。
<br />
</p>
<pre>times 510-($-$$) db 0
    dw 0xAA55
</pre>
<p class="paragraph">
&quot;$&quot;はNASMではアセンブラの現在位置を示します。&quot;$$&quot;は現在のセクションの先頭位置を示します。よって
<br />
</p>
<pre>$ - $$
</pre>
<p class="paragraph">
で現在位置がセクション先頭からどれだけ離れているかが分かります。
<br />
</p>
<ul><li> &quot;Chapter 3: The NASM Language&quot; &gt; &quot;3.5 Expressions&quot;<ul><li> <a class="externallink" href="http://www.nasm.us/doc/nasmdoc3.html#section-3.5" target="_blank">http://www.nasm.us/doc/nasmdoc3.html#section-3.5</a></li></ul></li></ul>

<p class="paragraph">
&quot;times&quot;プレフィクスは、その後ろに続くアセンブラを指定回数分繰り返す機能があります。
<br />
</p>
<ul><li> &quot;Chapter 3: The NASM Language&quot; &gt; &quot;3.2.5 TIMES: Repeating Instructions or Data&quot;<ul><li> <a class="externallink" href="http://www.nasm.us/doc/nasmdoc3.html#section-3.2.5" target="_blank">http://www.nasm.us/doc/nasmdoc3.html#section-3.2.5</a></li></ul></li></ul>
<p class="paragraph">
これらの組み合わせで、
<br />
</p>
<pre>times 510-($-$$) db 0
</pre>
<p class="paragraph">
これが「現在位置から510バイトまで0埋め」と解釈されます。
<br />
</p>

<p class="paragraph">
コンパイル：
<br />
</p>
<pre>&gt; nasm -f bin -o hello1.img hello1.asm
</pre>

<p class="paragraph">
Bochsで実行してみると、&quot;Booting from Floppy ...&quot;の次の行に、改行処理されて&quot;Hello, BIOS World!&quot;文字列が点滅しながら表示されます。色も指定した通りの背景色・文字色で表示されています。
<br />
</p>

<p class="paragraph">
<a href="./../medias/asm_for_fun/16bit_bios_nasm_hello1.jpg" title="" target="_blank"><img src="./../medias/asm_for_fun/16bit_bios_nasm_hello1.jpg" alt="" title=""  /></a>
<br />
</p>

<h3 id="id7749ff">&quot;Hello, World!&quot; : ビデオメモリに直接書き込む版</h3>

<p class="paragraph">
IBM PCの伝統として、セグメント0xB800がカラーテキストモードのデフォルト画面にマッピングされています。
<br />
0xB800:0000 以降に、直接カラーデータやASCIIコードを書き込むことで文字列を表示することが可能です。
<br />
1文字は1ワードで表現され、ASCIIデータが低位に、カラーデータが高位に格納されています。
<br />
画面サイズは、Bochs起動直後は80桁x25行になっています。
<br />
</p>

<p class="paragraph">
では、画面背景をLight Grayで塗りつぶし、左上から&quot;Hello, BIOS World!&quot;を黒字で表示させてみましょう。
<br />
hello2.asm:
<br />
</p>
<pre class="plugin_pre">
org 0H
bits 16

    JMP 0x07C0:start ; far jmp, update CS to 0x07C0

videoseg equ 0xB800
cols equ 80
rows equ 25
bgcolor equ 01110000B ; no blink, bg = light gray, fg = black
bgtext equ 0x20 ; space char

start:
    ; copy CS(0x07C0) to DS, ES
    MOV AX, CS
    MOV DS, AX

    MOV AX, videoseg
    MOV ES, AX
    MOV DI, 0

    ; clear background color and texts
    MOV AL, bgtext
    MOV AH, bgcolor
    ; for (i = 0; i &lt; rows; i++) {
    MOV CX, rows
.bg_fill_rows:
    PUSH CX
    ;     for (j = 0; j &lt; cols; j++) {
    MOV CX, cols
.bg_fill_cols:
    MOV [ES:DI], AX
    ADD DI, 2
    LOOP .bg_fill_cols
    ;     }
    POP CX
    LOOP .bg_fill_rows
    ; }

    XOR AX, AX
    XOR DI, DI
    MOV SI, hellomsg
.print:
    MOV BYTE AL, [DS:SI]
    CMP AX, 0
    JZ .print_end
    MOV BYTE [ES:DI], AL
    INC SI
    ADD DI, 2
    JMP .print
.print_end:

    JMP $


hellomsg: db &quot;Hello, BIOS World!&quot;, 0

times 510-($-$$) db 0
    dw 0xAA55
</pre>

<p class="paragraph">
コンパイル：
<br />
</p>
<pre>&gt; nasm -f bin -o hello2.img hello2.asm
</pre>

<p class="paragraph">
hello.bxrc でhello2.imgを指定します。
<br />
</p>
<pre>floppya: 1_44=hello1.img, status=inserted
-&gt;
floppya: 1_44=hello2.img, status=inserted
</pre>

<p class="paragraph">
Bochsで実行してみます。上手く表示出来ました。
<br />
</p>

<p class="paragraph">
<a href="./../medias/asm_for_fun/16bit_bios_nasm_hello2.jpg" title="" target="_blank"><img src="./../medias/asm_for_fun/16bit_bios_nasm_hello2.jpg" alt="" title=""  /></a>
<br />
</p>

<h3 id="id8a2865">まとめと参考記事</h3>

<p class="paragraph">
NASMとBIOS, VGAの提供する INT 10h 割り込みを使って &quot;Hello, World!&quot; アセンブラプログラミングを体験しました。
<br />
</p>

<p class="paragraph">
なおデバッグ機能を有効にしたBochsで試す時は、起動後に
<br />
</p>
<pre>&gt; b 0x7C00
</pre>
<p class="paragraph">
としてMBRの先頭の物理アドレス指定でブレークポイントを設定し、
<br />
</p>
<pre>&gt; c
</pre>
<p class="paragraph">
で実行すると、MBRの先頭で止まります。&quot;vb&quot;で&quot;0x07C0:0000&quot;形式で設定してもブレークしないので、必ず物理アドレスでブレークポイントを設定して下さい。
<br />
</p>

<p class="paragraph">
今回はテキストモードしか取りあげませんでしたが、グラフィックモードなどを使うことでビデオゲームを作ることも出来ます。
<br />
VGAプログラミングの詳細は、x86アセンブラプログラミングではなく、ゲームプログラミングとして検索した方が良いでしょう。
<br />
</p>

<ul><li> BIOS interrupt call - Wikipedia, the free encyclopedia<ul><li> <a class="externallink" href="http://en.wikipedia.org/wiki/BIOS_interrupt_call" target="_blank">http://en.wikipedia.org/wiki/BIOS_interrupt_call</a></li></ul></li>
<li> INT 10 - Wikipedia, the free encyclopedia<ul><li> <a class="externallink" href="http://en.wikipedia.org/wiki/INT_10" target="_blank">http://en.wikipedia.org/wiki/INT_10</a></li></ul></li>
<li> Video Graphics Array - Wikipedia, the free encyclopedia<ul><li> <a class="externallink" href="http://en.wikipedia.org/wiki/Video_Graphics_Array" target="_blank">http://en.wikipedia.org/wiki/Video_Graphics_Array</a></li></ul></li>
<li> Ralf Brown&#039;s Interrupt List, int 10<ul><li> <a class="externallink" href="http://www.ctyme.com/intr/int-10.htm" target="_blank">http://www.ctyme.com/intr/int-10.htm</a></li></ul></li>
<li> Art of Assembly Language/DOS, Chapter 23 The PC Video Display<ul><li> <a class="externallink" href="http://webster.cs.ucr.edu/AoA/DOS/ch23/CH23-1.html" target="_blank">http://webster.cs.ucr.edu/AoA/DOS/ch23/CH23-1.html</a></li></ul></li>
<li> Programming the VGA<ul><li> <a class="externallink" href="http://www.fysnet.net/modex.htm" target="_blank">http://www.fysnet.net/modex.htm</a></li></ul></li>
<li> VGA/SVGA Video Programming--Standard VGA Chipset Reference<ul><li> <a class="externallink" href="http://www.osdever.net/FreeVGA/vga/vga.htm" target="_blank">http://www.osdever.net/FreeVGA/vga/vga.htm</a></li></ul></li>
<li> Atrevida Tutorial 7: Introduction to VGA . . . Mode 13h<ul><li> <a class="externallink" href="http://atrevida.comprenica.com/atrtut07.html" target="_blank">http://atrevida.comprenica.com/atrtut07.html</a></li></ul></li>
<li> 256-Color VGA Programming in C<ul><li> <a class="externallink" href="http://www.brackeen.com/vga/index.html" target="_blank">http://www.brackeen.com/vga/index.html</a></li></ul></li></ul>

<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-784.html" title="Assembler/ForFun(x86_32)/03, x86_32用 デバッグ機能有効化 Bochs をVC++2008でビルド">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-787.html" title="Assembler/ForFun(x86_32)/05, 16bit BIOS with GNU as">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-790.html" title="Assembler/ForFun(x86_32)">Up</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-410.html" title="Assembler">Assembler</a>&nbsp;]</li>
</ul>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/785<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2007 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>