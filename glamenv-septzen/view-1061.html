<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>日記/2012/02/12/AmazonEC2+EBS+milkodeでAndroidソース調査環境を整える - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">日記/2012/02/12/AmazonEC2+EBS+milkodeでAndroidソース調査環境を整える</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2012-02-12 21:42:16 &nbsp; / &nbsp; last updated at: 2012-02-12 22:52:51<br>
カテゴリ: <a href="category-58.html">Android</a>&nbsp;</div>

<div class="data_body">
<p class="paragraph">
というのに遅ればせながら自分もtryしてみたので、駆け足でメモ。
<br />
</p>

<p class="paragraph">
コンセプト：Androidのソースツリーをmirrorモードでsync + そこから任意のバージョンのソースツリーをさらにsyncして、そのソースツリーをmilkodeに突っ込む。
<br />
</p>

<p class="paragraph">
当然、数十GB単位のディスクスペースが必要で、環境準備だけで数時間かかる(mirrorモードのsyncやmilkodeへの登録が時間かかる)。
<br />
さらに、週末やお仕事中の「ちょっとした空き時間で調べごと」をしたいだけなので、それ以外の時間はインスタンスを落としておきたい。となるとEBS(Elastic Block Storage)で永続化して必要なときだけインスタンスを上げておく使い方になる。
<br />
</p>




<h3 id="idb35494">1. AmazonEC2+ESB</h3>

<p class="paragraph">
ということで、今回はCommunity AMIsから&quot;099720109477/ebs/ubuntu-images/ubuntu-lucid-10.04-amd64-server-20110930&quot;を使ってrootを8GBのubuntu 10.04 64ビット版で立ち上げ。マイクロではメモリが足りなさすぎるので、スタンダード オンデマンドインスタンスのラージモデルで立ち上げ。
<br />
</p>

<p class="paragraph">
躓いたところ：
<br />
</p>
<ol><li> Security Groupを何も設定してなかったので、外部からアクセスできず、SSHすら接続出来なかった。</li>
<li> 最初に立ち上げたインスタンス、うっかり&quot;Terminate&quot;してしまってロスト。AWSのコンソールには表示されているのに、どう頑張っても&quot;Start&quot;が出来ず1時間ほど嵌った。</li></ol>

<p class="paragraph">
Security Groupはとりあえずdefaultにして、HTTP, SSH, HTTPSを0.0.0.0から許可。
<br />
インスタンスが立ち上がったら、
<br />
</p>
<pre>sudo aptitude update
sudo aptitude safe-upgrade
sudo reboot
</pre>
<p class="paragraph">
した上で、さらに次のURLを参考にパッケージ環境を調整する。
<br />
</p>
<ul><li> Initializing a Build Environment | Android Open Source<ul><li> <a class="externallink" href="http://source.android.com/source/initializing.html" target="_blank">http://source.android.com/source/initializing.html</a></li></ul></li></ul>

<p class="paragraph">
一方でAWSコンソール上からEBSで100GBのVolumeを用意して、実行中のインスタンスにattach。今回は/dev/sdfにattachした。
<br />
→ext4で初期化：
<br />
</p>
<pre class="plugin_pre">
# mkfs.ext4 /dev/sdf
mke2fs 1.41.11 (14-Mar-2010)
/dev/sdf is entire device, not just one partition!
Proceed anyway? (y,n) y
Filesystem label=
OS type: Linux
Block size=4096 (log=2)
Fragment size=4096 (log=2)
Stride=0 blocks, Stripe width=0 blocks
6553600 inodes, 26214400 blocks
1310720 blocks (5.00%) reserved for the super user
First data block=0
Maximum filesystem blocks=4294967296
800 block groups
32768 blocks per group, 32768 fragments per group
8192 inodes per group
Superblock backups stored on blocks:
        32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208,
        4096000, 7962624, 11239424, 20480000, 23887872

Writing inode tables: done
Creating journal (32768 blocks): done
Writing superblocks and filesystem accounting information:
done

This filesystem will be automatically checked every 24 mounts or
180 days, whichever comes first.  Use tune2fs -c or -i to override.
</pre>

<p class="paragraph">
その後独自の作業用ディレクトリ &quot;/work&quot; にマウント。
<br />
</p>
<pre># mkdir /work
# mount /dev/sdf /work
</pre>
<p class="paragraph">
&quot;/etc/fstab&quot;にも追加しておきました。
<br />
</p>
<pre>/dev/sdf   /work    auto   defaults    0   0
</pre>
<p class="paragraph">
&quot;/work&quot;のユーザとかパーミッションは、後でubuntuユーザでmkdirとか出来るように適当に調整しておく。
<br />
</p>

<p class="paragraph">
忘れずにsshdの設定を直しておく。
<br />
/etc/ssh/sshd_confi:
<br />
</p>
<pre>Protocol 2
...
PermitRootLogin no
...
PermitEmptyPasswords no
...
PasswordAuthentication no
</pre>
<p class="paragraph">
設定したら
<br />
</p>
<pre># service ssh restart
</pre>


<h3 id="id63ba2c">2. repo syncをtmuxで放置</h3>

<p class="paragraph">
今回はtmuxを使うが、screenでも可。ポイントは、非常に時間がかかり場合によっては一度HTTP 401が返されたりして躓くため、tmuxやscreenでrepo syncを放置できる状態が必要。
<br />
</p>

<p class="paragraph">
tmuxはapt-getですんなりインストール可能。
<br />
参考：
<br />
</p>
<ul><li> 時代はGNU screenからtmuxへ - それ、Gentooだとどうなる？<ul><li> <a class="externallink" href="http://d.hatena.ne.jp/tmatsuu/20090709/1247150771" target="_blank">http://d.hatena.ne.jp/tmatsuu/20090709/1247150771</a></li></ul></li>
<li> iTerm2 + zsh + tmux + vim で快適な256色ターミナル環境を構築する - ゆろよろ日記<ul><li> <a class="externallink" href="http://d.hatena.ne.jp/yuroyoro/20120211/1328930819" target="_blank">http://d.hatena.ne.jp/yuroyoro/20120211/1328930819</a></li></ul></li></ul>

<p class="paragraph">
何回もrepo syncしてると、負荷を下げるためかHTTP 401がrepo syncによるfetchingで返されるようになる。
<br />
その場合は以下のページの&quot;Using authentication&quot;を参考に、~/.netrcファイルを適切に設定し、repo syncを再挑戦する。
<br />
</p>
<ul><li> Downloading the Source Tree | Android Open Source<ul><li> <a class="externallink" href="http://source.android.com/source/downloading.html" target="_blank">http://source.android.com/source/downloading.html</a></li></ul></li></ul>

<p class="paragraph">
さらに今回はmirrorモードとしてrepo syncした。
<br />
</p>
<pre>$ mkdir -p /work/android/src-mirror
$ cd /work/android/src-mirror
$ repo init -u ... -mirror
$ repo sync
</pre>

<p class="paragraph">
mirrorのsyncが完了すれば（もしかしたら途中から401が発生して.netrcを調整したり、Networkエラーで途中でこけてまたsyncしなおしたりとあったかもしれないが）、そこから特定のbranchをrepo syncする。
<br />
</p>
<pre>$ mkdir -p /work/android/src-android-2.3.6_r1
$ cd /work/android/src-android-2.3.6_r1
$ repo init -u /work/android/src-mirror/platform/manifest.git -b android-2.3.6_r1
$ repo sync
</pre>

<h3 id="idab09f6">3. milkodeでインデックス化</h3>

<p class="paragraph">
参考：下記のURLを参考に、一部実際は変更してます。rvmのバージョンも多少変わってると思いますし・・・。
<br />
</p>
<ul><li> milkodeでAndroidのソースコードを検索する | Happy my life<ul><li> <a class="externallink" href="http://blog.cnu.jp/2011/08/16/milkode-android/" target="_blank">http://blog.cnu.jp/2011/08/16/milkode-android/</a></li></ul></li></ul>

<p class="paragraph">
まずrvmを導入する。すいません、ruby使ってないので、1.8のバージョンがどうとか1.9がどうとか、gemの置き場所だの依存関係がどうだのとかよく分からないので手を抜きました。
<br />
</p>
<ul><li> RVM: Ruby Version Manager - RVM Ruby Version Manager - Documentation<ul><li> <a class="externallink" href="http://beginrescueend.com/" target="_blank">http://beginrescueend.com/</a></li></ul></li></ul>

<p class="paragraph">
rvmのインストールが完了すると、.bashrcとか.profileとかに追記が入るので、ログインしなおすなり&quot;.&quot;で取り込むなりしておく。
<br />
続いて
<br />
</p>
<pre>$ sudo apt-get install build-essential
</pre>
<p class="paragraph">
しておく・・・けど、多分repo sync環境の調整時に殆ど入ってるかも。milkode入れる段になって
<br />
</p>
<pre>$ sudo apt-get install libxml2 libxslt
</pre>
<p class="paragraph">
したくらい？
<br />
</p>

<p class="paragraph">
あとは
<br />
</p>
<pre>$ rvm install 1.8.7
$ rvm use 1.8.7
$ gem install milkode
</pre>
<p class="paragraph">
で終わり。
<br />
以降、ログインしなおしたら
<br />
</p>
<pre>$ rvm use 1.8.7
</pre>
<p class="paragraph">
がおまじないとなる。
<br />
</p>

<p class="paragraph">
続いてmilkodeのデータベースを作る。
<br />
</p>
<pre>$ mkdir -p /work/milkdbs/src-android
$ cd /work/milkdbs/src-android
$ milk init
$ milk add /work/android/src-android-2.3.6_r1
$ milk add /work/android/src-android-x.y.z_rN (お好みの他のバージョンツリー)
</pre>

<p class="paragraph">
検索例：
<br />
</p>
<pre>$ milk setdb /work/milkdbs/src-android
$ milk grep -a &quot;cacerts&quot;
...
</pre>

<p class="paragraph">
あるいは&quot;milk web&quot;でWebインターフェイスを立ち上げてもOK。その場合は&quot;-p&quot;オプションで適宜ポートを指定した上で、AWSコンソールから&quot;Security Groups&quot;でそのポート番号のInboundを許可しておく設定が必要。
<br />
</p>

<p class="paragraph">
参考：
<br />
</p>
<ul><li> データベースの作成、パッケージ登録 - Milkode<ul><li> <a class="externallink" href="http://milkode.ongaeshi.me/wiki/%E3%83%81%E3%83%A5%E3%83%BC%E3%83%88%E3%83%AA%E3%82%A2%E3%83%AB" target="_blank">http://milkode.ongaeshi.me/wiki/%E3%83%81%E3%83%A5%E3%83%BC%E3%83%88%E3%83%AA%E3%82%A2%E3%83%AB</a></li></ul></li></ul>

<h3 id="ide525d8">4. コスト計算</h3>

<p class="paragraph">
今回は全てAsia Pacific/Tokyoリージョンに作成した。
<br />
まずEBSから：
<br />
</p>
<pre>$0.12 設定されたストレージについて、$/GB/月
=&gt;
100GB + AMI 8GB = 108GB * $0.12 = $12.96
</pre>
<p class="paragraph">
続いてインスタンスの使用量。
<br />
</p>
<pre>$0.40 /時 (ラージ)
=&gt; 月の日曜日、半日(12hour)ほど弄る＋その他の平日に業務で利用する可能性
=&gt; 12hour * 5dayとして、60hour /month
=&gt; 60 * 0.40 = $24.00
</pre>
<p class="paragraph">
合計して、
<br />
</p>
<pre>$12.96 (ESB) + $24.00 (インスタンス) = $36.96 /month
</pre>
<p class="paragraph">
日本円だと今日のレートではおよそ
<br />
</p>
<pre>2,867円
</pre>

<p class="paragraph">
実際のところ、スペックを度外視すれば3,000円前後のこの価格帯であれば他にもクラウドサービスあるいはVPSの候補は存在する。
<br />
</p>
<ul><li> 料金　｜　GMOクラウド Public<ul><li> <a class="externallink" href="http://www.gmocloud.com/price/" target="_blank">http://www.gmocloud.com/price/</a></li></ul></li>
<li> サービス仕様・料金｜IaaS型パブリッククラウド「さくらのクラウド」<ul><li> <a class="externallink" href="http://cloud.sakura.ad.jp/specification.php" target="_blank">http://cloud.sakura.ad.jp/specification.php</a></li></ul></li>
<li> 料金・機能一覧 | カゴヤ・クラウド/VPS<ul><li> <a class="externallink" href="http://www.kagoya.jp/cloud/vps/plan.html" target="_blank">http://www.kagoya.jp/cloud/vps/plan.html</a><ul><li> これなどは、Ubuntu 10.04 64bitがサポートされていながら1GBメモリ,100GBHDDで月額1,680とAWSより安価となっている</li></ul></li></ul></li>
<li> VPSサービスのご案内 | さくらインターネット<ul><li> <a class="externallink" href="http://vps.sakura.ad.jp/lp/?gclid=CIe2ntLGmK4CFWNKpgodw3MpKQ" target="_blank">http://vps.sakura.ad.jp/lp/?gclid=CIe2ntLGmK4CFWNKpgodw3MpKQ</a></li></ul></li>
<li> VPS：料金一覧 | VPSなら お名前.com<ul><li> <a class="externallink" href="http://www.onamae-server.com/vps/price/" target="_blank">http://www.onamae-server.com/vps/price/</a></li></ul></li>
<li> クラウド 料金 | ニフティクラウド<ul><li> <a class="externallink" href="http://cloud.nifty.com/price/" target="_blank">http://cloud.nifty.com/price/</a></li></ul></li></ul>

<p class="paragraph">
今回のAWSの構成だと明らかにカゴヤ・クラウドに負ける。しかし、最終的に、2.3.6_r1と4.0.3_r1のソースツリーをmirrorから展開＋milkodeに追加して33GBほど消費したので、EBSボリュームについては50GBに抑え、さらにrepo syncやソースのビルド時のみラージモデルを使用し、検索するだけであればマイクロインスタンスあるいはスモールモデルを使うように出来れば（あくまでも出来れば、の話）、
<br />
</p>
<pre>ESB: 58GB =&gt; $6.96
マイクロインスタンス: 60hour * $0.027 =&gt; $1.62
合計：$8.58 =&gt; 約665.7円
</pre>
<p class="paragraph">
となり圧勝となる。
<br />
</p>

<p class="paragraph">
とはいえ、あくまでも検索だけの用途でマイクロインスタンスが利用できた場合の計算となる。メモリの使用量の都合で、検索だけでもラージモデルが必要となり、100GBをフルに使うとなるといよいよカゴヤ・クラウドが選択肢に上がる。
<br />
それ以外は全般的に実験用途としては価格・サービス内容共にオーバースペックとなっているため選択肢に入れることができない状況。
<br />
</p>

<p class="paragraph">
・・・まぁ、今回は単純にAmazon EC2弄ってみたかっただけなので。(^_^;)
<br />
さすがに32bitOSホスト上のVMwareからは限界を感じましたもので。64bitにしようかな。メモリ自体は4GB積んでるのに、使いきれてない・・・。<br />
</p>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/1061<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2007 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>