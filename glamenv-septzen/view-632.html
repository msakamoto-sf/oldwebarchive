<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>技術/歴史/DOS時代のメモリ管理(EMS,XMS周辺) - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">技術/歴史/DOS時代のメモリ管理(EMS,XMS周辺)</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2010-04-02 11:21:43 &nbsp; / &nbsp; last updated at: 2010-04-05 13:14:24<br>
カテゴリ: <a href="category-48.html">Assembler</a>&nbsp;<a href="category-8.html">Windows</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-631.html" title="技術/歴史/DOS時代,Windows初期のCPUとPC">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-639.html" title="技術/歴史/FAQ/DOS/Vって結局OSの名前？規格の名前？">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-23.html" title="技術">技術</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
DOS時代、およびWindows3.x, 9x時代くらいまでのメモリ管理技術、特にEMSとXMS周辺のまとめメモです。
<br />
</p>
<pre>HMA, UMA, UMB, EMB, EMM, EMS, EMM386.{SYS|EXE}, QEMM, CEMM, XMS, HIMEM.SYS, LOADHIGH
</pre>
<p class="paragraph">
これらの略語について、簡単に解説＋まとめています。
<br />
</p>



<ul><li><a href="#id93a31e">MS-DOSおよびWindows3.x, 9x時代までのメモリマップ：</a><ul><li><a href="#id836b45">メモリマップ中の用語解説（上のメモリマップで&quot; <span class="plugin_pre_inline">*</span> &quot;付で解説した項目については解説省略）</a></li>
<li><a href="#id0bf436">DOS extender (DOSエクステンダ)</a></li>
<li><a href="#id39070e">Terminate and Stay Resident (TSR)</a></li></ul></li>
<li><a href="#id0afd5e">Expanded Memory (EMM, EMS, EMM386.SYS|EXE, QEMM, CEMM)</a><ul><li><a href="#id1c3fef">専用メモリカードによるハードウェアタイプ</a></li>
<li><a href="#id2cadf3">プロテクトモードを利用したソフトウェアエミュレーションタイプ</a></li>
<li><a href="#id16d2bf">EMM/EMSの簡単な歴史</a></li>
<li><a href="#id6a5bfc">EMM386.SYS と EMM386.EXE の違い</a></li></ul></li>
<li><a href="#id775456">eXtended Memory (HMA, UMA, UMB, EMB, XMS)</a><ul><li><a href="#idc67aca">A20ライン</a></li>
<li><a href="#id87e3f5">HIMEM.SYSやEMM386.EXE、DOSをHMAにロードする為のCONFIG.SYSサンプル</a></li></ul></li>
<li><a href="#iddf5560">参考資料</a><ul><li><a href="#id5b516b">Wikipediaショートカット</a></li></ul></li></ul>
<hr />
<h3 id="id93a31e">MS-DOSおよびWindows3.x, 9x時代までのメモリマップ：</h3>

<pre class="plugin_pre">
+--------------------------------+ 32M(max)
|                                |
| expanded memory board          +----------------------------------------+
|                                |                                        |
+--------------------------------+ 0                                      |
                                                                          |
+--------------------------------+                                        |
|                                |                                        |
| build-in memory                |                                        |
|                                |                                        |
+--------------------------------+ nM(*1)                                 |
|                                |                                        |
| eXtended Memory (1M - nM)(*1)  |                                        |
|                                |                                        |
|  +-----------------------------+ 10FFEFh(=FFFF:FFFFh)                   |
|  | High Memory Area            |                                        |
|  | (= 10000h - 10FFEFh)        | (FFEFh = 64K - 16(Fh))                 |
|  | (= FFFF:0010h - FFFF:FFFFh) |                                        |
+--+-----------------------------+ 1M = 1024K = 100000h(=FFFF:0010h)      |
|  | Bios Program Area           | (*2)                                   |
|  +-----------------------------+ 1016K = FE000h                         |
|  | Read Only Memory            | (*2)                                   |
|  +-----------------------------+ 960K = F0000h                          |
|                                |                                        |
| Upper Memory Area (640K - 1M)  |                                        |
|                                |                                        |
|  +-----------------------------+ (??)                                   |
|  | expanded memory page frame  | (64K) &lt;--------------------------------+
|  +-----------------------------+ (??)
|                                |
|  +-----------------------------+ (?)
|  | Disk Adapter                | (*2)
|  +-----------------------------+ 800K = C8000h
|                                |
|  +-----------------------------+ 752K(-1b) = BBFFFh
|  | Color Display Buffer        | (16K)(*2)
|  +-----------------------------+ 736K = B8000h
|                                |
|  +-----------------------------+ 708K(-1b) = B0FFFh
|  | Monochrome Display Buffer   | (4K)(*2)
|  +-----------------------------+ 704K = B0000h
|                                |
+--+-----------------------------+ 640K = A0000h
|  | extended BIOS data area     | (*3)
|  +-----------------------------+ 639K = 9FC00h
|                                |
| Conventional Memory (0 - 640K) |
|                                |
+--------------------------------+ 0

+--------------------------------+
|                                |
| IBM expanded memory adapter    |
|       (XMA)                    |
+--------------------------------+

*1 : &quot;nM&quot; = 16MB on 80286, 4GB on 80386/i486
*2 : &quot;IBM Personal Computer Technical Reference manual&quot;(IBM PC 5150)掲載
*3 : MS-KB37242掲載
</pre>

<h4 id="id836b45">メモリマップ中の用語解説（上のメモリマップで&quot; <span class="plugin_pre_inline">*</span> &quot;付で解説した項目については解説省略）</h4>

<dl>
<dt> Conventional Memory (コンベンショナル・メモリ)</dt>
<dd>
<p class="paragraph">
8086/8088のアドレスバス20bitによる制限(1MB)および、IBM PC 5150を発祥とするIBM PC互換機のメモリ配置により、OSやユーザープログラムが利用可能な640KBのメモリ領域。ただし、アドレス0番地 - 3FFh番地までは割り込みベクタとして予約されているのに加え、搭載されている物理RAM容量の制限も加わり実際に利用可能な領域は640KBよりさらに少なくなる場合もある。
<br />
事実、IBM PC 5150の最小メモリモデルは16KBしか搭載されていない。640KB以上の領域にディスプレイやROM BIOSが配置されているのは、MMU(メモリ管理ユニット)など電子回路のレベルで調整されている。
<br />
</p></dd>
<dt> Upper Memory Area (UMA) </dt>
<dd>
<p class="paragraph">
640KB - 1MBの領域。正確にはアドレスバス20bitにおける、A0000h以上 - FFFFFh以下の領域。
<br />
ビデオアダプタやデバイスドライバなどのバッファ領域、およびFFFFFh近辺にはROM BIOSが配置されている。
<br />
アドレスの後ろ(高位)にROM BIOSが配置されるのは、x86系ではCPUのリセット後に最初に命令がフェッチされるアドレスがアドレスの最大値近辺に設定されている為である。（CS:F000h, IP:FFF0h, 物理アドレスはFFFF0hになり、80286以降は残りのアドレスバスもCPUリセット後は全てのbitが1になっている。）
<br />
</p>

<p class="paragraph">
384KBの全領域が隙間無く埋まっているわけではない。後述のEMSは、所々に空いている&quot;穴&quot;を使って実現している。
<br />
</p></dd>
<dt> build-in memory </dt>
<dd>
<p class="paragraph">
Compaqなど一部のOEM製品ではマザーボード上に1MBのRAMを搭載するようになった。その場合、640KBまではConventional Memoryとして使われるが残りの384KBを(電子回路レベルで)1MBより上の領域にずらすようになっていた。
<br />
というのは、UMA領域は既にROM BIOSや各種バッファ領域で使われていたからである。
<br />
HIMEM.SYSなどは、もし利用可能であれば extended memory block に含めるようになっていた。あるいは、extended memoryの最初の384KBとして使われるようになっていた。
<br />
</p></dd>
<dt> Expanded Memory {Board|Page Frame} </dt>
<dd>
<p class="paragraph">
初期のIBM PCおよびその互換機では、バンク切り替え機能を持つ専用メモリカードを拡張バスに接続し、メモリ増設に対処していた。
<br />
このメモリ領域は &quot;Expanded Memory&quot; と呼ばれ、このメモリ領域を管理するのが &quot;Expanded Memory Manager&quot;(EMM)である。
<br />
またその仕様をまとめ上げたのが &quot;Expanded Memory Specification&quot;(EMS) である。
<br />
EMSでは16KB単位でバンク切り替えを行い、これをページと呼んだ。4ページ=64KBを連続して割り当てた領域をページフレームと呼んだ。
<br />
各種操作はEMMにより隠蔽され、ユーザープログラムは気にする必要がない。サポートされるメモリ総量は32MB(=2048ページ)まで。
<br />
</p>

<p class="paragraph">
ページフレームは、Conventional Memory領域ではなく UMA領域に設定するのが殆どである。ただしその場合、ROM BIOSやビデオ・デバイスドライババッファ領域と衝突しないよう調整する必要があった。
<br />
</p></dd>
<dt> High Memory Area (HMA) </dt>
<dd>
<p class="paragraph">
後述する &quot;eXtended Memory&quot; に含まれるアドレス領域の一部がHMAである。具体的には 100000h - 10FFEFh までの 64KB(-16byte) の領域となる。なぜこのような中途半端な領域に設定されたのかというと、80286のアドレスバスが24bitに拡張されたことが影響している。
<br />
</p>

<p class="paragraph">
8086/8088/80186/80188まではアドレスバスが20bitだったので、「セグメント：オフセット」方式で指定出来る物理アドレスは
<br />
</p>
<pre>FFFFFh
</pre>
<p class="paragraph">
までが最大だった。これは例えば
<br />
</p>
<pre>FFFFh:FFFFh
</pre>
<p class="paragraph">
と指定しても、繰り上がって20bitを超えた分は無視されてしまうことを意味する。
<br />
</p>

<p class="paragraph">
80286になりアドレスバスが24bitになったおかげで、
<br />
</p>
<pre>FFFFh:FFFFh → 10FFEFh
</pre>
<p class="paragraph">
にもアクセス可能となった。これは実際には80286のバグだったが、有効利用出来るので残された。これによりアクセス出来る範囲は、
<br />
</p>
<pre>FFFFh:0010h - FFFFh:FFFFh
</pre>
<p class="paragraph">
までとなり、サイズは丁度 64KB - 16Byte となる。
<br />
もちろん、これは物理RAMが1MB以上搭載されている場合でなおかつ80286以上のCPUが搭載されている場合だけ利用可能となる。
<br />
</p></dd>
<dt> eXtended Memory </dt>
<dd>
<p class="paragraph">
物理RAMが1MB以上搭載されている場合で、なおかつ80286以上のCPUが搭載されている場合に利用出来る、1MB以降のメモリ空間。
<br />
この領域には、286以降のプロテクトモードを利用しないとアクセス出来ない。(プロテクトモードが提供するセグメントディスクリプタを用いたセグメント・オフセット指定を行う必要がある。)
<br />
</p></dd>
<dt> IBM expanded memory adapter (XMA) </dt>
<dd>
<p class="paragraph">
IBMによる独立したメモリアダプタと、ソフトウェアドライバによりアクセス出来るメモリ領域。EMSやXMSとは特に関わってこない。
<br />
</p></dd>
</dl>

<p class="paragraph">
MS-DOSおよびWindows3.1の時代までのメモリ管理およびその用語は、大きく二つのメモリ管理方式に分類される。
<br />
</p>
<ol><li> 増設メモリカードによる &quot;Expanded Memory&quot; をバンク切り替え方式で活用する方式。</li>
<li> 1MBを超えるRAM領域、&quot;eXtended Memory&quot; を活用する方式。</li></ol>

<p class="paragraph">
HMA, UMA, UMB, EMB, EMM, EMS, EMM386.{SYS|EXE}, QEMM, CEMM, XMS, HIMEM.SYS, LOADHIGH などの略語が多いが、上記二つの方式に分類し、歴史の流れを簡単に追っていく。
<br />
</p>

<p class="paragraph">
その前に、メモリ管理方式に影響を与えた二つの技術要素 &quot;DOS extender&quot; と &quot;Terminate and Stay Resident&quot;(TSR) について簡単にまとめ、予備知識としておく。
<br />
</p>

<h4 id="id0bf436">DOS extender (DOSエクステンダ)</h4>

<p class="paragraph">
MS-DOSは基本的にx86のリアルモードで動作するOSである。従って、80286以降のCPUを搭載したとしても、OS自身はx86のプロテクトモードの仕組みを活用出来ない。
<br />
ユーザープログラム側でプロテクトモードの機能を利用する為の拡張用ソフトウェア、それが &quot;DOS extender&quot; と呼ばれるソフトウェア群である。 &quot;DOS extender&quot; は特定のソフトウェアを指すのではなく、x86プロテクトモードの機能をユーザープログラムが利用する為のデバイスドライバなど特殊なソフトウェア全般を指す。ここでは取りあげないが、VCPIやDPMIも含まれる。
<br />
</p>

<p class="paragraph">
注意したいのは、<strong>1MB以上のメモリを活用する為のソフトウェアの一部も</strong>DOS extenderに分類される点である。
<br />
というのは、アドレスバス24bitの80286であっても、実際に1MBを越える領域にアクセスするにはプロテクトモードを有効にし、セグメントディスクリプタを使ってセグメント：オフセット指定をしなければならないためである。
<br />
</p>

<p class="paragraph">
これから紹介する &quot;eXtended Memory&quot; を活用するソフトウェアは全て、DOS extenderに属することになる。
<br />
また、 &quot;Expanded Memory&quot; を活用するソフトウェアの一部も、x86のプロテクトモードを活用する為、DOS extenderに属する。
<br />
</p>

<p class="paragraph">
さらにWindows95/98/Meも、DOS上で起動してプロテクトモードを利用するという意味では DOS extender に分類することが出来る。
<br />
</p>

<p class="paragraph">
DOS extenderは、それを使うユーザープログラムから見ればプロテクトモードのOS(およびOSの提供するサービス)として存在し、リアルモードで動作するDOSから見れば一つのDOSアプリケーションとして見える。一種の疑似OS、仮想環境とも呼べるものんだった。
<br />
</p>
<pre class="plugin_pre">
+--------------------+     +--------------+     +----------------+
| アプリケーション   |----&gt;| DOS extender |----&gt;| DOS            |
| (プロテクトモード) |&lt;----|              |&lt;----| (リアルモード) |
+--------------------+     +--------------+     +----------------+
</pre>

<p class="paragraph">
DOS extender は Phar Lap社の &quot;286|DOS Extender&quot;, &quot;386|DOS Extender&quot; から始まり、様々なベンダーから発表された。また、Tenberry Software の &quot;DOS/4GW&quot; はPCゲームの世界で広まり、&quot;DOOM&quot;で採用された事で有名になった。
<br />
各社から様々に提供されたDOS extenderであるが、共通仕様としてVCPIを経てDPMIに収斂していく。その流れについては本記事では割愛する。
<br />
</p>

<h4 id="id39070e">Terminate and Stay Resident (TSR)</h4>

<p class="paragraph">
DOSは基本的にシングルタスクのOSであり、ユーザープログラムは終了時にINT 21H/4CHを呼ぶことでDOSのシェル(COMMAND.COM)に制御を戻す。しかし、終了時にINT 27H or INT 21H/31Hを呼ぶと、ユーザープログラムのロードされたアドレスが解放されないままCOMMAND.COMに戻ることが出来る。つまり、プログラムの実行イメージがメモリ上に残り、他のプログラムによって壊されない状態になる。
<br />
</p>

<p class="paragraph">
INT 27H は &quot;Terminate But Stay Resident&quot; と呼ばれる為、この機能を使うプログラム群を &quot;TSR&quot; と呼んだ。INT 27Hではプログラムのセグメント64KBをそっくりそのままメモリに残すことが出来る。MS-DOS 2.0で導入された INT 21H/31H (&quot;Kepp Process&quot;) はメモリ制限が無くなると共に、プログラムがexitコードを返せるようにした。
<br />
</p>

<p class="paragraph">
「メモリ上にプログラムを残せる」、この効果をTSRプログラム群がどのように活用したかというと、割り込みベクタを上書きして自身の割り込みハンドラを指すようにした。これにより、キーが押されたなどの割り込みイベントに応じて、自身のプログラムを実行することが出来た。
<br />
これを活用して擬似的なマルチタスクであったり、独自のデバイスドライバ、スケジューリング機能などのユーティリティプログラムが開発された。
<br />
</p>

<p class="paragraph">
TSRは技術的には「OSのハイジャック」と同義であり、コンピュータウィルスにより悪用されたり、複数のTSR間での衝突や相性問題を引き起こすこともあった。
<br />
Windows95以降の、マルチタスクが前提のOSが広まるにつれ、TSRは次第に衰退していった。
<br />
</p>

<p class="paragraph">
本記事ではDOSから初期Windows時代までのメモリ管理について焦点をあてているが、TSRもそれに少なからず影響を与えている。
<br />
通常はTSRはコンベンショナルメモリに配置されてしまう。コンベンショナルメモリを少しでも空ける為、TSRをUMAに配置出来るようにしたものが&quot;LOADHIGH&quot;コマンドであるといえる。
<br />
</p>

<h3 id="id0afd5e">Expanded Memory (EMM, EMS, EMM386.SYS|EXE, QEMM, CEMM)</h3>

<p class="paragraph">
上でも説明したが、バンク切り替え機能を持つ専用メモリカードを拡張バスに接続して使う。
<br />
</p>
<dl>
<dt> Expanded Memory Manager (EMM) </dt>
<dd>&quot;Expanded Memory&quot; を管理するソフトウェアのこと。</dd>
<dt> Expanded Memory Specification (EMS) </dt>
<dd>&quot;Expanded Memory&quot; を管理する為の仕様のこと。</dd>
</dl>

<p class="paragraph">
16KB(ぺージ)単位でバンク切り替えを行い、4ページ=64KBを連続して割り当てた領域がページフレーム。ページフレームはUMA上の空き領域に設定されるか、時代が下るとコンベンショナルメモリの一部に大きめのページフレームを確保する場合もあった。
<br />
</p>

<p class="paragraph">
この実装には二つのタイプがあった。一つは最も基本的な、専用メモリカードを使ってハードウェア的に実装するタイプ。もう一つは80286以降のCPUで、プロテクトモードで利用可能な1MBを超えるメモリ領域を専用メモリカードに「見立てる」ソフトウェアエミュレーションタイプ。
<br />
</p>

<h4 id="id1c3fef">専用メモリカードによるハードウェアタイプ</h4>

<p class="paragraph">
原点となる、専用メモリカードを使用したタイプ。プロテクトモードが利用出来る以前に実装された方式なので、8086/8088/80186/80188で利用出来る。バンク切り替えはハードウェア的に行われる。
<br />
</p>

<pre class="plugin_pre">
                                      +-------------------------+
                                      | Expanded Memory Board   |
                                      | (max 32MB = 2048 pages) |
                                      |     +--------+          |
                                  +--------&gt;| page N |          |
      | (...)                |    |   |     | ...    |          |
  1MB +----------------------+    |   |    +--------+|          |
      | UMA                  |    +-------&gt;| page 3 |+          |
      |                      |    |   |   +--------+|           |
      |  +-----------------+ |    +------&gt;| page 2 |+           |
      |  | expanded memory | |    |   |  +--------+|            |
      |  |   page frame    |------+-----&gt;| page 1 |+            |
      |  |      (16KB)     | |        |  | (64KB) |             |
      |  +-----------------+ |        |  +--------+             |
      |                      |        +-------------------------+
640KB +----------------------+
      | (...)                |
</pre>

<h4 id="id2cadf3">プロテクトモードを利用したソフトウェアエミュレーションタイプ</h4>

<p class="paragraph">
メインメモリが1MB以上搭載されていて、なおかつ80286以上のCPUを搭載している場合に利用可能。
<br />
プロテクトモードを利用することで1MB以上の領域の一部を専用メモリカード上のメモリ領域に「見立てて」、UMA中のページフレームにコピーする。一部には、メインメモリではなく補助記憶装置上のファイルを用いるドライバも存在し、この場合は8086/8088などリアルモードのみのCPUでも利用出来た。(HP200LX, CPUは80C186(CMOS版80186) の&quot;LXEMM&quot;はこの方式)
<br />
</p>
<pre class="plugin_pre">
      | (...)                |
      +----------------------+
      | page 2 (64KB)        |&lt;---+
      +----------------------+    |
      | (...)                |    |
      +----------------------+    |
      | page 1 (64KB)        |&lt;---+
      +----------------------+    |
      | (...)                |    |
  1MB +----------------------+    |
      | UMA                  |    |
      |                      |    |
      |  +-----------------+ |    |
      |  | expanded memory | |    |
      |  |   page frame    |------+
      |  |      (16KB)     | |
      |  +-----------------+ |
      |                      |
640KB +----------------------+
      | (...)                |
</pre>

<p class="paragraph">
このタイプのEMMは、プロテクトモードを利用している為 DOS extender に含まれる。
<br />
</p>

<p class="paragraph">
80386以降のCPUでは、仮想86モードでCPUの仮想メモリ機能を利用したEMMを実現する機能もある。MS-DOS用ソフトウェアの互換性のために、Microsoft Windows Me までこのタイプがサポートされていたらしい。
<br />
</p>

<h4 id="id16d2bf">EMM/EMSの簡単な歴史</h4>

<dl>
<dt> 1984年 - </dt>
<dd>
<p class="paragraph">
専用メモリカードを使ったハードウェアタイプの&quot;Expanded Memory&quot;が登場。&quot;Expanded Memory Manager&quot;(EMM)も各社より発表される。それぞれ専用メモリカードも併せて発売された。
<br />
</p>
<table>
	<tr>
		<td> AST </td>
		<td> remm.sys </td>
	</tr>
	<tr>
		<td> IBM </td>
		<td> ps2emm.sys </td>
	</tr>
	<tr>
		<td> AT&amp;T </td>
		<td> aemm.sys </td>
	</tr>
	<tr>
		<td> Intel </td>
		<td> emm.sys </td>
	</tr>
</table></dd>
<dt> 1987年 - </dt>
<dd>
<p class="paragraph">
80386以降のCPUで、プロテクトモードでアクセス可能な1MBoverの領域を&quot;Expanded Memory&quot;として扱うソフトウェアエミュレーションタイプのEMMが登場してくる。&quot;Compaq Expanded Memory Manager&quot;(CEMM)が Compaq DOS 3.31に搭載される。80386が必要。
<br />
</p>

<p class="paragraph">
また同年、Expanded Memoryの仕様である &quot;EMS 4.0&quot; が策定された。
<br />
これまでは Lotus, Intel, Microsoft によりまとめられた&quot;LIM EMS&quot;と呼ばれるExpanded Memoryの仕様と、ASTがまとめた&quot;Enhanced Expanded Memory Specification&quot;, EEMSの二つが存在していたが、 EMS 4.0 になり両方の内容が統合された。
<br />
</p></dd>
<dt> 1988 </dt>
<dd>
<ul><li> &quot;Quarterdeck Expanded Memory Manager&quot;(QEMM), Ver 4.2 がQuarterdeck Office Systemsによりリリース。80386が必要。</li>
<li> Windows/386(v2.1)でEMM386.SYSを提供開始。EMM386シリーズは80386の仮想86モードを使うのが特徴だった。</li></ul></dd>
<dt> 1989 </dt>
<dd>MS-DOS 4.01 で EMM386.SYSを提供開始。</dd>
<dt> 1990 </dt>
<dd>Digital Researchの DR-DOS 5.0 でEMM386相当機能を提供開始。</dd>
<dt> 1991 </dt>
<dd>MS-DOS 5.0 で EMM386.EXEを提供開始。UMA中の未使用領域をマッピングし、デバイスドライバやTSRをUMAや上位アドレスに読み込む&quot;load high&quot;機能を提供した。&quot;Upper Memory Block&quot;の登場である。</dd>
</dl>

<p class="paragraph">
ソフトウェアエミュレーションタイプは、紛れもなく 1MB を超える &quot;eXtended Memory&quot; を使う。従って、EMSは徐々にXMSに包含されていくようになる。
<br />
</p>

<h4 id="id6a5bfc">EMM386.SYS と EMM386.EXE の違い</h4>

<dl>
<dt> EMM386.SYS </dt>
<dd>1988年のWindows/386 (v2.1x) で登場。MS-DOSで登場するのは1989年のMS-DOS 4.01から。仮想86モードを使うため80386以降のCPUが必要。</dd>
<dt> EMM386.EXE </dt>
<dd>1991年のMS-DOS 5.0で登場。後述の&quot;Upper Memory Block&quot;(UMB)の未使用領域にメモリをマッピング可能で、デバイスドライバやTSRをロードし、コンベンショナルメモリを節約する。</dd>
</dl>

<p class="paragraph">
基本機能はWindows/386で実装され、&quot;.SYS&quot;で提供されたのがMS-DOS 4.xまで。より柔軟になって &quot;.EXE&quot; になったのが MS-DOS 5.x以降となる。
<br />
</p>

<p class="paragraph">
プロテクトモードで動作するWindowsとでは機能衝突も発生したらしく、下記のように、Windows3.0 Standard ModeではEMM386.SYSやEMM386.EXEを無効化するようKBが上げられている。
<br />
</p>
<ul><li> Cannot Use EMM386.SYS/EMM386.EXE in Standard Mode Windows 3.0<ul><li> <a class="externallink" href="http://support.microsoft.com/kb/82081/EN-US/" target="_blank">http://support.microsoft.com/kb/82081/EN-US/</a></li></ul></li></ul>

<p class="paragraph">
なお、とくにEMSに限って言えば、ハードウェアタイプのEMSであれば Windows/286(v2.0)でも利用可能になっていた。
<br />
</p>

<h3 id="id775456">eXtended Memory (HMA, UMA, UMB, EMB, XMS)</h3>

<p class="paragraph">
&quot;eXtended Memory&quot;、通称XMS(eXtended Memory Specification)はMS-DOSで 1MB 以降のメモリを扱う為のメモリ管理方式の一つ。
<br />
MS-DOSが「公式に」対応したのはMS-DOS 5.0からだが、それ以前にも、サードパーティ製のフリーソフトでXMSに対応することができた。XMS自身の仕様としてはMS-DOS 3.0以上を動作対象としている。
<br />
</p>

<p class="paragraph">
XMSは三つのメモリ領域の規格からなる。
<br />
</p>
<dl>
<dt> High Memory Area (HMA) </dt>
<dd>前述の通り、100000h - 10FFEFh までの64KB弱の領域を使用する。</dd>
<dt> Extended Memory Block (EMB) </dt>
<dd>10FFF0h以降のメモリ領域を使用する。XMSでは、XMSドライバによりEMB領域の内容をコンベンショナルメモリの間でブロック転送できるようになっている。リアルモードのプログラムでも、XMSのファンクションコールを使うことで、一時的にプロテクトモードになってブロック転送を利用出来た。MicrosoftのKB37242によると、EMBに実行コードを格納することは出来ず、データストレージとしてのみ利用可能だったらしい。</dd>
<dt> Upper Memory Block (UMB) </dt>
<dd>BIOS, VideoRAMなどが使用するUpper Memory Area (UMA)中の空き領域を使用する。</dd>
</dl>

<p class="paragraph">
規格のバージョンとしては、以下の3つがある。
<br />
</p>
<dl>
<dt> バージョン1 </dt>
<dd>HMAの規格だった。(発表年不明)</dd>
<dt> バージョン2 </dt>
<dd>EMBとUMBが追加される。最大64MBのEMBを確保(allocate)出来る。(1988年, Microsoft, Lotus, Intel, AST 合同)</dd>
<dt> バージョン3 </dt>
<dd>80386以降のCPUで最大4GBのEMB確保に対応。(1991年, Microsoft, Lotus, Intel, AST 合同)</dd>
</dl>

<p class="paragraph">
WindowsやDOSがXMSのサポートを開始した流れは、大雑把に次のようになる。
<br />
</p>

<ol><li> Windows/286(Windows 2.1x) : HIMEM.SYSによるHMA + EMB利用</li>
<li> DR-DOS 5.0 : EMM386.EXE</li>
<li> MS-DOS 5.0 : HIMEM.SYS + EMM386.EXE (UMB, EMS担当), 80386以降</li></ol>

<p class="paragraph">
※MS-DOS 5.0以前でも、サードパーティ製のフリーソフトでUMBを利用するタイプは存在した。
<br />
※この時代はとにかく、CONFIG.SYSやAUTOEXEC.BATを使ってUMBの空き領域の設定やEMM386のロードのオプションを調整する必要があった。
<br />
</p>

<ul><li> HIMEM.SYSはHMAを利用可能にすると共に、EMBも利用可能にした。乱暴に要約すれば、1MB越えのメモリ領域アクセスの為のデバイスドライバだった。<ul><li> FreeDOSでは&quot;HIMEM.EXE&quot;という名前になっている。</li></ul></li>
<li> DR-DOS 5.0, MS-DOS 5.0 での EMM386.EXEは、1MB超えのプロテクトモードのメモリを使ったソフトウェアエミュレーションタイプのEMMだった。</li></ul>

<h4 id="idc67aca">A20ライン</h4>

<p class="paragraph">
XMSでは1MBを超える物理メモリにアクセスする為、80286以降のCPUではA20ライン(A20ゲート)を有効化する必要があり、少なくともXMS2.0の段階でその機能は盛りこまれていた。
<br />
</p>

<p class="paragraph">
80286搭載のIBM PC ATが起源となる&quot;A20ライン&quot;(A20ゲート)については、 <a href="./view-634.html" >技術/歴史/&quot;WindowsOS内部のアーキテクチャのすべて&quot;読書メモ/4章</a> の &quot;メモ：&quot;A20ライン&quot;&quot; を参照。
<br />
</p>

<h4 id="id87e3f5">HIMEM.SYSやEMM386.EXE、DOSをHMAにロードする為のCONFIG.SYSサンプル</h4>

<p class="paragraph">
まずHIMEM.SYSを &quot;DEVICE&quot; でコンベンショナルメモリにロードする。
<br />
</p>
<pre>device=c:\dos\himem.sys
</pre>
<p class="paragraph">
→これでXMSによりHMAおよびEMBが使用可能になる。
<br />
</p>

<p class="paragraph">
続いてEMM386.EXEをコンベンショナルメモリにロードし、EMSとUMBに対応する。
<br />
</p>
<pre>device=c:\dos\emm386.exe umb
</pre>

<p class="paragraph">
なお他のデバイスドライバをEMBにロードするのであれば
<br />
</p>
<pre>DEVICEHIGH=foobar.sys
</pre>
<p class="paragraph">
とする。
<br />
コマンドプロンプトやAUTOEXEC.BAT中からプログラムをUMBにロードするには、&quot;LOADHIGH&quot;(&quot;LH&quot;)コマンドを利用出来る。TSRで使われた。
<br />
</p>

<p class="paragraph">
DOSカーネルをHMAにロードするには
<br />
</p>
<pre>dos=high
</pre>
<p class="paragraph">
をconfig.sysで指定する。デフォルトではコンベンショナルメモリにロードされる。
<br />
DOSカーネルにUMBも管理させるのであれば、
<br />
</p>
<pre>DOS=HIGH,UMB
</pre>
<p class="paragraph">
としてUMBオプションを付ける。
<br />
</p>

<h3 id="iddf5560">参考資料</h3>

<ul><li> &quot;IBM Personal Computer Technical Reference manual&quot;</li>
<li> Overview of Memory-Management Functionality in MS-DOS<ul><li> <a class="externallink" href="http://support.microsoft.com/kb/95555/EN-US/" target="_blank">http://support.microsoft.com/kb/95555/EN-US/</a></li></ul></li>
<li> A General Tutorial on the Various Forms of Memory<ul><li> <a class="externallink" href="http://support.microsoft.com/kb/37242/EN-US/" target="_blank">http://support.microsoft.com/kb/37242/EN-US/</a></li></ul></li>
<li> FreeDOS : DOS Extender<ul><li> <a class="externallink" href="http://wiki.fdos.org/Main/DOSExtender" target="_blank">http://wiki.fdos.org/Main/DOSExtender</a></li></ul></li>
<li> Lloyd Borrett - Computing - Articles - Understanding EMS 4.0<ul><li> <a class="externallink" href="http://www.borrett.id.au/computing/art-1989-01-02.htm" target="_blank">http://www.borrett.id.au/computing/art-1989-01-02.htm</a></li></ul></li>
<li> DOS Loadhigh: Information from Answers.com<ul><li> <a class="externallink" href="http://www.answers.com/topic/dos-loadhigh" target="_blank">http://www.answers.com/topic/dos-loadhigh</a></li></ul></li>
<li> W98:README：MS-DOS CONFIG.SYS コマンド<ul><li> <a class="externallink" href="http://support.microsoft.com/kb/412281/ja" target="_blank">http://support.microsoft.com/kb/412281/ja</a></li></ul></li></ul>

<h4 id="id5b516b">Wikipediaショートカット</h4>

<ul><li> コンベンショナルメモリ<ul><li> <a class="externallink" href="http://en.wikipedia.org/wiki/Conventional_memory" target="_blank">http://en.wikipedia.org/wiki/Conventional_memory</a></li></ul></li>
<li> EMS(Expanded Memory Specification), EMM386<ul><li> <a class="externallink" href="http://ja.wikipedia.org/wiki/Expanded_Memory_Specification" target="_blank">http://ja.wikipedia.org/wiki/Expanded_Memory_Specification</a></li>
<li> <a class="externallink" href="http://en.wikipedia.org/wiki/Expanded_memory" target="_blank">http://en.wikipedia.org/wiki/Expanded_memory</a></li>
<li> <a class="externallink" href="http://ja.wikipedia.org/wiki/%E3%83%90%E3%83%B3%E3%82%AF%E5%88%87%E3%82%8A%E6%8F%9B%E3%81%88" target="_blank">http://ja.wikipedia.org/wiki/%E3%83%90%E3%83%B3%E3%82%AF%E5%88%87%E3%82%8A%E6%8F%9B%E3%81%88</a></li>
<li> <a class="externallink" href="http://ja.wikipedia.org/wiki/EMM386" target="_blank">http://ja.wikipedia.org/wiki/EMM386</a></li>
<li> <a class="externallink" href="http://en.wikipedia.org/wiki/EMM386" target="_blank">http://en.wikipedia.org/wiki/EMM386</a></li></ul></li>
<li> XMS : eXtended Memory Specification<ul><li> <a class="externallink" href="http://ja.wikipedia.org/wiki/XMS" target="_blank">http://ja.wikipedia.org/wiki/XMS</a></li>
<li> <a class="externallink" href="http://ja.wikipedia.org/wiki/Upper_Memory_Area" target="_blank">http://ja.wikipedia.org/wiki/Upper_Memory_Area</a></li>
<li> <a class="externallink" href="http://ja.wikipedia.org/wiki/Upper_Memory_Block" target="_blank">http://ja.wikipedia.org/wiki/Upper_Memory_Block</a></li>
<li> <a class="externallink" href="http://en.wikipedia.org/wiki/EXtended_Memory_Specification" target="_blank">http://en.wikipedia.org/wiki/EXtended_Memory_Specification</a></li>
<li> <a class="externallink" href="http://en.wikipedia.org/wiki/High_Memory_Area" target="_blank">http://en.wikipedia.org/wiki/High_Memory_Area</a></li>
<li> <a class="externallink" href="http://en.wikipedia.org/wiki/Upper_Memory_Area" target="_blank">http://en.wikipedia.org/wiki/Upper_Memory_Area</a></li></ul></li>
<li> HIMEM.SYS<ul><li> <a class="externallink" href="http://en.wikipedia.org/wiki/HIMEM.SYS" target="_blank">http://en.wikipedia.org/wiki/HIMEM.SYS</a></li></ul></li>
<li> CONFIG.SYS<ul><li> <a class="externallink" href="http://en.wikipedia.org/wiki/CONFIG.SYS" target="_blank">http://en.wikipedia.org/wiki/CONFIG.SYS</a></li>
<li> <a class="externallink" href="http://ja.wikipedia.org/wiki/CONFIG.SYS" target="_blank">http://ja.wikipedia.org/wiki/CONFIG.SYS</a></li></ul></li>
<li> loadhigh<ul><li> <a class="externallink" href="http://en.wikipedia.org/wiki/Loadhigh" target="_blank">http://en.wikipedia.org/wiki/Loadhigh</a></li></ul></li>
<li> DOS extender<ul><li> <a class="externallink" href="http://ja.wikipedia.org/wiki/DOS%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%86%E3%83%B3%E3%83%80%E3%83%BC" target="_blank">http://ja.wikipedia.org/wiki/DOS%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%86%E3%83%B3%E3%83%80%E3%83%BC</a></li>
<li> <a class="externallink" href="http://en.wikipedia.org/wiki/DOS_extender" target="_blank">http://en.wikipedia.org/wiki/DOS_extender</a></li></ul></li>
<li> Terminate and Stay Resident (TSR)<ul><li> <a class="externallink" href="http://ja.wikipedia.org/wiki/Terminate_and_Stay_Resident" target="_blank">http://ja.wikipedia.org/wiki/Terminate_and_Stay_Resident</a></li>
<li> <a class="externallink" href="http://en.wikipedia.org/wiki/Terminate_and_Stay_Resident" target="_blank">http://en.wikipedia.org/wiki/Terminate_and_Stay_Resident</a></li></ul></li></ul>

<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-631.html" title="技術/歴史/DOS時代,Windows初期のCPUとPC">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-639.html" title="技術/歴史/FAQ/DOS/Vって結局OSの名前？規格の名前？">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-641.html" title="技術/歴史">Up</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-23.html" title="技術">技術</a>&nbsp;]</li>
</ul>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/632<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2007 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>