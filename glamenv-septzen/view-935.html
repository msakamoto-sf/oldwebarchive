<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Python/WinDBG拡張機能でデバッガを作ってみる - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">Python/WinDBG拡張機能でデバッガを作ってみる</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2011-03-23 18:31:58 &nbsp; / &nbsp; last updated at: 2011-04-02 16:20:06<br>
カテゴリ: <a href="category-28.html">Python</a>&nbsp;<a href="category-57.html">WinDBG</a>&nbsp;<a href="category-8.html">Windows</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-939.html" title="Python/WinDBG拡張機能その２：pykdを使ってみる">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-932.html" title="Python/codepiece/threading, event, console, Ctrl-C">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-184.html" title="Python">Python</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
&quot;Debugging Tools for Windows&quot;の提供する拡張機能をPythonから呼び出せるPyDbgEngを使って、Pythonで簡単なデバッガを作ってみました。
<br />
</p>



<ul><li><a href="#id96f6e4">はじめに</a></li>
<li><a href="#idf70d9b">comtypes, PyDbgEng のインストール</a><ul><li><a href="#ida4a9d9">comtypes のインストール</a></li>
<li><a href="#id8c22c2">PyDbgEng のインストール</a></li></ul></li>
<li><a href="#ide04d75">デバッガを作ってみる</a></li>
<li><a href="#id221b52">01_nothing.py : 何もしないデバッガ</a></li>
<li><a href="#id958eb4">02_mon_events.py : {CREATE|EXIT</a>_{PROCESS|THREAD},{LOAD|UNLOAD}_MODULEイベント}</li>
<li><a href="#id30afbc">03_initial_break.py : デバッガの初期イベントと例外イベントハンドラ</a></li>
<li><a href="#id348cfe">main()関数でブレークしてみる</a><ul><li><a href="#id1bf255">04_break_at_main1.py : ブレークポイントイベントを拾う</a></li>
<li><a href="#idf926d2">04_break_at_main2.py : ブレークしたときのスタックトレースとレジスタを表示してみる</a></li>
<li><a href="#ida42b39">04_break_at_main3.py : デバッガコマンドを実行してみる</a></li></ul></li>
<li><a href="#idc5a20f">対話形式のデバッガを作成してみる</a><ul><li><a href="#id1aaa56">05_interact1.py : 簡単な対話形式</a></li>
<li><a href="#idc15ca6">05_interact2.py : 任意のタイミングでデバッガにブレークさせる</a></li></ul></li>
<li><a href="#id19be54">まとめ</a></li></ul>
<hr />
<h3 id="id96f6e4">はじめに</h3>

<p class="paragraph">
PythonでWindowsネイティブアプリケーションのデバッガを作成するための基本方針は、 ctypes モジュールを使ってWin32APIの提供するデバッガ用APIやメモリ操作APIを活用します。それら基本的な使用方法をまとめたライブラリとして pydbg などが公開されており、 <a href="./view-825.html" >Python/Gray Hat Python 読書メモ</a> で紹介した &quot;Gray Hat Python&quot; でも解説されています。
<br />
ただしこれらのライブラリは x86/32bit 用となっている場合が多く、64bitに対応している状況ではありません。
<br />
</p>

<p class="paragraph">
一方でMicrosoftから無償で提供されているネイティブデバッガ &quot;Debugging Tools for Windows&quot; は32bit/64bit両対応で、リモートデバッグやカーネルデバッグにも対応しています。デバッガとしてもCUIベースのCDBとNTSD, GUIベースのWinDBGを備えています。またコア部分が拡張機能として公開されているため、独自のデバッグコマンドをプラグインとして開発したり、デバッガプログラムそれ自体さえも独自に開発することが可能です。
<br />
</p>

<p class="paragraph">
以降、&quot;Debugging Tools for Windows&quot;を単にWinDBGと略称します。
<br />
</p>

<p class="paragraph">
拡張機能はDLLとして提供されています。PythonのctypesモジュールはDLLで公開されている関数を呼び出すことが出来ますので、ctypes経由で拡張機能を呼び出すことでPythonでWinDBGと同等、つまり64bitやカーネルデバッグに対応したデバッガを作れそうです。
<br />
</p>

<p class="paragraph">
しかし拡張機能、特にデバッガそれ自体を開発するためのコア機能はCOMコンポーネントとして提供されているため、ctypes経由で呼び出すことが煩雑で困難です。
<br />
この問題を解決するのが今回紹介するオープンソースのライブラリ、 PyDbgEng です。
<br />
PyDbgEngはPythonのみで作られたライブラリで、comtypesという同じくPythonのみで作られたCOMラッパライブラリを経由する事でWinDBGのコア拡張機能であるCOMコンポーネントを活用しています。
<br />
comtypesは内部的にはctypesを使っており、COMを利用するための煩雑な手順を隠蔽してくれます。
<br />
</p>

<p class="paragraph">
本記事では comtypes , PyDbgEng のインストールの解説と、PyDbgEngを使った簡単なデバッガの作り方を紹介します。
<br />
</p>

<h3 id="idf70d9b">comtypes, PyDbgEng のインストール</h3>

<p class="paragraph">
comtypes, PyDbgEngの順にインストール手順を紹介します。
<br />
その他に必要なツールとして以下を事前にインストールしておいてください。
<br />
</p>
<ul><li> Python : multiprocessingモジュールを使用しているため、<strong>Python 2.6 以降</strong>が必要です。</li>
<li> Debugging Tools for Windows<ul><li> MSDNのサイトから入手できます。</li></ul></li>
<li> MIDL.exe, NMAKE.exe<ul><li> Visual C++, Windows SDK, Windows Driver Kit のいずれかに入っていますのでインストールしておいてください。WinSDK, WDKには&quot;Debugging Tools for Windows&quot;も同梱されていますので、いずれか片方を入れておくと便利です。</li></ul></li>
<li> Perl<ul><li> Windows用のActivePerl ( <a class="externallink" href="http://www.activestate.com/activeperl" target="_blank">http://www.activestate.com/activeperl</a> ) を使いました。PyDbgEngでWinDBGの拡張機能用ヘッダファイルからCOMが使うIDLを生成するスクリプトで必要です。</li></ul></li></ul>

<p class="paragraph">
本記事で検証した環境：
<br />
</p>
<pre>Windows XP/SP3(32bit), Windows 7/SP1(32bit)
Visual C++ 2010 Express Edition
Microsoft Windows SDK v 7.0
Windows Driver Kit 7600.16385.1
Debugging Tools for Windows v 6.12 : SDKオプション付きでインストールします。
   WDKと同時にインストールした場合はSDKも入ります。
Python 2.7
comtypes-0.6.2
PyDbgEng-0.14
ActivePerl 5.12.x
</pre>

<p class="paragraph">
Perl, Python には予めPATHを通しておきます。
<br />
</p>

<h4 id="ida4a9d9">comtypes のインストール</h4>

<ul><li> comtypes<ul><li> <a class="externallink" href="http://sourceforge.net/projects/comtypes/" target="_blank">http://sourceforge.net/projects/comtypes/</a></li></ul></li></ul>

<p class="paragraph">
setup.pyでインストール出来ます。
<br />
</p>
<pre>setup.py build
setup.py install
</pre>

<p class="paragraph">
Python 2.7 でのインストール時に &quot;ImportError: cannot import name DistutilsOptionError&quot; 発生する場合は次の記事を参照してください：
<br />
</p>
<ul><li> SourceForge.net: comtypes: Detail: 3036368 - ImportError DistutilsOptionError on Python 2.7<ul><li> <a class="externallink" href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=3036368&amp;group_id=115265&amp;atid=692940" target="_blank">http://sourceforge.net/tracker/index.php?func=detail&amp;aid=3036368&amp;group_id=115265&amp;atid=692940</a></li></ul></li></ul>

<p class="paragraph">
setup.pyを修正します：
<br />
</p>
<pre>from distutils.core import setup, Command, DistutilsOptionError
</pre>
<p class="paragraph">
→
<br />
</p>
<pre>from distutils.core import setup, Command
from distutils.errors import DistutilsOptionError
</pre>

<h4 id="id8c22c2">PyDbgEng のインストール</h4>

<ul><li> PyDbgEng<ul><li> <a class="externallink" href="http://pydbgeng.sourceforge.net/" target="_blank">http://pydbgeng.sourceforge.net/</a></li></ul></li></ul>

<p class="paragraph">
まずWinDBG拡張機能のCOMを使うためのIDLとTLBファイルを、自分の環境にあわせて作り直します。
<br />
必要なツール：
<br />
</p>
<pre>MIDL.exe, NMAKE.exe : Windows DDK や Windows SDK で提供されている。
Debugging Tools for Windows : SDK付きでインストール。
Perl : IDLを生成するためにPerlスクリプトを使っているため。
</pre>

<ol><li> WinSDKなりWDKなりのコマンドプロンプトを開き、&quot;PyDbgEng-0.14\DbgEngTlb&quot;ディレクトリに移動します。</li>
<li> &quot;out&quot;ディレクトリが既にあれば、念のためリネームするなどしてバックアップしておきます。</li>
<li> Makefileを修正します。 &quot;INPUT_HEADER = sdk\dbgeng.h&quot; を自分の環境のdbgeng.hを指すように変更します。dbgeng.hはWinDBGインストールディレクトリの &quot;sdk\inc&quot; 内にあるはずです。</li>
<li> nmakeでmakeします。</li>
<li> &quot;out&quot;ディレクトリに自分の環境でのIDLとTLBファイルが生成されます。</li>
<li> &quot;out&quot;中の body.idl, DbgEng.idl, DbgEng.tlb を &quot;PyDbgEng-0.14\PyDbgEng\data&quot; ディレクトリにコピーします。既に同じファイル名があれば、バックアップした後上書きコピーします。</li>
<li> &quot;PyDbgEng-0.14&quot;ディレクトリに移動し、&quot;setup.py&quot;でインストールする。</li></ol>

<p class="paragraph">
例：
<br />
</p>
<pre>&gt; setup.py build
&gt; setup.py install --record PyDbgEng-0.14.install-files
</pre>

<h3 id="ide04d75">デバッガを作ってみる</h3>

<p class="paragraph">
ここからPyDbgEngの機能を確認しつつ、簡単なデバッガを作っていきます。
<br />
</p>

<p class="paragraph">
なお本記事ではデバッガの内部構造であるとか実装パターン、WinDBGの拡張機能の概要や構成については触れません。予め&quot;Advanced Windows Debugging&quot;やWinDBGのヘルプドキュメントを熟読しておいて下さい。またPyDbgEngそれ自体の構成については適宜ソースコードを参照しながら掴んでいってください。それほど巨大なものでは無いので、Python提供の &quot;Module Docs&quot; などを活用して追ってみてください。
<br />
</p>
<a href="https://www.amazon.co.jp/dp/0321374460" target="_blank">Amazon | Advanced Windows Debugging | Hewardt, Mario Pravat, Daniel | Software Development</a><br>
<a href="https://www.amazon.co.jp/dp/4048676083" target="_blank">Amazon.co.jp: Windowsデバッグの極意 ツールを使いこなして、バグハント! : Mario Hewardt, Daniel Pravat, 長尾 高弘: 本</a><br>

<h3 id="id221b52">01_nothing.py : 何もしないデバッガ</h3>

<p class="paragraph">
最初にPyDbgEng関連モジュールを正常にimportでき、最低限度の動作確認として「何もしないデバッガ」を作ってみます。デバッガイベントにも反応せず、単にデバッグ対象プロセスを起動し、終わるまで待つだけです。
<br />
</p>

<p class="paragraph">
01_nothing.py :
<br />
</p>
<div class="hl-main"><pre><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">sys</span><span class="hl-code">
</span><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">
 
</span><span class="hl-comment"># dbgeng.dll, dbghelp.dllの場所を指定</span><span class="hl-code">
</span><span class="hl-identifier">DBGENG_DLL_PATH</span><span class="hl-code"> = </span><span class="hl-quotes">&quot;</span><span class="hl-string">C:</span><span class="hl-special">\\</span><span class="hl-string">WinDDK</span><span class="hl-special">\\</span><span class="hl-string">7600.16385.1</span><span class="hl-special">\\</span><span class="hl-string">Debuggers</span><span class="hl-quotes">&quot;</span><span class="hl-code">
 
</span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-number">2</span><span class="hl-code"> &gt; </span><span class="hl-builtin">len</span><span class="hl-brackets">(</span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">argv</span><span class="hl-brackets">)</span><span class="hl-code">:
  </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">usage: %s *.exe</span><span class="hl-quotes">&quot;</span><span class="hl-code"> % </span><span class="hl-brackets">(</span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-number">0</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">
  </span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-comment"># 何もしないイベントハンドラ</span><span class="hl-code">
</span><span class="hl-reserved">class</span><span class="hl-code"> </span><span class="hl-identifier">EmptyDbgEventHandler</span><span class="hl-brackets">(</span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">IDebugEventCallbacksSink</span><span class="hl-brackets">)</span><span class="hl-code">:
 
  </span><span class="hl-reserved">def</span><span class="hl-code"> </span><span class="hl-identifier">GetInterestMask</span><span class="hl-brackets">(</span><span class="hl-identifier">self</span><span class="hl-brackets">)</span><span class="hl-code">:
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">
 
</span><span class="hl-identifier">event_handler</span><span class="hl-code"> = </span><span class="hl-identifier">EmptyDbgEventHandler</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-identifier">dbg</span><span class="hl-code"> = </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">ProcessCreator</span><span class="hl-brackets">(</span><span class="hl-code"> \
    </span><span class="hl-identifier">command_line</span><span class="hl-code"> = </span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-number">1</span><span class="hl-brackets">]</span><span class="hl-code">, \
    </span><span class="hl-identifier">event_callbacks_sink</span><span class="hl-code"> = </span><span class="hl-identifier">event_handler</span><span class="hl-code">, \
    </span><span class="hl-identifier">dbg_eng_dll_path</span><span class="hl-code"> = </span><span class="hl-identifier">DBGENG_DLL_PATH</span><span class="hl-code"> \
    </span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-identifier">dbg</span><span class="hl-code">.</span><span class="hl-identifier">wait_for_event</span><span class="hl-brackets">(</span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">Defines</span><span class="hl-code">.</span><span class="hl-identifier">INFINITE</span><span class="hl-brackets">)</span></pre></div>

<p class="paragraph">
メモ帳を起動してみます：
<br />
</p>
<pre>&gt; 01_nothing.py notepad.exe
(メモ帳を終了)
&gt;
</pre>

<p class="paragraph">
この段階で動作しない場合、PyDbgEngの初期化で何か問題が発生している可能性があります。
<br />
PyDbgEng.py の PyDbgEng クラスの __init__ メソッド内で適当に dbg_eng_log を設定し、メッセージを確認してみてください。
<br />
</p>

<h3 id="id958eb4">02_mon_events.py : {CREATE|EXIT}_{PROCESS|THREAD},{LOAD|UNLOAD}_MODULEイベント</h3>

<p class="paragraph">
続いて DEBUG_EVENT_{CREATE|EXIT}_{PROCESS|THREAD}, DEBUG_EVENT_{LOAD|UNLOAD}_MODULE イベントをモニタしてみます。
<br />
</p>

<p class="paragraph">
02_mon_events.py :
<br />
</p>
<div class="hl-main"><pre><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">sys</span><span class="hl-code">
</span><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">
 
</span><span class="hl-identifier">DBGENG_DLL_PATH</span><span class="hl-code"> = </span><span class="hl-quotes">&quot;</span><span class="hl-string">C:</span><span class="hl-special">\\</span><span class="hl-string">WinDDK</span><span class="hl-special">\\</span><span class="hl-string">7600.16385.1</span><span class="hl-special">\\</span><span class="hl-string">Debuggers</span><span class="hl-quotes">&quot;</span><span class="hl-code">
 
</span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-number">2</span><span class="hl-code"> &gt; </span><span class="hl-builtin">len</span><span class="hl-brackets">(</span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">argv</span><span class="hl-brackets">)</span><span class="hl-code">:
  </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">usage: %s *.exe</span><span class="hl-quotes">&quot;</span><span class="hl-code"> % </span><span class="hl-brackets">(</span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-number">0</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">
  </span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-reserved">class</span><span class="hl-code"> </span><span class="hl-identifier">MyDbgEventHandler</span><span class="hl-brackets">(</span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">IDebugEventCallbacksSink</span><span class="hl-brackets">)</span><span class="hl-code">:
 
  </span><span class="hl-comment"># イベントハンドラでモニタするイベントを指定</span><span class="hl-code">
  </span><span class="hl-reserved">def</span><span class="hl-code"> </span><span class="hl-identifier">GetInterestMask</span><span class="hl-brackets">(</span><span class="hl-identifier">self</span><span class="hl-brackets">)</span><span class="hl-code">:
    </span><span class="hl-reserved">return</span><span class="hl-code"> \
        </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_EVENT_CREATE_PROCESS</span><span class="hl-code"> | \
        </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_EVENT_CREATE_THREAD</span><span class="hl-code"> | \
        </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_EVENT_LOAD_MODULE</span><span class="hl-code"> | \
        </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_EVENT_UNLOAD_MODULE</span><span class="hl-code"> | \
        </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_EVENT_EXIT_THREAD</span><span class="hl-code"> | \
        </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_EVENT_EXIT_PROCESS</span><span class="hl-code"> | \
        </span><span class="hl-number">0</span><span class="hl-code">
 
  </span><span class="hl-comment"># 以下、各イベントハンドラの実装</span><span class="hl-code">
  </span><span class="hl-reserved">def</span><span class="hl-code"> </span><span class="hl-identifier">CreateProcess</span><span class="hl-brackets">(</span><span class="hl-identifier">self</span><span class="hl-code">, </span><span class="hl-identifier">dbg</span><span class="hl-code">, \
      </span><span class="hl-identifier">ImageFileHandle</span><span class="hl-code">, </span><span class="hl-identifier">Handle</span><span class="hl-code">, </span><span class="hl-identifier">BaseOffset</span><span class="hl-code">, </span><span class="hl-identifier">ModuleSize</span><span class="hl-code">, </span><span class="hl-identifier">ModuleName</span><span class="hl-code">, \
      </span><span class="hl-identifier">ImageName</span><span class="hl-code">, </span><span class="hl-identifier">CheckSum</span><span class="hl-code">, </span><span class="hl-identifier">TimeDateStamp</span><span class="hl-code">, </span><span class="hl-identifier">InitialThreadHandle</span><span class="hl-code">, \
      </span><span class="hl-identifier">ThreadDataOffset</span><span class="hl-code">, </span><span class="hl-identifier">StartOffset</span><span class="hl-code"> \
      </span><span class="hl-brackets">)</span><span class="hl-code">:
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">&lt;&lt;CreateProcess&gt;&gt;</span><span class="hl-quotes">&quot;</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">ImageFileHandle : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">ImageFileHandle</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">Handle : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">Handle</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">BaseOffset : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">BaseOffset</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">ModuleSize : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">ModuleSize</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">ModuleName : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">ModuleName</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">ImageName : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">ImageName</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">CheckSum : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">CheckSum</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">TimeDateStamp : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">TimeDateStamp</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">InitialThreadHandle : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">InitialThreadHandle</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">ThreadDataOffset : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">ThreadDataOffset</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">StartDataOffset : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">StartOffset</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_STATUS_NO_CHANGE</span><span class="hl-code">
 
  </span><span class="hl-reserved">def</span><span class="hl-code"> </span><span class="hl-identifier">CreateThread</span><span class="hl-brackets">(</span><span class="hl-identifier">self</span><span class="hl-code">, </span><span class="hl-identifier">dbg</span><span class="hl-code">, </span><span class="hl-identifier">Handle</span><span class="hl-code">, </span><span class="hl-identifier">DataOffset</span><span class="hl-code">, </span><span class="hl-identifier">StartOffset</span><span class="hl-brackets">)</span><span class="hl-code">:
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">&lt;&lt;CreateThread&gt;&gt;</span><span class="hl-quotes">&quot;</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">Handle: </span><span class="hl-quotes">&quot;</span><span class="hl-code">, 
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-identifier">Handle</span><span class="hl-code">:
      </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">Handle</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">else</span><span class="hl-code">:
      </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">NULL</span><span class="hl-quotes">&quot;</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">DataOffset: </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">DataOffset</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">StartOffset: </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">StartOffset</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_STATUS_NO_CHANGE</span><span class="hl-code">
 
  </span><span class="hl-reserved">def</span><span class="hl-code"> </span><span class="hl-identifier">LoadModule</span><span class="hl-brackets">(</span><span class="hl-identifier">self</span><span class="hl-code">, </span><span class="hl-identifier">dbg</span><span class="hl-code">, \
      </span><span class="hl-identifier">ImageFileHandle</span><span class="hl-code">, </span><span class="hl-identifier">BaseOffset</span><span class="hl-code">, </span><span class="hl-identifier">ModuleSize</span><span class="hl-code">, \
      </span><span class="hl-identifier">ModuleName</span><span class="hl-code">, </span><span class="hl-identifier">ImageName</span><span class="hl-code">, </span><span class="hl-identifier">CheckSum</span><span class="hl-code">, </span><span class="hl-identifier">TimeDateStamp</span><span class="hl-code"> \
      </span><span class="hl-brackets">)</span><span class="hl-code">:
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">&lt;&lt;LoadModule&gt;&gt;</span><span class="hl-quotes">&quot;</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">ImageFileHandle : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">ImageFileHandle</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">BaseOffset : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">BaseOffset</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">ModuleSize : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">ModuleSize</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">ModuleName : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">ModuleName</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">ImageName : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">ImageName</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">CheckSum : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">CheckSum</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">TimeDateStamp : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">TimeDateStamp</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_STATUS_NO_CHANGE</span><span class="hl-code">
 
  </span><span class="hl-reserved">def</span><span class="hl-code"> </span><span class="hl-identifier">UnloadModule</span><span class="hl-brackets">(</span><span class="hl-identifier">self</span><span class="hl-code">, </span><span class="hl-identifier">dbg</span><span class="hl-code">, </span><span class="hl-identifier">ImageBaseName</span><span class="hl-code">, </span><span class="hl-identifier">BaseOffset</span><span class="hl-brackets">)</span><span class="hl-code">:
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">&lt;&lt;UnloadModule&gt;&gt;</span><span class="hl-quotes">&quot;</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">ImageBaseName: </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">ImageBaseName</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">BaseOffset : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">BaseOffset</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_STATUS_NO_CHANGE</span><span class="hl-code">
 
  </span><span class="hl-reserved">def</span><span class="hl-code"> </span><span class="hl-identifier">ExitThread</span><span class="hl-brackets">(</span><span class="hl-identifier">self</span><span class="hl-code">, </span><span class="hl-identifier">dbg</span><span class="hl-code">, </span><span class="hl-identifier">ExitCode</span><span class="hl-brackets">)</span><span class="hl-code">:
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">&lt;&lt;ExitThread&gt;&gt;</span><span class="hl-quotes">&quot;</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">ExitCode: </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">ExitCode</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_STATUS_NO_CHANGE</span><span class="hl-code">
 
  </span><span class="hl-reserved">def</span><span class="hl-code"> </span><span class="hl-identifier">ExitProcess</span><span class="hl-brackets">(</span><span class="hl-identifier">self</span><span class="hl-code">, </span><span class="hl-identifier">dbg</span><span class="hl-code">, </span><span class="hl-identifier">ExitCode</span><span class="hl-brackets">)</span><span class="hl-code">:
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">&lt;&lt;ExitProcess&gt;&gt;</span><span class="hl-quotes">&quot;</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">ExitCode: </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">ExitCode</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_STATUS_NO_CHANGE</span><span class="hl-code">
 
</span><span class="hl-identifier">event_handler</span><span class="hl-code"> = </span><span class="hl-identifier">MyDbgEventHandler</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-identifier">dbg</span><span class="hl-code"> = </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">ProcessCreator</span><span class="hl-brackets">(</span><span class="hl-code"> \
    </span><span class="hl-identifier">command_line</span><span class="hl-code"> = </span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-number">1</span><span class="hl-brackets">]</span><span class="hl-code">, \
    </span><span class="hl-identifier">event_callbacks_sink</span><span class="hl-code"> = </span><span class="hl-identifier">event_handler</span><span class="hl-code">, \
    </span><span class="hl-identifier">dbg_eng_dll_path</span><span class="hl-code"> = </span><span class="hl-identifier">DBGENG_DLL_PATH</span><span class="hl-code"> \
    </span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-identifier">dbg</span><span class="hl-code">.</span><span class="hl-identifier">wait_for_event</span><span class="hl-brackets">(</span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">Defines</span><span class="hl-code">.</span><span class="hl-identifier">INFINITE</span><span class="hl-brackets">)</span></pre></div>

<p class="paragraph">
実行例：
<br />
</p>
<pre class="plugin_pre">
&gt; 02_mon_events.py notepad.exe
&lt;&lt;CreateProcess&gt;&gt;
	ImageFileHandle :  0xe8L
	Handle :  0xd0L
	BaseOffset :  0x1000000L
	ModuleSize :  0x14000L
	ModuleName :  notepad
	ImageName :  notepad.exe
	CheckSum :  0x1315bL
	TimeDateStamp :  0xd4L
	InitialThreadHandle :  0xd4L
	ThreadDataOffset :  0x7ffde000L
	StartDataOffset :  0x100739dL
&lt;&lt;LoadModule&gt;&gt;
	ImageFileHandle :  0xe0L
	BaseOffset :  0x7c940000L
	ModuleSize :  0x9f000L
	ModuleName :  ntdll
	ImageName :  ntdll.dll
	CheckSum :  0xa1033L
	TimeDateStamp :  0x4d00f27bL
&lt;&lt;LoadModule&gt;&gt;
	ImageFileHandle :  0xe4L
	BaseOffset :  0x7c800000L
	ModuleSize :  0x133000L
	ModuleName :  kernel32
	ImageName :  C:\WINDOWS\system32\kernel32.dll
	CheckSum :  0x13a635L
	TimeDateStamp :  0x49c4f49cL
(...)
&lt;&lt;CreateThread&gt;&gt;
	Handle:  NULL
	DataOffset:  0x7ffdc000L
	StartOffset:  0x7c8106f9L
(...)
&lt;&lt;UnloadModule&gt;&gt;
	ImageBaseName:  C:\WINDOWS\system32\RichEd20.dll
	BaseOffset :  0x74d70000L
(...)
&lt;&lt;ExitThread&gt;&gt;
	ExitCode:  0x0L
&lt;&lt;ExitProcess&gt;&gt;
	ExitCode:  0x0L
</pre>

<p class="paragraph">
イベントハンドラの引数については、WinDBG側のヘルプとPyDbgEngのソースコードを突き合わせて調べればなんとかなると思います。
<br />
</p>

<h3 id="id30afbc">03_initial_break.py : デバッガの初期イベントと例外イベントハンドラ</h3>

<p class="paragraph">
デバッガで起動したときにシステムDLL内で発生する最初のイベントを拾うことが出来ます。拡張機能のコア、エンジン部分のオプションで DEBUG_ENGOPT_INITIAL_BREAK を指定します。
<br />
例外イベントとして送られますので、対応するイベントハンドラを用意します。
<br />
今回の例ではイベントハンドラに渡された主なパラメータを表示するにとどめ、特に何もせずそのまま処理を続行させます。
<br />
</p>

<p class="paragraph">
03_initial_break.py :
<br />
</p>
<div class="hl-main"><pre><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">sys</span><span class="hl-code">
</span><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">threading</span><span class="hl-code">
</span><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">
 
</span><span class="hl-identifier">DBGENG_DLL_PATH</span><span class="hl-code"> = </span><span class="hl-quotes">&quot;</span><span class="hl-string">C:</span><span class="hl-special">\\</span><span class="hl-string">WinDDK</span><span class="hl-special">\\</span><span class="hl-string">7600.16385.1</span><span class="hl-special">\\</span><span class="hl-string">Debuggers</span><span class="hl-quotes">&quot;</span><span class="hl-code">
 
</span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-number">2</span><span class="hl-code"> &gt; </span><span class="hl-builtin">len</span><span class="hl-brackets">(</span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">argv</span><span class="hl-brackets">)</span><span class="hl-code">:
  </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">usage: %s *.exe</span><span class="hl-quotes">&quot;</span><span class="hl-code"> % </span><span class="hl-brackets">(</span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-number">0</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">
  </span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-reserved">class</span><span class="hl-code"> </span><span class="hl-identifier">MyDbgEventHandler</span><span class="hl-brackets">(</span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">IDebugEventCallbacksSink</span><span class="hl-brackets">)</span><span class="hl-code">:
 
  </span><span class="hl-reserved">def</span><span class="hl-code"> </span><span class="hl-identifier">GetInterestMask</span><span class="hl-brackets">(</span><span class="hl-identifier">self</span><span class="hl-brackets">)</span><span class="hl-code">:
    </span><span class="hl-reserved">return</span><span class="hl-code"> \
        </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_EVENT_EXCEPTION</span><span class="hl-code"> | \
        </span><span class="hl-number">0</span><span class="hl-code">
 
  </span><span class="hl-reserved">def</span><span class="hl-code"> </span><span class="hl-identifier">Exception</span><span class="hl-brackets">(</span><span class="hl-identifier">self</span><span class="hl-code">, </span><span class="hl-identifier">dbg</span><span class="hl-code">, \
      </span><span class="hl-identifier">ExceptionCode</span><span class="hl-code">, </span><span class="hl-identifier">ExceptionFlags</span><span class="hl-code">, </span><span class="hl-identifier">ExceptionRecord</span><span class="hl-code">, \
      </span><span class="hl-identifier">ExceptionAddress</span><span class="hl-code">, </span><span class="hl-identifier">NumberParameters</span><span class="hl-code">, \
      </span><span class="hl-identifier">ExceptionInformation0</span><span class="hl-code">, </span><span class="hl-identifier">ExceptionInformation1</span><span class="hl-code">, </span><span class="hl-identifier">ExceptionInformation2</span><span class="hl-code">, \
      </span><span class="hl-identifier">ExceptionInformation3</span><span class="hl-code">, </span><span class="hl-identifier">ExceptionInformation4</span><span class="hl-code">, </span><span class="hl-identifier">ExceptionInformation5</span><span class="hl-code">, \
      </span><span class="hl-identifier">ExceptionInformation6</span><span class="hl-code">, </span><span class="hl-identifier">ExceptionInformation7</span><span class="hl-code">, </span><span class="hl-identifier">ExceptionInformation8</span><span class="hl-code">, \
      </span><span class="hl-identifier">ExceptionInformation9</span><span class="hl-code">, </span><span class="hl-identifier">ExceptionInformation10</span><span class="hl-code">, </span><span class="hl-identifier">ExceptionInformation11</span><span class="hl-code">, \
      </span><span class="hl-identifier">ExceptionInformation12</span><span class="hl-code">, </span><span class="hl-identifier">ExceptionInformation13</span><span class="hl-code">, </span><span class="hl-identifier">ExceptionInformation14</span><span class="hl-code">, \
      </span><span class="hl-identifier">FirstChance</span><span class="hl-brackets">)</span><span class="hl-code">:
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">&lt;&lt;Exception&gt;&gt;</span><span class="hl-quotes">&quot;</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">Code : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">ExceptionCode</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">Flags : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">ExceptionFlags</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">Address : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">ExceptionAddress</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">NumberParameters : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">NumberParameters</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">FirstChance : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">FirstChance</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_STATUS_NOT_CHANGED</span><span class="hl-code">
 
</span><span class="hl-identifier">event_handler</span><span class="hl-code"> = </span><span class="hl-identifier">MyDbgEventHandler</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-identifier">dbg</span><span class="hl-code"> = </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">ProcessCreator</span><span class="hl-brackets">(</span><span class="hl-code"> \
    </span><span class="hl-identifier">command_line</span><span class="hl-code"> = </span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-number">1</span><span class="hl-brackets">]</span><span class="hl-code">, \
    </span><span class="hl-identifier">event_callbacks_sink</span><span class="hl-code"> = </span><span class="hl-identifier">event_handler</span><span class="hl-code">, \
    </span><span class="hl-identifier">dbg_eng_dll_path</span><span class="hl-code"> = </span><span class="hl-identifier">DBGENG_DLL_PATH</span><span class="hl-code"> \
    </span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-identifier">dbg</span><span class="hl-code">.</span><span class="hl-identifier">idebug_control</span><span class="hl-code">.</span><span class="hl-identifier">AddEngineOptions</span><span class="hl-brackets">(</span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_ENGOPT_INITIAL_BREAK</span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-identifier">quit_event</span><span class="hl-code"> = </span><span class="hl-identifier">threading</span><span class="hl-code">.</span><span class="hl-identifier">Event</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-identifier">dbg</span><span class="hl-code">.</span><span class="hl-identifier">event_loop_with_quit_event</span><span class="hl-brackets">(</span><span class="hl-identifier">quit_event</span><span class="hl-brackets">)</span></pre></div>

<p class="paragraph">
実行例：
<br />
</p>
<pre class="plugin_pre">
&gt; 03_initial_break.py notepad.exe
&lt;&lt;Exception&gt;&gt;
        Code :  0x80000003L
        Flags :  0x0L
        Address :  0x7c94120eL
        NumberParameters :  0x3L
        FirstChance :  0x1L
(メモ帳を終了)
&gt;
</pre>

<h3 id="id348cfe">main()関数でブレークしてみる</h3>

<p class="paragraph">
簡単なコンソールアプリを作成し、main()関数でブレークしてみます。
<br />
</p>

<p class="paragraph">
helloworld.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">argc</span><span class="hl-code">, </span><span >char</span><span class="hl-code"> *</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">Hello, World!</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">getchar</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>
<p class="paragraph">
Makefile.mk:
<br />
</p>
<pre class="plugin_pre">

CFLAGS=/nologo /Zi /Wall /Od

helloworld.exe: helloworld.c
	cl $(CFLAGS) $? /link /DEBUG /PDB:$*.pdb

clean:
	del *.exe *.obj *.pdb *.ilk
</pre>
<p class="paragraph">
コンパイル＋実行：
<br />
</p>
<pre class="plugin_pre">
&gt; nmake /f Makefile.mk

Microsoft(R) Program Maintenance Utility Version 10.00.30319.01
Copyright (C) Microsoft Corporation.  All rights reserved.

        cl /nologo /Zi /Wall /Od helloworld.c /link /DEBUG /PDB:helloworld.pdb
helloworld.c
helloworld.c(3) : warning C4100: &#039;argv&#039; : 引数は関数の本体部で 1 度も参照されません。
helloworld.c(3) : warning C4100: &#039;argc&#039; : 引数は関数の本体部で 1 度も参照されません。

&gt; helloworld.exe
Hello, World!
(RETURNキー押下)
&gt;
</pre>

<p class="paragraph">
デバッグ対象が準備できたので、デバッガの方を作っていきます。
<br />
</p>

<h4 id="id1bf255">04_break_at_main1.py : ブレークポイントイベントを拾う</h4>

<p class="paragraph">
まずはブレークポイントイベントを拾ってみます。
<br />
</p>
<ol><li> &quot;!sym noisy&quot;に相当する設定を行い、シンボルがロードされたことを確認できるようにしておく。</li>
<li> &quot;main()&quot;にブレークポイントを設定する。</li>
<li> ブレークポイント用のイベントハンドラを用意し、渡された情報を表示してみる。</li></ol>

<p class="paragraph">
04_break_at_main1.py:
<br />
</p>
<div class="hl-main"><pre><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">sys</span><span class="hl-code">
</span><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">threading</span><span class="hl-code">
</span><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">os</span><span class="hl-code">
</span><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">
 
</span><span class="hl-identifier">DBGENG_DLL_PATH</span><span class="hl-code"> = </span><span class="hl-quotes">&quot;</span><span class="hl-string">C:</span><span class="hl-special">\\</span><span class="hl-string">WinDDK</span><span class="hl-special">\\</span><span class="hl-string">7600.16385.1</span><span class="hl-special">\\</span><span class="hl-string">Debuggers</span><span class="hl-quotes">&quot;</span><span class="hl-code">
 
</span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-number">2</span><span class="hl-code"> &gt; </span><span class="hl-builtin">len</span><span class="hl-brackets">(</span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">argv</span><span class="hl-brackets">)</span><span class="hl-code">:
  </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">usage: %s *.exe</span><span class="hl-quotes">&quot;</span><span class="hl-code"> % </span><span class="hl-brackets">(</span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-number">0</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">
  </span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-identifier">modname_exe</span><span class="hl-code"> = </span><span class="hl-identifier">os</span><span class="hl-code">.</span><span class="hl-identifier">path</span><span class="hl-code">.</span><span class="hl-identifier">basename</span><span class="hl-brackets">(</span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-number">1</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">.</span><span class="hl-identifier">replace</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">.exe</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-comment"># デバッガエンジンの出力を表示するための出力ハンドラを用意する</span><span class="hl-code">
</span><span class="hl-reserved">class</span><span class="hl-code"> </span><span class="hl-identifier">MyDbgOutputHandler</span><span class="hl-brackets">(</span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">IDebugOutputCallbacksSink</span><span class="hl-brackets">)</span><span class="hl-code">:
    </span><span class="hl-reserved">def</span><span class="hl-code"> </span><span class="hl-identifier">Output</span><span class="hl-brackets">(</span><span class="hl-identifier">self</span><span class="hl-code">, </span><span class="hl-identifier">this</span><span class="hl-code">, </span><span class="hl-identifier">Mask</span><span class="hl-code">, </span><span class="hl-identifier">Text</span><span class="hl-brackets">)</span><span class="hl-code">:
        </span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">stdout</span><span class="hl-code">.</span><span class="hl-identifier">write</span><span class="hl-brackets">(</span><span class="hl-identifier">Text</span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-reserved">class</span><span class="hl-code"> </span><span class="hl-identifier">MyDbgEventHandler</span><span class="hl-brackets">(</span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">IDebugEventCallbacksSink</span><span class="hl-brackets">)</span><span class="hl-code">:
 
  </span><span class="hl-reserved">def</span><span class="hl-code"> </span><span class="hl-identifier">GetInterestMask</span><span class="hl-brackets">(</span><span class="hl-identifier">self</span><span class="hl-brackets">)</span><span class="hl-code">:
    </span><span class="hl-reserved">return</span><span class="hl-code"> \
        </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_EVENT_BREAKPOINT</span><span class="hl-code"> | \
        </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_EVENT_CREATE_PROCESS</span><span class="hl-code"> | \
        </span><span class="hl-number">0</span><span class="hl-code">
 
  </span><span class="hl-comment"># ブレークポイント用のイベントハンドラ</span><span class="hl-code">
  </span><span class="hl-reserved">def</span><span class="hl-code"> </span><span class="hl-identifier">Breakpoint</span><span class="hl-brackets">(</span><span class="hl-identifier">self</span><span class="hl-code">, </span><span class="hl-identifier">dbg</span><span class="hl-code">, \
      </span><span class="hl-identifier">Offset</span><span class="hl-code">, </span><span class="hl-identifier">Id</span><span class="hl-code">, </span><span class="hl-identifier">BreakType</span><span class="hl-code">, </span><span class="hl-identifier">ProcType</span><span class="hl-code">, </span><span class="hl-identifier">Flags</span><span class="hl-code">, \
      </span><span class="hl-identifier">DataSize</span><span class="hl-code">, </span><span class="hl-identifier">DataAccessType</span><span class="hl-code">, </span><span class="hl-identifier">PassCount</span><span class="hl-code">, </span><span class="hl-identifier">CurrentPassCount</span><span class="hl-code">, \
      </span><span class="hl-identifier">MatchThread</span><span class="hl-code">, </span><span class="hl-identifier">CommandSize</span><span class="hl-code">, </span><span class="hl-identifier">OffsetExpressionSize</span><span class="hl-brackets">)</span><span class="hl-code">:
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">&lt;&lt;Breakpoint&gt;&gt;</span><span class="hl-quotes">&quot;</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">Offset : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">Offset</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">Id : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">Id</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">BreakType : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, 
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-identifier">BreakType</span><span class="hl-code"> == </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_BREAKPOINT_CODE</span><span class="hl-code">:
      </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">Software</span><span class="hl-quotes">&quot;</span><span class="hl-code">
    </span><span class="hl-reserved">else</span><span class="hl-code">:
      </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">Hardware</span><span class="hl-quotes">&quot;</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">ProcType : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">ProcType</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">Flags : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, 
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-identifier">Flags</span><span class="hl-code"> &amp; </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_BREAKPOINT_ENABLED</span><span class="hl-code">:
      </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">ENABLED </span><span class="hl-quotes">&quot;</span><span class="hl-code">
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-identifier">Flags</span><span class="hl-code"> &amp; </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_BREAKPOINT_ADDER_ONLY</span><span class="hl-code">:
      </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">ADDER_ONLY </span><span class="hl-quotes">&quot;</span><span class="hl-code">
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-identifier">Flags</span><span class="hl-code"> &amp; </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_BREAKPOINT_GO_ONLY</span><span class="hl-code">:
      </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">GO_ONLY </span><span class="hl-quotes">&quot;</span><span class="hl-code">
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-identifier">Flags</span><span class="hl-code"> &amp; </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_BREAKPOINT_ONE_SHOT</span><span class="hl-code">:
      </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">ONE_SHOT </span><span class="hl-quotes">&quot;</span><span class="hl-code">
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-identifier">Flags</span><span class="hl-code"> &amp; </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_BREAKPOINT_DEFERRED</span><span class="hl-code">:
      </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">DEFERRED </span><span class="hl-quotes">&quot;</span><span class="hl-code">
 
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-identifier">BreakType</span><span class="hl-code"> == </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_BREAKPOINT_DATA</span><span class="hl-code">:
      </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">(HWBRK)DataSize : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">DataSize</span><span class="hl-brackets">)</span><span class="hl-code">
      </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">(HWBRK)DataAccessType: </span><span class="hl-quotes">&quot;</span><span class="hl-code">, 
      </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-identifier">DataAccessType</span><span class="hl-code"> == </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_BREAK_READ</span><span class="hl-code">:
        </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">READ </span><span class="hl-quotes">&quot;</span><span class="hl-code">
      </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-identifier">DataAccessType</span><span class="hl-code"> == </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_BREAK_WRITE</span><span class="hl-code">:
        </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">WRITE </span><span class="hl-quotes">&quot;</span><span class="hl-code">
      </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-identifier">DataAccessType</span><span class="hl-code"> == </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_BREAK_EXECUTE</span><span class="hl-code">:
        </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">EXECUTE </span><span class="hl-quotes">&quot;</span><span class="hl-code">
 
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">PassCount : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">PassCount</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">CurrentPassCount : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">CurrentPassCount</span><span class="hl-brackets">)</span><span class="hl-code">
 
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-identifier">MatchThread</span><span class="hl-code">:
      </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">MatchThreadId : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">MatchThread</span><span class="hl-brackets">)</span><span class="hl-code">
 
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">CommandSize : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">CommandSize</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-special">\t</span><span class="hl-string">OffsetExpressionSize : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">OffsetExpressionSize</span><span class="hl-brackets">)</span><span class="hl-code">
 
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_STATUS_GO</span><span class="hl-code">
 
  </span><span class="hl-reserved">def</span><span class="hl-code"> </span><span class="hl-identifier">CreateProcess</span><span class="hl-brackets">(</span><span class="hl-identifier">self</span><span class="hl-code">, </span><span class="hl-identifier">dbg</span><span class="hl-code">, \
      </span><span class="hl-identifier">ImageFileHandle</span><span class="hl-code">, </span><span class="hl-identifier">Handle</span><span class="hl-code">, </span><span class="hl-identifier">BaseOffset</span><span class="hl-code">, </span><span class="hl-identifier">ModuleSize</span><span class="hl-code">, </span><span class="hl-identifier">ModuleName</span><span class="hl-code">, \
      </span><span class="hl-identifier">ImageName</span><span class="hl-code">, </span><span class="hl-identifier">CheckSum</span><span class="hl-code">, </span><span class="hl-identifier">TimeDateStamp</span><span class="hl-code">, </span><span class="hl-identifier">InitialThreadHandle</span><span class="hl-code">, \
      </span><span class="hl-identifier">ThreadDataOffset</span><span class="hl-code">, </span><span class="hl-identifier">StartOffset</span><span class="hl-code"> \
      </span><span class="hl-brackets">)</span><span class="hl-code">:
    </span><span class="hl-comment"># &quot;main()&quot;シンボルのアドレスを取得し、&quot;bp_set()&quot;でブレークポイントを設定</span><span class="hl-code">
    </span><span class="hl-identifier">main_symstr</span><span class="hl-code"> = </span><span class="hl-identifier">modname_exe</span><span class="hl-code"> + </span><span class="hl-quotes">&quot;</span><span class="hl-string">!main</span><span class="hl-quotes">&quot;</span><span class="hl-code">
    </span><span class="hl-identifier">main_addr</span><span class="hl-code"> = </span><span class="hl-identifier">dbg</span><span class="hl-code">.</span><span class="hl-identifier">resolve_symbol</span><span class="hl-brackets">(</span><span class="hl-identifier">main_symstr</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-identifier">main_symstr</span><span class="hl-code"> + </span><span class="hl-quotes">&quot;</span><span class="hl-string"> at </span><span class="hl-quotes">&quot;</span><span class="hl-code"> + </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">main_addr</span><span class="hl-brackets">)</span><span class="hl-code">, 
    </span><span class="hl-identifier">dbg</span><span class="hl-code">.</span><span class="hl-identifier">bp_set</span><span class="hl-brackets">(</span><span class="hl-identifier">dbg</span><span class="hl-code">.</span><span class="hl-identifier">resolve_symbol</span><span class="hl-brackets">(</span><span class="hl-identifier">modname_exe</span><span class="hl-code"> + </span><span class="hl-quotes">&quot;</span><span class="hl-string">!main</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string"> : break point set</span><span class="hl-quotes">&quot;</span><span class="hl-code">
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_STATUS_NO_CHANGE</span><span class="hl-code">
 
</span><span class="hl-identifier">event_handler</span><span class="hl-code"> = </span><span class="hl-identifier">MyDbgEventHandler</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-identifier">output_handler</span><span class="hl-code"> = </span><span class="hl-identifier">MyDbgOutputHandler</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-identifier">dbg</span><span class="hl-code"> = </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">ProcessCreator</span><span class="hl-brackets">(</span><span class="hl-code"> \
    </span><span class="hl-identifier">command_line</span><span class="hl-code"> = </span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-number">1</span><span class="hl-brackets">]</span><span class="hl-code">, \
    </span><span class="hl-identifier">output_callbacks_sink</span><span class="hl-code"> = </span><span class="hl-identifier">output_handler</span><span class="hl-code">, \
    </span><span class="hl-identifier">event_callbacks_sink</span><span class="hl-code"> = </span><span class="hl-identifier">event_handler</span><span class="hl-code">, \
    </span><span class="hl-identifier">dbg_eng_dll_path</span><span class="hl-code"> = </span><span class="hl-identifier">DBGENG_DLL_PATH</span><span class="hl-code"> \
    </span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-identifier">dbg</span><span class="hl-code">.</span><span class="hl-identifier">idebug_symbols</span><span class="hl-code">.</span><span class="hl-identifier">AddSymbolOptions</span><span class="hl-brackets">(</span><span class="hl-number">0</span><span class="hl-identifier">x80000000</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-comment"># &quot;!sym noisy&quot;に相当</span><span class="hl-code">
 
</span><span class="hl-identifier">quit_event</span><span class="hl-code"> = </span><span class="hl-identifier">threading</span><span class="hl-code">.</span><span class="hl-identifier">Event</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-identifier">dbg</span><span class="hl-code">.</span><span class="hl-identifier">event_loop_with_quit_event</span><span class="hl-brackets">(</span><span class="hl-identifier">quit_event</span><span class="hl-brackets">)</span></pre></div>

<p class="paragraph">
実行例：
<br />
</p>
<pre class="plugin_pre">
&gt; 04_break_at_main1.py helloworld.exe

Microsoft (R) Windows Debugger Version 6.12.0002.633 X86
Copyright (c) Microsoft Corporation. All rights reserved.

CommandLine: helloworld.exe
DBGHELP: _NT_SYMBOL_PATH: srv*...;http://msdl.microsoft.com/download/symbols
DBGHELP: Symbol Search Path: ...
(...)
*** WARNING: Unable to verify checksum for helloworld.exe
DBGHELP: helloworld - private symbols &amp; lines
         C:\(...)\helloworld.pdb
helloworld!main at 0x401010L  : break point set
ModLoad: 7c940000 7c9df000   ntdll.dll
ModLoad: 7c800000 7c933000   C:\WINDOWS\system32\kernel32.dll
Breakpoint 0 hit
&lt;&lt;Breakpoint&gt;&gt;
        Offset :  0x401010L
        Id :  0x0L
        BreakType :  Software
        ProcType :  0x14cL
        Flags :  ENABLED
        PassCount :  0x1L
        CurrentPassCount :  0x1L
        MatchThreadId :  0xffffffffL
        CommandSize :  0x0L
        OffsetExpressionSize :  0x0L
Hello, World!
(RETURNキー押下)
&gt;
</pre>

<h4 id="idf926d2">04_break_at_main2.py : ブレークしたときのスタックトレースとレジスタを表示してみる</h4>

<p class="paragraph">
main()でブレークさせることに成功したので、続いてブレークしたときのスタックトレースとレジスタを表示してみます。
<br />
</p>

<p class="paragraph">
04_break_at_main2.py :
<br />
</p>
<div class="hl-main"><pre><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">sys</span><span class="hl-code">
</span><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">threading</span><span class="hl-code">
</span><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">os</span><span class="hl-code">
</span><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">
 
</span><span class="hl-identifier">DBGENG_DLL_PATH</span><span class="hl-code"> = </span><span class="hl-quotes">&quot;</span><span class="hl-string">C:</span><span class="hl-special">\\</span><span class="hl-string">WinDDK</span><span class="hl-special">\\</span><span class="hl-string">7600.16385.1</span><span class="hl-special">\\</span><span class="hl-string">Debuggers</span><span class="hl-quotes">&quot;</span><span class="hl-code">
 
</span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-number">2</span><span class="hl-code"> &gt; </span><span class="hl-builtin">len</span><span class="hl-brackets">(</span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">argv</span><span class="hl-brackets">)</span><span class="hl-code">:
  </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">usage: %s *.exe</span><span class="hl-quotes">&quot;</span><span class="hl-code"> % </span><span class="hl-brackets">(</span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-number">0</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">
  </span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-identifier">modname_exe</span><span class="hl-code"> = </span><span class="hl-identifier">os</span><span class="hl-code">.</span><span class="hl-identifier">path</span><span class="hl-code">.</span><span class="hl-identifier">basename</span><span class="hl-brackets">(</span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-number">1</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">.</span><span class="hl-identifier">replace</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">.exe</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-reserved">class</span><span class="hl-code"> </span><span class="hl-identifier">MyDbgOutputHandler</span><span class="hl-brackets">(</span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">IDebugOutputCallbacksSink</span><span class="hl-brackets">)</span><span class="hl-code">:
    </span><span class="hl-reserved">def</span><span class="hl-code"> </span><span class="hl-identifier">Output</span><span class="hl-brackets">(</span><span class="hl-identifier">self</span><span class="hl-code">, </span><span class="hl-identifier">this</span><span class="hl-code">, </span><span class="hl-identifier">Mask</span><span class="hl-code">, </span><span class="hl-identifier">Text</span><span class="hl-brackets">)</span><span class="hl-code">:
        </span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">stdout</span><span class="hl-code">.</span><span class="hl-identifier">write</span><span class="hl-brackets">(</span><span class="hl-identifier">Text</span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-reserved">class</span><span class="hl-code"> </span><span class="hl-identifier">MyDbgEventHandler</span><span class="hl-brackets">(</span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">IDebugEventCallbacksSink</span><span class="hl-brackets">)</span><span class="hl-code">:
 
  </span><span class="hl-reserved">def</span><span class="hl-code"> </span><span class="hl-identifier">GetInterestMask</span><span class="hl-brackets">(</span><span class="hl-identifier">self</span><span class="hl-brackets">)</span><span class="hl-code">:
    </span><span class="hl-reserved">return</span><span class="hl-code"> \
        </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_EVENT_BREAKPOINT</span><span class="hl-code"> | \
        </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_EVENT_CREATE_PROCESS</span><span class="hl-code"> | \
        </span><span class="hl-number">0</span><span class="hl-code">
 
  </span><span class="hl-reserved">def</span><span class="hl-code"> </span><span class="hl-identifier">Breakpoint</span><span class="hl-brackets">(</span><span class="hl-identifier">self</span><span class="hl-code">, </span><span class="hl-identifier">dbg</span><span class="hl-code">, \
      </span><span class="hl-identifier">Offset</span><span class="hl-code">, </span><span class="hl-identifier">Id</span><span class="hl-code">, </span><span class="hl-identifier">BreakType</span><span class="hl-code">, </span><span class="hl-identifier">ProcType</span><span class="hl-code">, </span><span class="hl-identifier">Flags</span><span class="hl-code">, \
      </span><span class="hl-identifier">DataSize</span><span class="hl-code">, </span><span class="hl-identifier">DataAccessType</span><span class="hl-code">, </span><span class="hl-identifier">PassCount</span><span class="hl-code">, </span><span class="hl-identifier">CurrentPassCount</span><span class="hl-code">, \
      </span><span class="hl-identifier">MatchThread</span><span class="hl-code">, </span><span class="hl-identifier">CommandSize</span><span class="hl-code">, </span><span class="hl-identifier">OffsetExpressionSize</span><span class="hl-brackets">)</span><span class="hl-code">:
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">&lt;&lt;&lt;StackFrame(TOP5)&gt;&gt;&gt;</span><span class="hl-quotes">&quot;</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">Offset : </span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">Offset</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">#,INSTR,RTN,P0,P1,P2,P3</span><span class="hl-quotes">&quot;</span><span class="hl-code">
    </span><span class="hl-comment"># スタックフレームを最大5フレーム取得・表示</span><span class="hl-code">
    </span><span class="hl-identifier">frame_list</span><span class="hl-code"> = </span><span class="hl-identifier">dbg</span><span class="hl-code">.</span><span class="hl-identifier">get_stack_trace</span><span class="hl-brackets">(</span><span class="hl-number">5</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">for</span><span class="hl-code"> </span><span class="hl-identifier">f</span><span class="hl-code"> </span><span class="hl-reserved">in</span><span class="hl-code"> </span><span class="hl-identifier">frame_list</span><span class="hl-code">:
      </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">%d, 0x%08X, 0x%08X,</span><span class="hl-quotes">&quot;</span><span class="hl-code"> % \
          </span><span class="hl-brackets">(</span><span class="hl-identifier">f</span><span class="hl-code">.</span><span class="hl-identifier">FrameNumber</span><span class="hl-code">, </span><span class="hl-identifier">f</span><span class="hl-code">.</span><span class="hl-identifier">InstructionOffset</span><span class="hl-code">, </span><span class="hl-identifier">f</span><span class="hl-code">.</span><span class="hl-identifier">ReturnOffset</span><span class="hl-brackets">)</span><span class="hl-code">,
      </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">0x%08X, 0x%08X, 0x%08X, 0x%08X</span><span class="hl-quotes">&quot;</span><span class="hl-code"> % \
          </span><span class="hl-brackets">(</span><span class="hl-identifier">f</span><span class="hl-code">.</span><span class="hl-identifier">Params</span><span class="hl-brackets">[</span><span class="hl-number">0</span><span class="hl-brackets">]</span><span class="hl-code">, </span><span class="hl-identifier">f</span><span class="hl-code">.</span><span class="hl-identifier">Params</span><span class="hl-brackets">[</span><span class="hl-number">1</span><span class="hl-brackets">]</span><span class="hl-code">, </span><span class="hl-identifier">f</span><span class="hl-code">.</span><span class="hl-identifier">Params</span><span class="hl-brackets">[</span><span class="hl-number">2</span><span class="hl-brackets">]</span><span class="hl-code">, </span><span class="hl-identifier">f</span><span class="hl-code">.</span><span class="hl-identifier">Params</span><span class="hl-brackets">[</span><span class="hl-number">3</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-comment"># dump_context_list()でレジスタを取得・表示</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">Registers:</span><span class="hl-quotes">&quot;</span><span class="hl-code">
    </span><span class="hl-identifier">reg</span><span class="hl-code"> = </span><span class="hl-identifier">dbg</span><span class="hl-code">.</span><span class="hl-identifier">dump_context_list</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">for</span><span class="hl-code"> </span><span class="hl-identifier">n</span><span class="hl-code">, </span><span class="hl-identifier">v</span><span class="hl-code"> </span><span class="hl-reserved">in</span><span class="hl-code"> </span><span class="hl-identifier">reg</span><span class="hl-code">.</span><span class="hl-identifier">items</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">:
      </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-identifier">n</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">:</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">v</span><span class="hl-brackets">)</span><span class="hl-code">
 
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_STATUS_GO</span><span class="hl-code">
 
  </span><span class="hl-reserved">def</span><span class="hl-code"> </span><span class="hl-identifier">CreateProcess</span><span class="hl-brackets">(</span><span class="hl-identifier">self</span><span class="hl-code">, </span><span class="hl-identifier">dbg</span><span class="hl-code">, \
      </span><span class="hl-identifier">ImageFileHandle</span><span class="hl-code">, </span><span class="hl-identifier">Handle</span><span class="hl-code">, </span><span class="hl-identifier">BaseOffset</span><span class="hl-code">, </span><span class="hl-identifier">ModuleSize</span><span class="hl-code">, </span><span class="hl-identifier">ModuleName</span><span class="hl-code">, \
      </span><span class="hl-identifier">ImageName</span><span class="hl-code">, </span><span class="hl-identifier">CheckSum</span><span class="hl-code">, </span><span class="hl-identifier">TimeDateStamp</span><span class="hl-code">, </span><span class="hl-identifier">InitialThreadHandle</span><span class="hl-code">, \
      </span><span class="hl-identifier">ThreadDataOffset</span><span class="hl-code">, </span><span class="hl-identifier">StartOffset</span><span class="hl-code"> \
      </span><span class="hl-brackets">)</span><span class="hl-code">:
    </span><span class="hl-identifier">main_symstr</span><span class="hl-code"> = </span><span class="hl-identifier">modname_exe</span><span class="hl-code"> + </span><span class="hl-quotes">&quot;</span><span class="hl-string">!main</span><span class="hl-quotes">&quot;</span><span class="hl-code">
    </span><span class="hl-identifier">main_addr</span><span class="hl-code"> = </span><span class="hl-identifier">dbg</span><span class="hl-code">.</span><span class="hl-identifier">resolve_symbol</span><span class="hl-brackets">(</span><span class="hl-identifier">main_symstr</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-identifier">main_symstr</span><span class="hl-code"> + </span><span class="hl-quotes">&quot;</span><span class="hl-string"> at </span><span class="hl-quotes">&quot;</span><span class="hl-code"> + </span><span class="hl-builtin">hex</span><span class="hl-brackets">(</span><span class="hl-identifier">main_addr</span><span class="hl-brackets">)</span><span class="hl-code">, 
    </span><span class="hl-identifier">dbg</span><span class="hl-code">.</span><span class="hl-identifier">bp_set</span><span class="hl-brackets">(</span><span class="hl-identifier">dbg</span><span class="hl-code">.</span><span class="hl-identifier">resolve_symbol</span><span class="hl-brackets">(</span><span class="hl-identifier">modname_exe</span><span class="hl-code"> + </span><span class="hl-quotes">&quot;</span><span class="hl-string">!main</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string"> : break point set</span><span class="hl-quotes">&quot;</span><span class="hl-code">
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_STATUS_NO_CHANGE</span><span class="hl-code">
 
</span><span class="hl-identifier">event_handler</span><span class="hl-code"> = </span><span class="hl-identifier">MyDbgEventHandler</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-identifier">output_handler</span><span class="hl-code"> = </span><span class="hl-identifier">MyDbgOutputHandler</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-identifier">dbg</span><span class="hl-code"> = </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">ProcessCreator</span><span class="hl-brackets">(</span><span class="hl-code"> \
    </span><span class="hl-identifier">command_line</span><span class="hl-code"> = </span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-number">1</span><span class="hl-brackets">]</span><span class="hl-code">, \
    </span><span class="hl-identifier">output_callbacks_sink</span><span class="hl-code"> = </span><span class="hl-identifier">output_handler</span><span class="hl-code">, \
    </span><span class="hl-identifier">event_callbacks_sink</span><span class="hl-code"> = </span><span class="hl-identifier">event_handler</span><span class="hl-code">, \
    </span><span class="hl-identifier">dbg_eng_dll_path</span><span class="hl-code"> = </span><span class="hl-identifier">DBGENG_DLL_PATH</span><span class="hl-code"> \
    </span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-identifier">dbg</span><span class="hl-code">.</span><span class="hl-identifier">idebug_symbols</span><span class="hl-code">.</span><span class="hl-identifier">AddSymbolOptions</span><span class="hl-brackets">(</span><span class="hl-number">0</span><span class="hl-identifier">x80000000</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-identifier">quit_event</span><span class="hl-code"> = </span><span class="hl-identifier">threading</span><span class="hl-code">.</span><span class="hl-identifier">Event</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-identifier">dbg</span><span class="hl-code">.</span><span class="hl-identifier">event_loop_with_quit_event</span><span class="hl-brackets">(</span><span class="hl-identifier">quit_event</span><span class="hl-brackets">)</span></pre></div>
<p class="paragraph">
実行例：(シンボル関連の出力は省略しています)
<br />
</p>
<pre class="plugin_pre">
&gt; 04_break_at_main2.py helloworld.exe
(...)
helloworld!main at 0x401010L  : break point set
ModLoad: 7c940000 7c9df000   ntdll.dll
ModLoad: 7c800000 7c933000   C:\WINDOWS\system32\kernel32.dll
Breakpoint 0 hit
&lt;&lt;&lt;StackFrame(TOP5)&gt;&gt;&gt;
Offset :  0x401010L
#,INSTR,RTN,P0,P1,P2,P3
0, 0x00401010, 0x0040131E, 0x00000001, 0x00383860, 0x00383898, 0x348A6A2B
1, 0x0040131E, 0x7C817077, 0x00000000, 0x00000000, 0x7FFDC000, 0xFFFFFFFF80546CFD
2, 0x7C817077, 0x00000000, 0x00401374, 0x00000000, 0x78746341, 0x00000020
3, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000
0, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000
Registers:
Callback failed with 80004005
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ !!
Hello, World!
(RETURNキー押下)

&gt;
</pre>

<p class="paragraph">
スタックフレームの取得は成功しているが、レジスタの取得に失敗しています。
<br />
これは dump_context_list() -&gt; get_register_value() -&gt; IDebugRegisters.GetValue() の順で呼び、その戻り値を
<br />
</p>
<pre>return reg_value.u.I32
</pre>
<p class="paragraph">
として返しているが、このメンバアクセスがPyDbgEngインストール時にPerlで自動変換したTLBファイルと異なっているためです。。TLBファイルの当該定義を手動で修正すれば直りますが、残念ながら、Perlによる自動変換で他にも何箇所か実際の定義とずれが生じているところもあるようです。
<br />
例えば今回の例なら、スタックフレームの表示で戻り先のアドレスのシンボル名を取得しようとget_symbol()を使おうとしましたが、こちらも正常に動作しませんでした。
<br />
</p>

<p class="paragraph">
こうした修正箇所をすべて手作業で修正するのは非常に手間です。
<br />
そこで、次の例ではWinDBGエンジンの提供するデバッガコマンドを使ってスタックフレームやレジスタを表示させてみます。スクリプトで値を取得して処理させるには向いていませんが、とりあえず値を表示するだけであればこのアプローチでも大丈夫でしょう。
<br />
</p>

<h4 id="ida42b39">04_break_at_main3.py : デバッガコマンドを実行してみる</h4>

<p class="paragraph">
execute()に文字列でデバッガコマンドを渡せば実行できます。
<br />
</p>

<p class="paragraph">
04_break_at_main3.py:
<br />
</p>
<div class="hl-main"><pre><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">sys</span><span class="hl-code">
</span><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">threading</span><span class="hl-code">
</span><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">os</span><span class="hl-code">
</span><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">
 
</span><span class="hl-identifier">DBGENG_DLL_PATH</span><span class="hl-code"> = </span><span class="hl-quotes">&quot;</span><span class="hl-string">C:</span><span class="hl-special">\\</span><span class="hl-string">WinDDK</span><span class="hl-special">\\</span><span class="hl-string">7600.16385.1</span><span class="hl-special">\\</span><span class="hl-string">Debuggers</span><span class="hl-quotes">&quot;</span><span class="hl-code">
 
</span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-number">2</span><span class="hl-code"> &gt; </span><span class="hl-builtin">len</span><span class="hl-brackets">(</span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">argv</span><span class="hl-brackets">)</span><span class="hl-code">:
  </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">usage: %s *.exe</span><span class="hl-quotes">&quot;</span><span class="hl-code"> % </span><span class="hl-brackets">(</span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-number">0</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">
  </span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-identifier">modname_exe</span><span class="hl-code"> = </span><span class="hl-identifier">os</span><span class="hl-code">.</span><span class="hl-identifier">path</span><span class="hl-code">.</span><span class="hl-identifier">basename</span><span class="hl-brackets">(</span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-number">1</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">.</span><span class="hl-identifier">replace</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">.exe</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-reserved">class</span><span class="hl-code"> </span><span class="hl-identifier">MyDbgOutputHandler</span><span class="hl-brackets">(</span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">IDebugOutputCallbacksSink</span><span class="hl-brackets">)</span><span class="hl-code">:
    </span><span class="hl-reserved">def</span><span class="hl-code"> </span><span class="hl-identifier">Output</span><span class="hl-brackets">(</span><span class="hl-identifier">self</span><span class="hl-code">, </span><span class="hl-identifier">this</span><span class="hl-code">, </span><span class="hl-identifier">Mask</span><span class="hl-code">, </span><span class="hl-identifier">Text</span><span class="hl-brackets">)</span><span class="hl-code">:
        </span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">stdout</span><span class="hl-code">.</span><span class="hl-identifier">write</span><span class="hl-brackets">(</span><span class="hl-identifier">Text</span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-reserved">class</span><span class="hl-code"> </span><span class="hl-identifier">MyDbgEventHandler</span><span class="hl-brackets">(</span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">IDebugEventCallbacksSink</span><span class="hl-brackets">)</span><span class="hl-code">:
 
  </span><span class="hl-reserved">def</span><span class="hl-code"> </span><span class="hl-identifier">GetInterestMask</span><span class="hl-brackets">(</span><span class="hl-identifier">self</span><span class="hl-brackets">)</span><span class="hl-code">:
    </span><span class="hl-reserved">return</span><span class="hl-code"> \
        </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_EVENT_BREAKPOINT</span><span class="hl-code"> | \
        </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_EVENT_CREATE_PROCESS</span><span class="hl-code"> | \
        </span><span class="hl-number">0</span><span class="hl-code">
 
  </span><span class="hl-reserved">def</span><span class="hl-code"> </span><span class="hl-identifier">Breakpoint</span><span class="hl-brackets">(</span><span class="hl-identifier">self</span><span class="hl-code">, </span><span class="hl-identifier">dbg</span><span class="hl-code">, \
      </span><span class="hl-identifier">Offset</span><span class="hl-code">, </span><span class="hl-identifier">Id</span><span class="hl-code">, </span><span class="hl-identifier">BreakType</span><span class="hl-code">, </span><span class="hl-identifier">ProcType</span><span class="hl-code">, </span><span class="hl-identifier">Flags</span><span class="hl-code">, \
      </span><span class="hl-identifier">DataSize</span><span class="hl-code">, </span><span class="hl-identifier">DataAccessType</span><span class="hl-code">, </span><span class="hl-identifier">PassCount</span><span class="hl-code">, </span><span class="hl-identifier">CurrentPassCount</span><span class="hl-code">, \
      </span><span class="hl-identifier">MatchThread</span><span class="hl-code">, </span><span class="hl-identifier">CommandSize</span><span class="hl-code">, </span><span class="hl-identifier">OffsetExpressionSize</span><span class="hl-brackets">)</span><span class="hl-code">:
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">breakin!</span><span class="hl-quotes">&quot;</span><span class="hl-code">
    </span><span class="hl-identifier">dbg</span><span class="hl-code">.</span><span class="hl-identifier">execute</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">r</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-identifier">dbg</span><span class="hl-code">.</span><span class="hl-identifier">execute</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">kb</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-quotes">&quot;</span><span class="hl-code">
 
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_STATUS_GO</span><span class="hl-code">
 
  </span><span class="hl-reserved">def</span><span class="hl-code"> </span><span class="hl-identifier">CreateProcess</span><span class="hl-brackets">(</span><span class="hl-identifier">self</span><span class="hl-code">, </span><span class="hl-identifier">dbg</span><span class="hl-code">, \
      </span><span class="hl-identifier">ImageFileHandle</span><span class="hl-code">, </span><span class="hl-identifier">Handle</span><span class="hl-code">, </span><span class="hl-identifier">BaseOffset</span><span class="hl-code">, </span><span class="hl-identifier">ModuleSize</span><span class="hl-code">, </span><span class="hl-identifier">ModuleName</span><span class="hl-code">, \
      </span><span class="hl-identifier">ImageName</span><span class="hl-code">, </span><span class="hl-identifier">CheckSum</span><span class="hl-code">, </span><span class="hl-identifier">TimeDateStamp</span><span class="hl-code">, </span><span class="hl-identifier">InitialThreadHandle</span><span class="hl-code">, \
      </span><span class="hl-identifier">ThreadDataOffset</span><span class="hl-code">, </span><span class="hl-identifier">StartOffset</span><span class="hl-code"> \
      </span><span class="hl-brackets">)</span><span class="hl-code">:
    </span><span class="hl-identifier">dbg</span><span class="hl-code">.</span><span class="hl-identifier">execute</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">!sym noisy</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-identifier">main_symstr</span><span class="hl-code"> = </span><span class="hl-identifier">modname_exe</span><span class="hl-code"> + </span><span class="hl-quotes">&quot;</span><span class="hl-string">!main</span><span class="hl-quotes">&quot;</span><span class="hl-code">
    </span><span class="hl-identifier">dbg</span><span class="hl-code">.</span><span class="hl-identifier">execute</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">bp </span><span class="hl-quotes">&quot;</span><span class="hl-code"> + </span><span class="hl-identifier">main_symstr</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_STATUS_NO_CHANGE</span><span class="hl-code">
 
</span><span class="hl-identifier">event_handler</span><span class="hl-code"> = </span><span class="hl-identifier">MyDbgEventHandler</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-identifier">output_handler</span><span class="hl-code"> = </span><span class="hl-identifier">MyDbgOutputHandler</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-identifier">dbg</span><span class="hl-code"> = </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">ProcessCreator</span><span class="hl-brackets">(</span><span class="hl-code"> \
    </span><span class="hl-identifier">command_line</span><span class="hl-code"> = </span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-number">1</span><span class="hl-brackets">]</span><span class="hl-code">, \
    </span><span class="hl-identifier">output_callbacks_sink</span><span class="hl-code"> = </span><span class="hl-identifier">output_handler</span><span class="hl-code">, \
    </span><span class="hl-identifier">event_callbacks_sink</span><span class="hl-code"> = </span><span class="hl-identifier">event_handler</span><span class="hl-code">, \
    </span><span class="hl-identifier">dbg_eng_dll_path</span><span class="hl-code"> = </span><span class="hl-identifier">DBGENG_DLL_PATH</span><span class="hl-code"> \
    </span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-identifier">quit_event</span><span class="hl-code"> = </span><span class="hl-identifier">threading</span><span class="hl-code">.</span><span class="hl-identifier">Event</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-identifier">dbg</span><span class="hl-code">.</span><span class="hl-identifier">event_loop_with_quit_event</span><span class="hl-brackets">(</span><span class="hl-identifier">quit_event</span><span class="hl-brackets">)</span></pre></div>

<p class="paragraph">
実行例：(シンボル関連の出力は省略しています)
<br />
</p>
<pre class="plugin_pre">
&gt; 04_break_at_main3.py helloworld.exe
(...)
ModLoad: 00400000 00423000   helloworld.exe
!sym noisy
noisy mode - symbol prompts on
bp helloworld!main
ModLoad: 7c940000 7c9df000   ntdll.dll
ModLoad: 7c800000 7c933000   C:\WINDOWS\system32\kernel32.dll
Breakpoint 0 hit
breakin!
r
eax=00383898 ebx=7ffde000 ecx=00000001 edx=0041eb10 esi=00000000 edi=00000000
eip=00401010 esp=0012ff7c ebp=0012ffc0 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
helloworld!main:
00401010 55              push    ebp
kb
ChildEBP RetAddr  Args to Child
0012ff78 0040131e 00000001 00383860 00383898 helloworld!main
0012ffc0 7c817077 00000000 00000000 7ffde000 helloworld!__tmainCRTStartup+0x10b
0012fff0 00000000 00401374 00000000 78746341 kernel32!BaseProcessStart+0x23

Hello, World!
(RETURNキー押下)

&gt;
</pre>
<p class="paragraph">
WinDBGなどで &quot;bp&quot;, &quot;r&quot;, &quot;kb&quot; コマンドを実行したときと同様の表示を確認できました。
<br />
</p>

<h3 id="idc5a20f">対話形式のデバッガを作成してみる</h3>

<p class="paragraph">
スクリプトによる自動化とは趣旨が異なってしまいますが、execute()を使うことで対話形式のデバッガを作成することも可能です。
<br />
</p>

<h4 id="id1aaa56">05_interact1.py : 簡単な対話形式</h4>

<p class="paragraph">
対話形式を実装するポイントは次の3点です。
<br />
</p>
<ol><li> イベントハンドラは空にしておく。</li>
<li> wait_for_event()が真を返したら対話形式に移行する。</li>
<li> execute()の実行後、ステータスを確認しデバッガにブレークした状態でなければ、またwait_for_event()に戻る。</li></ol>

<p class="paragraph">
05_interact1.py:
<br />
</p>
<div class="hl-main"><pre><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">sys</span><span class="hl-code">
</span><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">threading</span><span class="hl-code">
</span><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">
</span><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">ctypes</span><span class="hl-code">
 
</span><span class="hl-identifier">DBGENG_DLL_PATH</span><span class="hl-code"> = </span><span class="hl-quotes">&quot;</span><span class="hl-string">C:</span><span class="hl-special">\\</span><span class="hl-string">WinDDK</span><span class="hl-special">\\</span><span class="hl-string">7600.16385.1</span><span class="hl-special">\\</span><span class="hl-string">Debuggers</span><span class="hl-quotes">&quot;</span><span class="hl-code">
 
</span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-number">2</span><span class="hl-code"> &gt; </span><span class="hl-builtin">len</span><span class="hl-brackets">(</span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">argv</span><span class="hl-brackets">)</span><span class="hl-code">:
  </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">usage: %s *.exe</span><span class="hl-quotes">&quot;</span><span class="hl-code"> % </span><span class="hl-brackets">(</span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-number">0</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">
  </span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-reserved">class</span><span class="hl-code"> </span><span class="hl-identifier">MyDbgOutputHandler</span><span class="hl-brackets">(</span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">IDebugOutputCallbacksSink</span><span class="hl-brackets">)</span><span class="hl-code">:
  </span><span class="hl-reserved">def</span><span class="hl-code"> </span><span class="hl-identifier">Output</span><span class="hl-brackets">(</span><span class="hl-identifier">self</span><span class="hl-code">, </span><span class="hl-identifier">dbg</span><span class="hl-code">, </span><span class="hl-identifier">Mask</span><span class="hl-code">, </span><span class="hl-identifier">Text</span><span class="hl-brackets">)</span><span class="hl-code">:
    </span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">stdout</span><span class="hl-code">.</span><span class="hl-identifier">write</span><span class="hl-brackets">(</span><span class="hl-identifier">Text</span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-comment"># イベントハンドラは空にしておく。</span><span class="hl-code">
</span><span class="hl-reserved">class</span><span class="hl-code"> </span><span class="hl-identifier">MyDbgEventHandler</span><span class="hl-brackets">(</span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">IDebugEventCallbacksSink</span><span class="hl-brackets">)</span><span class="hl-code">:
  </span><span class="hl-reserved">def</span><span class="hl-code"> </span><span class="hl-identifier">GetInterestMask</span><span class="hl-brackets">(</span><span class="hl-identifier">self</span><span class="hl-brackets">)</span><span class="hl-code">:
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">
 
</span><span class="hl-identifier">event_handler</span><span class="hl-code"> = </span><span class="hl-identifier">MyDbgEventHandler</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-identifier">output_handler</span><span class="hl-code"> = </span><span class="hl-identifier">MyDbgOutputHandler</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-identifier">dbg</span><span class="hl-code"> = </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">ProcessCreator</span><span class="hl-brackets">(</span><span class="hl-code"> \
    </span><span class="hl-identifier">command_line</span><span class="hl-code"> = </span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-number">1</span><span class="hl-brackets">]</span><span class="hl-code">, \
    </span><span class="hl-identifier">event_callbacks_sink</span><span class="hl-code"> = </span><span class="hl-identifier">event_handler</span><span class="hl-code">, \
    </span><span class="hl-identifier">output_callbacks_sink</span><span class="hl-code"> = </span><span class="hl-identifier">output_handler</span><span class="hl-code">, \
    </span><span class="hl-identifier">dbg_eng_dll_path</span><span class="hl-code"> = </span><span class="hl-identifier">DBGENG_DLL_PATH</span><span class="hl-code"> \
    </span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-comment"># 初期イベントで一旦ブレークする</span><span class="hl-code">
</span><span class="hl-identifier">dbg</span><span class="hl-code">.</span><span class="hl-identifier">idebug_control</span><span class="hl-code">.</span><span class="hl-identifier">AddEngineOptions</span><span class="hl-brackets">(</span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_ENGOPT_INITIAL_BREAK</span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-reserved">while</span><span class="hl-code"> </span><span class="hl-reserved">True</span><span class="hl-code">:
  </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-identifier">dbg</span><span class="hl-code">.</span><span class="hl-identifier">wait_for_event</span><span class="hl-brackets">(</span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">Defines</span><span class="hl-code">.</span><span class="hl-identifier">INFINITE</span><span class="hl-brackets">)</span><span class="hl-code">:
    </span><span class="hl-comment"># デバッガにブレーク</span><span class="hl-code">
    </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">debugger break</span><span class="hl-quotes">&quot;</span><span class="hl-code">
    </span><span class="hl-reserved">while</span><span class="hl-code"> </span><span class="hl-reserved">True</span><span class="hl-code">:
      </span><span class="hl-identifier">c</span><span class="hl-code"> = </span><span class="hl-builtin">raw_input</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">DBG&gt;</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">
      </span><span class="hl-identifier">dbg</span><span class="hl-code">.</span><span class="hl-identifier">execute</span><span class="hl-brackets">(</span><span class="hl-identifier">c</span><span class="hl-brackets">)</span><span class="hl-code">
      </span><span class="hl-identifier">status</span><span class="hl-code"> = </span><span class="hl-identifier">dbg</span><span class="hl-code">.</span><span class="hl-identifier">idebug_control</span><span class="hl-code">.</span><span class="hl-identifier">GetExecutionStatus</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">
      </span><span class="hl-comment"># execute()の結果がデバッガブレークでなければ wait_for_event() に戻る</span><span class="hl-code">
      </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-identifier">status</span><span class="hl-code"> != </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_STATUS_BREAK</span><span class="hl-code">:
        </span><span class="hl-reserved">break</span><span class="hl-code">
  </span><span class="hl-reserved">else</span><span class="hl-code">:
    </span><span class="hl-reserved">break</span></pre></div>
<p class="paragraph">
実行例：
<br />
</p>
<pre class="plugin_pre">
&gt; 05_interact1.py helloworld.exe
(...)
ModLoad: 00400000 00423000   helloworld.exe
ModLoad: 7c940000 7c9df000   ntdll.dll
ModLoad: 7c800000 7c933000   C:\WINDOWS\system32\kernel32.dll
(b30.99c): Break instruction exception - code 80000003 (first chance)
debugger break
DBG&gt;kb
kb
ChildEBP RetAddr  Args to Child
0012fb1c 7c9802ed 7ffdf000 7ffda000 00000000 ntdll!DbgBreakPoint
0012fc94 7c95fad7 0012fd30 7c940000 0012fce0 ntdll!LdrpInitializeProcess+0x1014
0012fd1c 7c94e457 0012fd30 7c940000 00000000 ntdll!_LdrpInitialize+0x183
00000000 00000000 00000000 00000000 00000000 ntdll!KiUserApcDispatcher+0x7
DBG&gt;r
r
eax=00241eb4 ebx=7ffda000 ecx=00000001 edx=00000002 esi=00241f48 edi=00241eb4
eip=7c94120e esp=0012fb20 ebp=0012fc94 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
ntdll!DbgBreakPoint:
7c94120e cc              int     3
DBG&gt;g
g
Hello, World!
(RETURNキー押下)

&gt;
</pre>

<h4 id="idc15ca6">05_interact2.py : 任意のタイミングでデバッガにブレークさせる</h4>

<p class="paragraph">
WinDBGやCDB, NTSDなどは Ctrl-C, Ctrl-BREAK で任意のタイミングでデバッガにブレークさせることが出来ます。
<br />
WinDBG拡張でこれを実現するには、ブレークの引き金を検出するスレッドを走らせておき、検出されたらIDebugControl.SetInterrupt()を呼びます。
<br />
</p>

<p class="paragraph">
このような動作をPythonで実装するための雛形を次の記事で作っています。
<br />
</p>
<ul><li> <a href="./view-932.html" >Python/codepiece/threading, event, console, Ctrl-C</a></li></ul>

<p class="paragraph">
この雛形を流用して組み立ててみたのが次のコードです。
<br />
05_interact2.py:
<br />
</p>
<div class="hl-main"><pre><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">sys</span><span class="hl-code">
</span><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">threading</span><span class="hl-code">
</span><span class="hl-reserved">import</span><span class="hl-code"> </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">
 
</span><span class="hl-identifier">DBGENG_DLL_PATH</span><span class="hl-code"> = </span><span class="hl-quotes">&quot;</span><span class="hl-string">C:</span><span class="hl-special">\\</span><span class="hl-string">WinDDK</span><span class="hl-special">\\</span><span class="hl-string">7600.16385.1</span><span class="hl-special">\\</span><span class="hl-string">Debuggers</span><span class="hl-quotes">&quot;</span><span class="hl-code">
 
</span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-number">2</span><span class="hl-code"> &gt; </span><span class="hl-builtin">len</span><span class="hl-brackets">(</span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">argv</span><span class="hl-brackets">)</span><span class="hl-code">:
  </span><span class="hl-reserved">print</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">usage: %s *.exe</span><span class="hl-quotes">&quot;</span><span class="hl-code"> % </span><span class="hl-brackets">(</span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-number">0</span><span class="hl-brackets">]</span><span class="hl-brackets">)</span><span class="hl-code">
  </span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-reserved">class</span><span class="hl-code"> </span><span class="hl-identifier">MyDbgOutputHandler</span><span class="hl-brackets">(</span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">IDebugOutputCallbacksSink</span><span class="hl-brackets">)</span><span class="hl-code">:
  </span><span class="hl-reserved">def</span><span class="hl-code"> </span><span class="hl-identifier">Output</span><span class="hl-brackets">(</span><span class="hl-identifier">self</span><span class="hl-code">, </span><span class="hl-identifier">dbg</span><span class="hl-code">, </span><span class="hl-identifier">Mask</span><span class="hl-code">, </span><span class="hl-identifier">Text</span><span class="hl-brackets">)</span><span class="hl-code">:
    </span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">stdout</span><span class="hl-code">.</span><span class="hl-identifier">write</span><span class="hl-brackets">(</span><span class="hl-identifier">Text</span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-identifier">output_handler</span><span class="hl-code"> = </span><span class="hl-identifier">MyDbgOutputHandler</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-comment"># イベントハンドラを省略し、デフォルトのもので済ませてしまう。</span><span class="hl-code">
</span><span class="hl-identifier">dbg</span><span class="hl-code"> = </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">ProcessCreator</span><span class="hl-brackets">(</span><span class="hl-code"> \
    </span><span class="hl-identifier">command_line</span><span class="hl-code"> = </span><span class="hl-identifier">sys</span><span class="hl-code">.</span><span class="hl-identifier">argv</span><span class="hl-brackets">[</span><span class="hl-number">1</span><span class="hl-brackets">]</span><span class="hl-code">, \
    </span><span class="hl-identifier">output_callbacks_sink</span><span class="hl-code"> = </span><span class="hl-identifier">output_handler</span><span class="hl-code">, \
    </span><span class="hl-identifier">dbg_eng_dll_path</span><span class="hl-code"> = </span><span class="hl-identifier">DBGENG_DLL_PATH</span><span class="hl-code"> \
    </span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-comment"># デバッグループ</span><span class="hl-code">
</span><span class="hl-reserved">def</span><span class="hl-code"> </span><span class="hl-identifier">debugger_thread</span><span class="hl-brackets">(</span><span class="hl-identifier">dbg</span><span class="hl-brackets">)</span><span class="hl-code">:
  </span><span class="hl-reserved">while</span><span class="hl-code"> </span><span class="hl-reserved">True</span><span class="hl-code">:
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-identifier">dbg</span><span class="hl-code">.</span><span class="hl-identifier">wait_for_event</span><span class="hl-brackets">(</span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">Defines</span><span class="hl-code">.</span><span class="hl-identifier">INFINITE</span><span class="hl-brackets">)</span><span class="hl-code">:
      </span><span class="hl-reserved">while</span><span class="hl-code"> </span><span class="hl-reserved">True</span><span class="hl-code">:
        </span><span class="hl-identifier">c</span><span class="hl-code"> = </span><span class="hl-quotes">&quot;</span><span class="hl-quotes">&quot;</span><span class="hl-code">
        </span><span class="hl-reserved">try</span><span class="hl-code">:
          </span><span class="hl-identifier">c</span><span class="hl-code"> = </span><span class="hl-builtin">raw_input</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">DBG&gt;</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">
        </span><span class="hl-reserved">except</span><span class="hl-code"> </span><span class="hl-reserved">EOFError</span><span class="hl-code">:
          </span><span class="hl-comment"># プロンプト表示中のCtrl-Cは無視する</span><span class="hl-code">
          </span><span class="hl-reserved">pass</span><span class="hl-code">
        </span><span class="hl-identifier">dbg</span><span class="hl-code">.</span><span class="hl-identifier">execute</span><span class="hl-brackets">(</span><span class="hl-identifier">c</span><span class="hl-brackets">)</span><span class="hl-code">
        </span><span class="hl-identifier">status</span><span class="hl-code"> = </span><span class="hl-identifier">dbg</span><span class="hl-code">.</span><span class="hl-identifier">idebug_control</span><span class="hl-code">.</span><span class="hl-identifier">GetExecutionStatus</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">
        </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-identifier">status</span><span class="hl-code"> != </span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_STATUS_BREAK</span><span class="hl-code">:
          </span><span class="hl-reserved">break</span><span class="hl-code">
    </span><span class="hl-reserved">else</span><span class="hl-code">:
      </span><span class="hl-reserved">break</span><span class="hl-code">
 
</span><span class="hl-identifier">t</span><span class="hl-code"> = </span><span class="hl-identifier">threading</span><span class="hl-code">.</span><span class="hl-identifier">Thread</span><span class="hl-brackets">(</span><span class="hl-identifier">target</span><span class="hl-code">=</span><span class="hl-identifier">debugger_thread</span><span class="hl-code">, </span><span class="hl-identifier">args</span><span class="hl-code">=</span><span class="hl-brackets">(</span><span class="hl-identifier">dbg</span><span class="hl-code">,</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-identifier">t</span><span class="hl-code">.</span><span class="hl-identifier">start</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">
 
</span><span class="hl-comment"># Ctrl-Cによるデバッガブレークの検出ループ</span><span class="hl-code">
</span><span class="hl-reserved">while</span><span class="hl-code"> </span><span class="hl-reserved">True</span><span class="hl-code">:
  </span><span class="hl-reserved">try</span><span class="hl-code">:
    </span><span class="hl-comment"># 1秒間ずつスレッドの終了チェック</span><span class="hl-code">
    </span><span class="hl-identifier">t</span><span class="hl-code">.</span><span class="hl-identifier">join</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-reserved">not</span><span class="hl-code"> </span><span class="hl-identifier">t</span><span class="hl-code">.</span><span class="hl-identifier">isAlive</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">:
      </span><span class="hl-reserved">break</span><span class="hl-code">
  </span><span class="hl-reserved">except</span><span class="hl-code"> </span><span class="hl-reserved">KeyboardInterrupt</span><span class="hl-code">:
    </span><span class="hl-comment"># デバッガブレーク発生</span><span class="hl-code">
    </span><span class="hl-identifier">dbg</span><span class="hl-code">.</span><span class="hl-identifier">idebug_control</span><span class="hl-code">.</span><span class="hl-identifier">SetInterrupt</span><span class="hl-brackets">(</span><span class="hl-identifier">PyDbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DbgEng</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG_INTERRUPT_ACTIVE</span><span class="hl-brackets">)</span></pre></div>

<p class="paragraph">
実行例は省略します。notepad.exeなどを動かして遊んでみてください。helloworld.exeなどコンソールアプリで標準入力を読む場合などは、タイミングによってはデバッガ側ではなくアプリ側でCtrl-Cを受信し、思うような動きにならない場合がありますので注意してください。
<br />
</p>

<h3 id="id19be54">まとめ</h3>

<p class="paragraph">
PyDbgEngライブラリを使い、WinDBGの拡張機能を使ったデバッガを作ってみました。簡単な例ではありましたが、これらをベースにして独自のデバッガやフォレンジックツールを組み上げてみてください。
<br />
ただし、TLBファイルの自動生成の限界など使っていく上でトラブルに遭遇しやすいことも確かです。大抵はCOM, TLB絡みの問題だと思いますので、手に負えない様であれば後半紹介したように直接デバッガコマンドを叩いてしまうというアプローチも試してみてください。
<br />
</p>

<p class="paragraph">
それでは楽しい楽しいグレーゾーンPythonをエンジョイしてください。
<br />
</p>

<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-939.html" title="Python/WinDBG拡張機能その２：pykdを使ってみる">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-932.html" title="Python/codepiece/threading, event, console, Ctrl-C">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-184.html" title="Python">Up</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-184.html" title="Python">Python</a>&nbsp;]</li>
</ul>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/935<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2001 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a target="_blank" href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" target="_blank" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>