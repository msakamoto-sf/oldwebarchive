<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>技術/Android/LogAndLogLevelTips - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">技術/Android/LogAndLogLevelTips</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2011-07-18 19:24:11 &nbsp; / &nbsp; last updated at: 2013-12-04 00:02:43<br>
カテゴリ: <a href="category-58.html">Android</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-1021.html" title="技術/Android/HowToReadSystemLogs">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-997.html" title="技術/Android/PermissionExamples">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-23.html" title="技術">技術</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
android.util.Logでログレベルの調整が分かりづらかったのでメモ。
<br />
公開されている資料をベースに、自分がつまずいた箇所を抜書きしました。
<br />
</p>

<p class="paragraph">
参考：
<br />
</p>
<ul><li> Reading and Writing Logs | Android Developers<ul><li> <a class="externallink" href="http://developer.android.com/guide/developing/debugging/debugging-log.html" target="_blank">http://developer.android.com/guide/developing/debugging/debugging-log.html</a></li></ul></li>
<li> Log | Android Developers<ul><li> <a class="externallink" href="http://developer.android.com/reference/android/util/Log.html" target="_blank">http://developer.android.com/reference/android/util/Log.html</a></li></ul></li>
<li> Android logging - Stack Overflow<ul><li> <a class="externallink" href="http://stackoverflow.com/questions/2018263/android-logging" target="_blank">http://stackoverflow.com/questions/2018263/android-logging</a></li></ul></li></ul>



<hr />
<ul><li><a href="#id829c26">android.util.Logの使い方</a></li>
<li><a href="#id52db77">実機やEmulator上でのログレベル</a><ul><li><a href="#idaff356">ログレベルと出力メソッドについて、Androidのソースコードを確認してみる。</a></li></ul></li>
<li><a href="#id2927ac">実機やEmulator上でのログレベルの調整</a><ul><li><a href="#id16e68b">android.util.Logドキュメントのミス・・・では無いらしい。</a></li></ul></li>
<li><a href="#idf0f258">ProGuardを用いて特定のログレベルを無効化する手法</a></li></ul>
<hr />
<h3 id="id829c26">android.util.Logの使い方</h3>

<p class="paragraph">
staticメソッドとしてv(Verbose) - e(Error)まで5種類が用意されている。他にもassertion用のメソッドであったり、あるログレベルが出力される設定になっているかチェックするisLoggable()メソッドが用意されている。
<br />
引数としてはログを見分けるための&quot;tag&quot;文字列, ログメッセージの2つに加え、例外発生時のStackTrace出力用にThrowableを渡すことも出来る。
<br />
</p>
<div class="hl-main"><pre><span class="hl-identifier">Log</span><span class="hl-code">.</span><span class="hl-identifier">e</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">tag1</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">tag1-error</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-identifier">Log</span><span class="hl-code">.</span><span class="hl-identifier">w</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">tag1</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">tag1-warn</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-identifier">Log</span><span class="hl-code">.</span><span class="hl-identifier">i</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">tag1</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">tag1-info</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-identifier">Log</span><span class="hl-code">.</span><span class="hl-identifier">d</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">tag1</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">tag1-debug</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-identifier">Log</span><span class="hl-code">.</span><span class="hl-identifier">v</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">tag1</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">tag1-verbose</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
 
</span><span class="hl-identifier">Log</span><span class="hl-code">.</span><span class="hl-identifier">e</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">tag2</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">tag2-error</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-identifier">Log</span><span class="hl-code">.</span><span class="hl-identifier">w</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">tag2</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">tag2-warn</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-identifier">Log</span><span class="hl-code">.</span><span class="hl-identifier">i</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">tag2</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">tag2-info</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-identifier">Log</span><span class="hl-code">.</span><span class="hl-identifier">d</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">tag2</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">tag2-debug</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-identifier">Log</span><span class="hl-code">.</span><span class="hl-identifier">v</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">tag2</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">tag2-verbose</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;</span></pre></div>
<p class="paragraph">
実際の出力(DDMSやLogcatなど)：
<br />
</p>
<pre class="plugin_pre">
07-17 16:40:45.434: ERROR/tag1(1218): tag1-error
07-17 16:40:45.434: WARN/tag1(1218): tag1-warn
07-17 16:40:45.434: INFO/tag1(1218): tag1-info
07-17 16:40:45.434: DEBUG/tag1(1218): tag1-debug
07-17 16:40:45.434: VERBOSE/tag1(1218): tag1-verbose
07-17 16:40:45.434: ERROR/tag2(1218): tag2-error
07-17 16:40:45.434: WARN/tag2(1218): tag2-warn
07-17 16:40:45.434: INFO/tag2(1218): tag2-info
07-17 16:40:45.434: DEBUG/tag2(1218): tag2-debug
07-17 16:40:45.434: VERBOSE/tag2(1218): tag2-verbose
</pre>

<h3 id="id52db77">実機やEmulator上でのログレベル</h3>

<p class="paragraph">
実機及びEmulator上でのデフォルトのログレベルは<strong>INFO</strong>である。
<br />
<strong>これはあくまでも isLoggable() がtrueを返すレベル であり、d()やv()が実行されるとINFOレベルであるにも関わらず出力されてしまう。</strong>
<br />
上で示した「実際の出力」では、ログレベルの調整を一切行っていないデフォルト状態(=INFOレベル)であるにも関わらず、 debug, verboseも出力されている。
<br />
</p>

<p class="paragraph">
ログレベルに応じてログ出力を適切にON/OFFするのであれば、次のように if(isLoggable()) で囲む必要がある。
<br />
</p>
<div class="hl-main"><pre><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">Log</span><span class="hl-code">.</span><span class="hl-identifier">isLoggable</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">tag1</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">Log</span><span class="hl-code">.</span><span class="hl-identifier">DEBUG</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">Log</span><span class="hl-code">.</span><span class="hl-identifier">d</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">tag1</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-string">tag1-debug</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>
<p class="paragraph">
勿論、isLoggable()でチェックするtag文字列と出力メソッドに渡すtag文字列は一致している必要がある。でないとチェックする意味がなくなってしまう。
<br />
</p>

<h4 id="idaff356">ログレベルと出力メソッドについて、Androidのソースコードを確認してみる。</h4>

<p class="paragraph">
ログの出力メソッドでは&quot;isLoggable()&quot;相当のフィルタリングを行なっていない、という点について実際にAndroidのソースコードを確認してみる。
<br />
なお以下の説明は &quot;android-4.0.3_r1&quot; tag のソースを用いているが、大筋は &quot;android-2.3.7_r1&quot; tagのソースでも同じであることを確認している。
<br />
</p>

<p class="paragraph">
まず android.util.Log クラスのJavaソースは以下になる。
<br />
frameworks/base/core/java/android/util/Log.java:
<br />
</p>
<div class="hl-main"><pre><span class="hl-reserved">public</span><span class="hl-code"> </span><span >final</span><span class="hl-code"> </span><span class="hl-reserved">class</span><span class="hl-code"> </span><span class="hl-identifier">Log</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
</span><span class="hl-comment">//</span><span class="hl-comment"> ...</span><span class="hl-comment"></span><span class="hl-code">
    </span><span class="hl-reserved">public</span><span class="hl-code"> </span><span >static</span><span class="hl-code"> </span><span class="hl-reserved">native</span><span class="hl-code"> </span><span >boolean</span><span class="hl-code"> </span><span class="hl-identifier">isLoggable</span><span class="hl-brackets">(</span><span class="hl-identifier">String</span><span class="hl-code"> </span><span class="hl-identifier">tag</span><span class="hl-code">, </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">level</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-comment">//</span><span class="hl-comment">...</span><span class="hl-comment"></span><span class="hl-code">
    </span><span class="hl-reserved">public</span><span class="hl-code"> </span><span >static</span><span class="hl-code"> </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">d</span><span class="hl-brackets">(</span><span class="hl-identifier">String</span><span class="hl-code"> </span><span class="hl-identifier">tag</span><span class="hl-code">, </span><span class="hl-identifier">String</span><span class="hl-code"> </span><span class="hl-identifier">msg</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">println_native</span><span class="hl-brackets">(</span><span class="hl-identifier">LOG_ID_MAIN</span><span class="hl-code">, </span><span class="hl-identifier">DEBUG</span><span class="hl-code">, </span><span class="hl-identifier">tag</span><span class="hl-code">, </span><span class="hl-identifier">msg</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-comment">//</span><span class="hl-comment">...</span><span class="hl-comment"></span><span class="hl-code">
    </span><span class="hl-reserved">public</span><span class="hl-code"> </span><span >static</span><span class="hl-code"> </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">d</span><span class="hl-brackets">(</span><span class="hl-identifier">String</span><span class="hl-code"> </span><span class="hl-identifier">tag</span><span class="hl-code">, </span><span class="hl-identifier">String</span><span class="hl-code"> </span><span class="hl-identifier">msg</span><span class="hl-code">, </span><span class="hl-identifier">Throwable</span><span class="hl-code"> </span><span class="hl-identifier">tr</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">println_native</span><span class="hl-brackets">(</span><span class="hl-identifier">LOG_ID_MAIN</span><span class="hl-code">, </span><span class="hl-identifier">DEBUG</span><span class="hl-code">, </span><span class="hl-identifier">tag</span><span class="hl-code">, </span><span class="hl-identifier">msg</span><span class="hl-code"> + </span><span class="hl-quotes">'</span><span class="hl-special">\n</span><span class="hl-quotes">'</span><span class="hl-code"> + </span><span class="hl-identifier">getStackTraceString</span><span class="hl-brackets">(</span><span class="hl-identifier">tr</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-comment">//</span><span class="hl-comment">...</span><span class="hl-comment"></span><span class="hl-code">
    </span><span class="hl-reserved">public</span><span class="hl-code"> </span><span >static</span><span class="hl-code"> </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">i</span><span class="hl-brackets">(</span><span class="hl-identifier">String</span><span class="hl-code"> </span><span class="hl-identifier">tag</span><span class="hl-code">, </span><span class="hl-identifier">String</span><span class="hl-code"> </span><span class="hl-identifier">msg</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">println_native</span><span class="hl-brackets">(</span><span class="hl-identifier">LOG_ID_MAIN</span><span class="hl-code">, </span><span class="hl-identifier">INFO</span><span class="hl-code">, </span><span class="hl-identifier">tag</span><span class="hl-code">, </span><span class="hl-identifier">msg</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-comment">//</span><span class="hl-comment">...</span><span class="hl-comment"></span><span class="hl-code">
    </span><span class="hl-comment">/*</span><span class="hl-comment">*</span><span class="hl-inlinedoc"> @hide </span><span class="hl-comment">*/</span><span class="hl-code"> </span><span class="hl-reserved">public</span><span class="hl-code"> </span><span >static</span><span class="hl-code"> </span><span class="hl-reserved">native</span><span class="hl-code"> </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">println_native</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">bufID</span><span class="hl-code">,
            </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">priority</span><span class="hl-code">, </span><span class="hl-identifier">String</span><span class="hl-code"> </span><span class="hl-identifier">tag</span><span class="hl-code">, </span><span class="hl-identifier">String</span><span class="hl-code"> </span><span class="hl-identifier">msg</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-comment">//</span><span class="hl-comment">...</span><span class="hl-comment"></span></pre></div>

<p class="paragraph">
isLoggable()、およびv(), d(), ... から呼ばれる println_native() はnativeメソッド、つまりC/C++で実装されている。
<br />
そこでJNIのソースを探してみると、以下のファイルで実装されていた。
<br />
frameworks/base/core/jni/android_util_Log.cpp:
<br />
</p>
<div class="hl-main"><pre><span class="hl-comment">//...</span><span class="hl-comment"></span><span class="hl-code">
</span><span >#define</span><span class="hl-code"> </span><span class="hl-identifier">LOG_NAMESPACE</span><span class="hl-code"> </span><span class="hl-quotes">&quot;</span><span class="hl-string">log.tag.</span><span class="hl-quotes">&quot;</span><span ></span><span class="hl-code">
</span><span class="hl-comment">//...</span><span class="hl-comment"></span><span class="hl-code">
 
</span><span class="hl-comment">// isLoggable()の処理：property_get()でpropファイルを調べている。</span><span class="hl-comment"></span><span class="hl-code">
</span><span >static</span><span class="hl-code"> </span><span class="hl-identifier">jboolean</span><span class="hl-code"> </span><span class="hl-identifier">android_util_Log_isLoggable</span><span class="hl-brackets">(</span><span class="hl-identifier">JNIEnv</span><span class="hl-code">* </span><span class="hl-identifier">env</span><span class="hl-code">, </span><span class="hl-identifier">jobject</span><span class="hl-code"> </span><span class="hl-identifier">clazz</span><span class="hl-code">, </span><span class="hl-identifier">jstring</span><span class="hl-code"> </span><span class="hl-identifier">tag</span><span class="hl-code">, </span><span class="hl-identifier">jint</span><span class="hl-code"> </span><span class="hl-identifier">level</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">len</span><span class="hl-code">;
    </span><span >char</span><span class="hl-code"> </span><span class="hl-identifier">key</span><span class="hl-brackets">[</span><span class="hl-identifier">PROPERTY_KEY_MAX</span><span class="hl-brackets">]</span><span class="hl-code">;
    </span><span >char</span><span class="hl-code"> </span><span class="hl-identifier">buf</span><span class="hl-brackets">[</span><span class="hl-identifier">PROPERTY_VALUE_MAX</span><span class="hl-brackets">]</span><span class="hl-code">;
 
</span><span class="hl-comment">// (省略) : エラー処理と、keyに&quot;log.tag.(タグ名)&quot;というprop取得のためのキー名を設定</span><span class="hl-comment"></span><span class="hl-code">
 
    </span><span class="hl-identifier">len</span><span class="hl-code"> = </span><span class="hl-identifier">property_get</span><span class="hl-brackets">(</span><span class="hl-identifier">key</span><span class="hl-code">, </span><span class="hl-identifier">buf</span><span class="hl-code">, </span><span class="hl-quotes">&quot;</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">logLevel</span><span class="hl-code"> = </span><span class="hl-identifier">toLevel</span><span class="hl-brackets">(</span><span class="hl-identifier">buf</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">logLevel</span><span class="hl-code"> &gt;= </span><span class="hl-number">0</span><span class="hl-code"> &amp;&amp; </span><span class="hl-identifier">level</span><span class="hl-code"> &gt;= </span><span class="hl-identifier">logLevel</span><span class="hl-brackets">)</span><span class="hl-code"> ? </span><span class="hl-reserved">true</span><span class="hl-code"> : </span><span class="hl-reserved">false</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-comment">//...</span><span class="hl-comment"></span><span class="hl-code">
 
</span><span class="hl-comment">// println_native()処理：__android_log_buf_write()に処理を委譲</span><span class="hl-comment"></span><span class="hl-code">
</span><span >static</span><span class="hl-code"> </span><span class="hl-identifier">jint</span><span class="hl-code"> </span><span class="hl-identifier">android_util_Log_println_native</span><span class="hl-brackets">(</span><span class="hl-identifier">JNIEnv</span><span class="hl-code">* </span><span class="hl-identifier">env</span><span class="hl-code">, </span><span class="hl-identifier">jobject</span><span class="hl-code"> </span><span class="hl-identifier">clazz</span><span class="hl-code">,
        </span><span class="hl-identifier">jint</span><span class="hl-code"> </span><span class="hl-identifier">bufID</span><span class="hl-code">, </span><span class="hl-identifier">jint</span><span class="hl-code"> </span><span class="hl-identifier">priority</span><span class="hl-code">, </span><span class="hl-identifier">jstring</span><span class="hl-code"> </span><span class="hl-identifier">tagObj</span><span class="hl-code">, </span><span class="hl-identifier">jstring</span><span class="hl-code"> </span><span class="hl-identifier">msgObj</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span >const</span><span class="hl-code"> </span><span >char</span><span class="hl-code">* </span><span class="hl-identifier">tag</span><span class="hl-code"> = </span><span >NULL</span><span class="hl-code">;
    </span><span >const</span><span class="hl-code"> </span><span >char</span><span class="hl-code">* </span><span class="hl-identifier">msg</span><span class="hl-code"> = </span><span >NULL</span><span class="hl-code">;
</span><span class="hl-comment">// (省略) :  エラー処理と、tag, msgにtagObj, msgObjの文字列を設定している。</span><span class="hl-comment"></span><span class="hl-code">
    </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">res</span><span class="hl-code"> = </span><span class="hl-identifier">__android_log_buf_write</span><span class="hl-brackets">(</span><span class="hl-identifier">bufID</span><span class="hl-code">, </span><span class="hl-brackets">(</span><span class="hl-identifier">android_LogPriority</span><span class="hl-brackets">)</span><span class="hl-identifier">priority</span><span class="hl-code">, </span><span class="hl-identifier">tag</span><span class="hl-code">, </span><span class="hl-identifier">msg</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-comment">// ...</span><span class="hl-comment"></span><span class="hl-code">
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">res</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
__android_log_buf_write()というのが出てきたが、こちらはJNIのソース中には見つからない。調べてみると、以下のファイルで実装されていた。
<br />
system/core/liblog/logd_write.c:
<br />
</p>
<div class="hl-main"><pre><span >int</span><span class="hl-code"> </span><span class="hl-identifier">__android_log_buf_write</span><span class="hl-brackets">(</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">bufID</span><span class="hl-code">, </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">prio</span><span class="hl-code">, </span><span >const</span><span class="hl-code"> </span><span >char</span><span class="hl-code"> *</span><span class="hl-identifier">tag</span><span class="hl-code">, </span><span >const</span><span class="hl-code"> </span><span >char</span><span class="hl-code"> *</span><span class="hl-identifier">msg</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span >struct</span><span class="hl-code"> </span><span class="hl-identifier">iovec</span><span class="hl-code"> </span><span class="hl-identifier">vec</span><span class="hl-brackets">[</span><span class="hl-number">3</span><span class="hl-brackets">]</span><span class="hl-code">;
</span><span class="hl-comment">// (省略) : tagとbufIDの調整</span><span class="hl-comment"></span><span class="hl-code">
    </span><span class="hl-identifier">vec</span><span class="hl-brackets">[</span><span class="hl-number">0</span><span class="hl-brackets">]</span><span class="hl-code">.</span><span class="hl-identifier">iov_base</span><span class="hl-code">   = </span><span class="hl-brackets">(</span><span >unsigned</span><span class="hl-code"> </span><span >char</span><span class="hl-code"> *</span><span class="hl-brackets">)</span><span class="hl-code"> &amp;</span><span class="hl-identifier">prio</span><span class="hl-code">;
    </span><span class="hl-identifier">vec</span><span class="hl-brackets">[</span><span class="hl-number">0</span><span class="hl-brackets">]</span><span class="hl-code">.</span><span class="hl-identifier">iov_len</span><span class="hl-code">    = </span><span class="hl-number">1</span><span class="hl-code">;
    </span><span class="hl-identifier">vec</span><span class="hl-brackets">[</span><span class="hl-number">1</span><span class="hl-brackets">]</span><span class="hl-code">.</span><span class="hl-identifier">iov_base</span><span class="hl-code">   = </span><span class="hl-brackets">(</span><span >void</span><span class="hl-code"> *</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">tag</span><span class="hl-code">;
    </span><span class="hl-identifier">vec</span><span class="hl-brackets">[</span><span class="hl-number">1</span><span class="hl-brackets">]</span><span class="hl-code">.</span><span class="hl-identifier">iov_len</span><span class="hl-code">    = </span><span class="hl-identifier">strlen</span><span class="hl-brackets">(</span><span class="hl-identifier">tag</span><span class="hl-brackets">)</span><span class="hl-code"> + </span><span class="hl-number">1</span><span class="hl-code">;
    </span><span class="hl-identifier">vec</span><span class="hl-brackets">[</span><span class="hl-number">2</span><span class="hl-brackets">]</span><span class="hl-code">.</span><span class="hl-identifier">iov_base</span><span class="hl-code">   = </span><span class="hl-brackets">(</span><span >void</span><span class="hl-code"> *</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">msg</span><span class="hl-code">;
    </span><span class="hl-identifier">vec</span><span class="hl-brackets">[</span><span class="hl-number">2</span><span class="hl-brackets">]</span><span class="hl-code">.</span><span class="hl-identifier">iov_len</span><span class="hl-code">    = </span><span class="hl-identifier">strlen</span><span class="hl-brackets">(</span><span class="hl-identifier">msg</span><span class="hl-brackets">)</span><span class="hl-code"> + </span><span class="hl-number">1</span><span class="hl-code">;
 
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">write_to_log</span><span class="hl-brackets">(</span><span class="hl-identifier">bufID</span><span class="hl-code">, </span><span class="hl-identifier">vec</span><span class="hl-code">, </span><span class="hl-number">3</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>
<p class="paragraph">
iovecについては readv(2), writev(2) を参照。
<br />
write_to_log()については以下のように宣言されている。
<br />
</p>
<div class="hl-main"><pre><span >static</span><span class="hl-code"> </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">__write_to_log_init</span><span class="hl-brackets">(</span><span class="hl-identifier">log_id_t</span><span class="hl-code">, </span><span >struct</span><span class="hl-code"> </span><span class="hl-identifier">iovec</span><span class="hl-code"> *</span><span class="hl-identifier">vec</span><span class="hl-code">, </span><span class="hl-identifier">size_t</span><span class="hl-code"> </span><span class="hl-identifier">nr</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span >static</span><span class="hl-code"> </span><span >int</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">*</span><span class="hl-identifier">write_to_log</span><span class="hl-brackets">)</span><span class="hl-brackets">(</span><span class="hl-identifier">log_id_t</span><span class="hl-code">, </span><span >struct</span><span class="hl-code"> </span><span class="hl-identifier">iovec</span><span class="hl-code"> *</span><span class="hl-identifier">vec</span><span class="hl-code">, </span><span class="hl-identifier">size_t</span><span class="hl-code"> </span><span class="hl-identifier">nr</span><span class="hl-brackets">)</span><span class="hl-code"> = </span><span class="hl-identifier">__write_to_log_init</span><span class="hl-code">;</span></pre></div>
<p class="paragraph">
以降のソースは割愛するが、処理内容としては以下になる。
<br />
</p>
<ul><li> 一回目のwrite_to_log()呼び出し：__write_to_log_init()が呼ばれる。<ul><li> 初期化処理(ログファイルのオープン) + write_to_log を __write_to_log_kernel に切り替え、かつ __write_to_log_kernel を呼び出す。</li></ul></li>
<li> 二回目以降のwrite_to_log()呼び出し：__write_to_log_kernel()が呼ばれる。<ul><li> writev(2) を使ってログファイル出力</li></ul></li></ul>

<p class="paragraph">
結論：以上見てきたように、isLoggable()によるログレベルの検査と、ログ出力処理は完全に独立している。このためたとえVERBOSEやDEBUGレベルがpropファイル上はOFFにされていたとしても、v()やd()メソッドを呼べばログファイルに出力されてしまう。
<br />
</p>

<h3 id="id2927ac">実機やEmulator上でのログレベルの調整</h3>

<p class="paragraph">
&quot;isLoggable()&quot;のドキュメントに記載されているが、
<br />
</p>
<pre>$ setprop log.tag.&lt;TAG&gt; &lt;LEVEL&gt;
</pre>
<p class="paragraph">
により実機及びEmulator上での対象TAGのログレベルを調整できる。
<br />
</p>

<p class="paragraph">
実機でも適用できるので、例えば実機でしか動かない機能をテストするとき、VerboseやDebugレベルを出力するために上記setpropコマンドを使ってログレベルを調整することが出来る。
<br />
</p>

<p class="paragraph">
他にも &quot;/data/local.prop&quot; ファイルに
<br />
</p>
<pre>log.tag.&lt;YOUR_LOG_TAG&gt;=&lt;LEVEL&gt;
</pre>
<p class="paragraph">
と記述しておくことでsetpropが不要になるようだ。
<br />
</p>

<h4 id="id16e68b">android.util.Logドキュメントのミス・・・では無いらしい。</h4>

<p class="paragraph">
StackOverflowでも話題になっているが、android.util.Logのドキュメントでは「Debugログは実行時にstripされる」と記載されている(20111-07-18時点)。
<br />
</p>
<blockquote><p class="paragraph">
Verbose should never be compiled into an application except during development.
<br />
<strong>Debug logs are compiled in but stripped at runtime.</strong>
<br />
Error, warning and info logs are always kept.
<br />
</p></blockquote>

<p class="paragraph">
実際は、最初の例で示したように実行時にもd()が呼ばれればDEBUGログが出力されてしまう。
<br />
</p>

<p class="paragraph">
仮にこのドキュメント通りであったとしても、setpropでログレベルを調整することによりDEBUGやVERBOSEレベルを実機上でログ出力させることは可能である。
<br />
</p>

<p class="paragraph">
開発者側としては、<strong>全てのログレベルが実機上で出力されることを前提として</strong>Logクラスの各出力メソッドを使う必要があるだろう。
<br />
</p>

<p class="paragraph">
<strong>2013-12追記</strong>
<br />
JSSECのセキュアコーディングガイド【2013年4月1日版】によると、これはドキュメントのミスではなく、一般的にログとはこのような使い分けや実装になる、という一般論を記述している。記述されているような一般論に基づいて適切にログレベルを整理し、デバッグやテスト時と、リリース時とでログ出力のON/OFFを制御するために、APIで提供されている各種機能を活用していくことになる。具体的にはJSSECのセキュアコーディングガイドを参照のこと。
<br />
</p>


<h3 id="idf0f258">ProGuardを用いて特定のログレベルを無効化する手法</h3>

<p class="paragraph">
StackOverflowに紹介されている。以下の設定をProGuardの設定ファイルに追加する。
<br />
</p>
<pre>-assumenosideeffects class android.util.Log {
    public static int v(...);
}
</pre>

<p class="paragraph">
ProGuardを有効にした状態で(Eclpse + ADTPluginならdefault.propertiesに &quot;proguard.config=proguard.cfg&quot; 追記)、Signed Packageを作成すると、Log.v()メソッド呼び出しがバイトコードレベルで除去される。
<br />
</p>

<p class="paragraph">
実際に上記ProGuard設定有り/無しでそれぞれSigned Packageを生成し、apktoolで展開、smaliファイルをdiffしてみる。
<br />
</p>

<pre class="plugin_pre">
$ diff (ProGuard設定無し).smali  (ProGuard設定有り).smali
164,169d163
&lt;     const-string v0, &quot;tag1&quot;
&lt;
&lt;     const-string v1, &quot;tag1-verbose&quot;
&lt;
&lt;     invoke-static {v0, v1}, Landroid/util/Log;-&gt;v(Ljava/lang/String;Ljava/lang/String;)I
&lt;
193,198d186
&lt;
&lt;     const-string v0, &quot;tag2&quot;
&lt;
&lt;     const-string v1, &quot;tag2-verbose&quot;
&lt;
&lt;     invoke-static {v0, v1}, Landroid/util/Log;-&gt;v(Ljava/lang/String;Ljava/lang/String;)I
</pre>
<p class="paragraph">
確かに Log.v() がバイトコードから除去されていることを確認できた。
<br />
</p>

<p class="paragraph">
このようにProGuardを使うことで、特定のログ出力をバイトコードレベルで無効化出来る。
<br />
デメリットとしては、いざ実機上で異常が発生した場合に、ログレベルを調整しても有用な詳細ログが取得できなくなる可能性が発生する。
<br />
</p>

<hr />

<p class="paragraph">
３行でまとめ：
<br />
</p>
<ul><li> if (isLoggable()) { Log.xxyy() } を徹底する。</li>
<li> ログレベルはsetprop または /data/local.prop でtag単位で調整可能。基本全てのログレベルが出力されることを前提とする。</li>
<li> ProGuardでバイトコードレベルで除去できるが、デメリットにも注意。</li></ul>

<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-1021.html" title="技術/Android/HowToReadSystemLogs">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-997.html" title="技術/Android/PermissionExamples">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-1081.html" title="技術/Android">Up</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-23.html" title="技術">技術</a>&nbsp;]</li>
</ul>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/999<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2007 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>