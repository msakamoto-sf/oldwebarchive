<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>C言語系/memos/BCC/02, 早見表とミニTips - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">C言語系/memos/BCC/02, 早見表とミニTips</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2010-02-24 23:39:13 &nbsp; / &nbsp; last updated at: 2010-02-25 09:03:54<br>
カテゴリ: <a href="category-10.html">C言語</a>&nbsp;<a href="category-8.html">Windows</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-597.html" title="C言語系/memos/BCC/01, Win32のEXE,LIB,DLL開発入門(C言語)">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-582.html" title="C言語系/memos/VC++">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-478.html" title="C言語系">C言語系</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
Borland C++ Compiler での、コンパイラ/リンカオプションやライブラリなどの早見表、および <a href="./view-597.html" >C言語系/memos/BCC/01, Win32のEXE,LIB,DLL開発入門(C言語)</a> では取りあげなかったミニTipsなど。
<br />
</p>




<p class="paragraph">
対象：
<br />
</p>
<pre>&gt; bcc32
Borland C++ 5.5.1 for Win32 Copyright (c) 1993, 2000 Borland
(...)
&gt; ilink32
Turbo Incremental Link 5.00 Copyright (c) 1997, 2000 Borland
(...)
</pre>

<ul><li><a href="#idbb61a2">各種早見表</a><ul><li><a href="#ida157ee">BCC32.EXEでのターゲット/マルチスレッド/UNICODE/ダイナミックRTL指定</a></li>
<li><a href="#id6dc38d">ILINK32.EXEで手動リンクするスタートアップモジュールと特殊処理オブジェクト</a></li>
<li><a href="#id0e9a1a">提供されているライブラリ</a></li>
<li><a href="#id977d6d">ILINK32.EXEでのターゲット指定オプション</a></li></ul></li>
<li><a href="#id1b5ae9">COFFとOMF, COFF2OMF</a></li>
<li><a href="#id7ff90f">アセンブラコードの出力(BCC32, &quot;-S&quot;オプション)</a></li>
<li><a href="#idc6543b">TDUMPの使い方 イロハ</a></li></ul>
<hr />
<h3 id="idbb61a2">各種早見表</h3>

<p class="paragraph">
以下のFAQ掲載のスタートアップモジュール/インポートライブラリ、および <a href="./view-597.html" >C言語系/memos/BCC/01, Win32のEXE,LIB,DLL開発入門(C言語)</a> で取りあげたいくつかのコマンドラインオプションをまとめておく。
<br />
</p>

<ul><li> Borland C++ Compiler 5.5 - FAQ<ul><li> <a class="externallink" href="http://edn.embarcadero.com/jp/article/33545" target="_blank">http://edn.embarcadero.com/jp/article/33545</a></li></ul></li></ul>

<h4 id="ida157ee">BCC32.EXEでのターゲット/マルチスレッド/UNICODE/ダイナミックRTL指定</h4>

<p class="paragraph">
ターゲットを指定するには、次の３つのオプションのいずれかを指定する。
<br />
</p>
<pre>-W : GUIアプリケーション
-WC : コンソールアプリケーション
-WD : DLL
</pre>

<p class="paragraph">
以下のオプションは、他のオプションと組み合わせて使用出来る。
<br />
</p>
<pre>-WM : マルチスレッド
-WU : UNICODE対応
-WR : ダイナミックRTLを使用
</pre>

<h4 id="id6dc38d">ILINK32.EXEで手動リンクするスタートアップモジュールと特殊処理オブジェクト</h4>

<p class="paragraph">
※W付はワイド文字版
<br />
</p>

<table>
	<tr>
		<td> C0X32(W).OBJ </td>
		<td> 32ビットコンソールモード用EXEスタートアップモジュール </td>
	</tr>
	<tr>
		<td> C0W32(W).OBJ </td>
		<td> GUI .EXE用スタートアップモジュール </td>
	</tr>
	<tr>
		<td> C0D32(W).OBJ </td>
		<td> DLLスタートアップモジュール </td>
	</tr>
	<tr>
		<td> C0D32X.OBJ </td>
		<td> DLLスタートアップモジュール（例外処理なし） </td>
	</tr>
	<tr>
		<td> FILEINFO.OBJ </td>
		<td> オープンしているファイルハンドル情報を子プロセスへ渡すときに使う </td>
	</tr>
	<tr>
		<td> GP.OBJ </td>
		<td> 例外処理発生時にレジスタダンプを印刷する </td>
	</tr>
	<tr>
		<td> WILDARGS.OBJ </td>
		<td> ワイルドカード引数を評価 </td>
	</tr>
</table>

<h4 id="id0e9a1a">提供されているライブラリ</h4>

<table>
	<tr>
		<td> CW32.LIB </td>
		<td> シングルスレッドのRTL </td>
	</tr>
	<tr>
		<td> CW32I.LIB </td>
		<td> シングルスレッドのRTL(CC3250.DLL)用 ImportLIB </td>
	</tr>
	<tr>
		<td> CW32MT.LIB </td>
		<td> マルチスレッドのRTL </td>
	</tr>
	<tr>
		<td> CW32MTI.LIB </td>
		<td> マルチスレッドのRTL(CC3250MT.DLL)用 ImportLib </td>
	</tr>
	<tr>
		<td> DXEXTRA.LIB </td>
		<td> DirectX用スタティックLib </td>
	</tr>
	<tr>
		<td> IMPORT32.LIB </td>
		<td> APIのインポートライブラリ </td>
	</tr>
	<tr>
		<td> INET.LIB </td>
		<td> MS Internet DLL用ImportLib </td>
	</tr>
	<tr>
		<td> NOEH32.LIB </td>
		<td> 例外処理を除外するためのライブラリ </td>
	</tr>
	<tr>
		<td> OLE2W32.LIB </td>
		<td> 32ビットOLE 2.0API用Import Lib </td>
	</tr>
	<tr>
		<td> OLEAUT32.LIB </td>
		<td> 32ビットOLE 2.0API用Import Lib </td>
	</tr>
	<tr>
		<td> UUID.LIB </td>
		<td> Direct3D、DirectDraw、シェルエクステンションなどのためのGUIDライブラリ </td>
	</tr>
	<tr>
		<td> WININET.LIB </td>
		<td> WININET.LIB用ImportLib </td>
	</tr>
	<tr>
		<td> WS2_32.LIB </td>
		<td> 32ビットWinSock 2.0用ImportLib </td>
	</tr>
</table>

<p class="paragraph">
・コンソールアプリ：
<br />
</p>
<pre>スタートアップモジュール : C0X32.OBJ
ライブラリ： CW32.LIB + IMPORT32.LIB
</pre>

<p class="paragraph">
・GUIアプリ：
<br />
</p>
<pre>スタートアップモジュール : C0W32.OBJ
ライブラリ： CW32.LIB + IMPORT32.LIB
</pre>

<p class="paragraph">
・ランタイムライブラリをDLLとしてリンクする場合は、CW32.LIBではなくCW32I.LIBをリンクする。
<br />
</p>
<pre>CW32I.LIB   をリンク → CC3250.DLL   が必要(BINディレクトリ中に存在)
CW32MTI.LIB をリンク → CC3250MT.DLL が必要(同上)
</pre>
<p class="paragraph">
※いずれも32bitGUIアプリ対応
<br />
</p>

<p class="paragraph">
・マルチスレッド用のライブラリ(CW32MT.LIB/CW32MTI.LIB)はBCC32.EXEでの
<br />
</p>
<pre>-WM
</pre>
<p class="paragraph">
オプション指定時に使う。
<br />
</p>

<p class="paragraph">
・NOEH32.LIBを指定して例外処理を扱わないようにすることで、BCCで作成するアプリケーションの実行ファイルのサイズを節約することが可能。ただしC++の入出力クラスなど例外処理が必要な場合は無効。
<br />
</p>

<h4 id="id977d6d">ILINK32.EXEでのターゲット指定オプション</h4>

<p class="paragraph">
<a href="./view-597.html" >C言語系/memos/BCC/01, Win32のEXE,LIB,DLL開発入門(C言語)</a> の複数ファイル分割の項から再掲：
<br />
</p>
<pre>ILINK32 [@respfile][options] startup myobjs, [exe], [mapfile], [libraries], [deffile], [resfile]
</pre>

<p class="paragraph">
&quot;options&quot;では、/c (シンボルで大文字と小文字を区別)オプションを忘れずに指定すること。
<br />
またターゲット指定のオプションを以下に簡単にまとめる。
<br />
</p>
<table>
	<tr>
		<td> /aa </td>
		<td> 32 ビット Windows アプリケーションを構築する </td>
	</tr>
	<tr>
		<td> /ad </td>
		<td> 32 ビット Windows デバイスドライバを構築する </td>
	</tr>
	<tr>
		<td> /ap </td>
		<td> 32 ビット Windows コンソールアプリケーションを構築する </td>
	</tr>
	<tr>
		<td> /Tpd </td>
		<td> Windows の .DLL ファイルをターゲットにする </td>
	</tr>
	<tr>
		<td> /Tpe </td>
		<td> Windows の .EXE ファイルをターゲットにする </td>
	</tr>
</table>

<h3 id="id1b5ae9">COFFとOMF, COFF2OMF</h3>

<p class="paragraph">
Visual C++ 2008 のC++コンパイラが生成するインポートライブラリは<strong>COFF (Common Object File Format)</strong>というファイル形式になっている。一方Borland C++ Compilerが生成するOBJ, LIBファイルは<strong>(Relocatable) OMF (Object Module Format)</strong>というファイル形式になっている。
<br />
</p>

<ul><li> Common Object File Format<ul><li> <a class="externallink" href="http://en.wikipedia.org/wiki/COFF" target="_blank">http://en.wikipedia.org/wiki/COFF</a></li></ul></li>
<li> (Relocatable) Object Module Format<ul><li> <a class="externallink" href="http://en.wikipedia.org/wiki/Relocatable_Object_Module_Format" target="_blank">http://en.wikipedia.org/wiki/Relocatable_Object_Module_Format</a></li></ul></li></ul>

<p class="paragraph">
この違いが問題となってくるのは、Visual C++ で生成したインポートライブラリをBorland C++ Compilerでリンクする場合である。
<br />
</p>

<pre>Visual C++ → xxyy.dll (PE: Porable Executable ファイル)
              xxyy.lib (COFF)
                ↓
BCC32/ILINK32  client.obj (OMF) → このままではCOFF形式のLIBをOMF形式のOBJとリンク出来ない！
</pre>

<p class="paragraph">
ここで登場するのが Borland C++ Compiler に含まれている COFF2OMF.EXE である。
<br />
</p>

<p class="paragraph">
まずCOFF形式のインポートライブラリをリンクしようとすると、エラーとなってしまうことを確認する。
<br />
</p>
<pre>&gt; dir
foobar_usedll_cui.c
libdllfoobarbaz.dll   ... VC++2008で生成したDLL
libdllfoobarbaz.lib   ... 同上のインポートライブラリ(COFF形式)

&gt; bcc32 -c foobar_usedll_cui.c
&gt; bcc32 -WC foobar_usedll_cui.obj libdllfoobarbaz.lib
Error: &#039;C:\IN_VITRO\C\BCCTEST03\LIBDLLFOOBARBAZ.LIB&#039; contains invalid OMF record, type 0x21 (possibly COFF)
</pre>
<p class="paragraph">
（foobar_usedll_cui.cおよびlibdllfoobarbaz.dllのソースは省略）
<br />
</p>

<p class="paragraph">
COFF2OMFを使って、OMF形式のインポートライブラリ &quot;libdllfoobarbaz_omf.lib&quot; に変換してリンク＆実行：
<br />
</p>
<pre>&gt; COFF2OMF libdllfoobarbaz.lib libdllfoobarbaz_omf.lib
&gt; bcc32 -WC foobar_usedll_cui.obj libdllfoobarbaz_omf.lib
&gt; foobar_usedll_cui.exe
foo(2, 3) = 5
bar(2, 3) = 6
</pre>

<p class="paragraph">
DLL側とアプリ側とで呼び出し規約を一致させる必要がある点に注意すること。これがずれてしまうと、スタックのクリーンアップがずれてしまい異常終了の原因になる。
<br />
呼び出し規約に応じてシンボル名の修飾が入るが、COFF2OMFでは&quot;-lib&quot;オプションで修飾名の調整を行える。
<br />
</p>
<pre>&quot;-lib:ms&quot; : MS C++ の名前の変形（name mangling）のあるエントリを許可（デフォルト: no）
&quot;-lib:st&quot; : MS stdcall の変形にエリアスを使うかわりに名前を標準化する
&quot;-lib:ca&quot; : MS cdecl エリアス使用を行わない（デフォルトはエリアシングする）
</pre>

<p class="paragraph">
呼び出し規約が一致しなくとも、&quot;-lib&quot;オプションを調整することで「無理矢理」リンクに成功させることも出来るが、当然、異常終了の原因となる。
<br />
</p>

<p class="paragraph">
呼び出し規約の不一致による異常終了は、アセンブラのレベルでデバッグをしないと発見が難しい。重ね重ね注意が必要である。
<br />
</p>

<h3 id="id7ff90f">アセンブラコードの出力(BCC32, &quot;-S&quot;オプション)</h3>

<p class="paragraph">
アセンブラコードを出力するには、&quot;-S&quot;オプションを使う。
<br />
</p>

<p class="paragraph">
bar.c:
<br />
</p>
<pre class="plugin_pre">
int bar(int a, int b) {
	return a * b;
}
</pre>

<p class="paragraph">
アセンブラファイルは拡張子が&quot;.asm&quot;で出力される。
<br />
</p>
<pre>&gt; bcc32 -S bar.c
Borland C++ 5.5.1 for Win32 Copyright (c) 1993, 2000 Borland
bar.c:
</pre>

<p class="paragraph">
bar.asm:
<br />
</p>
<pre class="plugin_pre">
	.386p
(...)
_bar	proc	near
?live1@0:
   ;	
   ;	int bar(int a, int b) {
   ;	
	push      ebp
	mov       ebp,esp
   ;	
   ;		return a * b;
   ;	
@1:
	mov       eax,dword ptr [ebp+8]
	imul      dword ptr [ebp+12]
   ;	
   ;	}
   ;	
@3:
@2:
	pop       ebp
	ret 
_bar	endp
_TEXT	ends
	public	_bar
	?debug	D &quot;bar.c&quot; 15447 27147
	end
</pre>

<p class="paragraph">
これをコンパイルするにはTASM32が必要らしい。
<br />
例えばOllyDbgのLoaddllはアセンブラで書かれており、TASM32でコンパイルされる。<span class="hidden">(</span><a class="footnote" href="#footnote_600_1" id="footnote_600_1_r"  title="それよりも、リソースファイルに実行ファイルイメージを埋め込んでいる方が気になって仕方ない。使う時は一時ファイルとかに吐きだして実行してるのかな？">*1</a><span class="hidden">)</span>
<br />
</p>

<ul><li> Loaddll<ul><li> <a class="externallink" href="http://www.ollydbg.de/Asmcode.htm" target="_blank">http://www.ollydbg.de/Asmcode.htm</a></li></ul></li></ul>

<h3 id="idc6543b">TDUMPの使い方 イロハ</h3>

<p class="paragraph">
EXE or DLLファイルのヘッダー情報をダンプ
<br />
</p>
<pre>tdump -e xxxx.exe
tdump -e xxxx.dll
</pre>

<p class="paragraph">
エクスポートの一覧をダンプ
<br />
</p>
<pre>tdump -ee xxxx.exe
tdump -ee xxxx.dll
</pre>

<p class="paragraph">
インポート一覧をダンプ
<br />
</p>
<pre>tdump -em xxxx.exe
</pre>

<p class="paragraph">
インポートしたモジュール一覧をダンプ
<br />
</p>
<pre>tdump -em. xxxx.exe
</pre>

<p class="paragraph">
COFF形式のOBJ, LIBファイルをダンプ
<br />
</p>
<pre>tdump -C xxxx.obj
tdump -C xxxx.lib
</pre>

<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-597.html" title="C言語系/memos/BCC/01, Win32のEXE,LIB,DLL開発入門(C言語)">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-582.html" title="C言語系/memos/VC++">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-596.html" title="C言語系/memos/BCC">Up</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-478.html" title="C言語系">C言語系</a>&nbsp;]</li>
</ul><div class="footnote">
<a id="footnote_600_1" href="#footnote_600_1_r">*1</a>: それよりも、リソースファイルに実行ファイルイメージを埋め込んでいる方が気になって仕方ない。使う時は一時ファイルとかに吐きだして実行してるのかな？
</div>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/600<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2007 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>