<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>C言語系/「デーモン君のソース探検」読書メモ/15, mktemp(3),mkstemp(3) - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">C言語系/「デーモン君のソース探検」読書メモ/15, mktemp(3),mkstemp(3)</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2010-01-30 12:22:47 &nbsp; / &nbsp; last updated at: 2010-01-30 12:25:58<br>
カテゴリ: <a href="category-32.html">BSD</a>&nbsp;<a href="category-10.html">C言語</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-567.html" title="C言語系/「デーモン君のソース探検」読書メモ/14, man.conf">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-571.html" title="C言語系/「デーモン君のソース探検」読書メモ/16, malloc(3)">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-478.html" title="C言語系">C言語系</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
お題：mktemp(3)とmkstemp(3)の違いを調査せよ
<br />
</p>

<p class="paragraph">
※今回は軽めなので、「デーモン君のソース探検」書籍は軽く参考程度に留め、テストプログラムを組んだりしつつさくさくと進めていきたいと思います。
<br />
</p>


<ul><li><a href="#id917a8f">mktemp(3)とmkstemp(3)の違いとテストプログラム</a><ul><li><a href="#id446b56">mktemp(3)のテストプログラム</a></li>
<li><a href="#id42b51e">mkstemp(3)のテストプログラム</a></li></ul></li>
<li><a href="#id269ba0">mkstemp(3)とmktemp(3)の中身</a></li>
<li><a href="#id7794ce">&quot;__warn_references&quot; → &quot;.gnu.warning&quot;セクションについて</a></li></ul>
<hr />
<h3 id="id917a8f">mktemp(3)とmkstemp(3)の違いとテストプログラム</h3>

<p class="paragraph">
まずmanページを確認してみる。
<br />
</p>
<pre class="plugin_pre">
NAME
     mktemp, mkstemp, mkdtemp - make unique temporary file or directory name

LIBRARY
     Standard C Library (libc, -lc)

SYNOPSIS
     #include &lt;stdlib.h&gt;

     char *
     mktemp(char *template);

     int
     mkstemp(char *template);
</pre>
<p class="paragraph">
ここで&quot;template&quot;という引数が一時ファイル名を指定するところで、連続する&quot;X&quot;の部分がプロセスIDと適当な英字の組み合わせに置換される。
<br />
mktemp()の場合は置換後のファイル名が、mkstemp()の場合は実際にファイルを作成しそのファイル記述子が返される。
<br />
mkstemp()の場合に置換後のファイル名をどうやって取り出すか、だが、template引数にconstが付いていない。つまり、template引数の連続する&quot;X&quot;の部分が直接上書きされることになる。
<br />
</p>

<p class="paragraph">
mktemp()とmkstemp()の差異は、mktemp()はファイル名を決定するだけでファイルは作成しない。一方mkstemp()の場合は実際にファイルを作成し、ファイル記述子まで返す。
<br />
manページの&quot;SECURITY CONSIDERATION&quot;にある通り、mktemp()の場合はファイル名生成と、その後のファイル作成で間が空いてしまうので競合する可能性が出てきてしまう。mkstemp()/mkdtemp()はそうならないようになっているので、そちらを推奨とのこと。
<br />
</p>

<p class="paragraph">
実際にテストプログラムを組んでみる。
<br />
</p>

<h4 id="id446b56">mktemp(3)のテストプログラム</h4>

<p class="paragraph">
mktemp.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdlib.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
  </span><span >char</span><span class="hl-code"> </span><span >template</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-code"> = </span><span class="hl-quotes">&quot;</span><span class="hl-string">/tmp/mktemp_test.XXXX</span><span class="hl-quotes">&quot;</span><span class="hl-code">;
  </span><span >char</span><span class="hl-code"> *</span><span class="hl-identifier">res</span><span class="hl-code"> = </span><span >NULL</span><span class="hl-code">;
 
  </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">template(before) = %s</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span >template</span><span class="hl-brackets">)</span><span class="hl-code">;
 
  </span><span class="hl-identifier">res</span><span class="hl-code"> = </span><span class="hl-identifier">mktemp</span><span class="hl-brackets">(</span><span >template</span><span class="hl-brackets">)</span><span class="hl-code">;
  </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span >NULL</span><span class="hl-code"> == </span><span class="hl-identifier">res</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">mktemp</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;
  </span><span class="hl-brackets">}</span><span class="hl-code">
  </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">template(after) = %s</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span >template</span><span class="hl-brackets">)</span><span class="hl-code">;
  </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">res = %s</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">res</span><span class="hl-brackets">)</span><span class="hl-code">;
 
  </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<pre>$ cc -Wall -c -o mktemp.o mktemp.c
$ cc -Wall -o mktemp mktemp.o
mktemp.o: In function `main&#039;:
mktemp.o(.text+0x40): warning: mktemp() possibly used unsafely, use mkstemp() or mkdtemp()
$ ./mktemp
template(before) = /tmp/mktemp_test.XXXX
template(after) = /tmp/mktemp_test.308a
res = /tmp/mktemp_test.308a
</pre>
<p class="paragraph">
実行ファイルのリンク時にwarningが表示されている。これについては後ほど追跡する。
<br />
ファイル名までは生成されるが、実際のファイルは作成されていない：
<br />
</p>
<pre>$ ls -a /tmp
./  ../
</pre>

<h4 id="id42b51e">mkstemp(3)のテストプログラム</h4>

<p class="paragraph">
mkstemp.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdlib.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
  </span><span >char</span><span class="hl-code"> </span><span >template</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-code"> = </span><span class="hl-quotes">&quot;</span><span class="hl-string">/tmp/mkstemp_test.XXXX</span><span class="hl-quotes">&quot;</span><span class="hl-code">;
  </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">fd</span><span class="hl-code"> = -</span><span class="hl-number">1</span><span class="hl-code">;
 
  </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">template(before) = %s</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span >template</span><span class="hl-brackets">)</span><span class="hl-code">;
 
  </span><span class="hl-identifier">fd</span><span class="hl-code"> = </span><span class="hl-identifier">mkstemp</span><span class="hl-brackets">(</span><span >template</span><span class="hl-brackets">)</span><span class="hl-code">;
  </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">-</span><span class="hl-number">1</span><span class="hl-code"> == </span><span class="hl-identifier">fd</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">mkstemp</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;
  </span><span class="hl-brackets">}</span><span class="hl-code">
  </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">template(after) = %s</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span >template</span><span class="hl-brackets">)</span><span class="hl-code">;
  </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">fd = %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">fd</span><span class="hl-brackets">)</span><span class="hl-code">;
 
  </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<pre>$ cc -Wall -c -o mkstemp.o mkstemp.c
$ cc -Wall -o mkstemp mkstemp.o
$ ./mkstemp
template(before) = /tmp/mkstemp_test.XXXX
template(after) = /tmp/mkstemp_test.328a
fd = 3
</pre>
<p class="paragraph">
実行してみると、実際にファイル作成まで行われている：
<br />
</p>
<pre>$ ls -a /tmp
./                 ../                mkstemp_test.328a
</pre>

<h3 id="id269ba0">mkstemp(3)とmktemp(3)の中身</h3>

<p class="paragraph">
mktemp/mkstemp/mkdtempのソースコードはそれぞれ以下の場所にあった。
<br />
</p>
<pre>/usr/src/lib/libc/stdio/
                        mkdtemp.c
                        mkstemp.c
                        mktemp.3
                        mktemp.c
</pre>

<p class="paragraph">
まずmktemp.cの主要部分：
<br />
</p>
<pre class="plugin_pre">
__warn_references(mktemp,
    &quot;warning: mktemp() possibly used unsafely, use mkstemp() or mkdtemp()&quot;)

char *
mktemp(path)
  char *path;
{

  _DIAGASSERT(path != NULL);

  return (__gettemp(path, (int *)NULL, 0) ? path : (char *)NULL);
}
</pre>
<p class="paragraph">
続いてmkstemp.cの主要部分：
<br />
</p>
<pre class="plugin_pre">
#if HAVE_CONFIG_H
#define GETTEMP         gettemp
#else
/* ... */
#define GETTEMP         __gettemp
#endif

int
mkstemp(path)
  char *path;
{
  int fd;

  _DIAGASSERT(path != NULL);

  return (GETTEMP(path, &amp;fd, 0) ? fd : -1);
}
</pre>
<p class="paragraph">
最後にmkdtemp.cの主要部分：
<br />
</p>
<pre class="plugin_pre">
#if HAVE_CONFIG_H
#define GETTEMP         gettemp
#else
/* ... */
#define GETTEMP         __gettemp
#endif

char *
mkdtemp(path)
  char *path;
{
  _DIAGASSERT(path != NULL);

  return (GETTEMP(path, (int *)NULL, 1) ? path : (char *)NULL);
}
</pre>

<p class="paragraph">
共通しているのは、いずれも&quot;gettemp&quot;or&quot;__gettemp&quot;なる関数へ処理を委譲している点である。
<br />
</p>

<p class="paragraph">
&quot;gettemp&quot;のソースコードは、同じディレクトリ内の次のファイル：
<br />
</p>
<pre>/usr/src/lib/libc/stdio/gettemp.c
</pre>
<p class="paragraph">
&quot;gettemp&quot;/&quot;__gettemp&quot;の切り替えはプリプロセッサで調整されており、いずれにせよ最終的に以下の関数が呼ばれるようになっている：
<br />
</p>
<pre class="plugin_pre">
#if HAVE_CONFIG_H
#define GETTEMP         gettemp
#else
#include &quot;local.h&quot;
#define GETTEMP         __gettemp
#endif

int
GETTEMP(path, doopen, domkdir)
        char *path;
        int *doopen;
        int domkdir;
{
</pre>
<p class="paragraph">
引数の変数名でほぼ使い方が分かるようになっている。ここでもう一度mk({s|d}?)tempでの呼び出しをまとめ直すと・・・
<br />
</p>
<pre>int GETTEMP(char *path, int *doopen, int domkdir):
mktemp  : __gettemp(path, (int *)NULL, 0)
mkstemp : GETTEMP(path, &amp;fd, 0)
mkdtemp : GETTEMP(path, (int *)NULL, 1)
</pre>
<p class="paragraph">
見たままで、解説は不要。doopenがファイル作成指示＆ファイル記述子格納先、domkdirがディレクトリ作成フラグになっている。
<br />
</p>

<p class="paragraph">
本体のソースコードの前半は、getpid()で取得されてたプロセスIDと、GETTEMP()内でのstaticな変数xtraを使ってなるべくユニークになるような文字列を生成している。
<br />
後半の無限forループにて、実際のファイル/ディレクトリ作成が行われ戻り値が返される。
<br />
</p>
<pre class="plugin_pre">
  for (;;) {
    if (doopen) {
      /* mkstemp()の場合、O_CREAT + O_EXCL:排他作成でopen(2)する */
      if ((*doopen =
          open(path, O_CREAT|O_EXCL|O_RDWR, 0600)) &gt;= 0)
        return (1);
      if (errno != EEXIST)
        return (0);
    } else if (domkdir) {
      /* mkdtemp()の場合、mkdir()を実行 */
      if (mkdir(path, 0700) &gt;= 0)
        return (1);
      if (errno != EEXIST)
        return (0);
    } else if (lstat(path, &amp;sbuf))
      /* mktemp()の場合、lstat()が-1でerrnoがENOENT:未存在なら真を返す */
      return (errno == ENOENT ? 1 : 0);
</pre>

<p class="paragraph">
以上でmktemp/mkstemp/mkdtempの中身は把握出来た。
<br />
</p>

<h3 id="id7794ce">&quot;__warn_references&quot; → &quot;.gnu.warning&quot;セクションについて</h3>

<p class="paragraph">
最後に、mktemp.cで出てきた
<br />
</p>
<pre>__warn_references(mktemp,
    &quot;warning: mktemp() possibly used unsafely, use mkstemp() or mkdtemp()&quot;)
</pre>
<p class="paragraph">
について調べてみたい。
<br />
Cソースの、関数以外の部分で出現しているので何らかのマクロであることが予想される。&quot;/usr/include&quot;でgrepしてみる。
<br />
</p>
<pre>$ cd /usr/include
$ grep -r &quot;warn_reference&quot; *
sys/cdefs_aout.h:#define        __warn_references(sym,msg) \
sys/cdefs_aout.h:#define        __warn_references(sym,msg) \
sys/cdefs_aout.h:#define        __warn_references(sym,msg)
sys/cdefs_aout.h:#undef __warn_references(sym,msg)
sys/cdefs_aout.h:#define __warn_references(sym,msg)
sys/cdefs_elf.h:#define __warn_references(sym,msg) \
sys/cdefs_elf.h:#define __warn_references(sym,msg) \
</pre>

<p class="paragraph">
実行ファイルはELF形式になるので、&quot;sys/cdefs_elf.h&quot;の方を見てみる。
<br />
</p>

<pre>#define __warn_references(sym,msg)                                      \
    __asm__(&quot;.section .gnu.warning.&quot; #sym &quot; ; .ascii \&quot;&quot; msg &quot;\&quot; ; .text&quot;);
</pre>

<p class="paragraph">
組み込みアセンブラに展開されることが分かる。&quot;cc -E&quot;でプリプロセッサを展開してみると、次のように展開された。
<br />
</p>

<pre>$ cd /usr/src/lib/libc/stdio
$ cc -E mktemp.c | more
...
__asm__(&quot;.section .gnu.warning.&quot; &quot;mktemp&quot; &quot; ; .ascii \&quot;&quot;
    &quot;warning: mktemp() possibly used unsafely, use mkstemp() or mkdtemp()&quot;  &quot;\&quot; ; .text&quot;);
...
</pre>

<p class="paragraph">
&quot;.section&quot; でセクションが &quot;.gnu.warning.mktemp&quot; に変更されている。これの影響でmktemp()を使ったプログラムをリンクする時にwarningメッセージが出ている事は確実である。
<br />
</p>

<p class="paragraph">
コンパイル時の流れをもう少し細かく追う為、まずccで&quot;-v&quot;オプションをつけ、ldコマンド呼び出し時のオプション群を把握する。
<br />
</p>
<pre class="plugin_pre">
$ cc -Wall -v -o mktemp mktemp.o
Using builtin specs.
gcc version 2.95.3 20010315 (release) (NetBSD nb3)
 ld -m elf_i386 -dc -dp \
     -e __start \
     -dynamic-linker /usr/libexec/ld.elf_so \
     -o mktemp \
     /usr/lib/crt0.o /usr/lib/crtbegin.o \
     mktemp.o \
     -lgcc -lc -lgcc /usr/lib/crtend.o
mktemp.o: In function `main&#039;:
mktemp.o(.text+0x40): warning: mktemp() possibly used unsafely, use mkstemp() or mkdtemp()
</pre>
<p class="paragraph">
ldコマンドのオプションを把握出来たので、これに実行時詳細を表示する&quot;--verbose&quot;を組み合わせ、表示内容をファイルに落として確認してみる。
<br />
</p>
<pre class="plugin_pre">
$ ld -m elf_i386 --verbose ...  &gt; link.log
mktemp.o: In function `main&#039;:
mktemp.o(.text+0x40): warning: mktemp() possibly used unsafely, use mkstemp() or mkdtemp()
$ more link.log
GNU ld version 2.11.2 (with BFD 2.11.2nb1)
  Supported emulations:
   elf_i386
   i386nbsd
using internal linker script:
==================================================
OUTPUT_FORMAT(&quot;elf32-i386&quot;, &quot;elf32-i386&quot;,
              &quot;elf32-i386&quot;)
OUTPUT_ARCH(i386)
ENTRY(_start)
SEARCH_DIR(/usr/lib);
/* Do we need any of these for elf?
   __DYNAMIC = 0;    */

...

  .text      :
  {
    *(.text)
    *(.text.*)
    *(.stub)
    /* .gnu.warning sections are handled specially by elf32.em.  */
    *(.gnu.warning)
    *(.gnu.linkonce.t.*)
  } =0x9090
</pre>
<p class="paragraph">
ようやく手がかりが見つかった。
<br />
</p>
<pre>/* .gnu.warning sections are handled specially by elf32.em.  */
</pre>
<p class="paragraph">
&quot;elf32.em&quot;がファイル名か、何らかの機能の略称か当初は不明だったので、あちこちをgrepしてしまった。
<br />
結論としてはファイル名なので、locateコマンドで辿ることができた。
<br />
</p>
<pre>$ locate elf32.em
/usr/src/gnu/dist/ld/emultempl/elf32.em
/usr/src/gnu/dist/toolchain/ld/emultempl/elf32.em
</pre>
<p class="paragraph">
２つ見つかってしまったが、&quot;.gnu.warning&quot;の警告表示機能についてはどちらも同様だったので、ここでは&quot;gnu/dist/ld/&quot;以下のelf32.emを見てみる。検索すると直ぐに見つかった。
<br />
</p>
<pre> /* Look for any sections named .gnu.warning.  As a GNU extensions,
    we treat such sections as containing warning messages.  We print
    out the warning message, and then zero out the section size so
    that it does not get copied into the output file.  */

 {
   ...
</pre>
<p class="paragraph">
コードは省略するが、ここで&quot;.gnu.warning&quot;で始まるセクション名について警告表示を行っている(正確には警告用のcallback関数を読んでいる)。
<br />
また、同ファイル中で&quot;.gnu.warning&quot;で始まるセクションは実行ファイルから除去する処理も組み込まれていた。このため、mktemp.oおよびmktempファイルには&quot;.gnu.warning&quot;セクションは含まれていない。
<br />
</p>
<pre class="plugin_pre">
$ readelf -S mktemp.o
There are 10 section headers, starting at offset 0x184:

Section Headers:
  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al
  [ 0]                   NULL            00000000 000000 000000 00      0   0  0
  [ 1] .text             PROGBITS        00000000 000034 0000a4 00  AX  0   0  4
  [ 2] .rel.text         REL             00000000 00041c 000058 08      8   1  4
  [ 3] .data             PROGBITS        00000000 0000d8 000000 00  WA  0   0  4
  [ 4] .bss              NOBITS          00000000 0000d8 000000 00  WA  0   0  4
  [ 5] .note             NOTE            00000000 0000d8 000014 00      0   0  1
  [ 6] .rodata           PROGBITS        00000000 0000ec 000054 00   A  0   0  1
  [ 7] .shstrtab         STRTAB          00000000 000140 000044 00      0   0  1
  [ 8] .symtab           SYMTAB          00000000 000314 0000d0 10      9   8  4
  [ 9] .strtab           STRTAB          00000000 0003e4 000038 00      0   0  1
...

$ readelf -S mktemp
There are 27 section headers, starting at offset 0xe30:

Section Headers:
  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al
  [ 0]                   NULL            00000000 000000 000000 00      0   0  0
  [ 1] .interp           PROGBITS        080480f4 0000f4 000017 00   A  0   0  1
  [ 2] .note.netbsd.iden NOTE            0804810c 00010c 000018 00   A  0   0  4
  [ 3] .hash             HASH            08048124 000124 0000b4 04   A  4   0  4
  [ 4] .dynsym           DYNSYM          080481d8 0001d8 0001a0 10   A  5   1  4
  [ 5] .dynstr           STRTAB          08048378 000378 00010f 00   A  0   0  1
  [ 6] .rel.got          REL             08048488 000488 000048 08   A  4  12  4
  [ 7] .rel.plt          REL             080484d0 0004d0 000050 08   A  4   9  4
  [ 8] .init             PROGBITS        08048520 000520 0000e1 00  AX  0   0 16
  [ 9] .plt              PROGBITS        08048604 000604 0000b0 04  AX  0   0  4
  [10] .text             PROGBITS        080486b4 0006b4 000354 00  AX  0   0  4
  [11] .fini             PROGBITS        08048a10 000a10 000081 00  AX  0   0 16
  [12] .rodata           PROGBITS        08048aa0 000aa0 000134 00   A  0   0 32
  [13] .data             PROGBITS        08049bd4 000bd4 000010 00  WA  0   0  4
  [14] .jcr              PROGBITS        08049be4 000be4 000004 00  WA  0   0  4
  [15] .eh_frame         PROGBITS        08049be8 000be8 000004 00  WA  0   0  4
  [16] .ctors            PROGBITS        08049bec 000bec 000008 00  WA  0   0  4
  [17] .dtors            PROGBITS        08049bf4 000bf4 000008 00  WA  0   0  4
  [18] .got              PROGBITS        08049bfc 000bfc 000058 04  WA  0   0  4
  [19] .dynamic          DYNAMIC         08049c54 000c54 000088 08  WA  5   0  4
  [20] .sbss             PROGBITS        08049cdc 000ce0 000000 00   W  0   0  1
  [21] .bss              NOBITS          08049ce0 000ce0 000028 00  WA  0   0 32
  [22] .note             NOTE            00000000 000ce0 000050 00      0   0  1
  [23] .ident            PROGBITS        00000000 000d30 000039 00      0   0  1
  [24] .shstrtab         STRTAB          00000000 000d69 0000c6 00      0   0  1
  [25] .symtab           SYMTAB          00000000 001268 000430 10     26  1f  4
  [26] .strtab           STRTAB          00000000 001698 000197 00      0   0  1
</pre>

<p class="paragraph">
以上で&quot;__warn_refereces&quot;マクロにより、&quot;.gnu.warning&quot;セクションが作成され、ldによるリンク時に警告表示される流れが把握出来た。
<br />
</p>

<p class="paragraph">
今回のお題については、ここまで。
<br />
</p>

<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-567.html" title="C言語系/「デーモン君のソース探検」読書メモ/14, man.conf">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-571.html" title="C言語系/「デーモン君のソース探検」読書メモ/16, malloc(3)">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-546.html" title="C言語系/「デーモン君のソース探検」読書メモ">Up</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-478.html" title="C言語系">C言語系</a>&nbsp;]</li>
</ul>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/568<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2001 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a target="_blank" href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" target="_blank" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>