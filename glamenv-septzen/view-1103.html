<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Groovy/超お手軽Web開発(Groovy-1.8 + Jetty8, 201209版) - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">Groovy/超お手軽Web開発(Groovy-1.8 + Jetty8, 201209版)</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2012-10-01 00:32:32 &nbsp; / &nbsp; last updated at: 2012-10-08 21:44:30<br>
カテゴリ: <a href="category-68.html">Groovy</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-1172.html" title="Groovy/続・お手軽Web開発 (GroovyServlet, Hogan.groovy, Gradle, Tomcat)">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-1101.html" title="Groovy">Groovy</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
Groovyを使うと超お手軽にWeb開発を始められます。・・・といっても、ちょっとしたスタブとか開発中のツール類専用です。
<br />
Jettyを組み込んでGroovyスクリプトで現在ディレクトリをさっくり公開しておしまい、な3分クッキングレベルですが、Groovyが提供しているGroovyServletとTemplateServletのお陰で、スクリプト感覚でJava/Groovy Servletプログラミングを楽しめます。
<br />
GroovyServlet, TemplateServlet共に、リクエストされる度に評価・実行されるため、書き換えたらすぐにブラウザから確認できます。コンテナの再起動など一切不要です。ただその代わり、毎回評価・実行されるためにパフォーマンスは悪いはずです。
<br />
ですので、プロダクトコード用というよりは実験や内部で使うツール類をさくっとでっち上げたい時に使う、そんな使い方になると思います。
<br />
</p>

<p class="paragraph">
<strong>※Windows上で実験する人、またはGroovyServletを使うと1度目は正常に動作するのに2回目以降のアクセスで404になってしまう人は、「GroovyServlet経由で&quot;.groovy&quot;にアクセスした時に、2回目以降で&quot;Script not found, sending 404.&quot;とスタックトレースが発生する場合の回避策」も参照してください。(2012-10-08追記)</strong>
<br />
</p>



<ul><li><a href="#id799fdc">下準備</a></li>
<li><a href="#idb6f63a">環境</a></li>
<li><a href="#idd4d738">web.xml無し版</a></li>
<li><a href="#ide98040">web.xml有り版</a></li>
<li><a href="#id79fc22">Windows環境での正体不明のトラブル</a><ul><li><a href="#id443412">GroovyServlet経由で&quot;.groovy&quot;にアクセスした時に、2回目以降で&quot;Script not found, sending 404.&quot;とスタックトレースが発生する場合の回避策</a><ul><li><a href="#id0a1fb8">回避策：groovy.servlet.GroovyServletを継承した独自のServletクラスでgetResourceConnection()をカスタマイズする。</a></li>
<li><a href="#id58626a">2回目以降のアクセスでトラブルになる原因</a></li>
<li><a href="#iddd11a7">回避策の解説</a></li></ul></li></ul></li>
<li><a href="#id7a1ebd">参考：</a></li></ul>
<hr />

<h3 id="id799fdc">下準備</h3>

<p class="paragraph">
2012-09-30時点でのJetty8最新版を使います・・・が、なんかorg.eclipse.jetty.orbitの依存解決でエラーが出るので、手動で調整する必要があります。
<br />
ひとまずGrapeで手動で&quot;org.eclipse.jetty.aggregate&quot;から&quot;jetty-all&quot;をインストールします。
<br />
</p>
<pre>$ grape install org.eclipse.jetty.aggregate jetty-all 8.1.7.v20120910
</pre>
<p class="paragraph">
・・・が、本記事を書いてる時点だと絶対に org.eclipse.jetty.orbit経由でのjavax.servlet-3.0.0.v201112011016.jarがDLできず、失敗します。
<br />
なぜか javax.servlet-3.0.0.v201112011016.<strong>orbit</strong>をDLしようとするんです・・・。
<br />
ivyのxmlファイルで&quot;ext&quot;部分が&quot;jar&quot;じゃなくて&quot;orbit&quot;になってしまってるんですよね。というわけでこれを手で修正します。
<br />
</p>

<p class="paragraph">
&quot;~/.groovy/grape/org.eclipse.jetty.orbit/javax.servlet/ivy-3.0.0.v201112011016.xml&quot;:
<br />
</p>
<pre class="plugin_pre">
&lt;artifact name=&quot;javax.servlet&quot; type=&quot;orbit&quot; ext=&quot;orbit&quot; conf=&quot;master&quot;/&gt;
-&gt;次のようにext=&quot;jar&quot;に修正します。
&lt;artifact name=&quot;javax.servlet&quot; type=&quot;orbit&quot; ext=&quot;jar&quot; conf=&quot;master&quot;/&gt;
</pre>

<p class="paragraph">
これで改めて &quot;grape install&quot; すれば多分正常にJettyの8.1.7最新版をインストールできるはずです。
<br />
</p>

<h3 id="idb6f63a">環境</h3>

<p class="paragraph">
今回の実験環境です。
<br />
</p>
<pre>Mac OS X 10.7.5
JDK 1.6.0_35
Groovy Version: 1.8.6 JVM: 1.6.0_35 Vendor: Apple Inc. OS: Mac OS X
</pre>

<h3 id="idd4d738">web.xml無し版</h3>

<p class="paragraph">
j1/j1.groovy:
<br />
</p>
<pre class="plugin_pre">
import org.eclipse.jetty.server.*
import org.eclipse.jetty.servlet.*
import groovy.servlet.*

@Grab(group=&#039;org.eclipse.jetty.aggregate&#039;, module=&#039;jetty-all&#039;, version=&#039;8.1.7.v20120910&#039;)
def server = new Server(8080)
def context = new ServletContextHandler(server, &#039;/&#039;, ServletContextHandler.SESSIONS)
context.resourceBase = &#039;.&#039;
context.addServlet(GroovyServlet, &quot;*.groovy&quot;)
context.addServlet(TemplateServlet, &quot;*.gsp&quot;)
server.start()
server.join()
</pre>

<p class="paragraph">
実行:
<br />
</p>
<pre>$ cd j1/
$ groovy j1.groovy
</pre>

<p class="paragraph">
以下のファイルはUTF-8で保存してます。
<br />
</p>

<p class="paragraph">
GroovyServletの使用例:
<br />
j1/g1.groovy:
<br />
</p>
<pre class="plugin_pre">
println &quot;&quot;&quot;
&lt;html&gt;
&lt;head&gt;&lt;title&gt;test&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
hello, Jettyの組み込みテストです。
${application.getServerInfo()}
&lt;/body&gt;
&lt;/html&gt;
&quot;&quot;&quot;
</pre>

<p class="paragraph">
TemplateServletの使用例:
<br />
j1/g2.gsp:
<br />
</p>
<pre class="plugin_pre">
&lt;html&gt;
&lt;head&gt;&lt;title&gt;TemplateServlet&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
TemplateServletの組み込みテストです。&lt;br&gt;
&lt;% println params %&gt;
&lt;% 3.times { %&gt;
Hello World!&lt;br&gt;
&lt;% } %&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>

<p class="paragraph">
&quot;g1.groovy&quot;は文字化けしなかったけど、&quot;g2.gsp&quot;の日本語部分は文字化けてしまいました。また後日調べます。
<br />
</p>

<p class="paragraph">
WEB-INF/のディレクトリ構成や、web.xml無しで始められるのが良い点です。
<br />
代わりに、&quot;.html&quot;などの静的ファイルの公開も自前でaddServlet()などする必要があります。
<br />
静的ファイルやライブラリjarファイルの呼び出しが出てきたら、次に紹介するweb.xml付きのパターンにした方が楽ちんです。
<br />
</p>

<h3 id="ide98040">web.xml有り版</h3>

<p class="paragraph">
j2/j2.groovy:
<br />
</p>
<pre class="plugin_pre">
import org.eclipse.jetty.server.*
import org.eclipse.jetty.webapp.*
import groovy.servlet.*

@Grab(group=&#039;org.eclipse.jetty.aggregate&#039;, module=&#039;jetty-all&#039;, version=&#039;8.1.7.v20120910&#039;)
def server = new Server(8080)
def webapp = new WebAppContext(&#039;.&#039;, &#039;/&#039;)
server.handler = webapp
server.start()
server.join()
</pre>

<p class="paragraph">
j2/WEB-INF/web.xml:
<br />
</p>
<pre class="plugin_pre">
&lt;web-app&gt;
  &lt;servlet&gt;
      &lt;servlet-name&gt;Groovlet&lt;/servlet-name&gt;
      &lt;servlet-class&gt;groovy.servlet.GroovyServlet&lt;/servlet-class&gt;
    &lt;/servlet&gt;
  &lt;servlet&gt;
      &lt;servlet-name&gt;Template&lt;/servlet-name&gt;
      &lt;servlet-class&gt;groovy.servlet.TemplateServlet&lt;/servlet-class&gt;
    &lt;/servlet&gt;
  &lt;servlet-mapping&gt;
      &lt;servlet-name&gt;Groovlet&lt;/servlet-name&gt;
      &lt;url-pattern&gt;*.groovy&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
  &lt;servlet-mapping&gt;
      &lt;servlet-name&gt;Template&lt;/servlet-name&gt;
      &lt;url-pattern&gt;*.gsp&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
&lt;/web-app&gt;
</pre>

<p class="paragraph">
j1からg1.groovyやg2.gspなどをコピペしてきます。
<br />
</p>
<pre>j2/
    j2.groovy
    g1.groovy
    g2.gsp
    WEB-INF/web.xml
</pre>

<p class="paragraph">
実行:
<br />
</p>
<pre>$ cd j2/
$ groovy j2.groovy
</pre>

<p class="paragraph">
web.xml有り版の場合はWebアプリとしてdeployされるためか、静的コンテンツなども通常のWebアプリと同じお作法で配置し、公開できます。
<br />
</p>


<h3 id="id79fc22">Windows環境での正体不明のトラブル</h3>

<p class="paragraph">
最初、Windows上で実験してたんです。
<br />
&quot;g1.groovy&quot;への1度目のアクセスは正常に動作します。
<br />
ところが、2回目以降のアクセスではなぜか以下の様なスタックトレースが発生し、404が返されてしまいます。
<br />
</p>
<pre class="plugin_pre">
java.io.IOException: ファイル名、ディレクトリ名、またはボリューム ラベルの構文が間違っています。
        at java.io.WinNTFileSystem.canonicalize0(Native Method)
        at java.io.Win32FileSystem.canonicalize(Win32FileSystem.java:414)
        at java.io.File.getCanonicalPath(File.java:589)
        at org.eclipse.jetty.util.resource.FileResource.getAlias(FileResource.java:191)
        at org.eclipse.jetty.server.handler.ContextHandler.getResource(ContextHandler.java:1569)
        at org.eclipse.jetty.webapp.WebAppContext.getResource(WebAppContext.java:346)
        at org.eclipse.jetty.webapp.WebAppContext$Context.getResource(WebAppContext.java:1248)
        at groovy.servlet.AbstractHttpServlet.getResourceConnection(AbstractHttpServlet.java:182)
        at groovy.util.GroovyScriptEngine.isSourceNewer(GroovyScriptEngine.java:564)
        at groovy.util.GroovyScriptEngine.loadScriptByName(GroovyScriptEngine.java:496)
        at groovy.util.GroovyScriptEngine.createScript(GroovyScriptEngine.java:549)
        at groovy.util.GroovyScriptEngine.run(GroovyScriptEngine.java:536)
        at groovy.servlet.GroovyServlet$1.call(GroovyServlet.java:120)
        at org.codehaus.groovy.runtime.GroovyCategorySupport$ThreadCategoryInfo.use(GroovyCategorySupport.java:109)
        at org.codehaus.groovy.runtime.GroovyCategorySupport$ThreadCategoryInfo.access$400(GroovyCategorySupport.java:65)
        at org.codehaus.groovy.runtime.GroovyCategorySupport.use(GroovyCategorySupport.java:249)
        at groovy.servlet.GroovyServlet.service(GroovyServlet.java:129)
        at javax.servlet.http.HttpServlet.service(HttpServlet.java:802)
        at org.eclipse.jetty.servlet.ServletHolder.handle(ServletHolder.java:648)
</pre>

<p class="paragraph">
TemplateServlet(&quot;g2.gsp&quot;)は影響を受けず、何度アクセスしても正常に動作してくれます。GroovyServletの場合だけこうなってしまうという謎・・・。
<br />
</p>

<p class="paragraph">
今回の記事ではまずした準備で書いた org.eclipse.jetty.orbit 経由の javax.servlet のインストールで1時間以上嵌ってしまい、さらにこの謎のスタックトレースで2時間ほど嵌りました。最終的に &quot;java.io.WinNTFileSystem.canonicalize0&quot; でWindows上でのファイル名の形式がおかしくなってるのかも・・・ならばUnix系のMacなら、とMacで試してみたらあっさりと動いてしまいました。
<br />
</p>

<p class="paragraph">
(上記スタックトレースの原因と回避策について以下に追記しました：2012-10-08)
<br />
</p>

<h4 id="id443412">GroovyServlet経由で&quot;.groovy&quot;にアクセスした時に、2回目以降で&quot;Script not found, sending 404.&quot;とスタックトレースが発生する場合の回避策</h4>

<p class="paragraph">
非常に原因を掴みづらいトラブルですが、GroovyServlet経由で&quot;.groovy&quot;にアクセスした時、1回目のアクセスは正常に動作するのに、2回目以降のアクセスで404発生、JettyなどServletContainer側で例外が発生しスタックトレースと&quot;Script not found, sending 404.&quot;というエラーメッセージが出力される場合があります。
<br />
その場合、以下の様な方法で404とスタックトレースを回避することが可能です。(Groovy 1.8.8 + Jetty 8, Win7SP1, JDK1.7で確認)
<br />
</p>

<h5 id="id0a1fb8">回避策：groovy.servlet.GroovyServletを継承した独自のServletクラスでgetResourceConnection()をカスタマイズする。</h5>

<p class="paragraph">
詳細は後述しますが、groovy.servlet.AbstractHttpServletで実装されているgetResourceConnection()に、1行だけ追加したServletクラスを追加します。
<br />
</p>
<ol><li> 手っ取り早くgroovy.servlet.GroovySerlvetを継承しただけの空っぽのクラスをJavaでもGroovyでも良いので作成。</li>
<li> groovy.servlet.AbstractHttpServletのgetResourceConnection()メソッドのシグネチャをコピペしてくる。</li>
<li> getResourceConnection()では最初に次の1行を実行したら、すぐに親クラス(super)のgetResourceConnection()に処理を委譲する。: if (name.startsWith(&quot;file:&quot;)) name = name.replaceFirst(&quot;file:&quot;, &quot;&quot;);</li>
<li> web.xmlでgroovy.servlet.GroovyServletではなく、今回作成したServletクラスで&quot;.groovy&quot;を処理させる。</li></ol>

<p class="paragraph">
今回は以下の様な構成にしました。
<br />
</p>
<pre class="plugin_pre">
WEB-INF/
    web.xml
    classes/
        groovy/
            servlet/
                MyGroovyServlet.groovy
</pre>
<p class="paragraph">
MyGroovyServlet.groovy:
<br />
</p>
<pre class="plugin_pre">
package groovy.servlet

import groovy.servlet.*

public class MyGroovyServlet extends GroovyServlet {

    public URLConnection getResourceConnection(String name) throws ResourceException {
        if (name.startsWith(&quot;file:&quot;)) name = name.replaceFirst(&quot;file:&quot;, &quot;&quot;)
        return super.getResourceConnection(name)
    }
}
</pre>

<p class="paragraph">
groovycでコンパイルしておきます。
<br />
</p>
<pre>$ cd WEB-INF/classes/
$ groovyc groovy/servlet/MyGroovyServlet.groovy
</pre>

<p class="paragraph">
WEB-INF/web.xml:
<br />
</p>
<pre class="plugin_pre">
&lt;web-app&gt;
  &lt;!-- ... --&gt;
  &lt;servlet&gt;
    &lt;servlet-name&gt;Groovlet&lt;/servlet-name&gt;
    &lt;!-- 自分でカスタマイズしたServletクラスを指定してます。 --&gt;
    &lt;servlet-class&gt;groovy.servlet.MyGroovyServlet&lt;/servlet-class&gt;
  &lt;/servlet&gt;
  &lt;!-- ... --&gt;
  &lt;servlet-mapping&gt;
    &lt;servlet-name&gt;Groovlet&lt;/servlet-name&gt;
    &lt;url-pattern&gt;*.groovy&lt;/url-pattern&gt;
  &lt;/servlet-mapping&gt;
  &lt;!-- ... --&gt;
&lt;/web-app&gt;
</pre>

<p class="paragraph">
これで、2回目以降のアクセスでも正常に動作するGroovyServletでお手軽プログラミングが楽しめるようになります。
<br />
</p>

<h5 id="id58626a">2回目以降のアクセスでトラブルになる原因</h5>

<p class="paragraph">
GroovyScriptEngineのキャッシュ更新チェック時に、すでに&quot;file:&quot;スキーマのURL展開されたものに対してServletContext.getResource()を呼んでしまっていることが原因です。
<br />
</p>

<p class="paragraph">
まず今回のトラブルに関連する箇所に絞って、GroovyServletが&quot;.groovy&quot;ファイルを実行する仕組みを簡単に解説します。
<br />
GroovyServletはGroovyScriptEngineで指定されたgroovyファイルを実行しています。この時、リクエストの度に毎回GroovyScriptEngineを初期化するのではなく、Servletのinit()中に初期化したGroovyScriptEngineを使いまわしています。
<br />
GroovyScriptEngineでは、一度実行したスクリプトについては内部でキャッシュしています。同じスクリプト名を実行するとき、GroovyScriptEngineは指定されたスクリプト名の&quot;リソース&quot;の最終更新日を調べ、再コンパイルが必要か判断しています。
<br />
GroovyScriptEngineではgroovy.util.ResourceConnectorのgetResourceConnection()を介して「スクリプト名」から実際のスクリプトを取り出しています。この時、実際のスクリプトはURLConnectionの形で取り出され、スクリプトのキャッシュはURLConnection.getURL().toExternalForm()の戻り値をキーとしてキャッシュされる・・・ようです。(すみません、ここちょっと不確かで、GroovyScriptEngine中でのscriptCache.get()メソッドの呼び出しは全てURL.toExternalForm()の値を引数にしているんですが、scriptCache.put()のキー値がどういう表現になるのか確認しきれていません)
<br />
</p>

<p class="paragraph">
ファイルシステム上のスクリプト名を取り出す場合は、「スクリプト名」ほぼイコール「ファイル名」でほぼそのままURLに変換できます。
<br />
しかしServletContainer上で指定された場合、「スクリプト名」は &quot;/foo/bar/baz.groovy&quot; のようなURLパス名で指定されてきます。これを、ServletContextのgetResource()を使って、実際に展開されているファイル名に変換する必要があります。
<br />
この変換処理を実装しているのが、groovy.servlet.AbstractHttpServletで実装されているgetResourceConnection()メソッドになります(AbstractHttpServletはResourceConnectorを実装しています)。
<br />
</p>

<p class="paragraph">
実際にローカルファイルシステム上でのファイルパスをURLで取り出しtoExternalForm()に変換すると、以下のようになります。
<br />
</p>
<pre>Windows: file:C:¥foo¥bar¥baz.groovy
Mac: file:/foo/bar/baz.groovy
</pre>

<p class="paragraph">
ここまでを踏まえて、デフォルトの実装のGroovyServletがURLで指定された&quot;.groovy&quot;をどう処理するか1回目と2回目で見ていきます。
<br />
1回目:
<br />
</p>
<ol><li> URLで指定されたURLをGroovyScriptEngineに渡す。</li>
<li> GroovyScriptEngineはResourceConnectorのgetResourceConnection()を呼び出す。</li>
<li> この時呼び出されるResourceConnectorはGroovyServlet、ひいてはAbstractHttpServletのインスタンスになる。(GroovyServletがinit()中でGroovyServletEngineのコンストラクタで、ResourceConnectorとして自分自身のthisを渡している)</li>
<li> AbstractHttpServletのgetResourceConnection()により、URLからServletContext.getResource()により実際のファイルパスのURLに変換される。</li>
<li> GroovyScriptEngine内でisSourceNewer()によりキャッシュが無いかチェックされるが、1回目では当然キャッシュされていないので、そのままキャッシュにputされる。</li></ol>

<p class="paragraph">
2回目:
<br />
</p>
<ol><li> isSourceNewer()までは同じ。</li>
<li> isSourceNewer()内でスクリプトのキャッシュについて最終更新日を確認するが、この時キャッシュのスクリプト名について再度ResourceConnectorのgetResourceConnection()を呼び出す。</li></ol>

<p class="paragraph">
この2回目以降のisSourceNewer()内のgetResourceConnection()の呼び出しが問題で、Macの場合は2回目以降では
<br />
</p>
<pre>&quot;/foo/bar/baz.groovy&quot;
</pre>
<p class="paragraph">
がgetResourceConnection()に渡されてきます。この形式であれば、AbstraceHttpServlet内ではServletContextのgetRealPath(&quot;/&quot;)で親ディレクトリを取り出し、&quot;/baz.groovy&quot;まで戻した上で再度 ServletContext.getResource(&quot;/baz.groovy&quot;)で正しいファイルパスのURLConnectionを返すことが出来ます。つまりAbstractHttpServletのデフォルト実装で正常に期待通りの動作をしてくれます。
<br />
ところがWindowsの場合、なぜか2回目以降では
<br />
</p>
<pre>&quot;file:C:¥foo¥bar¥baz.groovy&quot;
</pre>
<p class="paragraph">
というのが渡されてきてしまいます。これでは、AbstractHttpServletのデフォルト実装では元の&quot;/baz.groovy&quot;に戻せません。よって、これがそのまま ServletContext.getResource(&quot;file:C:¥foo¥bar¥baz.groovy&quot;)の呼び出しになってしまい、不正なファイルパスとして例外が発生し、以下のようなスタックトレースになってしまったわけです。
<br />
</p>

<pre>java.io.IOException: ファイル名、ディレクトリ名、またはボリューム ラベルの構文が間違っています。
       at java.io.WinNTFileSystem.canonicalize0(Native Method)
       ...
       at org.eclipse.jetty.webapp.WebAppContext$Context.getResource(WebAppContext.java:1248)
       at groovy.servlet.AbstractHttpServlet.getResourceConnection(AbstractHttpServlet.java:182)
       (ここでちょうど、isSourceNewerからAbstractHttpServletのgetResourceConnection()が呼ばれてます)
       at groovy.util.GroovyScriptEngine.isSourceNewer(GroovyScriptEngine.java:564)
       at groovy.util.GroovyScriptEngine.loadScriptByName(GroovyScriptEngine.java:496)
       at groovy.util.GroovyScriptEngine.createScript(GroovyScriptEngine.java:549)
       at groovy.util.GroovyScriptEngine.run(GroovyScriptEngine.java:536)
       ...
</pre>

<h5 id="iddd11a7">回避策の解説</h5>

<p class="paragraph">
ここまで判明し、さてどうやってこの問題を回避するか、となるわけですが、たかがお手軽WebプログラミングをしたいがためだけにGroovyScriptEngineまで手を出す余裕はありません。
<br />
「その場限りの」アドホック対応として、getResourceConnection()に&quot;file:&quot;始まりの文字列が渡されてきたら先頭の&quot;file:&quot;を空文字列に置換してから処理するように修正します。これが回避策で示したMyGroovyServletのソースコードで、先頭の&quot;file:&quot;を空にしてから親の(=AbstractHttpServletの)本来のgetResourceConnection()の実装に渡しています。
<br />
回避策自体の本質はたったの1行なのですが、なぜその1行でOKなのか、という部分がServlet処理と言うよりはGroovyのScript処理の内部実装の話になってしまい、調査に時間を取られてしまいました。
<br />
</p>


<h3 id="id7a1ebd">参考：</h3>

<ul><li> Groovy - Grape<ul><li> <a class="externallink" href="http://groovy.codehaus.org/Grape" target="_blank">http://groovy.codehaus.org/Grape</a><ul><li> 一番下に、Jettyサーバを組み込んでTemplateServletを提供する例が載ってます。</li></ul></li></ul></li>
<li> GroovyServlet (groovy 2.0.4 API)<ul><li> <a class="externallink" href="http://groovy.codehaus.org/gapi/" target="_blank">http://groovy.codehaus.org/gapi/</a></li></ul></li>
<li> Groovy - Groovy Templates<ul><li> <a class="externallink" href="http://groovy.codehaus.org/Groovy+Templates" target="_blank">http://groovy.codehaus.org/Groovy+Templates</a><ul><li> 最後の方にweb.xmlで動かす場合のサンプルが載ってます。</li></ul></li></ul></li>
<li> Practically Groovy: Go server-side up, with Groovy<ul><li> <a class="externallink" href="http://www.ibm.com/developerworks/java/library/j-pg03155/" target="_blank">http://www.ibm.com/developerworks/java/library/j-pg03155/</a></li></ul></li></ul>

<p class="paragraph">
Jetty組み込み関連：
<br />
</p>
<ul><li> Jetty/Tutorial/Embedding Jetty - Eclipsepedia<ul><li> <a class="externallink" href="http://wiki.eclipse.org/Jetty/Tutorial/Embedding_Jetty" target="_blank">http://wiki.eclipse.org/Jetty/Tutorial/Embedding_Jetty</a></li></ul></li>
<li> Jetty/Reference/Dependencies - Eclipsepedia<ul><li> <a class="externallink" href="http://wiki.eclipse.org/Jetty/Reference/Dependencies" target="_blank">http://wiki.eclipse.org/Jetty/Reference/Dependencies</a></li></ul></li>
<li> Jetty/Tutorial/Jetty HelloWorld - Eclipsepedia<ul><li> <a class="externallink" href="http://wiki.eclipse.org/Jetty/Tutorial/Jetty_HelloWorld" target="_blank">http://wiki.eclipse.org/Jetty/Tutorial/Jetty_HelloWorld</a></li></ul></li></ul>

<p class="paragraph">
意外に苦労した点としては、GroovyやJetty組み込み関連のWikiページ資料などで使われているJettyのバージョンが古く(Jetty6や7)、Jetty8だとクラス名やパッケージ階層が(今回のような超基本的かつ単純なクラスでさえも)変更されてしまっていたため、いちいちJetty8のJavaDoc上で探し直して、引数なども再確認が必要だったのが手間でした。
<br />
</p>



<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-1172.html" title="Groovy/続・お手軽Web開発 (GroovyServlet, Hogan.groovy, Gradle, Tomcat)">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-1101.html" title="Groovy">Up</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-1101.html" title="Groovy">Groovy</a>&nbsp;]</li>
</ul>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/1103<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2001 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a target="_blank" href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" target="_blank" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>