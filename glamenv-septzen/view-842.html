<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>読書メモ/&quot;Advanced UNIX Programming&quot; - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">読書メモ/&quot;Advanced UNIX Programming&quot;</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2010-11-21 10:49:09 &nbsp; / &nbsp; last updated at: 2010-11-21 11:05:47<br>
カテゴリ: <a href="category-10.html">C言語</a>&nbsp;<a href="category-20.html">Linux</a>&nbsp;<a href="category-38.html">UNIX</a>&nbsp;<a href="category-46.html">読書</a>&nbsp;</div>

<div class="data_body">
<p class="paragraph">
2007年7月頃に購入していて、ず～っと本棚に眠っていたのを、ようやく読み終えることが出来ました。 
<br />
</p>
<a href="https://www.amazon.co.jp/dp/0131411543" target="_blank">Amazon | Advanced UNIX Programming (Addison-Wesley Professional Computing Series) | Rochkind, Marc J. | Unix</a><br>

<p class="paragraph">
amazon.comの方でレビューを見てみると、全て高評価レビューとなっています（星４～５つ）。
<br />
</p>

<p class="paragraph">
以下、自分自身が読んだ感想を、三行で乱暴にまとめてみます。
<br />
</p>
<ul><li> 実務でUNIXプログラミングをする時に考慮すべき要点を網羅してくれている。</li>
<li> 移植性を考慮したり、標準(POSIXやSUS)周辺の地雷を回避したい時に必携。</li>
<li><strong>読者のほうで読み方を工夫する必要がある本。</strong></li></ul>




<p class="paragraph">
まず一点目、実務でUNIXプログラミングをする上で突き当たる問題について、随所で言及・考察が加えられています。以下の三つが特に重点的に取り上げられています。
<br />
</p>
<ul><li> Synchronized / Synchronous : I/O処理での物理的な入出力処理とシステムコールの復帰タイミングの関係<ul><li> ファイル入出力のカーネルバッファ・ユーザーバッファ・非同期I/O処理関連</li></ul></li>
<li> Block : アクションが完了するまで戻ってこない(blockされる)システムコール<ul><li> ファイル入出力・マルチスレッド・シグナル処理関連</li></ul></li>
<li> Lock : リソース(ファイル, IPCオブジェクト)のロック<ul><li> ファイル入出力・POSIX/SystemV IPC・マルチスレッド</li></ul></li></ul>

<p class="paragraph">
いずれも実際のUNIXプログラミングでは避けて通れない問題です。本書では、かなりしつこくこれらの問題について突っ込んでいます。突っ込みすぎて読者によっては置いてけぼりになるかもしれませんが、経験者であればあるほど、「あー、この問題かー、自分もやったなー。」と相槌を打って楽しめることでしょう。
<br />
</p>

<p class="paragraph">
二点目。移植性や標準についてですが、非常に注意して書かれています。そもそも本書のサンプルコード自体が、著者がSolaris/SUSE Linux/FreeBSD/Darwinの４プラットフォームで動作確認しており、どのプラットフォームがどの規格をサポートしているのか丁寧に書かれています。ただ、サポート状況の説明が各システムコール毎の解説に分散してしまっているため、一覧性は良くないかもしれません。文章を隅々まで読み込む必要があります。
<br />
逆に、実務上特定のプラットフォームしか触らないよ、という人には本書の記述は重過ぎるかもしれません。
<br />
</p>

<p class="paragraph">
しかし、特定のプラットフォームしか触らないにせよ、移植性を考慮するにせよ、本書の重要性は変わりません。
<br />
SUSv3では1,108の関数が規定されていますが、本書ではその中から、UNIXシステムプログラミングに関連しないCライブラリ関数・古くて利用が推奨されていないもの・logやトランザクションなどUNIXシステムプログラミングに必須とはいえないものなどを除去した、厳選に厳選を重ねた307の関数をとりあげています。
<br />
つまり本書で取り上げられている関数は、「これからの」UNIXシステムプログラミングで安心して・安定して使える関数だということです。実際、古いsignal()やBSDスタイルのflock()などはバッサリと切り捨てられ、代わりにsigaction()やlockf()/fcntl()によるロックが解説されています。
<br />
また、パス名やファイル記述子、IPCリソースなどの各種「上限値」の取得方法についても随所でsysconf()やpathconf()を使って紹介されているので、そうした情報を調べたいときにも役立ちます。
<br />
</p>

<p class="paragraph">
最後に読み方を工夫する必要がある点です。というのは、文章の内容が濃く、サンプルコードも初心者向きのレベルではないからです。
<br />
個人的な意見ですが、本書は「サンプルコードを自分で打ち込んで、動かして、実験して学ぶ本」ではありません。
<br />
「実務上、あるカテゴリのシステムコールを特に詳しく調査する必要が生じたときに、参考資料としてアイデアを頂戴する本」だと思います。
<br />
よって読者レベルにかかわらず、生真面目に文章の隅々まで、そしてサンプルコードを自分で打ち込んで読破する読み方はおすすめできません。たぶん、途中で精根尽き果ててしまうのではないでしょうか。
<br />
</p>

<p class="paragraph">
他の入門書を一冊読み終えた位のビギナーであれば、サンプルコードはもとより解説の大半も読み飛ばして結構だと思います。システムコールの網羅性は高いので、UNIXシステムプログラミングの世界地図として俯瞰して眺める程度でも罰は当たらないでしょう。
<br />
実務で実際にUNIXシステムプログラミングを経験したレベルの人であれば、ざっくりと斜め読みで通読程度でも問題ないでしょう。お仕事で必要に迫られて調査するときに、「あ～、確かこのカテゴリのシステムコール or 同期とか再突入問題とかマルチスレッド＋シグナル＋fork-execの最凶タッグ問題、AUPのどこそこに書いてあったな～」と思い出して、その時に詳しい解説やサンプルコードまで読み込む、というスタイルで良いと思います。
<br />
</p>

<p class="paragraph">
最後に、自分の読書時のメモを残しておきます。
<br />
</p>

<ul><li><a href="#id2ff421">サンプルコードとサポートサイト</a></li>
<li><a href="#id8c7037">読書メモさまざま</a><ul><li><a href="#idd719b3">p76 : O_RDONLY, O_WRONLY, O_RDWR : なんで O_RDONLY | O_WRONLY じゃだめなの？</a></li>
<li><a href="#id14271d">p88 : 2.7 Creating Temporary Files</a></li>
<li><a href="#iddb86e5">p90 : 2.8 File Offsets and O_APPEND</a></li>
<li><a href="#idd1df82">p137 : &quot;Hard and Symbolic Links&quot;</a></li>
<li><a href="#id4bd3ab">162p : struct dirent の d_ino とマウントポイントについて</a></li>
<li><a href="#id9ec9a4">164p : C言語の小技</a></li>
<li><a href="#id4cf5f9">c4/scrappc.h : bool定義について</a></li>
<li><a href="#idaa3dee">p314 : SIGCHLD + SA_NOCLDWAIT + SIG_IGN</a></li>
<li><a href="#id69b87c">c8/br.c の謎の &quot;__func__&quot; マクロ</a></li></ul></li>
<li><a href="#id9439e8">マルチスレッド＋シグナル＋fork-execの最凶タッグについて</a></li></ul>
<hr />
<h3 id="id2ff421">サンプルコードとサポートサイト</h3>

<p class="paragraph">
本書のサポートサイトは以下のURLになります。
<br />
</p>
<ul><li> Advanced UNIX Programming - Home<ul><li> <a class="externallink" href="http://basepath.com/aup/" target="_blank">http://basepath.com/aup/</a></li></ul></li></ul>

<p class="paragraph">
サンプルコードのダウンロード：
<br />
</p>
<ul><li> Advanced UNIX Programming - Download<ul><li> <a class="externallink" href="http://basepath.com/aup/download.htm" target="_blank">http://basepath.com/aup/download.htm</a></li></ul></li></ul>

<p class="paragraph">
サンプルコードはそのままではコンパイルできません。サイト上で公開されているawkスクリプトを別途DLし、環境変数を整えた上でMakefileを生成する必要があります。詳しくは以下のURLを参照してください。
<br />
</p>
<ul><li> Advanced UNIX Programming - Compile Examples<ul><li> <a class="externallink" href="http://basepath.com/aup/compile.htm" target="_blank">http://basepath.com/aup/compile.htm</a></li></ul></li></ul>

<p class="paragraph">
awkスクリプトを別途ダウンロードする、というのを知らずに、小一時間ほど「なんでMakefileが間違ってるんだろう～？」と悩みました。本書があくまでも&quot;Advanced&quot;であり、ビギナーなど眼中に無いことを思い知らされました。
<br />
</p>

<p class="paragraph">
自分はCentOS 5.xを使いましたが、以下のsetenv.shを用意して &quot;. setenv.sh&quot; すればOKにしています。
<br />
setenv.sh
<br />
</p>
<pre>#!/bin/sh
AUPSRC=/home/msakamoto/in_vitro/lang.c/AUP
OS=LINUX
LIBS=&quot;-lncurses -lutil -lrt&quot;
TLIBS=&quot;-pthread&quot;
export AUPSRC OS LIBS TLIBS
</pre>

<p class="paragraph">
awkスクリプトでMakefileを再生成するために、以下の makeall.sh というスクリプト使いました。
<br />
</p>
<pre class="plugin_pre">
#!/bin/sh -x

. setenv.sh

for i in common c1 c2 c3 c4 c5 c6 c7 c8 c9
do
        awk -f $AUPSRC/makebuild.awk $AUPSRC/$i/makebuild.spec &gt;$AUPSRC/$i/Makefile
        pushd $i
        #make clean
        make
        if [ 0 -ne $? ] ; then
                popd
                exit 1
        fi
        popd
done
</pre>

<h3 id="id8c7037">読書メモさまざま</h3>

<p class="paragraph">
読んでいて「へ～～へ～～、メモっとこう」と思った箇所をいくつか書き留めておきます。もっとも、Chapter5あたりからその気力すら失われました。マジで、隅々まで読み込むのはエネルギー吸い取られます。
<br />
</p>

<h4 id="idd719b3">p76 : O_RDONLY, O_WRONLY, O_RDWR : なんで O_RDONLY | O_WRONLY じゃだめなの？</h4>

<p class="paragraph">
→O_RDONLYは0で実装されてるから。・・・うわぁ・・・。
<br />
ex/o_rdwr.c:
<br />
</p>
<div class="hl-main"><pre><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">unistd.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">sys/types.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">sys/stat.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
</span><span >#include</span><span > </span><span class="hl-quotes">&lt;</span><span class="hl-string">fcntl.h</span><span class="hl-quotes">&gt;</span><span ></span><span class="hl-code">
 
</span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">(</span><span >void</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">fd</span><span class="hl-code"> = -</span><span class="hl-number">1</span><span class="hl-code">;
    </span><span >char</span><span class="hl-code"> </span><span class="hl-identifier">buf</span><span class="hl-brackets">[</span><span class="hl-number">100</span><span class="hl-brackets">]</span><span class="hl-code">;
    </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">nread</span><span class="hl-code"> = </span><span class="hl-number">0</span><span class="hl-code">, </span><span class="hl-identifier">nwrite</span><span class="hl-code"> = </span><span class="hl-number">0</span><span class="hl-code">;
    </span><span >char</span><span class="hl-code"> </span><span class="hl-identifier">mes</span><span class="hl-brackets">[</span><span class="hl-brackets">]</span><span class="hl-code"> = </span><span class="hl-quotes">&quot;</span><span class="hl-string">abc</span><span class="hl-quotes">&quot;</span><span class="hl-code">;
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">O_RDONLY = 0x%08X</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">O_RDONLY</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">O_WRONLY = 0x%08X</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">O_WRONLY</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">O_RDWR = 0x%08X</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">O_RDWR</span><span class="hl-brackets">)</span><span class="hl-code">;
 
    </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> TEST for O_RDONLY | O_WRONLY </span><span class="hl-mlcomment">*/</span><span class="hl-code">
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">-</span><span class="hl-number">1</span><span class="hl-code"> == </span><span class="hl-brackets">(</span><span class="hl-identifier">fd</span><span class="hl-code"> = </span><span class="hl-identifier">open</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">test.dat</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">O_RDONLY</span><span class="hl-code"> | </span><span class="hl-identifier">O_WRONLY</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">test.dat</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">1</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">-</span><span class="hl-number">1</span><span class="hl-code"> == </span><span class="hl-brackets">(</span><span class="hl-identifier">nwrite</span><span class="hl-code"> = </span><span class="hl-identifier">write</span><span class="hl-brackets">(</span><span class="hl-identifier">fd</span><span class="hl-code">, </span><span class="hl-identifier">mes</span><span class="hl-code">, </span><span class="hl-number">3</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">write(O_RDONLY | O_WRONLY)</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code"> </span><span class="hl-reserved">else</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">written size : %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">nwrite</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">-</span><span class="hl-number">1</span><span class="hl-code"> == </span><span class="hl-identifier">lseek</span><span class="hl-brackets">(</span><span class="hl-identifier">fd</span><span class="hl-code">, </span><span class="hl-number">0</span><span class="hl-code">, </span><span class="hl-identifier">SEEK_SET</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">lseek(0, (O_RDONLY | O_WRONLY))</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">2</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">-</span><span class="hl-number">1</span><span class="hl-code"> == </span><span class="hl-brackets">(</span><span class="hl-identifier">nread</span><span class="hl-code"> = </span><span class="hl-identifier">read</span><span class="hl-brackets">(</span><span class="hl-identifier">fd</span><span class="hl-code">, </span><span class="hl-identifier">buf</span><span class="hl-code">, </span><span class="hl-number">100</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">read(O_RDONLY | O_WRONLY)</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code"> </span><span class="hl-reserved">else</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">read size : %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">nread</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">contents = [%s]</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">buf</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-identifier">close</span><span class="hl-brackets">(</span><span class="hl-identifier">fd</span><span class="hl-brackets">)</span><span class="hl-code">;
 
    </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> TEST for O_RDWR </span><span class="hl-mlcomment">*/</span><span class="hl-code">
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">-</span><span class="hl-number">1</span><span class="hl-code"> == </span><span class="hl-brackets">(</span><span class="hl-identifier">fd</span><span class="hl-code"> = </span><span class="hl-identifier">open</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">test.dat</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">O_RDWR</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">test.dat</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">1</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">-</span><span class="hl-number">1</span><span class="hl-code"> == </span><span class="hl-brackets">(</span><span class="hl-identifier">nwrite</span><span class="hl-code"> = </span><span class="hl-identifier">write</span><span class="hl-brackets">(</span><span class="hl-identifier">fd</span><span class="hl-code">, </span><span class="hl-identifier">mes</span><span class="hl-code">, </span><span class="hl-number">3</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">write(O_RDWR)</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code"> </span><span class="hl-reserved">else</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">written size : %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">nwrite</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">-</span><span class="hl-number">1</span><span class="hl-code"> == </span><span class="hl-identifier">lseek</span><span class="hl-brackets">(</span><span class="hl-identifier">fd</span><span class="hl-code">, </span><span class="hl-number">0</span><span class="hl-code">, </span><span class="hl-identifier">SEEK_SET</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">lseek(0, (O_RDWR))</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">2</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">-</span><span class="hl-number">1</span><span class="hl-code"> == </span><span class="hl-brackets">(</span><span class="hl-identifier">nread</span><span class="hl-code"> = </span><span class="hl-identifier">read</span><span class="hl-brackets">(</span><span class="hl-identifier">fd</span><span class="hl-code">, </span><span class="hl-identifier">buf</span><span class="hl-code">, </span><span class="hl-number">100</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">read(O_RDWR)</span><span class="hl-quotes">&quot;</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code"> </span><span class="hl-reserved">else</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">read size : %d</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">nread</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">&quot;</span><span class="hl-string">contents = [%s]</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">&quot;</span><span class="hl-code">, </span><span class="hl-identifier">buf</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-identifier">close</span><span class="hl-brackets">(</span><span class="hl-identifier">fd</span><span class="hl-brackets">)</span><span class="hl-code">;
 
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<pre class="plugin_pre">
$ gcc -o o_rdwr o_rdwr.c
$ touch test.dat
$ ./o_rdwr
O_RDONLY = 0x00000000
O_WRONLY = 0x00000001
O_RDWR = 0x00000002
written size : 3
read(O_RDONLY | O_WRONLY): Bad file descriptor
written size : 3
read size : 3
contents = [abc]
</pre>
<p class="paragraph">
・・・これはやられた・・・
<br />
</p>

<h4 id="id14271d">p88 : 2.7 Creating Temporary Files</h4>

<p class="paragraph">
「デーモン君のソース探検」Chapter 15, mktemp も参照。
<br />
</p>

<h4 id="iddb86e5">p90 : 2.8 File Offsets and O_APPEND</h4>

<p class="paragraph">
ん？open(..., | O_APPEND)直後の lseek(fd, 0, SEEK_CUR)が0を返す？write()やその後のlseek()は合ってるのに？
<br />
→同様の人、居た。
<br />
</p>
<ul><li> lseek( ) on file opened with O_APPEND<ul><li> <a class="externallink" href="http://unix.derkeiler.com/Newsgroups/comp.unix.programmer/2003-11/0547.html" target="_blank">http://unix.derkeiler.com/Newsgroups/comp.unix.programmer/2003-11/0547.html</a></li></ul></li></ul>

<p class="paragraph">
これ、ちゃんとAPUEとか読むとwrite(2)のほうに載ってるんだけど・・・
<br />
</p>
<pre>If the O_APPEND option was specified when the file was opened, 
the file&#039;s offset is set to the current end of file before each 
write operation.
</pre>
<p class="paragraph">
つまり、open()の直後にオフセットが変更されるのではなく、write(2)の「直前に」自動的に変更されると言っている！！
<br />
OpenGroupのopen(2)ですらも、
<br />
</p>
<pre>O_APPEND
   If set, the file offset shall be set to the end of the file prior to each write.
</pre>
<p class="paragraph">
つまり「毎回のwriteの直前に」としか書いていない。open(2)の直後ではないというわけだ。
<br />
O_APPENDのキモは「writeする直前に自動lseek」である。というわけで、プロセス二つ起動してwrite()させてみた。
<br />
</p>
<pre class="plugin_pre">
[ttyAに切り替え]
$ touch test.dat
$ ./o_append2

[ttyBに切り替え]
$ ./o_append2

[ttyAに切り替え]
write(1) ?

written size : 3
offset(1): 3
write(2) ?

[ttyBに切り替え]
write(1) ?

written size : 3
offset(1): 6      # ちゃんとttyA側でwriteした分がseekされてる。
write(2) ?

[ttyAに切り替え]
written size : 3
offset(2): 9      # ちゃんとttyB側でwriteした分がseekされてる。

[ttyBに切り替え]

written size : 3
offset(2): 12
</pre>
<p class="paragraph">
O_APPENDをはずしてしまうと、writeの直前の自動lseek()が行われないため、各プロセス毎に独立してwrite(2)する。
<br />
結果として、複数のプロセスが平行してwrite(2)したとき、他のプロセスがwrite(2)したデータを上書きしてしまう。
<br />
</p>
<pre class="plugin_pre">
[ttyAに切り替え]
$ touch test.dat
$ ./o_append3

[ttyBに切り替え]
$ ./o_append3

[ttyAに切り替え]
write(1) ?

written size : 3
offset(1): 3
write(2) ?

[ttyBに切り替え]
write(1) ?

written size : 3
offset(1): 3      # ttyA側を無視して、オフセット0からwriteしてる。
write(2) ?

[ttyAに切り替え]
written size : 3
offset(2): 6      # ttyB側を同様に無視。

[ttyBに切り替え]

written size : 3
offset(2): 6
</pre>

<h4 id="idd1df82">p137 : &quot;Hard and Symbolic Links&quot;</h4>

<p class="paragraph">
Linux/UNIXと付き合い始めてはや6年。実は、これまでhardlinkをまともに使ったことが無いという事実。いや・・・だってさ・・・シンボリックリンクでほとんど事足りちゃうんだもん・・・。ごめんね、hardlink。
<br />
</p>

<p class="paragraph">
で、ためしに、hardlinkしたファイルがファイルシステムをまたいでmvされちゃうとどうなるのか試してみた。
<br />
</p>
<pre class="plugin_pre">
$ mkdir hardlink
$ echo &quot;12345&quot; &gt; hardlink/file1
$ echo &quot;67890&quot; &gt; hardlink/file2
$ ln ./hardlink/file1 pfile1
$ ln ./hardlink/file2 pfile2
$ ls -il
1250716 -rw-rw-r-- 2 msakamoto msakamoto    6 11月 15 19:52 pfile1
1250717 -rw-rw-r-- 2 msakamoto msakamoto    6 11月 15 19:52 pfile2
$ cd hardlink/
ls -il
1250716 -rw-rw-r-- 2 msakamoto msakamoto 6 11月 15 19:52 file1
1250717 -rw-rw-r-- 2 msakamoto msakamoto 6 11月 15 19:52 file2
$ cd ..
</pre>
<p class="paragraph">
この時点で、こんな感じ。
<br />
</p>
<pre>./pfile1 =&gt; hardlink/file1へのhardlink (i-node = 1250716)
./pfile2 =&gt; hardlink/file2へのhardlink (i-node = 1250717)
./hardlink/file1 (i-node = 1250716)
./hardlink/file2 (i-node = 1250717)
</pre>

<p class="paragraph">
で、ファイルシステムをまたいでmvしてみる。ちょうど&quot;/boot&quot;がマウントポイントが分かれていたので、rootになって &quot;./hardlink&quot; ディレクトリをmvしてみる。
<br />
</p>
<pre>$ su
# strace mv hardlink /boot/
...
</pre>
<p class="paragraph">
straceコマンドでシステムコールを追ってみると、ファイルを個別に<strong>コピー</strong>したり、結構大変なことやってる。
<br />
hardlinkしていたpfile1, pfile2の方を見てみる。
<br />
</p>
<pre>$ ls -il
1250716 -rw-rw-r-- 1 msakamoto msakamoto    6 11月 15 19:52 pfile1
1250717 -rw-rw-r-- 1 msakamoto msakamoto    6 11月 15 19:52 pfile2
</pre>
<p class="paragraph">
リンク数は1に減少してる。実体は存在している。結局、この場合のmvはstrace結果からも分かるように実質的には&quot;copy&quot;だった。
<br />
</p>

<h4 id="id4bd3ab">162p : struct dirent の d_ino とマウントポイントについて</h4>

<p class="paragraph">
struct dirent : d_inoを参照するときは、マウントポイントか注意すること。
<br />
d_inoはディレクトリの存在するファイルシステム上のi-nodeになる。
<br />
マウントポイントの場合で、マウント先のファイルシステムのi-nodeを必要とする場合はd_inoは使えない。
<br />
d_nameメンバを使って、stat(2)なども活用してディレクトリ階層をたどっていく。
<br />
</p>

<p class="paragraph">
・・・これ、結構忘れそうだな・・・。「あ、わざわざd_name辿らなくても、d_inoがあるじゃん、ラッキー」ってなりそう。
<br />
</p>

<h4 id="id9ec9a4">164p : C言語の小技</h4>

<pre>while (errno = 0, (entry = readdir(dir)) != NULL)
</pre>
<p class="paragraph">
あ、コンマのこんな使い方あったんだ。
<br />
</p>

<h4 id="id4cf5f9">c4/scrappc.h : bool定義について</h4>

<p class="paragraph">
サンプルコードの &quot;c4/scrappc.h&quot; でC++のbool定義に関連したコンパイルエラーが発生したので、原因と対処方法をメモ。
<br />
</p>

<p class="paragraph">
まず原因。
<br />
</p>
<pre>#include &quot;defs.h&quot;
</pre>
<p class="paragraph">
してから、
<br />
</p>
<pre>#include &lt;curses.h&gt;
</pre>
<p class="paragraph">
してる。で、一応bool定義の対処もされてるんだけど、CentOS5の場合はそれでは不十分。
<br />
curses.hの中ではC++と互換性を持つboolを定義するstdbool.hを呼んでるんだけど、defs.hの中でもstdbool.hをincludeしてる。
<br />
</p>

<p class="paragraph">
で、bool定義の対処が問題で、
<br />
</p>
<pre>#define bool bool_aup
#include &quot;defs.h&quot;
#undef bool
#include &lt;curses.h&gt;
</pre>
<p class="paragraph">
という順番になってる。
<br />
そして、stdbool.hでは二重includeを防ぐように_STDBOOL_Hマクロで囲まれてる。
<br />
結果として、
<br />
</p>
<pre>defs.h
 -&gt; stdbool.h
#undef bool
</pre>
<p class="paragraph">
この時点でstdbool.hはincludeされてるが、bool定義だけ欠落した状態。
<br />
そして
<br />
</p>
<pre>#include &lt;curses.h&gt;
</pre>
<p class="paragraph">
では、
<br />
</p>
<pre>#include &lt;stdbool.h&gt;
</pre>
<p class="paragraph">
したあと、curses用の独自のNCURSES_BOOLをboolにdefineしてる。
<br />
</p>
<pre>#define NCURSES_BOOL bool
</pre>
<p class="paragraph">
もしstdbool.hがまだincludeされていなかったのであれば、この時点で正常にbool定義がされるわけだが、今回のケースではずっと上のほうですでにinclude済みで、しかもbool定義はundefされている。結果として、bool定義自体はロストしたまま処理が進んでしまう。
<br />
</p>

<p class="paragraph">
対処について。
<br />
ちょっと無理やりだけどstdbool.hをもう一度includeさせる。
<br />
</p>
<pre>#include &lt;curses.h&gt;
</pre>
<p class="paragraph">
の上に
<br />
</p>
<pre>#undef _STDBOOL_H
</pre>
<p class="paragraph">
を置けば、二重includeチェック用のマクロをクリアできるので、defineなどのプリプロセッサも再処理される。
<br />
</p>

<p class="paragraph">
一応defs.hの中では、stdbool.hのincludeをSKIP_BOOLマクロでON/OFFできるようにはなってるんだけど、&quot;-DSKIP_BOOL&quot;をつけてみると今度は&quot;common/ec.h&quot;の中でもbool定義を使ってるのでそこでエラーになってしまう。事実上、defs.h中でのstdbool.hは外せない。
<br />
</p>

<p class="paragraph">
う～ん・・・ポータビリティって難しいなあ・・・。
<br />
</p>

<p class="paragraph">
参考：
<br />
</p>
<ul><li> Where is stdbool.h? - Stack Overflow<ul><li> <a class="externallink" href="http://stackoverflow.com/questions/1656874/where-is-stdbool-h" target="_blank">http://stackoverflow.com/questions/1656874/where-is-stdbool-h</a></li></ul></li>
<li> &quot;#include&quot;ファイルのトレース : gcc -H オプション</li></ul>

<h4 id="idaa3dee">p314 : SIGCHLD + SA_NOCLDWAIT + SIG_IGN</h4>

<p class="paragraph">
SIGCHLDに対してstruct sigactionのsa_flagsにSA_NOCLDWAIT を設定するのも、sa_handlerにSIG_IGNを設定するのも効果は同等。子プロセスがゾンビにならないようにする。
<br />
ただし、SIG_IGNを設定する方法はすべてのプラットフォームでサポートされているとは限らない、らしい。
<br />
SA_NOCLDWAITはX/Openのほうで明文化されているので、SIG_IGNだけではなくてSA_NOCLDWAITも併用するのがオススメらしい。
<br />
</p>

<p class="paragraph">
p611, &quot;9.1.6 sigaction System Call&quot; のSIG_IGNとSA_NOCLDWAITの解説も併せて参照したい。
<br />
</p>

<h4 id="id69b87c">c8/br.c の謎の &quot;__func__&quot; マクロ</h4>

<p class="paragraph">
288行目くらいで
<br />
</p>
<pre>fprintf(stderr, __FILE__ &quot;:&quot; __func__ &quot; -- bad state\n&quot;);
</pre>
<p class="paragraph">
という謎の&quot;__func__&quot;マクロがあり、これが未定義でコンパイルに失敗した。&quot;__FUNC__&quot;のつもりだろうか？
<br />
</p>

<p class="paragraph">
とりあえず display()関数の中なので、
<br />
</p>
<pre>fprintf(stderr, __FILE__ &quot;:display() -- bad state\n&quot;);
</pre>
<p class="paragraph">
にしてコンパイルを通した。
<br />
</p>

<h3 id="id9439e8">マルチスレッド＋シグナル＋fork-execの最凶タッグについて</h3>

<p class="paragraph">
・・・いや・・・実務で使ったこと無いですよ・・・そんな、聞いただけで頭が爆発しそうな組み合わせ。
<br />
&quot;Binary Hacks&quot;執筆協力されてるこの方、はてなダイアリのTOPで「昔のPOSIX関係の記事」に挙げてますけど、もうタイトル眺めただけでお腹一杯です・・・。
<br />
</p>

<ul><li> memologue<ul><li> <a class="externallink" href="http://d.hatena.ne.jp/yupo5656/" target="_blank">http://d.hatena.ne.jp/yupo5656/</a></li></ul></li></ul>

<p class="paragraph">
そう考えると、Threadモデル導入したApache HTTPD、結構スゴイのね。
<br />
</p>

<hr />
<p class="paragraph">
最後に。
<br />
</p>

<p class="paragraph">
WebもPOSIX/SUSも、「標準規格」が後から作られてる影響が大きいせいか、「標準規格」だからといって鵜呑みに出来ないんだなってつくづく思い知らされた。
<br />
</p>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/842<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2007 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>