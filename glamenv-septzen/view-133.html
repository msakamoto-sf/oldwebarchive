<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Perl/codepiece/flock01 - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">Perl/codepiece/flock01</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2007-03-14 22:57:58 &nbsp; / &nbsp; last updated at: 2008-12-28 23:01:35<br>
カテゴリ: <a href="category-21.html">Perl</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-131.html" title="Perl/codepiece/count_array1">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-132.html" title="Perl/codepiece/interface01">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-109.html" title="Perl">Perl</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<h3 id="id957144">Perlでのファイルのロック方法メモ</h3>

<ul><li> 基本は<strong> flock </strong>。但し、ここで使用するLOCK_SH, LOCK_EX, LOCK_UN, LOCK_NBは、</li></ul>
<pre>use Fcntl(:flock);
or
use Fcntl(:DEAFULT :flock);
</pre>
<p class="paragraph">
しておく必要がある。FcntlはシステムのCライブラリのfcntl.hをh2xsで取り込んで利用できるようにしてくれたモジュール。基本的に#defineされたものが取り込まれている。
<br />
</p>
<ul><li> <strong> :DEFAULT </strong>を指定すると、F_<span class="plugin_pre_inline">*</span>, O_<span class="plugin_pre_inline">*</span> 系列をデフォルトでEXPORTしてくれる。他に<strong> :flock, :seek, :mode </strong>なども指定できる。</li>
<li> flockはファイルハンドルのみを扱える。ネットワークソケットなど、Cの世界で言うところのファイルディスクリプタを生で取り扱うシーンでは、Cと同様に<strong> fcntl </strong>を使用する。</li>
<li> NFSを除くファイルシステムでのファイルのロックでは、flockで充当する。NFSにおいてはfcntlを行う必要があるらしい。これはLinuxのCレイヤーの現象らしい。</li></ul>

<p class="paragraph">
以下、参考。
<br />
</p>
<ul><li> Linux Man Page<ul><li> <a class="externallink" href="http://www.linux.or.jp/JM/html/LDP_man-pages/man2/flock.2.html" target="_blank">http://www.linux.or.jp/JM/html/LDP_man-pages/man2/flock.2.html</a></li>
<li> <a class="externallink" href="http://www.linux.or.jp/JM/html/LDP_man-pages/man2/fcntl.2.html" target="_blank">http://www.linux.or.jp/JM/html/LDP_man-pages/man2/fcntl.2.html</a></li></ul></li>
<li> perldoc<ul><li> flock: <a class="externallink" href="http://perldoc.perl.org/functions/flock.html" target="_blank">http://perldoc.perl.org/functions/flock.html</a></li>
<li> Core Module, Fcntl: <a class="externallink" href="http://perldoc.perl.org/Fcntl.html" target="_blank">http://perldoc.perl.org/Fcntl.html</a></li>
<li> fnctl: <a class="externallink" href="http://perldoc.perl.org/functions/fcntl.html" target="_blank">http://perldoc.perl.org/functions/fcntl.html</a></li></ul></li></ul>

<h3 id="idbfc943">Perlのflockは&quot;advisory&quot;ロックである点に要注意</h3>

<p class="paragraph">
flockのperldocにもしっかり太字で記載されていますが、Perlのflockは&quot;advisory&quot;ロックです。つまり、flockを使用しているもの同士であればロックは機能しますが、flockを使用せずに読み書きを行うプロセスに対しては機能しません。
<br />
</p>

<p class="paragraph">
実際、下のコードピースを使うと明らかです。コードピース同士でのロックは、同じflockを使用しているので、排他ロックは「その通りに」動作します。（戻り値がそのように見えます。）
<br />
</p>

<p class="paragraph">
しかしechoやviなどの読み書きプロセスと同時に動かして実験してみると、Perl側でLOCK_EXをかけているのに、echoシェルリダイレクトでファイルに書き込めますし、viの編集も何の問題もなく上書き保存可能です。
<br />
</p>

<p class="paragraph">
Perl同士でしか読み書きしないCGIのロックファイルについては有効ですが、別のプログラミング言語やプログラムなどで同時に読み書きするときは、Perlのflockが機能しない場合も有る点に注意が必要です。
<br />
</p>

<h3 id="idd72e45">コードピース(LOCK_{SH|EX|UN|NB}の実験)</h3>

<p class="paragraph">
標準入力からLOCK_*を受付け、コマンドラインで指定されたファイルに対してflock操作を行う。
<br />
異なる端末から二つ以上立ち上げていろいろ遊んでみる事を想定。
<br />
ここではローカルファイルシステム上のファイルをロック・アンロックする実験を行いたい為、flockで問題ない。
<br />
</p>

<p class="paragraph">
ファイルロックの他に、標準入力からのreadlineやswitch構文、他参考リンク。
<br />
</p>
<ul><li> IO::File : <a class="externallink" href="http://perldoc.perl.org/IO/File.html" target="_blank">http://perldoc.perl.org/IO/File.html</a></li>
<li> readline(), &lt;&gt; : <a class="externallink" href="http://perldoc.perl.org/functions/readline.html" target="_blank">http://perldoc.perl.org/functions/readline.html</a></li>
<li> switch() : <a class="externallink" href="http://perldoc.perl.org/Switch.html" target="_blank">http://perldoc.perl.org/Switch.html</a></li>
<li> <a class="externallink" href="http://blog.livedoor.jp/dankogai/archives/50780781.html" target="_blank">http://blog.livedoor.jp/dankogai/archives/50780781.html</a></li></ul>

<pre>#!/usr/bin/perl
use strict;
use warnings;
use Data::Dumper;
use Switch;
use Fcntl qw(:flock);

if(@ARGV &lt; 1) {
	die &quot;usage: $0 &lt;lock_file&gt;\n&quot;;
}

my $file = $ARGV[0];
my $lock_nb = 0;

if(! -e $file ) {
	die &quot;$file is not exist!\n&quot;;
}
print &quot;Lock target file is &#039;$file&#039;.\n&quot;;

## 通常のファイルハンドルを使用した書き方
# open my $fh, &quot;&lt;$file&quot; or die &quot;Open failure &#039;$file&#039;.($!)\n&quot;;

## IO::Fileを用いた書き方
my $fh = IO::File-&gt;new(&quot;+&lt;$file&quot;);
# エラーハンドリングは$fhがdefinedか否かで判別する。
# エラーコードはシステムのerrnoなので $! を参照する。
die &quot;Open file failure &#039;$file&#039; ($!).\n&quot; unless defined($fh);

sub help {
	my ($msg) = @_;
	print &quot;unrecognized statement: $msg\n&quot;;
	print &quot;statement are: LOCK_SH, LOCK_EX, LOCK_UN, LOCK_NB.\n&quot;;
	print &quot;(LOCK_NB switches LOCK_NB mode.)\n&quot;;
}

my $line = undef;
for(;;) {
	undef $!;
	unless (defined($line = &lt;STDIN&gt;)) {
		# if reached EOF, break loop.
		die $! if $!;
		last;
	}

	if($line !~ /^([A-Z_]+)/ ) {
		&amp;help($line);
		next;
	}

	switch($1) {
		my $ret = 0;
		case &quot;LOCK_SH&quot; {
			$ret = flock($fh, LOCK_SH | $lock_nb);
			print &quot;LOCK_SH results $ret.\n&quot;;
		}
		case &quot;LOCK_EX&quot; {
			$ret = flock($fh, LOCK_EX | $lock_nb);
			print &quot;LOCK_EX results $ret.\n&quot;;
		}
		case &quot;LOCK_UN&quot; {
			$ret = flock($fh, LOCK_UN);
			print &quot;LOCK_UN results $ret.\n&quot;;
		}
		case &quot;LOCK_NB&quot; {
			$lock_nb = ($lock_nb) ? 0 : LOCK_NB;
			print &quot;LOCK_NB is &quot;. (($lock_nb) ? &quot;ON&quot; : &quot;OFF&quot;) . &quot;.\n&quot;;
		}
		else {
			&amp;help($1);
		}
	}
}
# open my $fh の場合
#close $fh;
# IO::File の場合
$fh-&gt;close;
</pre>


<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-131.html" title="Perl/codepiece/count_array1">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-132.html" title="Perl/codepiece/interface01">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-109.html" title="Perl">Perl</a>&nbsp;]</li>
</ul>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/133<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2007 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>