<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>C言語系/「デーモン君のソース探検」読書メモ/03, getchar(3) - Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</title>
<!-- favicon 2017's reference:
https://developers.google.com/web/fundamentals/design-and-ui/browser-customization/
https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx
https://developer.chrome.com/multidevice/android/installtohomescreen
https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
-->
<link rel="shortcut icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="icon" href="../favicons/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="../favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="../favicons/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-160x160.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-196x196.png" sizes="96x96">
<link rel="icon" type="image/png" href="../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../favicons/favicon-32x32.png" sizes="32x32">

<!-- browserconfig.xml : https://msdn.microsoft.com/ja-jp/library/dn455106(v=vs.85).aspx -->
<meta name="msapplication-TileColor" content="#990000">
<meta name="msapplication-TileImage" content="../favicons/mstile-144x144.png">

<!-- these favicon files were generated by https://ao-system.net/favicongenerator/ , thanks!!(2017-02-18) -->

<style type="text/css"></style>

<link href="./css/pcbrowser.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_plugins.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/pcbrowser_wiki.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="./css/print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<!-- body start -->
<div class="body">
<div style="display: inline"><a name="pagetop"></a></div>
<div id="header-wrap">
<img src="./images/logo1.jpg" style="float: left; margin-right: 1em;"/>
<a href="./index.html" title="Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)"><img src="./icons/home.png" alt="home"/>&nbsp;Glamenv-Septzen(ぐらめぬ・ぜぷつぇん)(archive)</a>


<h1 style="margin-bottom: 10px;">C言語系/「デーモン君のソース探検」読書メモ/03, getchar(3)</h1>

<div style="clear: both;"></div>
</div><!-- //header-wrap -->

<!-- content-wrap start -->
<div id="content-wrap"><div class="contents_s">

<!-- data_main -->
<div class="data_main">

<div class="data_attrs_pre">
作成日: 2010-01-08 22:20:09 &nbsp; / &nbsp; last updated at: 2010-01-10 15:45:03<br>
カテゴリ: <a href="category-32.html">BSD</a>&nbsp;<a href="category-10.html">C言語</a>&nbsp;</div>

<div class="data_body">
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-541.html" title="C言語系/「デーモン君のソース探検」読書メモ/02, getopt(3)">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-544.html" title="C言語系/「デーモン君のソース探検」読書メモ/04, uuencode(1),uudecode(1)">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-478.html" title="C言語系">C言語系</a>&nbsp;]</li>
</ul>
<hr class="full_hr" />

<p class="paragraph">
お題：getchar(3)がバッファを使うことでファイルアクセス回数を少なくしている、その仕組みを追跡せよ。
<br />
</p>




<p class="paragraph">
まずgetchar()のソースを特定する。
<br />
</p>
<pre>$ locate getchar
...
/usr/src/lib/libc/stdio/getchar.c
...
</pre>
<p class="paragraph">
→
<br />
</p>
<div class="hl-main"><pre><span >int</span><span class="hl-code">
</span><span class="hl-identifier">getchar</span><span class="hl-brackets">(</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">FILE</span><span class="hl-code"> *</span><span class="hl-identifier">fp</span><span class="hl-code"> = </span><span class="hl-identifier">stdin</span><span class="hl-code">;
        </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">r</span><span class="hl-code">;
 
        </span><span class="hl-identifier">FLOCKFILE</span><span class="hl-brackets">(</span><span class="hl-identifier">fp</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">r</span><span class="hl-code"> = </span><span class="hl-identifier">__sgetc</span><span class="hl-brackets">(</span><span class="hl-identifier">fp</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">FUNLOCKFILE</span><span class="hl-brackets">(</span><span class="hl-identifier">fp</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">r</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>
<p class="paragraph">
FLOCKFILE/FUNLOCKFILEは本によるとマルチスレッド環境におけるファイルロックに関連しているので今はスルーする。
<br />
中心部分は &quot;r = __sgetc(fp);&quot;部分。まず &quot;__sgetc()&quot;がマクロかどうか判別する為、getchar.cのオブジェクトファイルgetchar.oのシンボル一覧に&quot;__sgetc&quot;があるか確認する。
<br />
</p>
<pre>$ nm /usr/lib/libc.a | less
getchar.o:
         U __sF
         U __srget
00000000 T getchar
00000038 T getchar_unlocked
</pre>
<p class="paragraph">
このように、&quot;__sgetc&quot;がシンボル一覧に無い。ということは、これは関数として定義されているのではなく、&quot;#define&quot;によるマクロ定義であることが予想される。そこで、&quot;/usr/src/include/&quot;の下を愚直にgrepしてみる。
<br />
</p>
<pre>$ cd /usr/src/include
$ grep -r sgetc *
stdio.h:#define __sgetc(p) (--(p)-&gt;_r &lt; 0 ? __srget(p) : (int)(*(p)-&gt;_p++))
stdio.h:#define getc(fp)        __sgetc(fp)
stdio.h:#define getc_unlocked(fp)       __sgetc(fp)
</pre>
<p class="paragraph">
stdio.h中で定義されていることが分かった。
<br />
</p>
<pre>__sgetc(p)
=
--(p)-&gt;_r &lt; 0 ? __srget(p) : (int)(*(p)-&gt;_p++))
</pre>
<p class="paragraph">
ifブロックで分かりやすく整形する：
<br />
</p>
<pre>if ( --(p)-&gt;_r &lt; 0 ) {
    __srget(p)
} else {
    (int)(*(p)-&gt;_p++))
}
</pre>
<p class="paragraph">
&quot;--&quot;や&quot;++&quot;演算子の優先順位を確認。
<br />
</p>
<pre>man operator
</pre>
<p class="paragraph">
→次のように整形出来る：
<br />
</p>
<pre>--(p-&gt;_r);
if ((p-&gt;_r) &lt; 0) {
    return __srget(p);
} else {
    (p-&gt;_p)++;
    return (int)(*(p-&gt;_p));
}
</pre>

<p class="paragraph">
ここで&quot;p&quot;は__sgetc(p)のpで、すなわちFILE構造体へのポインタ。
<br />
/usr/src/lib/libc/stdio/getchar.cを見直してみる：
<br />
</p>
<pre>getchar() {
    FILE *fp = stdin;
    /* ... */
    r = __sgetc(fp);
</pre>

<p class="paragraph">
FILE構造体はstdio.h中で定義されている。
<br />
</p>
<div class="hl-main"><pre><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> ... </span><span class="hl-mlcomment">*/</span><span class="hl-code">
 
</span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> stdio buffers </span><span class="hl-mlcomment">*/</span><span class="hl-code">
</span><span >struct</span><span class="hl-code"> </span><span class="hl-identifier">__sbuf</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span >unsigned</span><span class="hl-code"> </span><span >char</span><span class="hl-code"> *</span><span class="hl-identifier">_base</span><span class="hl-code">;
    </span><span >int</span><span class="hl-code">     </span><span class="hl-identifier">_size</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">;
 
</span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> ... </span><span class="hl-mlcomment">*/</span><span class="hl-code">
 
</span><span >typedef</span><span class="hl-code"> </span><span >struct</span><span class="hl-code"> </span><span class="hl-identifier">__sFILE</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span >unsigned</span><span class="hl-code"> </span><span >char</span><span class="hl-code"> *</span><span class="hl-identifier">_p</span><span class="hl-code">;      </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> current position in (some) buffer </span><span class="hl-mlcomment">*/</span><span class="hl-code">
    </span><span >int</span><span class="hl-code">     </span><span class="hl-identifier">_r</span><span class="hl-code">;             </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> read space left for getc() </span><span class="hl-mlcomment">*/</span><span class="hl-code">
    </span><span >int</span><span class="hl-code">     </span><span class="hl-identifier">_w</span><span class="hl-code">;             </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> write space left for putc() </span><span class="hl-mlcomment">*/</span><span class="hl-code">
    </span><span >short</span><span class="hl-code">   </span><span class="hl-identifier">_flags</span><span class="hl-code">;         </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> flags, below; this FILE is free if 0 </span><span class="hl-mlcomment">*/</span><span class="hl-code">
    </span><span >short</span><span class="hl-code">   </span><span class="hl-identifier">_file</span><span class="hl-code">;          </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> fileno, if Unix descriptor, else -1 </span><span class="hl-mlcomment">*/</span><span class="hl-code">
    </span><span >struct</span><span class="hl-code">  </span><span class="hl-identifier">__sbuf</span><span class="hl-code"> </span><span class="hl-identifier">_bf</span><span class="hl-code">;     </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> the buffer (at least 1 byte, if !NULL) </span><span class="hl-mlcomment">*/</span><span class="hl-code">
    </span><span >int</span><span class="hl-code">     </span><span class="hl-identifier">_lbfsize</span><span class="hl-code">;       </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> 0 or -_bf._size, for inline putc </span><span class="hl-mlcomment">*/</span><span class="hl-code">
 
    </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> operations </span><span class="hl-mlcomment">*/</span><span class="hl-code">
    </span><span >void</span><span class="hl-code">    *</span><span class="hl-identifier">_cookie</span><span class="hl-code">;       </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> cookie passed to io functions </span><span class="hl-mlcomment">*/</span><span class="hl-code">
    </span><span >int</span><span class="hl-code">     </span><span class="hl-brackets">(</span><span class="hl-code">*</span><span class="hl-identifier">_close</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">__P</span><span class="hl-brackets">(</span><span class="hl-brackets">(</span><span >void</span><span class="hl-code"> *</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span >int</span><span class="hl-code">     </span><span class="hl-brackets">(</span><span class="hl-code">*</span><span class="hl-identifier">_read</span><span class="hl-brackets">)</span><span class="hl-code">  </span><span class="hl-identifier">__P</span><span class="hl-brackets">(</span><span class="hl-brackets">(</span><span >void</span><span class="hl-code"> *, </span><span >char</span><span class="hl-code"> *, </span><span >int</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">fpos_t</span><span class="hl-code">  </span><span class="hl-brackets">(</span><span class="hl-code">*</span><span class="hl-identifier">_seek</span><span class="hl-brackets">)</span><span class="hl-code">  </span><span class="hl-identifier">__P</span><span class="hl-brackets">(</span><span class="hl-brackets">(</span><span >void</span><span class="hl-code"> *, </span><span class="hl-identifier">fpos_t</span><span class="hl-code">, </span><span >int</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span >int</span><span class="hl-code">     </span><span class="hl-brackets">(</span><span class="hl-code">*</span><span class="hl-identifier">_write</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">__P</span><span class="hl-brackets">(</span><span class="hl-brackets">(</span><span >void</span><span class="hl-code"> *, </span><span >const</span><span class="hl-code"> </span><span >char</span><span class="hl-code"> *, </span><span >int</span><span class="hl-brackets">)</span><span class="hl-brackets">)</span><span class="hl-code">;
 
    </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> ... </span><span class="hl-mlcomment">*/</span><span class="hl-code">
 
</span><span class="hl-brackets">}</span><span class="hl-code"> </span><span class="hl-identifier">FILE</span><span class="hl-code">;
 
</span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> ... </span><span class="hl-mlcomment">*/</span></pre></div>

<p class="paragraph">
&quot;__sgetc()&quot;のマクロに戻れば、ここまでで処理内容が以下のように判明した。
<br />
</p>
<pre>--(p-&gt;_r); /* 1文字取得するので、読み込みバッファのサイズをデクリメント */
if ((p-&gt;_r) &lt; 0) { /* マイナスになってしまったら、読み込み処理へ */
    return __srget(p);
} else {
    (p-&gt;_p)++; /* バッファの現在位置をインクリメント */
    return (int)(*(p-&gt;_p)); /* 上でインクリメントした位置の値を返す */
}
</pre>

<p class="paragraph">
&quot;__srget(p)&quot;か関数なのか、マクロなのかはlibc.aのシンボル一覧から判別可能。
<br />
</p>
<pre>$ nm /usr/lib/libc.a | less
...
rget.o:
         U __srefill
00000000 T __srget
</pre>
<p class="paragraph">
&quot;rget.o&quot;で定義、つまりrget.c中で関数定義されていることが予想される。
<br />
</p>
<pre>$ locate rget.c
...
/usr/src/lib/libc/stdio/rget.c
...
</pre>
<p class="paragraph">
ということで /usr/src/lib/libc/stdio/rget.c を覗いてみると、短いコードと分かりやすい説明コメント：
<br />
</p>
<div class="hl-main"><pre><span class="hl-mlcomment">/*</span><span class="hl-mlcomment">
 * Handle getc() when the buffer ran out:
 * Refill, then return the first character
 * in the newly-filled buffer.
 </span><span class="hl-mlcomment">*/</span><span class="hl-code">
</span><span >int</span><span class="hl-code">
</span><span class="hl-identifier">__srget</span><span class="hl-brackets">(</span><span class="hl-identifier">fp</span><span class="hl-brackets">)</span><span class="hl-code">
        </span><span class="hl-identifier">FILE</span><span class="hl-code"> *</span><span class="hl-identifier">fp</span><span class="hl-code">;
</span><span class="hl-brackets">{</span><span class="hl-code">
 
        </span><span class="hl-identifier">_DIAGASSERT</span><span class="hl-brackets">(</span><span class="hl-identifier">fp</span><span class="hl-code"> != </span><span >NULL</span><span class="hl-brackets">)</span><span class="hl-code">;
 
        </span><span class="hl-identifier">_SET_ORIENTATION</span><span class="hl-brackets">(</span><span class="hl-identifier">fp</span><span class="hl-code">, -</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">__srefill</span><span class="hl-brackets">(</span><span class="hl-identifier">fp</span><span class="hl-brackets">)</span><span class="hl-code"> == </span><span class="hl-number">0</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
                </span><span class="hl-identifier">fp</span><span class="hl-code">-&gt;</span><span class="hl-identifier">_r</span><span class="hl-code">--;
                </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-code">*</span><span class="hl-identifier">fp</span><span class="hl-code">-&gt;</span><span class="hl-identifier">_p</span><span class="hl-code">++</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code">
        </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">EOF</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
&quot;_SET_ORIENTATION(fp, -1)&quot; というのは &quot;/usr/src/lib/libc/stdio/wcio.h&quot; 中で定義されていて、wchar関連のフラグを操作しているらしい。今回は関連が薄そうなので、スルーする。
<br />
あとは見たままで、&quot;__srefill(fp)&quot;でバッファを埋め直し、戻り値が0であれば &quot;_r&quot;メンバを(1文字読むので)1デクリメントし、&quot;_p&quot;ポインタをインクリメントした上でその場所のデータを返している。
<br />
</p>

<p class="paragraph">
&quot;__srefill()&quot;は、libc.aのシンボル一覧を見ると refill.c にある。
<br />
</p>
<pre>refill.o:
...
00000028 T __srefill
...
</pre>
<p class="paragraph">
→
<br />
</p>
<pre>$ locate refill.c
/usr/src/lib/libc/stdio/refill.c
</pre>
<p class="paragraph">
→ &quot;/usr/src/lib/libc/stdio/refill.c&quot;を見てみる。&quot;__srefill(fp)&quot;の主要部分だけ抜き出す。
<br />
</p>
<div class="hl-main"><pre><span class="hl-mlcomment">/*</span><span class="hl-mlcomment">
 * Refill a stdio buffer.
 * Return EOF on eof or error, 0 otherwise.
 </span><span class="hl-mlcomment">*/</span><span class="hl-code">
</span><span >int</span><span class="hl-code">
</span><span class="hl-identifier">__srefill</span><span class="hl-brackets">(</span><span class="hl-identifier">fp</span><span class="hl-brackets">)</span><span class="hl-code">
        </span><span class="hl-identifier">FILE</span><span class="hl-code"> *</span><span class="hl-identifier">fp</span><span class="hl-code">;
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> ... </span><span class="hl-mlcomment">*/</span><span class="hl-code">
    </span><span class="hl-identifier">fp</span><span class="hl-code">-&gt;</span><span class="hl-identifier">_r</span><span class="hl-code"> = </span><span class="hl-number">0</span><span class="hl-code">; </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> largely a convenience for callers </span><span class="hl-mlcomment">*/</span><span class="hl-code">
    </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> ... </span><span class="hl-mlcomment">*/</span><span class="hl-code">
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">fp</span><span class="hl-code">-&gt;</span><span class="hl-identifier">_bf</span><span class="hl-code">.</span><span class="hl-identifier">_base</span><span class="hl-code"> == </span><span >NULL</span><span class="hl-brackets">)</span><span class="hl-code">
        </span><span class="hl-identifier">__smakebuf</span><span class="hl-brackets">(</span><span class="hl-identifier">fp</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> ... </span><span class="hl-mlcomment">*/</span><span class="hl-code">
    </span><span class="hl-identifier">fp</span><span class="hl-code">-&gt;</span><span class="hl-identifier">_p</span><span class="hl-code"> = </span><span class="hl-identifier">fp</span><span class="hl-code">-&gt;</span><span class="hl-identifier">_bf</span><span class="hl-code">.</span><span class="hl-identifier">_base</span><span class="hl-code">;
    </span><span class="hl-identifier">fp</span><span class="hl-code">-&gt;</span><span class="hl-identifier">_r</span><span class="hl-code"> = </span><span class="hl-brackets">(</span><span class="hl-code">*</span><span class="hl-identifier">fp</span><span class="hl-code">-&gt;</span><span class="hl-identifier">_read</span><span class="hl-brackets">)</span><span class="hl-brackets">(</span><span class="hl-identifier">fp</span><span class="hl-code">-&gt;</span><span class="hl-identifier">_cookie</span><span class="hl-code">, </span><span class="hl-brackets">(</span><span >char</span><span class="hl-code"> *</span><span class="hl-brackets">)</span><span class="hl-identifier">fp</span><span class="hl-code">-&gt;</span><span class="hl-identifier">_p</span><span class="hl-code">, </span><span class="hl-identifier">fp</span><span class="hl-code">-&gt;</span><span class="hl-identifier">_bf</span><span class="hl-code">.</span><span class="hl-identifier">_size</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">fp</span><span class="hl-code">-&gt;</span><span class="hl-identifier">_r</span><span class="hl-code"> &lt;= </span><span class="hl-number">0</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> ... </span><span class="hl-mlcomment">*/</span><span class="hl-code">
        </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">EOF</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-number">0</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span></pre></div>

<p class="paragraph">
&quot;__smakebuf(fp)&quot;は &quot; /usr/src/lib/libc/stdio/makebuf.c&quot; 中で定義されており、適切なバッファサイズを計算・malloc()で確保する。FILE構造体の&quot;_bf&quot;メンバは&quot;__sbuf&quot;構造体であり、&quot;_base&quot;メンバはバッファへのポインタ、&quot;_size&quot;メンバはバッファのサイズとなる。
<br />
よって以下のコードで、&quot;__smakebuf(fp)&quot;で確保されたバッファのアドレスが &quot;_p&quot; メンバにコピーされたことになる。
<br />
</p>
<pre>fp-&gt;_p = fp-&gt;_bf._base;
</pre>
<p class="paragraph">
次のコードだが、FILE構造体の&quot;_read&quot;メンバに入っている関数ポインタを経由し、バッファのアドレスとバッファサイズを引数に渡して実際の読み込み関数を呼び出している。
<br />
</p>
<pre>fp-&gt;_r = (*fp-&gt;_read)(fp-&gt;_cookie, (char *)fp-&gt;_p, fp-&gt;_bf._size);
</pre>

<p class="paragraph">
FILE構造体の&quot;_read&quot;メンバに何が入るのかは、fopen(3)を調べてみるとよい。
<br />
</p>
<pre>$ locate fopen
/usr/src/lib/libc/stdio/fopen.c
</pre>
<p class="paragraph">
→
<br />
</p>
<pre>FILE *
fopen(file, mode)
    const char *file;
    const char *mode;
{
    FILE *fp;
    int f;
    /* ... */
    if ((f = open(file, oflags, DEFFILEMODE)) &lt; 0)
        goto release;
    /* ... */
    fp-&gt;_file = f;
    /* ... */
    fp-&gt;_cookie = fp;
    fp-&gt;_read = __sread;
/* ... */
}
</pre>
<p class="paragraph">
&quot;_file&quot;メンバにはopen(2)で取得したファイル記述子が、&quot;_cookie&quot;メンバにはFILE構造体へのポインタ自身が入るようだ。
<br />
&quot;__sread&quot;をlibc.aのシンボル一覧から調べてみる(関数ポインタに代入されている以上は、マクロではあり得ない筈)。
<br />
</p>
<pre>$ nm /usr/lib/libc.a | less
...
stdio.o:
...
00000000 T __sread
...
</pre>
<p class="paragraph">
→
<br />
</p>
<pre>$ locate stdio.c
...
/usr/src/lib/libc/stdio/stdio.c
</pre>
<p class="paragraph">
→
<br />
</p>
<div class="hl-main"><pre><span class="hl-mlcomment">/*</span><span class="hl-mlcomment">
 * Small standard I/O/seek/close functions.
 * These maintain the `known seek offset' for seek optimisation.
 </span><span class="hl-mlcomment">*/</span><span class="hl-code">
</span><span >int</span><span class="hl-code">
</span><span class="hl-identifier">__sread</span><span class="hl-brackets">(</span><span class="hl-identifier">cookie</span><span class="hl-code">, </span><span class="hl-identifier">buf</span><span class="hl-code">, </span><span class="hl-identifier">n</span><span class="hl-brackets">)</span><span class="hl-code">
        </span><span >void</span><span class="hl-code"> *</span><span class="hl-identifier">cookie</span><span class="hl-code">;
        </span><span >char</span><span class="hl-code"> *</span><span class="hl-identifier">buf</span><span class="hl-code">;
        </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">n</span><span class="hl-code">;
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">FILE</span><span class="hl-code"> *</span><span class="hl-identifier">fp</span><span class="hl-code"> = </span><span class="hl-identifier">cookie</span><span class="hl-code">;
    </span><span >int</span><span class="hl-code"> </span><span class="hl-identifier">ret</span><span class="hl-code">;
 
    </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> ... </span><span class="hl-mlcomment">*/</span><span class="hl-code">
 
    </span><span class="hl-identifier">ret</span><span class="hl-code"> = </span><span class="hl-identifier">read</span><span class="hl-brackets">(</span><span class="hl-identifier">fp</span><span class="hl-code">-&gt;</span><span class="hl-identifier">_file</span><span class="hl-code">, </span><span class="hl-identifier">buf</span><span class="hl-code">, </span><span class="hl-brackets">(</span><span class="hl-identifier">size_t</span><span class="hl-brackets">)</span><span class="hl-identifier">n</span><span class="hl-brackets">)</span><span class="hl-code">;
 
    </span><span class="hl-mlcomment">/*</span><span class="hl-mlcomment"> ... </span><span class="hl-mlcomment">*/</span><span class="hl-code">
</span><span class="hl-brackets">}</span></pre></div>
<p class="paragraph">
これでようやく、read(2)システムコールまで到達し、バッファが足りない場合にread(2)でデータを取得している事が判明した。
<br />
</p>

<p class="paragraph">
getchar()あるいはgetc()による読み込みでのバッファ周りをまとめ直してみる。
<br />
</p>
<pre>A. 読み込み済のバッファが充分ある場合
→ /usr/src/include/stdio.h:&quot;__sgetc()&quot;マクロまでで完結。

B. 読み込み済のバッファが空になった場合
→ /usr/src/include/stdio.h:&quot;__sgetc()&quot;マクロ
→ /usr/src/lib/libc/stdio/rget.c:&quot;__srget()&quot;関数
→ /usr/src/lib/libc/stdio/refill.c:&quot;__srefill()&quot;関数
→ FILE構造体の&quot;_read&quot;メンバ関数ポインタ経由
→ /usr/src/lib/libc/stdio/fopen.c:&quot;fopen()&quot;関数でセットされた&quot;__sread&quot;関数
→ /usr/src/lib/libc/stdio/stdio.c:&quot;__sread()&quot;関数
→ read(2)システムコール
</pre>

<p class="paragraph">
今回のお題に対しては、ここまで。
<br />
</p>

<hr class="full_hr" />
<ul class="plugin_navi">
<li>[&nbsp;<a href="./view-541.html" title="C言語系/「デーモン君のソース探検」読書メモ/02, getopt(3)">Prev</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-544.html" title="C言語系/「デーモン君のソース探検」読書メモ/04, uuencode(1),uudecode(1)">Next</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-546.html" title="C言語系/「デーモン君のソース探検」読書メモ">Up</a>&nbsp;]</li>
<li>[&nbsp;<a href="./view-478.html" title="C言語系">C言語系</a>&nbsp;]</li>
</ul>
</div>

<div class="data_attrs_post">
original url: https://www.glamenv-septzen.net/view/543<br>
</div>

</div>
<!-- //data_main -->

</div>


</div>
<!-- /content-wrap end -->

<!-- footer start -->
<div id="footer">
Copyright &copy; 2001 - 2025 Masahiko Sakamoto(msakamoto-sf)<br>
License&nbsp;:&nbsp;<a target="_blank" href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a><br>
Contact&nbsp;:&nbsp;<a target="_blank" href="https://x.com/msakamoto_sf">x(twitter)</a> / <a target="_blank" href="https://github.com/msakamoto-sf/">github</a> / <a class="maillink" target="_blank" href="mailto:&#x73;&#x61;&#x6B;&#x61;&#x6D;&#x6F;&#x74;&#x6F;&#x2E;&#x67;&#x73;&#x79;&#x63;&#x2E;&#x33;&#x73;&#x40;&#x67;&#x6D;&#x61;&#x69;&#x6C;&#x2E;&#x63;&#x6F;&#x6D;">email</a><br>
--&nbsp;Beautiful Icons&nbsp;--<br />
<a href="http://www.famfamfam.com/lab/icons/silk/" target="_blank" title="Mark James Silk icon set 1.3">Mark James Silk icon set 1.3</a> by famfamfam<br />
<a href="http://www.pinvoke.com/" target="_blank" title="Fugue Icons">Fugue Icons</a> by Yusuke Kamiyamane<br />
</div>
<!-- /footer end -->

</div>
<!-- /body end -->

</body>
</html>